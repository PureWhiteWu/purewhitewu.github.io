<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="apple-touch-icon" sizes="180x180" href="https://static.purewhite.io/favicon.jpg"><link rel="icon" type="image/png" sizes="32x32" href="https://static.purewhite.io/favicon.jpg"><link rel="icon" type="image/png" sizes="16x16" href="https://static.purewhite.io/favicon.jpg"><link rel="mask-icon" href="https://static.purewhite.io/favicon.jpg" color="#222"><meta name="google-site-verification" content="Xg_Hnp9ie-Rq7-zLPdd3c9dQtR_0N845ue4QaK8jvL4"><meta name="baidu-site-verification" content="c3b074df19d33f893845b6d092bc9169"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" integrity="sha256-6cQIC71/iBIYXFK+0RHAvwmjwWzkWd+r7v/BX3/vZDc=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.purewhite.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":true,"nav":null,"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"ZP9482CZD3","apiKey":"d26207a3ce8de9fe98e7af4215425c93","indexName":"Blog","hits":{"per_page":10}}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/config.min.js"></script><meta name="description" content="最近在研究性能优化的时候，看到了 golang runtime 包下的一个文档HACKING.md觉得颇有意思，读完之后觉得对于 runtime 的理解更上一层，于是想着翻译一下。 本章内容会有一定深度，需要有一定基础的读者，限于篇幅在这里不可能完全展开各个细节。 这一篇文档面向的读者是 runtime 的开发者，所以有很多内容在我们普通使用中是接触不到的。"><meta property="og:type" content="article"><meta property="og:title" content="golang 在 runtime 中的一些骚东西"><meta property="og:url" content="https://www.purewhite.io/2019/11/28/runtime-hacking-translate/index.html"><meta property="og:site_name" content="Pure White"><meta property="og:description" content="最近在研究性能优化的时候，看到了 golang runtime 包下的一个文档HACKING.md觉得颇有意思，读完之后觉得对于 runtime 的理解更上一层，于是想着翻译一下。 本章内容会有一定深度，需要有一定基础的读者，限于篇幅在这里不可能完全展开各个细节。 这一篇文档面向的读者是 runtime 的开发者，所以有很多内容在我们普通使用中是接触不到的。"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2019-11-28T14:00:43.000Z"><meta property="article:modified_time" content="2023-06-14T15:05:22.000Z"><meta property="article:author" content="Pure White"><meta property="article:tag" content="后端"><meta property="article:tag" content="go"><meta property="article:tag" content="asm"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.purewhite.io/2019/11/28/runtime-hacking-translate/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.purewhite.io/2019/11/28/runtime-hacking-translate/","path":"2019/11/28/runtime-hacking-translate/","title":"golang 在 runtime 中的一些骚东西"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>golang 在 runtime 中的一些骚东西 | Pure White</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-98194081-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-98194081-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/third-party/analytics/google-analytics.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/third-party/analytics/baidu-analytics.min.js"></script><script async src="https://hm.baidu.com/hm.js?587d2548655f9855727225afb0e4d708"></script><script async src="//assets.growingio.com/2.1/gio.js"></script><script class="next-config" data-name="growingio_analytics" type="application/json">"8a8c3a537a0132ac"</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/third-party/analytics/growingio.min.js"></script><script type="text/javascript">!function(t,e,n,a,c,s,i){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(s=e.createElement(a)).async=1,s.src="https://www.clarity.ms/tag/8mh5xasia9",(i=e.getElementsByTagName(a)[0]).parentNode.insertBefore(s,i)}(window,document,"clarity","script")</script><script>!function(){var e=document.createElement("script");e.src="https://lf1-cdn-tos.bytegoofy.com/goofy/ttzz/push.js?c75fd468cb92e13256468f9ae3917db97049a5a91566914dbb6ab879288745b8bc434964556b7d7129e9b750ed197d397efd7b0c6c715c1701396e1af40cec962b8d7c8c6655c9b00211740aa8a98e2e",e.id="ttzz";var c=document.getElementsByTagName("script")[0];c.parentNode.insertBefore(e,c)}(window)</script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="Pure White" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="Pure White" type="application/rss+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Pure White</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">主业写bug，副业debug</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-关于我"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于我</a></li><li class="menu-item menu-item-标签"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-分类"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container"><div class="algolia-stats"><hr></div><div class="algolia-hits"></div><div class="algolia-pagination"></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B0%83%E5%BA%A6%E5%99%A8%E7%BB%93%E6%9E%84"><span class="nav-number">1.</span> <span class="nav-text">调度器结构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#G%E3%80%81M-%E5%92%8C-P"><span class="nav-number">1.1.</span> <span class="nav-text">G、M 和 P</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#getg-%E5%92%8Cgetg-m-curg"><span class="nav-number">1.2.</span> <span class="nav-text">getg()和getg().m.curg</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A0%88"><span class="nav-number">2.</span> <span class="nav-text">栈</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#nosplit-%E5%87%BD%E6%95%B0"><span class="nav-number">2.1.</span> <span class="nav-text">nosplit 函数</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E5%92%8C%E4%B8%8A%E6%8A%A5"><span class="nav-number">3.</span> <span class="nav-text">错误处理和上报</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5"><span class="nav-number">4.</span> <span class="nav-text">同步</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8E%9F%E5%AD%90%E6%80%A7"><span class="nav-number">5.</span> <span class="nav-text">原子性</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98%EF%BC%88Unmanaged-memory%EF%BC%89"><span class="nav-number">6.</span> <span class="nav-text">堆外内存（Unmanaged memory）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Zero-initialization-versus-zeroing"><span class="nav-number">7.</span> <span class="nav-text">Zero-initialization versus zeroing</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Runtime-only-%E7%BC%96%E8%AF%91%E6%8C%87%E4%BB%A4%EF%BC%88compiler-directives%EF%BC%89"><span class="nav-number">8.</span> <span class="nav-text">Runtime-only 编译指令（compiler directives）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#go-systemstack"><span class="nav-number">8.1.</span> <span class="nav-text">go:systemstack</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#go-nowritebarrier"><span class="nav-number">8.2.</span> <span class="nav-text">go:nowritebarrier</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#go-nowritebarrierrec-%E4%B8%8E-go-yeswritebarrierrec"><span class="nav-number">8.3.</span> <span class="nav-text">go:nowritebarrierrec 与 go:yeswritebarrierrec</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#go-uintptrkeepalive"><span class="nav-number">8.4.</span> <span class="nav-text">go:uintptrkeepalive</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Pure White" src="https://static.purewhite.io/avatar.jpg!webp_90"><p class="site-author-name" itemprop="name">Pure White</p><div class="site-description" itemprop="description">青春不是年华，是心境；<br>青春不是桃面、丹唇、柔膝，<br>而是深沉的意志、恢弘的想象、<br>炽热的感情。</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">59</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">14</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">29</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/PureWhiteWu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;PureWhiteWu" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:me@purewhite.io" title="E-Mail → mailto:me@purewhite.io" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://twitter.com/PureWhite_Wu" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;PureWhite_Wu" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i> Twitter</a></span><span class="links-of-author-item"><a href="https://www.linkedin.com/in/%E8%BF%AA-%E5%90%B4-846051106/" title="LinkedIn → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;%E8%BF%AA-%E5%90%B4-846051106&#x2F;" rel="noopener me" target="_blank"><i class="fa fa-linkedin fa-fw"></i> LinkedIn</a></span><span class="links-of-author-item"><a href="https://telegram.me/PureWhiteWu" title="Telegram → https:&#x2F;&#x2F;telegram.me&#x2F;PureWhiteWu" rel="noopener me" target="_blank"><i class="fa fa-telegram fa-fw"></i> Telegram</a></span><span class="links-of-author-item"><a href="http://weibo.com/purewhitewu" title="微博 → http:&#x2F;&#x2F;weibo.com&#x2F;purewhitewu" rel="noopener me" target="_blank"><i class="fa fa-weibo fa-fw"></i> 微博</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/PureWhite_Wu" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;PureWhite_Wu" rel="noopener me" target="_blank"><i class="fa fa-book fa-fw"></i> 知乎</a></span><span class="links-of-author-item"><a href="https://static.purewhite.io/wechat_channel.jpg" title="微信 → https:&#x2F;&#x2F;static.purewhite.io&#x2F;wechat_channel.jpg" rel="noopener me" target="_blank"><i class="fa fa-weixin fa-fw"></i> 微信</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → &#x2F;atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="sidebar-inner sidebar-blogroll"><div class="links-of-blogroll animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="http://blog.didispace.com/" title="http:&#x2F;&#x2F;blog.didispace.com&#x2F;" rel="noopener" target="_blank">程序猿DD</a></li><li class="links-of-blogroll-item"> <a href="http://www.v2ex.com/?r=PureWhiteWu" title="http:&#x2F;&#x2F;www.v2ex.com&#x2F;?r&#x3D;PureWhiteWu" rel="noopener" target="_blank">v2ex</a></li><li class="links-of-blogroll-item"> <a href="https://yuzhouwan.com/" title="https:&#x2F;&#x2F;yuzhouwan.com&#x2F;" rel="noopener" target="_blank">宇宙湾</a></li><li class="links-of-blogroll-item"> <a href="https://pengrl.com/" title="https:&#x2F;&#x2F;pengrl.com&#x2F;" rel="noopener" target="_blank">yoko blog</a></li></ul></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.purewhite.io/2019/11/28/runtime-hacking-translate/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://static.purewhite.io/avatar.jpg!webp_90"><meta itemprop="name" content="Pure White"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Pure White"><meta itemprop="description" content="青春不是年华，是心境；<br />青春不是桃面、丹唇、柔膝，<br />而是深沉的意志、恢弘的想象、<br />炽热的感情。"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="golang 在 runtime 中的一些骚东西 | Pure White"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> golang 在 runtime 中的一些骚东西</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-11-28 22:00:43" itemprop="dateCreated datePublished" datetime="2019-11-28T22:00:43+08:00">2019-11-28</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-06-14 23:05:22" itemprop="dateModified" datetime="2023-06-14T23:05:22+08:00">2023-06-14</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a></span></span><span id="/2019/11/28/runtime-hacking-translate/" class="post-meta-item leancloud_visitors" data-flag-title="golang 在 runtime 中的一些骚东西" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span class="leancloud-visitors-count"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Disqus：</span><a title="disqus" href="/2019/11/28/runtime-hacking-translate/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/28/runtime-hacking-translate/" itemprop="commentCount"></span></a></span><span class="post-meta-break"></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>4.1k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>15 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>最近在研究性能优化的时候，看到了 golang runtime 包下的一个文档<a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/master/src/runtime/HACKING.md"><code>HACKING.md</code></a>觉得颇有意思，读完之后觉得对于 runtime 的理解更上一层，于是想着翻译一下。</p><p>本章内容会有一定深度，需要有一定基础的读者，限于篇幅在这里不可能完全展开各个细节。</p><p>这一篇文档面向的读者是 runtime 的开发者，所以有很多内容在我们普通使用中是接触不到的。</p><span id="more"></span><p>这篇文档是会被经常编辑的，并且随着时间推移目前的内容可能会过时。这篇文档旨在说明写 runtime 代码和普通的 go 代码有什么不同，所以关注于一些普遍的概念而不是一些细节的实现。</p><h1 id="调度器结构"><a href="#调度器结构" class="headerlink" title="调度器结构"></a>调度器结构</h1><p>调度器管理三个在 runtime 中十分重要的类型：<code>G</code>、<code>M</code>和<code>P</code>。哪怕你不写 scheduler 相关代码，你也应当要了解这些概念。</p><h2 id="G、M-和-P"><a href="#G、M-和-P" class="headerlink" title="G、M 和 P"></a>G、M 和 P</h2><p>一个<code>G</code>就是一个 goroutine，在 runtime 中通过类型<code>g</code>来表示。当一个 goroutine 退出时，<code>g</code>对象会被放到一个空闲的<code>g</code>对象池中以用于后续的 goroutine 的使用（译者注：减少内存分配开销）。</p><p>一个<code>M</code>就是一个系统的线程，系统线程可以执行用户的 go 代码、runtime 代码、系统调用或者空闲等待。在 runtime 中通过类型<code>m</code>来表示。在同一时间，可能有任意数量的<code>M</code>，因为任意数量的<code>M</code>可能会阻塞在系统调用中。（译者注：当一个<code>M</code>执行阻塞的系统调用时，会将<code>M</code>和<code>P</code>解绑，并创建出一个新的<code>M</code>来执行<code>P</code>上的其它<code>G</code>。）</p><p>最后，一个<code>P</code>代表了执行用户 go 代码所需要的资源，比如调度器状态、内存分配器状态等。在 runtime 中通过类型<code>p</code>来表示。<code>P</code>的数量精确地（exactly）等于<code>GOMAXPROCS</code>。一个<code>P</code>可以被理解为是操作系统调度器中的 CPU，<code>p</code>类型可以被理解为是每个 CPU 的状态。在这里可以放一些需要高效共享但并不是针对每个<code>P</code>（Per <code>P</code>）或者每个<code>M</code>（Per <code>M</code>）的状态（译者注：意思是，可以放一些以<code>P</code>级别共享的数据）。</p><p>调度器的工作是将一个<code>G</code>（需要执行的代码）、一个<code>M</code>（代码执行的地方）和一个<code>P</code>（代码执行所需要的权限和资源）结合起来。当一个<code>M</code>停止执行用户代码的时候（比如进入阻塞的系统调用的时候），就需要把它的<code>P</code>归还到空闲的<code>P</code>池中；为了继续执行用户的 go 代码（比如从阻塞的系统调用退出的时候），就需要从空闲的<code>P</code>池中获取一个<code>P</code>。</p><p>所有的<code>g</code>、<code>m</code>和<code>p</code>对象都是分配在堆上且永不释放的，所以它们的内存使用是很稳定的。得益于此，runtime 可以在调度器实现中避免写屏障（译者注：垃圾回收时需要的一种屏障，会带来一些性能开销）。</p><h2 id="getg-和getg-m-curg"><a href="#getg-和getg-m-curg" class="headerlink" title="getg()和getg().m.curg"></a><code>getg()</code>和<code>getg().m.curg</code></h2><p>如果想要获取当前用户的<code>g</code>，需要使用<code>getg().m.curg</code>。</p><p><code>getg()</code>虽然会返回当前的<code>g</code>，但是当正在系统栈或者<code>signal</code>栈上执行的时候，会返回的是当前<code>M</code>的<code>g0</code>或者<code>gsignal</code>，而这很可能不是你想要的。</p><p>如果要判断当前正在系统栈上执行还是用户栈上执行，可以使用<code>getg() == getg().m.curg</code>。</p><h1 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h1><p>每个存活着的（non-dead）<code>G</code>都会有一个相关联的用户栈，用户的代码就是在这个用户栈上执行的。用户栈一开始很小（比如 2K），并且动态地生长或者收缩。</p><p>每一个<code>M</code>都有一个相关联的系统栈（也被称为<code>g0</code>栈，因为这个栈也是通过<code>g</code>实现的）；如果是在 Unix 平台上，还会有一个 <code>signal</code>栈（也被称为<code>gsignal</code>栈）。系统栈和<code>signal</code>栈不能生长，但是足够大到运行任何 runtime 和 cgo 的代码（在纯 go 二进制中为 8K，在 cgo 情况下由系统分配）。</p><p>runtime 代码经常通过调用<code>systemstack</code>、<code>mcall</code>或者<code>asmcgocall</code>临时性的切换到系统栈去执行一些特殊的任务，比如：不能被抢占的、不应该扩张用户栈的和会切换用户 goroutine 的。在系统栈上运行的代码隐含了不可抢占的含义，同时垃圾回收器不会扫描系统栈。当一个<code>M</code>在系统栈上运行时，当前的用户栈是没有被运行的。</p><h2 id="nosplit-函数"><a href="#nosplit-函数" class="headerlink" title="nosplit 函数"></a>nosplit 函数</h2><p>大多数函数都以检查堆栈指针和当前 G 的堆栈边界的 prologue 开始，并在堆栈需要增长时调用 morestack。</p><p>可以使用<code>//go:nosplit</code>（或者在汇编中使用<code>NOSPLIT</code>）标记功能，以指示它们不应该具有此 prologue。这有几个用途：</p><ul><li><p>必须在用户堆栈上运行的功能，但不能调用堆栈增长。例如因为这会导致死锁，或者因为它们在堆栈上有无类型的 words。</p></li><li><p>在进入时不可被抢占的功能。</p></li><li><p>可能没有有效 G 的功能。例如，runtime 初始化代码中的功能，或者可能从 C 代码进入的功能，例如 cgo 回调或信号处理程序。</p></li></ul><p>可拆分函数确保堆栈上有一定数量的空间，以便在其中运行不可拆分函数，链接器检查任何静态链的不可拆分函数调用是否不超过此限制。</p><p>任何具有<code>//go:nosplit</code>注释的函数都应在其文档注释中解释为什么是不可拆分的。</p><h1 id="错误处理和上报"><a href="#错误处理和上报" class="headerlink" title="错误处理和上报"></a>错误处理和上报</h1><p>在用户代码中，有一些可以被合理地（reasonably）恢复的错误可以像往常一样使用<code>panic</code>，但是有一些情况下，<code>panic</code>可能导致立即的致命的错误，比如在系统栈中调用或者当执行<code>mallocgc</code>时。</p><p>大部分的 runtime 的错误是不可恢复的，对于这些不可恢复的错误应该使用<code>throw</code>，<code>throw</code>会打印出<code>traceback</code>并立即终止进程。<code>throw</code>应当被传入一个字符串常量以避免在该情况下还需要为 string 分配内存。根据约定，更多的信息应当在<code>throw</code>之前使用<code>print</code>或者<code>println</code>打印出来，并且应当以<code>runtime.</code>开头。</p><p>对于不可恢复的错误，如果用户代码有可能导致故障（例如并发 map 写入），请使用 fatal。</p><p>为了进行 runtime 的错误调试，可以使用<code>GOTRACEBACK=system</code>或<code>GOTRACEBACK=crash</code>运行。<code>panic</code>和<code>fatal</code>的输出由<code>GOTRACEBACK</code>描述。<code>throw</code>的输出始终包括 runtime stack、元数据和所有 goroutines，无论<code>GOTRACEBACK</code>是什么（即与<code>GOTRACEBACK=system</code>等效）。是否让<code>throw</code>崩溃仍然受<code>GOTRACEBACK</code>控制。</p><h1 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h1><p>runtime 中有多种同步机制，这些同步机制不仅是语义上不同，和 go 调度器以及操作系统调度器之间的交互也是不一样的。</p><p>最简单的就是<code>mutex</code>，可以使用<code>lock</code>和<code>unlock</code>来操作。这种方法主要用来短期（长期的话性能差）地保护一些共享的数据。在<code>mutex</code>上阻塞会直接阻塞整个<code>M</code>，而不会和 go 的调度器进行交互。因此，在 runtime 中的最底层使用 <code>mutex</code>是安全的，因为它还会阻止相关联的<code>G</code>和<code>P</code>被重新调度（<code>M</code>都阻塞了，无法执行调度了）。<code>rwmutex</code>也是类似的。</p><p>如果是要进行一次性的通知，可以使用<code>note</code>。<code>note</code>提供了<code>notesleep</code>和<code>notewakeup</code>。不像传统的 UNIX 的<code>sleep/wakeup</code>，<code>note</code>是无竞争的（race-free），所以如果<code>notewakeup</code>已经发生了，那么<code>notesleep</code>将会立即返回。<code>note</code>可以在使用后通过<code>noteclear</code>来重置，但是要注意<code>noteclear</code>和<code>notesleep</code>、<code>notewakeup</code>不能发生竞争。类似<code>mutex</code>，阻塞在<code>note</code>上会阻塞整个<code>M</code>。然而，<code>note</code>提供了不同的方式来调用<code>sleep</code>：<code>notesleep</code>会阻止相关联的<code>G</code>和<code>P</code>被重新调度；<code>notetsleepg</code>的表现却像一个阻塞的系统调用一样，允许<code>P</code>被重用去运行另一个<code>G</code>。尽管如此，这仍然比直接阻塞一个<code>G</code>要低效，因为这需要消耗一个<code>M</code>。</p><p>如果需要直接和 go 调度器交互，可以使用<code>gopark</code>和<code>goready</code>。<code>gopark</code>挂起当前的 goroutine——把它变成<code>waiting</code>状态，并从调度器的运行队列中移除——然后调度另一个 goroutine 到当前的<code>M</code>或者<code>P</code>。<code>goready</code>将一个被挂起的 goroutine 恢复到<code>runnable</code>状态并将它放到运行队列中。</p><p>总结起来如下表：</p><table><tbody><tr><th></th><th colspan="3">Blocks</th></tr><tr><th>Interface</th><th>G</th><th>M</th><th>P</th></tr><tr><td>(rw)mutex</td><td>Y</td><td>Y</td><td>Y</td></tr><tr><td>note</td><td>Y</td><td>Y</td><td>Y/N</td></tr><tr><td>park</td><td>Y</td><td>N</td><td>N</td></tr></tbody></table><h1 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h1><p>runtime 使用<code>runtime/internal/atomic</code>中自有的一些原子操作。这个和<code>sync/atomic</code>是对应的，除了方法名由于历史原因有一些区别，并且有一些额外的 runtime 需要的方法。</p><p>总的来说，我们对于 runtime 中 atomic 的使用非常谨慎，并且尽可能避免不需要的原子操作。如果对于一个变量的访问已经被另一种同步机制所保护，那么这个已经被保护的访问一般就不需要是原子的。这么做主要有以下原因：</p><ol><li>合理地使用非原子和原子操作使得代码更加清晰可读，对于一个变量的原子操作意味着在另一处可能会有并发的对于这个变量的操作。</li><li>非原子的操作允许自动的竞争检测。runtime 本身目前并没有一个竞争检测器，但是未来可能会有。原子操作会使得竞争检测器忽视掉这个检测，但是非原子的操作可以通过竞争检测器来验证你的假设（是否会发生竞争）。</li><li>非原子的操作可以提高性能。</li></ol><p>当然，所有对于一个共享变量的非原子的操作都应当在文档中注明该操作是如何被保护的。</p><p>有一些比较普遍的将原子操作和非原子操作混合在一起的场景有：</p><ul><li>大部分操作都是读，且写操作被锁保护的变量。在锁保护的范围内，读操作没必要是原子的，但是写操作必须是原子的。在锁保护的范围外，读操作必须是原子的。</li><li>仅仅在 STW 期间发生的读操作，且 STW 期间不会有写操作。那么这个时候，读操作不需要是原子的。</li></ul><p>话虽如此，<code>Go Memory Model</code>给出的建议仍然成立<code>Don&#39;t be [too] clever</code>。runtime 的性能固然重要，但是鲁棒性（robustness）却更加重要。</p><h1 id="堆外内存（Unmanaged-memory）"><a href="#堆外内存（Unmanaged-memory）" class="headerlink" title="堆外内存（Unmanaged memory）"></a>堆外内存（Unmanaged memory）</h1><p>一般情况下，runtime 会尝试使用普通的方法来申请内存（堆上内存，gc 管理的），然而在某些情况 runtime 必须申请一些不被 gc 所管理的堆外内存（unmanaged memory）。这是很必要的，因为有可能该片内存就是内存管理器自身，或者说调用者没有一个<code>P</code>（译者注：比如在调度器初始化之前，是不存在<code>P</code>的）。</p><p>有三种方式可以申请堆外内存：</p><ul><li><code>sysAlloc</code>直接从操作系统获取内存，申请的内存必须是系统页表长度的整数倍。可以通过<code>sysFree</code>来释放。</li><li><code>persistentalloc</code>将多个小的内存申请合并在一起为一个大的<code>sysAlloc</code>以避免内存碎片（fragmentation）。然而，顾名思义，通过<code>persistentalloc</code>申请的内存是无法被释放的。</li><li><code>fixalloc</code>是一个<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Slab_allocation"><code>SLAB</code></a>风格的内存分配器，分配固定大小的内存。通过<code>fixalloc</code>分配的对象可以被释放，但是内存仅可以被相同的<code>fixalloc</code>池所重用。所以<code>fixalloc</code>适合用于相同类型的对象。</li></ul><p>一般来说，使用任何这些分配的类型应通过嵌入<code>runtime/internal/sys.NotInHeap</code>来标记为非堆上类型。</p><p>在堆外内存所分配的对象<strong>不应该</strong>包含堆上的指针对象，除非同时遵守了以下的规则：</p><ol><li>所有在堆外内存指向堆上的指针都必须是垃圾回收的根（garbage collection roots）。也就是说，所有指针必须可以通过一个全局变量所访问到，或者显式地使用<code>runtime.markroot</code>来标记。</li><li>如果内存被重用了，堆上的指针在被标记为 GC 根并且对 GC 可见前必须 以 0 初始化（zero-initialized，见后文）。不然的话，GC 可能会观察到过期的（stale）堆指针。可以参见下文<code>Zero-initialization versus zeroing</code>.</li></ol><h1 id="Zero-initialization-versus-zeroing"><a href="#Zero-initialization-versus-zeroing" class="headerlink" title="Zero-initialization versus zeroing"></a>Zero-initialization versus zeroing</h1><p>在 runtime 中有两种类型的零初始化，取决于内存是否已经初始化为了一个类型安全的状态。</p><p>如果内存不在一个类型安全的状态，意思是可能由于刚被分配，并且第一次初始化使用，会含有一些垃圾值（译者注：这个概念在日常的 Go 代码中是遇不到的，如果学过 C 语言的同学应该能理解什么意思），那么这片内存必须使用<code>memclrNoHeapPointers</code>进行<code>zero-initialized</code>或者无指针的写。这不会触发写屏障（译者注：写屏障是 GC 中的一个概念）。</p><p>内存可以通过<code>typedmemclr</code>或者<code>memclrHasPointers</code>来写入零值，设置为类型安全的状态。这会触发写屏障。</p><h1 id="Runtime-only-编译指令（compiler-directives）"><a href="#Runtime-only-编译指令（compiler-directives）" class="headerlink" title="Runtime-only 编译指令（compiler directives）"></a>Runtime-only 编译指令（compiler directives）</h1><p>除了<code>go doc compile</code>中注明的<code>//go:</code>编译指令外，编译器在 runtime 包中支持了额外的一些指令。</p><h2 id="go-systemstack"><a href="#go-systemstack" class="headerlink" title="go:systemstack"></a>go:systemstack</h2><p><code>go:systemstack</code>表明一个函数必须在系统栈上运行，这个会通过一个特殊的函数前引（prologue）动态地验证。</p><h2 id="go-nowritebarrier"><a href="#go-nowritebarrier" class="headerlink" title="go:nowritebarrier"></a>go:nowritebarrier</h2><p><code>go:nowritebarrier</code>告知编译器如果以下函数包含了写屏障，触发一个错误（这不会阻止写屏障的生成，只是单纯一个假设）。</p><p>一般情况下你应该使用<code>go:nowritebarrierrec</code>。<code>go:nowritebarrier</code>当且仅当“最好不要”写屏障，但是非正确性必须的情况下使用。</p><h2 id="go-nowritebarrierrec-与-go-yeswritebarrierrec"><a href="#go-nowritebarrierrec-与-go-yeswritebarrierrec" class="headerlink" title="go:nowritebarrierrec 与 go:yeswritebarrierrec"></a>go:nowritebarrierrec 与 go:yeswritebarrierrec</h2><p><code>go:nowritebarrierrec</code>告知编译器如果以下函数以及它调用的函数（递归下去），直到一个<code>go:yeswritebarrierrec</code>为止，包含了一个写屏障的话，触发一个错误。</p><p>逻辑上，编译器会在生成的调用图上从每个<code>go:nowritebarrierrec</code>函数出发，直到遇到了<code>go:yeswritebarrierrec</code>的函数（或者结束）为止。如果其中遇到一个函数包含写屏障，那么就会产生一个错误。</p><p><code>go:nowritebarrierrec</code>主要用来实现写屏障自身，用来避免死循环。</p><p>这两种编译指令都在调度器中所使用。写屏障需要一个活跃的<code>P</code>(<code>getg().m.p != nil</code>)，然而调度器相关代码有可能在没有一个活跃的<code>P</code>的情况下运行。在这种情况下，<code>go:nowritebarrierrec</code>会用在一些释放<code>P</code>或者没有<code>P</code>的函数上运行，<code>go:yeswritebarrierrec</code>会用在重新获取到了<code>P</code>的代码上。因为这些都是函数级别的注释，所以释放<code>P</code>和获取<code>P</code>的代码必须被拆分成两个函数。</p><h2 id="go-uintptrkeepalive"><a href="#go-uintptrkeepalive" class="headerlink" title="go:uintptrkeepalive"></a>go:uintptrkeepalive</h2><p>&#x2F;&#x2F;go:uintptrkeepalive 指令后面必须跟随一个函数声明。</p><p>它指定函数的 uintptr 参数可能是已转换为 uintptr 的指针值，并且在整个调用期间必须保持活动状态，即使从类型本身看在调用期间对象不再需要。</p><p>该指令类似于 &#x2F;&#x2F;go:uintptrescapes，但不强制逃逸参数。由于堆栈增长不理解这些参数，此指令必须与 &#x2F;&#x2F;go:nosplit 一起使用（在标记函数中以及所有传递参数的函数中），以防止堆栈增长。</p><p>从指针到 uintptr 的转换必须出现在此函数的任何调用参数列表中。此指令用于某些低级系统调用实现。</p></div><footer class="post-footer"><div class="reward-container"><div>请博主喝杯咖啡~</div> <button> 赞赏</button><div class="post-reward"><div> <img src="https://static.purewhite.io/wechat_pay.jpeg" alt="Pure White 微信"> <span>微信</span></div><div> <img src="https://static.purewhite.io/alipay.jpeg" alt="Pure White 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Pure White</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.purewhite.io/2019/11/28/runtime-hacking-translate/" title="golang 在 runtime 中的一些骚东西">https://www.purewhite.io/2019/11/28/runtime-hacking-translate/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="followme"> <span>欢迎关注我的其它发布渠道</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://static.purewhite.io/wechat_channel.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-tags"> <a href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag"># 后端</a> <a href="/tags/go/" rel="tag"># go</a> <a href="/tags/asm/" rel="tag"># asm</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2019/11/06/new-gitlab-git-flow-spec/" rel="prev" title="一种基于 gitlab 的适用于版本发布的 git-flow 协作规范"><i class="fa fa-angle-left"></i> 一种基于 gitlab 的适用于版本发布的 git-flow 协作规范</a></div><div class="post-nav-item"> <a href="/2020/06/30/golang-indirect-function-allocate/" rel="next" title="为什么 Golang 函数赋值会产生内存分配？">为什么 Golang 函数赋值会产生内存分配？<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="disqus_thread"><noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">沪ICP备15051443号-3</a> <img src="https://static.purewhite.io/images/2019-10-30-%E5%A4%87%E6%A1%88%E5%9B%BE%E6%A0%87.png" alt=""><a href="https://beian.mps.gov.cn/#/query/webSearch?code=31010602004105" rel="noopener" target="_blank">沪公网安备 31010602004105号</a></div><div class="copyright"> &copy; 2017 – <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Pure White</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span title="站点总字数">92k</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span title="站点阅读时长">5:34</span></span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动</div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a> <a href="https://github.com/PureWhiteWu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js" integrity="sha256-ytMJGN3toR+a84u7g7NuHm91VIR06Q41kMWDr2pq7Zo=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/comments.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/utils.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/motion.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/schemes/muse.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/next-boot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/bookmark.min.js"></script><script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.20.0/dist/algoliasearch-lite.umd.js" integrity="sha256-DABVk+hYj0mdUzo+7ViJC6cwLahQIejFvC+my2M/wfM=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.60.0/dist/instantsearch.production.min.js" integrity="sha256-9242vN47QUX50UG5Gf5XDO1YREWCEJRyXHofh5fsl24=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/third-party/search/algolia-search.min.js"></script><script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdn.jsdelivr.net/npm/wavedrom@3.3.0/wavedrom.min.js","integrity":"sha256-IRMDzTC+wK5stMucZ/XSXkeS5VNtxZ+/Bm8Mcqfoxdo="}}</script><script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdn.jsdelivr.net/npm/wavedrom@3.3.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/third-party/tags/wavedrom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/third-party/fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/third-party/pace.min.js"></script><script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"DyCyUXRHZzXfXMk2Y2ysMPgL-gzGzoHsz","app_key":"7ULdnCBPkXxF6ArPc8VxaXy4","server_url":"https://leancloud.purewhite.io","security":true}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/third-party/statistics/lean-analytics.min.js"></script><script src="https://cdn.jsdelivr.net/npm/quicklink@2.3.0/dist/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script><script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"ignores":null,"url":"https://www.purewhite.io/2019/11/28/runtime-hacking-translate/"}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/third-party/quicklink.min.js"></script><script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"blog-zr0zqnlt9p","count":true,"i18n":{"disqus":"disqus"}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/third-party/comments/disqus.min.js"></script></body></html>
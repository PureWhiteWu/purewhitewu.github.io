<!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/han-css@3/dist/han.min.css"><meta name="google-site-verification" content="Xg_Hnp9ie-Rq7-zLPdd3c9dQtR_0N845ue4QaK8jvL4"><link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css"><link rel="stylesheet" href="https://use.fontawesome.com/11d7545abd.css"><link rel="stylesheet" href="/css/main.css?v=7.0.1"><link rel="apple-touch-icon" sizes="180x180" href="https://static.purewhite.io/favicon.jpg?v=7.0.1"><link rel="icon" type="image/png" sizes="32x32" href="https://static.purewhite.io/favicon.jpg?v=7.0.1"><link rel="icon" type="image/png" sizes="16x16" href="https://static.purewhite.io/favicon.jpg?v=7.0.1"><link rel="mask-icon" href="https://static.purewhite.io/favicon.jpg?v=7.0.1" color="#222"><meta property="fb:admins" content="100008177860594"><meta property="fb:app_id" content="761738893983932"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"7.0.1",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!0,onmobile:!1,dimmer:!1},back2top:!0,back2top_sidebar:!1,fancybox:!0,fastclick:!0,lazyload:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"ZP9482CZD3",apiKey:"d26207a3ce8de9fe98e7af4215425c93",indexName:"Blog",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="简介kubeadm是一个kubernetes官方提供的快速安装和初始化拥有最佳实践（best practice）的kubernetes集群的工具，虽然目前还处于 beta 和 alpha 状态，还不能用在生产环境，但是我们可以通过学习这种部署方法来体会一些官方推荐的kubernetes最佳实践的设计和思想。"><meta name="keywords" content="后端,架构,kubernetes,kubeadm"><meta property="og:type" content="article"><meta property="og:title" content="使用 kubeadm 创建一个 kubernetes 集群"><meta property="og:url" content="https://purewhite.io/2017/12/17/use-kubeadm-setup-k8s/index.html"><meta property="og:site_name" content="Pure White"><meta property="og:description" content="简介kubeadm是一个kubernetes官方提供的快速安装和初始化拥有最佳实践（best practice）的kubernetes集群的工具，虽然目前还处于 beta 和 alpha 状态，还不能用在生产环境，但是我们可以通过学习这种部署方法来体会一些官方推荐的kubernetes最佳实践的设计和思想。"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://static.purewhite.io/images/2017-12-17-91C23F22-58A4-4F03-842F-97018D78F9D8.png"><meta property="og:image" content="https://static.purewhite.io/images/2017-12-17-2256534A-2144-4118-843C-7179EF34EC49.png"><meta property="og:image" content="https://static.purewhite.io/images/2017-12-17-1E93FFDE-F0FE-4C7B-9207-6B8DF3EE7787.png"><meta property="og:updated_time" content="2019-03-18T06:14:08.129Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="使用 kubeadm 创建一个 kubernetes 集群"><meta name="twitter:description" content="简介kubeadm是一个kubernetes官方提供的快速安装和初始化拥有最佳实践（best practice）的kubernetes集群的工具，虽然目前还处于 beta 和 alpha 状态，还不能用在生产环境，但是我们可以通过学习这种部署方法来体会一些官方推荐的kubernetes最佳实践的设计和思想。"><meta name="twitter:image" content="https://static.purewhite.io/images/2017-12-17-91C23F22-58A4-4F03-842F-97018D78F9D8.png"><link rel="alternate" href="/atom.xml" title="Pure White" type="application/atom+xml"><link rel="canonical" href="https://purewhite.io/2017/12/17/use-kubeadm-setup-k8s/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>使用 kubeadm 创建一个 kubernetes 集群 | Pure White</title><script>window.fbAsyncInit=function(){FB.init({appId:"761738893983932",xfbml:!0,version:"v2.10"})},function(e,n,t){var o,c=e.getElementsByTagName(n)[0];e.getElementById(t)||((o=e.createElement(n)).id=t,o.src="//connect.facebook.net/zh_Hans/sdk.js",c.parentNode.insertBefore(o,c))}(document,"script","facebook-jssdk")</script><script async src="//www.googletagmanager.com/gtag/js?id=UA-98194081-1"></script><script>var host=window.location.hostname;if("localhost"!==host){function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-98194081-1")}</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?a29bb47eea3aa0d952f7bd979b29fa84";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Pure White</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">主业写bug，副业debug</h1></div><div class="site-nav-toggle"> <button aria-label="Toggle navigation bar"><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-关于我"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于我</a></li><li class="menu-item menu-item-标签"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-分类"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></li></ul><div class="site-search"><div class="algolia-popup popup search-popup"><div class="algolia-search"><div class="algolia-search-input-icon"><i class="fa fa-search"></i></div><div class="algolia-search-input" id="algolia-search-input"></div></div><div class="algolia-results"><div id="algolia-stats"></div><div id="algolia-hits"></div><div id="algolia-pagination" class="algolia-pagination"></div></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div></div></nav></div></header> <a href="https://github.com/PureWhiteWu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#222;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><div class="reading-progress-bar"></div><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://purewhite.io/2017/12/17/use-kubeadm-setup-k8s/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Pure White"><meta itemprop="description" content="青春不是年华，是心境；<br />青春不是桃面、丹唇、柔膝，<br />而是深沉的意志、恢弘的想象、<br />炽热的感情。"><meta itemprop="image" content="https://static.purewhite.io/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Pure White"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">使用 kubeadm 创建一个 kubernetes 集群</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2017-12-17 17:22:34" itemprop="dateCreated datePublished" datetime="2017-12-17T17:22:34+08:00">2017-12-17</time> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2019-03-18 14:14:08" itemprop="dateModified" datetime="2019-03-18T14:14:08+08:00">2019-03-18</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/kubernetes/" itemprop="url" rel="index"><span itemprop="name">kubernetes</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span> <span class="post-meta-item-text">Comments:</span><a href="/2017/12/17/use-kubeadm-setup-k8s/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/12/17/use-kubeadm-setup-k8s/" itemprop="commentCount"></span></a></span> <span id="/2017/12/17/use-kubeadm-setup-k8s/" class="leancloud_visitors" data-flag-title="使用 kubeadm 创建一个 kubernetes 集群"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">Views:</span><span class="leancloud-visitors-count"></span></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">Symbols count in article:</span> <span title="Symbols count in article">4.5k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">Reading time &asymp;</span> <span title="Reading time">4 mins.</span></div></div></header><div class="post-body han-init-context" itemprop="articleBody"><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><code>kubeadm</code>是一个<code>kubernetes</code>官方提供的快速安装和初始化拥有<strong>最佳实践（best practice）</strong>的<code>kubernetes</code>集群的工具，虽然目前还处于 beta 和 alpha 状态，还不能用在生产环境，但是我们可以通过学习这种部署方法来体会一些官方推荐的kubernetes最佳实践的设计和思想。</p><a id="more"></a><p><code>kubeadm</code>的目标是提供一个最小可用的可以通过<code>Kubernetes一致性测试</code>的集群，所以并不会安装任何除此之外的非必须的addon。</p><p><code>kubeadm</code>默认情况下并不会安装一个网络解决方案，所以用<code>kubeadm</code>安装完之后 需要自己来安装一个网络的插件。</p><h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><h2 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h2><p><code>kubeadm</code>支持多种系统，这里简单介绍一下需要的系统要求：</p><ol><li>Ubuntu16.04+ / Debian 9 / CentOS 7 / RHEL 7 / Fedora 25/26(best-effort) / HypriotOS v1.0.1+ / Other</li><li>2GB或者以上的RAM（否则将没有足够空间留给app）</li><li>2核以上CPU</li><li>集群的机器之间必须能通过网络互相通信</li><li><strong><u>SWAP必须被关闭，否则<code>kubelet</code>会出错！</u></strong></li></ol><p>具体的详细信息可以在官方网站上看到。</p><p>本篇内容基于aws的ap-northeast-1的ec2，<code>CentOS 7</code>的操作系统（ami-4dd5522b），实例类型t2.medium 2核4GB，3台机器，1 master，2 nodes，kubernetes 1.9 版本。为了方便起见，在安全组里面打开了所有的端口和IP访问。</p><p>机器配置：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[centos@ip-172-31-24-49 ~]$ uname -a</span><br><span class="line">Linux ip-172-31-24-49.ap-northeast-1.compute.internal 3.10.0-693.5.2.el7.x86_64 #1 SMP Fri Oct 20 20:32:50 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure><p>首先 ，我们关闭selinux：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo vim /etc/sysconfig/selinux</span></span><br></pre></td></tr></table></figure><p><img src="https://static.purewhite.io/images/2017-12-17-91C23F22-58A4-4F03-842F-97018D78F9D8.png" alt="91C23F22-58A4-4F03-842F-97018D78F9D8"></p><p>把SELINUX改成disabled，然后保存退出。</p><p>在我用的ami中，swap是默认关闭的，所以不需要我手动关闭，大家需要确认 自己的环境中swap是否有关闭掉，否则会在之后的环节中出问题。</p><p>为了方便我们安装，我们将sshd设置为keepalive：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo -i</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"ClientAliveInterval 10"</span> &gt;&gt; /etc/ssh/sshd_config</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"TCPKeepAlive yes"</span> &gt;&gt; /etc/ssh/sshd_config</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl restart sshd.service</span></span><br></pre></td></tr></table></figure><p>接下来我们重启一下机器：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo sync</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo reboot</span></span><br></pre></td></tr></table></figure><p>至此，准备阶段结束。</p><h2 id="安装kubeadm"><a href="#安装kubeadm" class="headerlink" title="安装kubeadm"></a>安装kubeadm</h2><p>首先，我们需要在所有机器上都安装<code>docker</code>, <code>kubeadm</code>, <code>kubelet</code>和<code>kubectl</code>。</p><p>切记：<strong><code>kubeadm</code>不会自动去安装和管理 <code>kubelet</code>和<code>kubectl</code>，所以需要自己去确保安装的版本和你想要安装的<code>kubernetes</code>版本相同。</strong></p><p>安装<code>docker</code>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install -y docker</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl <span class="built_in">enable</span> docker &amp;&amp; sudo systemctl start docker</span></span><br></pre></td></tr></table></figure><p>在RHEL/CentOS 7 系统上可能会路由失败，我们需要设置一下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo -i</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf</span></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo sysctl --system</span></span><br></pre></td></tr></table></figure><p>接下来我们需要安装<code>kubeadm</code>, <code>kubelet</code>和<code>kubectl</code>了，我们需要先加一个repo：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>然后安装：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install -y kubelet kubeadm kubectl</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl <span class="built_in">enable</span> kubelet &amp;&amp; sudo systemctl start kubelet</span></span><br></pre></td></tr></table></figure><p>至此，在所有机器上安装所需的软件已经结束。</p><h2 id="使用kubeadm初始化master"><a href="#使用kubeadm初始化master" class="headerlink" title="使用kubeadm初始化master"></a>使用kubeadm初始化master</h2><p>安装完所有的依赖之后，我们就可以用<code>kubeadm</code>初始化master了。</p><p>最简单的初始化方法是：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubeadm init</span></span><br></pre></td></tr></table></figure><p>除此之外，<code>kubeadm</code>还支持多种方法来配置，具体可以查看一下官方文档。</p><p>我们在初始化的时候指定一下kubernetes版本，并设置一下pod-network-cidr（后面的flannel会用到）：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo -i</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubeadm init --kubernetes-version=v1.9.0 --pod-network-cidr=10.244.0.0/16</span></span><br></pre></td></tr></table></figure><p>在这个过程中<code>kubeadm</code>执行了一系列的操作，包括一些pre-check，生成ca证书，安装etcd和其它控制组件等。</p><p>界面差不多如下：</p><p><img src="https://static.purewhite.io/images/2017-12-17-2256534A-2144-4118-843C-7179EF34EC49.png" alt="2256534A-2144-4118-843C-7179EF34EC49"></p><p>最下面的这行<code>kubeadm join</code>什么的，就是用来让别的node加入集群的，可以看出非常方便。我们要保存好这一行东西，这是我们之后让node加入集群的凭据，一会儿会用到。</p><p>这个时候，我们还不能通过<code>kubectl</code>来控制集群，要让<code>kubectl</code>可用，我们需要做：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 对于非root用户</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p <span class="variable">$HOME</span>/.kube</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对于root用户</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以直接放到~/.bash_profile</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"export KUBECONFIG=/etc/kubernetes/admin.conf"</span> &gt;&gt; ~/.bash_profile</span></span><br></pre></td></tr></table></figure><p>接下来要注意，我们<strong>必须</strong>自己来安装一个network addon。</p><p><strong><u>network addon必须在任何app部署之前安装好。同样的，<code>kube-dns</code>也会在network addon安装好之后才启动。<code>kubeadm</code>只支持CNI-based networks（不支持<code>kubenet</code>）。</u></strong></p><p>比较常见的network addon有：<code>Calico</code>, <code>Canal</code>, <code>Flannel</code>, <code>Kube-router</code>, <code>Romana</code>, <code>Weave Net</code>等。这里我们使用<code>Flannel</code>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.9.1/Documentation/kube-flannel.yml</span></span><br></pre></td></tr></table></figure><p>安装完network之后，你可以通过<code>kubectl get pods --all-namespaces</code>来查看<code>kube-dns</code>是否在running来判断network是否安装成功。</p><p>默认情况下，为了保证master的安全，master是不会被调度到app的。你可以取消这个限制通过输入：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl taint nodes --all node-role.kubernetes.io/master-</span></span><br></pre></td></tr></table></figure><h2 id="加入nodes"><a href="#加入nodes" class="headerlink" title="加入nodes"></a>加入nodes</h2><p>终于部署完了我们的master！</p><p>现在我们开始加入一些node到我们的集群里面吧！</p><p>ssh到我们的node节点上，执行刚才下面给出的那个 <code>kubeadm join</code>的命令（每个人不同）：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo -i</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubeadm join --token 72a8a4.2ed9076cd668b8b7 172.31.31.60:6443 --discovery-token-ca-cert-hash sha256:f0894e55d475f882dd40d52c6d01f758017ec5729be632294049f687330f60d2</span></span><br></pre></td></tr></table></figure><p>输出差不多如下图：</p><p><img src="https://static.purewhite.io/images/2017-12-17-1E93FFDE-F0FE-4C7B-9207-6B8DF3EE7787.png" alt="1E93FFDE-F0FE-4C7B-9207-6B8DF3EE7787"></p><p>这时候，我们去master上输入<code>kubectl get nodes</code>查看一下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@i-071abd86ed304dc84 ~]# kubectl get nodes</span><br><span class="line">NAME                  STATUS    ROLES     AGE       VERSION</span><br><span class="line">i-071abd86ed304dc84   Ready     master    12m       v1.9.0</span><br><span class="line">i-0c559ad3c0b16fd36   Ready     &lt;none&gt;    1m        v1.9.0</span><br><span class="line">i-0f3f7462b0a004b5e   Ready     &lt;none&gt;    47s       v1.9.0</span><br></pre></td></tr></table></figure><p>成功！</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>我们可以看到，用<code>kubeadm</code>部署可以让我们比手动部署方便得多，虽然比不上<code>kops</code>这样的一键部署生产Kubernetes集群的工具，但是<code>kubeadm</code>最初的设计也并非是傻瓜式使用。</p><p><code>kubeadm</code>给了用户很多的灵活性，让用户可以完全自定义地去配置自己的集群。</p><p>不过目前（截止博客发布为止），<code>kubeadm</code>还只是在测试，官方还不建议在生产环境中使用，不过预计会在2018年春季可以投入生产使用。</p><p>最后，我们总结一下<code>kubeadm</code>最核心的几个概念：</p><ul><li>官方认为的 最佳实践（best-practice）</li><li>合理的安全（reasonably secure）</li><li>可扩展（extensible）</li><li>最小可用（minimum viable）</li></ul></div><div><div id="reward-container"><div>请博主喝杯咖啡~</div> <button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';"> Donate</button><div id="qr" style="display:none"><div style="display:inline-block"> <img src="https://static.purewhite.io/wechat_pay.jpeg" alt="Pure White WeChat Pay"><p>WeChat Pay</p></div><div style="display:inline-block"> <img src="https://static.purewhite.io/alipay.jpeg" alt="Pure White Alipay"><p>Alipay</p></div></div></div></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/后端/" rel="tag"># 后端</a> <a href="/tags/架构/" rel="tag"># 架构</a> <a href="/tags/kubernetes/" rel="tag"># kubernetes</a> <a href="/tags/运维/" rel="tag"># 运维</a> <a href="/tags/docker/" rel="tag"># docker</a> <a href="/tags/linux/" rel="tag"># linux</a></div><div class="post-widgets"><div class="wp_rating"><div id="wpac-rating"></div></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/12/14/cas-authentication/" rel="next" title="CAS认证"><i class="fa fa-chevron-left"></i> CAS认证</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2017/12/21/design-pattern-opening-words/" rel="prev" title="《Head First 设计模式》读书笔记0.5 —— 引子">《Head First 设计模式》读书笔记0.5 —— 引子<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div><div class="comments" id="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> Table of Contents</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> Overview</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="https://static.purewhite.io/avatar.jpg" alt="Pure White"><p class="site-author-name" itemprop="name">Pure White</p><div class="site-description motion-element" itemprop="description">青春不是年华，是心境；<br>青春不是桃面、丹唇、柔膝，<br>而是深沉的意志、恢弘的想象、<br>炽热的感情。</div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives"><span class="site-state-item-count">48</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">15</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">30</span> <span class="site-state-item-name">tags</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/PureWhiteWu" title="GitHub &rarr; https://github.com/PureWhiteWu" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:daniel48@126.com" title="E-Mail &rarr; mailto:daniel48@126.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://twitter.com/PureWhite_Wu" title="Twitter &rarr; https://twitter.com/PureWhite_Wu" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i> Twitter</a></span><span class="links-of-author-item"><a href="https://www.linkedin.com/in/%E8%BF%AA-%E5%90%B4-846051106/" title="LinkedIn &rarr; https://www.linkedin.com/in/%E8%BF%AA-%E5%90%B4-846051106/" rel="noopener" target="_blank"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a></span><span class="links-of-author-item"><a href="https://telegram.me/PureWhiteWu" title="Telegram &rarr; https://telegram.me/PureWhiteWu" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i> Telegram</a></span><span class="links-of-author-item"><a href="http://weibo.com/purewhitewu" title="微博 &rarr; http://weibo.com/purewhitewu" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> 微博</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/PureWhite_Wu" title="知乎 &rarr; https://www.zhihu.com/people/PureWhite_Wu" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i> 知乎</a></span><span class="links-of-author-item"><a href="https://static.purewhite.io/wechat.jpeg" title="微信 &rarr; https://static.purewhite.io/wechat.jpeg" rel="noopener" target="_blank"><i class="fa fa-fw fa-weixin"></i> 微信</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="http://blog.didispace.com/" title="http://blog.didispace.com/" rel="noopener" target="_blank">程序猿DD</a></li><li class="links-of-blogroll-item"> <a href="http://www.v2ex.com/?r=PureWhiteWu" title="http://www.v2ex.com/?r=PureWhiteWu" rel="noopener" target="_blank">v2ex</a></li></ul></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#使用"><span class="nav-number">2.</span> <span class="nav-text">使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#系统环境"><span class="nav-number">2.1.</span> <span class="nav-text">系统环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装kubeadm"><span class="nav-number">2.2.</span> <span class="nav-text">安装kubeadm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用kubeadm初始化master"><span class="nav-number">2.3.</span> <span class="nav-text">使用kubeadm初始化master</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#加入nodes"><span class="nav-number">2.4.</span> <span class="nav-text">加入nodes</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li></ol></div></div></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> <a href="http://www.miitbeian.gov.cn" rel="noopener" target="_blank">沪ICP备15051443号-3</a> &copy; 2017 – <span itemprop="copyrightYear">2019</span><span class="with-love" id="animate"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">Pure White</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">Symbols count total:</span> <span title="Symbols count total">137k</span></div><div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div> <span class="post-meta-divider">|</span><div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.0.1</div><script>!function(){var e=document.createElement("script");e.src="//tajs.qq.com/stats?sId=61888292";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script><script src="/lib/reading_progress/reading_progress.js"></script><script src="/js/src/utils.js?v=7.0.1"></script><script src="/js/src/motion.js?v=7.0.1"></script><script src="/js/src/schemes/muse.js?v=7.0.1"></script><script src="/js/src/scrollspy.js?v=7.0.1"></script><script src="/js/src/post-details.js?v=7.0.1"></script><script src="/js/src/next-boot.js?v=7.0.1"></script><script src="/js/src/js.cookie.js?v=7.0.1"></script><script src="/js/src/scroll-cookie.js?v=7.0.1"></script><script id="dsq-count-scr" src="https://blog-zr0zqnlt9p.disqus.com/count.js" async></script><script>var disqus_config=function(){this.page.url="https://purewhite.io/2017/12/17/use-kubeadm-setup-k8s/",this.page.identifier="2017/12/17/use-kubeadm-setup-k8s/",this.page.title="使用 kubeadm 创建一个 kubernetes 集群"};function loadComments(){var t=document,e=t.createElement("script");e.src="https://blog-zr0zqnlt9p.disqus.com/embed.js",e.setAttribute("data-timestamp",""+ +new Date),(t.head||t.body).appendChild(e)}$(function(){$("#comments").offset().top-$(window).height()<=0?loadComments():$(window).on("scroll.disqus_scroll",function(){$("#comments").offset().top-$(window).height()-$(window).scrollTop()<60&&($(window).off(".disqus_scroll"),loadComments())})})</script><link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css"><script src="/lib/algolia-instant-search/instantsearch.min.js"></script><script src="/js/src/algolia-search.js?v=7.0.1"></script><script>
    
    function addCount(Counter) {
      var $visitors = $('.leancloud_visitors');
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text(counter.time + 1);
            
            Counter('put', '/classes/Counter/' + counter.objectId, JSON.stringify({ time: { '__op': 'Increment', 'amount': 1 } }))
            
              .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
              })
          } else {
            
              Counter('post', '/classes/Counter', JSON.stringify({ title: title, url: url, time: 1 }))
                .done(function() {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(1);
                })
                .fail(function() {
                  console.log('Failed to create');
                });
            
          }
        })
        .fail(function ({ responseJSON }) {
          console.log('LeanCloud Counter Error: ' + responseJSON.code + ' ' + responseJSON.error);
        });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + 'Sa9GIjpR90eFliBWzUAiUp9W-gzGzoHsz')
        .done(function({ api_server }) {
          var Counter = function(method, url, data) {
            return $.ajax({
              method: method,
              url: 'https://' + api_server + '/1.1' + url,
              headers: {
                'X-LC-Id': 'Sa9GIjpR90eFliBWzUAiUp9W-gzGzoHsz',
                'X-LC-Key': 'rSpeP2HoYIdOYJr4p2elMvLn',
                'Content-Type': 'application/json',
              },
              data: data
            });
          };
          
            addCount(Counter);
          
        });
    });
  </script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>wpac_init=window.wpac_init||[],wpac_init.push({widget:"Rating",id:8500,el:"wpac-rating",color:"fc6423"}),function(){if(!("WIDGETPACK_LOADED"in window)){WIDGETPACK_LOADED=!0;var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//embed.widgetpack.com/widget.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t.nextSibling)}}()</script><script src="/lib/pangu/dist/pangu.min.js?v=3.3"></script><script>pangu.spacingPage()</script><script src="/lib/bookmark/bookmark.min.js?v=1.0"></script><script>bookmark.scrollToMark("auto","#more")</script><script>$(".highlight").each(function(e,t){var n=$("<div>").addClass("highlight-wrap");$(t).after(n),n.append($("<button>").addClass("copy-btn").append("Copy").on("click",function(e){var t=$(this).parent().find(".code").find(".line").map(function(e,t){return $(t).text()}).toArray().join("\n"),n=document.createElement("textarea"),o=window.pageYOffset||document.documentElement.scrollTop;n.style.top=o+"px",n.style.position="absolute",n.style.opacity="0",n.readOnly=!0,n.value=t,document.body.appendChild(n),n.select(),n.setSelectionRange(0,t.length),n.readOnly=!1,document.execCommand("copy")?$(this).text("Copied"):$(this).text("Copy failed"),n.blur(),$(this).blur()})).on("mouseleave",function(e){var t=$(this).find(".copy-btn");setTimeout(function(){t.text("Copy")},300)}).append(t)})</script></body></html>
<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 5.4.0"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="apple-touch-icon" sizes="180x180" href="https://static.purewhite.io/favicon.jpg"><link rel="icon" type="image/png" sizes="32x32" href="https://static.purewhite.io/favicon.jpg"><link rel="icon" type="image/png" sizes="16x16" href="https://static.purewhite.io/favicon.jpg"><link rel="mask-icon" href="https://static.purewhite.io/favicon.jpg" color="#222"><meta name="google-site-verification" content="Xg_Hnp9ie-Rq7-zLPdd3c9dQtR_0N845ue4QaK8jvL4"><meta name="baidu-site-verification" content="c3b074df19d33f893845b6d092bc9169"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.purewhite.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.8.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":true,"nav":null,"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"ZP9482CZD3","apiKey":"d26207a3ce8de9fe98e7af4215425c93","indexName":"Blog","hits":{"per_page":10}}}</script><script src="/js/config.js"></script><meta name="description" content="有多少人工就有多少智能。                            ——鲁迅  缘起众所周知，字节跳动内部主要使用 Thrift，为了更好地掌控生成代码，我们用 Go 自己实现了 Thrift 代码生成工具。 而我们的故(shi)事(gu)，正是由一次重构开始……"><meta property="og:type" content="article"><meta property="og:title" content="使用人工智能优化 Golang 编译器"><meta property="og:url" content="https://www.purewhite.io/2020/10/14/manual-intelligence-optimize-golang-compiler/index.html"><meta property="og:site_name" content="Pure White"><meta property="og:description" content="有多少人工就有多少智能。                            ——鲁迅  缘起众所周知，字节跳动内部主要使用 Thrift，为了更好地掌控生成代码，我们用 Go 自己实现了 Thrift 代码生成工具。 而我们的故(shi)事(gu)，正是由一次重构开始……"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://static.purewhite.io/uPic/2020-10-14/QpVggz-image-20201014151957346.png!webp_90"><meta property="og:image" content="https://static.purewhite.io/uPic/2020-10-14/CjPx3x-image-20201014152156510.png!webp_90"><meta property="og:image" content="https://static.purewhite.io/uPic/2020-10-14/4lXjbo-image-20201014153941394.png!webp_90"><meta property="og:image" content="https://static.purewhite.io/uPic/2020-10-14/CijHWI-1602576741958_a607b2f22c9eaad1d2fa15f240e3d7f9.png!webp_90"><meta property="og:image" content="https://static.purewhite.io/uPic/2020-10-14/5xpCC2-1602577065517_13324d0f6a7ef6f60f4eb96f78b4d23d.png!webp_90"><meta property="og:image" content="https://static.purewhite.io/uPic/2020-10-14/ZuyUfz-image-20201014154039859.png!webp_90"><meta property="og:image" content="https://static.purewhite.io/uPic/2020-10-14/GkGorr-image-20201014154055511.png!webp_90"><meta property="og:image" content="https://static.purewhite.io/uPic/2020-10-14/OOtOtc-1602577689777_491ea856ccc372c98bbd3b7b83ecf03f.png!webp_90"><meta property="og:image" content="https://static.purewhite.io/uPic/2020-10-14/g4d2ua-image-20201014154314334.png!webp_90"><meta property="og:image" content="https://static.purewhite.io/uPic/2020-10-14/gz7Udp-1602579503413_8c994f7473789b1c81ac17040fd9aa1f.png!webp_90"><meta property="article:published_time" content="2020-10-14T08:26:00.000Z"><meta property="article:modified_time" content="2021-12-02T12:51:07.228Z"><meta property="article:author" content="Pure White"><meta property="article:tag" content="后端"><meta property="article:tag" content="go"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://static.purewhite.io/uPic/2020-10-14/QpVggz-image-20201014151957346.png!webp_90"><link rel="canonical" href="https://www.purewhite.io/2020/10/14/manual-intelligence-optimize-golang-compiler/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.purewhite.io/2020/10/14/manual-intelligence-optimize-golang-compiler/","path":"2020/10/14/manual-intelligence-optimize-golang-compiler/","title":"使用人工智能优化 Golang 编译器"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>使用人工智能优化 Golang 编译器 | Pure White</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-98194081-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-98194081-1","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script src="/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?587d2548655f9855727225afb0e4d708"></script><script async src="//assets.growingio.com/2.1/gio.js"></script><script class="next-config" data-name="growingio_analytics" type="application/json">"8a8c3a537a0132ac"</script><script src="/js/third-party/analytics/growingio.js"></script><script>!function(){var e=document.createElement("script");e.src="https://lf1-cdn-tos.bytegoofy.com/goofy/ttzz/push.js?c75fd468cb92e13256468f9ae3917db97049a5a91566914dbb6ab879288745b8bc434964556b7d7129e9b750ed197d397efd7b0c6c715c1701396e1af40cec962b8d7c8c6655c9b00211740aa8a98e2e",e.id="ttzz";var c=document.getElementsByTagName("script")[0];c.parentNode.insertBefore(e,c)}(window)</script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="Pure White" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="Pure White" type="application/rss+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">Pure White</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">主业写bug，副业debug</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-关于我"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于我</a></li><li class="menu-item menu-item-标签"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-分类"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container"><div class="algolia-stats"><hr></div><div class="algolia-hits"></div><div class="algolia-pagination"></div></div></div></div></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BC%98%E8%B5%B7"><span class="nav-number">1.</span> <span class="nav-text">缘起</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%AD%A3%E6%96%87"><span class="nav-number">2.</span> <span class="nav-text">正文</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#The-End"><span class="nav-number">3.</span> <span class="nav-text">The End</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Pure White" src="https://static.purewhite.io/avatar.jpg!webp_90"><p class="site-author-name" itemprop="name">Pure White</p><div class="site-description" itemprop="description">青春不是年华，是心境；<br>青春不是桃面、丹唇、柔膝，<br>而是深沉的意志、恢弘的想象、<br>炽热的感情。</div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">59</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">14</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">29</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/PureWhiteWu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;PureWhiteWu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:wudi@purewhite.io" title="E-Mail → mailto:wudi@purewhite.io" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://twitter.com/PureWhite_Wu" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;PureWhite_Wu" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i> Twitter</a></span><span class="links-of-author-item"><a href="https://www.linkedin.com/in/%E8%BF%AA-%E5%90%B4-846051106/" title="LinkedIn → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;%E8%BF%AA-%E5%90%B4-846051106&#x2F;" rel="noopener" target="_blank"><i class="fa fa-linkedin fa-fw"></i> LinkedIn</a></span><span class="links-of-author-item"><a href="https://telegram.me/PureWhiteWu" title="Telegram → https:&#x2F;&#x2F;telegram.me&#x2F;PureWhiteWu" rel="noopener" target="_blank"><i class="fa fa-telegram fa-fw"></i> Telegram</a></span><span class="links-of-author-item"><a href="http://weibo.com/purewhitewu" title="微博 → http:&#x2F;&#x2F;weibo.com&#x2F;purewhitewu" rel="noopener" target="_blank"><i class="fa fa-weibo fa-fw"></i> 微博</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/PureWhite_Wu" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;PureWhite_Wu" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i> 知乎</a></span><span class="links-of-author-item"><a href="https://static.purewhite.io/wechat_channel.jpg" title="微信 → https:&#x2F;&#x2F;static.purewhite.io&#x2F;wechat_channel.jpg" rel="noopener" target="_blank"><i class="fa fa-weixin fa-fw"></i> 微信</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i> RSS</a></span></div><div class="cc-license site-overview-item animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div><div class="links-of-blogroll site-overview-item animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="http://blog.didispace.com/" title="http:&#x2F;&#x2F;blog.didispace.com&#x2F;" rel="noopener" target="_blank">程序猿DD</a></li><li class="links-of-blogroll-item"> <a href="http://www.v2ex.com/?r=PureWhiteWu" title="http:&#x2F;&#x2F;www.v2ex.com&#x2F;?r&#x3D;PureWhiteWu" rel="noopener" target="_blank">v2ex</a></li><li class="links-of-blogroll-item"> <a href="https://yuzhouwan.com/" title="https:&#x2F;&#x2F;yuzhouwan.com&#x2F;" rel="noopener" target="_blank">宇宙湾</a></li><li class="links-of-blogroll-item"> <a href="https://pengrl.com/" title="https:&#x2F;&#x2F;pengrl.com&#x2F;" rel="noopener" target="_blank">yoko blog</a></li></ul></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a> <a href="https://github.com/PureWhiteWu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.purewhite.io/2020/10/14/manual-intelligence-optimize-golang-compiler/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://static.purewhite.io/avatar.jpg!webp_90"><meta itemprop="name" content="Pure White"><meta itemprop="description" content="青春不是年华，是心境；<br />青春不是桃面、丹唇、柔膝，<br />而是深沉的意志、恢弘的想象、<br />炽热的感情。"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Pure White"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 使用人工智能优化 Golang 编译器</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-10-14 16:26:00" itemprop="dateCreated datePublished" datetime="2020-10-14T16:26:00+08:00">2020-10-14</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2021-12-02 20:51:07" itemprop="dateModified" datetime="2021-12-02T20:51:07+08:00">2021-12-02</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a></span></span><span id="/2020/10/14/manual-intelligence-optimize-golang-compiler/" class="post-meta-item leancloud_visitors" data-flag-title="使用人工智能优化 Golang 编译器" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span class="leancloud-visitors-count"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Disqus：</span><a title="disqus" href="/2020/10/14/manual-intelligence-optimize-golang-compiler/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/10/14/manual-intelligence-optimize-golang-compiler/" itemprop="commentCount"></span></a></span><span class="post-meta-break"></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>4.4k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>8 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>有多少人工就有多少智能。 ——鲁迅</p></blockquote><h1 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a>缘起</h1><p>众所周知，字节跳动内部主要使用 Thrift，为了更好地掌控生成代码，我们用 Go 自己实现了 Thrift 代码生成工具。</p><p>而我们的故(shi)事(gu)，正是由一次重构开始……</p><span id="more"></span><p>在一次平淡无奇的重构发版后，正当我拎着电脑包往外冲心里已经盘算好了回去之后要拿出我熟练度 30W 的至臻 KDA 卡莎大杀四方时，业务方拉住了我，告诉我他们在用了新版的生成代码后，性能下降了10%。</p><p>内心 os：What？？？你们是不是有其它逻辑变更？<del>我写的代码怎么可能有 bug</del> 逻辑一模一样的生成代码怎么可能会有性能差异？</p><p>好吧，为了避免突然哪一天账号已停用，我还是耐心地问了业务方一个问题：</p> <img data-src="https://static.purewhite.io/uPic/2020-10-14/QpVggz-image-20201014151957346.png!webp_90" width="30%" alt="能重现吗？" style="margin:0 auto"><p>于是在一通如此这般地各种标准对齐、环境对齐等等一通操作（此处省略 2^10^10 字）后，我们终于搞清楚了状况：</p><p><strong>重构后的生成代码比重构之前，在该业务方的 idl 上，性能真的要差 10%！</strong></p><p>What？？？虽然重构过生成代码，但是新的生成代码无论从语义上还是实现上都是（几乎）和旧的一致的，怎么可能性能会差？？？</p><p>好吧，为了发扬我大 IG 不加班的光辉传统，我们决定直接十五投就完事——把生成代码 revert 回旧版的。好了，问题解决。（第二天，HR：小吴啊，财务室工资结一下）。</p> <img data-src="https://static.purewhite.io/uPic/2020-10-14/CjPx3x-image-20201014152156510.png!webp_90" width="30%" style="margin:0 auto"><h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>先附上我们用来讲解生成代码的 IDL：</p><figure class="highlight thrift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line">    <span class="number">1</span>: list&lt;list&lt;<span class="keyword">i64</span>&gt;&gt; data1,</span><br><span class="line">    <span class="number">2</span>: map&lt;<span class="keyword">i64</span>, list&lt;<span class="keyword">byte</span>&gt;&gt; data2,</span><br><span class="line">    <span class="number">3</span>: list&lt;map&lt;<span class="keyword">i64</span>, <span class="keyword">byte</span>&gt;&gt; data3,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">Serialize</span> </span>&#123;</span><br><span class="line">    Example Method (<span class="number">1</span>: Example req),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先，对比一下新旧生成代码（由于代码较多，就不直接贴在文章中了）。</p><p>旧代码：<a target="_blank" rel="noopener" href="https://gist.github.com/PureWhiteWu/bdd28734ab1f675bb7b73ecf0c57e994">https://gist.github.com/PureWhiteWu/bdd28734ab1f675bb7b73ecf0c57e994</a></p><p>新代码：<a target="_blank" rel="noopener" href="https://gist.github.com/PureWhiteWu/63ac02ee613695213fe9eac4e22493ba">https://gist.github.com/PureWhiteWu/63ac02ee613695213fe9eac4e22493ba</a></p><p>可以看到，新旧生成代码，在编解码逻辑上是完全等价的！不过旧代码采用了局部变量，新代码是直接用的对应结构体的字段。我们怀疑是不是这里的差异导致的（这可能会导致计算 offset 的开销），于是生成了汇编进行比较（由于汇编较大，不直接贴了，有兴趣的同学建议自行生成一下看一下），发现确实是多了一条 MOVQ 语句用来计算偏移量！</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MOVQ	&quot;&quot;.p+144(SP), AX</span><br></pre></td></tr></table></figure><p>看来罪魁祸首好像找到了？不过又感觉哪儿不太对，毕竟现代 CPU 都是有多级流水线的，就多这么一条 MOVQ 语句，对于多级流水线架构的 CPU 来说，性能差距再怎么不可能导致 10% 这么大，特别是尽管这个语句是在 for 循环中的，但是在总的执行的指令占比中也没有 10% 这么多。</p> <img data-src="https://static.purewhite.io/uPic/2020-10-14/4lXjbo-image-20201014153941394.png!webp_90" width="30%" style="margin:0 auto"><p>为了验证我们的疑问，我们改了一版生成代码，改为了和原先生成的一样使用临时变量，发现确实去掉了这条语句后，性能没有任何变化。也就是说，性能的问题并不是这个间接寻址导致的。</p><p>随后，根据生成代码的汇编差异，我们提出了许多猜想，花了大量时间进行验证，但是均不是性能变差的原因（此处过于心酸略过不表）。</p> <img data-src="https://static.purewhite.io/uPic/2020-10-14/CijHWI-1602576741958_a607b2f22c9eaad1d2fa15f240e3d7f9.png!webp_90" width="30%" style="margin:0 auto"><p>最终，我们定位到了是由于在新的生成代码中，相比旧版本的生成代码，在返回错误的时候会额外包装一下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err := ...; err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> thrift.PrependError(fmt.Sprintf(<span class="string">&quot;%T read field x &#x27;xxx&#x27; error: &quot;</span>, p), err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而旧版本的生成代码是直接返回的错误：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err := ...; err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>虽然这些只是在发生错误的时候才会调用到，在正常流程中不会用到，但是生成的汇编代码中这段逻辑占了相当大的比例：</p> <img data-src="https://static.purewhite.io/uPic/2020-10-14/5xpCC2-1602577065517_13324d0f6a7ef6f60f4eb96f78b4d23d.png!webp_90" width="70%" style="margin:0 auto"><p>而 Go 的编译器并没有帮我们重排这些指令，导致在真正运行的时候，L1 cache miss 大大提高，极大地降低了性能，参考如下实验结果：</p><p><img data-src="https://static.purewhite.io/uPic/2020-10-14/ZuyUfz-image-20201014154039859.png!webp_90" alt="Old"></p><p><img data-src="https://static.purewhite.io/uPic/2020-10-14/GkGorr-image-20201014154055511.png!webp_90" alt="New"></p><p>针对这种编译器太弱智导致的问题，只能上人工智能来解决了——有多少人工就有多少智能。</p> <img data-src="https://static.purewhite.io/uPic/2020-10-14/OOtOtc-1602577689777_491ea856ccc372c98bbd3b7b83ecf03f.png!webp_90" width="30%" style="margin:0 auto"><p>既然编译器不会自动做指令重排，那就我们来帮编译器干这事，改造完成后的生成代码见：<a target="_blank" rel="noopener" href="https://gist.github.com/PureWhiteWu/296f2bdac6051e4052a68c2bb1de1c07">https://gist.github.com/PureWhiteWu/296f2bdac6051e4052a68c2bb1de1c07</a></p><p>比较关键的方法是，我们在所有原先<code>return thrift.PrependError</code>的地方，都改为了<code>goto XXXError</code>，如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Example)</span> <span class="title">Read</span><span class="params">(iprot thrift.TProtocol)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	<span class="keyword">var</span> fieldTypeId thrift.TType</span><br><span class="line">	<span class="keyword">var</span> fieldId <span class="keyword">int16</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> _, err = iprot.ReadStructBegin(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">goto</span> ReadStructBeginError</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		_, fieldTypeId, fieldId, err = iprot.ReadFieldBegin()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">goto</span> ReadFieldBeginError</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> fieldTypeId == thrift.STOP &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">switch</span> fieldId &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">			<span class="keyword">if</span> fieldTypeId == thrift.LIST &#123;</span><br><span class="line">				<span class="keyword">if</span> err := p.ReadField1(iprot); err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">goto</span> ReadFieldError</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> err := iprot.Skip(fieldTypeId); err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">goto</span> SkipFieldError</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">			<span class="keyword">if</span> fieldTypeId == thrift.MAP &#123;</span><br><span class="line">				<span class="keyword">if</span> err := p.ReadField2(iprot); err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">goto</span> ReadFieldError</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> err := iprot.Skip(fieldTypeId); err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">goto</span> SkipFieldError</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">			<span class="keyword">if</span> fieldTypeId == thrift.LIST &#123;</span><br><span class="line">				<span class="keyword">if</span> err := p.ReadField3(iprot); err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">goto</span> ReadFieldError</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> err := iprot.Skip(fieldTypeId); err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">goto</span> SkipFieldError</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">if</span> err := iprot.Skip(fieldTypeId); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">goto</span> SkipFieldError</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err := iprot.ReadFieldEnd(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">goto</span> ReadFieldEndError</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := iprot.ReadStructEnd(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">goto</span> ReadStructEndError</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">ReadStructBeginError:</span><br><span class="line">	<span class="keyword">return</span> thrift.PrependError(fmt.Sprintf(<span class="string">&quot;%T read struct begin error: &quot;</span>, p), err)</span><br><span class="line">ReadFieldBeginError:</span><br><span class="line">	<span class="keyword">return</span> thrift.PrependError(fmt.Sprintf(<span class="string">&quot;%T read field %d begin error: &quot;</span>, p, fieldId), err)</span><br><span class="line">ReadFieldError:</span><br><span class="line">	<span class="keyword">return</span> thrift.PrependError(fmt.Sprintf(<span class="string">&quot;%T read field %d &#x27;%s&#x27; error: &quot;</span>, p, fieldId, fieldIDToName_Example[fieldId]), err)</span><br><span class="line">SkipFieldError:</span><br><span class="line">	<span class="keyword">return</span> thrift.PrependError(fmt.Sprintf(<span class="string">&quot;%T field %d skip type %d error: &quot;</span>, p, fieldId, fieldTypeId), err)</span><br><span class="line">ReadFieldEndError:</span><br><span class="line">	<span class="keyword">return</span> thrift.PrependError(fmt.Sprintf(<span class="string">&quot;%T read field end error&quot;</span>, p), err)</span><br><span class="line">ReadStructEndError:</span><br><span class="line">	<span class="keyword">return</span> thrift.PrependError(fmt.Sprintf(<span class="string">&quot;%T read struct end error: &quot;</span>, p), err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过这种方式，使得我们正常流程中，如果判断 err 出错的情况之下，不再有之前的一大段处理的指令，而仅仅是变成了一条简单的 jmp 指令；而对应的错误处理逻辑，则尽可能放在正常流程 return 之后，使得尽可能减少 cpu load 指令的次数并降低 L1 icache miss；同时，使得所有的错误处理的逻辑在最终的汇编中只会出现一次，而不是出现多次。</p><p>这里必须吐槽一波，Go 编译器有时候会“贴心”地帮你把这些代码挪回到上面，但是由于只会出现一次而其它错误处理的地方都会直接 jmp，所以问题也不大，后续可以考虑试一下把这些逻辑扔到一个独立的函数中并标记 noinline 是否可以再度提高性能（使得在主流程中完全不出现）。</p><p>经过这个调整，perf 的性能明显好了很多，并且可能比旧版本更优：</p><p><img data-src="https://static.purewhite.io/uPic/2020-10-14/g4d2ua-image-20201014154314334.png!webp_90" alt="Newer"></p><h1 id="The-End"><a href="#The-End" class="headerlink" title="The End"></a>The End</h1><p>至此，这个问题算是搞明白了，在这个过程中，最大的收获是：<del>Go 编译器竟然如此的弱智</del> 人工指令重排竟然能带来如此之大的提升。</p><p>谨以此文分享我们的经验，希望能够抛砖引玉，为性能优化提出一个新的思路，毕竟鲁迅曾说过：</p> <img data-src="https://static.purewhite.io/uPic/2020-10-14/gz7Udp-1602579503413_8c994f7473789b1c81ac17040fd9aa1f.png!webp_90" width="40%" style="margin:0 auto"></div><footer class="post-footer"><div class="reward-container"><div>请博主喝杯咖啡~</div> <button> 赞赏</button><div class="post-reward"><div> <img src="https://static.purewhite.io/wechat_pay.jpeg" alt="Pure White 微信"> <span>微信</span></div><div> <img src="https://static.purewhite.io/alipay.jpeg" alt="Pure White 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Pure White</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.purewhite.io/2020/10/14/manual-intelligence-optimize-golang-compiler/" title="使用人工智能优化 Golang 编译器">https://www.purewhite.io/2020/10/14/manual-intelligence-optimize-golang-compiler/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="followme"> <span>欢迎关注我的其它发布渠道</span><div class="social-list"><div class="social-item"><a target="_blank" class="social-link" href="https://static.purewhite.io/wechat_channel.jpg"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></a></div><div class="social-item"><a target="_blank" class="social-link" href="/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-tags"> <a href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag"># 后端</a> <a href="/tags/go/" rel="tag"># go</a></div><div class="post-widgets"><div class="wpac-rating-container"><div id="wpac-rating"></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/2020/08/24/golang-sync-map-keys-never-delete/" rel="prev" title="踩了 Golang sync.Map 的一个坑"><i class="fa fa-chevron-left"></i> 踩了 Golang sync.Map 的一个坑</a></div><div class="post-nav-item"> <a href="/2020/12/21/jtalk-11-golang/" rel="next" title="掘金JTalk Meetup 11期 - Golang 进阶指南和最佳实践">掘金JTalk Meetup 11期 - Golang 进阶指南和最佳实践<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="disqus_thread"><noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">沪ICP备15051443号-3</a> <img src="https://static.purewhite.io/images/2019-10-30-%E5%A4%87%E6%A1%88%E5%9B%BE%E6%A0%87.png" alt=""><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31010602004105" rel="noopener" target="_blank">沪公网安备 31010602004105号</a></div><div class="copyright"> &copy; 2017 – <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Pure White</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span title="站点总字数">210k</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span title="站点阅读时长">6:21</span></span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动</div></div></footer><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/pjax.js"></script><script src="https://embed.widgetpack.com/widget.js" async></script><script class="next-config" data-name="rating" type="application/json">{"enable":true,"id":8500,"color":"#fc6423"}</script><script src="/js/third-party/rating.js"></script><script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.11.0/dist/algoliasearch-lite.umd.js" integrity="sha256-48AZ24Ct05NAMLT7hvYgeW1X350OgEcZvHd6Ih6xwOA=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.33.0/dist/instantsearch.production.min.js" integrity="sha256-4ZQdz/UqmHX2Yk/+jtIRU6ZmN+ElFjKqxqYdbdQskr0=" crossorigin="anonymous"></script><script src="/js/third-party/search/algolia-search.js"></script><script src="/js/third-party/fancybox.js"></script><script src="/js/third-party/pace.js"></script><script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"GnBUFiou8SXNzMY8SKVSPw6z-9Nh9j0Va","app_key":"SHesuNBbuyni9gG2gJlHAd6E","server_url":"https://leancloud.purewhite.io","security":true}</script><script src="/js/third-party/statistics/lean-analytics.js"></script><script src="https://cdn.jsdelivr.net/npm/quicklink@2.2.0/dist/quicklink.umd.js" integrity="sha256-4kQf9z5ntdQrzsBC3YSHnEz02Z9C1UeW/E9OgnvlzSY=" crossorigin="anonymous"></script><script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"ignores":null,"url":"https://www.purewhite.io/2020/10/14/manual-intelligence-optimize-golang-compiler/"}</script><script src="/js/third-party/quicklink.js"></script><script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"blog-zr0zqnlt9p","count":true,"i18n":{"disqus":"disqus"}}</script><script src="/js/third-party/comments/disqus.js"></script></body></html>
<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="apple-touch-icon" sizes="180x180" href="https://static.purewhite.io/favicon.jpg"><link rel="icon" type="image/png" sizes="32x32" href="https://static.purewhite.io/favicon.jpg"><link rel="icon" type="image/png" sizes="16x16" href="https://static.purewhite.io/favicon.jpg"><link rel="mask-icon" href="https://static.purewhite.io/favicon.jpg" color="#222"><meta name="google-site-verification" content="Xg_Hnp9ie-Rq7-zLPdd3c9dQtR_0N845ue4QaK8jvL4"><meta name="baidu-site-verification" content="c3b074df19d33f893845b6d092bc9169"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" integrity="sha256-6cQIC71/iBIYXFK+0RHAvwmjwWzkWd+r7v/BX3/vZDc=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.purewhite.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":true,"nav":null,"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"ZP9482CZD3","apiKey":"d26207a3ce8de9fe98e7af4215425c93","indexName":"Blog","hits":{"per_page":10}}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/config.min.js"></script><meta name="description" content="缘起最近想尝试在 Golang 里面实现clock_gettime的CLOCK_REALTIME_COARSE和CLOCK_MONOTONIC_COARSE，正好深入研究了下 time.Now的实现，还机缘巧合下顺便优化了一把time.Now（虽然最终提交的是 Ian 大佬的版本）。 在这里记录下来整个过程，以供查阅。"><meta property="og:type" content="article"><meta property="og:title" content="一次 Golang 的 time.Now 优化之旅"><meta property="og:url" content="https://www.purewhite.io/2021/04/29/golang-time-now-optimize/index.html"><meta property="og:site_name" content="Pure White"><meta property="og:description" content="缘起最近想尝试在 Golang 里面实现clock_gettime的CLOCK_REALTIME_COARSE和CLOCK_MONOTONIC_COARSE，正好深入研究了下 time.Now的实现，还机缘巧合下顺便优化了一把time.Now（虽然最终提交的是 Ian 大佬的版本）。 在这里记录下来整个过程，以供查阅。"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2021-04-29T06:10:44.000Z"><meta property="article:modified_time" content="2021-12-02T12:51:07.000Z"><meta property="article:author" content="Pure White"><meta property="article:tag" content="后端"><meta property="article:tag" content="go"><meta property="article:tag" content="asm"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.purewhite.io/2021/04/29/golang-time-now-optimize/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.purewhite.io/2021/04/29/golang-time-now-optimize/","path":"2021/04/29/golang-time-now-optimize/","title":"一次 Golang 的 time.Now 优化之旅"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>一次 Golang 的 time.Now 优化之旅 | Pure White</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-98194081-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-98194081-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/third-party/analytics/google-analytics.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/third-party/analytics/baidu-analytics.min.js"></script><script async src="https://hm.baidu.com/hm.js?587d2548655f9855727225afb0e4d708"></script><script async src="//assets.growingio.com/2.1/gio.js"></script><script class="next-config" data-name="growingio_analytics" type="application/json">"8a8c3a537a0132ac"</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/third-party/analytics/growingio.min.js"></script><script type="text/javascript">!function(t,e,n,a,c,s,i){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(s=e.createElement(a)).async=1,s.src="https://www.clarity.ms/tag/8mh5xasia9",(i=e.getElementsByTagName(a)[0]).parentNode.insertBefore(s,i)}(window,document,"clarity","script")</script><script>!function(){var e=document.createElement("script");e.src="https://lf1-cdn-tos.bytegoofy.com/goofy/ttzz/push.js?c75fd468cb92e13256468f9ae3917db97049a5a91566914dbb6ab879288745b8bc434964556b7d7129e9b750ed197d397efd7b0c6c715c1701396e1af40cec962b8d7c8c6655c9b00211740aa8a98e2e",e.id="ttzz";var c=document.getElementsByTagName("script")[0];c.parentNode.insertBefore(e,c)}(window)</script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="Pure White" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="Pure White" type="application/rss+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Pure White</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">主业写bug，副业debug</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-关于我"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于我</a></li><li class="menu-item menu-item-标签"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-分类"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container"><div class="algolia-stats"><hr></div><div class="algolia-hits"></div><div class="algolia-pagination"></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BC%98%E8%B5%B7"><span class="nav-number">1.</span> <span class="nav-text">缘起</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#time-Now-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="nav-number">2.</span> <span class="nav-text">time.Now 实现原理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#time-Now-%E4%BC%98%E5%8C%96"><span class="nav-number">3.</span> <span class="nav-text">time.Now 优化</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9C%A8runtime%E5%A4%96%E8%B0%83%E7%94%A8vdso%EF%BC%9F"><span class="nav-number">4.</span> <span class="nav-text">在runtime外调用vdso？</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Pure White" src="https://static.purewhite.io/avatar.jpg!webp_90"><p class="site-author-name" itemprop="name">Pure White</p><div class="site-description" itemprop="description">青春不是年华，是心境；<br>青春不是桃面、丹唇、柔膝，<br>而是深沉的意志、恢弘的想象、<br>炽热的感情。</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">59</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">14</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">29</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/PureWhiteWu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;PureWhiteWu" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:me@purewhite.io" title="E-Mail → mailto:me@purewhite.io" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://twitter.com/PureWhite_Wu" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;PureWhite_Wu" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i> Twitter</a></span><span class="links-of-author-item"><a href="https://www.linkedin.com/in/%E8%BF%AA-%E5%90%B4-846051106/" title="LinkedIn → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;%E8%BF%AA-%E5%90%B4-846051106&#x2F;" rel="noopener me" target="_blank"><i class="fa fa-linkedin fa-fw"></i> LinkedIn</a></span><span class="links-of-author-item"><a href="https://telegram.me/PureWhiteWu" title="Telegram → https:&#x2F;&#x2F;telegram.me&#x2F;PureWhiteWu" rel="noopener me" target="_blank"><i class="fa fa-telegram fa-fw"></i> Telegram</a></span><span class="links-of-author-item"><a href="http://weibo.com/purewhitewu" title="微博 → http:&#x2F;&#x2F;weibo.com&#x2F;purewhitewu" rel="noopener me" target="_blank"><i class="fa fa-weibo fa-fw"></i> 微博</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/PureWhite_Wu" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;PureWhite_Wu" rel="noopener me" target="_blank"><i class="fa fa-book fa-fw"></i> 知乎</a></span><span class="links-of-author-item"><a href="https://static.purewhite.io/wechat_channel.jpg" title="微信 → https:&#x2F;&#x2F;static.purewhite.io&#x2F;wechat_channel.jpg" rel="noopener me" target="_blank"><i class="fa fa-weixin fa-fw"></i> 微信</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → &#x2F;atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i> RSS</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="sidebar-inner sidebar-blogroll"><div class="links-of-blogroll animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="http://blog.didispace.com/" title="http:&#x2F;&#x2F;blog.didispace.com&#x2F;" rel="noopener" target="_blank">程序猿DD</a></li><li class="links-of-blogroll-item"> <a href="http://www.v2ex.com/?r=PureWhiteWu" title="http:&#x2F;&#x2F;www.v2ex.com&#x2F;?r&#x3D;PureWhiteWu" rel="noopener" target="_blank">v2ex</a></li><li class="links-of-blogroll-item"> <a href="https://yuzhouwan.com/" title="https:&#x2F;&#x2F;yuzhouwan.com&#x2F;" rel="noopener" target="_blank">宇宙湾</a></li><li class="links-of-blogroll-item"> <a href="https://pengrl.com/" title="https:&#x2F;&#x2F;pengrl.com&#x2F;" rel="noopener" target="_blank">yoko blog</a></li></ul></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.purewhite.io/2021/04/29/golang-time-now-optimize/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://static.purewhite.io/avatar.jpg!webp_90"><meta itemprop="name" content="Pure White"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Pure White"><meta itemprop="description" content="青春不是年华，是心境；<br />青春不是桃面、丹唇、柔膝，<br />而是深沉的意志、恢弘的想象、<br />炽热的感情。"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="一次 Golang 的 time.Now 优化之旅 | Pure White"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 一次 Golang 的 time.Now 优化之旅</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-04-29 14:10:44" itemprop="dateCreated datePublished" datetime="2021-04-29T14:10:44+08:00">2021-04-29</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2021-12-02 20:51:07" itemprop="dateModified" datetime="2021-12-02T20:51:07+08:00">2021-12-02</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a></span></span><span id="/2021/04/29/golang-time-now-optimize/" class="post-meta-item leancloud_visitors" data-flag-title="一次 Golang 的 time.Now 优化之旅" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span class="leancloud-visitors-count"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Disqus：</span><a title="disqus" href="/2021/04/29/golang-time-now-optimize/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/04/29/golang-time-now-optimize/" itemprop="commentCount"></span></a></span><span class="post-meta-break"></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>1.6k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>6 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a>缘起</h1><p>最近想尝试在 Golang 里面实现<code>clock_gettime</code>的<code>CLOCK_REALTIME_COARSE</code>和<code>CLOCK_MONOTONIC_COARSE</code>，正好深入研究了下 <code>time.Now</code>的实现，还机缘巧合下顺便优化了一把<code>time.Now</code>（虽然最终提交的是 Ian 大佬的版本）。</p><p>在这里记录下来整个过程，以供查阅。</p><span id="more"></span><h1 id="time-Now-实现原理"><a href="#time-Now-实现原理" class="headerlink" title="time.Now 实现原理"></a>time.Now 实现原理</h1><p>首先我们来看看 <code>time.Now</code>的实现原理，从代码（以下代码基于 Go &lt;&#x3D; 1.16 版本）入手：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Provided by package runtime.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">now</span><span class="params">()</span></span> (sec <span class="type">int64</span>, nsec <span class="type">int32</span>, mono <span class="type">int64</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Now returns the current local time.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Now</span><span class="params">()</span></span> Time &#123;</span><br><span class="line">	sec, nsec, mono := now()</span><br><span class="line">	mono -= startNano</span><br><span class="line">	sec += unixToInternal - minWall</span><br><span class="line">	<span class="keyword">if</span> <span class="type">uint64</span>(sec)&gt;&gt;<span class="number">33</span> != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> Time&#123;<span class="type">uint64</span>(nsec), sec + minWall, Local&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> Time&#123;hasMonotonic | <span class="type">uint64</span>(sec)&lt;&lt;nsecShift | <span class="type">uint64</span>(nsec), mono, Local&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，<code>time.Now</code>里面实际上是调用了<code>now</code>来获得对应的时间数值，然后进行了一系列的处理。这部分处理就不说了，网上有较多资料，也不是本文重点。我们接着去<code>runtime</code>包里面找找<code>now</code>是怎么实现的：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//go:linkname time_now time.now</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">time_now</span><span class="params">()</span></span> (sec <span class="type">int64</span>, nsec <span class="type">int32</span>, mono <span class="type">int64</span>) &#123;</span><br><span class="line">	sec, nsec = walltime()</span><br><span class="line">	<span class="keyword">return</span> sec, nsec, nanotime()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据关键字搜索，很快能搜到在<code>runtime</code>的<code>timestub.go</code>文件中的以上代码，可以看到实际上调用了两个方法：<code>walltime</code>和<code>nanotime</code>，这两个方法又调用了<code>walltime1</code>和<code>nanotime1</code>，并且是以汇编实现的，让我们继续深入看下这两个方法的汇编实现，因为代码基本相同，这边以<code>walltime1</code>作为例子：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">// func walltime1() (sec int64, nsec int32)</span><br><span class="line">// non-zero frame-size means bp is saved and restored</span><br><span class="line">TEXT runtime·walltime1(SB),NOSPLIT,$16-12</span><br><span class="line">	// We don&#x27;t know how much stack space the VDSO code will need,</span><br><span class="line">	// so switch to g0.</span><br><span class="line">	// In particular, a kernel configured with CONFIG_OPTIMIZE_INLINING=n</span><br><span class="line">	// and hardening can use a full page of stack space in gettime_sym</span><br><span class="line">	// due to stack probes inserted to avoid stack/heap collisions.</span><br><span class="line">	// See issue #20427.</span><br><span class="line"></span><br><span class="line">	MOVQ	SP, R12	// Save old SP; R12 unchanged by C code.</span><br><span class="line"></span><br><span class="line">	get_tls(CX)</span><br><span class="line">	MOVQ	g(CX), AX</span><br><span class="line">	MOVQ	g_m(AX), BX // BX unchanged by C code.</span><br><span class="line"></span><br><span class="line">	// Set vdsoPC and vdsoSP for SIGPROF traceback.</span><br><span class="line">	// Save the old values on stack and restore them on exit,</span><br><span class="line">	// so this function is reentrant.</span><br><span class="line">	MOVQ	m_vdsoPC(BX), CX</span><br><span class="line">	MOVQ	m_vdsoSP(BX), DX</span><br><span class="line">	MOVQ	CX, 0(SP)</span><br><span class="line">	MOVQ	DX, 8(SP)</span><br><span class="line"></span><br><span class="line">	LEAQ	sec+0(FP), DX</span><br><span class="line">	MOVQ	-8(DX), CX</span><br><span class="line">	MOVQ	CX, m_vdsoPC(BX)</span><br><span class="line">	MOVQ	DX, m_vdsoSP(BX)</span><br><span class="line"></span><br><span class="line">	CMPQ	AX, m_curg(BX)	// Only switch if on curg.</span><br><span class="line">	JNE	noswitch</span><br><span class="line"></span><br><span class="line">	MOVQ	m_g0(BX), DX</span><br><span class="line">	MOVQ	(g_sched+gobuf_sp)(DX), SP	// Set SP to g0 stack</span><br><span class="line"></span><br><span class="line">noswitch:</span><br><span class="line">	SUBQ	$16, SP		// Space for results</span><br><span class="line">	ANDQ	$~15, SP	// Align for C code</span><br><span class="line"></span><br><span class="line">	MOVL	$0, DI // CLOCK_REALTIME</span><br><span class="line">	LEAQ	0(SP), SI</span><br><span class="line">	MOVQ	runtime·vdsoClockgettimeSym(SB), AX</span><br><span class="line">	CMPQ	AX, $0</span><br><span class="line">	JEQ	fallback</span><br><span class="line">	CALL	AX</span><br><span class="line">ret:</span><br><span class="line">	MOVQ	0(SP), AX	// sec</span><br><span class="line">	MOVQ	8(SP), DX	// nsec</span><br><span class="line">	MOVQ	R12, SP		// Restore real SP</span><br><span class="line">	// Restore vdsoPC, vdsoSP</span><br><span class="line">	// We don&#x27;t worry about being signaled between the two stores.</span><br><span class="line">	// If we are not in a signal handler, we&#x27;ll restore vdsoSP to 0,</span><br><span class="line">	// and no one will care about vdsoPC. If we are in a signal handler,</span><br><span class="line">	// we cannot receive another signal.</span><br><span class="line">	MOVQ	8(SP), CX</span><br><span class="line">	MOVQ	CX, m_vdsoSP(BX)</span><br><span class="line">	MOVQ	0(SP), CX</span><br><span class="line">	MOVQ	CX, m_vdsoPC(BX)</span><br><span class="line">	MOVQ	AX, sec+0(FP)</span><br><span class="line">	MOVL	DX, nsec+8(FP)</span><br><span class="line">	RET</span><br><span class="line">fallback:</span><br><span class="line">	MOVQ	$SYS_clock_gettime, AX</span><br><span class="line">	SYSCALL</span><br><span class="line">	JMP ret</span><br></pre></td></tr></table></figure><p>这段代码的注释非常的清晰，根据这段代码，可以看到，实际上是使用的<code>vdso call</code>来获取到当前的时间信息。只不过，由于 Go 是自己维护的协程的栈，而这个栈在某些内核上调用<code>vdso</code>会出问题，所以需要先切换到<code>g0</code>（也就是系统线程的栈）上才行。所以这里在开头和结尾有很多额外的操作，需要制造和清理作案现场。</p><p>有同学可能对<code>vdso</code>不了解，这里简单介绍下，实际上一开始获取时间信息是需要通过系统调用的，也就是要 syscall 才行，但是众所周知，syscall 的性能较差，同时获取时间戳又是个高频操作，所以大家也想办法优化了几版，最终是现在采用的<code>vdso</code>的方案。<code>vdso</code>全称是<code>virtual dynamic shared object</code>，简单来说就是把这段原本需要系统调用的方法，像动态链接库（<code>so</code>库）一样加载到用户内存空间里面，这样用户的进程就可以像调用一个普通方法一样调用这个方法了，可以避免系统调用的额外开销。具体可以参考一下：<a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man7/vdso.7.html%E3%80%82">https://man7.org/linux/man-pages/man7/vdso.7.html。</a></p><p>看完<code>walltime1</code>之后我们来看下<code>nanotime1</code>，由于开头的切换到<code>g0</code>的代码都是一样的，所以这里只截取后续部分的代码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">noswitch:</span><br><span class="line">	SUBQ	$16, SP		// Space for results</span><br><span class="line">	ANDQ	$~15, SP	// Align for C code</span><br><span class="line"></span><br><span class="line">	MOVL	$1, DI // CLOCK_MONOTONIC</span><br><span class="line">	LEAQ	0(SP), SI</span><br><span class="line">	MOVQ	runtime·vdsoClockgettimeSym(SB), AX</span><br><span class="line">	CMPQ	AX, $0</span><br><span class="line">	JEQ	fallback</span><br><span class="line">	CALL	AX</span><br><span class="line">ret:</span><br><span class="line">	MOVQ	0(SP), AX	// sec</span><br><span class="line">	MOVQ	8(SP), DX	// nsec</span><br><span class="line">	MOVQ	R12, SP		// Restore real SP</span><br><span class="line">	// Restore vdsoPC, vdsoSP</span><br><span class="line">	// We don&#x27;t worry about being signaled between the two stores.</span><br><span class="line">	// If we are not in a signal handler, we&#x27;ll restore vdsoSP to 0,</span><br><span class="line">	// and no one will care about vdsoPC. If we are in a signal handler,</span><br><span class="line">	// we cannot receive another signal.</span><br><span class="line">	MOVQ	8(SP), CX</span><br><span class="line">	MOVQ	CX, m_vdsoSP(BX)</span><br><span class="line">	MOVQ	0(SP), CX</span><br><span class="line">	MOVQ	CX, m_vdsoPC(BX)</span><br><span class="line">	// sec is in AX, nsec in DX</span><br><span class="line">	// return nsec in AX</span><br><span class="line">	IMULQ	$1000000000, AX</span><br><span class="line">	ADDQ	DX, AX</span><br><span class="line">	MOVQ	AX, ret+0(FP)</span><br><span class="line">	RET</span><br></pre></td></tr></table></figure><p>可以看到，唯二修改的就是调用的<code>clockid</code>——<code>CLOCK_MONOTONIC</code>和<code>RET</code>之前的处理逻辑——将返回结果转换成纳秒。</p><h1 id="time-Now-优化"><a href="#time-Now-优化" class="headerlink" title="time.Now 优化"></a>time.Now 优化</h1><p>说到这里，大家应该就能发现问题所在了——<code>time.Now</code>调用了一次<code>walltime</code>和一次<code>nanotime</code>，这两次调用都有几乎一样的切换到<code>g0</code>栈再恢复的代码，而且这段代码量还比较多。如果我们把这两次调用给合并到一起，就可以节省一次切换栈和准备工作导致的额外开销了！</p><p>Go 官方团队的 Ian 大佬和我（几乎）同时提了对应的 pr 来优化这部分的逻辑，最终 Ian 大佬实现的性能更好（-20%，<a target="_blank" rel="noopener" href="https://go-review.googlesource.com/c/go/+/314571">我的版本</a>是 -17%），于是最终采用的是 Ian 大佬的版本：<a target="_blank" rel="noopener" href="https://go-review.googlesource.com/c/go/+/314277/%E3%80%82">https://go-review.googlesource.com/c/go/+/314277/。</a></p><h1 id="在runtime外调用vdso？"><a href="#在runtime外调用vdso？" class="headerlink" title="在runtime外调用vdso？"></a>在<code>runtime</code>外调用<code>vdso</code>？</h1><p>回到开头，我是想自己实现<code>clock_gettime</code>的<code>CLOCK_REALTIME_COARSE</code>和<code>CLOCK_MONOTONIC_COARSE</code>，这就需要我在<code>runtime</code>包外部实现以上的一系列操作。但是如果要这么干，就需要把所有<code>runtime</code>包里面的结构体定义全部复制一份（这样在汇编代码里面 include 的 <code>go_asm.h</code>才有对应的偏移量），这样可维护性太差了，而且如果某个版本调整了结构体的顺序，行为就不可定义，太危险了，要不就得每个版本单独复制一份出来。</p><p>针对这个问题，也和 Go 官方进行了讨论，最终确实没有什么太好的思路，Go 目前不支持在<code>runtime</code>外部安全地调用<code>vdso</code>。</p><p>不过不管怎么样，在这个讨论的过程中，促成了<code>time.Now</code>的优化，还是不枉此行。</p></div><footer class="post-footer"><div class="reward-container"><div>请博主喝杯咖啡~</div> <button> 赞赏</button><div class="post-reward"><div> <img src="https://static.purewhite.io/wechat_pay.jpeg" alt="Pure White 微信"> <span>微信</span></div><div> <img src="https://static.purewhite.io/alipay.jpeg" alt="Pure White 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Pure White</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.purewhite.io/2021/04/29/golang-time-now-optimize/" title="一次 Golang 的 time.Now 优化之旅">https://www.purewhite.io/2021/04/29/golang-time-now-optimize/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="followme"> <span>欢迎关注我的其它发布渠道</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://static.purewhite.io/wechat_channel.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-tags"> <a href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag"># 后端</a> <a href="/tags/go/" rel="tag"># go</a> <a href="/tags/asm/" rel="tag"># asm</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2021/03/09/golang-generic-glance/" rel="prev" title="Golang 泛型初探"><i class="fa fa-angle-left"></i> Golang 泛型初探</a></div><div class="post-nav-item"> <a href="/2021/05/24/inventing-the-service-trait/" rel="next" title="【译】Inventing the Service trait">【译】Inventing the Service trait<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="disqus_thread"><noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">沪ICP备15051443号-3</a> <img src="https://static.purewhite.io/images/2019-10-30-%E5%A4%87%E6%A1%88%E5%9B%BE%E6%A0%87.png" alt=""><a href="https://beian.mps.gov.cn/#/query/webSearch?code=31010602004105" rel="noopener" target="_blank">沪公网安备 31010602004105号</a></div><div class="copyright"> &copy; 2017 – <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Pure White</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span title="站点总字数">92k</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span title="站点阅读时长">5:34</span></span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动</div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a> <a href="https://github.com/PureWhiteWu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js" integrity="sha256-ytMJGN3toR+a84u7g7NuHm91VIR06Q41kMWDr2pq7Zo=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/comments.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/utils.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/motion.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/schemes/muse.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/next-boot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/bookmark.min.js"></script><script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.20.0/dist/algoliasearch-lite.umd.js" integrity="sha256-DABVk+hYj0mdUzo+7ViJC6cwLahQIejFvC+my2M/wfM=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.60.0/dist/instantsearch.production.min.js" integrity="sha256-9242vN47QUX50UG5Gf5XDO1YREWCEJRyXHofh5fsl24=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/third-party/search/algolia-search.min.js"></script><script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdn.jsdelivr.net/npm/wavedrom@3.3.0/wavedrom.min.js","integrity":"sha256-IRMDzTC+wK5stMucZ/XSXkeS5VNtxZ+/Bm8Mcqfoxdo="}}</script><script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdn.jsdelivr.net/npm/wavedrom@3.3.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/third-party/tags/wavedrom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/third-party/fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/third-party/pace.min.js"></script><script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"DyCyUXRHZzXfXMk2Y2ysMPgL-gzGzoHsz","app_key":"7ULdnCBPkXxF6ArPc8VxaXy4","server_url":"https://leancloud.purewhite.io","security":true}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/third-party/statistics/lean-analytics.min.js"></script><script src="https://cdn.jsdelivr.net/npm/quicklink@2.3.0/dist/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script><script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"ignores":null,"url":"https://www.purewhite.io/2021/04/29/golang-time-now-optimize/"}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/third-party/quicklink.min.js"></script><script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"blog-zr0zqnlt9p","count":true,"i18n":{"disqus":"disqus"}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.19.1/source/js/third-party/comments/disqus.min.js"></script></body></html>
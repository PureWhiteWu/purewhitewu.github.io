<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 5.4.0"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="apple-touch-icon" sizes="180x180" href="https://static.purewhite.io/favicon.jpg"><link rel="icon" type="image/png" sizes="32x32" href="https://static.purewhite.io/favicon.jpg"><link rel="icon" type="image/png" sizes="16x16" href="https://static.purewhite.io/favicon.jpg"><link rel="mask-icon" href="https://static.purewhite.io/favicon.jpg" color="#222"><meta name="google-site-verification" content="Xg_Hnp9ie-Rq7-zLPdd3c9dQtR_0N845ue4QaK8jvL4"><meta name="baidu-site-verification" content="c3b074df19d33f893845b6d092bc9169"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.purewhite.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.8.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":true,"nav":null,"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"ZP9482CZD3","apiKey":"d26207a3ce8de9fe98e7af4215425c93","indexName":"Blog","hits":{"per_page":10}}}</script><script src="/js/config.js"></script><meta name="description" content="前情提要可以先看下我之前在 JTalk 上分享的实践：https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1UZ4y1g7ju 这篇文章是对于其中我最后说的“使用 SIMD 优化”部分的详细说明。 TL；DRList&lt;i64&gt; 场景下提升六倍，List&lt;i32&gt; 提升十二倍。"><meta property="og:type" content="article"><meta property="og:title" content="使用 SIMD 优化 Thrift 编码"><meta property="og:url" content="https://www.purewhite.io/2021/01/06/simd-optimize-thrift/index.html"><meta property="og:site_name" content="Pure White"><meta property="og:description" content="前情提要可以先看下我之前在 JTalk 上分享的实践：https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1UZ4y1g7ju 这篇文章是对于其中我最后说的“使用 SIMD 优化”部分的详细说明。 TL；DRList&lt;i64&gt; 场景下提升六倍，List&lt;i32&gt; 提升十二倍。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://static-ali-oss.purewhite.io/uPic/2021-01-06/124kux-image-20210106162329929.png!webp_90"><meta property="article:published_time" content="2021-01-06T07:41:29.000Z"><meta property="article:modified_time" content="2021-12-02T12:51:07.230Z"><meta property="article:author" content="Pure White"><meta property="article:tag" content="后端"><meta property="article:tag" content="go"><meta property="article:tag" content="asm"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://static-ali-oss.purewhite.io/uPic/2021-01-06/124kux-image-20210106162329929.png!webp_90"><link rel="canonical" href="https://www.purewhite.io/2021/01/06/simd-optimize-thrift/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.purewhite.io/2021/01/06/simd-optimize-thrift/","path":"2021/01/06/simd-optimize-thrift/","title":"使用 SIMD 优化 Thrift 编码"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>使用 SIMD 优化 Thrift 编码 | Pure White</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-98194081-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-98194081-1","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script src="/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?587d2548655f9855727225afb0e4d708"></script><script async src="//assets.growingio.com/2.1/gio.js"></script><script class="next-config" data-name="growingio_analytics" type="application/json">"8a8c3a537a0132ac"</script><script src="/js/third-party/analytics/growingio.js"></script><script>!function(){var e=document.createElement("script");e.src="https://lf1-cdn-tos.bytegoofy.com/goofy/ttzz/push.js?c75fd468cb92e13256468f9ae3917db97049a5a91566914dbb6ab879288745b8bc434964556b7d7129e9b750ed197d397efd7b0c6c715c1701396e1af40cec962b8d7c8c6655c9b00211740aa8a98e2e",e.id="ttzz";var c=document.getElementsByTagName("script")[0];c.parentNode.insertBefore(e,c)}(window)</script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="Pure White" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="Pure White" type="application/rss+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">Pure White</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">主业写bug，副业debug</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-关于我"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于我</a></li><li class="menu-item menu-item-标签"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-分类"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container"><div class="algolia-stats"><hr></div><div class="algolia-hits"></div><div class="algolia-pagination"></div></div></div></div></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E6%83%85%E6%8F%90%E8%A6%81"><span class="nav-number">1.</span> <span class="nav-text">前情提要</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TL%EF%BC%9BDR"><span class="nav-number">2.</span> <span class="nav-text">TL；DR</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%83%8C%E6%99%AF"><span class="nav-number">3.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%9D%E8%B7%AF"><span class="nav-number">4.</span> <span class="nav-text">思路</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#POC"><span class="nav-number">5.</span> <span class="nav-text">POC</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="nav-number">6.</span> <span class="nav-text">测试结果</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AF%A6%E7%BB%86%E8%A7%A3%E9%87%8A"><span class="nav-number">7.</span> <span class="nav-text">详细解释</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Go-%E4%B8%AD%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="nav-number">8.</span> <span class="nav-text">Go 中测试结果</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Pure White" src="https://static.purewhite.io/avatar.jpg!webp_90"><p class="site-author-name" itemprop="name">Pure White</p><div class="site-description" itemprop="description">青春不是年华，是心境；<br>青春不是桃面、丹唇、柔膝，<br>而是深沉的意志、恢弘的想象、<br>炽热的感情。</div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">59</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">14</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">29</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/PureWhiteWu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;PureWhiteWu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:wudi@purewhite.io" title="E-Mail → mailto:wudi@purewhite.io" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://twitter.com/PureWhite_Wu" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;PureWhite_Wu" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i> Twitter</a></span><span class="links-of-author-item"><a href="https://www.linkedin.com/in/%E8%BF%AA-%E5%90%B4-846051106/" title="LinkedIn → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;%E8%BF%AA-%E5%90%B4-846051106&#x2F;" rel="noopener" target="_blank"><i class="fa fa-linkedin fa-fw"></i> LinkedIn</a></span><span class="links-of-author-item"><a href="https://telegram.me/PureWhiteWu" title="Telegram → https:&#x2F;&#x2F;telegram.me&#x2F;PureWhiteWu" rel="noopener" target="_blank"><i class="fa fa-telegram fa-fw"></i> Telegram</a></span><span class="links-of-author-item"><a href="http://weibo.com/purewhitewu" title="微博 → http:&#x2F;&#x2F;weibo.com&#x2F;purewhitewu" rel="noopener" target="_blank"><i class="fa fa-weibo fa-fw"></i> 微博</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/PureWhite_Wu" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;PureWhite_Wu" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i> 知乎</a></span><span class="links-of-author-item"><a href="https://static.purewhite.io/wechat_channel.jpg" title="微信 → https:&#x2F;&#x2F;static.purewhite.io&#x2F;wechat_channel.jpg" rel="noopener" target="_blank"><i class="fa fa-weixin fa-fw"></i> 微信</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i> RSS</a></span></div><div class="cc-license site-overview-item animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div><div class="links-of-blogroll site-overview-item animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="http://blog.didispace.com/" title="http:&#x2F;&#x2F;blog.didispace.com&#x2F;" rel="noopener" target="_blank">程序猿DD</a></li><li class="links-of-blogroll-item"> <a href="http://www.v2ex.com/?r=PureWhiteWu" title="http:&#x2F;&#x2F;www.v2ex.com&#x2F;?r&#x3D;PureWhiteWu" rel="noopener" target="_blank">v2ex</a></li><li class="links-of-blogroll-item"> <a href="https://yuzhouwan.com/" title="https:&#x2F;&#x2F;yuzhouwan.com&#x2F;" rel="noopener" target="_blank">宇宙湾</a></li><li class="links-of-blogroll-item"> <a href="https://pengrl.com/" title="https:&#x2F;&#x2F;pengrl.com&#x2F;" rel="noopener" target="_blank">yoko blog</a></li></ul></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a> <a href="https://github.com/PureWhiteWu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.purewhite.io/2021/01/06/simd-optimize-thrift/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://static.purewhite.io/avatar.jpg!webp_90"><meta itemprop="name" content="Pure White"><meta itemprop="description" content="青春不是年华，是心境；<br />青春不是桃面、丹唇、柔膝，<br />而是深沉的意志、恢弘的想象、<br />炽热的感情。"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Pure White"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 使用 SIMD 优化 Thrift 编码</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-01-06 15:41:29" itemprop="dateCreated datePublished" datetime="2021-01-06T15:41:29+08:00">2021-01-06</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2021-12-02 20:51:07" itemprop="dateModified" datetime="2021-12-02T20:51:07+08:00">2021-12-02</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a></span></span><span id="/2021/01/06/simd-optimize-thrift/" class="post-meta-item leancloud_visitors" data-flag-title="使用 SIMD 优化 Thrift 编码" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span class="leancloud-visitors-count"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Disqus：</span><a title="disqus" href="/2021/01/06/simd-optimize-thrift/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/01/06/simd-optimize-thrift/" itemprop="commentCount"></span></a></span><span class="post-meta-break"></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>3.7k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>7 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h1><p>可以先看下我之前在 JTalk 上分享的实践：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1UZ4y1g7ju">https://www.bilibili.com/video/BV1UZ4y1g7ju</a></p><p>这篇文章是对于其中我最后说的“使用 SIMD 优化”部分的详细说明。</p><h1 id="TL；DR"><a href="#TL；DR" class="headerlink" title="TL；DR"></a>TL；DR</h1><p>List&lt;i64&gt; 场景下提升六倍，List&lt;i32&gt; 提升十二倍。</p><span id="more"></span><h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>基于 FastRead/Write 接口，由于我们已经拿到了所有的内存，所以我们可以尝试采用 SIMD 来进一步的优化。</p><h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>最容易想到的优化点也是公司内最常见的用法 list&lt;i64/i32&gt;，这个比较容易想到使用 SIMD 进行优化。</p><p>在 thrift binary 里面，int 类型在复制到 buffer 之前需要先转成大端，也就是 binary.BigEndian.PutInt 一次，这个操作原本需要比较多语句，通过软件来模拟，但是在 amd64 下有一个 BSWAP 指令可以直接完成，这个优化 Go 编译器已经做了，所以现在的伪代码如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> src, dst</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>; i++ &#123;</span><br><span class="line">    dst[i] = bswap(src[i])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看出来，这个操作实际上是很有规律的，并且全都是相邻的操作，符合 SIMD 指令的模式。</p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><p>先使用了 C++ 做了一个 POC（只贴了关键代码，完整代码见 <a target="_blank" rel="noopener" href="https://gist.github.com/PureWhiteWu/e88f241fc8b62df06ae1eb04923a88ae%EF%BC%89%EF%BC%9A">https://gist.github.com/PureWhiteWu/e88f241fc8b62df06ae1eb04923a88ae）：</a></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> MASK = <span class="number">0x0001020304050607</span>;</span><br><span class="line"><span class="keyword">const</span> __mmask16 bit16mask[<span class="number">17</span>] = &#123;<span class="number">0x0000</span>, <span class="number">0x0001</span>, <span class="number">0x0003</span>, <span class="number">0x0007</span>, <span class="number">0x000f</span>, <span class="number">0x001f</span>, <span class="number">0x003f</span>, <span class="number">0x007f</span>, <span class="number">0x00ff</span>, <span class="number">0x01ff</span>, <span class="number">0x03ff</span>, <span class="number">0x07ff</span>, <span class="number">0x0fff</span>, <span class="number">0x1fff</span>, <span class="number">0x3fff</span>, <span class="number">0x7fff</span>, <span class="number">0xffff</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">avx512_little_2_big</span><span class="params">(<span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> *src, <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> *dst, <span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> loop_count = n / <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">int</span> remainder = n % <span class="number">8</span>;</span><br><span class="line">    __m512i mask = _mm512_set1_epi64(MASK);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loop_count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> index = i * <span class="number">8</span>;</span><br><span class="line">        __m512i input_data = _mm512_loadu_si512(&amp;src[index]);</span><br><span class="line">        __m512i output_data = _mm512_shuffle_epi8(input_data, mask);</span><br><span class="line">        _mm512_storeu_si512(&amp;avx512_data[index], output_data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (remainder != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> index = loop_count * <span class="number">8</span>;</span><br><span class="line">        __m512i padding = _mm512_set1_epi64(<span class="number">0</span>);</span><br><span class="line">        __m512i input_data = _mm512_mask_loadu_epi64(padding, bit16mask[remainder], &amp;src[index]);</span><br><span class="line">        __m512i output_data = _mm512_shuffle_epi8(input_data, mask);</span><br><span class="line">        _mm512_mask_storeu_epi64(&amp;avx512_data[index], bit16mask[remainder], output_data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">avx2_little_2_big</span><span class="params">(<span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> *src, <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> *dst, <span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> loop_count = n / <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">int</span> remainder = n % <span class="number">4</span>;</span><br><span class="line">    __m256i mask = _mm256_set1_epi64x(MASK);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loop_count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> index = i * <span class="number">4</span>;</span><br><span class="line">        __m256i input_data = _mm256_loadu_si256((__m256i *)&amp;src[index]);</span><br><span class="line">        __m256i output_data = _mm256_shuffle_epi8(input_data, mask);</span><br><span class="line">        _mm256_storeu_si256((__m256i *)&amp;avx2_data[index], output_data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (remainder != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> index = loop_count * <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = index; i &lt; index + remainder; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            avx2_data[i] = <span class="built_in">bswap_64</span>(src[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h1><p>编译命令如下：</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">$</span> <span class="comment">g</span>++ <span class="comment">little_2_big_gcc</span><span class="string">.</span><span class="comment">cpp</span> <span class="literal">-</span><span class="comment">o</span> <span class="comment">ll2</span> <span class="literal">-</span><span class="comment">mavx512f</span> <span class="literal">-</span><span class="comment">mavx512bw</span> <span class="literal">-</span><span class="comment">mavx2</span> <span class="literal">-</span><span class="comment">mavx</span> <span class="literal">-</span><span class="comment">O3</span></span><br></pre></td></tr></table></figure><p>在 linux 物理机上进行测试，结果如下：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">avx512</span> time: <span class="number">27009</span> us</span><br><span class="line"><span class="attribute">avx2</span> time: <span class="number">21920</span> us</span><br><span class="line"><span class="attribute">bswap</span> time: <span class="number">49967</span> us</span><br></pre></td></tr></table></figure><p>可以得出结论：</p><ol><li>avx512 的性能很不稳定，有些情况下还不如 avx2；</li><li>avx2 相比 bswap 方案基本可以提升一倍以上的性能；</li><li>Linus 诚不欺我。</li></ol><h1 id="详细解释"><a href="#详细解释" class="headerlink" title="详细解释"></a>详细解释</h1><p>bswap 做的事情是将整个字节序进行倒序，以 int32 为例，包含 4 字节，假设原来数据如下：</p><p>00000000 00000001 00000010 00000011</p><p>那么 bswap 之后，数据为：</p><p>00000011 00000010 00000001 00000000</p><p>在 avx2 中，也有一个指令 vpshufb 能够达到类似的效果，不过不是纯粹的 bswap，详见：<a target="_blank" rel="noopener" href="https://software.intel.com/content/www/us/en/develop/documentation/cpp-compiler-developer-guide-and-reference/top/compiler-reference/intrinsics/intrinsics-for-intel-advanced-vector-extensions-2/intrinsics-for-shuffle-operations-1/mm256-shuffle-epi8.html">https://software.intel.com/content/www/us/en/develop/documentation/cpp-compiler-developer-guide-and-reference/top/compiler-reference/intrinsics/intrinsics-for-intel-advanced-vector-extensions-2/intrinsics-for-shuffle-operations-1/mm256-shuffle-epi8.html</a></p><p>shuffle 的意思是“洗牌”，作用是可以根据一个传入的 mask 来重排对应 byte 的位置。所以这里最关键的就是代码示例中最上面那行：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> MASK = <span class="number">0x0001020304050607</span>;</span><br></pre></td></tr></table></figure><p>为什么用这个 mask 就行了呢？我们得复习一下大小端的知识。</p><p>大端字节序是符合人类阅读习惯的顺序，高位在前，还是以刚才的 int32 作为例子，假如大端序表示如下：</p><p>00000011（高位在这里） 00000010 00000001 00000000</p><p>那么在我们电脑上，小端字节序就是这么存的：</p><table><thead><tr><th>内存地址</th><th>0</th><th>1</th><th>2</th><th>3（高位在这里）</th></tr></thead><tbody><tr><td>值</td><td>00000000</td><td>00000001</td><td>00000010</td><td>00000011</td></tr></tbody></table><p>这时候对应的 MASK 是 0x00010203，在内存中以小端序表示为：</p><table><thead><tr><th>内存地址</th><th>0</th><th>1</th><th>2</th><th>3（高位在这里）</th></tr></thead><tbody><tr><td>值</td><td>3</td><td>2</td><td>1</td><td>0</td></tr></tbody></table><p>我们的机器都是小端序的，所以，在做 shuffle 的时候，内存地址 0 对应的是 内存地址 3 处的值，内存地址 1 对应的是 内存地址 2 处的值，以此类推。</p><p>这样，shuffle 计算下来之后，内存中的值就变成了：</p><table><thead><tr><th>内存地址</th><th>0</th><th>1</th><th>2</th><th>3</th></tr></thead><tbody><tr><td>值</td><td>00000011</td><td>00000010</td><td>00000001</td><td>00000000</td></tr></tbody></table><p><img data-src="https://static-ali-oss.purewhite.io/uPic/2021-01-06/124kux-image-20210106162329929.png!webp_90" alt="shuffle"></p><p>这时候，也就相当于成功完成了一次 bswap 的操作了。</p><p>由于 int64 有 8 位，所以 MASK 为 0x00 01 02 03 04 05 06 07 就可以完成一次 int64 的 bswap。</p><p><em>（注：没有 0 键在编写此节时遭到虐待）</em></p><h1 id="Go-中测试结果"><a href="#Go-中测试结果" class="headerlink" title="Go 中测试结果"></a>Go 中测试结果</h1><p>最后附上 Go 中的测试结果，我们测试了 List 中有 12345 个元素的 benchmark：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">BenchmarkWriteListI64</span></span><br><span class="line"><span class="attribute">BenchmarkWriteListI64</span>-<span class="number">16</span>         <span class="number">703928</span>         <span class="number">1753</span> ns/op</span><br><span class="line"><span class="attribute">BenchmarkWriteI64</span></span><br><span class="line"><span class="attribute">BenchmarkWriteI64</span>-<span class="number">16</span>              <span class="number">98204</span>        <span class="number">11875</span> ns/op</span><br><span class="line"><span class="attribute">BenchmarkWriteListI32</span></span><br><span class="line"><span class="attribute">BenchmarkWriteListI32</span>-<span class="number">16</span>        <span class="number">1300507</span>          <span class="number">907</span> ns/op</span><br><span class="line"><span class="attribute">BenchmarkWriteI32</span></span><br><span class="line"><span class="attribute">BenchmarkWriteI32</span>-<span class="number">16</span>              <span class="number">98522</span>        <span class="number">12580</span> ns/op</span><br></pre></td></tr></table></figure><p>可以看出，在 Go 上的性能提升非常巨大，List&lt;i64&gt; 场景下提升六倍，List&lt;i32&gt; 更是提升了十几倍。</p><p>究其原因，应该是 Go 做的优化太少太差，远远比不上 gcc。</p></div><footer class="post-footer"><div class="reward-container"><div>请博主喝杯咖啡~</div> <button> 赞赏</button><div class="post-reward"><div> <img src="https://static.purewhite.io/wechat_pay.jpeg" alt="Pure White 微信"> <span>微信</span></div><div> <img src="https://static.purewhite.io/alipay.jpeg" alt="Pure White 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Pure White</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.purewhite.io/2021/01/06/simd-optimize-thrift/" title="使用 SIMD 优化 Thrift 编码">https://www.purewhite.io/2021/01/06/simd-optimize-thrift/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="followme"> <span>欢迎关注我的其它发布渠道</span><div class="social-list"><div class="social-item"><a target="_blank" class="social-link" href="https://static.purewhite.io/wechat_channel.jpg"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></a></div><div class="social-item"><a target="_blank" class="social-link" href="/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-tags"> <a href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag"># 后端</a> <a href="/tags/go/" rel="tag"># go</a> <a href="/tags/asm/" rel="tag"># asm</a></div><div class="post-widgets"><div class="wpac-rating-container"><div id="wpac-rating"></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/2020/12/21/jtalk-11-golang/" rel="prev" title="掘金JTalk Meetup 11期 - Golang 进阶指南和最佳实践"><i class="fa fa-chevron-left"></i> 掘金JTalk Meetup 11期 - Golang 进阶指南和最佳实践</a></div><div class="post-nav-item"> <a href="/2021/03/09/golang-generic-glance/" rel="next" title="Golang 泛型初探">Golang 泛型初探<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="disqus_thread"><noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">沪ICP备15051443号-3</a> <img src="https://static.purewhite.io/images/2019-10-30-%E5%A4%87%E6%A1%88%E5%9B%BE%E6%A0%87.png" alt=""><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31010602004105" rel="noopener" target="_blank">沪公网安备 31010602004105号</a></div><div class="copyright"> &copy; 2017 – <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Pure White</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span title="站点总字数">210k</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span title="站点阅读时长">6:21</span></span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动</div></div></footer><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/pjax.js"></script><script src="https://embed.widgetpack.com/widget.js" async></script><script class="next-config" data-name="rating" type="application/json">{"enable":true,"id":8500,"color":"#fc6423"}</script><script src="/js/third-party/rating.js"></script><script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.11.0/dist/algoliasearch-lite.umd.js" integrity="sha256-48AZ24Ct05NAMLT7hvYgeW1X350OgEcZvHd6Ih6xwOA=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.33.0/dist/instantsearch.production.min.js" integrity="sha256-4ZQdz/UqmHX2Yk/+jtIRU6ZmN+ElFjKqxqYdbdQskr0=" crossorigin="anonymous"></script><script src="/js/third-party/search/algolia-search.js"></script><script src="/js/third-party/fancybox.js"></script><script src="/js/third-party/pace.js"></script><script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"GnBUFiou8SXNzMY8SKVSPw6z-9Nh9j0Va","app_key":"SHesuNBbuyni9gG2gJlHAd6E","server_url":"https://leancloud.purewhite.io","security":true}</script><script src="/js/third-party/statistics/lean-analytics.js"></script><script src="https://cdn.jsdelivr.net/npm/quicklink@2.2.0/dist/quicklink.umd.js" integrity="sha256-4kQf9z5ntdQrzsBC3YSHnEz02Z9C1UeW/E9OgnvlzSY=" crossorigin="anonymous"></script><script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"ignores":null,"url":"https://www.purewhite.io/2021/01/06/simd-optimize-thrift/"}</script><script src="/js/third-party/quicklink.js"></script><script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"blog-zr0zqnlt9p","count":true,"i18n":{"disqus":"disqus"}}</script><script src="/js/third-party/comments/disqus.js"></script></body></html>
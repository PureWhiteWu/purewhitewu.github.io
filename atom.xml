<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Pure White</title>
  
  <subtitle>ä¸»ä¸šå†™bugï¼Œå‰¯ä¸šdebug</subtitle>
  <link href="https://www.purewhite.io/atom.xml" rel="self"/>
  
  <link href="https://www.purewhite.io/"/>
  <updated>2022-03-15T17:33:07.693Z</updated>
  <id>https://www.purewhite.io/</id>
  
  <author>
    <name>Pure White</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ç»™å¤§å®¶æ¨èä¸€ä¸ª B ç«™å®è— up ä¸» â€”â€” BiBiPiano</title>
    <link href="https://www.purewhite.io/2022/03/16/bibipiano-recommend/"/>
    <id>https://www.purewhite.io/2022/03/16/bibipiano-recommend/</id>
    <published>2022-03-15T17:23:00.000Z</published>
    <updated>2022-03-15T17:33:07.693Z</updated>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©æƒ³å‘ä¸€ç‚¹å’ŒæŠ€æœ¯æ— å…³çš„å†…å®¹ï¼Œæ¯•ç«Ÿç”Ÿæ´»ä¸­ä¹Ÿä¸å…¨æ˜¯å·¥ä½œå˜›ğŸ˜Šã€‚</p><p>å…³æ³¨è¿™ä¸ª up ä¸»å·²ç»å¾ˆä¹…äº†ï¼Œå·²ç»ç»è¿‡äº†å¾ˆé•¿æ—¶é—´çš„æ£€éªŒï¼Œåœ¨è¿™é‡Œä¹Ÿæ¨èç»™å¤§å®¶ã€‚</p><p>è¿™ä¸ª up ä¸»å‘çš„æ‰€æœ‰æ›²å­æˆ‘éƒ½ä¼šç¬¬ä¸€æ—¶é—´å¬ã€‚</p><p>å¦å¤–ï¼Œè®°å¾—ä¸€å®šè¦çœ‹ç®€ä»‹ï¼Œä¸€å®šè¦çœ‹ç®€ä»‹ï¼Œä¸€å®šè¦çœ‹ç®€ä»‹ï¼</p><span id="more"></span><p>è¿™é‡Œæˆ‘å°è¯•ä½¿ç”¨åµŒå…¥ä»£ç ç»™å¤§å®¶æ¨èä¸‰é¦–æ›²å­ï¼Œä¸è¿‡æ¨èå¤§å®¶è·³è½¬åˆ°åŸé¡µé¢ï¼Œä¸€è¾¹çœ‹ç®€ä»‹ä¸€è¾¹å¬ã€‚</p><h1 id="å¡å†œï¼ˆå¿…å¬ï¼‰"><a href="#å¡å†œï¼ˆå¿…å¬ï¼‰" class="headerlink" title="å¡å†œï¼ˆå¿…å¬ï¼‰"></a>å¡å†œï¼ˆå¿…å¬ï¼‰</h1><iframe src="//player.bilibili.com/player.html?aid=63771647&bvid=BV1L4411U7Fj&cid=110717051&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><h1 id="é£å±…ä½çš„è¡—é“"><a href="#é£å±…ä½çš„è¡—é“" class="headerlink" title="é£å±…ä½çš„è¡—é“"></a>é£å±…ä½çš„è¡—é“</h1><iframe src="//player.bilibili.com/player.html?aid=68436693&bvid=BV1xJ411u76b&cid=118609878&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><h1 id="å¯æƒœä¸æ˜¯ä½ "><a href="#å¯æƒœä¸æ˜¯ä½ " class="headerlink" title="å¯æƒœä¸æ˜¯ä½ "></a>å¯æƒœä¸æ˜¯ä½ </h1><iframe src="//player.bilibili.com/player.html?aid=371290548&bvid=BV1VZ4y1u7qy&cid=212569521&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä»Šå¤©æƒ³å‘ä¸€ç‚¹å’ŒæŠ€æœ¯æ— å…³çš„å†…å®¹ï¼Œæ¯•ç«Ÿç”Ÿæ´»ä¸­ä¹Ÿä¸å…¨æ˜¯å·¥ä½œå˜›ğŸ˜Šã€‚&lt;/p&gt;
&lt;p&gt;å…³æ³¨è¿™ä¸ª up ä¸»å·²ç»å¾ˆä¹…äº†ï¼Œå·²ç»ç»è¿‡äº†å¾ˆé•¿æ—¶é—´çš„æ£€éªŒï¼Œåœ¨è¿™é‡Œä¹Ÿæ¨èç»™å¤§å®¶ã€‚&lt;/p&gt;
&lt;p&gt;è¿™ä¸ª up ä¸»å‘çš„æ‰€æœ‰æ›²å­æˆ‘éƒ½ä¼šç¬¬ä¸€æ—¶é—´å¬ã€‚&lt;/p&gt;
&lt;p&gt;å¦å¤–ï¼Œè®°å¾—ä¸€å®šè¦çœ‹ç®€ä»‹ï¼Œä¸€å®šè¦çœ‹ç®€ä»‹ï¼Œä¸€å®šè¦çœ‹ç®€ä»‹ï¼&lt;/p&gt;</summary>
    
    
    
    <category term="éšç¬”" scheme="https://www.purewhite.io/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
    <category term="éšç¬”" scheme="https://www.purewhite.io/tags/%E9%9A%8F%E7%AC%94/"/>
    
    <category term="å¿ƒå¾—" scheme="https://www.purewhite.io/tags/%E5%BF%83%E5%BE%97/"/>
    
  </entry>
  
  <entry>
    <title>Rustc Reading Clubï¼šä»ä¸€ä¸ªé”™è¯¯å‡ºå‘å­¦ä¹  rustc_resolve</title>
    <link href="https://www.purewhite.io/2021/11/07/rustc-resolve-reading-defined-multiple-times/"/>
    <id>https://www.purewhite.io/2021/11/07/rustc-resolve-reading-defined-multiple-times/</id>
    <published>2021-11-07T07:38:31.000Z</published>
    <updated>2021-12-02T12:51:07.230Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘ Rust å®˜æ–¹ç¤¾åŒºæäº†ä¸ª Rustc Reading Club çš„æ´»åŠ¨ï¼Œç”±ç¼–è¯‘å™¨ team çš„ Leader Niko å‘èµ·ï¼Œå…·ä½“ç½‘å€åœ¨è¿™é‡Œï¼š<a href="https://rust-lang.github.io/rustc-reading-club/">https://rust-lang.github.io/rustc-reading-club/</a></p><p>å¾ˆå¯æƒœçš„æ˜¯ï¼Œ11 æœˆ 4 æ—¥çš„ç¬¬ä¸€æœŸï¼Œç”±äºå¤ªè¿‡ç«çˆ†å¹¶ä¸” Zoom äººæ•°é™åˆ¶ 100 äººï¼Œå¯¼è‡´ä¸»æŒäºº Niko è‡ªå·±è¿›ä¸æ¥æ‰€ä»¥å–æ¶ˆäº†â€¦â€¦ç­‰å¾…çœ‹çœ‹å®˜æ–¹åç»­ä¼šæ€ä¹ˆæå§ï¼Œè¿˜æ˜¯å¾ˆæœŸå¾…å®˜æ–¹ç»„ç»‡çš„æ´»åŠ¨çš„ã€‚</p><p>Rust ä¸­æ–‡ç¤¾ç¾¤çš„å¼ æ±‰ä¸œå¤§ä½¬ä¹Ÿç´§è·Ÿç€å®˜æ–¹çš„æ´»åŠ¨ï¼Œåœ¨ç¤¾ç¾¤é‡Œé¢ç»„ç»‡äº† Rustc æºç é˜…è¯»çš„æ´»åŠ¨ï¼Œä»Šå¤©ï¼ˆ11 æœˆ 7 æ—¥ï¼‰ä¸¾åŠäº†ç¬¬ä¸€æœŸï¼Œåœ¨è¿™æœŸä¸­æˆ‘è·Ÿç€å´ç¿±ç¿”å¤§ä½¬çš„æ€è·¯ï¼Œä»ä¸€ä¸ªé”™è¯¯å‡ºå‘ï¼Œå­¦ä¹ äº†ä¸€éƒ¨åˆ† rustc_resolve çš„é€»è¾‘ï¼Œäºæ˜¯æƒ³ç€å†™ä¸€ç¯‡åšå®¢æ€»ç»“ä¸€ä¸‹ã€‚</p><p>ã€å°å¹¿å‘Šã€‘ä¸‹ä¸€æœŸ 11 æœˆ 14 æ—¥ä¸‹åˆä¼šç”±åˆ˜ç¿¼é£å¤§ä½¬å¸¦é¢†å¤§å®¶ä¸€èµ·å»é˜…è¯»ç±»å‹æ¨å¯¼ç›¸å…³çš„ä»£ç ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ä¸‹è½½<a href="https://www.feishu.cn/">é£ä¹¦</a>ï¼Œæ³¨å†Œä¸€ä¸ªä¸ªäººè´¦å·ï¼Œç„¶åæ‰«æäºŒç»´ç åŠ å…¥ï¼š</p><span id="more"></span><img data-src="https://static.purewhite.io/uPic/2021-11-07/image-20211107173520665-Xcw2lU.png!webp_90" alt="Rust ä¸­æ–‡ç¤¾ç¾¤" style="zoom: 25%;" /><h1 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h1><p>è¨€å½’æ­£ä¼ ï¼Œåœ¨é˜…è¯» Rustc æºä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œä¸»è¦æ˜¯å…ˆ clone ä¸‹æ¥ Rust çš„ä»£ç ï¼Œç„¶åé…ç½®å¥½ IDEï¼ˆè™½ç„¶ä½†æ˜¯ï¼ŒClion åˆ°ç°åœ¨æ­£å¼ç‰ˆè¿˜ä¸æ”¯æŒè¿œç¨‹ï¼ŒEAP åˆå„ç§ bugâ€¦â€¦ï¼‰ï¼Œå…·ä½“å¯ä»¥å‚è€ƒå®˜æ–¹çš„ guideï¼š<a href="https://rustc-dev-guide.rust-lang.org/getting-started.html%E3%80%82%E8%B7%9F%E7%9D%80%E8%BF%99%E7%AB%A0%E5%81%9A%E5%AE%8C%E5%B0%B1%E8%A1%8C%EF%BC%9Ahttps://rustc-dev-guide.rust-lang.org/building/how-to-build-and-run.html%E3%80%82">https://rustc-dev-guide.rust-lang.org/getting-started.htmlã€‚è·Ÿç€è¿™ç« åšå®Œå°±è¡Œï¼šhttps://rustc-dev-guide.rust-lang.org/building/how-to-build-and-run.htmlã€‚</a></p><h1 id="ä»é”™è¯¯å‡ºå‘"><a href="#ä»é”™è¯¯å‡ºå‘" class="headerlink" title="ä»é”™è¯¯å‡ºå‘"></a>ä»é”™è¯¯å‡ºå‘</h1><p>è¿™æ¬¡æˆ‘ä»¬çš„é˜…è¯»ä¸»è¦çš„å¯¹è±¡æ˜¯<code>rustc_resolve</code>ï¼Œé¡¾åæ€ä¹‰åº”è¯¥æ˜¯åšåç§°è§£æçš„ï¼Œæ›´åŠ è¯¦ç»†çš„ä¿¡æ¯å¯ä»¥æ¥è¿™ç…ä¸€çœ¼ï¼š<a href="https://rustc-dev-guide.rust-lang.org/name-resolution.html%E3%80%82">https://rustc-dev-guide.rust-lang.org/name-resolution.htmlã€‚</a></p><p>æˆ‘ä»¬æ‰“å¼€<code>rustc_resolve</code>çš„<code>lib.rs</code>ä¸€çœ‹ï¼Œå¦ˆå‘€ï¼Œå…‰è¿™ä¸ªæ–‡ä»¶å°±æ¥è¿‘ 4000 è¡Œä»£ç ï¼Œç›´æ¥è¿™ä¹ˆç¡¬çœ‹è‚¯å®šä¸ç°å®ï¼›ä¸è¿‡å´ç¿±ç¿”å¤§ä½¬æå‡ºäº†ä¸€ä¸ªæ€è·¯ï¼šä»ä¸€ä¸ªæˆ‘ä»¬æœ€å¸¸è§çš„é”™è¯¯<code>the name xx is defined multiple times</code>å‡ºå‘ï¼Œé¡ºç€è¿™æ¡è·¯å»å­¦ä¹ ä¸€ä¸‹ç›¸å…³çš„ä»£ç ã€‚</p><p>è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åŠæ³•ï¼Œå½“ä½ ä¸çŸ¥é“ä»å“ªå…¥æ‰‹çš„æ—¶å€™ï¼Œä½ å¯ä»¥æ„é€ ä¸€ä¸ªåœºæ™¯ï¼Œç”±ç‚¹åˆ‡å…¥ï¼Œæœ€ç»ˆç”±ç‚¹åŠé¢çœ‹å®Œæ‰€æœ‰ä»£ç ã€‚</p><p>åºŸè¯å°‘è¯´ï¼Œæˆ‘ä»¬å…ˆç¥­å‡ºæœç´¢å¤§æ³•ï¼Œåœ¨<code>rustc_resolve</code>é‡Œé¢æœä¸€ä¸‹è¿™ä¸ªé”™è¯¯æ˜¯åœ¨å“ªå‡ºç°çš„ï¼š</p><img data-src="https://static.purewhite.io/uPic/2021-11-07/image-20211107184148779-Rk3CR3.png!webp_90" alt="æŸ¥æ‰¾è¿™ä¸ªé”™è¯¯" style="zoom:50%;" /><p>éå¸¸å·§ï¼Œæ­£å¥½å°±åœ¨<code>rustc_resolve</code>çš„<code>lib.rs</code>ä¸­ï¼Œäºæ˜¯æˆ‘ä»¬è·³è½¬è¿‡å»ï¼Œå‘ç°ç¡®å®æ˜¯è¿™ä¸ªæˆ‘ä»¬æƒ³æ‰¾çš„é”™è¯¯ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> msg = <span class="built_in">format!</span>(<span class="string">&quot;the name `&#123;&#125;` is defined multiple times&quot;</span>, name);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut</span> err = <span class="keyword">match</span> (old_binding.is_extern_crate(), new_binding.is_extern_crate()) &#123;</span><br><span class="line">    (<span class="literal">true</span>, <span class="literal">true</span>) =&gt; struct_span_err!(<span class="keyword">self</span>.session, span, E0259, <span class="string">&quot;&#123;&#125;&quot;</span>, msg),</span><br><span class="line">    (<span class="literal">true</span>, _) | (_, <span class="literal">true</span>) =&gt; <span class="keyword">match</span> new_binding.is_import() &amp;&amp; old_binding.is_import() &#123;</span><br><span class="line">        <span class="literal">true</span> =&gt; struct_span_err!(<span class="keyword">self</span>.session, span, E0254, <span class="string">&quot;&#123;&#125;&quot;</span>, msg),</span><br><span class="line">        <span class="literal">false</span> =&gt; struct_span_err!(<span class="keyword">self</span>.session, span, E0260, <span class="string">&quot;&#123;&#125;&quot;</span>, msg),</span><br><span class="line">    &#125;,</span><br><span class="line">    _ =&gt; <span class="keyword">match</span> (old_binding.is_import(), new_binding.is_import()) &#123;</span><br><span class="line">        (<span class="literal">false</span>, <span class="literal">false</span>) =&gt; struct_span_err!(<span class="keyword">self</span>.session, span, E0428, <span class="string">&quot;&#123;&#125;&quot;</span>, msg),</span><br><span class="line">        (<span class="literal">true</span>, <span class="literal">true</span>) =&gt; struct_span_err!(<span class="keyword">self</span>.session, span, E0252, <span class="string">&quot;&#123;&#125;&quot;</span>, msg),</span><br><span class="line">        _ =&gt; struct_span_err!(<span class="keyword">self</span>.session, span, E0255, <span class="string">&quot;&#123;&#125;&quot;</span>, msg),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ‰€åœ¨çš„è¿™ä¸ªå‡½æ•°åä¹Ÿæ­£å¥½æ˜¯<code>report_conflict</code>ï¼Œå®Œç¾ï¼</p><p>è®©æˆ‘ä»¬æ¥ç€çœ‹çœ‹è¿™ä¸ªå‡½æ•°åœ¨å“ªè¢«è°ƒç”¨åˆ°äº†ï¼š</p><img data-src="https://static.purewhite.io/uPic/2021-11-07/image-20211107184650136-uds41e.png!webp_90" alt="report_conflict" style="zoom:67%;" /><p>è¿™ä¸ªå‡½æ•°é™¤äº†å®šä¹‰å¤–ï¼Œè¢«è°ƒç”¨åˆ°äº†ä¸¤æ¬¡ï¼Œå…¶ä¸­ä¸‹é¢è¿™æ¬¡æ˜¯åœ¨è‡ªå·±å‡½æ•°å†…éƒ¨é€’å½’è°ƒç”¨ï¼Œæˆ‘ä»¬ç›´æ¥æ— è§†æ‰ï¼›è¿˜æœ‰ä¸€æ¬¡æ˜¯åœ¨<code>build_reduced_graph.rs</code>ä¸­ï¼Œè®©æˆ‘ä»¬è·Ÿç€å»çœ‹çœ‹ï¼š</p><img data-src="https://static.purewhite.io/uPic/2021-11-07/image-20211107184758563-03lWsz.png!webp_90" alt="build_reduced_graph.rs" style="zoom:67%;" /><p>åœ¨è¿™é‡Œæ˜¯è¢«<code>define</code>æ–¹æ³•è°ƒç”¨åˆ°ï¼Œçœ‹ç€å¾ˆç¬¦åˆé¢„æœŸï¼Œçœ‹æ¥æˆ‘ä»¬æ‰¾å¯¹åœ°æ–¹äº†ã€‚</p><p>è¿™æ®µä»£ç å…ˆé€šè¿‡<code>to_name_binding</code>æ–¹æ³•æŠŠä¼ å…¥çš„<code>def</code>è½¬æ¢æˆä¸€ä¸ª<code>NameBinding</code>ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹è¿™æ®µå¹²äº†å•¥ï¼š</p><img data-src="https://static.purewhite.io/uPic/2021-11-07/image-20211107185222063-iGSng1.png!webp_90" alt="NameBinding" style="zoom:67%;" /><p><code>NameBinding</code>æ˜¯ä¸€ä¸ªè®°å½•äº†ä¸€ä¸ªå€¼ã€ç±»å‹æˆ–è€…æ¨¡å—å®šä¹‰çš„ç»“æ„ä½“ï¼Œå…¶ä¸­<code>kind</code>æˆ‘ä»¬å¤§èƒ†çŒœæµ‹æ˜¯ç±»å‹ï¼Œ<code>ambiguity</code>çœ‹ä¸æ‡‚å…ˆæ”¾ç€ï¼Œ<code>expansion</code>ä¹Ÿæ˜¯ï¼ˆå¦‚æœçœ‹è¿‡ rustc-dev-guide èƒ½å¤§è‡´çŸ¥é“æ˜¯å’Œå«ç”Ÿå®å±•å¼€æœ‰å…³ï¼Œè¿™é‡Œæˆ‘ä»¬ä¹Ÿå…ˆæ— è§†ï¼‰ï¼Œç„¶åæ˜¯<code>span</code>ä¹Ÿä¸çŸ¥é“å¹²å•¥çš„ï¼Œç‚¹è¿›å»ç ”ç©¶ä¸‹æ„Ÿè§‰å’Œå¢é‡ç¼–è¯‘æœ‰å…³ï¼Œä¹Ÿå…ˆæ”¾ç€ï¼Œæœ€å<code>vis</code>ä¼°æ‘¸ç€åº”è¯¥è¡¨ç¤ºçš„æ˜¯å¯è§æ€§ã€‚</p><p>ç„¶åæˆ‘ä»¬å†ç‚¹<code>ResolverArenas</code>çœ‹çœ‹æ˜¯å¹²å•¥çš„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Nothing really interesting here; it just provides memory for the rest of the crate.</span></span><br><span class="line"><span class="meta">#[derive(Default)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">ResolverArenas</span></span>&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å—¯ï¼Œå¥½ï¼Œæ²¡å•¥å€¼å¾—å…³æ³¨çš„ï¼Œåªæ˜¯ç”¨æ¥æä¾›å†…å­˜çš„ï¼Œç›´æ¥æ— è§†ã€‚</p><p>æˆ‘ä»¬å†æ¥ç€å›åˆ°ä¸Šé¢çš„<code>define</code>æ–¹æ³•ä¸­ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">&#x27;a</span>&gt; Resolver&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    <span class="comment">/// Defines `name` in namespace `ns` of module `parent` to be `def` if it is not yet defined;</span></span><br><span class="line">    <span class="comment">/// otherwise, reports an error.</span></span><br><span class="line">    <span class="keyword">crate</span> <span class="function"><span class="keyword">fn</span> <span class="title">define</span></span>&lt;T&gt;(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, parent: Module&lt;<span class="symbol">&#x27;a</span>&gt;, ident: Ident, ns: Namespace, def: T)</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        T: ToNameBinding&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> binding = def.to_name_binding(<span class="keyword">self</span>.arenas);</span><br><span class="line">        <span class="keyword">let</span> key = <span class="keyword">self</span>.new_key(ident, ns);</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Err</span>(old_binding) = <span class="keyword">self</span>.try_define(parent, key, binding) &#123;</span><br><span class="line">            <span class="keyword">self</span>.report_conflict(parent, ident, ns, old_binding, &amp;binding);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒå¥<code>let key = self.new_key(ident, ns);</code>çœ‹ç€ä¹Ÿæ²¡å•¥ç‰¹æ®Šçš„ï¼Œå°±æ˜¯æ ¹æ®å½“å‰æ‰€åœ¨çš„<code>namespace</code>ç»™<code>ident</code>ï¼ˆè¡¨ç¤ºæ ‡è¯†ç¬¦ï¼‰æ–°å»ºä¸€ä¸ª<code>key</code>ï¼Œé‚£ä¹ˆ value åº”è¯¥å°±æ˜¯ä¸Šé¢çš„<code>binding</code>äº†ã€‚</p><p>ç„¶åè¿™é‡Œè°ƒç”¨äº†<code>try_define</code>ï¼Œå¦‚æœè¿”å›äº† Err å°±è°ƒç”¨<code>report_conflict</code>ï¼Œè®©æˆ‘ä»¬æ¥ç€è¿›å…¥<code>try_define</code>çœ‹çœ‹ï¼ˆå…ˆä¸ç”¨ä»”ç»†çœ‹ï¼‰ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Define the name or return the existing binding if there is a collision.</span></span><br><span class="line"><span class="keyword">crate</span> <span class="function"><span class="keyword">fn</span> <span class="title">try_define</span></span>(</span><br><span class="line">    &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">    module: Module&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    key: BindingKey,</span><br><span class="line">    binding: &amp;<span class="symbol">&#x27;a</span> NameBinding&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">) -&gt; <span class="built_in">Result</span>&lt;(), &amp;<span class="symbol">&#x27;a</span> NameBinding&lt;<span class="symbol">&#x27;a</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> res = binding.res();</span><br><span class="line">    <span class="keyword">self</span>.check_reserved_macro_name(key.ident, res);</span><br><span class="line">    <span class="keyword">self</span>.set_binding_parent_module(binding, module);</span><br><span class="line">    <span class="keyword">self</span>.update_resolution(module, key, |this, resolution| &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(old_binding) = resolution.binding &#123;</span><br><span class="line">            <span class="keyword">if</span> res == Res::<span class="literal">Err</span> &#123;</span><br><span class="line">                <span class="comment">// Do not override real bindings with `Res::Err`s from error recovery.</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">Ok</span>(());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">match</span> (old_binding.is_glob_import(), binding.is_glob_import()) &#123;</span><br><span class="line">                (<span class="literal">true</span>, <span class="literal">true</span>) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> res != old_binding.res() &#123;</span><br><span class="line">                        resolution.binding = <span class="literal">Some</span>(this.ambiguity(</span><br><span class="line">                            AmbiguityKind::GlobVsGlob,</span><br><span class="line">                            old_binding,</span><br><span class="line">                            binding,</span><br><span class="line">                        ));</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> !old_binding.vis.is_at_least(binding.vis, &amp;*this) &#123;</span><br><span class="line">                        <span class="comment">// We are glob-importing the same item but with greater visibility.</span></span><br><span class="line">                        resolution.binding = <span class="literal">Some</span>(binding);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                (old_glob @ <span class="literal">true</span>, <span class="literal">false</span>) | (old_glob @ <span class="literal">false</span>, <span class="literal">true</span>) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">let</span> (glob_binding, nonglob_binding) =</span><br><span class="line">                        <span class="keyword">if</span> old_glob &#123; (old_binding, binding) &#125; <span class="keyword">else</span> &#123; (binding, old_binding) &#125;;</span><br><span class="line">                    <span class="keyword">if</span> glob_binding.res() != nonglob_binding.res()</span><br><span class="line">                        &amp;&amp; key.ns == MacroNS</span><br><span class="line">                        &amp;&amp; nonglob_binding.expansion != LocalExpnId::ROOT</span><br><span class="line">                    &#123;</span><br><span class="line">                        resolution.binding = <span class="literal">Some</span>(this.ambiguity(</span><br><span class="line">                            AmbiguityKind::GlobVsExpanded,</span><br><span class="line">                            nonglob_binding,</span><br><span class="line">                            glob_binding,</span><br><span class="line">                        ));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        resolution.binding = <span class="literal">Some</span>(nonglob_binding);</span><br><span class="line">                    &#125;</span><br><span class="line">                    resolution.shadowed_glob = <span class="literal">Some</span>(glob_binding);</span><br><span class="line">                &#125;</span><br><span class="line">                (<span class="literal">false</span>, <span class="literal">false</span>) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">Err</span>(old_binding);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resolution.binding = <span class="literal">Some</span>(binding);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹ç€æ¯”è¾ƒé•¿ï¼Œè®©æˆ‘ä»¬ä¸€ç‚¹ä¸€ç‚¹æ¥ã€‚</p><p>ç¬¬ä¸€å¥<code>let res = binding.res();</code>å°±æœ‰ç‚¹æ‡µäº†ï¼Œ<code>res</code>æ˜¯å•¥ï¼Ÿresultï¼Ÿresponseï¼Ÿå…¶å®éƒ½ä¸æ˜¯ï¼Œæˆ‘ä»¬ç‚¹è¿›å»çœ‹çœ‹ï¼Œä¸€ç›´ç‚¹åˆ°åº•ï¼Œä¼šå‘ç°å…¶å®æ˜¯<code>resolution</code>çš„ç¼©å†™ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// The resolution of a path or export.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// For every path or identifier in Rust, the compiler must determine</span></span><br><span class="line"><span class="comment">/// what the path refers to. This process is called name resolution,</span></span><br><span class="line"><span class="comment">/// and `Res` is the primary result of name resolution.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// For example, everything prefixed with `/* Res */` in this example has</span></span><br><span class="line"><span class="comment">/// an associated `Res`:</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// fn str_to_string(s: &amp; /* Res */ str) -&gt; /* Res */ String &#123;</span></span><br><span class="line"><span class="comment">///     /* Res */ String::from(/* Res */ s)</span></span><br><span class="line"><span class="comment">/// &#125;</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// /* Res */ str_to_string(&quot;hello&quot;);</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// The associated `Res`s will be:</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - `str` will resolve to [`Res::PrimTy`];</span></span><br><span class="line"><span class="comment">/// - `String` will resolve to [`Res::Def`], and the `Res` will include the [`DefId`]</span></span><br><span class="line"><span class="comment">///   for `String` as defined in the standard library;</span></span><br><span class="line"><span class="comment">/// - `String::from` will also resolve to [`Res::Def`], with the [`DefId`]</span></span><br><span class="line"><span class="comment">///   pointing to `String::from`;</span></span><br><span class="line"><span class="comment">/// - `s` will resolve to [`Res::Local`];</span></span><br><span class="line"><span class="comment">/// - the call to `str_to_string` will resolve to [`Res::Def`], with the [`DefId`]</span></span><br><span class="line"><span class="comment">///   pointing to the definition of `str_to_string` in the current crate.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#[derive(Clone, Copy, PartialEq, Eq, Encodable, Decodable, Hash, Debug)]</span></span><br><span class="line"><span class="meta">#[derive(HashStable_Generic)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">Res</span></span>&lt;Id = hir::HirId&gt; &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¥½çš„ï¼Œè¿™æ¡è¯­å¥å°±æ˜¯è·å¾—äº†æˆ‘ä»¬åˆšæ‰åˆå§‹åŒ–çš„<code>binding</code>çš„<code>resolution</code>ï¼Œæˆ‘ä»¬æ¥ç€çœ‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.check_reserved_macro_name(key.ident, res);</span><br><span class="line"><span class="keyword">self</span>.set_binding_parent_module(binding, module);</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹ç¬¬ä¸€è¡Œçš„<code>check_reserved_macro_name</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">crate</span> <span class="function"><span class="keyword">fn</span> <span class="title">check_reserved_macro_name</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, ident: Ident, res: Res) &#123;</span><br><span class="line">    <span class="comment">// Reserve some names that are not quite covered by the general check</span></span><br><span class="line">    <span class="comment">// performed on `Resolver::builtin_attrs`.</span></span><br><span class="line">    <span class="keyword">if</span> ident.name == sym::cfg || ident.name == sym::cfg_attr &#123;</span><br><span class="line">        <span class="keyword">let</span> macro_kind = <span class="keyword">self</span>.get_macro(res).map(|ext| ext.macro_kind());</span><br><span class="line">        <span class="keyword">if</span> macro_kind.is_some() &amp;&amp; sub_namespace_match(macro_kind, <span class="literal">Some</span>(MacroKind::Attr)) &#123;</span><br><span class="line">            <span class="keyword">self</span>.session.span_err(</span><br><span class="line">                ident.span,</span><br><span class="line">                &amp;<span class="built_in">format!</span>(<span class="string">&quot;name `&#123;&#125;` is reserved in attribute namespace&quot;</span>, ident),</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¥½åƒä¹Ÿæ²¡å•¥ç‰¹æ®Šçš„ï¼Œå°±æ˜¯çœ‹çœ‹æœ‰æ²¡æœ‰ç”¨åˆ°ä¿ç•™å…³é”®å­—ï¼Œå…ˆæ— è§†æ‰å§ï¼›</p><p>å†çœ‹çœ‹ç¬¬äºŒè¡Œ<code>set_binding_parent_module</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">set_binding_parent_module</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, binding: &amp;<span class="symbol">&#x27;a</span> NameBinding&lt;<span class="symbol">&#x27;a</span>&gt;, module: Module&lt;<span class="symbol">&#x27;a</span>&gt;) &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(old_module) = <span class="keyword">self</span>.binding_parent_modules.insert(PtrKey(binding), module) &#123;</span><br><span class="line">        <span class="keyword">if</span> !ptr::eq(module, old_module) &#123;</span><br><span class="line">            span_bug!(binding.span, <span class="string">&quot;parent module is reset for binding&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>hmmmâ€¦â€¦å¥½åƒæ˜¯ç»‘å®šäº†æ‰€åœ¨çš„ moduleï¼Œçœ‹ç€ä¹Ÿæ²¡å•¥ç‰¹æ®Šçš„ï¼Œä¹Ÿè·³è¿‡å§ã€‚</p><p>æ¥ç€å¾€ä¸‹çœ‹ï¼Œè¿™ä¸€æ®µæ˜¯é‡å¤´æˆäº†ï¼Œè®©æˆ‘ä»¬å…ˆè¿›å…¥<code>update_resolution</code>çœ‹çœ‹ï¼š</p><img data-src="https://static.purewhite.io/uPic/2021-11-07/image-20211107191451777-uOrrh7.png!webp_90" alt="update_resolution" style="zoom:67%;" /><p>è¿™é‡Œæˆ‘ä»¬åªå…³æ³¨ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> resolution = &amp;<span class="keyword">mut</span> *<span class="keyword">self</span>.resolution(module, key).borrow_mut();</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> t = f(<span class="keyword">self</span>, resolution);</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤è¡Œï¼Œè¿™ä¸¤è¡Œåº”è¯¥æ˜¯ä¸»è¦é€»è¾‘ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬è°ƒç”¨äº†<code>self.resolution</code>ï¼Œæˆ‘ä»¬è¿›å»çœ‹çœ‹ï¼š</p><img data-src="https://static.purewhite.io/uPic/2021-11-07/image-20211107191616859-Q69Ns3.png!webp_90" alt="resolution" style="zoom:67%;" /><p>è¿™é‡Œåˆè°ƒç”¨äº†<code>resolutions</code>ï¼š</p><img data-src="https://static.purewhite.io/uPic/2021-11-07/image-20211107191702182-edhbmZ.png!webp_90" alt="resolutions" style="zoom:67%;" /><p>è¿™é‡Œæˆ‘ä»¬å‘ç°åˆæœ‰ä¸€æ®µæ–°çš„é€»è¾‘ï¼Œæˆ‘ä»¬çœ‹ä¸‹å­—æ®µçš„æ³¨é‡Šï¼š</p><img data-src="https://static.purewhite.io/uPic/2021-11-07/image-20211107191746171-295pM4.png!webp_90" alt="module populate" style="zoom:67%;" /><p>ä¼šå‘ç°å…¶å® module çš„ resolution æ˜¯ lazy è®¡ç®—çš„ï¼Œokï¼Œå…·ä½“çš„<code>build_reduced_graph_external</code>æƒ³å¿…å°±æ˜¯è®¡ç®—çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå…ˆè·³è¿‡ï¼Œä½œä¸ºä¸€ä¸ªé»‘ç›’ï¼Œä¹‹åå†å»æ¢ç©¶ã€‚</p><p>å¥½äº†ï¼Œç°åœ¨å›è¿‡å¤´ç»§ç»­çœ‹åˆšæ‰çš„ä»£ç ï¼š</p><img data-src="https://static.purewhite.io/uPic/2021-11-07/image-20211107191616859-Q69Ns3.png!webp_90" alt="resolution" style="zoom:67%;" /><p>åœ¨<code>resolution</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬è·å–åˆ°äº†å½“å‰æ¨¡å—çš„æ‰€æœ‰<code>resolutions</code>ï¼Œç„¶åçœ‹çœ‹<code>key</code>æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨å°±åˆ›å»ºä¸€ä¸ªæ–°çš„ï¼Œå¹¶è¿”å›è¿™ä¸ª<code>resolution</code>ã€‚</p><p>å†å›åˆ°ä¸Šå±‚ä»£ç ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> resolution = &amp;<span class="keyword">mut</span> *<span class="keyword">self</span>.resolution(module, key).borrow_mut();</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> t = f(<span class="keyword">self</span>, resolution);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬æ‹¿åˆ°äº†<code>resolution</code>åè°ƒç”¨äº†ä¼ å…¥çš„ fï¼Œè®©æˆ‘ä»¬å›åˆ°<code>try_define</code>ä¸­ï¼Œå…ˆçœ‹ else éƒ¨åˆ†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.update_resolution(module, key, |this, resolution| &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(old_binding) = resolution.binding &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolution.binding = <span class="literal">Some</span>(binding);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="literal">Ok</span>(())</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¦‚æœè¿”å›çš„<code>resolution</code>çš„<code>binding</code>æ˜¯<code>None</code>ï¼ˆå¯¹åº”ä¸Šé¢<code>resolution</code>æ–¹æ³•ä¸­æ–°å»ºçš„<code>resolution</code>ï¼Œä¹‹å‰ä¸å­˜åœ¨ï¼‰ï¼Œé‚£ä¹ˆå°±æŠŠ<code>resolution</code>çš„<code>binding</code>è®¾ä¸ºå½“å‰çš„<code>binding</code>ç„¶åè¿”å›<code>Ok</code>ï¼Œé€»è¾‘è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚</p><p>å¥½äº†ï¼Œè®©æˆ‘ä»¬å†æ¥ç€çœ‹çœ‹å¦‚æœåŸæ¥å·²ç»æœ‰äº†ä¸€ä¸ª<code>binding</code>ï¼Œrustc ä¼šå¦‚ä½•å¤„ç†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> res = binding.res();</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.update_resolution(module, key, |this, resolution| &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(old_binding) = resolution.binding &#123;</span><br><span class="line">        <span class="keyword">if</span> res == Res::<span class="literal">Err</span> &#123;</span><br><span class="line">            <span class="comment">// Do not override real bindings with `Res::Err`s from error recovery.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Ok</span>(());</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¦‚æœä¹‹å‰è¿”å›çš„ res æœ¬èº«å°±æ˜¯ Err çš„è¯ï¼Œå°±ç›´æ¥è¿”å›ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ Err çš„æ³¨é‡Šï¼š</p><img data-src="https://static.purewhite.io/uPic/2021-11-07/image-20211107192704528-TJIrs5.png!webp_90" alt="Res::Err" style="zoom:67%;" /><p>å—¯ï¼Œè¿™éƒ¨åˆ†ç›´æ¥æ— è§†å§ï¼Œæˆ‘ä»¬æ¥ç€çœ‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> res = binding.res();</span><br><span class="line"><span class="keyword">self</span>.update_resolution(module, key, |this, resolution| &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(old_binding) = resolution.binding &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">match</span> (old_binding.is_glob_import(), binding.is_glob_import()) &#123;</span><br><span class="line">            (<span class="literal">true</span>, <span class="literal">true</span>) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> res != old_binding.res() &#123;</span><br><span class="line">                    resolution.binding = <span class="literal">Some</span>(this.ambiguity(</span><br><span class="line">                        AmbiguityKind::GlobVsGlob,</span><br><span class="line">                        old_binding,</span><br><span class="line">                        binding,</span><br><span class="line">                    ));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> !old_binding.vis.is_at_least(binding.vis, &amp;*this) &#123;</span><br><span class="line">                    <span class="comment">// We are glob-importing the same item but with greater visibility.</span></span><br><span class="line">                    resolution.binding = <span class="literal">Some</span>(binding);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br></pre></td></tr></table></figure><p>å¦‚æœè¯´æ–°çš„å’Œæ—§çš„éƒ½æ˜¯<code>glob_import</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬åˆ¤æ–­ä¸€ä¸‹å½“å‰çš„<code>res</code>å’Œä¹‹å‰çš„<code>res</code>æ˜¯å¦æ˜¯åŒä¸€ä¸ªï¼Œå¦‚æœä¸æ˜¯å°±è¯´æ˜å‡ºç°äº†æ¨¡ç³Šæ€§ï¼Œæˆ‘ä»¬æŠŠ<code>resolution</code>çš„<code>binding</code>è®¾ç½®æˆ<code>ambiguity</code>ï¼ˆæ¨¡ç³Šçš„æ„æ€ï¼‰ï¼›å¦‚æœä¸¤ä¸ª<code>res</code>æ˜¯åŒä¸€ä¸ªï¼Œé‚£æˆ‘ä»¬å†åˆ¤æ–­ä¸€ä¸‹å¯è§æ€§ï¼Œå¦‚æœè¯´æ–°çš„å¯è§æ€§æ›´å¤§ï¼Œé‚£æˆ‘ä»¬å°±ç›´æ¥æ›¿æ¢ã€‚</p><p>è¿™é‡Œå¤§å®¶å°±ä¼šç–‘æƒ‘äº†ï¼Œ<code>glob_import</code>æ˜¯å•¥ï¼Ÿæˆ‘ä»¬æ¥æ’å…¥ä¸€ä¸ªå°æ’æ›²ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">import_kind_to_string</span></span>(import_kind: &amp;ImportKind&lt;<span class="symbol">&#x27;_</span>&gt;) -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line">    <span class="keyword">match</span> import_kind &#123;</span><br><span class="line">        ImportKind::Single &#123; source, .. &#125; =&gt; source.to_string(),</span><br><span class="line">        ImportKind::Glob &#123; .. &#125; =&gt; <span class="string">&quot;*&quot;</span>.to_string(),</span><br><span class="line">        ImportKind::ExternCrate &#123; .. &#125; =&gt; <span class="string">&quot;&lt;extern crate&gt;&quot;</span>.to_string(),</span><br><span class="line">        ImportKind::MacroUse =&gt; <span class="string">&quot;#[macro_use]&quot;</span>.to_string(),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™å¤§å®¶åº”è¯¥éƒ½çŸ¥é“äº†å§ï¼Œæˆ‘å°±ä¸è¿‡å¤šè§£é‡Šäº†ã€‚</p><p>å¥½çš„ï¼Œå›å½’æ­£é¢˜ï¼Œçœ‹èµ·æ¥è¿™æ®µæ˜¯å¤„ç†<code>use</code>ç›¸å…³çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•ç•¥è¿‡ï¼Œæ¥ç€å¾€ä¸‹çœ‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> res = binding.res();</span><br><span class="line"><span class="keyword">self</span>.update_resolution(module, key, |this, resolution| &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(old_binding) = resolution.binding &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">match</span> (old_binding.is_glob_import(), binding.is_glob_import()) &#123;</span><br><span class="line">            ...</span><br><span class="line">            (old_glob @ <span class="literal">true</span>, <span class="literal">false</span>) | (old_glob @ <span class="literal">false</span>, <span class="literal">true</span>) =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> (glob_binding, nonglob_binding) =</span><br><span class="line">                    <span class="keyword">if</span> old_glob &#123; (old_binding, binding) &#125; <span class="keyword">else</span> &#123; (binding, old_binding) &#125;;</span><br><span class="line">                <span class="keyword">if</span> glob_binding.res() != nonglob_binding.res()</span><br><span class="line">                    &amp;&amp; key.ns == MacroNS</span><br><span class="line">                    &amp;&amp; nonglob_binding.expansion != LocalExpnId::ROOT</span><br><span class="line">                &#123;</span><br><span class="line">                    resolution.binding = <span class="literal">Some</span>(this.ambiguity(</span><br><span class="line">                        AmbiguityKind::GlobVsExpanded,</span><br><span class="line">                        nonglob_binding,</span><br><span class="line">                        glob_binding,</span><br><span class="line">                    ));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    resolution.binding = <span class="literal">Some</span>(nonglob_binding);</span><br><span class="line">                &#125;</span><br><span class="line">                resolution.shadowed_glob = <span class="literal">Some</span>(glob_binding);</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ®µæˆ‘ä»¬å¤„ç†äº†ä¸€ä¸ª<code>glob_import</code>å’Œä¸€ä¸ªé<code>glob_import</code>çš„æƒ…å†µï¼Œç®€å•æ¥è¯´åŸåˆ™å°±æ˜¯ï¼Œé<code>glob</code>çš„ä¼˜å…ˆï¼Œä½†æ˜¯æœ‰ä¸ªä¾‹å¤–ï¼šå¦‚æœé<code>glob</code>çš„æ˜¯åœ¨å®ä¸­çš„ï¼Œé‚£ä¹ˆè¿™é‡Œå°±ä¼šå¯¼è‡´â€œæ¨¡ç³Šâ€ï¼ˆRust æ˜¯å«ç”Ÿå®ï¼‰ï¼Œè¿™é‡Œä¼šåƒä¸Šæ–‡ä¸€æ ·æŠŠ<code>binding</code>è®¾ä¸º<code>ambiguity</code>ã€‚</p><p>è¿™éƒ¨åˆ†çš„é€»è¾‘æ¶‰åŠåˆ°å®çš„ç›¸å…³çŸ¥è¯†ï¼Œæˆ‘ä»¬å…ˆä½œä¸ºä¸€ä¸ªé»‘ç›’è·³è¿‡ï¼Œåæ­£å¤§æ¦‚äº†è§£åˆ°äº†é<code>glob</code>ä¼˜å…ˆï¼Œä¼š<code>shadow</code>æ‰<code>glob</code>å°±å®Œäº‹ï¼Œè¿™ä¹Ÿç¬¦åˆæˆ‘ä»¬çš„ç¼–ç ç»éªŒå’Œäººä½“å·¥ç¨‹å­¦ã€‚</p><p>å¥½ï¼Œæˆ‘ä»¬æœ€åçœ‹æœ€ç®€å•çš„ä¸€éƒ¨åˆ†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> res = binding.res();</span><br><span class="line"><span class="keyword">self</span>.update_resolution(module, key, |this, resolution| &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(old_binding) = resolution.binding &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">match</span> (old_binding.is_glob_import(), binding.is_glob_import()) &#123;</span><br><span class="line">            ...</span><br><span class="line">            (<span class="literal">false</span>, <span class="literal">false</span>) =&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">Err</span>(old_binding);</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸¤ä¸ªåå­—éƒ½ä¸æ˜¯<code>glob</code>å¼•å…¥çš„ï¼Œé‚£ä¹ˆå°±è¯´æ˜åœ¨å½“å‰çš„å‘½åç©ºé—´ä¸­æˆ‘ä»¬å‡ºç°äº†ä¿©ä¸€æ ·çš„åå­—ï¼ˆè¦æ³¨æ„åœ¨è¿™é‡Œè§£æçš„ä¸æ˜¯å˜é‡åï¼Œæ‰€ä»¥ä¸å…è®¸æœ‰ä¸€æ ·çš„ï¼‰ï¼Œé‚£ä¹ˆå°±è¯´æ˜å‡ºé”™äº†ï¼Œè¿”å›é”™è¯¯æŠ›ç»™ä¸Šå±‚ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„<code>define</code>æ–¹æ³•ä¸­ï¼Œå¹¶æŠ¥é”™ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Defines `name` in namespace `ns` of module `parent` to be `def` if it is not yet defined;</span></span><br><span class="line"><span class="comment">/// otherwise, reports an error.</span></span><br><span class="line"><span class="keyword">crate</span> <span class="function"><span class="keyword">fn</span> <span class="title">define</span></span>&lt;T&gt;(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, parent: Module&lt;<span class="symbol">&#x27;a</span>&gt;, ident: Ident, ns: Namespace, def: T)</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    T: ToNameBinding&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> binding = def.to_name_binding(<span class="keyword">self</span>.arenas);</span><br><span class="line">    <span class="keyword">let</span> key = <span class="keyword">self</span>.new_key(ident, ns);</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Err</span>(old_binding) = <span class="keyword">self</span>.try_define(parent, key, binding) &#123;</span><br><span class="line">        <span class="keyword">self</span>.report_conflict(parent, ident, ns, old_binding, &amp;binding);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å¥½äº†ï¼Œè‡³æ­¤ï¼Œæˆ‘ä»¬çœ‹å®Œäº†æˆ‘ä»¬å¼€å¤´æ‰€è¯´çš„<code>the name xx is defined multiple times</code>ç›¸å…³çš„é€»è¾‘å•¦ã€‚</p><p>ä¸è¿‡æˆ‘ä»¬ä»ç„¶é—ç•™äº†ä¸€äº›é—®é¢˜ï¼Œå¤§å®¶å¯ä»¥ç»§ç»­æ·±å…¥æ¢ç©¶ä¸€ä¸‹ï¼š</p><ol><li><code>binding</code>è¢«æ ‡è®°ä¸º<code>ambiguity</code>åï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</li><li><code>module</code>çš„<code>resolution</code>æ˜¯æ€ä¹ˆè¢«è§£æå‡ºæ¥çš„ï¼Ÿä¹Ÿå°±æ˜¯æˆ‘ä»¬ç•¥è¿‡çš„<code>build_reduced_graph_external</code>å¹²äº†å•¥ï¼Ÿ</li><li>å®å±•å¼€å¯¼è‡´çš„å†²çªä¸ºä»€ä¹ˆè¦ç‰¹æ®Šå¯¹å¾…ï¼Ÿ</li></ol><p>å¤§å®¶å¯ä»¥é¡ºç€ä»¥ä¸Šçš„é—®é¢˜ç»§ç»­æ¢ç©¶ï¼Œæ¬¢è¿å¤§å®¶ç•™è¨€è¯„è®ºæˆ–è€…åŠ å…¥ Rust ä¸­æ–‡ç¤¾ç¾¤ä¸€èµ·è®¨è®ºå­¦ä¹  Rust~</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘ Rust å®˜æ–¹ç¤¾åŒºæäº†ä¸ª Rustc Reading Club çš„æ´»åŠ¨ï¼Œç”±ç¼–è¯‘å™¨ team çš„ Leader Niko å‘èµ·ï¼Œå…·ä½“ç½‘å€åœ¨è¿™é‡Œï¼š&lt;a href=&quot;https://rust-lang.github.io/rustc-reading-club/&quot;&gt;https://rust-lang.github.io/rustc-reading-club/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;å¾ˆå¯æƒœçš„æ˜¯ï¼Œ11 æœˆ 4 æ—¥çš„ç¬¬ä¸€æœŸï¼Œç”±äºå¤ªè¿‡ç«çˆ†å¹¶ä¸” Zoom äººæ•°é™åˆ¶ 100 äººï¼Œå¯¼è‡´ä¸»æŒäºº Niko è‡ªå·±è¿›ä¸æ¥æ‰€ä»¥å–æ¶ˆäº†â€¦â€¦ç­‰å¾…çœ‹çœ‹å®˜æ–¹åç»­ä¼šæ€ä¹ˆæå§ï¼Œè¿˜æ˜¯å¾ˆæœŸå¾…å®˜æ–¹ç»„ç»‡çš„æ´»åŠ¨çš„ã€‚&lt;/p&gt;
&lt;p&gt;Rust ä¸­æ–‡ç¤¾ç¾¤çš„å¼ æ±‰ä¸œå¤§ä½¬ä¹Ÿç´§è·Ÿç€å®˜æ–¹çš„æ´»åŠ¨ï¼Œåœ¨ç¤¾ç¾¤é‡Œé¢ç»„ç»‡äº† Rustc æºç é˜…è¯»çš„æ´»åŠ¨ï¼Œä»Šå¤©ï¼ˆ11 æœˆ 7 æ—¥ï¼‰ä¸¾åŠäº†ç¬¬ä¸€æœŸï¼Œåœ¨è¿™æœŸä¸­æˆ‘è·Ÿç€å´ç¿±ç¿”å¤§ä½¬çš„æ€è·¯ï¼Œä»ä¸€ä¸ªé”™è¯¯å‡ºå‘ï¼Œå­¦ä¹ äº†ä¸€éƒ¨åˆ† rustc_resolve çš„é€»è¾‘ï¼Œäºæ˜¯æƒ³ç€å†™ä¸€ç¯‡åšå®¢æ€»ç»“ä¸€ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;ã€å°å¹¿å‘Šã€‘ä¸‹ä¸€æœŸ 11 æœˆ 14 æ—¥ä¸‹åˆä¼šç”±åˆ˜ç¿¼é£å¤§ä½¬å¸¦é¢†å¤§å®¶ä¸€èµ·å»é˜…è¯»ç±»å‹æ¨å¯¼ç›¸å…³çš„ä»£ç ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ä¸‹è½½&lt;a href=&quot;https://www.feishu.cn/&quot;&gt;é£ä¹¦&lt;/a&gt;ï¼Œæ³¨å†Œä¸€ä¸ªä¸ªäººè´¦å·ï¼Œç„¶åæ‰«æäºŒç»´ç åŠ å…¥ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="rust" scheme="https://www.purewhite.io/categories/rust/"/>
    
    
    <category term="rust" scheme="https://www.purewhite.io/tags/rust/"/>
    
  </entry>
  
  <entry>
    <title>The Rustonomicon çš„ä¸­æ–‡ç¿»è¯‘</title>
    <link href="https://www.purewhite.io/2021/09/23/rust-nomicon-translate/"/>
    <id>https://www.purewhite.io/2021/09/23/rust-nomicon-translate/</id>
    <published>2021-09-23T09:50:56.000Z</published>
    <updated>2021-12-02T12:51:07.229Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨å­¦ä¹  Rustï¼Œå‘ç° Rust ç¤¾åŒºçœŸçš„æ˜¯æœ‰éå¸¸ä¸°å¯Œçš„èµ„æºï¼Œä»ç¤¾åŒºä¸­å­¦åˆ°äº†å¾ˆå¤šæœ‰ç”¨çš„ä¸œè¥¿ã€‚ä¸æ­¤åŒæ—¶ï¼Œä¹Ÿä¸€ç›´æƒ³ç€èƒ½å¤Ÿä¸ºç¤¾åŒºåšç‚¹ä»€ä¹ˆã€‚</p><p>æ­£å¥½å‘ç°<a href="https://doc.rust-lang.org/nomicon/">ã€ŠThe Rustonomiconã€‹</a>ï¼ˆä¹Ÿç§°ä¸º Rust ç§˜å…¸ã€æ­»çµä¹¦ï¼‰ä¹‹å‰çš„ä¸€ç‰ˆä¸­æ–‡ç¿»è¯‘ï¼ˆæ„Ÿè°¢@tjxingï¼‰æ˜¯æ›´æ–°åˆ°äº† 2018 å¹´ï¼Œä¹‹åå°±å†ä¹Ÿæ²¡å†æ›´æ–°ç»´æŠ¤è¿‡äº†ï¼›è€Œè¿™ä¸‰å¹´å®˜æ–¹ä¹Ÿå¯¹äºè¿™æœ¬ä¹¦è¿›è¡Œäº†å¤§é‡çš„è¿­ä»£å‡çº§ï¼Œäºæ˜¯æƒ³ç€é‡æ–°ç¿»è¯‘ä¸€ç‰ˆï¼Œå¹¶å°½å¯èƒ½æŒç»­è·Ÿè¿›è¿­ä»£ï¼Œè´¡çŒ®ç»™ç¤¾åŒºï¼Œä¹Ÿç®—æ˜¯å°½ä¸€ä»½ç»µè–„ä¹‹åŠ›ã€‚</p><p>åœ¨çº¿é˜…è¯»åœ°å€ï¼š<a href="https://nomicon.purewhite.io/">https://nomicon.purewhite.io/</a></p><p>github åœ°å€ï¼š<a href="https://github.com/PureWhiteWu/nomicon-zh-Hans">https://github.com/PureWhiteWu/nomicon-zh-Hans</a></p><span id="more"></span><h1 id="ä¸€äº›æƒ³è¯´çš„è¯"><a href="#ä¸€äº›æƒ³è¯´çš„è¯" class="headerlink" title="ä¸€äº›æƒ³è¯´çš„è¯"></a>ä¸€äº›æƒ³è¯´çš„è¯</h1><p>é¦–å…ˆï¼Œé™äºè¯‘è€…è‡ªèº«å§¿åŠ¿æ°´å¹³ï¼Œç¿»è¯‘æœ‰å¯èƒ½æ— æ³•åšåˆ°å®Œå…¨ä¿¡è¾¾é›…ï¼Œå¹¶ä¸”æœ‰ä¸€äº›ä¸“ä¸šæœ¯è¯­ä¸çŸ¥é“å¦‚ä½•ç¿»è¯‘åˆ°ä¸­æ–‡ï¼Œåœ¨è¿™é‡Œå…ˆå‘å¤§å®¶é“æ­‰ï¼Œè¯·å¤šåŒ…æ¶µã€‚</p><p>ä¸è¿‡ï¼Œè¯‘è€…ä¿è¯æ‰€æœ‰ç¿»è¯‘çš„å†…å®¹éƒ½æ˜¯è¯‘è€…é˜…è¯»å¹¶è°ƒæ•´è¿‡å¤šæ¬¡çš„ï¼Œå¹¶ä¸”è¯‘è€…ä¼šåŠªåŠ›å°†å†…å®¹è°ƒæ•´åˆ°æ»¡è¶³<strong>èƒ½çœ‹æ‡‚</strong>çš„è¦æ±‚ï¼Œå¹¶ä¸”åšåˆ°ä¸é—æ¼åŸæ–‡å†…å®¹ã€‚</p><p>å¦‚æœå¤§å®¶å¯¹äºç¿»è¯‘æœ‰æ›´å¥½çš„å»ºè®®æˆ–è€…æƒ³æ³•ï¼Œæ¬¢è¿ç›´æ¥ PR~</p><p>ç›®å‰ç¿»è¯‘åŸºäº commitï¼š2747c4bb2cbc0639b733793ddb0bf4e9daa2634eï¼ŒåŸºäºæ—¶é—´ï¼š2021/9/19</p><p>Qï¼šä¸ºä»€ä¹ˆä¸åŸºäºä¹‹å‰å·²æœ‰çš„ä¸­æ–‡ç‰ˆè¿›è¡Œæ”¹è¿›ï¼Ÿ</p><p>Aï¼šå› ä¸ºç¿»è¯‘æˆä¸­æ–‡ç‰ˆåï¼Œå¾ˆéš¾å†å›è¿‡å¤´å»çœ‹å’Œç°åœ¨çš„è‹±æ–‡ç‰ˆåŸæ–‡åˆ°åº•å·®äº†å•¥ï¼Œæ‰€ä»¥è¿˜ä¸å¦‚å®Œå…¨é‡æ–°ç¿»è¯‘ä¸€éã€‚</p><p>Qï¼šé‚£ä¼šä¸ä¼šæœ‰ä¸€å¤©ä½ çš„è¿™ä¸ªç‰ˆæœ¬ä¹Ÿè¿‡æœŸäº†ï¼Ÿ</p><p>Aï¼šå¸Œæœ›æ²¡æœ‰é‚£ä¸€å¤©ã€‚æˆ‘ watch äº†è‹±æ–‡åŸç‰ˆçš„æ‰€æœ‰ PRï¼Œå¦‚æœæœ‰å˜æ›´ï¼ˆå¸Œæœ›ï¼‰èƒ½åŠæ—¶æ›´æ–°ã€‚å½“ç„¶ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶ä¸€èµ·è´¡çŒ® PRã€‚</p><h1 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h1><ul><li><input disabled="" type="checkbox"> github å¢åŠ  actionï¼Œåˆå…¥ master åè‡ªåŠ¨æ›´æ–°çº¿ä¸Šç‰ˆæœ¬</li><li><input disabled="" type="checkbox"> æ€è€ƒæ˜¯å¦æŠŠè‹±æ–‡åŸç‰ˆå’Œä¸­æ–‡ç¿»è¯‘æŒ‰æ®µè½æ”¾åœ¨ä¸€èµ·ï¼Œæ–¹ä¾¿æŸ¥é˜…åŸç‰ˆ</li></ul><p>ä¹Ÿæ¬¢è¿å¤§å®¶é›†æ€å¹¿ç›Šï¼Œä¸€èµ·å»ºè®¾ Rust ç¤¾åŒºã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘åœ¨å­¦ä¹  Rustï¼Œå‘ç° Rust ç¤¾åŒºçœŸçš„æ˜¯æœ‰éå¸¸ä¸°å¯Œçš„èµ„æºï¼Œä»ç¤¾åŒºä¸­å­¦åˆ°äº†å¾ˆå¤šæœ‰ç”¨çš„ä¸œè¥¿ã€‚ä¸æ­¤åŒæ—¶ï¼Œä¹Ÿä¸€ç›´æƒ³ç€èƒ½å¤Ÿä¸ºç¤¾åŒºåšç‚¹ä»€ä¹ˆã€‚&lt;/p&gt;
&lt;p&gt;æ­£å¥½å‘ç°&lt;a href=&quot;https://doc.rust-lang.org/nomicon/&quot;&gt;ã€ŠThe Rustonomiconã€‹&lt;/a&gt;ï¼ˆä¹Ÿç§°ä¸º Rust ç§˜å…¸ã€æ­»çµä¹¦ï¼‰ä¹‹å‰çš„ä¸€ç‰ˆä¸­æ–‡ç¿»è¯‘ï¼ˆæ„Ÿè°¢@tjxingï¼‰æ˜¯æ›´æ–°åˆ°äº† 2018 å¹´ï¼Œä¹‹åå°±å†ä¹Ÿæ²¡å†æ›´æ–°ç»´æŠ¤è¿‡äº†ï¼›è€Œè¿™ä¸‰å¹´å®˜æ–¹ä¹Ÿå¯¹äºè¿™æœ¬ä¹¦è¿›è¡Œäº†å¤§é‡çš„è¿­ä»£å‡çº§ï¼Œäºæ˜¯æƒ³ç€é‡æ–°ç¿»è¯‘ä¸€ç‰ˆï¼Œå¹¶å°½å¯èƒ½æŒç»­è·Ÿè¿›è¿­ä»£ï¼Œè´¡çŒ®ç»™ç¤¾åŒºï¼Œä¹Ÿç®—æ˜¯å°½ä¸€ä»½ç»µè–„ä¹‹åŠ›ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨çº¿é˜…è¯»åœ°å€ï¼š&lt;a href=&quot;https://nomicon.purewhite.io/&quot;&gt;https://nomicon.purewhite.io/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;github åœ°å€ï¼š&lt;a href=&quot;https://github.com/PureWhiteWu/nomicon-zh-Hans&quot;&gt;https://github.com/PureWhiteWu/nomicon-zh-Hans&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="rust" scheme="https://www.purewhite.io/categories/rust/"/>
    
    
    <category term="rust" scheme="https://www.purewhite.io/tags/rust/"/>
    
  </entry>
  
  <entry>
    <title>ã€è¯‘ã€‘Rust å¸¸è§çš„é—®é¢˜</title>
    <link href="https://www.purewhite.io/2021/09/01/rust-faq/"/>
    <id>https://www.purewhite.io/2021/09/01/rust-faq/</id>
    <published>2021-09-01T08:24:08.000Z</published>
    <updated>2021-12-02T12:51:07.229Z</updated>
    
    <content type="html"><![CDATA[<p>åŸæ–‡ï¼š<a href="https://github.com/dtolnay/rust-faq">https://github.com/dtolnay/rust-faq</a></p><p>æœ¬æ–‡æ¡£çš„å­˜åœ¨æ˜¯ä¸ºäº†å›ç­”æœ‰å…³ Rust ç¼–ç¨‹è¯­è¨€çš„å¸¸è§é—®é¢˜ã€‚å®ƒä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„è¯­è¨€æŒ‡å—ï¼Œä¹Ÿä¸æ˜¯ä¸€ä¸ªæ•™æˆè¯¥è¯­è¨€çš„å·¥å…·ã€‚å®ƒåªæ˜¯ä¸€ä¸ªå‚è€ƒï¼Œç”¨æ¥å›ç­” Rust ç¤¾åŒºä¸­äººä»¬ç»å¸¸é‡åˆ°çš„é—®é¢˜ï¼Œå¹¶æ¾„æ¸… Rust çš„ä¸€äº›è®¾è®¡å†³å®šèƒŒåçš„åŸå› ã€‚</p><span id="more"></span><p>å¦‚æœä½ è§‰å¾—æœ‰ä¸€äº›å¸¸è§çš„æˆ–é‡è¦çš„é—®é¢˜åœ¨è¿™é‡Œæ²¡æœ‰å¾—åˆ°è§£ç­”ï¼Œè¯·åœ¨ GitHub ä¸Šé’ˆå¯¹<a href="https://github.com/dtolnay/rust-faq">è¿™ä¸ª repo</a>æä¸€ä¸ª issue!</p><p><em>è¿™äº›å†…å®¹å¤§éƒ¨åˆ†ä»¥å‰éƒ½åœ¨ rust-lang/rust åº“ä¸­ï¼Œå¹¶ä¸”åœ¨ç½‘ç«™ä¸Šæœ‰ä¸€ä¸ªä¸“é—¨çš„ FAQ é¡µé¢ã€‚ä½†æ˜¯åœ¨ 2018 å¹´çš„ç½‘ç«™é‡æ–°è®¾è®¡ä¸­ï¼Œå®ƒè¢«åˆ é™¤äº†ã€‚æˆ‘åœ¨è¿™é‡ŒæŠŠå®ƒæ¢å¤äº†ï¼Œå› ä¸ºè¿™äº›é—®é¢˜ä¸­çš„è®¸å¤šé—®é¢˜ä»ç„¶è¢«é¢‘ç¹è¯¢é—®ã€‚</em></p><h1 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h1><ul><li><a href="#The-Rust-Project">The Rust Project</a></li><li><a href="#%E6%80%A7%E8%83%BD">æ€§èƒ½</a></li><li><a href="#%E8%AF%AD%E6%B3%95">è¯­æ³•</a></li><li><a href="#%E6%95%B0%E5%AD%97">æ•°å­—</a></li><li><a href="#%E5%AD%97%E7%AC%A6%E4%B8%B2">å­—ç¬¦ä¸²</a></li><li><a href="#%E9%9B%86%E5%90%88">é›†åˆ</a></li><li><a href="#%E6%80%9D%E6%99%AE%E8%84%BE%E6%B0%94am">æ‰€æœ‰æƒ</a></li><li><a href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">ç”Ÿå‘½å‘¨æœŸ</a></li><li><a href="#%E6%B3%9B%E5%9E%8B">æ³›å‹</a></li><li><a href="#%E8%BE%93%E5%85%A5-%E8%BE%93%E5%87%BA">è¾“å…¥/è¾“å‡º</a></li><li><a href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">é”™è¯¯å¤„ç†</a></li><li><a href="#%E5%B9%B6%E5%8F%91">å¹¶å‘</a></li><li><a href="#%E5%AE%8F">å®</a></li><li><a href="#Debugging-and-Tooling">Debugging and Tooling</a></li><li><a href="#Low-Level">Low-Level</a></li><li><a href="#%E8%B7%A8%E5%B9%B3%E5%8F%B0">è·¨å¹³å°</a></li><li><a href="#mod-%E5%92%8C-crate">mod å’Œ crate</a></li><li><a href="#%E5%BA%93">åº“</a></li><li><a href="#%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">è®¾è®¡æ¨¡å¼</a></li><li><a href="#%E5%85%B6%E4%BB%96%E8%AF%AD%E8%A8%80">å…¶ä»–è¯­è¨€</a></li><li><a href="#Documentation">Documentation</a></li></ul><h1 id="The-Rust-Project"><a href="#The-Rust-Project" class="headerlink" title="The Rust Project"></a>The Rust Project</h1><h2 id="è¿™ä¸ªé¡¹ç›®çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#è¿™ä¸ªé¡¹ç›®çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="è¿™ä¸ªé¡¹ç›®çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ"></a>è¿™ä¸ªé¡¹ç›®çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>è®¾è®¡å¹¶å®ç°ä¸€ç§å®‰å…¨çš„ã€å¹¶å‘çš„ã€å®ç”¨çš„ç³»ç»Ÿçº§è¯­è¨€ã€‚</p><p>Rust ä¹‹æ‰€ä»¥å­˜åœ¨ï¼Œæ˜¯å› ä¸ºåœ¨è¿™ä¸ªæŠ½è±¡å’Œæ•ˆç‡æ°´å¹³ä¸Šçš„å…¶ä»–è¯­è¨€å¹¶ä¸ä»¤äººæ»¡æ„ã€‚ç‰¹åˆ«æ˜¯ï¼š</p><ol><li>å¯¹å®‰å…¨æ€§çš„å…³æ³¨å¤ªå°‘ã€‚</li><li>ä»–ä»¬å¯¹å¹¶å‘æ€§çš„æ”¯æŒå¾ˆå·®ã€‚</li><li>ç¼ºä¹å®é™…çš„æ‰¿å—åŠ›ã€‚</li><li>å®ƒä»¬å¯¹èµ„æºçš„æ§åˆ¶æœ‰é™ã€‚</li></ol><p>Rust ä½œä¸ºä¸€ç§æ›¿ä»£æ–¹æ¡ˆå­˜åœ¨ï¼Œå®ƒæ—¢èƒ½æä¾›é«˜æ•ˆçš„ä»£ç ï¼Œåˆèƒ½æä¾›èˆ’é€‚çš„æŠ½è±¡æ°´å¹³ï¼ŒåŒæ—¶åœ¨ä¸Šè¿°å››ç‚¹ä¸Šéƒ½æœ‰æ”¹è¿›ã€‚</p><h2 id="è¿™ä¸ªé¡¹ç›®æ˜¯ç”±-Mozilla-æ§åˆ¶çš„å—ï¼Ÿ"><a href="#è¿™ä¸ªé¡¹ç›®æ˜¯ç”±-Mozilla-æ§åˆ¶çš„å—ï¼Ÿ" class="headerlink" title="è¿™ä¸ªé¡¹ç›®æ˜¯ç”± Mozilla æ§åˆ¶çš„å—ï¼Ÿ"></a>è¿™ä¸ªé¡¹ç›®æ˜¯ç”± Mozilla æ§åˆ¶çš„å—ï¼Ÿ</h2><p>Rust åœ¨ 2006 å¹´ä½œä¸º Graydon Hoare çš„å…¼èŒé¡¹ç›®å¼€å§‹ï¼Œå¹¶ä¿æŒäº† 3 å¹´å¤šã€‚2009 å¹´ï¼Œå½“è¯¥è¯­è¨€æˆç†Ÿåˆ°å¯ä»¥è¿è¡ŒåŸºæœ¬æµ‹è¯•å¹¶å±•ç¤ºå…¶æ ¸å¿ƒæ¦‚å¿µæ—¶ï¼ŒMozilla å‚ä¸å…¶ä¸­ã€‚è™½ç„¶å®ƒä»ç„¶ç”± Mozilla èµåŠ©ï¼Œä½† Rust æ˜¯ç”±æ¥è‡ªä¸–ç•Œå„åœ°ä¸åŒåœ°æ–¹çš„çˆ±å¥½è€…ç»„æˆçš„ä¸€ä¸ªå¤šæ ·åŒ–ç¤¾åŒºå¼€å‘çš„ã€‚<a href="https://www.rust-lang.org/governance">Rust å›¢é˜Ÿ</a>ç”± Mozilla å’Œé Mozilla æˆå‘˜ç»„æˆï¼ŒGitHub ä¸Šçš„<code>rust</code>åˆ°ç›®å‰ä¸ºæ­¢å·²ç»æœ‰è¶…è¿‡<a href="https://github.com/rust-lang/rust/">2300 ä¸ªç‹¬ç‰¹çš„è´¡çŒ®è€…</a>ã€‚</p><p>å°±<a href="https://github.com/rust-lang/rfcs/blob/master/text/1068-rust-governance.md">é¡¹ç›®ç®¡ç†</a>è€Œè¨€ï¼ŒRust ç”±ä¸€ä¸ªæ ¸å¿ƒå›¢é˜Ÿç®¡ç†ï¼Œä¸ºé¡¹ç›®è®¾å®šæ„¿æ™¯å’Œä¼˜å…ˆçº§ã€‚ä»å…¨çƒè§’åº¦æ¥æŒ‡å¯¼å®ƒã€‚è¿˜æœ‰ä¸€äº›å­å›¢é˜Ÿæ¥æŒ‡å¯¼å’Œä¿ƒè¿›ç‰¹å®šå…´è¶£é¢†åŸŸçš„å‘å±•ï¼ŒåŒ…æ‹¬æ ¸å¿ƒè¯­è¨€ã€ç¼–è¯‘å™¨ã€Rust åº“ã€Rust å·¥å…·å’Œ Rust å®˜æ–¹ç¤¾åŒºçš„ç®¡ç†ã€‚è¿™äº›é¢†åŸŸçš„è®¾è®¡éƒ½æ˜¯é€šè¿‡[RFC]ï¼ˆ<a href="https://github.com/rust-lang/rfcs%EF%BC%89%E6%9D%A5%E6%8E%A8%E8%BF%9B%E7%9A%84%E3%80%82%E5%AF%B9%E4%BA%8E%E4%B8%8D%E9%9C%80%E8%A6%81">https://github.com/rust-lang/rfcsï¼‰æ¥æ¨è¿›çš„ã€‚å¯¹äºä¸éœ€è¦</a> RFC çš„å˜åŒ–ï¼Œé€šè¿‡<a href="https://github.com/rust-lang/rust"><code>rustc</code>ä»“åº“</a>çš„ PR æ¥å†³å®šã€‚</p><h2 id="Rustçš„ä¸€äº›éç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#Rustçš„ä¸€äº›éç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="Rustçš„ä¸€äº›éç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ"></a>Rustçš„ä¸€äº›éç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ</h2><ol><li>æˆ‘ä»¬ä¸é‡‡ç”¨ä»»ä½•ç‰¹åˆ«å‰æ²¿çš„æŠ€æœ¯ã€‚æ—§çš„ã€æˆç†Ÿçš„æŠ€æœ¯ä¼šæ›´å¥½ã€‚</li><li>æˆ‘ä»¬å¹¶ä¸æŠŠè¡¨ç°åŠ›ã€æç®€ä¸»ä¹‰æˆ–ä¼˜é›…æ€§ç½®äºå…¶ä»–ç›®æ ‡ä¹‹ä¸Šã€‚è¿™äº›éƒ½æ˜¯å¯å–çš„ï¼Œä½†æ˜¯ä»å±çš„ç›®æ ‡ã€‚</li><li>æˆ‘ä»¬ä¸æ‰“ç®—æ¶µç›– C++ æˆ–ä»»ä½•å…¶ä»–è¯­è¨€çš„å®Œæ•´åŠŸèƒ½é›†ã€‚Rust åº”è¯¥æä¾›å¤§å¤šæ•°æƒ…å†µä¸‹çš„åŠŸèƒ½ã€‚</li><li>æˆ‘ä»¬ä¸æ‰“ç®—åšåˆ° 100% çš„é™æ€ï¼Œ100% çš„å®‰å…¨ï¼Œ100% çš„åå°„ï¼Œæˆ–åœ¨ä»»ä½•å…¶ä»–æ„ä¹‰ä¸Šè¿‡äºæ•™æ¡åŒ–ã€‚å­˜åœ¨æƒè¡¡ã€‚</li><li>æˆ‘ä»¬ä¸è¦æ±‚ Rust åœ¨â€œæ‰€æœ‰å¯èƒ½çš„å¹³å°â€ä¸Šè¿è¡Œã€‚å®ƒæœ€ç»ˆå¿…é¡»åœ¨å¹¿æ³›ä½¿ç”¨çš„ç¡¬ä»¶å’Œè½¯ä»¶å¹³å°ä¸Šæ²¡æœ‰ä¸å¿…è¦çš„å¦¥ååœ°è¿è¡Œã€‚</li></ol><h2 id="Mozilla-åœ¨å“ªäº›é¡¹ç›®ä¸­ä½¿ç”¨-Rustï¼Ÿ"><a href="#Mozilla-åœ¨å“ªäº›é¡¹ç›®ä¸­ä½¿ç”¨-Rustï¼Ÿ" class="headerlink" title="Mozilla åœ¨å“ªäº›é¡¹ç›®ä¸­ä½¿ç”¨ Rustï¼Ÿ"></a>Mozilla åœ¨å“ªäº›é¡¹ç›®ä¸­ä½¿ç”¨ Rustï¼Ÿ</h2><p>ä¸»è¦çš„é¡¹ç›®æ˜¯<a href="https://github.com/servo/servo">Servo</a>ï¼Œè¿™æ˜¯ Mozilla æ­£åœ¨è¿›è¡Œçš„å®éªŒæ€§æµè§ˆå™¨å¼•æ“ã€‚ä»–ä»¬ä¹Ÿåœ¨åŠªåŠ›å°†<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1135640">Rust ç»„ä»¶</a>æ•´åˆåˆ° Firefox ä¸­ã€‚</p><h2 id="æœ‰å“ªäº›å¤§å‹-Rust-é¡¹ç›®çš„ä¾‹å­ï¼Ÿ"><a href="#æœ‰å“ªäº›å¤§å‹-Rust-é¡¹ç›®çš„ä¾‹å­ï¼Ÿ" class="headerlink" title="æœ‰å“ªäº›å¤§å‹ Rust é¡¹ç›®çš„ä¾‹å­ï¼Ÿ"></a>æœ‰å“ªäº›å¤§å‹ Rust é¡¹ç›®çš„ä¾‹å­ï¼Ÿ</h2><p>ç°åœ¨æœ€å¤§çš„ä¸¤ä¸ª Rust å¼€æºé¡¹ç›®æ˜¯<a href="https://github.com/servo/servo">Servo</a>å’Œ<a href="https://github.com/rust-lang/rust">Rust ç¼–è¯‘å™¨</a>æœ¬èº«ã€‚</p><h2 id="è¿˜æœ‰è°åœ¨ä½¿ç”¨-Rustï¼Ÿ"><a href="#è¿˜æœ‰è°åœ¨ä½¿ç”¨-Rustï¼Ÿ" class="headerlink" title="è¿˜æœ‰è°åœ¨ä½¿ç”¨ Rustï¼Ÿ"></a>è¿˜æœ‰è°åœ¨ä½¿ç”¨ Rustï¼Ÿ</h2><p><a href="https://www.rust-lang.org/production/users">è¶Šæ¥è¶Šå¤šçš„ç»„ç»‡ï¼</a></p><h2 id="æˆ‘æ€æ ·æ‰èƒ½è½»æ¾åœ°å°è¯•-Rustï¼Ÿ"><a href="#æˆ‘æ€æ ·æ‰èƒ½è½»æ¾åœ°å°è¯•-Rustï¼Ÿ" class="headerlink" title="æˆ‘æ€æ ·æ‰èƒ½è½»æ¾åœ°å°è¯• Rustï¼Ÿ"></a>æˆ‘æ€æ ·æ‰èƒ½è½»æ¾åœ°å°è¯• Rustï¼Ÿ</h2><p>å°è¯•Rustçš„æœ€ç®€å•æ–¹æ³•æ˜¯é€šè¿‡<a href="https://play.rust-lang.org/">playpen</a>ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºç¼–å†™å’Œè¿è¡Œ Rust ä»£ç çš„åœ¨çº¿åº”ç”¨ç¨‹åºã€‚å¦‚æœä½ æƒ³åœ¨ä½ çš„ç³»ç»Ÿä¸Šå°è¯• Rustï¼Œ<a href="https://www.rust-lang.org/tools/install">å®‰è£…å®ƒ</a>å¹¶é€šè¿‡ä¹¦ä¸­çš„<a href="https://doc.rust-lang.org/book/ch02-00-guessing-game-tutorial.html">çŒœè°œæ¸¸æˆ</a>æ•™ç¨‹ã€‚</p><h2 id="æˆ‘æ€æ ·æ‰èƒ½å¾—åˆ°-Rust-é—®é¢˜çš„å¸®åŠ©ï¼Ÿ"><a href="#æˆ‘æ€æ ·æ‰èƒ½å¾—åˆ°-Rust-é—®é¢˜çš„å¸®åŠ©ï¼Ÿ" class="headerlink" title="æˆ‘æ€æ ·æ‰èƒ½å¾—åˆ° Rust é—®é¢˜çš„å¸®åŠ©ï¼Ÿ"></a>æˆ‘æ€æ ·æ‰èƒ½å¾—åˆ° Rust é—®é¢˜çš„å¸®åŠ©ï¼Ÿ</h2><p>æœ‰å‡ ç§æ–¹æ³•ã€‚ä½ å¯ä»¥ã€‚</p><ul><li>åœ¨<a href="https://users.rust-lang.org/">users.rust-lang.org</a>ï¼Œå³ Rust å®˜æ–¹ç”¨æˆ·è®ºå›ä¸Šå‘å¸–</li><li>åœ¨å®˜æ–¹çš„<a href="https://chat.mibbit.com/?server=irc.mozilla.org&channel=%23rust">Rust IRC channel</a> (#rust on irc.mozilla.org)ä¸­æé—®ã€‚</li><li>åœ¨<a href="https://stackoverflow.com/questions/tagged/rust">Stack Overflow</a>ä¸Šç”¨â€œrustâ€æ ‡ç­¾æé—®ã€‚</li><li>åœ¨<a href="https://www.reddit.com/r/rust">/r/rust</a>ï¼Œéå®˜æ–¹çš„ Rust å­è®ºå›ä¸Šå‘å¸–</li></ul><h2 id="ä¸ºä»€ä¹ˆ-Rust-éšç€æ—¶é—´çš„æ¨ç§»å‘ç”Ÿäº†å¦‚æ­¤å¤§çš„å˜åŒ–ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆ-Rust-éšç€æ—¶é—´çš„æ¨ç§»å‘ç”Ÿäº†å¦‚æ­¤å¤§çš„å˜åŒ–ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆ Rust éšç€æ—¶é—´çš„æ¨ç§»å‘ç”Ÿäº†å¦‚æ­¤å¤§çš„å˜åŒ–ï¼Ÿ"></a>ä¸ºä»€ä¹ˆ Rust éšç€æ—¶é—´çš„æ¨ç§»å‘ç”Ÿäº†å¦‚æ­¤å¤§çš„å˜åŒ–ï¼Ÿ</h2><p>Rust æœ€åˆçš„ç›®æ ‡æ˜¯åˆ›é€ ä¸€ç§å®‰å…¨ä½†å¯ç”¨çš„ç³»ç»Ÿç¼–ç¨‹è¯­è¨€ã€‚åœ¨è¿½æ±‚è¿™ä¸€ç›®æ ‡çš„è¿‡ç¨‹ä¸­ï¼Œå®ƒæ¢ç´¢äº†å¾ˆå¤šæƒ³æ³•ï¼Œå…¶ä¸­ä¸€äº›è¢«ä¿ç•™äº†ä¸‹æ¥ï¼ˆç”Ÿå‘½å‘¨æœŸï¼ŒTraitï¼‰ï¼Œè€Œå¦ä¸€äº›åˆ™è¢«æŠ›å¼ƒäº†ï¼ˆç±»å‹çŠ¶æ€ç³»ç»Ÿï¼Œç»¿è‰²çº¿ç¨‹ï¼‰ã€‚å¦å¤–ï¼Œåœ¨ 1.0 ä¹‹å‰ï¼Œå¾ˆå¤šæ ‡å‡†åº“éƒ½è¢«é‡å†™äº†ï¼Œå› ä¸ºæ—©æœŸçš„è®¾è®¡è¢«æ›´æ–°ä»¥æœ€å¥½åœ°ä½¿ç”¨ Rust çš„ç‰¹æ€§ï¼Œå¹¶æä¾›é«˜è´¨é‡çš„ã€ä¸€è‡´çš„è·¨å¹³å° APIã€‚ç°åœ¨ Rust å·²ç»è¾¾åˆ°äº† 1.0ï¼Œè¯¥è¯­è¨€è¢«ä¿è¯æ˜¯â€œç¨³å®šçš„â€ï¼›è™½ç„¶å®ƒå¯èƒ½ç»§ç»­å‘å±•ï¼Œä½†åœ¨å½“å‰ Rust ä¸Šè¿è¡Œçš„ä»£ç åº”è¯¥ç»§ç»­åœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸Šè¿è¡Œã€‚</p><h2 id="Rustè¯­è¨€çš„ç‰ˆæœ¬ç®¡ç†æ˜¯å¦‚ä½•è¿›è¡Œçš„ï¼Ÿ"><a href="#Rustè¯­è¨€çš„ç‰ˆæœ¬ç®¡ç†æ˜¯å¦‚ä½•è¿›è¡Œçš„ï¼Ÿ" class="headerlink" title="Rustè¯­è¨€çš„ç‰ˆæœ¬ç®¡ç†æ˜¯å¦‚ä½•è¿›è¡Œçš„ï¼Ÿ"></a>Rustè¯­è¨€çš„ç‰ˆæœ¬ç®¡ç†æ˜¯å¦‚ä½•è¿›è¡Œçš„ï¼Ÿ</h2><p>Rust çš„è¯­è¨€ç‰ˆæœ¬ç®¡ç†éµå¾ª<a href="http://semver.org/">SemVer</a>ï¼Œåªæœ‰å½“éœ€è¦è¿›è¡Œç¼–è¯‘å™¨é”™è¯¯çš„ä¿®å¤ã€å®‰å…¨æ¼æ´çš„ä¿®è¡¥æˆ–è€…éœ€è¦æ›´å¤šæ³¨é‡Šä»¥æ”¹å˜ç±»å‹æ¨æ–­å’Œåˆ†å‘çš„æ—¶å€™ï¼Œæ‰å…è®¸åœ¨å°ç‰ˆæœ¬ä¸­å¯¹ç¨³å®šçš„ API è¿›è¡Œå‘åä¸å…¼å®¹çš„ä¿®æ”¹ã€‚æ›´è¯¦ç»†çš„å°ç‰ˆæœ¬ä¿®æ”¹æŒ‡å—å¯å‚è€ƒ<a href="https://github.com/rust-lang/rfcs/blob/master/text/1122-language-semver.md">è¯­è¨€</a>å’Œ<a href="https://github.com/rust-lang/rfcs/blob/master/text/1105-api-evolution.md">æ ‡å‡†åº“</a>çš„ RFCã€‚</p><p>Rust æœ‰ä¸‰ä¸ªâ€œå‘å¸ƒ channelâ€ï¼šç¨³å®šç‰ˆã€æµ‹è¯•ç‰ˆå’Œ nightly ç‰ˆã€‚ç¨³å®šç‰ˆå’Œæµ‹è¯•ç‰ˆæ¯å…­å‘¨æ›´æ–°ä¸€æ¬¡ï¼Œå½“å‰çš„ nightly ç‰ˆæˆä¸ºæ–°çš„æµ‹è¯•ç‰ˆï¼Œè€Œå½“å‰çš„ nightly ç‰ˆæˆä¸ºæ–°çš„ç¨³å®šç‰ˆã€‚æ ‡è®°ä¸ºä¸ç¨³å®šçš„è¯­è¨€å’Œæ ‡å‡†åº“åŠŸèƒ½æˆ–éšè—åœ¨ç‰¹æ€§å¼€å…³åé¢çš„åŠŸèƒ½åªèƒ½åœ¨ nightly ä¸­ä½¿ç”¨ã€‚æ–°åŠŸèƒ½ä»¥ä¸ç¨³å®šçš„å½¢å¼å‡ºç°ï¼Œä¸€æ—¦è¢«æ ¸å¿ƒå›¢é˜Ÿå’Œç›¸å…³çš„å­å›¢é˜Ÿæ‰¹å‡†ï¼Œå°±ä¼šè¢«â€œè§£ç¦â€ã€‚è¿™ç§æ–¹æ³•å…è®¸å®éªŒï¼ŒåŒæ—¶ä¸ºç¨³å®šé¢‘é“æä¾›å¼ºå¤§çš„å‘åå…¼å®¹æ€§ä¿è¯ã€‚</p><p>æ›´å¤šçš„ç»†èŠ‚ï¼Œè¯·é˜…è¯» Rust çš„åšæ–‡<a href="http://blog.rust-lang.org/2014/10/30/Stability.html">â€œStability as a Deliverableâ€</a>ã€‚</p><h2 id="æˆ‘å¯ä»¥åœ¨æµ‹è¯•ç‰ˆæˆ–ç¨³å®šç‰ˆé¢‘é“ä¸Šä½¿ç”¨ä¸ç¨³å®šçš„åŠŸèƒ½å—ï¼Ÿ"><a href="#æˆ‘å¯ä»¥åœ¨æµ‹è¯•ç‰ˆæˆ–ç¨³å®šç‰ˆé¢‘é“ä¸Šä½¿ç”¨ä¸ç¨³å®šçš„åŠŸèƒ½å—ï¼Ÿ" class="headerlink" title="æˆ‘å¯ä»¥åœ¨æµ‹è¯•ç‰ˆæˆ–ç¨³å®šç‰ˆé¢‘é“ä¸Šä½¿ç”¨ä¸ç¨³å®šçš„åŠŸèƒ½å—ï¼Ÿ"></a>æˆ‘å¯ä»¥åœ¨æµ‹è¯•ç‰ˆæˆ–ç¨³å®šç‰ˆé¢‘é“ä¸Šä½¿ç”¨ä¸ç¨³å®šçš„åŠŸèƒ½å—ï¼Ÿ</h2><p>ä¸ï¼Œä½ ä¸èƒ½ã€‚Rust åŠªåŠ›ä¸ºæµ‹è¯•ç‰ˆå’Œç¨³å®šç‰ˆé¢‘é“ä¸Šæä¾›çš„åŠŸèƒ½çš„ç¨³å®šæ€§æä¾›å¼ºæœ‰åŠ›çš„ä¿è¯ã€‚å½“æŸé¡¹åŠŸèƒ½ä¸ç¨³å®šæ—¶ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬è¿˜ä¸èƒ½ä¸ºå®ƒæä¾›è¿™äº›ä¿è¯ï¼Œå¹¶ä¸”ä¸å¸Œæœ›äººä»¬ä¾èµ–å®ƒä¿æŒä¸å˜ã€‚è¿™ä½¿æˆ‘ä»¬æœ‰æœºä¼šåœ¨ nightly ä¸Šå°è¯•æ”¹å˜ï¼ŒåŒæ—¶ä»ç„¶ä¸ºå¯»æ±‚ç¨³å®šçš„äººä¿æŒå¼ºæœ‰åŠ›çš„ä¿è¯ã€‚</p><p>äº‹æƒ…ä¸€ç›´åœ¨å˜ç¨³å®šï¼Œæµ‹è¯•ç‰ˆå’Œç¨³å®šç‰ˆé¢‘é“æ¯å…­å‘¨æ›´æ–°ä¸€æ¬¡ï¼Œå…¶ä»–æ—¶å€™å¶å°”ä¹Ÿä¼šæ¥å—æµ‹è¯•ç‰ˆçš„ä¿®å¤ã€‚å¦‚æœä½ åœ¨ç­‰å¾…ä¸€ä¸ªåŠŸèƒ½ï¼Œè€Œä¸ä½¿ç”¨ nightlyï¼Œä½ å¯ä»¥é€šè¿‡æ£€æŸ¥é—®é¢˜è¿½è¸ªå™¨ä¸Šçš„<a href="https://github.com/rust-lang/rust/issues?q=is:issue+is:open+tracking+label:B-unstable"><code>B-unstable</code></a>æ ‡ç­¾æ¥å®šä½å…¶è¿½è¸ªé—®é¢˜ã€‚</p><h2 id="ä»€ä¹ˆæ˜¯â€œç‰¹æ€§å¼€å…³â€"><a href="#ä»€ä¹ˆæ˜¯â€œç‰¹æ€§å¼€å…³â€" class="headerlink" title="ä»€ä¹ˆæ˜¯â€œç‰¹æ€§å¼€å…³â€?"></a>ä»€ä¹ˆæ˜¯â€œç‰¹æ€§å¼€å…³â€?</h2><p>â€œç‰¹æ€§å¼€å…³â€æ˜¯ Rust ç”¨æ¥ç¨³å®šç¼–è¯‘å™¨ã€è¯­è¨€å’Œæ ‡å‡†åº“çš„ç‰¹æ€§çš„æœºåˆ¶ã€‚ä¸€ä¸ªè¢«â€œå¼€å…³æ§åˆ¶â€çš„ç‰¹æ€§åªæœ‰åœ¨ nightly ä¸Šæ‰èƒ½è®¿é—®ï¼Œè€Œä¸”åªæœ‰åœ¨é€šè¿‡<code>#[feature]</code>å±æ€§æˆ–<code>-Z unstable-options</code>å‘½ä»¤è¡Œå‚æ•°æ˜ç¡®å¯ç”¨åæ‰èƒ½è®¿é—®ã€‚å½“ä¸€ä¸ªç‰¹æ€§è¢«ç¨³å®šåŒ–åï¼Œå®ƒå°±å¯ä»¥åœ¨ç¨³å®šå‘å¸ƒé€šé“ä¸Šä½¿ç”¨ï¼Œå¹¶ä¸”ä¸éœ€è¦æ˜ç¡®å¯ç”¨ï¼Œè¿™æ—¶å€™è¿™ä¸ªç‰¹æ€§å°±è¢«è®¤ä¸ºæ˜¯ç¨³å®šçš„ã€‚ç‰¹æ€§å¼€å…³å…è®¸å¼€å‘è€…åœ¨å¼€å‘ä¸­çš„å®éªŒæ€§åŠŸèƒ½åœ¨å®ƒä»¬åœ¨ç¨³å®šè¯­è¨€ä¸­å¯ç”¨ä¹‹å‰è¿›è¡Œæµ‹è¯•ã€‚</p><h2 id="ä¸ºä»€ä¹ˆè¦é‡‡ç”¨-MIT-ASL2-åŒè®¸å¯è¯ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦é‡‡ç”¨-MIT-ASL2-åŒè®¸å¯è¯ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦é‡‡ç”¨ MIT/ASL2 åŒè®¸å¯è¯ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦é‡‡ç”¨ MIT/ASL2 åŒè®¸å¯è¯ï¼Ÿ</h2><p>Apache è®¸å¯è¯åŒ…æ‹¬å¯¹ä¸“åˆ©ä¾µçŠ¯çš„é‡è¦ä¿æŠ¤ï¼Œä½†å®ƒä¸ GPL ç¬¬ 2 ç‰ˆä¸å…¼å®¹ã€‚ä¸ºäº†é¿å… Rust ä¸ GPL2 çš„ä½¿ç”¨å‡ºç°é—®é¢˜ï¼ŒRust é‡‡ç”¨äº† MIT è®¸å¯ã€‚</p><h2 id="ä¸ºä»€ä¹ˆæ˜¯-BSD-é£æ ¼çš„è®¸å¯ï¼Œè€Œä¸æ˜¯-MPL-æˆ–ä¸‰åˆä¸€è®¸å¯ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆæ˜¯-BSD-é£æ ¼çš„è®¸å¯ï¼Œè€Œä¸æ˜¯-MPL-æˆ–ä¸‰åˆä¸€è®¸å¯ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆæ˜¯ BSD é£æ ¼çš„è®¸å¯ï¼Œè€Œä¸æ˜¯ MPL æˆ–ä¸‰åˆä¸€è®¸å¯ï¼Ÿ"></a>ä¸ºä»€ä¹ˆæ˜¯ BSD é£æ ¼çš„è®¸å¯ï¼Œè€Œä¸æ˜¯ MPL æˆ–ä¸‰åˆä¸€è®¸å¯ï¼Ÿ</h2><p>è¿™ä¸€æ–¹é¢æ˜¯ç”±äºåŸå§‹å¼€å‘è€…ï¼ˆGraydonï¼‰çš„åå¥½ï¼Œå¦ä¸€æ–¹é¢æ˜¯ç”±äºè¯­è¨€å¾€å¾€æ¯”ç½‘ç»œæµè§ˆå™¨ç­‰äº§å“æœ‰æ›´å¹¿æ³›çš„å—ä¼—å’Œæ›´å¤šæ ·åŒ–çš„å¯èƒ½åµŒå…¥å’Œæœ€ç»ˆç”¨é€”ã€‚æˆ‘ä»¬å¸Œæœ›å°½å¯èƒ½å¤šåœ°å¸å¼•è¿™äº›æ½œåœ¨çš„è´¡çŒ®è€…ã€‚</p><h1 id="æ€§èƒ½"><a href="#æ€§èƒ½" class="headerlink" title="æ€§èƒ½"></a>æ€§èƒ½</h1><h2 id="Rustæœ‰å¤šå¿«ï¼Ÿ"><a href="#Rustæœ‰å¤šå¿«ï¼Ÿ" class="headerlink" title="Rustæœ‰å¤šå¿«ï¼Ÿ"></a>Rustæœ‰å¤šå¿«ï¼Ÿ</h2><p>éå¸¸å¿«! åœ¨è®¸å¤šåŸºå‡†æµ‹è¯•ä¸­ï¼ŒRust å·²ç»å¯ä»¥ä¸ C å’Œ C++ ç«äº‰ï¼ˆæ¯”å¦‚<a href="https://benchmarksgame-team.pages.debian.net/benchmarksgame/fastest/rust.html">åŸºå‡†æ¸¸æˆ</a>å’Œ<a href="https://github.com/kostya/benchmarks">å…¶ä»–</a>ï¼‰ã€‚</p><p>åƒ C++ ä¸€æ ·ï¼ŒRust æŠŠ<a href="http://blog.rust-lang.org/2015/05/11/traits.html">é›¶æˆæœ¬æŠ½è±¡</a>ä½œä¸ºå®ƒçš„æ ¸å¿ƒåŸåˆ™ä¹‹ä¸€ï¼šRust çš„æŠ½è±¡æ²¡æœ‰ä¸€ä¸ªæ–½åŠ å…¨å±€æ€§èƒ½æƒ©ç½šï¼Œä¹Ÿæ²¡æœ‰ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ä»»ä½•è¿è¡Œæ—¶ç³»ç»Ÿçš„å¼€é”€ã€‚</p><p>é‰´äº Rust æ˜¯å»ºç«‹åœ¨ LLVM ä¹‹ä¸Šçš„ï¼Œå¹¶åŠªåŠ›ä» LLVM çš„è§’åº¦ç±»ä¼¼äº Clangï¼Œä»»ä½• LLVM çš„æ€§èƒ½æ”¹è¿›ä¹Ÿæœ‰åŠ©äº Rustã€‚ä»é•¿è¿œæ¥çœ‹ï¼ŒRust çš„ç±»å‹ç³»ç»Ÿä¸­æ›´ä¸°å¯Œçš„ä¿¡æ¯ä¹Ÿåº”è¯¥èƒ½å¤Ÿå®ç° C/C++ ä»£ç éš¾ä»¥å®ç°æˆ–æ— æ³•å®ç°çš„ä¼˜åŒ–ã€‚</p><h2 id="Rust-æœ‰åƒåœ¾æ”¶é›†å—ï¼Ÿ"><a href="#Rust-æœ‰åƒåœ¾æ”¶é›†å—ï¼Ÿ" class="headerlink" title="Rust æœ‰åƒåœ¾æ”¶é›†å—ï¼Ÿ"></a>Rust æœ‰åƒåœ¾æ”¶é›†å—ï¼Ÿ</h2><p>ä¸ï¼ŒRust çš„å…³é”®åˆ›æ–°ä¹‹ä¸€æ˜¯åœ¨<em>ä¸éœ€è¦</em>åƒåœ¾æ”¶é›†çš„åŒæ—¶ä¿è¯å†…å­˜å®‰å…¨ï¼ˆæ—  segfaultï¼‰ã€‚</p><p>é€šè¿‡é¿å… GCï¼ŒRust å¯ä»¥æä¾›è®¸å¤šå¥½å¤„ï¼šå¯é¢„æµ‹çš„èµ„æºæ¸…ç†ï¼Œè¾ƒä½çš„å†…å­˜ç®¡ç†å¼€é”€ï¼Œä»¥åŠåŸºæœ¬ä¸Šæ²¡æœ‰è¿è¡Œæ—¶ç³»ç»Ÿã€‚æ‰€æœ‰è¿™äº›ç‰¹å¾éƒ½ä½¿ Rust å˜å¾—ç²¾å¹²ï¼Œå¹¶ä¸”å®¹æ˜“åµŒå…¥åˆ°ä»»æ„çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå¹¶ä½¿å…¶æ›´å®¹æ˜“<a href="http://calculist.org/blog/2015/12/23/neon-node-rust/">å°† Rust ä»£ç ä¸æœ‰ GC çš„è¯­è¨€é›†æˆ</a>ã€‚</p><p>Rust é€šè¿‡å…¶æ‰€æœ‰æƒå’Œå€Ÿç”¨ç³»ç»Ÿé¿å…äº†å¯¹ GC çš„éœ€æ±‚ï¼Œä½†åŒæ ·çš„ç³»ç»Ÿä¹Ÿæœ‰åŠ©äºè§£å†³ä¸€ç³»åˆ—å…¶ä»–é—®é¢˜ï¼ŒåŒ…æ‹¬<br><a href="http://blog.skylight.io/rust-means-never-having-to-close-a-socket/">ä¸€èˆ¬çš„èµ„æºç®¡ç†</a>å’Œ<a href="http://blog.rust-lang.org/2015/04/10/Fearless-Concurrency.html">å¹¶å‘æ€§</a>ã€‚</p><p>å½“å•ä¸€æ‰€æœ‰æƒä¸å¤Ÿç”¨æ—¶ï¼ŒRust ç¨‹åºä¾é æ ‡å‡†çš„å¼•ç”¨è®¡æ•°æ™ºèƒ½æŒ‡é’ˆç±»å‹<a href="https://doc.rust-lang.org/std/rc/struct.Rc.html"><code>Rc</code></a>ï¼Œä»¥åŠå®ƒçš„çº¿ç¨‹å®‰å…¨å¯¹åº”ç±»å‹<a href="https://doc.rust-lang.org/std/sync/struct.Arc.html"><code>Arc</code></a>ï¼Œè€Œä¸æ˜¯ GCã€‚</p><p>ç„¶è€Œï¼Œæˆ‘ä»¬æ­£åœ¨ç ”ç©¶<em>å¯é€‰çš„</em>åƒåœ¾æ”¶é›†ä½œä¸ºæœªæ¥çš„æ‰©å±•ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ä½¿å…¶èƒ½å¤Ÿé¡ºåˆ©åœ°ä¸åƒåœ¾æ”¶é›†çš„è¿è¡Œæ—¶ï¼Œä¾‹å¦‚é‚£äº›ç”±<a href="https://spidermonkey.dev/">Spidermonkey</a>å’Œ<a href="https://developers.google.com/v8/?hl=en">V8</a>çš„ JavaScript å¼•æ“æä¾›çš„ã€‚æœ€åï¼Œä¸€äº›äººå·²ç»åœ¨æ²¡æœ‰ç¼–è¯‘å™¨çš„æ”¯æŒæƒ…å†µä¸‹ç ”ç©¶äº†å®ç°<a href="https://manishearth.github.io/blog/2015/09/01/designing-a-gc-in-rust/">çº¯ Rust åƒåœ¾æ”¶é›†å™¨</a>ã€‚</p><h2 id="ä¸ºä»€ä¹ˆæˆ‘çš„ç¨‹åºå¾ˆæ…¢ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆæˆ‘çš„ç¨‹åºå¾ˆæ…¢ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆæˆ‘çš„ç¨‹åºå¾ˆæ…¢ï¼Ÿ"></a>ä¸ºä»€ä¹ˆæˆ‘çš„ç¨‹åºå¾ˆæ…¢ï¼Ÿ</h2><p>Rust ç¼–è¯‘å™¨ä¸ä¼šç”¨ä¼˜åŒ–æ¥ç¼–è¯‘ï¼Œé™¤éè¢«è¦æ±‚è¿™æ ·åšï¼Œ<a href="https://users.rust-lang.org/t/why-does-cargo-build-not-optimise-by-default/4150/3">å› ä¸ºä¼˜åŒ–ä¼šé™ä½ç¼–è¯‘é€Ÿåº¦ï¼Œè€Œä¸”åœ¨å¼€å‘è¿‡ç¨‹ä¸­é€šå¸¸æ˜¯ä¸å¯å–çš„</a>ã€‚</p><p>å¦‚æœä½ ç”¨<code>cargo</code>ç¼–è¯‘ï¼Œè¯·ä½¿ç”¨<code>--release</code>æ ‡å¿—ã€‚å¦‚æœä½ ç›´æ¥ç”¨<code>rustc</code>ç¼–è¯‘ï¼Œä½¿ç”¨<code>-O</code>æ ‡å¿—ã€‚è¿™ä¸¤ä¸ªæ ‡å¿—ä¸­çš„ä»»ä½•ä¸€ä¸ªéƒ½ä¼šæ‰“å¼€ä¼˜åŒ–åŠŸèƒ½ã€‚</p><h2 id="Rustçš„ç¼–è¯‘ä¼¼ä¹å¾ˆæ…¢ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ"><a href="#Rustçš„ç¼–è¯‘ä¼¼ä¹å¾ˆæ…¢ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ" class="headerlink" title="Rustçš„ç¼–è¯‘ä¼¼ä¹å¾ˆæ…¢ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ"></a>Rustçš„ç¼–è¯‘ä¼¼ä¹å¾ˆæ…¢ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</h2><p>ä»£ç ç¿»è¯‘å’Œä¼˜åŒ–ã€‚Rust æä¾›äº†é«˜æ°´å¹³çš„æŠ½è±¡ï¼Œå¯ä»¥ç¼–è¯‘æˆé«˜æ•ˆçš„æœºå™¨ä»£ç ï¼Œè¿™äº›ç¿»è¯‘éœ€è¦æ—¶é—´æ¥è¿è¡Œï¼Œç‰¹åˆ«æ˜¯åœ¨ä¼˜åŒ–æ—¶ã€‚</p><p>ä½†æ˜¯ Rust çš„ç¼–è¯‘æ—¶é—´å¹¶ä¸åƒçœ‹èµ·æ¥é‚£ä¹ˆç³Ÿç³•ï¼Œè€Œä¸”æœ‰ç†ç”±ç›¸ä¿¡å®ƒä¼šæœ‰æ‰€æ”¹å–„ã€‚å½“æ¯”è¾ƒ C++ å’Œ Rust ä¹‹é—´ç±»ä¼¼è§„æ¨¡çš„é¡¹ç›®æ—¶ï¼Œä¸€èˆ¬è®¤ä¸ºæ•´ä¸ªé¡¹ç›®çš„ç¼–è¯‘æ—¶é—´æ˜¯ç›¸å½“çš„ã€‚äººä»¬æ™®éè®¤ä¸º Rust çš„ç¼–è¯‘é€Ÿåº¦å¾ˆæ…¢ï¼Œè¿™åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ç”±äº C++ å’Œ Rust çš„<em>ç¼–è¯‘æ¨¡å‹</em>çš„ä¸åŒã€‚C++ çš„ç¼–è¯‘å•å…ƒæ˜¯æ–‡ä»¶ï¼Œè€Œ Rust çš„ç¼–è¯‘å•å…ƒæ˜¯ç”±è®¸å¤šæ–‡ä»¶ç»„æˆçš„ crateã€‚å› æ­¤ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¿®æ”¹ä¸€ä¸ª C++ æ–‡ä»¶å¯èƒ½ä¼šå¯¼è‡´æ¯” Rust å°‘å¾—å¤šçš„é‡æ–°ç¼–è¯‘ã€‚ç›®å‰æ­£åœ¨åŠªåŠ›é‡æ„ç¼–è¯‘å™¨ä»¥å¼•å…¥<a href="https://github.com/rust-lang/rfcs/blob/master/text/1298-incremental-compilation.md">å¢é‡ç¼–è¯‘</a>ï¼Œè¿™å°†ä¸º Rust æä¾› C++ æ¨¡å‹çš„ç¼–è¯‘æ—¶é—´ä¼˜åŠ¿ã€‚</p><p>é™¤äº†ç¼–è¯‘æ¨¡å‹ä¹‹å¤–ï¼ŒRust çš„è¯­è¨€è®¾è®¡å’Œç¼–è¯‘å™¨å®ç°è¿˜æœ‰å…¶ä»–å‡ ä¸ªæ–¹é¢ä¼šå½±å“ç¼–è¯‘æ—¶çš„æ€§èƒ½ã€‚</p><p>é¦–å…ˆï¼ŒRust æœ‰ä¸€ä¸ªé€‚åº¦å¤æ‚çš„ç±»å‹ç³»ç»Ÿï¼Œå¿…é¡»èŠ±è´¹ä¸å¯å¿½è§†çš„ç¼–è¯‘æ—¶é—´æ¥æ‰§è¡Œçº¦æŸï¼Œä½¿ Rust åœ¨è¿è¡Œæ—¶å®‰å…¨ã€‚</p><p>å…¶æ¬¡ï¼ŒRust ç¼–è¯‘å™¨æœ‰é•¿æœŸçš„æŠ€æœ¯å€ºåŠ¡ï¼Œç‰¹åˆ«æ˜¯äº§ç”Ÿäº†è´¨é‡å¾ˆå·®çš„ LLVM IRï¼ŒLLVM å¿…é¡»èŠ±æ—¶é—´â€œä¿®å¤â€ã€‚åœ¨ Rust ç¼–è¯‘å™¨ä¸­åŠ å…¥ä¸€ä¸ªæ–°çš„å†…éƒ¨è¡¨ç¤ºæ³•ï¼Œç§°ä¸º<a href="https://github.com/rust-lang/rfcs/blob/master/text/1211-mir.md">MIR</a>ï¼Œæœ‰å¯èƒ½è¿›è¡Œæ›´å¤šçš„ä¼˜åŒ–ï¼Œæé«˜ç”Ÿæˆçš„ LLVM IR çš„è´¨é‡ï¼Œä½†è¿™é¡¹å·¥ä½œè¿˜æ²¡æœ‰å‘ç”Ÿè¿‡ã€‚</p><p>ç¬¬ä¸‰ï¼ŒRust ä½¿ç”¨ LLVM æ¥ç”Ÿæˆä»£ç æ˜¯ä¸€æŠŠåŒåˆƒå‰‘ï¼šè™½ç„¶å®ƒä½¿ Rust æ‹¥æœ‰ä¸–ç•Œä¸€æµçš„è¿è¡Œæ—¶æ€§èƒ½ï¼Œä½† LLVM æ˜¯ä¸€ä¸ªå¤§å‹æ¡†æ¶ï¼Œä¸æ³¨é‡ç¼–è¯‘æ—¶çš„æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†è´¨é‡å·®çš„è¾“å…¥æ—¶ã€‚</p><p>æœ€åï¼Œè™½ç„¶ Rust çš„é¦–é€‰ç­–ç•¥æ˜¯å•æ€æ³›å‹ï¼ˆç±»ä¼¼äº C++ï¼‰ï¼Œä½†å®ƒè¦æ±‚ç”Ÿæˆçš„ä»£ç æ¯”å…¶ä»–ç¿»è¯‘ç­–ç•¥å¤šå¾—å¤šã€‚Rust çš„ç¨‹åºå‘˜å¯ä»¥ä½¿ç”¨ç‰¹å¾å¯¹è±¡ï¼Œé€šè¿‡ä½¿ç”¨åŠ¨æ€è°ƒåº¦æ¥æ¢å–è¿™ç§ä»£ç çš„è†¨èƒ€ã€‚</p><h2 id="ä¸ºä»€ä¹ˆ-Rust-çš„HashMapå¾ˆæ…¢ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆ-Rust-çš„HashMapå¾ˆæ…¢ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆ Rust çš„HashMapå¾ˆæ…¢ï¼Ÿ"></a>ä¸ºä»€ä¹ˆ Rust çš„<code>HashMap</code>å¾ˆæ…¢ï¼Ÿ</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒRust çš„<a href="https://doc.rust-lang.org/std/collections/struct.HashMap.html"><code>HashMap</code></a>ä½¿ç”¨ <a href="https://en.wikipedia.org/wiki/SipHash">SipHash</a> æ•£åˆ—ç®—æ³•ï¼Œè¯¥ç®—æ³•æ—¨åœ¨é˜²æ­¢<a href="http://programmingisterrible.com/post/40620375793/hash-table-denial-of-service-attacks-revisited">æ•£åˆ—è¡¨ç¢°æ’æ”»å‡»</a>ï¼ŒåŒæ—¶æä¾›<a href="https://www.reddit.com/r/rust/comments/3hw9zf/rust_hasher_comparisons/cub4oh6">å„ç§å·¥ä½œè´Ÿè½½ä¸‹çš„åˆç†æ€§èƒ½</a>ã€‚</p><p>è™½ç„¶ SipHash <a href="http://cglab.ca/%7Eabeinges/blah/hash-rs/">åœ¨è®¸å¤šæƒ…å†µä¸‹è¡¨ç°å‡ºæœ‰ç«äº‰åŠ›çš„æ€§èƒ½</a>ï¼Œä½†å®ƒæ¯”å…¶ä»–æ•£åˆ—ç®—æ³•æ˜æ˜¾æ…¢çš„ä¸€ç§æƒ…å†µæ˜¯åœ¨çŸ­é”®ï¼Œå¦‚æ•´æ•°ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Rust ç¨‹åºå‘˜ç»å¸¸è§‚å¯Ÿåˆ°<a href="https://doc.rust-lang.org/std/collections/struct.HashMap.html"><code>HashMap</code></a>çš„æ€§èƒ½ç¼“æ…¢ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç»å¸¸æ¨èä½¿ç”¨ <a href="https://crates.io/crates/fnv">FNV hasher</a>ï¼Œä½†è¦æ³¨æ„å®ƒä¸å…·å¤‡ä¸ SipHash ä¸€æ ·çš„æŠ—ç¢°æ’ç‰¹æ€§ã€‚</p><h2 id="ä¸ºä»€ä¹ˆæ²¡æœ‰é›†æˆçš„åŸºå‡†æµ‹è¯•åŸºç¡€è®¾æ–½"><a href="#ä¸ºä»€ä¹ˆæ²¡æœ‰é›†æˆçš„åŸºå‡†æµ‹è¯•åŸºç¡€è®¾æ–½" class="headerlink" title="ä¸ºä»€ä¹ˆæ²¡æœ‰é›†æˆçš„åŸºå‡†æµ‹è¯•åŸºç¡€è®¾æ–½?"></a>ä¸ºä»€ä¹ˆæ²¡æœ‰é›†æˆçš„åŸºå‡†æµ‹è¯•åŸºç¡€è®¾æ–½?</h2><p>æœ‰ï¼Œä½†å®ƒåªåœ¨ nightly ä¸Šå¯ç”¨ã€‚æˆ‘ä»¬æœ€ç»ˆè®¡åˆ’å»ºç«‹ä¸€ä¸ªå¯æ’æ‹”çš„ç³»ç»Ÿæ¥è¿›è¡Œç»¼åˆåŸºå‡†æµ‹è¯•ï¼Œä½†ä¸æ­¤åŒæ—¶ï¼Œç›®å‰çš„ç³»ç»Ÿ<a href="https://github.com/rust-lang/rust/issues/29553">è¢«è®¤ä¸ºæ˜¯ä¸ç¨³å®šçš„</a>ã€‚</p><h2 id="Rust-æ˜¯å¦åšäº†å°¾è°ƒç”¨ä¼˜åŒ–ï¼Ÿ"><a href="#Rust-æ˜¯å¦åšäº†å°¾è°ƒç”¨ä¼˜åŒ–ï¼Ÿ" class="headerlink" title="Rust æ˜¯å¦åšäº†å°¾è°ƒç”¨ä¼˜åŒ–ï¼Ÿ"></a>Rust æ˜¯å¦åšäº†å°¾è°ƒç”¨ä¼˜åŒ–ï¼Ÿ</h2><p>ä¸€èˆ¬æ¥è¯´ï¼Œä¸ä¼šã€‚åœ¨<a href="http://llvm.org/docs/CodeGenerator.html#sibling-call-optimization">æœ‰é™çš„æƒ…å†µä¸‹</a>å¯èƒ½ä¼šè¿›è¡Œå°¾éƒ¨è°ƒç”¨ä¼˜åŒ–ï¼Œä½†<a href="https://mail.mozilla.org/pipermail/rust-dev/2013-April/003557.html">ä¸ä¿è¯</a>ã€‚ç”±äºè¿™ä¸ªåŠŸèƒ½ä¸€ç›´æ˜¯äººä»¬æ‰€å¸Œæœ›çš„ï¼ŒRust ä¿ç•™äº†ä¸€ä¸ªå…³é”®å­—ï¼ˆ<code>become</code>ï¼‰ï¼Œå°½ç®¡ç›®å‰è¿˜ä¸æ¸…æ¥šå®ƒåœ¨æŠ€æœ¯ä¸Šæ˜¯å¦å¯è¡Œï¼Œä¹Ÿä¸æ¸…æ¥šå®ƒæ˜¯å¦ä¼šè¢«å®ç°ã€‚æ›¾ç»æœ‰ä¸€ä¸ª<a href="https://github.com/rust-lang/rfcs/pull/81">æ‹Ÿè®®çš„æ‰©å±•</a>ï¼Œå…è®¸åœ¨æŸäº›æƒ…å†µä¸‹æ¶ˆé™¤å°¾éšè°ƒç”¨ï¼Œä½†ç›®å‰è¢«æ¨è¿Ÿäº†ã€‚</p><h2 id="Rust-æœ‰-runtime-å—ï¼Ÿ"><a href="#Rust-æœ‰-runtime-å—ï¼Ÿ" class="headerlink" title="Rust æœ‰ runtime å—ï¼Ÿ"></a>Rust æœ‰ runtime å—ï¼Ÿ</h2><p>ä¸æ˜¯ Java ç­‰è¯­è¨€æ‰€ä½¿ç”¨çš„å…¸å‹æ„ä¹‰ä¸Šçš„è¿è¡Œæ—¶ï¼Œä½†æ˜¯ Rust æ ‡å‡†åº“çš„ä¸€éƒ¨åˆ†å¯ä»¥è¢«è®¤ä¸ºæ˜¯â€œè¿è¡Œæ—¶â€ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªå †ã€å›æº¯ã€è§£å¼€å’Œå †æ ˆå®ˆæŠ¤ã€‚æœ‰ä¸€ä¸ª<a href="https://github.com/rust-lang/rust/blob/master/library/std/src/rt.rs">å°‘é‡çš„åˆå§‹åŒ–ä»£ç </a>ï¼Œåœ¨ç”¨æˆ·çš„<code>main</code>å‡½æ•°ä¹‹å‰è¿è¡Œã€‚Rust æ ‡å‡†åº“è¿˜é“¾æ¥äº† C æ ‡å‡†åº“ï¼Œå®ƒä¹Ÿåšäº†ç±»ä¼¼çš„<a href="http://www.embecosm.com/appnotes/ean9/html/ch05s02.html">è¿è¡Œæ—¶åˆå§‹åŒ–</a>ã€‚Rust ä»£ç å¯ä»¥åœ¨æ²¡æœ‰æ ‡å‡†åº“çš„æƒ…å†µä¸‹è¿›è¡Œç¼–è¯‘ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿è¡Œæ—¶ä¸ C è¯­è¨€å¤§è‡´ç›¸å½“ã€‚</p><h1 id="è¯­æ³•"><a href="#è¯­æ³•" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h1><h2 id="ä¸ºä»€ä¹ˆè¦ç”¨å¤§æ‹¬å·-ä¸ºä»€ä¹ˆ-Rust-çš„è¯­æ³•ä¸èƒ½åƒ-Haskell-æˆ–-Python-é‚£æ ·ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦ç”¨å¤§æ‹¬å·-ä¸ºä»€ä¹ˆ-Rust-çš„è¯­æ³•ä¸èƒ½åƒ-Haskell-æˆ–-Python-é‚£æ ·ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ç”¨å¤§æ‹¬å·? ä¸ºä»€ä¹ˆ Rust çš„è¯­æ³•ä¸èƒ½åƒ Haskell æˆ– Python é‚£æ ·ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦ç”¨å¤§æ‹¬å·? ä¸ºä»€ä¹ˆ Rust çš„è¯­æ³•ä¸èƒ½åƒ Haskell æˆ– Python é‚£æ ·ï¼Ÿ</h2><p>ä½¿ç”¨å¤§æ‹¬å·æ¥è¡¨ç¤ºå—æ˜¯å„ç§ç¼–ç¨‹è¯­è¨€ä¸­å¸¸è§çš„è®¾è®¡é€‰æ‹©ï¼Œè€Œ Rust çš„ä¸€è‡´æ€§å¯¹äºå·²ç»ç†Ÿæ‚‰è¿™ç§é£æ ¼çš„äººæ¥è¯´æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚</p><p>å¤§æ‹¬å·è¿˜å¯ä»¥ä¸ºç¨‹åºå‘˜æä¾›æ›´çµæ´»çš„è¯­æ³•ï¼Œå¹¶åœ¨ç¼–è¯‘å™¨ä¸­æä¾›æ›´ç®€å•çš„è§£æå™¨ã€‚</p><h2 id="æˆ‘å¯ä»¥åœ¨ifæ¡ä»¶ä¸Šä¸åŠ å°æ‹¬å·ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆæˆ‘å¿…é¡»åœ¨å•è¡Œå—å‘¨å›´åŠ ä¸Šå¤§æ‹¬å·ï¼Ÿä¸ºä»€ä¹ˆä¸å…è®¸ä½¿ç”¨-C-è¯­è¨€çš„é£æ ¼"><a href="#æˆ‘å¯ä»¥åœ¨ifæ¡ä»¶ä¸Šä¸åŠ å°æ‹¬å·ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆæˆ‘å¿…é¡»åœ¨å•è¡Œå—å‘¨å›´åŠ ä¸Šå¤§æ‹¬å·ï¼Ÿä¸ºä»€ä¹ˆä¸å…è®¸ä½¿ç”¨-C-è¯­è¨€çš„é£æ ¼" class="headerlink" title="æˆ‘å¯ä»¥åœ¨ifæ¡ä»¶ä¸Šä¸åŠ å°æ‹¬å·ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆæˆ‘å¿…é¡»åœ¨å•è¡Œå—å‘¨å›´åŠ ä¸Šå¤§æ‹¬å·ï¼Ÿä¸ºä»€ä¹ˆä¸å…è®¸ä½¿ç”¨ C è¯­è¨€çš„é£æ ¼?"></a>æˆ‘å¯ä»¥åœ¨<code>if</code>æ¡ä»¶ä¸Šä¸åŠ å°æ‹¬å·ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆæˆ‘å¿…é¡»åœ¨å•è¡Œå—å‘¨å›´åŠ ä¸Šå¤§æ‹¬å·ï¼Ÿä¸ºä»€ä¹ˆä¸å…è®¸ä½¿ç”¨ C è¯­è¨€çš„é£æ ¼?</h2><p>C è¯­è¨€è¦æ±‚â€œifâ€è¯­å¥çš„æ¡ä»¶å¿…é¡»æœ‰å°æ‹¬å·ï¼Œä½†å¤§æ‹¬å·æ˜¯å¯é€‰çš„ï¼Œè€Œ Rust å¯¹å…¶â€œifâ€è¡¨è¾¾å¼åšå‡ºäº†ç›¸åçš„é€‰æ‹©ã€‚è¿™ä½¿å¾—æ¡ä»¶è¯­å¥ä¸è¯­å¥ä¸»ä½“æ˜ç¡®åˆ†å¼€ï¼Œå¹¶é¿å…äº†å¯é€‰å¤§æ‹¬å·çš„å±å®³ï¼Œè¿™å¯èƒ½å¯¼è‡´åœ¨é‡æ„è¿‡ç¨‹ä¸­å‡ºç°å®¹æ˜“è¢«å¿½ç•¥çš„é”™è¯¯ï¼Œæ¯”å¦‚è‹¹æœçš„ <a href="https://gotofail.com/">goto fail</a> é”™è¯¯ã€‚</p><h2 id="ä¸ºä»€ä¹ˆæ²¡æœ‰å­—å…¸çš„å­—é¢è¯­æ³•ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆæ²¡æœ‰å­—å…¸çš„å­—é¢è¯­æ³•ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆæ²¡æœ‰å­—å…¸çš„å­—é¢è¯­æ³•ï¼Ÿ"></a>ä¸ºä»€ä¹ˆæ²¡æœ‰å­—å…¸çš„å­—é¢è¯­æ³•ï¼Ÿ</h2><p>Rust çš„æ•´ä½“è®¾è®¡å€¾å‘äºé™åˆ¶<em>è¯­è¨€</em>çš„å¤§å°ï¼ŒåŒæ—¶å¯ç”¨å¼ºå¤§çš„<em>åº“</em>ã€‚è™½ç„¶ Rust ç¡®å®ä¸ºæ•°ç»„å’Œå­—ç¬¦ä¸²å­—é¢æä¾›äº†åˆå§‹åŒ–è¯­æ³•ï¼Œä½†è¿™æ˜¯è¯­è¨€ä¸­å”¯ä¸€çš„é›†åˆç±»å‹ã€‚å…¶ä»–åº“å®šä¹‰çš„ç±»å‹ï¼ŒåŒ…æ‹¬æ— å¤„ä¸åœ¨çš„<a href="https://doc.rust-lang.org/std/vec/struct.Vec.html"><code>Vec</code></a>é›†åˆç±»å‹ï¼Œéƒ½ä½¿ç”¨å®è¿›è¡Œåˆå§‹åŒ–ï¼Œå¦‚<a href="https://doc.rust-lang.org/std/macro.vec!.html"><code>vec!</code></a>å®ã€‚</p><p>è¿™ç§ä½¿ç”¨ Rust çš„å®è®¾æ–½æ¥åˆå§‹åŒ–é›†åˆçš„è®¾è®¡é€‰æ‹©åœ¨æœªæ¥å¯èƒ½ä¼šè¢«é€šç”¨åœ°æ‰©å±•åˆ°å…¶ä»–é›†åˆï¼Œä¸ä»…å¯ä»¥ç®€å•åœ°åˆå§‹åŒ–<a href="https://doc.rust-lang.org/std/collections/struct.HashMap.html"><code>HashMap</code></a>å’Œ<a href="https://doc.rust-lang.org/std/vec/struct.Vec.html"><code>Vec</code></a>ï¼Œè¿˜å¯ä»¥åˆå§‹åŒ–å…¶ä»–é›†åˆç±»å‹ï¼Œå¦‚<a href="https://doc.rust-lang.org/std/collections/struct.BTreeMap.html"><code>BTreeMap</code></a>ã€‚åŒæ—¶, å¦‚æœä½ æƒ³è¦ä¸€ä¸ªæ›´æ–¹ä¾¿çš„åˆå§‹åŒ–é›†åˆçš„è¯­æ³•, ä½ å¯ä»¥<a href="https://stackoverflow.com/questions/27582739/how-do-i-create-a-hashmap-literal">åˆ›å»ºä½ è‡ªå·±çš„å®</a>æ¥æä¾›å®ƒ.</p><h2 id="æˆ‘åº”è¯¥åœ¨ä»€ä¹ˆæ—¶å€™ä½¿ç”¨éšå¼è¿”å›ï¼Ÿ"><a href="#æˆ‘åº”è¯¥åœ¨ä»€ä¹ˆæ—¶å€™ä½¿ç”¨éšå¼è¿”å›ï¼Ÿ" class="headerlink" title="æˆ‘åº”è¯¥åœ¨ä»€ä¹ˆæ—¶å€™ä½¿ç”¨éšå¼è¿”å›ï¼Ÿ"></a>æˆ‘åº”è¯¥åœ¨ä»€ä¹ˆæ—¶å€™ä½¿ç”¨éšå¼è¿”å›ï¼Ÿ</h2><p>Rust æ˜¯ä¸€ç§éå¸¸é¢å‘è¡¨è¾¾å¼çš„è¯­è¨€ï¼Œè€Œâ€œéšå¼è¿”å›â€æ˜¯è¿™ç§è®¾è®¡çš„ä¸€éƒ¨åˆ†ã€‚åƒ<code>if</code>s, <code>match</code>es, å’Œæ™®é€šå—è¿™æ ·çš„ç»“æ„åœ¨ Rust ä¸­éƒ½æ˜¯è¡¨è¾¾å¼ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢çš„ä»£ç æ£€æŸ¥ä¸€ä¸ª<a href="https://doc.rust-lang.org/std/primitive.i64.html"><code>i64</code></a>æ˜¯å¦ä¸ºå¥‡æ•°ï¼Œé€šè¿‡ç®€å•åœ°å°†å…¶ä½œä¸ºä¸€ä¸ªå€¼æ¥è¿”å›ç»“æœã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">is_odd</span></span>(x: <span class="built_in">i64</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> x % <span class="number">2</span> != <span class="number">0</span> &#123; <span class="literal">true</span> &#125; <span class="keyword">else</span> &#123; <span class="literal">false</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è™½ç„¶å®ƒå¯ä»¥è¿›ä¸€æ­¥ç®€åŒ–ï¼Œæ¯”å¦‚è¯´ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">is_odd</span></span>(x: <span class="built_in">i64</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    x % <span class="number">2</span> != <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ¯ä¸ªä¾‹å­ä¸­ï¼Œå‡½æ•°çš„æœ€åä¸€è¡Œæ˜¯è¯¥å‡½æ•°çš„è¿”å›å€¼ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä¸€ä¸ªå‡½æ•°ä»¥åˆ†å·ç»“æŸï¼Œå…¶è¿”å›ç±»å‹å°†æ˜¯<code>()</code>ï¼Œè¡¨ç¤ºæ²¡æœ‰è¿”å›å€¼ã€‚éšå¼è¿”å›å¿…é¡»çœç•¥åˆ†å·ï¼Œæ‰èƒ½å‘æŒ¥ä½œç”¨ã€‚</p><p>æ˜¾å¼è¿”å›åªæœ‰åœ¨éšå¼è¿”å›ä¸å¯èƒ½æ—¶æ‰ä¼šä½¿ç”¨ï¼Œå› ä¸ºä½ è¦åœ¨å‡½æ•°ä¸»ä½“ç»“æŸå‰è¿”å›ã€‚è™½ç„¶ä¸Šé¢çš„æ¯ä¸ªå‡½æ•°éƒ½å¯ä»¥ç”¨<code>return</code>å…³é”®å­—å’Œåˆ†å·æ¥å†™ï¼Œä½†è¿™æ ·åšæ˜¯ä¸å¿…è¦çš„å†—é•¿ï¼Œè€Œä¸”ä¸ Rust ä»£ç çš„æƒ¯ä¾‹ä¸ä¸€è‡´ã€‚</p><h2 id="ä¸ºä»€ä¹ˆä¸æ¨æ–­å‡ºå‡½æ•°çš„ç­¾åï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä¸æ¨æ–­å‡ºå‡½æ•°çš„ç­¾åï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä¸æ¨æ–­å‡ºå‡½æ•°çš„ç­¾åï¼Ÿ"></a>ä¸ºä»€ä¹ˆä¸æ¨æ–­å‡ºå‡½æ•°çš„ç­¾åï¼Ÿ</h2><p>åœ¨ Rust ä¸­ï¼Œå£°æ˜å¾€å¾€å¸¦æœ‰æ˜ç¡®çš„ç±»å‹ï¼Œè€Œå®é™…ä»£ç çš„ç±»å‹æ˜¯æ¨æ–­å‡ºæ¥çš„ã€‚è¿™ç§è®¾è®¡æœ‰å‡ ä¸ªåŸå› ï¼š</p><ul><li>å¼ºåˆ¶æ€§çš„å£°æ˜ç­¾åæœ‰åŠ©äºåœ¨æ¨¡å—å’Œæ¿å—å±‚é¢ä¸Šæ‰§è¡Œæ¥å£çš„ç¨³å®šæ€§ã€‚</li><li>ç­¾åæé«˜äº†ç¨‹åºå‘˜å¯¹ä»£ç çš„ç†è§£ï¼Œæ¶ˆé™¤äº† IDE åœ¨æ•´ä¸ªæ¿å—ä¸­è¿è¡Œæ¨ç†ç®—æ³•æ¥çŒœæµ‹ä¸€ä¸ªå‡½æ•°çš„å‚æ•°ç±»å‹çš„éœ€è¦ï¼›å®ƒæ€»æ˜¯æ˜¾å¼çš„ï¼Œå°±åœ¨é™„è¿‘ã€‚</li><li>åœ¨æœºåˆ¶ä¸Šï¼Œå®ƒç®€åŒ–äº†æ¨ç†ç®—æ³•ï¼Œå› ä¸ºæ¨ç†åªéœ€è¦ä¸€æ¬¡çœ‹ä¸€ä¸ªå‡½æ•°ã€‚</li></ul><h2 id="ä¸ºä»€ä¹ˆmatchå¿…é¡»æ˜¯è¯¦å°½çš„"><a href="#ä¸ºä»€ä¹ˆmatchå¿…é¡»æ˜¯è¯¦å°½çš„" class="headerlink" title="ä¸ºä»€ä¹ˆmatchå¿…é¡»æ˜¯è¯¦å°½çš„?"></a>ä¸ºä»€ä¹ˆ<code>match</code>å¿…é¡»æ˜¯è¯¦å°½çš„?</h2><p>ä¸ºäº†å¸®åŠ©é‡æ„å’Œæ¸…æ™°åŒ–ã€‚</p><p>é¦–å…ˆï¼Œå¦‚æœæ¯ä¸€ç§å¯èƒ½æ€§éƒ½è¢«<code>match</code>æ‰€è¦†ç›–ï¼Œé‚£ä¹ˆå°†æ¥åœ¨<code>enum</code>ä¸­å¢åŠ å˜ä½“å°†å¯¼è‡´ç¼–è¯‘å¤±è´¥ï¼Œè€Œä¸æ˜¯åœ¨è¿è¡Œæ—¶å‡ºé”™ã€‚è¿™ç§ç±»å‹çš„ç¼–è¯‘å™¨å¸®åŠ©ä½¿å¾— Rust ä¸­çš„æ— ç•é‡æ„æˆä¸ºå¯èƒ½ã€‚</p><p>å…¶æ¬¡ï¼Œç©·ä¸¾å¼æ£€æŸ¥ä½¿é»˜è®¤æƒ…å†µçš„è¯­ä¹‰å˜å¾—æ˜ç¡®ï¼šä¸€èˆ¬æ¥è¯´ï¼Œéç©·ä¸¾å¼<code>match</code>çš„å”¯ä¸€å®‰å…¨æ–¹å¼æ˜¯åœ¨æ²¡æœ‰åŒ¹é…åˆ°ä»»ä½•ä¸œè¥¿æ—¶è®©çº¿ç¨‹ææ…Œã€‚Rust çš„æ—©æœŸç‰ˆæœ¬å¹¶ä¸è¦æ±‚<code>match</code>æƒ…å†µæ˜¯è¯¦å°½çš„ï¼Œè€Œä¸”å‘ç°å®ƒæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ bug æ¥æºã€‚</p><p>é€šè¿‡ä½¿ç”¨<code>_</code>é€šé…ç¬¦ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°å¿½ç•¥æ‰€æœ‰æœªæŒ‡å®šçš„æƒ…å†µã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">match</span> val.do_something() &#123;</span><br><span class="line">    Cat(a) =&gt; &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">    _ =&gt; &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Numerics"><a href="#Numerics" class="headerlink" title="Numerics"></a>Numerics</h1><h2 id="å¯¹äºæµ®ç‚¹è¿ç®—ï¼Œæˆ‘åº”è¯¥é€‰æ‹©f32å’Œf64ä¸­çš„å“ªä¸€ä¸ª"><a href="#å¯¹äºæµ®ç‚¹è¿ç®—ï¼Œæˆ‘åº”è¯¥é€‰æ‹©f32å’Œf64ä¸­çš„å“ªä¸€ä¸ª" class="headerlink" title="å¯¹äºæµ®ç‚¹è¿ç®—ï¼Œæˆ‘åº”è¯¥é€‰æ‹©f32å’Œf64ä¸­çš„å“ªä¸€ä¸ª?"></a>å¯¹äºæµ®ç‚¹è¿ç®—ï¼Œæˆ‘åº”è¯¥é€‰æ‹©<code>f32</code>å’Œ<code>f64</code>ä¸­çš„å“ªä¸€ä¸ª?</h2><p>é€‰æ‹©å“ªç§æ–¹å¼å–å†³äºç¨‹åºçš„ç›®çš„ã€‚</p><p>å¦‚æœä½ å¯¹æµ®ç‚¹æ•°çš„æœ€å¤§ç²¾åº¦æ„Ÿå…´è¶£, é‚£ä¹ˆå°±é€‰æ‹©<a href="https://doc.rust-lang.org/std/primitive.f64.html"><code>f64</code></a>. å¦‚æœä½ å¯¹ä¿æŒæ•°å€¼çš„å¤§å°æˆ–æœ€å¤§çš„æ•ˆç‡æ›´æ„Ÿå…´è¶£ï¼Œå¹¶ä¸”ä¸å…³å¿ƒæ¯ä¸ªæ•°å€¼çš„ä½æ•°è¾ƒå°‘æ‰€å¸¦æ¥çš„è¯¯å·®ï¼Œé‚£ä¹ˆ<a href="https://doc.rust-lang.org/std/primitive.f32.html"><code>f32</code></a>æ›´å¥½ã€‚å¯¹<a href="https://doc.rust-lang.org/std/primitive.f32.html"><code>f32</code></a>çš„æ“ä½œé€šå¸¸æ›´å¿«ï¼Œå³ä½¿æ˜¯åœ¨ 64 ä½ç¡¬ä»¶ä¸Šã€‚ä½œä¸ºä¸€ä¸ªå¸¸è§çš„ä¾‹å­ï¼Œå›¾å½¢ç¼–ç¨‹é€šå¸¸ä½¿ç”¨<a href="https://doc.rust-lang.org/std/primitive.f32.html"><code>f32</code></a>ï¼Œå› ä¸ºå®ƒéœ€è¦é«˜æ€§èƒ½ï¼Œè€Œ 32 ä½æµ®ç‚¹æ•°è¶³ä»¥ä»£è¡¨å±å¹•ä¸Šçš„åƒç´ ã€‚</p><p>å¦‚æœæœ‰ç–‘é—®ï¼Œå¯ä»¥é€‰æ‹©<a href="https://doc.rust-lang.org/std/primitive.f64.html"><code>f64</code></a>ä»¥è·å¾—æ›´å¤§çš„ç²¾åº¦ã€‚</p><h2 id="ä¸ºä»€ä¹ˆæˆ‘ä¸èƒ½æ¯”è¾ƒæµ®ç‚¹æ•°æˆ–ç”¨å®ƒä»¬ä½œä¸ºHashMapæˆ–BTreeMapçš„é”®"><a href="#ä¸ºä»€ä¹ˆæˆ‘ä¸èƒ½æ¯”è¾ƒæµ®ç‚¹æ•°æˆ–ç”¨å®ƒä»¬ä½œä¸ºHashMapæˆ–BTreeMapçš„é”®" class="headerlink" title="ä¸ºä»€ä¹ˆæˆ‘ä¸èƒ½æ¯”è¾ƒæµ®ç‚¹æ•°æˆ–ç”¨å®ƒä»¬ä½œä¸ºHashMapæˆ–BTreeMapçš„é”®?"></a>ä¸ºä»€ä¹ˆæˆ‘ä¸èƒ½æ¯”è¾ƒæµ®ç‚¹æ•°æˆ–ç”¨å®ƒä»¬ä½œä¸º<code>HashMap</code>æˆ–<code>BTreeMap</code>çš„é”®?</h2><p>æµ®ç‚¹æ•°å¯ä»¥ç”¨<code>==</code>, <code>!=</code>, <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code>, å’Œ<code>&gt;=</code>è¿ç®—ç¬¦ï¼Œä»¥åŠ<code>partial_cmp()</code>å‡½æ•°è¿›è¡Œæ¯”è¾ƒã€‚<code>==</code>å’Œ<code>ï¼=</code>æ˜¯<a href="https://doc.rust-lang.org/std/cmp/trait.PartialEq.html"><code>PartialEq</code></a>ç‰¹æ€§çš„ä¸€éƒ¨åˆ†ï¼Œè€Œ<code>&lt;</code>ã€<code>&lt;=</code>ã€<code>&gt;</code>ã€<code>&gt;=</code>å’Œ<code>partial_cmp()</code>æ˜¯<a href="https://doc.rust-lang.org/std/cmp/trait.PartialOrd.html"><code>PartialOrd</code></a> ç‰¹æ€§çš„ä¸€éƒ¨åˆ†ã€‚</p><p>æµ®ç‚¹æ•°ä¸èƒ½ç”¨<code>cmp()</code>å‡½æ•°è¿›è¡Œæ¯”è¾ƒï¼Œå®ƒæ˜¯<a href="https://doc.rust-lang.org/std/cmp/trait.Ord.html"><code>Ord</code></a>ç‰¹æ€§çš„ä¸€éƒ¨åˆ†ï¼Œå› ä¸ºæµ®ç‚¹æ•°æ²¡æœ‰æ€»æ’åºã€‚æ­¤å¤–ï¼Œæµ®ç‚¹æ•°æ²¡æœ‰å…¨ç­‰å…³ç³»ï¼Œæ‰€ä»¥å®ƒä»¬ä¹Ÿæ²¡æœ‰å®ç°<a href="https://doc.rust-lang.org/std/cmp/trait.Eq.html"><code>Eq</code></a>ç‰¹æ€§ã€‚</p><p>ç”±äºæµ®ç‚¹æ•°<a href="https://en.wikipedia.org/wiki/NaN"><code>NaN</code></a>ä¸å°äºã€å¤§äºæˆ–ç­‰äºä»»ä½•å…¶ä»–æµ®ç‚¹æ•°æˆ–å…¶æœ¬èº«ï¼Œæ‰€ä»¥æµ®ç‚¹æ•°æ²¡æœ‰æ€»æ’åºæˆ–å¹³ç­‰å…³ç³»ã€‚</p><p>å› ä¸ºæµ®ç‚¹æ•°æ²¡æœ‰å®ç°<a href="https://doc.rust-lang.org/std/cmp/trait.Eq.html"><code>Eq</code></a>æˆ–<a href="https://doc.rust-lang.org/std/cmp/trait.Ord.html"><code>Ord</code></a>ï¼Œæ‰€ä»¥å®ƒä»¬ä¸èƒ½è¢«ç”¨äºç‰¹è´¨è¾¹ç•Œéœ€è¦è¿™äº›ç‰¹è´¨çš„ç±»å‹ï¼Œä¾‹å¦‚<a href="https://doc.rust-lang.org/std/collections/struct.BTreeMap.html"><code>BTreeMap</code></a>æˆ–[<code>HashMap</code>]ã€‚è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå› ä¸ºè¿™äº›ç±»å‹<em>å‡è®¾</em>å®ƒä»¬çš„é”®æä¾›äº†ä¸€ä¸ªæ€»æ’åºæˆ–æ€»ç­‰ä»·å…³ç³»ï¼Œå¦åˆ™ä¼šå‡ºç°æ•…éšœã€‚</p><p>æœ‰ä¸€ä¸ª<a href="https://crates.io/crates/ordered-float">crate</a>åŒ…è£…äº†<a href="https://doc.rust-lang.org/std/primitive.f32.html"><code>f32</code></a>å’Œ<a href="https://doc.rust-lang.org/std/primitive.f64.html"><code>f64</code></a>ä»¥æä¾›<a href="https://doc.rust-lang.org/std/cmp/trait.Ord.html"><code>Ord</code></a>å’Œ<a href="https://doc.rust-lang.org/std/cmp/trait.Eq.html"><code>Eq</code></a>çš„å®ç°ï¼Œè¿™åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½å¾ˆæœ‰ç”¨ã€‚</p><h2 id="æˆ‘å¦‚ä½•åœ¨æ•°å­—ç±»å‹ä¹‹é—´è¿›è¡Œè½¬æ¢"><a href="#æˆ‘å¦‚ä½•åœ¨æ•°å­—ç±»å‹ä¹‹é—´è¿›è¡Œè½¬æ¢" class="headerlink" title="æˆ‘å¦‚ä½•åœ¨æ•°å­—ç±»å‹ä¹‹é—´è¿›è¡Œè½¬æ¢?"></a>æˆ‘å¦‚ä½•åœ¨æ•°å­—ç±»å‹ä¹‹é—´è¿›è¡Œè½¬æ¢?</h2><p>æœ‰ä¸¤ç§æ–¹æ³•ï¼š<code>as</code>å…³é”®å­—ï¼Œå®ƒä¸ºåŸå§‹ç±»å‹åšç®€å•çš„è½¬æ¢ï¼Œä»¥åŠ<a href="https://doc.rust-lang.org/std/convert/trait.Into.html"><code>Into</code></a>å’Œ<a href="https://doc.rust-lang.org/std/convert/trait.From.html"><code>From</code></a>ç‰¹æ€§ï¼Œå®ƒä»¬æ˜¯ä¸ºä¸€äº›ç±»å‹è½¬æ¢è€Œå®ç°çš„ï¼ˆä½ ä¹Ÿå¯ä»¥ä¸ºä½ è‡ªå·±çš„ç±»å‹å®ç°ï¼‰ã€‚<a href="https://doc.rust-lang.org/std/convert/trait.Into.html"><code>Into</code></a>å’Œ<a href="https://doc.rust-lang.org/std/convert/trait.From.html"><code>From</code></a>ç‰¹æ€§åªåœ¨è½¬æ¢æ— æŸçš„æƒ…å†µä¸‹å®ç°ï¼Œæ‰€ä»¥ä¾‹å¦‚ï¼Œ<code>f64::from(0f32)</code>ä¼šè¢«ç¼–è¯‘ï¼Œè€Œ<code>f32::from(0f64)</code>ä¸ä¼šã€‚å¦ä¸€æ–¹é¢ï¼Œ<code>as</code>å°†åœ¨ä»»ä½•ä¸¤ä¸ªåŸå§‹ç±»å‹ä¹‹é—´è¿›è¡Œè½¬æ¢ï¼Œå¿…è¦æ—¶æˆªæ–­æ•°å€¼ã€‚</p><h2 id="ä¸ºä»€ä¹ˆRustæ²¡æœ‰å¢é‡å’Œå‡é‡è¿ç®—ç¬¦"><a href="#ä¸ºä»€ä¹ˆRustæ²¡æœ‰å¢é‡å’Œå‡é‡è¿ç®—ç¬¦" class="headerlink" title="ä¸ºä»€ä¹ˆRustæ²¡æœ‰å¢é‡å’Œå‡é‡è¿ç®—ç¬¦?"></a>ä¸ºä»€ä¹ˆRustæ²¡æœ‰å¢é‡å’Œå‡é‡è¿ç®—ç¬¦?</h2><p>Preincrement å’Œ Postincrementï¼ˆä»¥åŠä¸ä¹‹å¯¹åº”çš„ Decrementï¼‰è™½ç„¶æ–¹ä¾¿ï¼Œä½†ä¹Ÿç›¸å½“å¤æ‚ã€‚å®ƒä»¬éœ€è¦å¯¹è®¡ç®—é¡ºåºçš„äº†è§£ï¼Œå¹¶ç»å¸¸å¯¼è‡´ C å’Œ C++ ä¸­çš„å¾®å¦™é”™è¯¯å’Œæœªå®šä¹‰è¡Œä¸ºã€‚å’Œ<code>x = x + 1</code>ç›¸æ¯”<code>x += 1</code>åªæ˜¯ç¨å¾®é•¿ä¸€ç‚¹ï¼Œä½†ä¸æ˜ç¡®ã€‚</p><h1 id="å­—ç¬¦ä¸²"><a href="#å­—ç¬¦ä¸²" class="headerlink" title="å­—ç¬¦ä¸²"></a>å­—ç¬¦ä¸²</h1><h2 id="å¦‚ä½•å°†ä¸€ä¸ªStringæˆ–Vec-lt-T-gt-è½¬æ¢ä¸ºä¸€ä¸ªç‰‡æ–­-amp-strå’Œ-amp-T"><a href="#å¦‚ä½•å°†ä¸€ä¸ªStringæˆ–Vec-lt-T-gt-è½¬æ¢ä¸ºä¸€ä¸ªç‰‡æ–­-amp-strå’Œ-amp-T" class="headerlink" title="å¦‚ä½•å°†ä¸€ä¸ªStringæˆ–Vec&lt;T&gt;è½¬æ¢ä¸ºä¸€ä¸ªç‰‡æ–­(&amp;strå’Œ&amp;[T])?"></a>å¦‚ä½•å°†ä¸€ä¸ª<code>String</code>æˆ–<code>Vec&lt;T&gt;</code>è½¬æ¢ä¸ºä¸€ä¸ªç‰‡æ–­(<code>&amp;str</code>å’Œ<code>&amp;[T]</code>)?</h2><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥åœ¨æœŸæœ›æœ‰ç‰‡æ–­çš„åœ°æ–¹ä¼ é€’ä¸€ä¸ªå¯¹<code>String</code>æˆ–<code>Vec&lt;T&gt;</code>çš„å¼•ç”¨ã€‚ä½¿ç”¨<a href="https://doc.rust-lang.org/book/ch15-02-deref.html">Deref coercions</a>ï¼Œ<a href="https://doc.rust-lang.org/std/string/struct.String.html"><code>String</code>s</a>å’Œ<a href="https://doc.rust-lang.org/std/vec/struct.Vec.html"><code>Vec</code>s</a>åœ¨ç”¨<code>&amp;</code>æˆ–<code>&amp;mut</code>ä¼ é€’å¼•ç”¨æ—¶ï¼Œå°†è‡ªåŠ¨è”åˆåˆ°å„è‡ªçš„ç‰‡ä¸Šã€‚</p><p>åœ¨<code>&amp;str</code>å’Œ<code>&amp;[T]</code>ä¸Šå®ç°çš„æ–¹æ³•å¯ä»¥ç›´æ¥è®¿é—®<code>String</code>å’Œ<code>Vec&lt;T&gt;</code>ã€‚ä¾‹å¦‚ï¼Œ<code>some_string.trim()</code>å¯ä»¥å·¥ä½œï¼Œå°½ç®¡<code>trim</code>æ˜¯<code>&amp;str</code>ä¸Šçš„æ–¹æ³•ï¼Œè€Œ<code>some_string</code>æ˜¯ä¸€ä¸ª<code>String</code>ã€‚</p><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¾‹å¦‚é€šç”¨ä»£ç ï¼Œæœ‰å¿…è¦è¿›è¡Œæ‰‹åŠ¨è½¬æ¢ã€‚æ‰‹åŠ¨è½¬æ¢å¯ä»¥ä½¿ç”¨åˆ‡ç‰‡æ“ä½œç¬¦æ¥å®ç°ï¼Œåƒè¿™æ ·ã€‚<code>&amp;my_vec[...]</code>ã€‚</p><h2 id="æˆ‘å¦‚ä½•ä»-amp-strè½¬æ¢åˆ°Stringæˆ–åè¿‡æ¥ï¼Ÿ"><a href="#æˆ‘å¦‚ä½•ä»-amp-strè½¬æ¢åˆ°Stringæˆ–åè¿‡æ¥ï¼Ÿ" class="headerlink" title="æˆ‘å¦‚ä½•ä»&amp;strè½¬æ¢åˆ°Stringæˆ–åè¿‡æ¥ï¼Ÿ"></a>æˆ‘å¦‚ä½•ä»<code>&amp;str</code>è½¬æ¢åˆ°<code>String</code>æˆ–åè¿‡æ¥ï¼Ÿ</h2><p><a href="https://doc.rust-lang.org/std/string/trait.ToString.html#tymethod.to_string"><code>to_string()</code></a>æ–¹æ³•å¯ä»¥å°†<a href="https://doc.rust-lang.org/std/primitive.str.html"><code>&amp;str</code></a>è½¬æ¢ä¸º<a href="https://doc.rust-lang.org/std/string/struct.String.html"><code>String</code></a>ï¼Œå½“ä½ å€Ÿç”¨ä¸€ä¸ªå¼•ç”¨æ—¶ï¼Œ<a href="https://doc.rust-lang.org/std/string/struct.String.html"><code>String</code></a>è‡ªåŠ¨è½¬æ¢ä¸º<a href="https://doc.rust-lang.org/std/primitive.str.html"><code>&amp;str</code></a>ã€‚è¿™ä¸¤ç§æƒ…å†µåœ¨ä¸‹é¢çš„ä¾‹å­ä¸­éƒ½æœ‰æ¼”ç¤ºã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> s = <span class="string">&quot;Jane Doe&quot;</span>.to_string();</span><br><span class="line">    say_hello(&amp;s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">say_hello</span></span>(name: &amp;<span class="built_in">str</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span> (<span class="string">&quot;Hello &#123;&#125;!&quot;</span>, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸¤ç§ä¸åŒçš„å­—ç¬¦ä¸²ç±»å‹ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"><a href="#ä¸¤ç§ä¸åŒçš„å­—ç¬¦ä¸²ç±»å‹ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ" class="headerlink" title="ä¸¤ç§ä¸åŒçš„å­—ç¬¦ä¸²ç±»å‹ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"></a>ä¸¤ç§ä¸åŒçš„å­—ç¬¦ä¸²ç±»å‹ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h2><p><a href="https://doc.rust-lang.org/std/string/struct.String.html"><code>String</code></a>æ˜¯ä¸€ä¸ªåœ¨å †ä¸Šåˆ†é…çš„ UTF-8 å­—èŠ‚çš„è‡ªæœ‰ç¼“å†²åŒºã€‚å¯å˜çš„<a href="https://doc.rust-lang.org/std/string/struct.String.html"><code>String</code></a>å¯ä»¥è¢«ä¿®æ”¹ï¼Œæ ¹æ®éœ€è¦å¢åŠ å…¶å®¹é‡ã€‚<a href="https://doc.rust-lang.org/std/primitive.str.html"><code>&amp;str</code></a>æ˜¯åœ¨å…¶ä»–åœ°æ–¹åˆ†é…çš„<a href="https://doc.rust-lang.org/std/string/struct.String.html"><code>String</code></a>çš„ä¸€ä¸ªå›ºå®šå®¹é‡çš„â€œè§†å›¾â€ï¼Œå¦‚æœæ˜¯ä»<a href="https://doc.rust-lang.org/std/string/struct.String.html"><code>String</code></a>ä¸­å¼•ç”¨çš„ç‰‡æ–­ï¼Œé€šå¸¸åœ¨å †ä¸Šï¼Œå¦‚æœæ˜¯å­—ç¬¦ä¸²å­—é¢ï¼Œåœ¨é™æ€å†…å­˜ä¸­ã€‚</p><p><a href="https://doc.rust-lang.org/std/primitive.str.html"><code>&amp;str</code></a>æ˜¯ç”± Rust è¯­è¨€å®ç°çš„åŸå§‹ç±»å‹ï¼Œè€Œ<a href="https://doc.rust-lang.org/std/string/struct.String.html"><code>String</code></a>æ˜¯ç”±æ ‡å‡†åº“å®ç°çš„ã€‚</p><h2 id="æˆ‘å¦‚ä½•åœ¨ä¸€ä¸ªStringä¸­è¿›è¡Œ-O-1-çš„å­—ç¬¦è®¿é—®"><a href="#æˆ‘å¦‚ä½•åœ¨ä¸€ä¸ªStringä¸­è¿›è¡Œ-O-1-çš„å­—ç¬¦è®¿é—®" class="headerlink" title="æˆ‘å¦‚ä½•åœ¨ä¸€ä¸ªStringä¸­è¿›è¡Œ O(1) çš„å­—ç¬¦è®¿é—®?"></a>æˆ‘å¦‚ä½•åœ¨ä¸€ä¸ª<code>String</code>ä¸­è¿›è¡Œ O(1) çš„å­—ç¬¦è®¿é—®?</h2><p>ä½ ä¸èƒ½ã€‚è‡³å°‘åœ¨ä½ ä¸æ¸…æ¥šâ€œå­—ç¬¦â€æ˜¯ä»€ä¹ˆæ„æ€çš„æƒ…å†µä¸‹ï¼Œä»¥åŠåœ¨å¯¹å­—ç¬¦ä¸²è¿›è¡Œé¢„å¤„ç†ä»¥æ‰¾åˆ°æ‰€éœ€å­—ç¬¦çš„ç´¢å¼•çš„æƒ…å†µä¸‹æ˜¯ä¸è¡Œçš„ã€‚</p><p>Rust å­—ç¬¦ä¸²æ˜¯ UTF-8 ç¼–ç çš„ã€‚UTF-8 ä¸­çš„å•ä¸ªè§†è§‰å­—ç¬¦ä¸ä¸€å®šæ˜¯ä¸€ä¸ªå­—èŠ‚ï¼Œå› ä¸ºå®ƒåœ¨ ASCII ç¼–ç çš„å­—ç¬¦ä¸²ä¸­æ˜¯ä¸€ä¸ªå­—èŠ‚ã€‚æ¯ä¸ªå­—èŠ‚è¢«ç§°ä¸ºâ€œä»£ç å•å…ƒâ€ï¼ˆåœ¨ UTF-16 ä¸­ï¼Œä»£ç å•å…ƒæ˜¯ 2 ä¸ªå­—èŠ‚ï¼›åœ¨ UTF-32 ä¸­æ˜¯4ä¸ªå­—èŠ‚ï¼‰ã€‚â€œä»£ç ç‚¹â€ç”±ä¸€ä¸ªæˆ–å¤šä¸ªä»£ç å•å…ƒç»„æˆï¼Œå¹¶ç»„åˆæˆæœ€æ¥è¿‘äºå­—ç¬¦çš„â€œå­—ç´ ç¾¤â€ã€‚</p><p>å› æ­¤ï¼Œå³ä½¿ä½ å¯ä»¥å¯¹ UTF-8 å­—ç¬¦ä¸²ä¸­çš„å­—èŠ‚è¿›è¡Œç´¢å¼•ï¼Œä½ ä¹Ÿæ— æ³•åœ¨æ’å®šæ—¶é—´å†…è®¿é—®ç¬¬ i ä¸ªç ä½æˆ–å­—æ¯ç¾¤ã€‚ç„¶è€Œï¼Œå¦‚æœä½ çŸ¥é“æ‰€éœ€çš„ç ä½æˆ–å­—å½¢ç¾¤ä»å“ªä¸ªå­—èŠ‚å¼€å§‹ï¼Œé‚£ä¹ˆä½ å°±å¯ä»¥åœ¨æ’å®šæ—¶é—´å†…è®¿é—®å®ƒã€‚åŒ…æ‹¬<a href="https://doc.rust-lang.org/std/primitive.str.html#method.find">str::find()</a>å’Œ regex åŒ¹é…åœ¨å†…çš„å‡½æ•°éƒ½ä¼šè¿”å›å­—èŠ‚ç´¢å¼•ï¼Œä»¥æ–¹ä¾¿è¿™ç§è®¿é—®ã€‚</p><h2 id="ä¸ºä»€ä¹ˆå­—ç¬¦ä¸²é»˜è®¤ä¸º-UTF-8ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆå­—ç¬¦ä¸²é»˜è®¤ä¸º-UTF-8ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆå­—ç¬¦ä¸²é»˜è®¤ä¸º UTF-8ï¼Ÿ"></a>ä¸ºä»€ä¹ˆå­—ç¬¦ä¸²é»˜è®¤ä¸º UTF-8ï¼Ÿ</h2><p><a href="https://doc.rust-lang.org/std/primitive.str.html"><code>str</code></a>ç±»å‹æ˜¯ UTF-8ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨é‡å¤–è§‚å¯Ÿåˆ°æ›´å¤šçš„æ–‡æœ¬æ˜¯ç”¨è¿™ç§ç¼–ç çš„â€“ç‰¹åˆ«æ˜¯åœ¨ç½‘ç»œä¼ è¾“ä¸­ï¼Œå®ƒæ˜¯ endian-agnostic çš„â€“è€Œä¸”æˆ‘ä»¬è®¤ä¸ºæœ€å¥½ä¸è¦è®© I/O çš„é»˜è®¤å¤„ç†æ¶‰åŠåˆ°åœ¨æ¯ä¸ªæ–¹å‘é‡æ–°ç¼–ç ä»£ç ç‚¹ã€‚</p><p>è¿™ç¡®å®æ„å‘³ç€åœ¨ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­å®šä½ä¸€ä¸ªç‰¹å®šçš„ Unicode ç¼–ç ç‚¹æ˜¯ä¸€ä¸ª O(n) æ“ä½œï¼Œå°½ç®¡å¦‚æœå¼€å§‹çš„å­—èŠ‚ç´¢å¼•å·²ç»çŸ¥é“ï¼Œé‚£ä¹ˆå®ƒä»¬å¯ä»¥åœ¨ O(1) ä¸­è¢«è®¿é—®ã€‚ä¸€æ–¹é¢ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸å¯å–çš„ï¼›å¦ä¸€æ–¹é¢ï¼Œè¿™ä¸ªé—®é¢˜å……æ»¡äº†æƒè¡¡ï¼Œæˆ‘ä»¬æƒ³æŒ‡å‡ºå‡ ä¸ªé‡è¦çš„é™å®šæ¡ä»¶ã€‚</p><p>æ‰«æä¸€ä¸ª<a href="https://doc.rust-lang.org/std/primitive.str.html"><code>str</code></a>çš„ ASCII èŒƒå›´çš„ä»£ç ç‚¹ä»ç„¶å¯ä»¥å®‰å…¨åœ°é€ä¸ªå­—èŠ‚åœ°è¿›è¡Œã€‚å¦‚æœä½ ä½¿ç”¨<a href="https://doc.rust-lang.org/std/primitive.str.html#method.as_bytes"><code>.as_bytes()</code></a>ï¼Œå–å‡ºä¸€ä¸ª<a href="https://doc.rust-lang.org/std/primitive.u8.html"><code>u8</code></a>åªéœ€èŠ±è´¹<code>O(1)</code>ï¼Œå¹¶äº§ç”Ÿä¸€ä¸ªå¯ä»¥è¢«è½¬æ¢å¹¶ä¸ ASCII èŒƒå›´çš„<a href="https://doc.rust-lang.org/std/primitive.char.html"><code>char</code></a>æ¯”è¾ƒçš„å€¼ã€‚å› æ­¤ï¼Œå¦‚æœä½ ï¼ˆæ¯”å¦‚ï¼‰åœ¨<code>\n</code>ä¸Šæ–­è¡Œï¼ŒåŸºäºå­—èŠ‚çš„å¤„ç†æ–¹æ³•ä»ç„¶æœ‰æ•ˆã€‚UTF-8 å°±æ˜¯è¿™æ ·è¢«ç²¾å¿ƒè®¾è®¡çš„ã€‚</p><p>å¤§å¤šæ•°â€œé¢å‘å­—ç¬¦â€çš„æ–‡æœ¬æ“ä½œåªæœ‰åœ¨éå¸¸æœ‰é™çš„è¯­è¨€å‡è®¾ä¸‹æ‰èƒ½å·¥ä½œï¼Œå¦‚â€œä»… ASCII èŒƒå›´çš„ä»£ç ç‚¹â€ã€‚åœ¨ ASCII èŒƒå›´ä¹‹å¤–ï¼Œä½ å¾€å¾€ä¸å¾—ä¸ä½¿ç”¨å¤æ‚çš„ï¼ˆéæ’å®šæ—¶é—´ï¼‰ç®—æ³•æ¥ç¡®å®šè¯­è¨€å•ä½ï¼ˆå­—å½¢ã€å•è¯ã€æ®µè½ï¼‰çš„è¾¹ç•Œã€‚æˆ‘ä»¬å»ºè®®ä½¿ç”¨ä¸€ç§â€œè¯šå®çš„â€å…·æœ‰è¯­è¨€æ„è¯†çš„ã€ç» Unicode æ‰¹å‡†çš„ç®—æ³•ã€‚</p><p><a href="https://doc.rust-lang.org/std/primitive.char.html"><code>char</code></a>ç±»å‹æ˜¯ UTF-32ã€‚å¦‚æœä½ ç¡®å®šä½ éœ€è¦åšä¸€ä¸ªä»£ç ç‚¹çš„ç®—æ³•ï¼Œå†™ä¸€ä¸ª<code>type wstr = [char]</code>ï¼Œå¹¶å°†ä¸€ä¸ª<a href="https://doc.rust-lang.org/std/primitive.str.html"><code>str</code></a>ä¸€æ¬¡æ€§è§£å‹åˆ°å…¶ä¸­ï¼Œç„¶åç”¨<code>wstr</code>å·¥ä½œï¼Œè¿™æ˜¯éå¸¸å®¹æ˜“çš„ã€‚æ¢å¥è¯è¯´ï¼šå¦‚æœä½ éœ€è¦ä½¿ç”¨è¿™ç§ç¼–ç ï¼Œè¯­è¨€æ²¡æœ‰<code>é»˜è®¤è§£ç ä¸º UTF32</code>çš„äº‹å®ä¸åº”è¯¥é˜»æ­¢ä½ è§£ç ï¼ˆæˆ–ä»¥ä»»ä½•å…¶ä»–æ–¹å¼é‡æ–°ç¼–ç ï¼‰ã€‚</p><p>å…³äºä¸ºä»€ä¹ˆ UTF-8 é€šå¸¸æ¯” UTF-16 æˆ– UTF-32 æ›´å—æ¬¢è¿ï¼Œè¯·é˜…è¯»<a href="http://utf8everywhere.org/"> UTF-8 Everywhere å®£è¨€</a>ã€‚</p><h2 id="æˆ‘åº”è¯¥ä½¿ç”¨ä»€ä¹ˆå­—ç¬¦ä¸²ç±»å‹ï¼Ÿ"><a href="#æˆ‘åº”è¯¥ä½¿ç”¨ä»€ä¹ˆå­—ç¬¦ä¸²ç±»å‹ï¼Ÿ" class="headerlink" title="æˆ‘åº”è¯¥ä½¿ç”¨ä»€ä¹ˆå­—ç¬¦ä¸²ç±»å‹ï¼Ÿ"></a>æˆ‘åº”è¯¥ä½¿ç”¨ä»€ä¹ˆå­—ç¬¦ä¸²ç±»å‹ï¼Ÿ</h2><p>Rust æœ‰å››å¯¹å­—ç¬¦ä¸²ç±»å‹ï¼Œæ¯ä¸€å¯¹éƒ½æœ‰ä¸åŒçš„ç”¨é€”ã€‚åœ¨æ¯ä¸€å¯¹ä¸­ï¼Œéƒ½æœ‰ä¸€ä¸ªâ€œè‡ªæœ‰â€çš„å­—ç¬¦ä¸²ç±»å‹ï¼Œå’Œä¸€ä¸ªâ€œåˆ†ç‰‡â€çš„å­—ç¬¦ä¸²ç±»å‹ã€‚è¿™ä¸ªç»„ç»‡çœ‹èµ·æ¥åƒè¿™æ ·ã€‚</p><table><thead><tr><th align="left"></th><th align="left">â€œSliceâ€ type</th><th align="left">â€œOwnedâ€ type</th></tr></thead><tbody><tr><td align="left">UTF-8</td><td align="left"><code>str</code></td><td align="left"><code>String</code></td></tr><tr><td align="left">OS-compatible</td><td align="left"><code>OsStr</code></td><td align="left"><code>OsString</code></td></tr><tr><td align="left">C-compatible</td><td align="left"><code>CStr</code></td><td align="left"><code>CString</code></td></tr><tr><td align="left">System path</td><td align="left"><code>Path</code></td><td align="left"><code>PathBuf</code></td></tr></tbody></table><p>Rust çš„ä¸åŒå­—ç¬¦ä¸²ç±»å‹æœ‰ä¸åŒçš„ç”¨é€”ã€‚<code>String</code>å’Œ<code>str</code>æ˜¯ UTF-8 ç¼–ç çš„é€šç”¨å­—ç¬¦ä¸²ã€‚<code>OsString</code>å’Œ<code>OsStr</code>æ˜¯æ ¹æ®å½“å‰å¹³å°ç¼–ç çš„ï¼Œåœ¨ä¸æ“ä½œç³»ç»Ÿäº¤äº’æ—¶ä½¿ç”¨ã€‚<code>CString</code>å’Œ<code>CStr</code>ç›¸å½“äºC è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²ï¼Œåœ¨ FFI ä»£ç ä¸­ä½¿ç”¨ã€‚<code>PathBuf</code>å’Œ<code>Path</code>æ˜¯å¯¹<code>OsString</code>å’Œ<code>OsStr</code>çš„æ–¹ä¾¿åŒ…è£…ï¼Œæä¾›ç‰¹å®šäºè·¯å¾„æ“ä½œçš„æ–¹æ³•ã€‚</p><h2 id="æˆ‘æ€æ ·æ‰èƒ½å†™ä¸€ä¸ªæ—¢æ¥å—-amp-stråˆæ¥å—Stringçš„å‡½æ•°"><a href="#æˆ‘æ€æ ·æ‰èƒ½å†™ä¸€ä¸ªæ—¢æ¥å—-amp-stråˆæ¥å—Stringçš„å‡½æ•°" class="headerlink" title="æˆ‘æ€æ ·æ‰èƒ½å†™ä¸€ä¸ªæ—¢æ¥å—&amp;stråˆæ¥å—Stringçš„å‡½æ•°?"></a>æˆ‘æ€æ ·æ‰èƒ½å†™ä¸€ä¸ªæ—¢æ¥å—<code>&amp;str</code>åˆæ¥å—<code>String</code>çš„å‡½æ•°?</h2><p>æœ‰å‡ ç§é€‰æ‹©ï¼Œå–å†³äºå‡½æ•°çš„éœ€è¦ã€‚</p><ul><li>å¦‚æœå‡½æ•°éœ€è¦ä¸€ä¸ªè‡ªæœ‰çš„å­—ç¬¦ä¸²ï¼Œä½†åˆæƒ³æ¥å—ä»»ä½•ç±»å‹çš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ª<code>Into&lt;String&gt;</code>ç»‘å®šã€‚</li><li>å¦‚æœå‡½æ•°éœ€è¦ä¸€ä¸ªå­—ç¬¦ä¸²åˆ†ç‰‡ï¼Œä½†å¸Œæœ›æ¥å—ä»»ä½•ç±»å‹çš„å­—ç¬¦ä¸²ï¼Œä½¿ç”¨<code>AsRef&lt;str&gt;</code>ç»‘å®šã€‚</li><li>å¦‚æœå‡½æ•°ä¸å…³å¿ƒå­—ç¬¦ä¸²çš„ç±»å‹ï¼Œè€Œæƒ³ç»Ÿä¸€å¤„ç†è¿™ä¸¤ç§å¯èƒ½æ€§ï¼Œä½¿ç”¨<code>Cow&lt;str&gt;</code>ä½œä¸ºè¾“å…¥ç±»å‹ã€‚</li></ul><h3 id="ä½¿ç”¨Into-lt-String-gt"><a href="#ä½¿ç”¨Into-lt-String-gt" class="headerlink" title="ä½¿ç”¨Into&lt;String&gt;"></a>ä½¿ç”¨<code>Into&lt;String&gt;</code></h3><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¯¥å‡½æ•°å°†åŒæ—¶æ¥å—è‡ªæœ‰å­—ç¬¦ä¸²å’Œå­—ç¬¦ä¸²ç‰‡ï¼Œè¦ä¹ˆä¸åšä»»ä½•äº‹æƒ…ï¼Œè¦ä¹ˆåœ¨å‡½æ•°ä¸»ä½“å†…å°†è¾“å…¥çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºè‡ªæœ‰å­—ç¬¦ä¸²ã€‚æ³¨æ„ï¼Œè½¬æ¢éœ€è¦æ˜ç¡®è¿›è¡Œï¼Œå¦åˆ™ä¸ä¼šå‘ç”Ÿã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">accepts_both</span></span>&lt;S: <span class="built_in">Into</span>&lt;<span class="built_in">String</span>&gt;&gt;(s: S) &#123;</span><br><span class="line">    <span class="keyword">let</span> s = s.into(); <span class="comment">// è¿™å°†æŠŠ s è½¬æ¢æˆä¸€ä¸ª`String`ã€‚</span></span><br><span class="line">    <span class="comment">// ... å…¶ä½™çš„å‡½æ•°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨AsRef-lt-str-gt"><a href="#ä½¿ç”¨AsRef-lt-str-gt" class="headerlink" title="ä½¿ç”¨AsRef&lt;str&gt;"></a>ä½¿ç”¨<code>AsRef&lt;str&gt;</code></h3><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¯¥å‡½æ•°å°†æ¥å—æ‹¥æœ‰çš„å­—ç¬¦ä¸²å’Œå­—ç¬¦ä¸²ç‰‡æ–­ï¼Œè¦ä¹ˆä¸åšä»»ä½•äº‹æƒ…ï¼Œè¦ä¹ˆå°†è¾“å…¥çš„å­—ç¬¦ä¸²ç‰‡æ–­è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚è¿™å¯ä»¥é€šè¿‡å¼•ç”¨è¾“å…¥æ¥è‡ªåŠ¨å®Œæˆï¼Œåƒè¿™æ ·ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">accepts_both</span></span>&lt;S: <span class="built_in">AsRef</span>&lt;<span class="built_in">str</span>&gt;&gt;(s: &amp;S) &#123;</span><br><span class="line">    <span class="comment">// ... è¯¥å‡½æ•°çš„ä¸»ä½“</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨Cow-lt-str-gt"><a href="#ä½¿ç”¨Cow-lt-str-gt" class="headerlink" title="ä½¿ç”¨Cow&lt;str&gt;"></a>ä½¿ç”¨<code>Cow&lt;str&gt;</code></h3><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå‡½æ•°æ¥æ”¶äº†ä¸€ä¸ª<code>Cow&lt;str&gt;</code>ï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªé€šç”¨ç±»å‹ï¼Œè€Œæ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œæ ¹æ®éœ€è¦åŒ…å«ä¸€ä¸ªè‡ªæœ‰çš„å­—ç¬¦ä¸²æˆ–å­—ç¬¦ä¸²ç‰‡æ–­ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">accepts_cow</span></span>(s: Cow&lt;<span class="built_in">str</span>&gt;) &#123;</span><br><span class="line">    <span class="comment">// ... è¯¥å‡½æ•°çš„ä¸»ä½“</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="é›†åˆ"><a href="#é›†åˆ" class="headerlink" title="é›†åˆ"></a>é›†åˆ</h1><h2 id="æˆ‘å¯ä»¥åœ¨-Rust-ä¸­æœ‰æ•ˆåœ°å®ç°å‘é‡å’Œé“¾è¡¨ç­‰æ•°æ®ç»“æ„å—"><a href="#æˆ‘å¯ä»¥åœ¨-Rust-ä¸­æœ‰æ•ˆåœ°å®ç°å‘é‡å’Œé“¾è¡¨ç­‰æ•°æ®ç»“æ„å—" class="headerlink" title="æˆ‘å¯ä»¥åœ¨ Rust ä¸­æœ‰æ•ˆåœ°å®ç°å‘é‡å’Œé“¾è¡¨ç­‰æ•°æ®ç»“æ„å—?"></a>æˆ‘å¯ä»¥åœ¨ Rust ä¸­æœ‰æ•ˆåœ°å®ç°å‘é‡å’Œé“¾è¡¨ç­‰æ•°æ®ç»“æ„å—?</h2><p>å¦‚æœä½ å®ç°è¿™äº›æ•°æ®ç»“æ„çš„åŸå› æ˜¯ä¸ºäº†åœ¨å…¶ä»–ç¨‹åºä¸­ä½¿ç”¨å®ƒä»¬ï¼Œé‚£å°±æ²¡æœ‰å¿…è¦äº†ï¼Œå› ä¸ºè¿™äº›æ•°æ®ç»“æ„çš„æœ‰æ•ˆå®ç°å·²ç»ç”±æ ‡å‡†åº“æä¾›äº†ã€‚</p><p>ç„¶è€Œï¼Œå¦‚æœ<a href="book-to-many-lists">ä½ çš„ç†ç”±åªæ˜¯ä¸ºäº†å­¦ä¹ </a>ï¼Œé‚£ä¹ˆä½ å¾ˆå¯èƒ½éœ€è¦æ¶‰è¶³ä¸å®‰å…¨ä»£ç ã€‚è™½ç„¶è¿™äº›æ•°æ®ç»“æ„å¯ä»¥å®Œå…¨ç”¨å®‰å…¨çš„ Rust æ¥å®ç°ï¼Œä½†å…¶æ€§èƒ½å¯èƒ½ä¼šæ¯”ä½¿ç”¨ä¸å®‰å…¨çš„ä»£ç è¦å·®ã€‚åŸå› å¾ˆç®€å•ï¼Œå‘é‡å’Œé“¾æ¥åˆ—è¡¨ç­‰æ•°æ®ç»“æ„ä¾èµ–äºæŒ‡é’ˆå’Œå†…å­˜æ“ä½œï¼Œè€Œè¿™äº›æ“ä½œåœ¨å®‰å…¨ Rust ä¸­æ˜¯ä¸å…è®¸çš„ã€‚</p><p>ä¾‹å¦‚ï¼Œä¸€ä¸ªåŒé“¾æ¥åˆ—è¡¨éœ€è¦å¯¹æ¯ä¸ªèŠ‚ç‚¹æœ‰ä¸¤ä¸ªå¯å˜å¼•ç”¨ï¼Œä½†è¿™è¿åäº† Rust çš„å¯å˜å¼•ç”¨åˆ«åè§„åˆ™ã€‚ä½ å¯ä»¥ç”¨<a href="https://doc.rust-lang.org/std/rc/struct.Weak.html"><code>Weak&lt;T&gt;</code></a>æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯æ€§èƒ½ä¼šæ¯”ä½ æƒ³è¦çš„å·®ã€‚ä½¿ç”¨ä¸å®‰å…¨çš„ä»£ç ï¼Œä½ å¯ä»¥ç»•è¿‡å¯å˜å¼•ç”¨åˆ«åè§„åˆ™çš„é™åˆ¶ï¼Œä½†å¿…é¡»æ‰‹åŠ¨éªŒè¯ä½ çš„ä»£ç æ˜¯å¦å¼•å…¥äº†å†…å­˜å®‰å…¨è¿è§„ã€‚</p><h2 id="æˆ‘æ€æ ·æ‰èƒ½åœ¨ä¸ç§»åŠ¨-æ¶ˆè€—é›†åˆçš„æƒ…å†µä¸‹å¯¹å…¶è¿›è¡Œè¿­ä»£ï¼Ÿ"><a href="#æˆ‘æ€æ ·æ‰èƒ½åœ¨ä¸ç§»åŠ¨-æ¶ˆè€—é›†åˆçš„æƒ…å†µä¸‹å¯¹å…¶è¿›è¡Œè¿­ä»£ï¼Ÿ" class="headerlink" title="æˆ‘æ€æ ·æ‰èƒ½åœ¨ä¸ç§»åŠ¨/æ¶ˆè€—é›†åˆçš„æƒ…å†µä¸‹å¯¹å…¶è¿›è¡Œè¿­ä»£ï¼Ÿ"></a>æˆ‘æ€æ ·æ‰èƒ½åœ¨ä¸ç§»åŠ¨/æ¶ˆè€—é›†åˆçš„æƒ…å†µä¸‹å¯¹å…¶è¿›è¡Œè¿­ä»£ï¼Ÿ</h2><p>æœ€ç®€å•çš„æ–¹æ³•æ˜¯é€šè¿‡ä½¿ç”¨é›†åˆçš„<a href="https://doc.rust-lang.org/std/iter/trait.IntoIterator.html"><code>IntoIterator</code></a>å®ç°ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå…³äº<a href="https://doc.rust-lang.org/std/vec/struct.Vec.html"><code>&amp;Vec</code></a>çš„ä¾‹å­ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> v = <span class="built_in">vec!</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>];</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> &amp;v &#123;</span><br><span class="line">    <span class="built_in">print!</span> (<span class="string">&quot;&#123;&#125; &quot;</span>, item);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">println!</span> (<span class="string">&quot;\nLength: &#123;&#125;&quot;</span>, v.len());</span><br></pre></td></tr></table></figure><p>Rust çš„<code>for</code>å¾ªç¯å¯¹å®ƒä»¬è¦è¿­ä»£çš„ä¸œè¥¿è°ƒç”¨<code>into_iter()</code>ï¼ˆå®šä¹‰åœ¨<a href="https://doc.rust-lang.org/std/iter/trait.IntoIterator.html"><code>IntoIterator</code></a>trait ä¸Šï¼‰ã€‚ä»»ä½•å®ç°äº†<a href="https://doc.rust-lang.org/std/iter/trait.IntoIterator.html"><code>IntoIterator</code></a>trait çš„ä¸œè¥¿éƒ½å¯ä»¥ç”¨<code>for</code>å¾ªç¯è¿›è¡Œå¾ªç¯ã€‚<a href="https://doc.rust-lang.org/std/iter/trait.IntoIterator.html"><code>IntoIterator</code></a>æ˜¯ä¸º<a href="https://doc.rust-lang.org/std/vec/struct.Vec.html"><code>&amp;Vec</code></a>å’Œ<a href="https://doc.rust-lang.org/std/vec/struct.Vec.html"><code>&amp;mut Vec</code></a>å®ç°çš„ï¼Œå¯¼è‡´æ¥è‡ª<code>into_iter()</code>çš„è¿­ä»£å™¨å€Ÿç”¨é›†åˆçš„å†…å®¹ï¼Œè€Œä¸æ˜¯ç§»åŠ¨/æ¶ˆè´¹å®ƒä»¬ã€‚è¿™å¯¹å…¶ä»–æ ‡å‡†é›†åˆä¹Ÿæ˜¯å¦‚æ­¤ã€‚</p><p>å¦‚æœéœ€è¦ä¸€ä¸ªç§»åŠ¨/æ¶ˆè€—çš„è¿­ä»£å™¨ï¼Œç¼–å†™<code>for</code>å¾ªç¯æ—¶ä¸è¦åœ¨è¿­ä»£ä¸­ä½¿ç”¨<code>&amp;</code>æˆ–<code>&amp;mut</code>ã€‚</p><p>å¦‚æœä½ éœ€è¦ç›´æ¥è®¿é—®ä¸€ä¸ªå€Ÿç”¨çš„è¿­ä»£å™¨ï¼Œä½ é€šå¸¸å¯ä»¥é€šè¿‡è°ƒç”¨<code>iter()</code>æ–¹æ³•å¾—åˆ°å®ƒã€‚</p><h2 id="ä¸ºä»€ä¹ˆæˆ‘éœ€è¦åœ¨æ•°ç»„å£°æ˜ä¸­è¾“å…¥æ•°ç»„å¤§å°"><a href="#ä¸ºä»€ä¹ˆæˆ‘éœ€è¦åœ¨æ•°ç»„å£°æ˜ä¸­è¾“å…¥æ•°ç»„å¤§å°" class="headerlink" title="ä¸ºä»€ä¹ˆæˆ‘éœ€è¦åœ¨æ•°ç»„å£°æ˜ä¸­è¾“å…¥æ•°ç»„å¤§å°?"></a>ä¸ºä»€ä¹ˆæˆ‘éœ€è¦åœ¨æ•°ç»„å£°æ˜ä¸­è¾“å…¥æ•°ç»„å¤§å°?</h2><p>ä½ ä¸ä¸€å®šè¦è¿™æ ·åšã€‚å¦‚æœä½ ç›´æ¥å£°æ˜ä¸€ä¸ªæ•°ç»„ï¼Œå¤§å°æ˜¯æ ¹æ®å…ƒç´ çš„æ•°é‡æ¨æ–­å‡ºæ¥çš„ã€‚ä½†æ˜¯å¦‚æœä½ å£°æ˜çš„æ˜¯ä¸€ä¸ªæ¥æ”¶å›ºå®šå¤§å°çš„æ•°ç»„çš„å‡½æ•°ï¼Œç¼–è¯‘å™¨å°±å¿…é¡»çŸ¥é“è¿™ä¸ªæ•°ç»„æœ‰å¤šå¤§ã€‚</p><p>æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç›®å‰ Rust å¹¶æ²¡æœ‰å¯¹ä¸åŒå¤§å°çš„æ•°ç»„æä¾›æ³›å‹ã€‚å¦‚æœä½ æƒ³æ¥å—ä¸€ä¸ªè¿ç»­çš„å¯å˜æ•°é‡çš„å€¼çš„å®¹å™¨ï¼Œä½¿ç”¨<a href="https://doc.rust-lang.org/std/vec/struct.Vec.html"><code>Vec</code></a>æˆ– sliceï¼ˆå–å†³äºä½ æ˜¯å¦éœ€è¦æ‰€æœ‰æƒï¼‰ã€‚</p><h1 id="æ‰€æœ‰æƒ"><a href="#æ‰€æœ‰æƒ" class="headerlink" title="æ‰€æœ‰æƒ"></a>æ‰€æœ‰æƒ</h1><h2 id="æˆ‘æ€æ ·æ‰èƒ½å®ç°ä¸€ä¸ªåŒ…å«ç¯çš„å›¾æˆ–å…¶ä»–æ•°æ®ç»“æ„"><a href="#æˆ‘æ€æ ·æ‰èƒ½å®ç°ä¸€ä¸ªåŒ…å«ç¯çš„å›¾æˆ–å…¶ä»–æ•°æ®ç»“æ„" class="headerlink" title="æˆ‘æ€æ ·æ‰èƒ½å®ç°ä¸€ä¸ªåŒ…å«ç¯çš„å›¾æˆ–å…¶ä»–æ•°æ®ç»“æ„?"></a>æˆ‘æ€æ ·æ‰èƒ½å®ç°ä¸€ä¸ªåŒ…å«ç¯çš„å›¾æˆ–å…¶ä»–æ•°æ®ç»“æ„?</h2><p>è‡³å°‘æœ‰å››ç§é€‰æ‹©ï¼ˆåœ¨<a href="https://rust-unofficial.github.io/too-many-lists/">Too Many Linked Lists</a>ä¸­è¯¦ç»†è®¨è®ºè¿‡ï¼‰ã€‚</p><ul><li>ä½ å¯ä»¥ä½¿ç”¨<a href="https://doc.rust-lang.org/std/rc/struct.Rc.html"><code>Rc</code></a>å’Œ<a href="https://doc.rust-lang.org/std/rc/struct.Weak.html"><code>Weak</code></a>å®ç°å®ƒï¼Œä»¥å…è®¸èŠ‚ç‚¹çš„å…±äº«æ‰€æœ‰æƒã€‚å°½ç®¡è¿™ç§æ–¹æ³•éœ€è¦ä»˜å‡ºå†…å­˜ç®¡ç†çš„ä»£ä»·ã€‚</li><li>ä½ å¯ä»¥ä½¿ç”¨â€œä¸å®‰å…¨â€çš„ä»£ç å®ç°å®ƒï¼Œä½¿ç”¨åŸå§‹æŒ‡é’ˆã€‚è¿™å°†æ›´åŠ é«˜æ•ˆï¼Œä½†å´ç»•è¿‡äº† Rust çš„å®‰å…¨ä¿è¯ã€‚</li><li>ä½¿ç”¨å‘é‡å’Œè¿™äº›å‘é‡çš„ç´¢å¼•ã€‚æœ‰<a href="http://smallcultfollowing.com/babysteps/blog/2015/04/06/modeling-graphs-in-rust-using-vector-indices/">å‡ ä¸ª</a><a href="https://featherweightmusings.blogspot.com/2015/04/graphs-in-rust.html">å¯ç”¨</a>è¿™ç§æ–¹æ³•çš„ä¾‹å­å’Œè§£é‡Šã€‚</li><li>ç”¨<a href="https://doc.rust-lang.org/std/cell/struct.UnsafeCell.html"><code>UnsafeCell</code></a>ä½¿ç”¨å€Ÿç”¨çš„å¼•ç”¨ã€‚å¯¹äºè¿™ç§æ–¹æ³•æœ‰<a href="https://github.com/nrc/r4cppp/blob/master/graphs/README.md#node-and-unsafecell">è§£é‡Šå’Œä»£ç </a>ã€‚</li></ul><h2 id="æˆ‘æ€æ ·æ‰èƒ½å®šä¹‰ä¸€ä¸ªåŒ…å«å¯¹å…¶è‡ªèº«å­—æ®µä¹‹ä¸€çš„å¼•ç”¨çš„ç»“æ„ï¼Ÿ"><a href="#æˆ‘æ€æ ·æ‰èƒ½å®šä¹‰ä¸€ä¸ªåŒ…å«å¯¹å…¶è‡ªèº«å­—æ®µä¹‹ä¸€çš„å¼•ç”¨çš„ç»“æ„ï¼Ÿ" class="headerlink" title="æˆ‘æ€æ ·æ‰èƒ½å®šä¹‰ä¸€ä¸ªåŒ…å«å¯¹å…¶è‡ªèº«å­—æ®µä¹‹ä¸€çš„å¼•ç”¨çš„ç»“æ„ï¼Ÿ"></a>æˆ‘æ€æ ·æ‰èƒ½å®šä¹‰ä¸€ä¸ªåŒ…å«å¯¹å…¶è‡ªèº«å­—æ®µä¹‹ä¸€çš„å¼•ç”¨çš„ç»“æ„ï¼Ÿ</h2><p>è¿™æ˜¯æœ‰å¯èƒ½çš„ï¼Œä½†æ˜¯è¿™æ ·åšæ²¡æœ‰ç”¨ã€‚è¯¥ç»“æ„ä¼šè¢«è‡ªå·±æ°¸ä¹…å€Ÿç”¨ï¼Œå› æ­¤ä¸èƒ½è¢«ç§»åŠ¨ã€‚ä¸‹é¢æ˜¯ä¸€äº›è¯´æ˜è¿™ä¸ªé—®é¢˜çš„ä»£ç ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::cell::Cell;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Unmovable</span></span>&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    x: <span class="built_in">u32</span>,</span><br><span class="line">    y: Cell&lt;<span class="built_in">Option</span>&lt;&amp;<span class="symbol">&#x27;a</span> <span class="built_in">u32</span>&gt;&gt;ã€‚</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> test = Unmovable &#123; x: <span class="number">42</span>, y: Cell::new(<span class="literal">None</span>) &#125;ã€‚</span><br><span class="line">    test.y.set(<span class="literal">Some</span>(&amp;test.x))ã€‚</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span> (<span class="string">&quot;&#123;:?&#125;&quot;</span>, test);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æŒ‰å€¼ä¼ é€’ã€æ¶ˆè€—ã€ç§»åŠ¨å’Œè½¬ç§»æ‰€æœ‰æƒä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«"><a href="#æŒ‰å€¼ä¼ é€’ã€æ¶ˆè€—ã€ç§»åŠ¨å’Œè½¬ç§»æ‰€æœ‰æƒä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«" class="headerlink" title="æŒ‰å€¼ä¼ é€’ã€æ¶ˆè€—ã€ç§»åŠ¨å’Œè½¬ç§»æ‰€æœ‰æƒä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«?"></a>æŒ‰å€¼ä¼ é€’ã€æ¶ˆè€—ã€ç§»åŠ¨å’Œè½¬ç§»æ‰€æœ‰æƒä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«?</h2><p>è¿™äº›æ˜¯åŒä¸€äº‹ç‰©çš„ä¸åŒæœ¯è¯­ã€‚åœ¨æ‰€æœ‰çš„æƒ…å†µä¸‹ï¼Œè¿™æ„å‘³ç€å€¼å·²ç»è¢«è½¬ç§»åˆ°å¦ä¸€ä¸ªæ‰€æœ‰è€…é‚£é‡Œï¼Œå¹¶ä¸”è„±ç¦»äº†åŸæ‰€æœ‰è€…çš„å æœ‰ï¼ŒåŸæ‰€æœ‰è€…ä¸èƒ½å†ä½¿ç”¨å®ƒã€‚å¦‚æœä¸€ä¸ªç±»å‹å®ç°äº†<code>Copy</code>ç‰¹æ€§ï¼Œé‚£ä¹ˆåŸæ‰€æœ‰è€…çš„å€¼å°±ä¸ä¼šè¢«åºŸæ­¢ï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨ã€‚</p><h2 id="ä¸ºä»€ä¹ˆæŸäº›ç±»å‹çš„å€¼åœ¨ä¼ é€’ç»™ä¸€ä¸ªå‡½æ•°åå¯ä»¥ä½¿ç”¨ï¼Œè€Œé‡å¤ä½¿ç”¨å…¶ä»–ç±»å‹çš„å€¼ä¼šå¯¼è‡´é”™è¯¯ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆæŸäº›ç±»å‹çš„å€¼åœ¨ä¼ é€’ç»™ä¸€ä¸ªå‡½æ•°åå¯ä»¥ä½¿ç”¨ï¼Œè€Œé‡å¤ä½¿ç”¨å…¶ä»–ç±»å‹çš„å€¼ä¼šå¯¼è‡´é”™è¯¯ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆæŸäº›ç±»å‹çš„å€¼åœ¨ä¼ é€’ç»™ä¸€ä¸ªå‡½æ•°åå¯ä»¥ä½¿ç”¨ï¼Œè€Œé‡å¤ä½¿ç”¨å…¶ä»–ç±»å‹çš„å€¼ä¼šå¯¼è‡´é”™è¯¯ï¼Ÿ"></a>ä¸ºä»€ä¹ˆæŸäº›ç±»å‹çš„å€¼åœ¨ä¼ é€’ç»™ä¸€ä¸ªå‡½æ•°åå¯ä»¥ä½¿ç”¨ï¼Œè€Œé‡å¤ä½¿ç”¨å…¶ä»–ç±»å‹çš„å€¼ä¼šå¯¼è‡´é”™è¯¯ï¼Ÿ</h2><p>å¦‚æœä¸€ä¸ªç±»å‹å®ç°äº†<a href="https://doc.rust-lang.org/std/marker/trait.Copy.html"><code>Copy</code></a>ç‰¹æ€§ï¼Œé‚£ä¹ˆå®ƒåœ¨ä¼ é€’ç»™å‡½æ•°æ—¶å°±ä¼šè¢«å¤åˆ¶ã€‚Rust ä¸­çš„æ‰€æœ‰æ•°å­—ç±»å‹éƒ½å®ç°äº†<a href="https://doc.rust-lang.org/std/marker/trait.Copy.html"><code>Copy</code></a>ï¼Œä½†ç»“æ„ç±»å‹é»˜è®¤ä¸å®ç°<a href="https://doc.rust-lang.org/std/marker/trait.Copy.html"><code>Copy</code></a>ï¼Œæ‰€ä»¥å®ƒä»¬è¢«ç§»åŠ¨ã€‚è¿™æ„å‘³ç€è¯¥ç»“æ„ä¸èƒ½å†è¢«ç”¨äºå…¶ä»–åœ°æ–¹ï¼Œé™¤éé€šè¿‡è¿”å›å°†å…¶ç§»å›å‡½æ•°ä¹‹å¤–ã€‚</p><h2 id="å¦‚ä½•å¤„ç†â€œuse-of-moved-valueâ€çš„é”™è¯¯ï¼Ÿ"><a href="#å¦‚ä½•å¤„ç†â€œuse-of-moved-valueâ€çš„é”™è¯¯ï¼Ÿ" class="headerlink" title="å¦‚ä½•å¤„ç†â€œuse of moved valueâ€çš„é”™è¯¯ï¼Ÿ"></a>å¦‚ä½•å¤„ç†â€œuse of moved valueâ€çš„é”™è¯¯ï¼Ÿ</h2><p>è¿™ä¸ªé”™è¯¯æ„å‘³ç€ä½ è¦ä½¿ç”¨çš„å€¼å·²ç»è¢«è½¬ç§»åˆ°ä¸€ä¸ªæ–°çš„æ‰€æœ‰è€…é‚£é‡Œã€‚é¦–å…ˆè¦æ£€æŸ¥çš„æ˜¯æœ‰å…³çš„ç§»åŠ¨æ˜¯å¦æ˜¯å¿…è¦çš„ï¼šå¦‚æœå®ƒç§»åŠ¨åˆ°ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œä¹Ÿè®¸å¯ä»¥é‡å†™è¯¥å‡½æ•°ä»¥ä½¿ç”¨ä¸€ä¸ªå¼•ç”¨ï¼Œè€Œä¸æ˜¯ç§»åŠ¨ã€‚å¦åˆ™ï¼Œå¦‚æœè¢«ç§»åŠ¨çš„ç±»å‹å®ç°äº†<a href="https://doc.rust-lang.org/std/clone/trait.Clone.html"><code>Clone</code></a>ï¼Œé‚£ä¹ˆåœ¨ç§»åŠ¨å‰å¯¹å…¶è°ƒç”¨<code>clone()</code>å°†ç§»åŠ¨å®ƒçš„ä¸€ä¸ªå‰¯æœ¬ï¼Œç•™ä¸‹åŸå§‹çš„ä»ç„¶å¯ä»¥ç»§ç»­ä½¿ç”¨ã€‚ä½†æ˜¯è¯·æ³¨æ„ï¼Œå…‹éš†ä¸€ä¸ªå€¼é€šå¸¸åº”è¯¥æ˜¯æœ€åçš„æ‰‹æ®µï¼Œå› ä¸ºå…‹éš†å¯èƒ½å¾ˆæ˜‚è´µï¼Œä¼šå¯¼è‡´è¿›ä¸€æ­¥çš„åˆ†é…ã€‚</p><p>å¦‚æœç§»åŠ¨çš„å€¼æ˜¯ä½ è‡ªå·±çš„è‡ªå®šä¹‰ç±»å‹ï¼Œè€ƒè™‘å®ç°<a href="https://doc.rust-lang.org/std/marker/trait.Copy.html"><code>Copy</code></a>ï¼ˆç”¨äºéšå¼å¤åˆ¶ï¼Œè€Œä¸æ˜¯ç§»åŠ¨ï¼‰æˆ–<a href="https://doc.rust-lang.org/std/clone/trait.Clone.html"><code>Clone</code></a>ï¼ˆæ˜¾å¼å¤åˆ¶ï¼‰ã€‚<a href="https://doc.rust-lang.org/std/marker/trait.Copy.html"><code>Copy</code></a>æœ€å¸¸ç”¨çš„å®ç°æ–¹å¼æ˜¯<code>#[derive(Copy, Clone)]</code>ï¼ˆ<a href="https://doc.rust-lang.org/std/marker/trait.Copy.html"><code>Copy</code></a>éœ€è¦<a href="https://doc.rust-lang.org/std/clone/trait.Clone.html"><code>Clone</code></a>ï¼‰ï¼Œè€Œ<a href="https://doc.rust-lang.org/std/clone/trait.Clone.html"><code>Clone</code></a>åˆ™æ˜¯`#[derive(Clone)]ã€‚</p><p>å¦‚æœè¿™äº›éƒ½ä¸å¯èƒ½ï¼Œä½ å¯èƒ½æƒ³ä¿®æ”¹è·å¾—æ‰€æœ‰æƒçš„å‡½æ•°ï¼Œä»¥ä¾¿åœ¨å‡½æ•°é€€å‡ºæ—¶è¿”å›æ•°å€¼çš„æ‰€æœ‰æƒã€‚</p><h2 id="åœ¨æ–¹æ³•å£°æ˜ä¸­ä½¿ç”¨selfã€-amp-selfæˆ–-amp-mut-selfçš„è§„åˆ™æ˜¯ä»€ä¹ˆ"><a href="#åœ¨æ–¹æ³•å£°æ˜ä¸­ä½¿ç”¨selfã€-amp-selfæˆ–-amp-mut-selfçš„è§„åˆ™æ˜¯ä»€ä¹ˆ" class="headerlink" title="åœ¨æ–¹æ³•å£°æ˜ä¸­ä½¿ç”¨selfã€&amp;selfæˆ–&amp;mut selfçš„è§„åˆ™æ˜¯ä»€ä¹ˆ?"></a>åœ¨æ–¹æ³•å£°æ˜ä¸­ä½¿ç”¨<code>self</code>ã€<code>&amp;self</code>æˆ–<code>&amp;mut self</code>çš„è§„åˆ™æ˜¯ä»€ä¹ˆ?</h2><ul><li>å½“ä¸€ä¸ªå‡½æ•°éœ€è¦æ¶ˆè€—å€¼çš„æ—¶å€™ï¼Œä½¿ç”¨<code>self</code>ã€‚</li><li>å½“ä¸€ä¸ªå‡½æ•°åªéœ€è¦ä¸€ä¸ªå¯¹å€¼çš„åªè¯»å¼•ç”¨æ—¶ï¼Œä½¿ç”¨<code>&amp;self</code>ã€‚</li><li>å½“ä¸€ä¸ªå‡½æ•°éœ€è¦åœ¨ä¸æ¶ˆè€—è¯¥å€¼çš„æƒ…å†µä¸‹æ”¹å˜è¯¥å€¼æ—¶ï¼Œä½¿ç”¨<code>&amp;mut self</code>ã€‚</li></ul><h2 id="æˆ‘æ€æ ·æ‰èƒ½ç†è§£å€Ÿç”¨æ£€æŸ¥å™¨ï¼Ÿ"><a href="#æˆ‘æ€æ ·æ‰èƒ½ç†è§£å€Ÿç”¨æ£€æŸ¥å™¨ï¼Ÿ" class="headerlink" title="æˆ‘æ€æ ·æ‰èƒ½ç†è§£å€Ÿç”¨æ£€æŸ¥å™¨ï¼Ÿ"></a>æˆ‘æ€æ ·æ‰èƒ½ç†è§£å€Ÿç”¨æ£€æŸ¥å™¨ï¼Ÿ</h2><p>å€Ÿç”¨æ£€æŸ¥å™¨åœ¨è¯„ä¼° Rust ä»£ç æ—¶åªåº”ç”¨ä¸€äº›è§„åˆ™ï¼Œè¿™äº›è§„åˆ™å¯ä»¥åœ¨ Rust ä¹¦çš„<a href="https://doc.rust-lang.org/book/ch15-02-deref.html">å€Ÿç”¨éƒ¨åˆ†</a>ä¸­æ‰¾åˆ°ã€‚è¿™äº›è§„åˆ™æ˜¯ï¼š</p><blockquote><p>é¦–å…ˆï¼Œä»»ä½•å€Ÿç”¨å¿…é¡»æŒç»­çš„èŒƒå›´ä¸å¤§äºæ‰€æœ‰è€…çš„èŒƒå›´ã€‚ç¬¬äºŒï¼Œä½ å¯ä»¥æœ‰è¿™ä¸¤ç§å€Ÿç”¨ä¸­çš„ä¸€ç§æˆ–å¦ä¸€ç§ï¼Œä½†ä¸èƒ½åŒæ—¶å­˜åœ¨ï¼š</p><ul><li>å¯¹ä¸€ä¸ªèµ„æºçš„ä¸€ä¸ªæˆ–å¤šä¸ªå¼•ç”¨ï¼ˆ&amp;Tï¼‰ã€‚</li><li>ä¸€ä¸ªå¯å˜çš„å¼•ç”¨ï¼ˆ&amp;mut Tï¼‰ã€‚</li></ul></blockquote><p>è™½ç„¶è¿™äº›è§„åˆ™æœ¬èº«å¾ˆç®€å•ï¼Œä½†æŒç»­åœ°éµå®ˆè¿™äº›è§„åˆ™å¹¶ä¸å®¹æ˜“ï¼Œç‰¹åˆ«æ˜¯å¯¹äºé‚£äº›ä¸ä¹ æƒ¯æ¨ç†å¯¿å‘½å’Œæ‰€æœ‰æƒçš„äººæ¥è¯´ã€‚</p><p>äº†è§£å€Ÿç”¨æ£€æŸ¥å™¨çš„ç¬¬ä¸€æ­¥æ˜¯é˜…è¯»å®ƒäº§ç”Ÿçš„é”™è¯¯ã€‚ä¸ºäº†ç¡®ä¿å€Ÿç”¨æ£€æŸ¥å™¨åœ¨è§£å†³å®ƒæ‰€å‘ç°çš„é—®é¢˜æ–¹é¢æä¾›é«˜è´¨é‡çš„å¸®åŠ©ï¼Œæˆ‘ä»¬åšäº†å¤§é‡çš„å·¥ä½œã€‚å½“ä½ é‡åˆ°å€Ÿç”¨æ£€æŸ¥å™¨çš„é—®é¢˜æ—¶ï¼Œç¬¬ä¸€æ­¥æ˜¯æ…¢æ…¢åœ°ã€ä»”ç»†åœ°é˜…è¯»æ‰€æŠ¥å‘Šçš„é”™è¯¯ï¼Œåªæœ‰åœ¨ç†è§£äº†æ‰€æè¿°çš„é”™è¯¯ä¹‹åï¼Œæ‰èƒ½æ¥è¿‘ä»£ç ã€‚</p><p>ç¬¬äºŒæ­¥æ˜¯ç†Ÿæ‚‰ Rust æ ‡å‡†åº“æä¾›çš„æ‰€æœ‰æƒå’Œå¯å˜æ€§ç›¸å…³çš„å®¹å™¨ç±»å‹ï¼ŒåŒ…æ‹¬<a href="https://doc.rust-lang.org/std/cell/struct.Cell.html"><code>Cell</code></a>ã€<a href="https://doc.rust-lang.org/std/cell/struct.RefCell.html"><code>RefCell</code></a>å’Œ<a href="https://doc.rust-lang.org/std/borrow/enum.Cow.html"><code>Cow</code></a>ã€‚è¿™äº›éƒ½æ˜¯è¡¨è¾¾æŸäº›æ‰€æœ‰æƒå’Œå¯å˜æ€§æƒ…å†µçš„æœ‰ç”¨å’Œå¿…è¦çš„å·¥å…·ï¼Œå¹¶ä¸”è¢«å†™æˆæ€§èƒ½ä»£ä»·æœ€å°ã€‚</p><p>ç†è§£å€Ÿç”¨æ£€æŸ¥å™¨æœ€é‡è¦çš„ä¸€ä¸ªéƒ¨åˆ†æ˜¯å®è·µã€‚Rust çš„å¼ºé™æ€åˆ†æä¿è¯æ˜¯ä¸¥æ ¼çš„ï¼Œä¸è®¸å¤šç¨‹åºå‘˜ä¹‹å‰çš„å·¥ä½œæœ‰å¾ˆå¤§ä¸åŒã€‚éœ€è¦ä¸€äº›æ—¶é—´æ‰èƒ½å®Œå…¨é€‚åº”ä¸€åˆ‡ã€‚</p><p>å¦‚æœä½ å‘ç°è‡ªå·±åœ¨å€Ÿç”¨æ£€æŸ¥å™¨ä¸ŠæŒ£æ‰ï¼Œæˆ–è€…æ²¡æœ‰è€å¿ƒäº†ï¼Œè¯·éšæ—¶è”ç³»<a href="https://www.rust-lang.org/community"> Rust ç¤¾åŒº</a>å¯»æ±‚å¸®åŠ©ã€‚</p><h2 id="ä»€ä¹ˆæ—¶å€™Rcæœ‰ç”¨ï¼Ÿ"><a href="#ä»€ä¹ˆæ—¶å€™Rcæœ‰ç”¨ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ—¶å€™Rcæœ‰ç”¨ï¼Ÿ"></a>ä»€ä¹ˆæ—¶å€™<code>Rc</code>æœ‰ç”¨ï¼Ÿ</h2><p>è¿™åœ¨<a href="https://doc.rust-lang.org/std/rc/struct.Rc.html"><code>Rc</code></a>çš„å®˜æ–¹æ–‡æ¡£ä¸­æœ‰æ‰€æ¶‰åŠï¼ŒRust çš„éåŸå­å¼•ç”¨è®¡ç®—çš„æŒ‡é’ˆç±»å‹ã€‚ç®€è€Œè¨€ä¹‹ï¼Œ<a href="https://doc.rust-lang.org/std/rc/struct.Rc.html"><code>Rc</code></a>å’Œå®ƒçš„çº¿ç¨‹å®‰å…¨è¡¨äº²<a href="https://doc.rust-lang.org/std/sync/struct.Arc.html"><code>Arc</code></a>å¯¹äºè¡¨è¾¾å…±äº«æ‰€æœ‰æƒæ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œå½“æ²¡æœ‰äººè®¿é—®ç›¸å…³å†…å­˜æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†å…¶å–æ¶ˆã€‚</p><h2 id="æˆ‘å¦‚ä½•ä»ä¸€ä¸ªå‡½æ•°ä¸­è¿”å›ä¸€ä¸ªé—­åŒ…ï¼Ÿ"><a href="#æˆ‘å¦‚ä½•ä»ä¸€ä¸ªå‡½æ•°ä¸­è¿”å›ä¸€ä¸ªé—­åŒ…ï¼Ÿ" class="headerlink" title="æˆ‘å¦‚ä½•ä»ä¸€ä¸ªå‡½æ•°ä¸­è¿”å›ä¸€ä¸ªé—­åŒ…ï¼Ÿ"></a>æˆ‘å¦‚ä½•ä»ä¸€ä¸ªå‡½æ•°ä¸­è¿”å›ä¸€ä¸ªé—­åŒ…ï¼Ÿ</h2><p>è¦ä»ä¸€ä¸ªå‡½æ•°ä¸­è¿”å›ä¸€ä¸ªé—­åŒ…ï¼Œå®ƒå¿…é¡»æ˜¯ä¸€ä¸ªâ€œç§»åŠ¨é—­åŒ…â€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œé—­åŒ…æ˜¯ç”¨<code>move</code>å…³é”®å­—å£°æ˜çš„ã€‚æ­£å¦‚<a href="https://doc.rust-lang.org/book/ch13-01-closures.html"> Rust ä¹¦ä¸­æ‰€è§£é‡Šçš„</a>ï¼Œè¿™ä½¿å¾—é—­åŒ…æ‹¥æœ‰è‡ªå·±çš„æ•è·å˜é‡çš„å‰¯æœ¬ï¼Œç‹¬ç«‹äºå…¶çˆ¶çº§å †æ ˆæ¡†æ¶ã€‚å¦åˆ™ï¼Œè¿”å›ä¸€ä¸ªé—­åŒ…å°†æ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºå®ƒå°†å…è®¸è®¿é—®ä¸å†æœ‰æ•ˆçš„å˜é‡ï¼›æ¢å¥è¯è¯´ï¼šå®ƒå°†å…è®¸è¯»å–å¯èƒ½æ— æ•ˆçš„å†…å­˜ã€‚é—­åŒ…è¿˜å¿…é¡»è¢«åŒ…è£¹åœ¨ä¸€ä¸ª<a href="https://doc.rust-lang.org/std/boxed/struct.Box.html"><code>Box</code></a>ä¸­ï¼Œè¿™æ ·å®ƒå°±è¢«åˆ†é…åœ¨å †ä¸Šã€‚é˜…è¯»æ›´å¤šå…³äºè¿™ä¸ªçš„å†…å®¹<a href="https://doc.rust-lang.org/book/ch13-01-closures.html">åœ¨ä¹¦ä¸­</a>ã€‚</p><h2 id="ä»€ä¹ˆæ˜¯-deref-coercionï¼Œå®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯-deref-coercionï¼Œå®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ deref coercionï¼Œå®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ deref coercionï¼Œå®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ</h2><p><a href="https://doc.rust-lang.org/book/ch15-02-deref.html">deref coercion</a> æ˜¯ä¸€ä¸ªå¾ˆæ–¹ä¾¿çš„ coercionã€‚è‡ªåŠ¨å°†å¯¹æŒ‡é’ˆçš„å¼•ç”¨(ä¾‹å¦‚, <code>&amp;Rc&lt;T&gt;</code> æˆ– <code>&amp;Box&lt;T&gt;</code>)è½¬æ¢ä¸ºå¯¹å…¶å†…å®¹çš„å¼•ç”¨ï¼ˆä¾‹å¦‚ï¼Œ<code>&amp;T</code>ï¼‰ã€‚Deref coercion çš„å­˜åœ¨æ˜¯ä¸ºäº†ä½¿ Rust çš„ä½¿ç”¨æ›´ç¬¦åˆäººä½“å·¥ç¨‹å­¦ï¼Œå¹¶é€šè¿‡<a href="https://doc.rust-lang.org/std/ops/trait.Deref.html"><code>Deref</code></a>ç‰¹æ€§å®ç°ã€‚</p><p>Deref çš„å®ç°è¡¨æ˜å®ç°ç±»å‹å¯ä»¥é€šè¿‡è°ƒç”¨<code>deref</code>æ–¹æ³•è½¬æ¢ä¸ºç›®æ ‡ç±»å‹ï¼Œè¯¥æ–¹æ³•æ¥æ”¶å¯¹è°ƒç”¨ç±»å‹çš„ä¸å¯å˜çš„å¼•ç”¨ï¼Œå¹¶è¿”å›å¯¹ç›®æ ‡ç±»å‹çš„å¼•ç”¨ï¼ˆå…·æœ‰ç›¸åŒçš„ç”Ÿå‘½å‘¨æœŸï¼‰ã€‚<code>*</code>å‰ç¼€æ“ä½œç¬¦æ˜¯<code>deref</code>æ–¹æ³•çš„ç®€å†™ã€‚</p><p>å®ƒä»¬è¢«ç§°â€œcoercionsâ€ï¼Œå› ä¸ºä¸‹é¢çš„è§„åˆ™ï¼Œè¿™é‡Œå¼•ç”¨äº†<a href="https://doc.rust-lang.org/book/ch15-02-deref.html"> Rust ä¹¦</a>ã€‚</p><blockquote><p>å¦‚æœä½ æœ‰ä¸€ä¸ªç±»å‹<code>U</code>ï¼Œå¹¶ä¸”å®ƒå®ç°äº†<code>Deref&lt;Target=T&gt;</code>ï¼Œé‚£ä¹ˆ<code>&amp;U</code>çš„å€¼å°†è‡ªåŠ¨è¢«å¼ºåˆ¶ä¸º<code>T</code>ã€‚</p></blockquote><p>ä¾‹å¦‚ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ª<code>&amp;Rc&lt;String&gt;</code>ï¼Œå®ƒå°†é€šè¿‡è¿™ä¸ªè§„åˆ™è”åˆæˆä¸€ä¸ª<code>&amp;String</code>ï¼Œç„¶åä»¥åŒæ ·çš„æ–¹å¼è”åˆæˆä¸€ä¸ª<code>&amp;str</code>ã€‚å› æ­¤ï¼Œå¦‚æœä¸€ä¸ªå‡½æ•°éœ€è¦ä¸€ä¸ª<code>&amp;str</code>å‚æ•°ï¼Œä½ å¯ä»¥ç›´æ¥ä¼ å…¥ä¸€ä¸ª<code>&amp;Rc&lt;String&gt;</code>ï¼Œæ‰€æœ‰çš„å¼ºåˆ¶éƒ½é€šè¿‡<code>Deref</code>ç‰¹æ€§è‡ªåŠ¨å¤„ç†ã€‚</p><p>æœ€å¸¸è§çš„ Derefcoercions ç§ç±»æ˜¯ï¼š</p><ul><li><code>&amp;Rc&lt;T&gt;</code>åˆ°<code>&amp;T</code>ã€‚</li><li><code>&amp;Box&lt;T&gt;</code>åˆ°<code>&amp;T</code>ã€‚</li><li><code>&amp;Arc&lt;T&gt;</code>åˆ°<code>&amp;T</code>ã€‚</li><li><code>&amp;Vec&lt;T&gt;</code>æ”¹ä¸º<code>&amp;[T]</code>ã€‚</li><li><code>&amp;String</code>æ”¹ä¸º<code>&amp;str</code>ã€‚</li></ul><h1 id="ç”Ÿå‘½å‘¨æœŸ"><a href="#ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸ"></a>ç”Ÿå‘½å‘¨æœŸ</h1><h2 id="ä¸ºä»€ä¹ˆæ˜¯ç”Ÿå‘½å‘¨æœŸ"><a href="#ä¸ºä»€ä¹ˆæ˜¯ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ä¸ºä»€ä¹ˆæ˜¯ç”Ÿå‘½å‘¨æœŸ?"></a>ä¸ºä»€ä¹ˆæ˜¯ç”Ÿå‘½å‘¨æœŸ?</h2><p>ç”Ÿå‘½å‘¨æœŸæ˜¯ Rust å¯¹å†…å­˜å®‰å…¨é—®é¢˜çš„å›ç­”ã€‚å®ƒå…è®¸ Rust ç¡®ä¿å†…å­˜å®‰å…¨è€Œä¸éœ€è¦ä»˜å‡ºåƒåœ¾å›æ”¶çš„æ€§èƒ½ä»£ä»·ã€‚å®ƒä»¬æ˜¯åŸºäºå„ç§å­¦æœ¯å·¥ä½œçš„ã€‚</p><h2 id="ä¸ºä»€ä¹ˆç”Ÿå‘½å‘¨æœŸçš„è¯­æ³•æ˜¯è¿™æ ·çš„ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆç”Ÿå‘½å‘¨æœŸçš„è¯­æ³•æ˜¯è¿™æ ·çš„ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆç”Ÿå‘½å‘¨æœŸçš„è¯­æ³•æ˜¯è¿™æ ·çš„ï¼Ÿ"></a>ä¸ºä»€ä¹ˆç”Ÿå‘½å‘¨æœŸçš„è¯­æ³•æ˜¯è¿™æ ·çš„ï¼Ÿ</h2><p><code>&#39;a</code>è¯­æ³•æ¥è‡ªäº ML ç³»åˆ—ç¼–ç¨‹è¯­è¨€ï¼Œå…¶ä¸­<code>&#39;a</code>ç”¨äºè¡¨ç¤ºä¸€ä¸ªé€šç”¨ç±»å‹å‚æ•°ã€‚å¯¹äº Rust æ¥è¯´ï¼Œè¿™ç§è¯­æ³•å¿…é¡»æ˜¯æ˜ç¡®çš„ã€æ˜æ˜¾çš„ï¼Œå¹¶ä¸”é€‚åˆåœ¨ç±»å‹å£°æ˜ä¸­ä¸ traits å’Œ reference ä¸€èµ·ä½¿ç”¨ã€‚å…¶ä»–çš„è¯­æ³•å·²ç»è¢«è®¨è®ºè¿‡äº†ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰å…¶ä»–çš„è¯­æ³•è¢«è¯æ˜æ˜¯æ›´å¥½çš„ã€‚</p><h2 id="æˆ‘å¦‚ä½•å°†ä¸€ä¸ªå€Ÿæ¥çš„ä¸œè¥¿è¿”å›åˆ°æˆ‘ä»å‡½æ•°ä¸­åˆ›å»ºçš„ä¸œè¥¿ï¼Ÿ"><a href="#æˆ‘å¦‚ä½•å°†ä¸€ä¸ªå€Ÿæ¥çš„ä¸œè¥¿è¿”å›åˆ°æˆ‘ä»å‡½æ•°ä¸­åˆ›å»ºçš„ä¸œè¥¿ï¼Ÿ" class="headerlink" title="æˆ‘å¦‚ä½•å°†ä¸€ä¸ªå€Ÿæ¥çš„ä¸œè¥¿è¿”å›åˆ°æˆ‘ä»å‡½æ•°ä¸­åˆ›å»ºçš„ä¸œè¥¿ï¼Ÿ"></a>æˆ‘å¦‚ä½•å°†ä¸€ä¸ªå€Ÿæ¥çš„ä¸œè¥¿è¿”å›åˆ°æˆ‘ä»å‡½æ•°ä¸­åˆ›å»ºçš„ä¸œè¥¿ï¼Ÿ</h2><p>ä½ éœ€è¦ç¡®ä¿å€Ÿæ¥çš„ä¸œè¥¿ä¼šè¶…è¿‡å‡½æ•°çš„å¯¿å‘½ã€‚è¿™å¯ä»¥é€šè¿‡å°†è¾“å‡ºå¯¿å‘½ä¸ä¸€äº›è¾“å…¥å¯¿å‘½ç»‘å®šæ¥å®ç°ï¼Œæ¯”å¦‚è¯´ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">Pool</span></span> = TypedArena&lt;Thing&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸‹é¢çš„ç”Ÿå‘½å‘¨æœŸåªæ˜¯ä¸ºäº†è¯´æ˜é—®é¢˜è€Œæ˜ç¡®å†™çš„ï¼›å®ƒå¯ä»¥é€šè¿‡åé¢æè¿°çš„åˆ é™¤è§„åˆ™çœç•¥ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">create_borrowed</span></span>&lt;<span class="symbol">&#x27;a</span>&gt;(pool: &amp;<span class="symbol">&#x27;a</span> Pool,</span><br><span class="line">                       x: <span class="built_in">i32</span>,</span><br><span class="line">                       y: <span class="built_in">i32</span>) -&gt; &amp;<span class="symbol">&#x27;a</span> Thing &#123;</span><br><span class="line">    pool.alloc(Thing &#123; x: x, y: y &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦ä¸€ç§æ–¹æ³•æ˜¯é€šè¿‡è¿”å›ä¸€ä¸ªè‡ªæœ‰ç±»å‹å¦‚<a href="https://doc.rust-lang.org/std/string/struct.String.html"><code>String</code></a>æ¥å®Œå…¨æ¶ˆé™¤å¼•ç”¨ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">happy_birthday</span></span>(name: &amp;<span class="built_in">str</span>, age: <span class="built_in">i64</span>) -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line">    <span class="built_in">format!</span> (<span class="string">&quot;Hello &#123;&#125;! You&#x27;re &#123;&#125; years old!&quot;</span>, name, age)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œä½†å¾€å¾€ä¼šå¯¼è‡´ä¸å¿…è¦çš„åˆ†é…ã€‚</p><h2 id="ä¸ºä»€ä¹ˆæœ‰äº›å¼•ç”¨æœ‰å¯¿å‘½ï¼Œå¦‚-amp-39-a-Tï¼Œè€Œæœ‰äº›åˆ™æ²¡æœ‰ï¼Œå¦‚-amp-Tï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆæœ‰äº›å¼•ç”¨æœ‰å¯¿å‘½ï¼Œå¦‚-amp-39-a-Tï¼Œè€Œæœ‰äº›åˆ™æ²¡æœ‰ï¼Œå¦‚-amp-Tï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆæœ‰äº›å¼•ç”¨æœ‰å¯¿å‘½ï¼Œå¦‚&amp;&#39;a Tï¼Œè€Œæœ‰äº›åˆ™æ²¡æœ‰ï¼Œå¦‚&amp;Tï¼Ÿ"></a>ä¸ºä»€ä¹ˆæœ‰äº›å¼•ç”¨æœ‰å¯¿å‘½ï¼Œå¦‚<code>&amp;&#39;a T</code>ï¼Œè€Œæœ‰äº›åˆ™æ²¡æœ‰ï¼Œå¦‚<code>&amp;T</code>ï¼Ÿ</h2><p>äº‹å®ä¸Š, <em>æ‰€æœ‰</em>å¼•ç”¨ç±»å‹éƒ½æœ‰ä¸€ä¸ªå¯¿å‘½, ä½†å¤§å¤šæ•°æ—¶å€™ä½ ä¸å¿…æ˜ç¡®å†™å‡º<br>å®ƒæ˜¯æ˜ç¡®çš„ã€‚è§„åˆ™å¦‚ä¸‹ã€‚</p><ol><li><p>åœ¨ä¸€ä¸ªå‡½æ•°ä½“ä¸­ï¼Œä½ æ°¸è¿œä¸éœ€è¦æ˜ç¡®åœ°å†™å‡ºç”Ÿå‘½å‘¨æœŸï¼›æ­£ç¡®çš„å€¼åº”è¯¥æ€»æ˜¯è¢«æ¨æ–­å‡ºæ¥çš„ã€‚</p></li><li><p>åœ¨ä¸€ä¸ªå‡½æ•°çš„<em>ç­¾å</em>ä¸­ï¼ˆä¾‹å¦‚ï¼Œåœ¨å…¶å‚æ•°çš„ç±»å‹æˆ–å…¶è¿”å›ç±»å‹ä¸­ï¼‰ï¼Œä½ <em>å¯èƒ½</em>ä¼šéœ€è¦å†™ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸã€‚è¿™é‡Œçš„ç”Ÿå‘½å‘¨æœŸä½¿ç”¨ä¸€ä¸ªç®€å•çš„é»˜è®¤æ–¹æ¡ˆï¼Œç§°ä¸º<a href="https://doc.rust-lang.org/book/ch10-03-lifetime-syntax.html#lifetime-elision">â€œlifetime elisionâ€</a>ã€‚å®ƒç”±ä»¥ä¸‹ä¸‰æ¡è§„åˆ™ç»„æˆï¼š</p><ul><li>åœ¨ä¸€ä¸ªå‡½æ•°çš„å‚æ•°ä¸­ï¼Œæ¯ä¸€ä¸ªè¢«çœç•¥çš„ç”Ÿå‘½å‘¨æœŸéƒ½æˆä¸ºä¸€ä¸ªç‹¬ç«‹çš„ç”Ÿå‘½å‘¨æœŸå‚æ•°ã€‚</li><li>å¦‚æœæ­£å¥½åªæœ‰ä¸€ä¸ªè¾“å…¥ç”Ÿå‘½å‘¨æœŸï¼Œæ— è®ºæ˜¯å¦è¢«çœç•¥ï¼Œè¯¥ç”Ÿå‘½å‘¨æœŸéƒ½è¢«åˆ†é…ç»™æ‰€æœ‰è¿”å›å€¼ä¸­è¢«çœç•¥çš„ç”Ÿå‘½å‘¨æœŸã€‚</li><li>å¦‚æœæœ‰å¤šä¸ªè¾“å…¥ç”Ÿå‘½å‘¨æœŸï¼Œä½†å…¶ä¸­ä¸€ä¸ªæ˜¯ &amp;self æˆ– &amp;mut selfï¼Œé‚£ä¹ˆ self çš„ç”Ÿå‘½å‘¨æœŸå°†è¢«åˆ†é…ç»™æ‰€æœ‰è¢«å¿½ç•¥çš„è¿”å›ç”Ÿå‘½å‘¨æœŸã€‚</li></ul></li><li><p>æœ€åï¼Œåœ¨â€œç»“æ„â€æˆ–â€œæšä¸¾â€çš„å®šä¹‰ä¸­ï¼Œæ‰€æœ‰çš„ç”Ÿå‘½å‘¨æœŸå¿…é¡»è¢«æ˜ç¡®åœ°å£°æ˜ã€‚</p></li></ol><p>å¦‚æœè¿™äº›è§„åˆ™å¯¼è‡´äº†ç¼–è¯‘é”™è¯¯ï¼ŒRust ç¼–è¯‘å™¨å°†æä¾›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯ï¼ŒæŒ‡å‡ºæ‰€é€ æˆçš„é”™è¯¯ï¼Œå¹¶æ ¹æ®æ¨ç†è¿‡ç¨‹çš„å“ªä¸€æ­¥é€ æˆçš„é”™è¯¯ï¼Œæå‡ºä¸€ä¸ªæ½œåœ¨çš„è§£å†³æ–¹æ¡ˆã€‚</p><h2 id="Rustå¦‚ä½•ä¿è¯â€œæ²¡æœ‰ç©ºæŒ‡é’ˆâ€å’Œâ€œæ²¡æœ‰æ‚¬ç©ºæŒ‡é’ˆâ€"><a href="#Rustå¦‚ä½•ä¿è¯â€œæ²¡æœ‰ç©ºæŒ‡é’ˆâ€å’Œâ€œæ²¡æœ‰æ‚¬ç©ºæŒ‡é’ˆâ€" class="headerlink" title="Rustå¦‚ä½•ä¿è¯â€œæ²¡æœ‰ç©ºæŒ‡é’ˆâ€å’Œâ€œæ²¡æœ‰æ‚¬ç©ºæŒ‡é’ˆâ€?"></a>Rustå¦‚ä½•ä¿è¯â€œæ²¡æœ‰ç©ºæŒ‡é’ˆâ€å’Œâ€œæ²¡æœ‰æ‚¬ç©ºæŒ‡é’ˆâ€?</h2><p>æ„é€ ä¸€ä¸ª<code>&amp;Foo</code>æˆ–<code>&amp;mut Foo</code>ç±»å‹çš„å€¼çš„å”¯ä¸€æ–¹æ³•æ˜¯æŒ‡å®šä¸€ä¸ªå¼•ç”¨æ‰€æŒ‡å‘çš„<code>Foo</code>ç±»å‹çš„ç°æœ‰å€¼ã€‚å¼•ç”¨åœ¨ç»™å®šçš„ä»£ç åŒºåŸŸå†…ï¼ˆå¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼‰â€œå€Ÿç”¨â€åŸå§‹å€¼ï¼Œåœ¨å€Ÿç”¨æœŸé—´ï¼Œè¢«å€Ÿç”¨çš„å€¼ä¸èƒ½è¢«ç§»åŠ¨æˆ–é”€æ¯ã€‚</p><h2 id="æˆ‘å¦‚ä½•ç”¨â€œnullâ€æ¥è¡¨è¾¾ä¸€ä¸ªå€¼çš„ç¼ºå¤±"><a href="#æˆ‘å¦‚ä½•ç”¨â€œnullâ€æ¥è¡¨è¾¾ä¸€ä¸ªå€¼çš„ç¼ºå¤±" class="headerlink" title="æˆ‘å¦‚ä½•ç”¨â€œnullâ€æ¥è¡¨è¾¾ä¸€ä¸ªå€¼çš„ç¼ºå¤±?"></a>æˆ‘å¦‚ä½•ç”¨â€œnullâ€æ¥è¡¨è¾¾ä¸€ä¸ªå€¼çš„ç¼ºå¤±?</h2><p>ä½ å¯ä»¥ç”¨<a href="https://doc.rust-lang.org/std/option/enum.Option.html"><code>Option</code></a>ç±»å‹æ¥åšï¼Œå®ƒå¯ä»¥æ˜¯<code>Some(T)</code>æˆ–<code>None</code>ã€‚<code>Some(T)</code>è¡¨ç¤ºå…¶ä¸­åŒ…å«ä¸€ä¸ª<code>T</code>ç±»å‹çš„å€¼ï¼Œè€Œ<code>None</code>è¡¨ç¤ºæ²¡æœ‰å€¼ã€‚</p><h1 id="æ³›å‹"><a href="#æ³›å‹" class="headerlink" title="æ³›å‹"></a>æ³›å‹</h1><h2 id="ä»€ä¹ˆæ˜¯â€œå•æ€åŒ–â€"><a href="#ä»€ä¹ˆæ˜¯â€œå•æ€åŒ–â€" class="headerlink" title="ä»€ä¹ˆæ˜¯â€œå•æ€åŒ–â€?"></a>ä»€ä¹ˆæ˜¯â€œå•æ€åŒ–â€?</h2><p>å•æ€åŒ–æ˜¯å°†æ³›å‹å‡½æ•°ï¼ˆæˆ–ç»“æ„ï¼‰çš„æ¯ä¸€æ¬¡ä½¿ç”¨éƒ½åŸºäºè°ƒç”¨è¯¥å‡½æ•°ï¼ˆæˆ–ä½¿ç”¨è¯¥ç»“æ„ï¼‰çš„å‚æ•°ç±»å‹ç”¨ç‰¹å®šçš„å®ä¾‹è¿›è¡Œå•æ€åŒ–ã€‚</p><p>åœ¨å•æ€åŒ–è¿‡ç¨‹ä¸­ï¼Œæ³›å‹å‡½æ•°çš„ä¸€ä¸ªæ–°å‰¯æœ¬è¢«ç¿»è¯‘ä¸ºè¯¥å‡½æ•°å®ä¾‹åŒ–çš„æ¯ä¸€ç»„ç‹¬ç‰¹ç±»å‹ã€‚è¿™ä¸ C++ ä½¿ç”¨çš„ç­–ç•¥ç›¸åŒã€‚å®ƒçš„ç»“æœæ˜¯ä¸ºæ¯ä¸ªè°ƒç”¨ç‚¹ä¸“é—¨è®¾è®¡çš„å¿«é€Ÿä»£ç ï¼Œå¹¶ä¸”æ˜¯é™æ€è°ƒåº¦çš„ï¼Œå…¶ä»£ä»·æ˜¯ç”¨è®¸å¤šä¸åŒç±»å‹å®ä¾‹åŒ–çš„å‡½æ•°ä¼šå¯¼è‡´â€œä»£ç è†¨èƒ€â€ï¼Œå³å¤šä¸ªå‡½æ•°å®ä¾‹ä¼šå¯¼è‡´æ¯”ç”¨å…¶ä»–ç¿»è¯‘ç­–ç•¥åˆ›å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶æ›´å¤§ã€‚</p><p>æ¥å—<a href="https://doc.rust-lang.org/book/ch17-02-trait-objects.html"> Trait Object </a>è€Œä¸æ˜¯ç±»å‹å‚æ•°çš„å‡½æ•°ä¸è¿›è¡Œå•æ€åŒ–ã€‚ç›¸åï¼Œç‰¹è´¨å¯¹è±¡ä¸Šçš„æ–¹æ³•åœ¨è¿è¡Œæ—¶è¢«åŠ¨æ€åœ°åˆ†é…ã€‚</p><h2 id="ä¸€ä¸ªå‡½æ•°å’Œä¸€ä¸ªæ²¡æœ‰æ•è·ä»»ä½•å˜é‡çš„é—­åŒ…ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"><a href="#ä¸€ä¸ªå‡½æ•°å’Œä¸€ä¸ªæ²¡æœ‰æ•è·ä»»ä½•å˜é‡çš„é—­åŒ…ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ" class="headerlink" title="ä¸€ä¸ªå‡½æ•°å’Œä¸€ä¸ªæ²¡æœ‰æ•è·ä»»ä½•å˜é‡çš„é—­åŒ…ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"></a>ä¸€ä¸ªå‡½æ•°å’Œä¸€ä¸ªæ²¡æœ‰æ•è·ä»»ä½•å˜é‡çš„é—­åŒ…ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h2><p>å‡½æ•°å’Œé—­åŒ…åœ¨æ“ä½œä¸Šæ˜¯ç­‰ä»·çš„ï¼Œä½†ç”±äºå®ƒä»¬çš„å®ç°æ–¹å¼ä¸åŒï¼Œæ‰€ä»¥æœ‰ä¸åŒçš„è¿è¡Œæ—¶è¡¨ç¤ºã€‚</p><p>å‡½æ•°æ˜¯è¯­è¨€çš„å†…ç½®åŸºå…ƒï¼Œè€Œé—­åŒ…æœ¬è´¨ä¸Šæ˜¯ä¸‰ç§ç‰¹å¾ä¹‹ä¸€çš„è¯­æ³•ç³–ã€‚<a href="https://doc.rust-lang.org/std/ops/trait.Fn.html"><code>Fn</code></a>, <a href="https://doc.rust-lang.org/std/ops/trait.FnMut.html"><code>FnMut</code></a>, å’Œ <a href="https://doc.rust-lang.org/std/ops/trait.FnOnce.html"><code>FnOnce</code></a>ã€‚å½“ä½ åˆ›å»ºä¸€ä¸ªé—­åŒ…æ—¶ï¼ŒRust ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªç»“æ„ï¼Œå®ç°è¿™ä¸‰ä¸ªç»“æ„çš„ç›¸åº”ç‰¹æ€§ï¼Œå¹¶å°†æ•è·çš„ç¯å¢ƒå˜é‡ä½œä¸ºæˆå‘˜ï¼Œå¹¶ä½¿è¯¥ç»“æ„å¯ä»¥ä½œä¸ºä¸€ä¸ªå‡½æ•°è¢«è°ƒç”¨ã€‚è£¸éœ²çš„å‡½æ•°ä¸èƒ½æ•è·ç¯å¢ƒã€‚</p><p>è¿™äº›ç‰¹å¾ä¹‹é—´çš„æœ€å¤§åŒºåˆ«æ˜¯å®ƒä»¬å¦‚ä½•æ¥å—â€œselfâ€å‚æ•°ã€‚<a href="https://doc.rust-lang.org/std/ops/trait.Fn.html"><code>Fn</code></a>ä½¿ç”¨<code>&amp;self</code>ï¼Œ<a href="https://doc.rust-lang.org/std/ops/trait.FnMut.html"><code>FnMut</code></a>ä½¿ç”¨<code>&amp;mut self</code>ï¼Œè€Œ<a href="https://doc.rust-lang.org/std/ops/trait.FnOnce.html"><code>FnOnce</code></a>ä½¿ç”¨<code>self</code>ã€‚</p><p>å³ä½¿ä¸€ä¸ªé—­åŒ…æ²¡æœ‰æ•è·ä»»ä½•ç¯å¢ƒå˜é‡ï¼Œå®ƒåœ¨è¿è¡Œæ—¶ä¹Ÿè¢«è¡¨ç¤ºä¸ºä¸¤ä¸ªæŒ‡é’ˆï¼Œä¸å…¶ä»–é—­åŒ…ç›¸åŒã€‚</p><h2 id="ä»€ä¹ˆæ˜¯é«˜é˜¶ç±»å‹ï¼Œä¸ºä»€ä¹ˆæˆ‘éœ€è¦å®ƒä»¬ï¼Œä»¥åŠä¸ºä»€ä¹ˆ-Rust-æ²¡æœ‰å®ƒä»¬ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯é«˜é˜¶ç±»å‹ï¼Œä¸ºä»€ä¹ˆæˆ‘éœ€è¦å®ƒä»¬ï¼Œä»¥åŠä¸ºä»€ä¹ˆ-Rust-æ²¡æœ‰å®ƒä»¬ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯é«˜é˜¶ç±»å‹ï¼Œä¸ºä»€ä¹ˆæˆ‘éœ€è¦å®ƒä»¬ï¼Œä»¥åŠä¸ºä»€ä¹ˆ Rust æ²¡æœ‰å®ƒä»¬ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯é«˜é˜¶ç±»å‹ï¼Œä¸ºä»€ä¹ˆæˆ‘éœ€è¦å®ƒä»¬ï¼Œä»¥åŠä¸ºä»€ä¹ˆ Rust æ²¡æœ‰å®ƒä»¬ï¼Ÿ</h2><p>é«˜ç­‰ç±»å‹æ˜¯æŒ‡å…·æœ‰æœªå¡«å……å‚æ•°çš„ç±»å‹ã€‚ç±»å‹æ„é€ å™¨ï¼Œå¦‚<a href="https://doc.rust-lang.org/std/vec/struct.Vec.html"><code>Vec</code></a>ï¼Œ<a href="https://doc.rust-lang.org/std/result/enum.Result.html"><code>Result</code></a>ï¼Œå’Œ<a href="https://doc.rust-lang.org/std/collections/struct.HashMap.html"><code>HashMap</code></a>éƒ½æ˜¯é«˜ç±»å‹ç±»å‹çš„ä¾‹å­ï¼šæ¯ä¸ªç±»å‹éƒ½éœ€è¦ä¸€äº›é¢å¤–çš„ç±»å‹å‚æ•°ï¼Œä»¥ä¾¿å®é™…è¡¨ç¤ºä¸€ä¸ªç‰¹å®šçš„ç±»å‹ï¼Œå¦‚<code>Vec&lt;u32&gt;</code>ã€‚å¯¹é«˜ç±»å‹çš„æ”¯æŒæ„å‘³ç€è¿™äº›â€œä¸å®Œæ•´â€çš„ç±»å‹å¯ä»¥åœ¨ä»»ä½•å¯ä»¥ä½¿ç”¨â€œå®Œæ•´â€ç±»å‹çš„åœ°æ–¹ä½¿ç”¨ï¼ŒåŒ…æ‹¬ä½œä¸ºå‡½æ•°çš„æ³›å‹ã€‚</p><p>ä»»ä½•å®Œæ•´çš„ç±»å‹ï¼Œåƒ<a href="https://doc.rust-lang.org/std/primitive.i32.html"><code>i32</code></a>ï¼Œ<a href="https://doc.rust-lang.org/std/primitive.bool.html"><code>bool</code></a>æˆ–<a href="https://doc.rust-lang.org/std/primitive.char.html"><code>char</code></a>éƒ½å±äº<code>*</code>ç±»å‹ï¼ˆè¿™ä¸ªç¬¦å·æ¥è‡ªç±»å‹ç†è®ºé¢†åŸŸï¼‰ã€‚ä¸€ä¸ªæœ‰ä¸€ä¸ªå‚æ•°çš„ç±»å‹ï¼Œåƒ<a href="https://doc.rust-lang.org/std/vec/struct.Vec.html"><code>Vec&lt;T&gt;</code></a>æ˜¯å±äº<code>* -&gt; *</code>ï¼Œæ„æ€æ˜¯<a href="https://doc.rust-lang.org/std/vec/struct.Vec.html"><code>Vec&lt;T&gt;</code></a>æ¥æ”¶ä¸€ä¸ªå®Œæ•´çš„ç±»å‹ï¼Œåƒ<a href="https://doc.rust-lang.org/std/primitive.i32.html"><code>i32</code></a>ï¼Œå¹¶è¿”å›ä¸€ä¸ªå®Œæ•´ç±»å‹<code>Vec&lt;i32&gt;</code>ã€‚ä¸€ä¸ªæœ‰ä¸‰ä¸ªå‚æ•°çš„ç±»å‹ï¼Œå¦‚<a href="https://doc.rust-lang.org/std/collections/struct.HashMap.html"><code>HashMap&lt;K, V, S&gt;</code></a>æ˜¯ä¸€ç§<code>* -&gt; * -&gt; * -&gt; *</code>ï¼Œå¹¶æ¥æ”¶ä¸‰ä¸ªå®Œæ•´çš„ç±»å‹ï¼ˆå¦‚<a href="https://doc.rust-lang.org/std/primitive.i32.html"><code>i32</code></a>ï¼Œ<a href="https://doc.rust-lang.org/std/string/struct.String.html"><code>String</code></a>ï¼Œå’Œ<a href="https://doc.rust-lang.org/std/collections/hash_map/struct.RandomState.html"><code>RandomState</code></a>ï¼‰ï¼Œäº§ç”Ÿä¸€ä¸ªæ–°çš„å®Œæ•´ç±»å‹<code>HashMap&lt;i32, String, RandomState&gt;</code>ã€‚</p><p>é™¤äº†è¿™äº›ä¾‹å­ä¹‹å¤–ï¼Œç±»å‹æ„é€ å‡½æ•°è¿˜å¯ä»¥æ¥å—<em>ç”Ÿå‘½å‘¨æœŸ</em>å‚æ•°ï¼Œæˆ‘ä»¬å°†å…¶è¡¨ç¤ºä¸º<code>Lt</code>ã€‚ä¾‹å¦‚ï¼Œ<code>slice::Iter</code>çš„ç§ç±»æ˜¯<code>Lt -&gt; * -&gt; *</code>ï¼Œå› ä¸ºå®ƒå¿…é¡»åƒ<code>Iter&lt;&#39;a, u32&gt;</code>ä¸€æ ·è¢«å®ä¾‹åŒ–ã€‚</p><p>ç”±äºç¼ºä¹å¯¹é«˜é˜¶ç±»å‹çš„æ”¯æŒï¼Œå› æ­¤å¾ˆéš¾ç¼–å†™æŸäº›ç±»å‹çš„é€šç”¨ä»£ç ã€‚å¯¹äºåƒè¿­ä»£å™¨è¿™æ ·çš„æ¦‚å¿µçš„æŠ½è±¡æ¥è¯´ï¼Œè¿™å°¤å…¶æˆé—®é¢˜ï¼Œå› ä¸ºè¿­ä»£å™¨é€šå¸¸è‡³å°‘è¦åœ¨ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸå†…è¿›è¡Œå‚æ•°åŒ–ã€‚è¿™åè¿‡æ¥åˆé˜»ç¢äº†å¯¹ Rust çš„é›†åˆè¿›è¡ŒæŠ½è±¡çš„ traits çš„åˆ›å»ºã€‚</p><p>å¦ä¸€ä¸ªå¸¸è§çš„ä¾‹å­æ˜¯åƒ functors æˆ– monads è¿™æ ·çš„æ¦‚å¿µï¼Œå®ƒä»¬éƒ½æ˜¯ç±»å‹æ„é€ å‡½æ•°ï¼Œè€Œä¸æ˜¯å•ä¸€ç±»å‹ã€‚</p><p>Rust ç›®å‰å¹¶ä¸æ”¯æŒé«˜ç±»å‹çš„ç±»å‹ï¼Œå› ä¸ºä¸æˆ‘ä»¬æƒ³åšçš„å…¶ä»–æ”¹è¿›ç›¸æ¯”ï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ä¸ªä¼˜å…ˆäº‹é¡¹ã€‚ç”±äºè¯¥è®¾è®¡æ˜¯ä¸€ä¸ªé‡å¤§çš„ã€è·¨é¢†åŸŸçš„å˜åŒ–ï¼Œæˆ‘ä»¬ä¹Ÿæƒ³è°¨æ…åœ°å¯¹å¾…å®ƒã€‚ä½†æ˜¯ç›®å‰ç¼ºä¹æ”¯æŒå¹¶æ²¡æœ‰ä»€ä¹ˆå†…åœ¨çš„åŸå› ã€‚</p><h2 id="é€šç”¨ç±»å‹ä¸­åƒ-lt-T-Foo-gt-è¿™æ ·çš„å‘½åç±»å‹å‚æ•°æ˜¯ä»€ä¹ˆæ„æ€"><a href="#é€šç”¨ç±»å‹ä¸­åƒ-lt-T-Foo-gt-è¿™æ ·çš„å‘½åç±»å‹å‚æ•°æ˜¯ä»€ä¹ˆæ„æ€" class="headerlink" title="é€šç”¨ç±»å‹ä¸­åƒ&lt;T=Foo&gt;è¿™æ ·çš„å‘½åç±»å‹å‚æ•°æ˜¯ä»€ä¹ˆæ„æ€?"></a>é€šç”¨ç±»å‹ä¸­åƒ<code>&lt;T=Foo&gt;</code>è¿™æ ·çš„å‘½åç±»å‹å‚æ•°æ˜¯ä»€ä¹ˆæ„æ€?</h2><p>è¿™äº›è¢«ç§°ä¸º<a href="https://doc.rust-lang.org/book/ch19-03-advanced-traits.html#specifying-placeholder-types-in-trait-definitions-with-associated-types">å…³è”ç±»å‹</a>ï¼Œå®ƒä»¬å…è®¸è¡¨è¾¾ä¸èƒ½ç”¨<code>where</code>å­å¥è¡¨è¾¾çš„ç‰¹å¾è¾¹ç•Œã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªæ³›å‹çº¦æŸ<code>X: Bar&lt;T=Foo&gt;</code>æ„å‘³ç€â€<code>X</code>å¿…é¡»å®ç° trait <code>Bar</code>ï¼Œåœ¨<code>Bar</code>çš„å®ç°ä¸­ï¼Œ<code>X</code>å¿…é¡»é€‰æ‹©<code>Foo</code>ä½œä¸º<code>Bar</code>çš„å…³è”ç±»å‹<code>T</code>â€œã€‚è¿™ç§çº¦æŸä¸èƒ½é€šè¿‡<code>where</code>å­å¥æ¥è¡¨è¾¾çš„ä¾‹å­åŒ…æ‹¬åƒ<code>Box&lt;Bar&lt;T=Foo&gt;&gt;</code>è¿™æ ·çš„ trait objectã€‚</p><p>å…³è”ç±»å‹çš„å­˜åœ¨æ˜¯å› ä¸ºæ³›å‹ç»å¸¸æ¶‰åŠç±»å‹å®¶æ—ï¼Œå…¶ä¸­ä¸€ä¸ªç±»å‹å†³å®šäº†ä¸€ä¸ªå®¶æ—ä¸­çš„æ‰€æœ‰å…¶ä»–ç±»å‹ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå›¾çš„ trait å¯èƒ½å°†å›¾æœ¬èº«ä½œä¸ºå…¶<code>Self</code>ç±»å‹ï¼Œå¹¶æœ‰èŠ‚ç‚¹å’Œè¾¹çš„å…³è”ç±»å‹ã€‚æ¯ä¸ªå›¾çš„ç±»å‹å”¯ä¸€åœ°å†³å®šäº†ç›¸å…³çš„ç±»å‹ã€‚ä½¿ç”¨å…³è”ç±»å‹ä½¿è¿™äº›ç±»å‹æ—çš„å·¥ä½œæ›´åŠ ç®€æ´ï¼Œå¹¶ä¸”åœ¨è®¸å¤šæƒ…å†µä¸‹æä¾›æ›´å¥½çš„ç±»å‹æ¨ç†ã€‚</p><h2 id="æˆ‘å¯ä»¥é‡è½½è¿ç®—ç¬¦å—-å“ªäº›æ“ä½œç¬¦ï¼Œå¦‚ä½•æ“ä½œï¼Ÿ"><a href="#æˆ‘å¯ä»¥é‡è½½è¿ç®—ç¬¦å—-å“ªäº›æ“ä½œç¬¦ï¼Œå¦‚ä½•æ“ä½œï¼Ÿ" class="headerlink" title="æˆ‘å¯ä»¥é‡è½½è¿ç®—ç¬¦å—? å“ªäº›æ“ä½œç¬¦ï¼Œå¦‚ä½•æ“ä½œï¼Ÿ"></a>æˆ‘å¯ä»¥é‡è½½è¿ç®—ç¬¦å—? å“ªäº›æ“ä½œç¬¦ï¼Œå¦‚ä½•æ“ä½œï¼Ÿ</h2><p>ä½ å¯ä»¥ä½¿ç”¨å®ƒä»¬çš„å…³è”ç‰¹æ€§ä¸ºå„ç§è¿ç®—ç¬¦æä¾›è‡ªå®šä¹‰çš„å®ç°ã€‚<a href="https://doc.rust-lang.org/std/ops/trait.Add.html"><code>Add</code></a>ä»£è¡¨<code>+</code>ï¼Œ<a href="https://doc.rust-lang.org/std/ops/trait.Mul.html"><code>Mul</code></a>ä»£è¡¨<code>*</code>ï¼Œç­‰ç­‰ã€‚å®ƒçœ‹èµ·æ¥åƒè¿™æ ·ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::ops::Addã€‚</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Foo</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Add <span class="keyword">for</span> Foo &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Output</span></span> = Foo;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">add</span></span>(<span class="keyword">self</span>, rhs: Foo) -&gt; Self::Output &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Adding!&quot;</span>);</span><br><span class="line">        <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹æ“ä½œç¬¦å¯ä»¥è¢«é‡è½½ã€‚</p><table><thead><tr><th align="left">Operation</th><th align="left">Trait</th></tr></thead><tbody><tr><td align="left"><code>+</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.Add.html"><code>Add</code></a></td></tr><tr><td align="left"><code>+=</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.AddAssign.html"><code>AddAssign</code></a></td></tr><tr><td align="left"><code>binary -</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.Sub.html"><code>Sub</code></a></td></tr><tr><td align="left"><code>-=</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.SubAssign.html"><code>SubAssign</code></a></td></tr><tr><td align="left"><code>*</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.Mul.html"><code>Mul</code></a></td></tr><tr><td align="left"><code>*=</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.MulAssign.html"><code>MulAssign</code></a></td></tr><tr><td align="left"><code>/</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.Div.html"><code>Div</code></a></td></tr><tr><td align="left"><code>/=</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.DivAssign.html"><code>DivAssign</code></a></td></tr><tr><td align="left"><code>unary -</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.Neg.html"><code>Neg</code></a></td></tr><tr><td align="left"><code>%</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.Rem.html"><code>Rem</code></a></td></tr><tr><td align="left"><code>%=</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.RemAssign.html"><code>RemAssign</code></a></td></tr><tr><td align="left"><code>&amp;</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.BitAnd.html"><code>BitAnd</code></a></td></tr><tr><td align="left"><code>&amp;=</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.BitAndAssign.html"><code>BitAndAssign</code></a></td></tr><tr><td align="left"><code>&#124;</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.BitOr.html"><code>BitOr</code></a></td></tr><tr><td align="left"><code>&#124;=</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.BitOrAssign.html"><code>BitOrAssign</code></a></td></tr><tr><td align="left"><code>^</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.BitXor.html"><code>BitXor</code></a></td></tr><tr><td align="left"><code>^=</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.BitXorAssign.html"><code>BitXorAssign</code></a></td></tr><tr><td align="left"><code>!</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.Not.html"><code>Not</code></a></td></tr><tr><td align="left"><code>&lt;&lt;</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.Shl.html"><code>Shl</code></a></td></tr><tr><td align="left"><code>&lt;&lt;=</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.ShlAssign.html"><code>ShlAssign</code></a></td></tr><tr><td align="left"><code>&gt;&gt;</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.Shr.html"><code>Shr</code></a></td></tr><tr><td align="left"><code>&gt;&gt;=</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.ShrAssign.html"><code>ShrAssign</code></a></td></tr><tr><td align="left"><code>*</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.Deref.html"><code>Deref</code></a></td></tr><tr><td align="left"><code>mut *</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.DerefMut.html"><code>DerefMut</code></a></td></tr><tr><td align="left"><code>[]</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.Index.html"><code>Index</code></a></td></tr><tr><td align="left"><code>mut []</code></td><td align="left"><a href="https://doc.rust-lang.org/std/ops/trait.IndexMut.html"><code>IndexMut</code></a></td></tr></tbody></table><h2 id="ä¸ºä»€ä¹ˆè¦åœ¨Eq-PartialEqå’ŒOrd-PartialOrdä¹‹é—´åˆ’åˆ†ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦åœ¨Eq-PartialEqå’ŒOrd-PartialOrdä¹‹é—´åˆ’åˆ†ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦åœ¨Eq/PartialEqå’ŒOrd/PartialOrdä¹‹é—´åˆ’åˆ†ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦åœ¨<code>Eq</code>/<code>PartialEq</code>å’Œ<code>Ord</code>/<code>PartialOrd</code>ä¹‹é—´åˆ’åˆ†ï¼Ÿ</h2><p>åœ¨ Rust ä¸­ï¼Œæœ‰ä¸€äº›ç±»å‹çš„å€¼åªæœ‰éƒ¨åˆ†æ’åºï¼Œæˆ–è€…åªæœ‰éƒ¨åˆ†ç›¸ç­‰ã€‚éƒ¨åˆ†æ’åºçš„æ„æ€æ˜¯ï¼Œåœ¨ç»™å®šçš„ç±»å‹ä¸­å¯èƒ½å­˜åœ¨æ—¢ä¸å°äºä¹Ÿä¸å¤§äºå¯¹æ–¹çš„å€¼ã€‚éƒ¨åˆ†å¹³ç­‰æ„å‘³ç€å¯èƒ½æœ‰ç»™å®šç±»å‹çš„å€¼ä¸ç­‰äºè‡ªå·±ã€‚</p><p>æµ®ç‚¹ç±»å‹ï¼ˆ<a href="https://doc.rust-lang.org/std/primitive.f32.html"><code>f32</code></a>å’Œ<a href="https://doc.rust-lang.org/std/primitive.f64.html"><code>f64</code></a>ï¼‰æ˜¯æ¯ç§ç±»å‹çš„å¾ˆå¥½çš„ä¾‹å­ã€‚ä»»ä½•æµ®ç‚¹ç±»å‹éƒ½å¯ä»¥æœ‰<code>NaN</code>ï¼ˆæ„æ€æ˜¯â€œä¸æ˜¯ä¸€ä¸ªæ•°å­—â€ï¼‰çš„å€¼ã€‚<code>NaN</code>ä¸ç­‰äºè‡ªå·±ï¼ˆ<code>NaN == NaN</code>æ˜¯ falseï¼‰ï¼Œä¹Ÿä¸å°äºæˆ–å¤§äºä»»ä½•å…¶ä»–æµ®ç‚¹å€¼ã€‚å› æ­¤ï¼Œ<a href="https://doc.rust-lang.org/std/primitive.f32.html"><code>f32</code></a>å’Œ[<code>f64</code>]éƒ½å®ç°äº†<a href="https://doc.rust-lang.org/std/cmp/trait.PartialOrd.html"><code>PartialOrd</code></a>å’Œ<a href="https://doc.rust-lang.org/std/cmp/trait.PartialEq.html"><code>PartialEq</code></a>ï¼Œä½†æ²¡æœ‰å®ç°<a href="https://doc.rust-lang.org/std/cmp/trait.Ord.html"><code>Ord</code></a>å’Œ``Eq`]<a href="https://doc.rust-lang.org/std/cmp/trait.Eq.html">Eq</a>ã€‚</p><p>æ­£å¦‚åœ¨<a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E4%B8%8D%E8%83%BD%E6%AF%94%E8%BE%83%E6%B5%AE%E7%82%B9%E6%95%B0%E6%88%96%E7%94%A8%E5%AE%83%E4%BB%AC%E4%BD%9C%E4%B8%BAHashMap%E6%88%96BTreeMap%E7%9A%84%E9%94%AE">å…ˆå‰å…³äº floats çš„é—®é¢˜</a>ä¸­è§£é‡Šçš„é‚£æ ·ï¼Œè¿™äº›åŒºåˆ«å¾ˆé‡è¦ï¼Œå› ä¸ºæœ‰äº›é›†åˆä¾èµ–äºæ€»æ’åº/equalityï¼Œä»¥ä¾¿ç»™å‡ºæ­£ç¡®çš„ç»“æœã€‚</p><h1 id="è¾“å…¥-è¾“å‡º"><a href="#è¾“å…¥-è¾“å‡º" class="headerlink" title="è¾“å…¥/è¾“å‡º"></a>è¾“å…¥/è¾“å‡º</h1><h2 id="å¦‚ä½•å°†ä¸€ä¸ªæ–‡ä»¶è¯»æˆä¸€ä¸ªâ€œå­—ç¬¦ä¸²â€"><a href="#å¦‚ä½•å°†ä¸€ä¸ªæ–‡ä»¶è¯»æˆä¸€ä¸ªâ€œå­—ç¬¦ä¸²â€" class="headerlink" title="å¦‚ä½•å°†ä¸€ä¸ªæ–‡ä»¶è¯»æˆä¸€ä¸ªâ€œå­—ç¬¦ä¸²â€?"></a>å¦‚ä½•å°†ä¸€ä¸ªæ–‡ä»¶è¯»æˆä¸€ä¸ªâ€œå­—ç¬¦ä¸²â€?</h2><p>ä½¿ç”¨<a href="https://doc.rust-lang.org/std/io/trait.Read.html#method.read_to_string"><code>read_to_string()</code></a>æ–¹æ³•, è¿™ä¸ªæ–¹æ³•æ˜¯åœ¨<a href="https://doc.rust-lang.org/std/io/index.html"><code>std::io</code></a>ä¸­çš„<a href="https://doc.rust-lang.org/std/io/trait.Read.html"><code>Read</code></a>ç‰¹æ€§ä¸Šå®šä¹‰ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::io::Read;</span><br><span class="line"><span class="keyword">use</span> std::fs::File;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">read_file</span></span>(path: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">String</span>, std::io::Error&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> s = <span class="built_in">String</span>::new();</span><br><span class="line">    <span class="keyword">let</span> _ = File::open(path)?.read_to_string(&amp;<span class="keyword">mut</span> s);  <span class="comment">// `s` contains the contents of &quot;foo.txt&quot;</span></span><br><span class="line">    <span class="literal">Ok</span>(s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">match</span> read_file(<span class="string">&quot;foo.txt&quot;</span>) &#123;</span><br><span class="line">        <span class="literal">Ok</span>(_) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;Got file contents!&quot;</span>),</span><br><span class="line">        <span class="literal">Err</span>(err) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;Getting file contents failed with error: &#123;&#125;&quot;</span>, err)</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¦‚ä½•æœ‰æ•ˆåœ°è¯»å–æ–‡ä»¶è¾“å…¥"><a href="#å¦‚ä½•æœ‰æ•ˆåœ°è¯»å–æ–‡ä»¶è¾“å…¥" class="headerlink" title="å¦‚ä½•æœ‰æ•ˆåœ°è¯»å–æ–‡ä»¶è¾“å…¥?"></a>å¦‚ä½•æœ‰æ•ˆåœ°è¯»å–æ–‡ä»¶è¾“å…¥?</h2><p><a href="https://doc.rust-lang.org/std/fs/struct.File.html"><code>File</code></a>ç±»å‹å®ç°äº†<a href="https://doc.rust-lang.org/std/io/trait.Read.html"><code>Read</code></a>ç‰¹æ€§ï¼Œå®ƒæœ‰å¤šç§å‡½æ•°ç”¨äºè¯»å†™æ•°æ®ï¼ŒåŒ…æ‹¬<a href="https://doc.rust-lang.org/std/io/trait.Read.html#tymethod.read"><code>read()</code></a>, <a href="https://doc.rust-lang.org/std/io/trait.Read.html#method.read_to_end"><code>read_to_end()</code></a>, <a href="https://doc.rust-lang.org/std/io/trait.Read.html#method.bytes"><code>bytes()</code></a>, <a href="https://doc.rust-lang.org/std/io/trait.Read.html#method.chars"><code>chars()</code></a>, å’Œ<a href="https://doc.rust-lang.org/std/io/trait.Read.html#method.take"><code>take()</code></a> ã€‚è¿™äº›å‡½æ•°ä¸­çš„æ¯ä¸€ä¸ªéƒ½ä»ä¸€ä¸ªç»™å®šçš„æ–‡ä»¶ä¸­è¯»å–ä¸€å®šé‡çš„è¾“å…¥ã€‚<a href="https://doc.rust-lang.org/std/io/trait.Read.html#tymethod.read"><code>read()</code></a> åœ¨ä¸€æ¬¡è°ƒç”¨ä¸­è¯»å–åº•å±‚ç³»ç»Ÿæ‰€èƒ½æä¾›çš„è¾“å…¥é‡ã€‚<a href="https://doc.rust-lang.org/std/io/trait.Read.html#method.read_to_end"><code>read_to_end()</code></a> å°†æ•´ä¸ªç¼“å†²åŒºè¯»å…¥ä¸€ä¸ªå‘é‡ï¼Œéœ€è¦å¤šå°‘ç©ºé—´å°±åˆ†é…å¤šå°‘ã€‚<a href="https://doc.rust-lang.org/std/io/trait.Read.html#method.bytes"><code>bytes()</code></a>å’Œ<a href="https://doc.rust-lang.org/std/io/trait.Read.html#method.chars"><code>chars()</code></a>åˆ†åˆ«å…è®¸ä½ å¯¹æ–‡ä»¶çš„å­—èŠ‚å’Œå­—ç¬¦è¿›è¡Œè¿­ä»£ã€‚æœ€åï¼Œ<a href="https://doc.rust-lang.org/std/io/trait.Read.html#method.take"><code>take()</code></a>å…è®¸ä½ ä»æ–‡ä»¶ä¸­è¯»å–ä»»æ„æ•°é‡çš„å­—èŠ‚ã€‚æ€»çš„æ¥è¯´ï¼Œè¿™äº›åº”è¯¥å…è®¸ä½ æœ‰æ•ˆåœ°è¯»å…¥ä»»ä½•ä½ éœ€è¦çš„æ•°æ®ã€‚</p><p>å¯¹äºç¼“å†²è¯»å–ï¼Œä½¿ç”¨<a href="https://doc.rust-lang.org/std/io/struct.BufReader.html"><code>BufReader</code></a>ç»“æ„ï¼Œè¿™æœ‰åŠ©äºå‡å°‘è¯»å–æ—¶çš„ç³»ç»Ÿè°ƒç”¨æ•°é‡ã€‚</p><h2 id="æˆ‘å¦‚ä½•åœ¨-Rust-ä¸­è¿›è¡Œå¼‚æ­¥è¾“å…¥-è¾“å‡ºï¼Ÿ"><a href="#æˆ‘å¦‚ä½•åœ¨-Rust-ä¸­è¿›è¡Œå¼‚æ­¥è¾“å…¥-è¾“å‡ºï¼Ÿ" class="headerlink" title="æˆ‘å¦‚ä½•åœ¨ Rust ä¸­è¿›è¡Œå¼‚æ­¥è¾“å…¥/è¾“å‡ºï¼Ÿ"></a>æˆ‘å¦‚ä½•åœ¨ Rust ä¸­è¿›è¡Œå¼‚æ­¥è¾“å…¥/è¾“å‡ºï¼Ÿ</h2><p>ä½¿ç”¨ <a href="https://github.com/tokio-rs/tokio">tokio</a>ã€‚</p><h2 id="æˆ‘å¦‚ä½•åœ¨-Rust-ä¸­è·å¾—å‘½ä»¤è¡Œå‚æ•°"><a href="#æˆ‘å¦‚ä½•åœ¨-Rust-ä¸­è·å¾—å‘½ä»¤è¡Œå‚æ•°" class="headerlink" title="æˆ‘å¦‚ä½•åœ¨ Rust ä¸­è·å¾—å‘½ä»¤è¡Œå‚æ•°?"></a>æˆ‘å¦‚ä½•åœ¨ Rust ä¸­è·å¾—å‘½ä»¤è¡Œå‚æ•°?</h2><p>æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨<a href="https://doc.rust-lang.org/std/env/struct.Args.html"><code>Args</code></a>ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªè¾“å…¥å‚æ•°çš„è¿­ä»£å™¨ã€‚</p><p>å¦‚æœä½ æ­£åœ¨å¯»æ‰¾æ›´å¼ºå¤§çš„åº“ï¼Œåœ¨ crates.io ä¸Šæœ‰<a href="https://crates.io/keywords/argument">ä¸€äº›é€‰é¡¹</a>ã€‚</p><h1 id="é”™è¯¯å¤„ç†"><a href="#é”™è¯¯å¤„ç†" class="headerlink" title="é”™è¯¯å¤„ç†"></a>é”™è¯¯å¤„ç†</h1><h2 id="ä¸ºä»€ä¹ˆ-Rust-æ²¡æœ‰å¼‚å¸¸ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆ-Rust-æ²¡æœ‰å¼‚å¸¸ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆ Rust æ²¡æœ‰å¼‚å¸¸ï¼Ÿ"></a>ä¸ºä»€ä¹ˆ Rust æ²¡æœ‰å¼‚å¸¸ï¼Ÿ</h2><p>å¼‚å¸¸ä½¿æ§åˆ¶æµçš„ç†è§£å¤æ‚åŒ–ï¼Œå®ƒä»¬åœ¨ç±»å‹ç³»ç»Ÿä¹‹å¤–è¡¨è¾¾æœ‰æ•ˆæ€§/æ— æ•ˆæ€§ï¼Œè€Œä¸”å®ƒä»¬ä¸å¤šçº¿ç¨‹ä»£ç ï¼ˆRust çš„ä¸»è¦ç„¦ç‚¹ï¼‰çš„äº’æ“ä½œæ€§å¾ˆå·®ã€‚</p><p>Rust æ›´å€¾å‘äºé‡‡ç”¨åŸºäºç±»å‹çš„é”™è¯¯å¤„ç†æ–¹æ³•ï¼Œè¿™åœ¨ä¹¦ä¸­æœ‰<a href="https://doc.rust-lang.org/book/ch09-00-error-handling.html">è¯¦ç»†ä»‹ç»</a>ã€‚è¿™ä¸ Rust çš„æ§åˆ¶æµã€å¹¶å‘æ€§å’Œå…¶ä»–ä¸€åˆ‡éƒ½æ›´åŠ å»åˆã€‚</p><h2 id="åˆ°å¤„éƒ½æœ‰-unwrap-â€™æ˜¯æ€ä¹ˆå›äº‹"><a href="#åˆ°å¤„éƒ½æœ‰-unwrap-â€™æ˜¯æ€ä¹ˆå›äº‹" class="headerlink" title="åˆ°å¤„éƒ½æœ‰`unwrap()â€™æ˜¯æ€ä¹ˆå›äº‹?"></a>åˆ°å¤„éƒ½æœ‰`unwrap()â€™æ˜¯æ€ä¹ˆå›äº‹?</h2><p><code>unwrap()</code>æ˜¯ä¸€ä¸ªæå–<a href="https://doc.rust-lang.org/std/option/enum.Option.html"><code>Option</code></a>æˆ–<a href="https://doc.rust-lang.org/std/result/enum.Result.html"><code>Result</code></a>é‡Œé¢çš„å€¼çš„å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰å€¼å°±ä¼š panicã€‚</p><p><code>unwrap()</code>ä¸åº”è¯¥æ˜¯ä½ å¤„ç†é¢„æœŸå‡ºç°çš„é”™è¯¯çš„é»˜è®¤æ–¹å¼ï¼Œä¾‹å¦‚ç”¨æˆ·è¾“å…¥ä¸æ­£ç¡®ã€‚åœ¨ç”Ÿäº§ä»£ç ä¸­ï¼Œå®ƒåº”è¯¥è¢«è§†ä¸ºä¸€ä¸ªæ–­è¨€ï¼Œå³è¯¥å€¼æ˜¯éç©ºçš„ï¼Œå¦‚æœè¿åï¼Œå°†ä½¿ç¨‹åºå´©æºƒã€‚</p><p>å®ƒå¯¹å¿«é€ŸåŸå‹ä¹Ÿå¾ˆæœ‰ç”¨ï¼Œåœ¨é‚£é‡Œä½ è¿˜ä¸æƒ³å¤„ç†é”™è¯¯ï¼Œæˆ–è€…åœ¨åšå®¢æ–‡ç« ä¸­ï¼Œé”™è¯¯å¤„ç†ä¼šåˆ†æ•£å¯¹é‡ç‚¹çš„æ³¨æ„åŠ›ã€‚</p><h2 id="å½“æˆ‘è¯•å›¾è¿è¡Œä½¿ç”¨try-å®çš„ç¤ºä¾‹ä»£ç æ—¶ï¼Œä¸ºä»€ä¹ˆæˆ‘å¾—åˆ°ä¸€ä¸ªé”™è¯¯"><a href="#å½“æˆ‘è¯•å›¾è¿è¡Œä½¿ç”¨try-å®çš„ç¤ºä¾‹ä»£ç æ—¶ï¼Œä¸ºä»€ä¹ˆæˆ‘å¾—åˆ°ä¸€ä¸ªé”™è¯¯" class="headerlink" title="å½“æˆ‘è¯•å›¾è¿è¡Œä½¿ç”¨try!å®çš„ç¤ºä¾‹ä»£ç æ—¶ï¼Œä¸ºä»€ä¹ˆæˆ‘å¾—åˆ°ä¸€ä¸ªé”™è¯¯?"></a>å½“æˆ‘è¯•å›¾è¿è¡Œä½¿ç”¨<code>try!</code>å®çš„ç¤ºä¾‹ä»£ç æ—¶ï¼Œä¸ºä»€ä¹ˆæˆ‘å¾—åˆ°ä¸€ä¸ªé”™è¯¯?</h2><p>è¿™å¯èƒ½æ˜¯å‡½æ•°çš„è¿”å›ç±»å‹çš„é—®é¢˜ã€‚<a href="https://doc.rust-lang.org/std/macro.try!.html"><code>try!</code></a>å®è¦ä¹ˆä»<a href="https://doc.rust-lang.org/std/result/enum.Result.html"><code>Result</code></a>ä¸­æå–æ•°å€¼ï¼Œè¦ä¹ˆæå‰è¿”å›ï¼Œé”™è¯¯æ˜¯<a href="https://doc.rust-lang.org/std/result/enum.Result.html"><code>Result</code></a>æºå¸¦çš„ã€‚è¿™æ„å‘³ç€<a href="https://doc.rust-lang.org/std/macro.try!.html"><code>try</code></a>åªå¯¹è¿”å›<a href="https://doc.rust-lang.org/std/result/enum.Result.html"><code>Result</code></a>æœ¬èº«çš„å‡½æ•°æœ‰æ•ˆï¼Œå…¶ä¸­<code>Err</code>æ„é€ çš„ç±»å‹å®ç°äº†<code>From::from(err)</code>ã€‚ç‰¹åˆ«æ˜¯ï¼Œè¿™æ„å‘³ç€<a href="https://doc.rust-lang.org/std/macro.try!.html"><code>try!</code></a>å®ä¸èƒ½åœ¨<code>main</code>å‡½æ•°ä¸­å·¥ä½œã€‚</p><h2 id="æœ‰æ²¡æœ‰æ¯”åˆ°å¤„éƒ½æ˜¯â€œResultâ€æ›´ç®€å•çš„æ–¹æ³•æ¥åšé”™è¯¯å¤„ç†ï¼Ÿ"><a href="#æœ‰æ²¡æœ‰æ¯”åˆ°å¤„éƒ½æ˜¯â€œResultâ€æ›´ç®€å•çš„æ–¹æ³•æ¥åšé”™è¯¯å¤„ç†ï¼Ÿ" class="headerlink" title="æœ‰æ²¡æœ‰æ¯”åˆ°å¤„éƒ½æ˜¯â€œResultâ€æ›´ç®€å•çš„æ–¹æ³•æ¥åšé”™è¯¯å¤„ç†ï¼Ÿ"></a>æœ‰æ²¡æœ‰æ¯”åˆ°å¤„éƒ½æ˜¯â€œResultâ€æ›´ç®€å•çš„æ–¹æ³•æ¥åšé”™è¯¯å¤„ç†ï¼Ÿ</h2><p>å¦‚æœä½ æ­£åœ¨å¯»æ‰¾ä¸€ç§æ–¹æ³•æ¥é¿å…åœ¨å…¶ä»–äººçš„ä»£ç ä¸­å¤„ç†<a href="https://doc.rust-lang.org/std/result/enum.Result.html"><code>Result</code></a>ï¼Œæ€»æ˜¯æœ‰<a href="https://doc.rust-lang.org/core/option/enum.Option.html#method.unwrap"><code>unwrap()</code></a>ï¼Œä½†è¿™å¯èƒ½ä¸æ˜¯ä½ æƒ³è¦çš„ã€‚<a href="https://doc.rust-lang.org/std/result/enum.Result.html"><code>Result</code></a>æ˜¯ä¸€ä¸ªæŒ‡æ ‡ï¼Œè¡¨æ˜æŸäº›è®¡ç®—å¯èƒ½ä¼šæˆ–å¯èƒ½ä¸ä¼šæˆåŠŸå®Œæˆã€‚è¦æ±‚ä½ æ˜ç¡®åœ°å¤„ç†è¿™äº›å¤±è´¥æ˜¯ Rust é¼“åŠ±å¥å£®æ€§çš„æ–¹å¼ä¹‹ä¸€ã€‚Rust æä¾›äº†åƒ<a href="https://doc.rust-lang.org/std/macro.try!.html"><code>try!</code>å®</a>è¿™æ ·çš„å·¥å…·ï¼Œä½¿å¤„ç†å¤±è´¥çš„è¿‡ç¨‹ç¬¦åˆäººä½“å·¥ç¨‹å­¦ã€‚</p><p>å¦‚æœä½ çœŸçš„ä¸æƒ³å¤„ç†é”™è¯¯ï¼Œå¯ä»¥ä½¿ç”¨<a href="https://doc.rust-lang.org/core/option/enum.Option.html#method.unwrap"><code>unwrap()</code></a>ï¼Œä½†è¦çŸ¥é“ï¼Œè¿™æ ·åšæ„å‘³ç€ä»£ç åœ¨å¤±è´¥æ—¶ panicï¼Œè¿™é€šå¸¸ä¼šå¯¼è‡´å…³é—­è¿›ç¨‹ã€‚</p><h1 id="å¹¶å‘"><a href="#å¹¶å‘" class="headerlink" title="å¹¶å‘"></a>å¹¶å‘</h1><h2 id="æˆ‘å¯ä»¥åœ¨æ²¡æœ‰â€œä¸å®‰å…¨â€å—çš„æƒ…å†µä¸‹è·¨çº¿ç¨‹ä½¿ç”¨é™æ€å€¼å—ï¼Ÿ"><a href="#æˆ‘å¯ä»¥åœ¨æ²¡æœ‰â€œä¸å®‰å…¨â€å—çš„æƒ…å†µä¸‹è·¨çº¿ç¨‹ä½¿ç”¨é™æ€å€¼å—ï¼Ÿ" class="headerlink" title="æˆ‘å¯ä»¥åœ¨æ²¡æœ‰â€œä¸å®‰å…¨â€å—çš„æƒ…å†µä¸‹è·¨çº¿ç¨‹ä½¿ç”¨é™æ€å€¼å—ï¼Ÿ"></a>æˆ‘å¯ä»¥åœ¨æ²¡æœ‰â€œä¸å®‰å…¨â€å—çš„æƒ…å†µä¸‹è·¨çº¿ç¨‹ä½¿ç”¨é™æ€å€¼å—ï¼Ÿ</h2><p>å¦‚æœæ˜¯åŒæ­¥çš„ï¼Œä¿®æ”¹æ˜¯å®‰å…¨çš„ã€‚ä¿®æ”¹ä¸€ä¸ªé™æ€çš„<a href="https://doc.rust-lang.org/std/sync/struct.Mutex.html"><code>Mutex</code></a>ï¼ˆé€šè¿‡<a href="https://crates.io/crates/lazy_static/">lazy-static</a> crate æ‡’æƒ°åœ°åˆå§‹åŒ–ï¼‰ä¸éœ€è¦ä¸€ä¸ª<code>unsafe</code>å—ï¼Œä¿®æ”¹ä¸€ä¸ªé™æ€çš„<a href="https://doc.rust-lang.org/std/sync/atomic/struct.AtomicUsize.html"><code>AtomicUsize</code></a>ï¼ˆå¯ä»¥ä¸ç”¨ lazy_static åˆå§‹åŒ–ï¼‰ä¹Ÿæ˜¯å¦‚æ­¤ã€‚</p><p>æ›´ä¸€èˆ¬åœ°è¯´ï¼Œå¦‚æœä¸€ä¸ªç±»å‹å®ç°äº†<a href="https://doc.rust-lang.org/std/marker/trait.Sync.html"><code>Sync</code></a>ï¼Œå¹¶ä¸”æ²¡æœ‰å®ç°<a href="https://doc.rust-lang.org/std/ops/trait.Drop.html"><code>Drop</code></a>ï¼Œå®ƒ<a href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#accessing-or-modifying-a-mutable-static-variable">å¯ä»¥åœ¨<code>static</code>ä¸­ä½¿ç”¨</a>ã€‚</p><h1 id="å®"><a href="#å®" class="headerlink" title="å®"></a>å®</h1><h2 id="æˆ‘å¯ä»¥å†™ä¸€ä¸ªå®æ¥ç”Ÿæˆæ ‡è¯†ç¬¦å—"><a href="#æˆ‘å¯ä»¥å†™ä¸€ä¸ªå®æ¥ç”Ÿæˆæ ‡è¯†ç¬¦å—" class="headerlink" title="æˆ‘å¯ä»¥å†™ä¸€ä¸ªå®æ¥ç”Ÿæˆæ ‡è¯†ç¬¦å—?"></a>æˆ‘å¯ä»¥å†™ä¸€ä¸ªå®æ¥ç”Ÿæˆæ ‡è¯†ç¬¦å—?</h2><p>ç›®å‰ä¸èƒ½ã€‚Rust çš„å®æ˜¯<a href="https://en.wikipedia.org/wiki/Hygienic_macro">â€œå«ç”Ÿå®â€</a>ï¼Œå®ƒæœ‰æ„é¿å…æ•æ‰æˆ–åˆ›å»ºå¯èƒ½ä¸å…¶ä»–æ ‡è¯†ç¬¦å‘ç”Ÿæ„å¤–ç¢°æ’çš„æ ‡è¯†ç¬¦ã€‚å®ƒä»¬çš„åŠŸèƒ½ä¸é€šå¸¸ä¸ C é¢„å¤„ç†å™¨ç›¸å…³çš„å®çš„é£æ ¼æ˜æ˜¾ä¸åŒã€‚å®è°ƒç”¨åªèƒ½å‡ºç°åœ¨è¢«æ˜ç¡®æ”¯æŒçš„åœ°æ–¹ï¼šé¡¹ç›®ã€æ–¹æ³•å£°æ˜ã€è¯­å¥ã€è¡¨è¾¾å¼å’Œæ¨¡å¼ã€‚è¿™é‡Œï¼Œâ€œæ–¹æ³•å£°æ˜â€æŒ‡çš„æ˜¯å¯ä»¥æ”¾ç½®æ–¹æ³•çš„ç©ºç™½å¤„ã€‚å®ƒä»¬ä¸èƒ½è¢«ç”¨æ¥å®Œæˆéƒ¨åˆ†æ–¹æ³•å£°æ˜ã€‚æŒ‰ç…§åŒæ ·çš„é€»è¾‘ï¼Œå®ƒä»¬ä¹Ÿä¸èƒ½ç”¨æ¥å®Œæˆä¸€ä¸ªéƒ¨åˆ†å˜é‡å£°æ˜ã€‚</p><h1 id="Debugging-and-Tooling"><a href="#Debugging-and-Tooling" class="headerlink" title="Debugging and Tooling"></a>Debugging and Tooling</h1><h2 id="æˆ‘å¦‚ä½•è°ƒè¯•-Rust-ç¨‹åºï¼Ÿ"><a href="#æˆ‘å¦‚ä½•è°ƒè¯•-Rust-ç¨‹åºï¼Ÿ" class="headerlink" title="æˆ‘å¦‚ä½•è°ƒè¯• Rust ç¨‹åºï¼Ÿ"></a>æˆ‘å¦‚ä½•è°ƒè¯• Rust ç¨‹åºï¼Ÿ</h2><p>Rust ç¨‹åºå¯ä»¥ä½¿ç”¨ <a href="https://sourceware.org/gdb/current/onlinedocs/gdb/">gdb</a> æˆ– <a href="http://lldb.llvm.org/tutorial.html">lldb</a> è¿›è¡Œè°ƒè¯•ï¼Œä¸ C å’Œ C++ ç›¸åŒã€‚äº‹å®ä¸Šï¼Œæ¯ä¸€ä¸ª Rust çš„å®‰è£…éƒ½å¸¦æœ‰ rust-gdb å’Œ rust-lldb ä¸­çš„ä¸€ä¸ªæˆ–ä¸¤ä¸ªï¼ˆå–å†³äºå¹³å°æ”¯æŒï¼‰ã€‚è¿™äº›æ˜¯å¯¹ gdb å’Œ lldb çš„å°è£…ï¼Œå¹¶å¯ç”¨äº† Rust pretty-printingã€‚</p><h2 id="rustcè¯´æ ‡å‡†åº“ä»£ç ä¸­å‘ç”Ÿäº†-panicã€‚æˆ‘å¦‚ä½•å®šä½æˆ‘çš„ä»£ç ä¸­çš„é”™è¯¯ï¼Ÿ"><a href="#rustcè¯´æ ‡å‡†åº“ä»£ç ä¸­å‘ç”Ÿäº†-panicã€‚æˆ‘å¦‚ä½•å®šä½æˆ‘çš„ä»£ç ä¸­çš„é”™è¯¯ï¼Ÿ" class="headerlink" title="rustcè¯´æ ‡å‡†åº“ä»£ç ä¸­å‘ç”Ÿäº† panicã€‚æˆ‘å¦‚ä½•å®šä½æˆ‘çš„ä»£ç ä¸­çš„é”™è¯¯ï¼Ÿ"></a><code>rustc</code>è¯´æ ‡å‡†åº“ä»£ç ä¸­å‘ç”Ÿäº† panicã€‚æˆ‘å¦‚ä½•å®šä½æˆ‘çš„ä»£ç ä¸­çš„é”™è¯¯ï¼Ÿ</h2><p>è¿™ä¸ªé”™è¯¯é€šå¸¸æ˜¯ç”±å®¢æˆ·ç«¯ä»£ç ä¸­<a href="https://doc.rust-lang.org/core/option/enum.Option.html#method.unwrap"><code>unwrap()</code>ing</a>ä¸€ä¸ª<code>None</code>æˆ–<code>Err</code>å¼•èµ·çš„ã€‚é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡<code>RUST_BACKTRACE=1</code>æ¥å¯ç”¨å›æº¯ï¼Œæœ‰åŠ©äºè·å¾—æ›´å¤šä¿¡æ¯ã€‚åœ¨è°ƒè¯•æ¨¡å¼ä¸‹ç¼–è¯‘ï¼ˆé»˜è®¤ä¸ºâ€œcargo buildâ€ï¼‰ä¹Ÿæœ‰å¸®åŠ©ã€‚ä½¿ç”¨è°ƒè¯•å™¨ï¼Œå¦‚æä¾›çš„<code>rust-gdb</code>æˆ–<code>rust-lldb</code>ä¹Ÿå¾ˆæœ‰å¸®åŠ©ã€‚</p><h2 id="æˆ‘åº”è¯¥ä½¿ç”¨ä»€ä¹ˆ-IDEï¼Ÿ"><a href="#æˆ‘åº”è¯¥ä½¿ç”¨ä»€ä¹ˆ-IDEï¼Ÿ" class="headerlink" title="æˆ‘åº”è¯¥ä½¿ç”¨ä»€ä¹ˆ IDEï¼Ÿ"></a>æˆ‘åº”è¯¥ä½¿ç”¨ä»€ä¹ˆ IDEï¼Ÿ</h2><p>Rust çš„å¼€å‘ç¯å¢ƒæœ‰å¾ˆå¤šé€‰æ‹©ï¼Œæ‰€æœ‰è¿™äº›éƒ½åœ¨éå®˜æ–¹çš„ <a href="https://areweideyet.com/">IDE æ”¯æŒé¡µé¢</a>ä¸Šæœ‰è¯¦ç»†è¯´æ˜ã€‚</p><h1 id="Low-Level"><a href="#Low-Level" class="headerlink" title="Low-Level"></a>Low-Level</h1><h2 id="æˆ‘æ€æ ·æ‰èƒ½memcpyå­—èŠ‚"><a href="#æˆ‘æ€æ ·æ‰èƒ½memcpyå­—èŠ‚" class="headerlink" title="æˆ‘æ€æ ·æ‰èƒ½memcpyå­—èŠ‚?"></a>æˆ‘æ€æ ·æ‰èƒ½<code>memcpy</code>å­—èŠ‚?</h2><p>å¦‚æœä½ æƒ³å®‰å…¨åœ°å…‹éš†ä¸€ä¸ªç°æœ‰çš„åˆ†ç‰‡ï¼Œä½ å¯ä»¥ä½¿ç”¨<a href="https://doc.rust-lang.org/std/primitive.slice.html#method.clone_from_slice"><code>clone_from_slice</code></a>ã€‚</p><p>è¦å¤åˆ¶å¯èƒ½é‡å çš„å­—èŠ‚ï¼Œä½¿ç”¨<a href="https://doc.rust-lang.org/std/marker/trait.Copy.html"><code>copy</code></a>ã€‚è¦å¤åˆ¶ä¸é‡å çš„å­—èŠ‚ï¼Œä½¿ç”¨<a href="https://doc.rust-lang.org/std/ptr/fn.copy_nonoverlapping.html"><code>copy_nonoverlapping</code></a>ã€‚è¿™ä¸¤ä¸ªå‡½æ•°éƒ½æ˜¯â€œä¸å®‰å…¨â€çš„ï¼Œå› ä¸ºå®ƒä»¬éƒ½å¯ä»¥è¢«ç”¨æ¥ç ´åè¯­è¨€çš„å®‰å…¨ä¿è¯ã€‚åœ¨ä½¿ç”¨å®ƒä»¬æ—¶è¦æ³¨æ„ã€‚</p><h2 id="æ²¡æœ‰æ ‡å‡†åº“ï¼ŒRust-èƒ½åˆç†åœ°è¿è¡Œå—ï¼Ÿ"><a href="#æ²¡æœ‰æ ‡å‡†åº“ï¼ŒRust-èƒ½åˆç†åœ°è¿è¡Œå—ï¼Ÿ" class="headerlink" title="æ²¡æœ‰æ ‡å‡†åº“ï¼ŒRust èƒ½åˆç†åœ°è¿è¡Œå—ï¼Ÿ"></a>æ²¡æœ‰æ ‡å‡†åº“ï¼ŒRust èƒ½åˆç†åœ°è¿è¡Œå—ï¼Ÿ</h2><p>å½“ç„¶å¯ä»¥ã€‚Rust ç¨‹åºå¯ä»¥ä½¿ç”¨<code>#![no_std]</code>å±æ€§è®¾ç½®ä¸ºä¸åŠ è½½æ ‡å‡†åº“ã€‚è®¾ç½®äº†è¿™ä¸ªå±æ€§åï¼Œä½ å¯ä»¥ç»§ç»­ä½¿ç”¨ Rust æ ¸å¿ƒåº“ï¼Œå®ƒåªæ˜¯å¹³å°æ— å…³çš„åŸè¯­ã€‚å› æ­¤ï¼Œå®ƒä¸åŒ…æ‹¬ IOã€å¹¶å‘æ€§ã€å †åˆ†é…ç­‰ã€‚</p><h2 id="æˆ‘å¯ä»¥ç”¨-Rust-å†™ä¸€ä¸ªæ“ä½œç³»ç»Ÿå—ï¼Ÿ"><a href="#æˆ‘å¯ä»¥ç”¨-Rust-å†™ä¸€ä¸ªæ“ä½œç³»ç»Ÿå—ï¼Ÿ" class="headerlink" title="æˆ‘å¯ä»¥ç”¨ Rust å†™ä¸€ä¸ªæ“ä½œç³»ç»Ÿå—ï¼Ÿ"></a>æˆ‘å¯ä»¥ç”¨ Rust å†™ä¸€ä¸ªæ“ä½œç³»ç»Ÿå—ï¼Ÿ</h2><p>æ˜¯çš„ï¼äº‹å®ä¸Šï¼Œæœ‰<a href="http://wiki.osdev.org/Rust">å‡ ä¸ªæ­£åœ¨è¿›è¡Œçš„é¡¹ç›®å°±æ˜¯è¿™æ ·</a>ã€‚</p><h2 id="æˆ‘å¦‚ä½•åœ¨æ–‡ä»¶æˆ–å…¶ä»–å­—èŠ‚æµä¸­ä»¥å¤§æ•°æˆ–å°æ•°æ ¼å¼è¯»å†™æ•°å­—ç±»å‹å¦‚i32æˆ–f64"><a href="#æˆ‘å¦‚ä½•åœ¨æ–‡ä»¶æˆ–å…¶ä»–å­—èŠ‚æµä¸­ä»¥å¤§æ•°æˆ–å°æ•°æ ¼å¼è¯»å†™æ•°å­—ç±»å‹å¦‚i32æˆ–f64" class="headerlink" title="æˆ‘å¦‚ä½•åœ¨æ–‡ä»¶æˆ–å…¶ä»–å­—èŠ‚æµä¸­ä»¥å¤§æ•°æˆ–å°æ•°æ ¼å¼è¯»å†™æ•°å­—ç±»å‹å¦‚i32æˆ–f64?"></a>æˆ‘å¦‚ä½•åœ¨æ–‡ä»¶æˆ–å…¶ä»–å­—èŠ‚æµä¸­ä»¥å¤§æ•°æˆ–å°æ•°æ ¼å¼è¯»å†™æ•°å­—ç±»å‹å¦‚<code>i32</code>æˆ–<code>f64</code>?</h2><p>ä½ åº”è¯¥çœ‹çœ‹ <a href="https://docs.rs/byteorder">byteorder crate</a>ï¼Œå®ƒæä¾›äº†ç›¸åº”çš„å®ç”¨ç¨‹åºã€‚</p><h2 id="Rust-æ˜¯å¦ä¿è¯ä¸€ä¸ªç‰¹å®šçš„æ•°æ®å¸ƒå±€ï¼Ÿ"><a href="#Rust-æ˜¯å¦ä¿è¯ä¸€ä¸ªç‰¹å®šçš„æ•°æ®å¸ƒå±€ï¼Ÿ" class="headerlink" title="Rust æ˜¯å¦ä¿è¯ä¸€ä¸ªç‰¹å®šçš„æ•°æ®å¸ƒå±€ï¼Ÿ"></a>Rust æ˜¯å¦ä¿è¯ä¸€ä¸ªç‰¹å®šçš„æ•°æ®å¸ƒå±€ï¼Ÿ</h2><p>é»˜è®¤æƒ…å†µä¸‹ä¸æ˜¯ã€‚åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ<code>enum</code>å’Œ<code>struct</code>çš„å¸ƒå±€æ˜¯æœªå®šä¹‰çš„ã€‚è¿™å…è®¸ç¼–è¯‘å™¨è¿›è¡Œæ½œåœ¨çš„ä¼˜åŒ–ï¼Œæ¯”å¦‚ä¸ºåˆ¤åˆ«å¼é‡æ–°ä½¿ç”¨å¡«å……ç‰©ï¼Œå‹ç¼©åµŒå¥—çš„<code>enum</code>çš„å˜ä½“ï¼Œé‡æ–°æ’åºå­—æ®µä»¥ç§»é™¤å¡«å……ç‰©ï¼Œç­‰ç­‰ã€‚ä¸æºå¸¦æ•°æ®çš„<code>enum</code>ï¼ˆâ€œC-likeâ€ï¼‰æœ‰èµ„æ ¼æ‹¥æœ‰ä¸€ä¸ªå®šä¹‰çš„è¡¨ç¤ºã€‚è¿™ç§<code>æšä¸¾</code>å¾ˆå®¹æ˜“åŒºåˆ†ï¼Œå› ä¸ºå®ƒä»¬åªæ˜¯ä¸€ä¸ªæ²¡æœ‰æ•°æ®çš„åå­—åˆ—è¡¨ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">snum CLike &#123;</span><br><span class="line">    A,</span><br><span class="line">    B = <span class="number">32</span>,</span><br><span class="line">    C = <span class="number">34</span>,</span><br><span class="line">    D</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ï¼ƒ[repr(C)]</code>å±æ€§å¯ä»¥åº”ç”¨äºè¿™äº›â€œenumâ€ï¼Œä½¿å®ƒä»¬åœ¨åŒç­‰çš„ C ä»£ç ä¸­å…·æœ‰ç›¸åŒçš„è¡¨ç¤ºã€‚è¿™å…è®¸åœ¨ FFI ä»£ç ä¸­ä½¿ç”¨ Rust çš„â€œenumâ€ï¼Œè€Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ä¹Ÿä½¿ç”¨ C çš„â€œenumâ€ã€‚è¯¥å±æ€§ä¹Ÿå¯ä»¥åº”ç”¨äº<code>struct</code>ï¼Œä»¥è·å¾—ä¸<code>C struct</code>ç›¸åŒçš„å¸ƒå±€ã€‚</p><h1 id="è·¨å¹³å°"><a href="#è·¨å¹³å°" class="headerlink" title="è·¨å¹³å°"></a>è·¨å¹³å°</h1><h2 id="åœ¨-Rust-ä¸­è¡¨è¾¾ç‰¹å®šå¹³å°è¡Œä¸ºçš„ä¹ æƒ¯æ€§æ–¹æ³•æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#åœ¨-Rust-ä¸­è¡¨è¾¾ç‰¹å®šå¹³å°è¡Œä¸ºçš„ä¹ æƒ¯æ€§æ–¹æ³•æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="åœ¨ Rust ä¸­è¡¨è¾¾ç‰¹å®šå¹³å°è¡Œä¸ºçš„ä¹ æƒ¯æ€§æ–¹æ³•æ˜¯ä»€ä¹ˆï¼Ÿ"></a>åœ¨ Rust ä¸­è¡¨è¾¾ç‰¹å®šå¹³å°è¡Œä¸ºçš„ä¹ æƒ¯æ€§æ–¹æ³•æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>å¹³å°ç‰¹å®šè¡Œä¸ºå¯ä»¥ç”¨<a href="https://doc.rust-lang.org/reference/attributes.html#conditional-compilation">æ¡ä»¶ç¼–è¯‘å±æ€§</a>æ¥è¡¨è¾¾ï¼Œå¦‚<code>target_os</code>, <code>target_family</code>, <code>target_endian</code>ï¼Œç­‰ç­‰ã€‚</p><h2 id="Rust-å¯ä»¥ç”¨äº-Android-iOS-ç¼–ç¨‹å—ï¼Ÿ"><a href="#Rust-å¯ä»¥ç”¨äº-Android-iOS-ç¼–ç¨‹å—ï¼Ÿ" class="headerlink" title="Rust å¯ä»¥ç”¨äº Android/iOS ç¼–ç¨‹å—ï¼Ÿ"></a>Rust å¯ä»¥ç”¨äº Android/iOS ç¼–ç¨‹å—ï¼Ÿ</h2><p>æ˜¯çš„ï¼Œå®ƒå¯ä»¥! åœ¨ <a href="https://github.com/tomaka/android-rs-glue">Android</a>å’Œ <a href="https://www.bignerdranch.com/blog/building-an-ios-app-in-rust-part-1/">iOS</a> ä¸­éƒ½å·²ç»æœ‰ä½¿ç”¨ Rust çš„ä¾‹å­ã€‚å®ƒç¡®å®éœ€è¦ä¸€äº›å·¥ä½œæ¥è®¾ç½®ï¼Œä½† Rust åœ¨è¿™ä¸¤ä¸ªå¹³å°ä¸Šçš„åŠŸèƒ½éƒ½å¾ˆå¥½ã€‚</p><h2 id="æˆ‘å¯ä»¥åœ¨ç½‘ç»œæµè§ˆå™¨ä¸­è¿è¡Œæˆ‘çš„-Rust-ç¨‹åºå—ï¼Ÿ"><a href="#æˆ‘å¯ä»¥åœ¨ç½‘ç»œæµè§ˆå™¨ä¸­è¿è¡Œæˆ‘çš„-Rust-ç¨‹åºå—ï¼Ÿ" class="headerlink" title="æˆ‘å¯ä»¥åœ¨ç½‘ç»œæµè§ˆå™¨ä¸­è¿è¡Œæˆ‘çš„ Rust ç¨‹åºå—ï¼Ÿ"></a>æˆ‘å¯ä»¥åœ¨ç½‘ç»œæµè§ˆå™¨ä¸­è¿è¡Œæˆ‘çš„ Rust ç¨‹åºå—ï¼Ÿ</h2><p>æœ‰å¯èƒ½ã€‚Rust å¯¹<a href="http://asmjs.org/">asm.js</a>å’Œ<a href="http://webassembly.org/">WebAssembly</a>éƒ½æœ‰<a href="https://davidmcneil.gitbooks.io/the-rusty-web/">å®éªŒæ€§æ”¯æŒ</a>ã€‚</p><h2 id="æˆ‘å¦‚ä½•åœ¨-Rust-ä¸­è¿›è¡Œäº¤å‰ç¼–è¯‘ï¼Ÿ"><a href="#æˆ‘å¦‚ä½•åœ¨-Rust-ä¸­è¿›è¡Œäº¤å‰ç¼–è¯‘ï¼Ÿ" class="headerlink" title="æˆ‘å¦‚ä½•åœ¨ Rust ä¸­è¿›è¡Œäº¤å‰ç¼–è¯‘ï¼Ÿ"></a>æˆ‘å¦‚ä½•åœ¨ Rust ä¸­è¿›è¡Œäº¤å‰ç¼–è¯‘ï¼Ÿ</h2><p>åœ¨ Rust ä¸­å¯ä»¥è¿›è¡Œäº¤å‰ç¼–è¯‘ï¼Œä½†éœ€è¦<a href="https://github.com/japaric/rust-cross/blob/master/README.md">ä¸€ç‚¹å·¥ä½œ</a>æ¥è®¾ç½®ã€‚æ¯ä¸ª Rust ç¼–è¯‘å™¨éƒ½æ˜¯ä¸€ä¸ªäº¤å‰ç¼–è¯‘å™¨ï¼Œä½†æ˜¯åº“éœ€è¦é’ˆå¯¹ç›®æ ‡å¹³å°è¿›è¡Œäº¤å‰ç¼–è¯‘ã€‚</p><p>Rust ç¡®å®ä¸ºæ¯ä¸ªæ”¯æŒçš„å¹³å°åˆ†å‘äº†æ ‡å‡†åº“çš„å‰¯æœ¬ï¼Œè¿™äº›å‰¯æœ¬åŒ…å«åœ¨åˆ†å‘é¡µé¢ä¸Šæ‰¾åˆ°çš„æ¯ä¸ªæ„å»ºç›®å½•çš„<code>rust-std-*</code>æ–‡ä»¶ä¸­ï¼Œä½†ç›®å‰è¿˜æ²¡æœ‰è‡ªåŠ¨å®‰è£…çš„æ–¹æ³•ã€‚</p><h1 id="mod-å’Œ-crate"><a href="#mod-å’Œ-crate" class="headerlink" title="mod å’Œ crate"></a>mod å’Œ crate</h1><h2 id="mod-å’Œ-crate-ä¹‹é—´çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#mod-å’Œ-crate-ä¹‹é—´çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="mod å’Œ crate ä¹‹é—´çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ"></a>mod å’Œ crate ä¹‹é—´çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ</h2><ul><li>crate æ˜¯ä¸€ä¸ªç¼–è¯‘å•å…ƒï¼Œå®ƒæ˜¯ Rust ç¼–è¯‘å™¨å¯ä»¥æ“ä½œçš„æœ€å°çš„ä»£ç é‡ã€‚</li><li>mod æ˜¯ crate å†…çš„ä¸€ä¸ªï¼ˆå¯èƒ½æ˜¯åµŒå¥—çš„ï¼‰ä»£ç ç»„ç»‡å•å…ƒã€‚</li><li>ä¸€ä¸ª crate åŒ…å«ä¸€ä¸ªéšå«çš„ã€æœªå‘½åçš„é¡¶å±‚ modã€‚</li><li>é€’å½’å®šä¹‰å¯ä»¥è·¨è¶Š modï¼Œä½†ä¸èƒ½è·¨è¶Š crateã€‚</li></ul><h2 id="ä¸ºä»€ä¹ˆ-Rust-ç¼–è¯‘å™¨æ‰¾ä¸åˆ°æˆ‘æ­£åœ¨ä½¿ç”¨çš„è¿™ä¸ªåº“"><a href="#ä¸ºä»€ä¹ˆ-Rust-ç¼–è¯‘å™¨æ‰¾ä¸åˆ°æˆ‘æ­£åœ¨ä½¿ç”¨çš„è¿™ä¸ªåº“" class="headerlink" title="ä¸ºä»€ä¹ˆ Rust ç¼–è¯‘å™¨æ‰¾ä¸åˆ°æˆ‘æ­£åœ¨ä½¿ç”¨çš„è¿™ä¸ªåº“?"></a>ä¸ºä»€ä¹ˆ Rust ç¼–è¯‘å™¨æ‰¾ä¸åˆ°æˆ‘æ­£åœ¨<code>ä½¿ç”¨</code>çš„è¿™ä¸ªåº“?</h2><p>æœ‰å¾ˆå¤šå¯èƒ½çš„ç­”æ¡ˆï¼Œä½†ä¸€ä¸ªå¸¸è§çš„é”™è¯¯æ˜¯æ²¡æœ‰æ„è¯†åˆ°<code>use</code>å£°æ˜æ˜¯ç›¸å¯¹äº crate root çš„ã€‚è¯•ç€æ”¹å†™ä½ çš„å£°æ˜ï¼Œä½¿ç”¨å®ƒä»¬åœ¨ä½ çš„é¡¹ç›®æ ¹æ–‡ä»¶ä¸­å®šä¹‰çš„è·¯å¾„ï¼Œçœ‹çœ‹æ˜¯å¦èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>è¿˜æœ‰â€œselfâ€å’Œâ€œsuperâ€ï¼Œå®ƒä»¬åˆ†åˆ«å°†â€œuseâ€è·¯å¾„åŒºåˆ†ä¸ºç›¸å¯¹äºå½“å‰ mod æˆ–çˆ¶ modã€‚</p><p>å…³äº<code>use</code>åº“çš„å®Œæ•´ä¿¡æ¯ï¼Œè¯·é˜…è¯» Rust ä¹¦ä¸­çš„<a href="https://doc.rust-lang.org/book/ch07-00-managing-growing-projects-with-packages-crates-and-modules.html">â€œPackages, Crates, and Modulesâ€</a>ä¸€ç« ã€‚</p><h2 id="ä¸ºä»€ä¹ˆæˆ‘å¿…é¡»åœ¨-crate-çš„é¡¶å±‚ç”¨modå£°æ˜-mod-æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ç›´æ¥useå®ƒä»¬ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆæˆ‘å¿…é¡»åœ¨-crate-çš„é¡¶å±‚ç”¨modå£°æ˜-mod-æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ç›´æ¥useå®ƒä»¬ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆæˆ‘å¿…é¡»åœ¨ crate çš„é¡¶å±‚ç”¨modå£°æ˜ mod æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ç›´æ¥useå®ƒä»¬ï¼Ÿ"></a>ä¸ºä»€ä¹ˆæˆ‘å¿…é¡»åœ¨ crate çš„é¡¶å±‚ç”¨<code>mod</code>å£°æ˜ mod æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ç›´æ¥<code>use</code>å®ƒä»¬ï¼Ÿ</h2><p>åœ¨ Rust ä¸­ï¼Œæœ‰ä¸¤ç§æ–¹æ³•æ¥å£°æ˜æ¨¡å—ï¼Œå†…è”æˆ–åœ¨å¦ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚ä¸‹é¢æ˜¯å„è‡ªçš„ä¸€ä¸ªä¾‹å­ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In main.rs</span></span><br><span class="line"><span class="keyword">mod</span> hello &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">f</span></span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;hello!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    hello::f();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In main.rs</span></span><br><span class="line"><span class="keyword">mod</span> hello;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    hello::f();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// In hello.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">f</span></span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;hello!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ç¬¬ä¸€ä¸ªä¾‹å­ä¸­ï¼Œæ¨¡å—è¢«å®šä¹‰åœ¨å®ƒæ‰€ä½¿ç”¨çš„åŒä¸€æ–‡ä»¶ä¸­ã€‚åœ¨ç¬¬äºŒä¸ªä¾‹å­ä¸­ï¼Œä¸»æ–‡ä»¶ä¸­çš„æ¨¡å—å£°æ˜å‘Šè¯‰ç¼–è¯‘å™¨å¯»æ‰¾<code>hello.rs</code>æˆ–<code>hello/mod.rs</code>ï¼Œå¹¶åŠ è½½è¯¥æ–‡ä»¶ã€‚</p><p>æ³¨æ„<code>mod</code>å’Œ<code>use</code>ä¹‹é—´çš„åŒºåˆ«ï¼š<code>mod</code>å£°æ˜ä¸€ä¸ªæ¨¡å—çš„å­˜åœ¨ï¼Œè€Œ<code>use</code>å¼•ç”¨ä¸€ä¸ªåœ¨å…¶ä»–åœ°æ–¹å£°æ˜çš„æ¨¡å—ï¼Œå°†å…¶å†…å®¹çº³å…¥å½“å‰æ¨¡å—çš„èŒƒå›´ã€‚</p><h2 id="æˆ‘å¦‚ä½•é…ç½®-Cargo-ä½¿ç”¨ä»£ç†ï¼Ÿ"><a href="#æˆ‘å¦‚ä½•é…ç½®-Cargo-ä½¿ç”¨ä»£ç†ï¼Ÿ" class="headerlink" title="æˆ‘å¦‚ä½•é…ç½® Cargo ä½¿ç”¨ä»£ç†ï¼Ÿ"></a>æˆ‘å¦‚ä½•é…ç½® Cargo ä½¿ç”¨ä»£ç†ï¼Ÿ</h2><p>å‚è€ƒ <a href="https://rsproxy.cn/">https://rsproxy.cn/</a>ã€‚</p><h2 id="ä¸ºä»€ä¹ˆæˆ‘å·²ç»â€œuseâ€äº†-crateï¼Œä½†ç¼–è¯‘å™¨è¿˜æ˜¯æ‰¾ä¸åˆ°æ–¹æ³•çš„å®ç°ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆæˆ‘å·²ç»â€œuseâ€äº†-crateï¼Œä½†ç¼–è¯‘å™¨è¿˜æ˜¯æ‰¾ä¸åˆ°æ–¹æ³•çš„å®ç°ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆæˆ‘å·²ç»â€œuseâ€äº† crateï¼Œä½†ç¼–è¯‘å™¨è¿˜æ˜¯æ‰¾ä¸åˆ°æ–¹æ³•çš„å®ç°ï¼Ÿ"></a>ä¸ºä»€ä¹ˆæˆ‘å·²ç»â€œuseâ€äº† crateï¼Œä½†ç¼–è¯‘å™¨è¿˜æ˜¯æ‰¾ä¸åˆ°æ–¹æ³•çš„å®ç°ï¼Ÿ</h2><p>å¯¹äºå®šä¹‰åœ¨ trait ä¸Šçš„æ–¹æ³•ï¼Œä½ å¿…é¡»æ˜ç¡®å¯¼å…¥ trait å£°æ˜ã€‚è¿™æ„å‘³ç€ä»…ä»…å¯¼å…¥ä¸€ä¸ªç»“æ„å®ç° trait çš„æ¨¡å—æ˜¯ä¸å¤Ÿçš„ï¼Œä½ è¿˜å¿…é¡»å¯¼å…¥ trait æœ¬èº«ã€‚</p><h2 id="ä¸ºä»€ä¹ˆç¼–è¯‘å™¨ä¸èƒ½ä¸ºæˆ‘æ¨æ–­å‡ºuseå£°æ˜ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆç¼–è¯‘å™¨ä¸èƒ½ä¸ºæˆ‘æ¨æ–­å‡ºuseå£°æ˜ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆç¼–è¯‘å™¨ä¸èƒ½ä¸ºæˆ‘æ¨æ–­å‡ºuseå£°æ˜ï¼Ÿ"></a>ä¸ºä»€ä¹ˆç¼–è¯‘å™¨ä¸èƒ½ä¸ºæˆ‘æ¨æ–­å‡º<code>use</code>å£°æ˜ï¼Ÿ</h2><p>å®ƒå¯èƒ½å¯ä»¥ï¼Œä½†ä½ ä¹Ÿä¸å¸Œæœ›å®ƒè¿™æ ·åšã€‚è™½ç„¶åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨æœ‰å¯èƒ½é€šè¿‡ç®€å•åœ°å¯»æ‰¾ç»™å®šæ ‡è¯†ç¬¦çš„å®šä¹‰ä½ç½®æ¥ç¡®å®šå¯¼å…¥çš„æ­£ç¡®æ¨¡å—ï¼Œä½†åœ¨ä¸€èˆ¬æƒ…å†µä¸‹å¯èƒ½ä¸æ˜¯è¿™æ ·çš„ã€‚<code>rustc</code>ä¸­ä»»ä½•ç”¨äºé€‰æ‹©ç«äº‰æ€§é€‰é¡¹çš„å†³ç­–è§„åˆ™ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¼šå¼•èµ·æƒŠè®¶å’Œæ··ä¹±ï¼ŒRust æ›´å€¾å‘äºæ˜ç¡®è¯´æ˜åç§°çš„æ¥æºã€‚</p><p>ä¾‹å¦‚ï¼Œç¼–è¯‘å™¨å¯ä»¥è¯´ï¼Œåœ¨æ ‡è¯†ç¬¦å®šä¹‰ç›¸äº’ç«äº‰çš„æƒ…å†µä¸‹ï¼Œä¼šé€‰æ‹©æœ€æ—©å¯¼å…¥çš„æ¨¡å—çš„å®šä¹‰ã€‚æ‰€ä»¥å¦‚æœæ¨¡å—<code>foo</code>å’Œæ¨¡å—<code>bar</code>éƒ½å®šä¹‰äº†æ ‡è¯†ç¬¦<code>baz</code>ï¼Œä½†æ˜¯<code>foo</code>æ˜¯ç¬¬ä¸€ä¸ªæ³¨å†Œçš„æ¨¡å—ï¼Œç¼–è¯‘å™¨ä¼šæ’å…¥<code>use foo::baz;</code>ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mod</span> foo;</span><br><span class="line"><span class="keyword">mod</span> bar;</span><br><span class="line"></span><br><span class="line"><span class="comment">// use foo::baz  // to be inserted by the compiler.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">  baz();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ çŸ¥é“è¿™ç§æƒ…å†µä¼šå‘ç”Ÿï¼Œä¹Ÿè®¸å®ƒå¯ä»¥èŠ‚çœå°‘é‡çš„æŒ‰é”®ï¼Œä½†å®ƒä¹Ÿå¤§å¤§å¢åŠ äº†å½“ä½ çœŸæ­£æƒ³æŠŠ<code>baz()</code>å˜æˆ<code>bar::baz()</code>æ—¶å‡ºç°ä»¤äººæƒŠè®¶çš„é”™è¯¯ä¿¡æ¯çš„å¯èƒ½æ€§ï¼Œè€Œä¸”å®ƒé€šè¿‡ä½¿å‡½æ•°è°ƒç”¨çš„æ„ä¹‰ä¾èµ–äºæ¨¡å—å£°æ˜è€Œé™ä½äº†ä»£ç çš„å¯è¯»æ€§ã€‚è¿™äº›éƒ½æ˜¯æˆ‘ä»¬ä¸æ„¿æ„åšçš„æŠ˜è¡·ã€‚</p><p>ç„¶è€Œï¼ŒIDE å¯ä»¥å¸®åŠ©ç®¡ç†å£°æ˜ï¼Œè¿™å°†ç»™ä½ å¸¦æ¥ä¸¤æ–¹é¢çš„å¥½å¤„ï¼šæœºå™¨ååŠ©æ‹‰å…¥åå­—ï¼Œä½†æ˜ç¡®å£°æ˜è¿™äº›åå­—çš„æ¥æºã€‚</p><h2 id="æˆ‘å¦‚ä½•è¿›è¡ŒåŠ¨æ€-Rust-åº“åŠ è½½ï¼Ÿ"><a href="#æˆ‘å¦‚ä½•è¿›è¡ŒåŠ¨æ€-Rust-åº“åŠ è½½ï¼Ÿ" class="headerlink" title="æˆ‘å¦‚ä½•è¿›è¡ŒåŠ¨æ€ Rust åº“åŠ è½½ï¼Ÿ"></a>æˆ‘å¦‚ä½•è¿›è¡ŒåŠ¨æ€ Rust åº“åŠ è½½ï¼Ÿ</h2><p>ç”¨<a href="https://crates.io/crates/libloading"> libloading </a>å¯¼å…¥ Rust ä¸­çš„åŠ¨æ€åº“ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªè·¨å¹³å°çš„åŠ¨æ€é“¾æ¥ç³»ç»Ÿã€‚</p><h2 id="ä¸ºä»€ä¹ˆ-crates-io-æ²¡æœ‰å‘½åç©ºé—´ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆ-crates-io-æ²¡æœ‰å‘½åç©ºé—´ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆ crates.io æ²¡æœ‰å‘½åç©ºé—´ï¼Ÿ"></a>ä¸ºä»€ä¹ˆ crates.io æ²¡æœ‰å‘½åç©ºé—´ï¼Ÿ</h2><p>å¼•ç”¨ crates.io è®¾è®¡çš„<a href="https://internals.rust-lang.org/t/crates-io-package-policies/1041">å®˜æ–¹è§£é‡Š</a>ï¼š</p><blockquote><p>åœ¨ä½¿ç”¨ crates.io çš„ç¬¬ä¸€ä¸ªæœˆé‡Œï¼Œå¾ˆå¤šäººé—®æˆ‘ä»¬æ˜¯å¦æœ‰å¯èƒ½å¼•å…¥<a href="https://github.com/rust-lang/crates.io/issues/58">å‘½åç©ºé—´</a>ã€‚</p><p>è™½ç„¶ namespace å…è®¸å¤šä¸ªä½œè€…ä½¿ç”¨å•ä¸€çš„ã€é€šç”¨çš„åç§°ï¼Œä½†å®ƒä»¬å¢åŠ äº†åŒ…åœ¨ Rust ä»£ç ä¸­çš„å¼•ç”¨å’Œäººç±»å¯¹åŒ…çš„äº¤æµçš„å¤æ‚æ€§ã€‚ä¹ä¸€çœ‹ï¼Œå®ƒä»¬å…è®¸å¤šä¸ªä½œè€…ä½¿ç”¨â€œhttpâ€è¿™æ ·çš„åå­—ï¼Œä½†è¿™ä»…ä»…æ„å‘³ç€äººä»¬éœ€è¦å°†è¿™äº›åŒ…ç§°ä¸ºâ€œwycatsâ€™httpâ€æˆ–â€œreemâ€™httpâ€ï¼Œä¸â€œwycats-httpâ€æˆ–â€œreem-httpâ€è¿™æ ·çš„åŒ…åç›¸æ¯”æ²¡æœ‰ä»€ä¹ˆå¥½å¤„ã€‚</p><p>å½“æˆ‘ä»¬ç ”ç©¶æ²¡æœ‰å‘½åç©ºé—´çš„è½¯ä»¶åŒ…ç”Ÿæ€ç³»ç»Ÿæ—¶ï¼Œæˆ‘ä»¬å‘ç°äººä»¬å€¾å‘äºä½¿ç”¨æ›´æœ‰åˆ›æ„çš„åå­—ï¼ˆå¦‚<code>nokogiri</code>è€Œä¸æ˜¯<code>tenderlove&#39;s libxml2</code>ï¼‰ã€‚è¿™äº›æœ‰åˆ›æ„çš„åå­—å¾€å¾€ç®€çŸ­æ˜“è®°ï¼Œéƒ¨åˆ†åŸå› æ˜¯ç¼ºä¹ä»»ä½•å±‚æ¬¡ç»“æ„ã€‚å®ƒä»¬ä½¿äººä»¬æ›´å®¹æ˜“ç®€æ´æ˜äº†åœ°äº¤æµè½¯ä»¶åŒ…ã€‚ä»–ä»¬åˆ›é€ äº†ä»¤äººå…´å¥‹çš„å“ç‰Œã€‚æˆ‘ä»¬å·²ç»çœ‹åˆ°äº†ä¸€äº› 10,000+ è½¯ä»¶åŒ…ç”Ÿæ€ç³»ç»Ÿçš„æˆåŠŸï¼Œå¦‚ NPM å’Œ RubyGemsï¼Œå®ƒä»¬çš„ç¤¾åŒºåœ¨ä¸€ä¸ªå•ä¸€çš„å‘½åç©ºé—´å†…è“¬å‹ƒå‘å±•ã€‚</p><p>ç®€è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬è®¤ä¸ºå¦‚æœ Piston é€‰æ‹©<code>bvssvni/game-engine</code>è¿™æ ·çš„åå­—ï¼ˆå…è®¸å…¶ä»–ç”¨æˆ·é€‰æ‹©<code>wycats/game-engine</code>ï¼‰è€Œä¸æ˜¯ç®€å•çš„<code>piston</code>ï¼Œé‚£ä¹ˆ Cargo çš„ç”Ÿæ€ç³»ç»Ÿå°±ä¸ä¼šå¥½è½¬ã€‚</p><p>å› ä¸ºå‘½åç©ºé—´åœ¨å¾ˆå¤šæ–¹é¢ä¸¥æ ¼æ¥è¯´éƒ½æ¯”è¾ƒå¤æ‚ï¼Œè€Œä¸”å¦‚æœå°†æ¥æœ‰å¿…è¦çš„è¯ï¼Œè¿˜å¯ä»¥å…¼å®¹æ·»åŠ ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åšæŒä½¿ç”¨å•ä¸€çš„å…±äº«å‘½åç©ºé—´ã€‚</p></blockquote><h1 id="åº“"><a href="#åº“" class="headerlink" title="åº“"></a>åº“</h1><h2 id="æˆ‘æ€æ ·æ‰èƒ½å‘å‡º-HTTP-è¯·æ±‚"><a href="#æˆ‘æ€æ ·æ‰èƒ½å‘å‡º-HTTP-è¯·æ±‚" class="headerlink" title="æˆ‘æ€æ ·æ‰èƒ½å‘å‡º HTTP è¯·æ±‚?"></a>æˆ‘æ€æ ·æ‰èƒ½å‘å‡º HTTP è¯·æ±‚?</h2><p>æ ‡å‡†åº“ä¸åŒ…æ‹¬ HTTP çš„å®ç°ï¼Œæ‰€ä»¥ä½ è¦ä½¿ç”¨ä¸€ä¸ªå¤–éƒ¨çš„ crateã€‚<br><a href="http://docs.rs/reqwest">reqwest</a> æ˜¯æœ€ç®€å•çš„ã€‚å®ƒå»ºç«‹åœ¨<a href="https://github.com/hyperium/hyper">hyper</a>ä¸Šï¼Œç”¨ Rust ç¼–å†™ï¼Œä½†ä¹Ÿæœ‰<a href="https://crates.io/keywords/http">ä¸€äº›å…¶ä»–çš„</a>ã€‚<a href="https://docs.rs/curl">curl</a> crate è¢«å¹¿æ³›ä½¿ç”¨ï¼Œå®ƒæä¾›äº†ä¸ curl åº“çš„ç»‘å®šã€‚</p><h2 id="æˆ‘å¦‚ä½•ç”¨-Rust-ç¼–å†™-GUI-åº”ç”¨ç¨‹åºï¼Ÿ"><a href="#æˆ‘å¦‚ä½•ç”¨-Rust-ç¼–å†™-GUI-åº”ç”¨ç¨‹åºï¼Ÿ" class="headerlink" title="æˆ‘å¦‚ä½•ç”¨ Rust ç¼–å†™ GUI åº”ç”¨ç¨‹åºï¼Ÿ"></a>æˆ‘å¦‚ä½•ç”¨ Rust ç¼–å†™ GUI åº”ç”¨ç¨‹åºï¼Ÿ</h2><p>æœ‰å¤šç§æ–¹æ³•å¯ä»¥åœ¨ Rust ä¸­ç¼–å†™ GUI åº”ç”¨ç¨‹åºã€‚åªè¦çœ‹çœ‹<a href="https://github.com/kud1ing/awesome-rust#gui">è¿™ä¸ª GUI æ¡†æ¶çš„åˆ—è¡¨</a>ã€‚</p><h2 id="æˆ‘æ€æ ·æ‰èƒ½è§£æ-JSON-XML"><a href="#æˆ‘æ€æ ·æ‰èƒ½è§£æ-JSON-XML" class="headerlink" title="æˆ‘æ€æ ·æ‰èƒ½è§£æ JSON/XML?"></a>æˆ‘æ€æ ·æ‰èƒ½è§£æ JSON/XML?</h2><p><a href="https://serde.rs/">Serde</a>æ˜¯æ¨èçš„ Rust æ•°æ®åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„åº“ï¼Œå¯ä»¥ä»è®¸å¤šä¸åŒçš„æ ¼å¼ä¸­è·å–ã€‚</p><h2 id="æ˜¯å¦æœ‰ä¸€ä¸ªæ ‡å‡†çš„-2D-çŸ¢é‡å’Œå½¢çŠ¶-crate"><a href="#æ˜¯å¦æœ‰ä¸€ä¸ªæ ‡å‡†çš„-2D-çŸ¢é‡å’Œå½¢çŠ¶-crate" class="headerlink" title="æ˜¯å¦æœ‰ä¸€ä¸ªæ ‡å‡†çš„ 2D+ çŸ¢é‡å’Œå½¢çŠ¶ crate?"></a>æ˜¯å¦æœ‰ä¸€ä¸ªæ ‡å‡†çš„ 2D+ çŸ¢é‡å’Œå½¢çŠ¶ crate?</h2><p>è¿˜æ²¡æœ‰! æƒ³å†™ä¸€ä¸ªå—ï¼Ÿ</p><h2 id="æˆ‘å¦‚ä½•åœ¨-Rust-ä¸­ç¼–å†™ä¸€ä¸ª-OpenGL-åº”ç”¨ç¨‹åº"><a href="#æˆ‘å¦‚ä½•åœ¨-Rust-ä¸­ç¼–å†™ä¸€ä¸ª-OpenGL-åº”ç”¨ç¨‹åº" class="headerlink" title="æˆ‘å¦‚ä½•åœ¨ Rust ä¸­ç¼–å†™ä¸€ä¸ª OpenGL åº”ç”¨ç¨‹åº?"></a>æˆ‘å¦‚ä½•åœ¨ Rust ä¸­ç¼–å†™ä¸€ä¸ª OpenGL åº”ç”¨ç¨‹åº?</h2><p><a href="https://github.com/tomaka/glium">Glium</a> æ˜¯ Rust ä¸­ OpenGL ç¼–ç¨‹çš„ä¸»è¦åº“ã€‚<a href="https://github.com/bjz/glfw-rs">GLFW</a> ä¹Ÿæ˜¯ä¸€ä¸ªå¯é çš„é€‰æ‹©ã€‚</p><h2 id="æˆ‘å¯ä»¥ç”¨-Rust-å†™ä¸€ä¸ªè§†é¢‘æ¸¸æˆå—ï¼Ÿ"><a href="#æˆ‘å¯ä»¥ç”¨-Rust-å†™ä¸€ä¸ªè§†é¢‘æ¸¸æˆå—ï¼Ÿ" class="headerlink" title="æˆ‘å¯ä»¥ç”¨ Rust å†™ä¸€ä¸ªè§†é¢‘æ¸¸æˆå—ï¼Ÿ"></a>æˆ‘å¯ä»¥ç”¨ Rust å†™ä¸€ä¸ªè§†é¢‘æ¸¸æˆå—ï¼Ÿ</h2><p>æ˜¯çš„ï¼Œä½ å¯ä»¥ã€‚Rust çš„ä¸»è¦æ¸¸æˆç¼–ç¨‹åº“æ˜¯<a href="http://www.piston.rs/">Piston</a>ï¼Œè€Œä¸”è¿˜æœ‰ä¸€ä¸ª<a href="https://www.reddit.com/r/rust_gamedev/"> Rust æ¸¸æˆç¼–ç¨‹çš„ subreddit </a>å’Œä¸€ä¸ª IRC é¢‘é“ï¼ˆ<code>#rust-gamedev</code> on <a href="https://wiki.mozilla.org/IRC">Mozilla IRC</a>ï¼‰ã€‚</p><h1 id="è®¾è®¡æ¨¡å¼"><a href="#è®¾è®¡æ¨¡å¼" class="headerlink" title="è®¾è®¡æ¨¡å¼"></a>è®¾è®¡æ¨¡å¼</h1><h2 id="Rustæ˜¯é¢å‘å¯¹è±¡çš„å—ï¼Ÿ"><a href="#Rustæ˜¯é¢å‘å¯¹è±¡çš„å—ï¼Ÿ" class="headerlink" title="Rustæ˜¯é¢å‘å¯¹è±¡çš„å—ï¼Ÿ"></a>Rustæ˜¯é¢å‘å¯¹è±¡çš„å—ï¼Ÿ</h2><p>å®ƒæ˜¯å¤šèŒƒå¼çš„ã€‚å¾ˆå¤šåœ¨ OO è¯­è¨€ä¸­å¯ä»¥åšçš„äº‹æƒ…åœ¨ Rust ä¸­ä¹Ÿå¯ä»¥åšï¼Œä½†ä¸æ˜¯æ‰€æœ‰çš„äº‹æƒ…ï¼Œä¹Ÿä¸æ€»æ˜¯ä½¿ç”¨ä½ æ‰€ä¹ æƒ¯çš„é‚£ç§æŠ½è±¡æ–¹å¼ã€‚</p><h2 id="æˆ‘å¦‚ä½•å°†é¢å‘å¯¹è±¡çš„æ¦‚å¿µæ˜ å°„åˆ°-Rust-ä¸­ï¼Ÿ"><a href="#æˆ‘å¦‚ä½•å°†é¢å‘å¯¹è±¡çš„æ¦‚å¿µæ˜ å°„åˆ°-Rust-ä¸­ï¼Ÿ" class="headerlink" title="æˆ‘å¦‚ä½•å°†é¢å‘å¯¹è±¡çš„æ¦‚å¿µæ˜ å°„åˆ° Rust ä¸­ï¼Ÿ"></a>æˆ‘å¦‚ä½•å°†é¢å‘å¯¹è±¡çš„æ¦‚å¿µæ˜ å°„åˆ° Rust ä¸­ï¼Ÿ</h2><p>è¿™å–å†³äºã€‚æœ‰ä¸€äº›æ–¹æ³•å¯ä»¥å°†é¢å‘å¯¹è±¡çš„æ¦‚å¿µï¼Œå¦‚<a href="https://www.reddit.com/r/rust/comments/2sryuw/ideaquestion_about_multiple_inheritence/">å¤šé‡ç»§æ‰¿</a>ç¿»è¯‘æˆ Rustï¼Œä½†ç”±äº Rust ä¸æ˜¯é¢å‘å¯¹è±¡çš„ï¼Œæ‰€ä»¥ç¿»è¯‘çš„ç»“æœå¯èƒ½ä¸å®ƒåœ¨ OO è¯­è¨€ä¸­çš„å¤–è§‚æœ‰å¾ˆå¤§ä¸åŒã€‚</p><h2 id="æˆ‘å¦‚ä½•å¤„ç†å¸¦æœ‰å¯é€‰å‚æ•°çš„ç»“æ„çš„é…ç½®ï¼Ÿ"><a href="#æˆ‘å¦‚ä½•å¤„ç†å¸¦æœ‰å¯é€‰å‚æ•°çš„ç»“æ„çš„é…ç½®ï¼Ÿ" class="headerlink" title="æˆ‘å¦‚ä½•å¤„ç†å¸¦æœ‰å¯é€‰å‚æ•°çš„ç»“æ„çš„é…ç½®ï¼Ÿ"></a>æˆ‘å¦‚ä½•å¤„ç†å¸¦æœ‰å¯é€‰å‚æ•°çš„ç»“æ„çš„é…ç½®ï¼Ÿ</h2><p>æœ€ç®€å•çš„æ–¹æ³•æ˜¯åœ¨ä½ ç”¨æ¥æ„å»ºç»“æ„å®ä¾‹çš„ä»»ä½•å‡½æ•°ä¸­ä½¿ç”¨<a href="https://doc.rust-lang.org/std/option/enum.Option.html"><code>Option</code></a>ç±»å‹ï¼ˆé€šå¸¸æ˜¯<code>new()</code>ï¼‰ã€‚å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨æ„å»ºå™¨æ¨¡å¼ï¼Œåœ¨æ„å»ºæ‰€æ„å»ºçš„ç±»å‹ä¹‹å‰ï¼Œåªå¿…é¡»è°ƒç”¨æŸäº›å®ä¾‹åŒ–æˆå‘˜å˜é‡çš„å‡½æ•°ã€‚</p><h2 id="æˆ‘å¦‚ä½•åœ¨-Rust-ä¸­åšå…¨å±€å˜é‡"><a href="#æˆ‘å¦‚ä½•åœ¨-Rust-ä¸­åšå…¨å±€å˜é‡" class="headerlink" title="æˆ‘å¦‚ä½•åœ¨ Rust ä¸­åšå…¨å±€å˜é‡?"></a>æˆ‘å¦‚ä½•åœ¨ Rust ä¸­åšå…¨å±€å˜é‡?</h2><p>Rust ä¸­çš„å…¨å±€å˜é‡å¯ä»¥ä½¿ç”¨<code>const</code>å£°æ˜æ¥å®ç°ç¼–è¯‘æ—¶è®¡ç®—çš„å…¨å±€å¸¸é‡ï¼Œè€Œ<code>static</code>å¯ä»¥ç”¨æ¥å®ç°å¯å˜çš„å…¨å±€å˜é‡ã€‚è¯·æ³¨æ„ï¼Œä¿®æ”¹<code>static mut</code>å˜é‡éœ€è¦ä½¿ç”¨<code>unsafe</code>ï¼Œå› ä¸ºå®ƒå…è®¸æ•°æ®ç«äº‰ï¼Œè€Œåœ¨å®‰å…¨çš„ Rust ä¸­ä¿è¯ä¸ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚<code>const</code>å’Œ<code>static</code>å€¼ä¹‹é—´çš„ä¸€ä¸ªé‡è¦åŒºåˆ«æ˜¯ï¼Œä½ å¯ä»¥å¯¹<code>static</code>å€¼è¿›è¡Œå¼•ç”¨ï¼Œä½†ä¸èƒ½å¯¹<code>const</code>å€¼è¿›è¡Œå¼•ç”¨ï¼Œåè€…æ²¡æœ‰æŒ‡å®šçš„å†…å­˜ä½ç½®ã€‚å…³äº<code>const</code>ä¸<code>static</code>çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»<a href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#accessing-or-modifying-a-mutable-static-variable"> Rust ä¹¦</a>ã€‚</p><h2 id="æˆ‘å¦‚ä½•è®¾ç½®ç¨‹åºåŒ–å®šä¹‰çš„ç¼–è¯‘æ—¶å¸¸é‡ï¼Ÿ"><a href="#æˆ‘å¦‚ä½•è®¾ç½®ç¨‹åºåŒ–å®šä¹‰çš„ç¼–è¯‘æ—¶å¸¸é‡ï¼Ÿ" class="headerlink" title="æˆ‘å¦‚ä½•è®¾ç½®ç¨‹åºåŒ–å®šä¹‰çš„ç¼–è¯‘æ—¶å¸¸é‡ï¼Ÿ"></a>æˆ‘å¦‚ä½•è®¾ç½®ç¨‹åºåŒ–å®šä¹‰çš„ç¼–è¯‘æ—¶å¸¸é‡ï¼Ÿ</h2><p>Rust ç›®å‰å¯¹ç¼–è¯‘æ—¶å¸¸é‡çš„æ”¯æŒæœ‰é™ã€‚ä½ å¯ä»¥ä½¿ç”¨â€œconstâ€å£°æ˜æ¥å®šä¹‰åŸºå…ƒï¼ˆç±»ä¼¼äºâ€œstaticâ€ï¼Œä½†æ˜¯æ˜¯ä¸å¯å˜çš„ï¼Œåœ¨å†…å­˜ä¸­æ²¡æœ‰æŒ‡å®šçš„ä½ç½®ï¼‰ï¼Œä¹Ÿå¯ä»¥å®šä¹‰â€œconstâ€å‡½æ•°å’Œå›ºæœ‰æ–¹æ³•ã€‚</p><p>è¦å®šä¹‰ä¸èƒ½é€šè¿‡è¿™äº›æœºåˆ¶å®šä¹‰çš„ç¨‹åºæ€§å¸¸é‡ï¼Œå¯ä»¥ä½¿ç”¨<a href="https://crates.io/crates/lazy_static"><code>lazy-static</code></a> crateï¼Œå®ƒé€šè¿‡åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶è‡ªåŠ¨è®¡ç®—å¸¸é‡æ¥æ¨¡æ‹Ÿç¼–è¯‘æ—¶è®¡ç®—ã€‚</p><h2 id="æˆ‘å¯ä»¥è¿è¡Œå‘ç”Ÿåœ¨-main-ä¹‹å‰çš„åˆå§‹åŒ–ä»£ç å—ï¼Ÿ"><a href="#æˆ‘å¯ä»¥è¿è¡Œå‘ç”Ÿåœ¨-main-ä¹‹å‰çš„åˆå§‹åŒ–ä»£ç å—ï¼Ÿ" class="headerlink" title="æˆ‘å¯ä»¥è¿è¡Œå‘ç”Ÿåœ¨ main ä¹‹å‰çš„åˆå§‹åŒ–ä»£ç å—ï¼Ÿ"></a>æˆ‘å¯ä»¥è¿è¡Œå‘ç”Ÿåœ¨ main ä¹‹å‰çš„åˆå§‹åŒ–ä»£ç å—ï¼Ÿ</h2><p>Rust æ²¡æœ‰â€œåœ¨<code>main</code>ä¹‹å‰çš„ç”Ÿå‘½â€çš„æ¦‚å¿µã€‚æœ€æ¥è¿‘çš„æ˜¯é€šè¿‡<a href="https://crates.io/crates/lazy_static"><code>lazy-static</code></a> crate æ¥å®Œæˆï¼Œå®ƒé€šè¿‡åœ¨é™æ€å˜é‡ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶æ‡’æ•£åœ°åˆå§‹åŒ–é™æ€å˜é‡æ¥æ¨¡æ‹Ÿâ€œmainä¹‹å‰â€ã€‚</p><h2 id="Rust-å…è®¸-globals-ä½¿ç”¨éç»“æ„è¡¨è¾¾å¼çš„å€¼å—ï¼Ÿ"><a href="#Rust-å…è®¸-globals-ä½¿ç”¨éç»“æ„è¡¨è¾¾å¼çš„å€¼å—ï¼Ÿ" class="headerlink" title="Rust å…è®¸ globals ä½¿ç”¨éç»“æ„è¡¨è¾¾å¼çš„å€¼å—ï¼Ÿ"></a>Rust å…è®¸ globals ä½¿ç”¨éç»“æ„è¡¨è¾¾å¼çš„å€¼å—ï¼Ÿ</h2><p>ä¸å…è®¸ã€‚å…¨å±€å˜é‡ä¸èƒ½æœ‰ä¸€ä¸ªéç»“æ„è¡¨è¾¾å¼çš„æ„é€ å‡½æ•°ï¼Œä¹Ÿä¸èƒ½æœ‰ä¸€ä¸ªææ„å‡½æ•°ã€‚é™æ€æ„é€ å‡½æ•°æ˜¯ä¸å¯å–çš„ï¼Œå› ä¸ºç¡®ä¿é™æ€åˆå§‹åŒ–é¡ºåºçš„å¯ç§»æ¤æ€§æ˜¯å¾ˆå›°éš¾çš„ã€‚main ä¹‹å‰çš„ç”Ÿå‘½é€šå¸¸è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªé”™è¯¯çš„åŠŸèƒ½ï¼Œæ‰€ä»¥ Rust ä¸å…è®¸å®ƒã€‚</p><p>å‚è§ <a href="http://yosefk.com/c++fqa/ctors.html#fqa-10.12">C++ FQA </a>ä¸­å…³äºâ€œé™æ€åˆå§‹åŒ–é¡ºåºæƒ¨è´¥â€çš„å†…å®¹ï¼Œä»¥åŠ<a href="https://ericlippert.com/2013/02/06/static-constructors-part-one/"> Eric Lippert çš„åšå®¢</a>ä¸­å…³äº C# çš„æŒ‘æˆ˜ï¼Œå®ƒä¹Ÿæœ‰è¿™ç§ç‰¹æ€§ã€‚</p><p>ä½ å¯ä»¥ç”¨<a href="https://crates.io/crates/lazy_static/"> lazy-static </a>å·¥å…·ç®±æ¥è¿‘ä¼¼éå†…å®¹è¡¨è¾¾å¼çš„ globalsã€‚</p><h1 id="å…¶ä»–è¯­è¨€"><a href="#å…¶ä»–è¯­è¨€" class="headerlink" title="å…¶ä»–è¯­è¨€"></a>å…¶ä»–è¯­è¨€</h1><h2 id="æˆ‘æ€æ ·æ‰èƒ½åœ¨-Rust-ä¸­å®ç°ç±»ä¼¼-C-è¯­è¨€çš„struct-X-static-int-X-çš„ä¸œè¥¿å‘¢ï¼Ÿ"><a href="#æˆ‘æ€æ ·æ‰èƒ½åœ¨-Rust-ä¸­å®ç°ç±»ä¼¼-C-è¯­è¨€çš„struct-X-static-int-X-çš„ä¸œè¥¿å‘¢ï¼Ÿ" class="headerlink" title="æˆ‘æ€æ ·æ‰èƒ½åœ¨ Rust ä¸­å®ç°ç±»ä¼¼ C è¯­è¨€çš„struct X { static int X; };çš„ä¸œè¥¿å‘¢ï¼Ÿ"></a>æˆ‘æ€æ ·æ‰èƒ½åœ¨ Rust ä¸­å®ç°ç±»ä¼¼ C è¯­è¨€çš„<code>struct X &#123; static int X; &#125;;</code>çš„ä¸œè¥¿å‘¢ï¼Ÿ</h2><p>Rust æ²¡æœ‰ä¸Šé¢ä»£ç ç‰‡æ–­ä¸­æ‰€ç¤ºçš„<code>é™æ€</code>å­—æ®µã€‚ç›¸åï¼Œä½ å¯ä»¥åœ¨ä¸€ä¸ªç»™å®šçš„æ¨¡å—ä¸­å£°æ˜ä¸€ä¸ª<code>é™æ€</code>å˜é‡ï¼Œè¿™ä¸ªå˜é‡å¯¹è¯¥æ¨¡å—æ˜¯ç§æœ‰çš„ã€‚</p><h2 id="æˆ‘å¦‚ä½•å°†-C-é£æ ¼çš„æšä¸¾è½¬æ¢ä¸ºæ•´æ•°ï¼Œåä¹‹äº¦ç„¶ï¼Ÿ"><a href="#æˆ‘å¦‚ä½•å°†-C-é£æ ¼çš„æšä¸¾è½¬æ¢ä¸ºæ•´æ•°ï¼Œåä¹‹äº¦ç„¶ï¼Ÿ" class="headerlink" title="æˆ‘å¦‚ä½•å°† C é£æ ¼çš„æšä¸¾è½¬æ¢ä¸ºæ•´æ•°ï¼Œåä¹‹äº¦ç„¶ï¼Ÿ"></a>æˆ‘å¦‚ä½•å°† C é£æ ¼çš„æšä¸¾è½¬æ¢ä¸ºæ•´æ•°ï¼Œåä¹‹äº¦ç„¶ï¼Ÿ</h2><p>å°† C é£æ ¼çš„æšä¸¾è½¬æ¢ä¸ºæ•´æ•°å¯ä»¥ç”¨<code>as</code>è¡¨è¾¾å¼æ¥å®Œæˆï¼Œæ¯”å¦‚<code>e as i64</code>(å…¶ä¸­<code>e</code>æ˜¯æŸä¸ªæšä¸¾)ã€‚</p><p>å¦ä¸€ä¸ªæ–¹å‘çš„è½¬æ¢å¯ä»¥ç”¨<code>match</code>è¯­å¥æ¥å®Œæˆ, å®ƒå°†ä¸åŒçš„æ•°å­—å€¼æ˜ å°„åˆ°æšä¸¾çš„ä¸åŒæ½œåœ¨å€¼ä¸Š.</p><h2 id="ä¸ºä»€ä¹ˆ-Rust-ç¨‹åºçš„äºŒè¿›åˆ¶å¤§å°æ¯”-C-ç¨‹åºå¤§"><a href="#ä¸ºä»€ä¹ˆ-Rust-ç¨‹åºçš„äºŒè¿›åˆ¶å¤§å°æ¯”-C-ç¨‹åºå¤§" class="headerlink" title="ä¸ºä»€ä¹ˆ Rust ç¨‹åºçš„äºŒè¿›åˆ¶å¤§å°æ¯” C ç¨‹åºå¤§?"></a>ä¸ºä»€ä¹ˆ Rust ç¨‹åºçš„äºŒè¿›åˆ¶å¤§å°æ¯” C ç¨‹åºå¤§?</h2><p>æœ‰å‡ ä¸ªå› ç´ å¯¼è‡´ Rust ç¨‹åºé»˜è®¤æ¯”åŠŸèƒ½ç›¸å½“çš„ C ç¨‹åºæœ‰è¾ƒå¤§çš„äºŒè¿›åˆ¶å¤§å°ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒRust æ›´å€¾å‘äºå¯¹ç°å®ä¸–ç•Œçš„ç¨‹åºæ€§èƒ½è¿›è¡Œä¼˜åŒ–ï¼Œè€Œä¸æ˜¯å¯¹å°ç¨‹åºçš„å¤§å°è¿›è¡Œä¼˜åŒ–ã€‚</p><h3 id="å•æ€åŒ–"><a href="#å•æ€åŒ–" class="headerlink" title="å•æ€åŒ–"></a>å•æ€åŒ–</h3><p>Rust å¯¹æ³›å‹è¿›è¡Œäº†å•æ€åŒ–å¤„ç†ï¼Œè¿™æ„å‘³ç€åœ¨ç¨‹åºä¸­æ¯ä½¿ç”¨ä¸€ä¸ªå…·ä½“ç±»å‹ï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„æ³›å‹å‡½æ•°æˆ–ç±»å‹ã€‚è¿™ç±»ä¼¼äº C++ ä¸­æ¨¡æ¿çš„å·¥ä½œæ–¹å¼ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸‹é¢çš„ç¨‹åºä¸­ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">foo</span></span>&lt;T&gt;(t: T) &#123;</span><br><span class="line">    <span class="comment">// ... do something</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    foo(<span class="number">10</span>);       <span class="comment">// i32</span></span><br><span class="line">    foo(<span class="string">&quot;hello&quot;</span>);  <span class="comment">// &amp;str</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªä¸åŒç‰ˆæœ¬çš„<code>foo</code>å°†å‡ºç°åœ¨æœ€ç»ˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œä¸€ä¸ªä¸“é—¨ç”¨äº<code>i32</code>è¾“å…¥ï¼Œä¸€ä¸ªä¸“é—¨ç”¨äº<code>&amp;str</code>è¾“å…¥ã€‚è¿™ä½¿å¾—é€šç”¨å‡½æ•°çš„é™æ€è°ƒåº¦æ›´åŠ æœ‰æ•ˆï¼Œä½†ä»£ä»·æ˜¯ä¸€ä¸ªæ›´å¤§çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p><h3 id="è°ƒè¯•ç¬¦å·"><a href="#è°ƒè¯•ç¬¦å·" class="headerlink" title="è°ƒè¯•ç¬¦å·"></a>è°ƒè¯•ç¬¦å·</h3><p>Rust ç¨‹åºåœ¨ç¼–è¯‘æ—¶ä¿ç•™äº†ä¸€äº›è°ƒè¯•ç¬¦å·ï¼Œå³ä½¿æ˜¯åœ¨ release æ¨¡å¼ä¸‹ç¼–è¯‘ã€‚è¿™äº›ç¬¦å·ç”¨äºæä¾› panic æ—¶çš„ backtraceï¼Œå¯ä»¥ç”¨<code>strip</code>æˆ–å…¶ä»–è°ƒè¯•ç¬¦å·ç§»é™¤å·¥å…·ç§»é™¤ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç”¨ Cargo åœ¨ release æ¨¡å¼ä¸‹ç¼–è¯‘ï¼Œç›¸å½“äºç”¨ rustc è®¾ç½®ä¼˜åŒ–çº§åˆ« 3ã€‚å¦ä¸€ä¸ªä¼˜åŒ–çº§åˆ«ï¼ˆç§°ä¸º<code>s</code>æˆ–<code>z</code>ï¼‰<a href="https://github.com/rust-lang/rust/pull/32386">å·²è¢«æ·»åŠ </a>ï¼Œå®ƒå‘Šè¯‰ç¼–è¯‘å™¨ä¸ºå¤§å°è€Œä¸æ˜¯æ€§èƒ½è¿›è¡Œä¼˜åŒ–ã€‚</p><h3 id="é“¾æ¥æ—¶ä¼˜åŒ–"><a href="#é“¾æ¥æ—¶ä¼˜åŒ–" class="headerlink" title="é“¾æ¥æ—¶ä¼˜åŒ–"></a>é“¾æ¥æ—¶ä¼˜åŒ–</h3><p>Rust é»˜è®¤ä¸åšé“¾æ¥æ—¶ä¼˜åŒ–ï¼Œä½†å¯ä»¥è¢«æŒ‡ç¤ºè¿™æ ·åšã€‚è¿™å¢åŠ äº† Rust ç¼–è¯‘å™¨å¯èƒ½åšçš„ä¼˜åŒ–é‡ï¼Œå¹¶å¯¹äºŒè¿›åˆ¶çš„å¤§å°æœ‰å°çš„å½±å“ã€‚ä¸ä¹‹å‰æåˆ°çš„å°ºå¯¸ä¼˜åŒ–æ¨¡å¼ç›¸ç»“åˆï¼Œè¿™ç§å½±å“å¯èƒ½æ›´å¤§ã€‚</p><h3 id="æ ‡å‡†åº“"><a href="#æ ‡å‡†åº“" class="headerlink" title="æ ‡å‡†åº“"></a>æ ‡å‡†åº“</h3><p>Rust æ ‡å‡†åº“åŒ…æ‹¬ libbacktrace å’Œ libunwindï¼Œè¿™åœ¨æŸäº›ç¨‹åºä¸­å¯èƒ½æ˜¯ä¸å¯å–çš„ã€‚å› æ­¤ï¼Œä½¿ç”¨<code>#![no_std]</code>å¯ä»¥å¸¦æ¥æ›´å°çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä½†é€šå¸¸ä¹Ÿä¼šå¯¹ä½ æ­£åœ¨ç¼–å†™çš„é‚£ç§ Rust ä»£ç é€ æˆå®è´¨æ€§çš„æ”¹å˜ã€‚è¯·æ³¨æ„ï¼Œåœ¨æ²¡æœ‰æ ‡å‡†åº“çš„æƒ…å†µä¸‹ä½¿ç”¨ Rustï¼Œé€šå¸¸åœ¨åŠŸèƒ½ä¸Šæ›´æ¥è¿‘äºåŒç­‰çš„ C ä»£ç ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œä¸‹é¢çš„ C ç¨‹åºè¯»å…¥ä¸€ä¸ªåå­—ï¼Œå¹¶å¯¹æœ‰è¿™ä¸ªåå­—çš„äººè¯´â€œä½ å¥½â€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;What&#x27;s your name?\n&quot;</span>);</span><br><span class="line">    <span class="keyword">char</span> input[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, input);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello %s!\n&quot;</span>, input);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨Rusté‡å†™è¿™ä¸ªï¼Œä½ å¯èƒ½ä¼šå¾—åˆ°å¦‚ä¸‹çš„ä¸œè¥¿ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::io;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;What&#x27;s your name?&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> input = <span class="built_in">String</span>::new();</span><br><span class="line">    io::stdin().read_line(&amp;<span class="keyword">mut</span> input).unwrap();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Hello &#123;&#125;!&quot;</span>, input);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç¨‹åºåœ¨ç¼–è¯‘åä¸ C ç¨‹åºç›¸æ¯”ï¼Œä¼šæœ‰æ›´å¤§çš„äºŒè¿›åˆ¶ï¼Œä½¿ç”¨æ›´å¤šçš„å†…å­˜ã€‚ä½†æ˜¯è¿™ä¸ªç¨‹åºå¹¶ä¸å®Œå…¨ç­‰åŒäºä¸Šé¢çš„ C ä»£ç ã€‚ç­‰ä»·çš„ Rust ä»£ç åè€Œä¼šæ˜¯è¿™æ ·çš„ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![feature(lang_items)]</span></span><br><span class="line"><span class="meta">#![feature(libc)]</span></span><br><span class="line"><span class="meta">#![feature(no_std)]</span></span><br><span class="line"><span class="meta">#![feature(start)]</span></span><br><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> libc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">printf</span></span>(fmt: *<span class="keyword">const</span> <span class="built_in">u8</span>, ...) -&gt; <span class="built_in">i32</span>;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">scanf</span></span>(fmt: *<span class="keyword">const</span> <span class="built_in">u8</span>, ...) -&gt; <span class="built_in">i32</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[start]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">start</span></span>(_argc: <span class="built_in">isize</span>, _argv: *<span class="keyword">const</span> *<span class="keyword">const</span> <span class="built_in">u8</span>) -&gt; <span class="built_in">isize</span> &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        printf(<span class="string">b&quot;What&#x27;s your name?\n\0&quot;</span>.as_ptr());</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> input = [<span class="number">0u8</span>; <span class="number">100</span>];</span><br><span class="line">        scanf(<span class="string">b&quot;%s\0&quot;</span>.as_ptr(), &amp;<span class="keyword">mut</span> input);</span><br><span class="line">        printf(<span class="string">b&quot;Hello %s!\n\0&quot;</span>.as_ptr(), &amp;input);</span><br><span class="line">        <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[lang=<span class="meta-string">&quot;eh_personality&quot;</span>]</span> <span class="keyword">extern</span> <span class="function"><span class="keyword">fn</span> <span class="title">eh_personality</span></span>() &#123;&#125;</span><br><span class="line"><span class="meta">#[lang=<span class="meta-string">&quot;panic_fmt&quot;</span>]</span> <span class="function"><span class="keyword">fn</span> <span class="title">panic_fmt</span></span>() -&gt; ! &#123; <span class="keyword">loop</span> &#123;&#125; &#125;</span><br><span class="line"><span class="meta">#[lang=<span class="meta-string">&quot;stack_exhausted&quot;</span>]</span> <span class="keyword">extern</span> <span class="function"><span class="keyword">fn</span> <span class="title">stack_exhausted</span></span>() &#123;&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç¡®å®åº”è¯¥åœ¨å†…å­˜ä½¿ç”¨æ–¹é¢ä¸ C è¯­è¨€å¤§è‡´ç›¸åŒï¼Œä½†ä»£ä»·æ˜¯æ›´å¤šçš„ç¨‹åºå‘˜å¤æ‚æ€§ï¼Œä»¥åŠç¼ºä¹é€šå¸¸ç”± Rust æä¾›çš„é™æ€ä¿è¯ï¼ˆåœ¨è¿™é‡Œé€šè¿‡ä½¿ç”¨<code>unsafe</code>æ¥é¿å…ï¼‰ã€‚</p><h2 id="ä¸ºä»€ä¹ˆ-Rust-ä¸åƒ-C-é‚£æ ·æœ‰ä¸€ä¸ªç¨³å®šçš„-ABIï¼Œä¸ºä»€ä¹ˆæˆ‘å¿…é¡»ç”¨-extern-æ¥æ³¨è§£ä¸œè¥¿ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆ-Rust-ä¸åƒ-C-é‚£æ ·æœ‰ä¸€ä¸ªç¨³å®šçš„-ABIï¼Œä¸ºä»€ä¹ˆæˆ‘å¿…é¡»ç”¨-extern-æ¥æ³¨è§£ä¸œè¥¿ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆ Rust ä¸åƒ C é‚£æ ·æœ‰ä¸€ä¸ªç¨³å®šçš„ ABIï¼Œä¸ºä»€ä¹ˆæˆ‘å¿…é¡»ç”¨ extern æ¥æ³¨è§£ä¸œè¥¿ï¼Ÿ"></a>ä¸ºä»€ä¹ˆ Rust ä¸åƒ C é‚£æ ·æœ‰ä¸€ä¸ªç¨³å®šçš„ ABIï¼Œä¸ºä»€ä¹ˆæˆ‘å¿…é¡»ç”¨ extern æ¥æ³¨è§£ä¸œè¥¿ï¼Ÿ</h2><p>å¯¹ ABI çš„æ‰¿è¯ºæ˜¯ä¸€ä¸ªé‡å¤§çš„å†³å®šï¼Œä¼šé™åˆ¶æœªæ¥æ½œåœ¨çš„æœ‰åˆ©çš„è¯­è¨€å˜åŒ–ã€‚é‰´äº Rust åœ¨ 2015 å¹´ 5 æœˆæ‰è¾¾åˆ° 1.0ï¼Œç°åœ¨åšå‡ºåƒç¨³å®š ABI è¿™æ ·å¤§çš„æ‰¿è¯ºè¿˜ä¸ºæ—¶è¿‡æ—©ã€‚ä½†è¿™å¹¶ä¸æ„å‘³ç€æœªæ¥ä¸ä¼šå‘ç”Ÿã€‚(å°½ç®¡ C++ å·²ç»æˆåŠŸåœ°è¿è¡Œäº†å¾ˆå¤šå¹´è€Œæ²¡æœ‰æŒ‡å®šä¸€ä¸ªç¨³å®šçš„ ABI)ã€‚</p><p><code>extern</code>å…³é”®å­—å…è®¸ Rust ä½¿ç”¨ç‰¹å®šçš„ ABIï¼Œä¾‹å¦‚å®šä¹‰æ˜ç¡®çš„ C ABIï¼Œä»¥ä¾¿ä¸å…¶ä»–è¯­è¨€äº’æ“ä½œã€‚</p><h2 id="Rust-ä»£ç å¯ä»¥è°ƒç”¨-C-ä»£ç å—ï¼Ÿ"><a href="#Rust-ä»£ç å¯ä»¥è°ƒç”¨-C-ä»£ç å—ï¼Ÿ" class="headerlink" title="Rust ä»£ç å¯ä»¥è°ƒç”¨ C ä»£ç å—ï¼Ÿ"></a>Rust ä»£ç å¯ä»¥è°ƒç”¨ C ä»£ç å—ï¼Ÿ</h2><p>å¯ä»¥ã€‚ä» Rust ä¸­è°ƒç”¨ C ä»£ç çš„è®¾è®¡ä¸ä» C++ ä¸­è°ƒç”¨ C ä»£ç ä¸€æ ·é«˜æ•ˆã€‚</p><h2 id="C-ä»£ç å¯ä»¥è°ƒç”¨-Rust-ä»£ç å—"><a href="#C-ä»£ç å¯ä»¥è°ƒç”¨-Rust-ä»£ç å—" class="headerlink" title="C ä»£ç å¯ä»¥è°ƒç”¨ Rust ä»£ç å—?"></a>C ä»£ç å¯ä»¥è°ƒç”¨ Rust ä»£ç å—?</h2><p>æ˜¯çš„ï¼ŒRust ä»£ç å¿…é¡»é€šè¿‡â€œexternâ€å£°æ˜å…¬å¼€ï¼Œè¿™ä½¿å¾—å®ƒä¸ C-ABI å…¼å®¹ã€‚è¿™æ ·çš„å‡½æ•°å¯ä»¥ä½œä¸ºä¸€ä¸ªå‡½æ•°æŒ‡é’ˆä¼ é€’ç»™ C ä»£ç ï¼Œæˆ–è€…ï¼Œå¦‚æœèµ‹äºˆ<code>#[no_mangle]</code>å±æ€§ä»¥ç¦ç”¨ç¬¦å·çº ç¼ ï¼Œå¯ä»¥ç›´æ¥ä» C ä»£ç ä¸­è°ƒç”¨ã€‚</p><h2 id="æˆ‘å·²ç»å†™äº†å®Œç¾çš„-C-ä»£ç ã€‚Rust-èƒ½ç»™æˆ‘ä»€ä¹ˆï¼Ÿ"><a href="#æˆ‘å·²ç»å†™äº†å®Œç¾çš„-C-ä»£ç ã€‚Rust-èƒ½ç»™æˆ‘ä»€ä¹ˆï¼Ÿ" class="headerlink" title="æˆ‘å·²ç»å†™äº†å®Œç¾çš„ C++ ä»£ç ã€‚Rust èƒ½ç»™æˆ‘ä»€ä¹ˆï¼Ÿ"></a>æˆ‘å·²ç»å†™äº†å®Œç¾çš„ C++ ä»£ç ã€‚Rust èƒ½ç»™æˆ‘ä»€ä¹ˆï¼Ÿ</h2><p>ç°ä»£ C++ åŒ…å«äº†è®¸å¤šä½¿ç¼–å†™å®‰å…¨å’Œæ­£ç¡®çš„ä»£ç ä¸å®¹æ˜“å‡ºé”™çš„ç‰¹æ€§ï¼Œä½†å®ƒå¹¶ä¸å®Œç¾ï¼Œè€Œä¸”ä»ç„¶å¾ˆå®¹æ˜“å¼•å…¥ä¸å®‰å…¨å› ç´ ã€‚è¿™æ˜¯ C++ çš„æ ¸å¿ƒå¼€å‘äººå‘˜æ­£åœ¨åŠªåŠ›å…‹æœçš„é—®é¢˜ï¼Œä½†æ˜¯ C++ å—é™äºæ‚ ä¹…çš„å†å²ï¼Œå®ƒæ¯”ä»–ä»¬ç°åœ¨è¯•å›¾å®ç°çš„å¾ˆå¤šæƒ³æ³•éƒ½è¦æ—©ã€‚</p><p>Rust ä»ç¬¬ä¸€å¤©èµ·å°±è¢«è®¾è®¡æˆä¸€ç§å®‰å…¨çš„ç³»ç»Ÿç¼–ç¨‹è¯­è¨€ï¼Œè¿™æ„å‘³ç€å®ƒä¸ä¼šå—åˆ°å†å²ä¸Šçš„è®¾è®¡å†³å®šçš„é™åˆ¶ï¼Œè€Œè¿™äº›å†³å®šä½¿ C++ çš„å®‰å…¨é—®é¢˜å˜å¾—å¦‚æ­¤å¤æ‚ã€‚åœ¨ C++ ä¸­ï¼Œå®‰å…¨æ˜¯é€šè¿‡è°¨æ…çš„ä¸ªäººçºªå¾‹å®ç°çš„ï¼Œè€Œä¸”å¾ˆå®¹æ˜“å‡ºé”™ã€‚åœ¨ Rust ä¸­ï¼Œå®‰å…¨æ˜¯é»˜è®¤çš„ã€‚å®ƒè®©ä½ æœ‰èƒ½åŠ›åœ¨ä¸€ä¸ªåŒ…æ‹¬ä¸å¦‚ä½ å®Œç¾çš„äººåœ¨å†…çš„å›¢é˜Ÿä¸­å·¥ä½œï¼Œè€Œä¸å¿…èŠ±æ—¶é—´åå¤æ£€æŸ¥ä»–ä»¬çš„ä»£ç æ˜¯å¦å­˜åœ¨å®‰å…¨æ¼æ´ã€‚</p><h2 id="æˆ‘å¦‚ä½•åœ¨-Rust-ä¸­å®ç°ç›¸å½“äº-C-æ¨¡æ¿çš„ä¸“ä¸šåŒ–ï¼Ÿ"><a href="#æˆ‘å¦‚ä½•åœ¨-Rust-ä¸­å®ç°ç›¸å½“äº-C-æ¨¡æ¿çš„ä¸“ä¸šåŒ–ï¼Ÿ" class="headerlink" title="æˆ‘å¦‚ä½•åœ¨ Rust ä¸­å®ç°ç›¸å½“äº C++ æ¨¡æ¿çš„ä¸“ä¸šåŒ–ï¼Ÿ"></a>æˆ‘å¦‚ä½•åœ¨ Rust ä¸­å®ç°ç›¸å½“äº C++ æ¨¡æ¿çš„ä¸“ä¸šåŒ–ï¼Ÿ</h2><p>Rust ç›®å‰è¿˜æ²¡æœ‰ä¸æ¨¡æ¿ä¸“ä¸šåŒ–å®Œå…¨å¯¹ç­‰çš„ä¸œè¥¿ï¼Œä½†å®ƒ<a href="https://github.com/rust-lang/rust/issues/31844">æ­£åœ¨ç ”ç©¶ä¸­</a>ï¼Œå¸Œæœ›èƒ½å¾ˆå¿«åŠ å…¥ã€‚ç„¶è€Œï¼Œç±»ä¼¼çš„æ•ˆæœå¯ä»¥é€šè¿‡<a href="https://doc.rust-lang.org/book/ch19-03-advanced-traits.html">å…³è”ç±»å‹</a>å®ç°ã€‚</p><h2 id="Rust-çš„æ‰€æœ‰æƒç³»ç»Ÿä¸-C-çš„ç§»åŠ¨è¯­ä¹‰æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ"><a href="#Rust-çš„æ‰€æœ‰æƒç³»ç»Ÿä¸-C-çš„ç§»åŠ¨è¯­ä¹‰æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ" class="headerlink" title="Rust çš„æ‰€æœ‰æƒç³»ç»Ÿä¸ C++ çš„ç§»åŠ¨è¯­ä¹‰æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ"></a>Rust çš„æ‰€æœ‰æƒç³»ç»Ÿä¸ C++ çš„ç§»åŠ¨è¯­ä¹‰æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</h2><p>åº•å±‚çš„æ¦‚å¿µæ˜¯ç›¸ä¼¼çš„ï¼Œä½†è¿™ä¸¤ä¸ªç³»ç»Ÿåœ¨å®è·µä¸­çš„å·¥ä½œæ–¹å¼æ˜¯éå¸¸ä¸åŒçš„ã€‚åœ¨è¿™ä¸¤ä¸ªç³»ç»Ÿä¸­ï¼Œâ€œmoveâ€ä¸€ä¸ªå€¼éƒ½æ˜¯ä¸€ç§ä¸ºäº†è½¬ç§»å…¶åº•å±‚èµ„æºçš„æ‰€æœ‰æƒçš„æ–¹å¼ã€‚ä¾‹å¦‚ï¼Œç§»åŠ¨ä¸€ä¸ªå­—ç¬¦ä¸²ä¼šè½¬ç§»å­—ç¬¦ä¸²çš„ç¼“å†²åŒºï¼Œè€Œä¸æ˜¯å¤åˆ¶å®ƒã€‚</p><p>åœ¨ Rust ä¸­ï¼Œæ‰€æœ‰æƒè½¬ç§»æ˜¯é»˜è®¤è¡Œä¸ºã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ç¼–å†™äº†ä¸€ä¸ªä»¥â€œStringâ€ä¸ºå‚æ•°çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°†å¯¹å…¶è°ƒç”¨è€…æä¾›çš„<code>String</code>å€¼æ‹¥æœ‰æ‰€æœ‰æƒã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">process</span></span>(s: <span class="built_in">String</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">caller</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> s = <span class="built_in">String</span>::from(<span class="string">&quot;Hello, world!&quot;</span>);</span><br><span class="line">    process(s); <span class="comment">// Transfers ownership of `s` to `process`</span></span><br><span class="line">    process(s); <span class="comment">// Error! ownership already transferred.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­£å¦‚ä½ åœ¨ä¸Šé¢çš„ç‰‡æ®µä¸­çœ‹åˆ°çš„ï¼Œåœ¨å‡½æ•°<code>caller</code>ä¸­ï¼Œå¯¹<code>process</code>çš„ç¬¬ä¸€æ¬¡è°ƒç”¨è½¬ç§»äº†å˜é‡<code>s</code>çš„æ‰€æœ‰æƒã€‚ç¼–è¯‘å™¨ä¼šè·Ÿè¸ªæ‰€æœ‰æƒï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡è°ƒç”¨<code>process</code>ä¼šå¯¼è‡´ä¸€ä¸ªé”™è¯¯ï¼Œå› ä¸ºå°†åŒä¸€ä¸ªå€¼çš„æ‰€æœ‰æƒè½¬è®©ä¸¤æ¬¡æ˜¯éæ³•çš„ã€‚å¦‚æœä¸€ä¸ªå€¼æœ‰ä¸€ä¸ªæœªå®Œæˆçš„å¼•ç”¨ï¼ŒRust ä¹Ÿä¼šé˜»æ­¢ä½ ç§»åŠ¨è¿™ä¸ªå€¼ã€‚</p><p>C++ é‡‡å–äº†ä¸€ç§ä¸åŒçš„æ–¹æ³•ã€‚åœ¨ C++ ä¸­ï¼Œé»˜è®¤çš„åšæ³•æ˜¯å¤åˆ¶ä¸€ä¸ªå€¼ï¼ˆæ›´ç¡®åˆ‡åœ°è¯´ï¼Œæ˜¯è°ƒç”¨å¤åˆ¶æ„é€ å‡½æ•°ï¼‰ã€‚ç„¶è€Œï¼Œè¢«è°ƒç”¨è€…å¯ä»¥ä½¿ç”¨ä¸€ä¸ªâ€œrvalue referenceâ€æ¥å£°æ˜ä»–ä»¬çš„å‚æ•°ï¼Œä¾‹å¦‚<code>string&amp;&amp;</code>ï¼Œä»¥è¡¨æ˜ä»–ä»¬å°†è·å¾—è¯¥å‚æ•°æ‰€æ‹¥æœ‰çš„ä¸€äº›èµ„æºçš„æ‰€æœ‰æƒï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå­—ç¬¦ä¸²çš„å†…éƒ¨ç¼“å†²åŒºï¼‰ã€‚ç„¶åè°ƒç”¨è€…å¿…é¡»ä¼ é€’ä¸€ä¸ªä¸´æ—¶è¡¨è¾¾å¼æˆ–ä½¿ç”¨<code>std::move</code>è¿›è¡Œæ˜ç¡®çš„ç§»åŠ¨ã€‚å¤§è‡´ç›¸å½“äºä¸Šé¢çš„å‡½æ•°<code>process</code>çš„ç²—ç•¥ç­‰ä»·ç‰©æ˜¯ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(string&amp;&amp; s)</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">caller</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">string <span class="title">s</span><span class="params">(<span class="string">&quot;Hello, world!&quot;</span>)</span></span>;</span><br><span class="line">    <span class="built_in">process</span>(std::<span class="built_in">move</span>(s));</span><br><span class="line">    <span class="built_in">process</span>(std::<span class="built_in">move</span>(s));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>C++ ç¼–è¯‘å™¨æ²¡æœ‰ä¹‰åŠ¡å»è·Ÿè¸ªç§»åŠ¨ã€‚ä¾‹å¦‚ï¼Œä¸Šé¢çš„ä»£ç åœ¨ç¼–è¯‘æ—¶æ²¡æœ‰ä»»ä½•è­¦å‘Šæˆ–é”™è¯¯ï¼Œè‡³å°‘åœ¨ä½¿ç”¨é»˜è®¤çš„è®¾ç½®çš„æƒ…å†µä¸‹ï¼Œä¸Šè¿°ä»£ç åœ¨ç¼–è¯‘æ—¶æ²¡æœ‰ä»»ä½•è­¦å‘Šæˆ–é”™è¯¯ã€‚æ­¤å¤–ï¼Œåœ¨C++ä¸­ï¼Œå­—ç¬¦ä¸²<code>s</code>æœ¬èº«çš„æ‰€æœ‰æƒï¼ˆå¦‚æœä¸æ˜¯å®ƒçš„å†…éƒ¨ç¼“å†²åŒºçš„è¯ï¼‰ä»ç„¶å±äº<code>caller</code>ï¼Œæ‰€ä»¥<code>s</code>çš„ææ„å‡½æ•°ä¼šåœ¨<code>caller</code>è¿”å›æ—¶è¿è¡Œï¼Œå³ä½¿å®ƒå·²ç»è¢«ç§»åŠ¨äº†ï¼ˆç›¸åï¼Œåœ¨ Rust ä¸­ï¼Œè¢«ç§»åŠ¨çš„å€¼åªè¢«å…¶æ–°ä¸»äººä¸¢å¼ƒï¼‰ã€‚</p><h2 id="æˆ‘æ€æ ·æ‰èƒ½ä»-Rust-ä¸-C-äº’æ“ä½œï¼Œæˆ–è€…ä»-C-ä¸-Rust-äº’æ“ä½œï¼Ÿ"><a href="#æˆ‘æ€æ ·æ‰èƒ½ä»-Rust-ä¸-C-äº’æ“ä½œï¼Œæˆ–è€…ä»-C-ä¸-Rust-äº’æ“ä½œï¼Ÿ" class="headerlink" title="æˆ‘æ€æ ·æ‰èƒ½ä» Rust ä¸ C++ äº’æ“ä½œï¼Œæˆ–è€…ä» C++ ä¸ Rust äº’æ“ä½œï¼Ÿ"></a>æˆ‘æ€æ ·æ‰èƒ½ä» Rust ä¸ C++ äº’æ“ä½œï¼Œæˆ–è€…ä» C++ ä¸ Rust äº’æ“ä½œï¼Ÿ</h2><p>Rust å’Œ C++ å¯ä»¥é€šè¿‡ C è¯­è¨€è¿›è¡Œäº’æ“ä½œã€‚Rust å’Œ C++ éƒ½ä¸º C è¯­è¨€æä¾›äº†ä¸€ä¸ª<a href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#using-extern-functions-to-call-external-code">å¤–æ¥å‡½æ•°æ¥å£</a>ï¼Œå¹¶å¯ä»¥ç”¨å®ƒæ¥è¿›è¡Œç›¸äº’ä¹‹é—´çš„é€šä¿¡ã€‚å¦‚æœç¼–å†™ C è¯­è¨€ç»‘å®šå¤ªè¿‡ç¹çï¼Œä½ å¯ä»¥ä½¿ç”¨<a href="https://github.com/rust-lang/rust-bindgen">rust-bindgen</a>æ¥å¸®åŠ©è‡ªåŠ¨ç”Ÿæˆå¯è¡Œçš„ C è¯­è¨€ç»‘å®šã€‚</p><h2 id="Rust-æœ‰-C-é£æ ¼çš„æ„é€ å‡½æ•°å—ï¼Ÿ"><a href="#Rust-æœ‰-C-é£æ ¼çš„æ„é€ å‡½æ•°å—ï¼Ÿ" class="headerlink" title="Rust æœ‰ C++ é£æ ¼çš„æ„é€ å‡½æ•°å—ï¼Ÿ"></a>Rust æœ‰ C++ é£æ ¼çš„æ„é€ å‡½æ•°å—ï¼Ÿ</h2><p>ä¸ï¼Œå‡½æ•°çš„ä½œç”¨ä¸æ„é€ å‡½æ•°ç›¸åŒï¼Œä¸ä¼šå¢åŠ è¯­è¨€çš„å¤æ‚æ€§ã€‚åœ¨ Rust ä¸­ï¼Œç›¸å½“äºæ„é€ å‡½æ•°çš„é€šå¸¸åç§°æ˜¯<code>new()</code>ï¼Œå°½ç®¡è¿™åªæ˜¯ä¸€ä¸ªæƒ¯ä¾‹è€Œä¸æ˜¯è¯­è¨€è§„åˆ™ã€‚<code>new()</code>å‡½æ•°å®é™…ä¸Šå°±åƒå…¶ä»–å‡½æ•°ä¸€æ ·ã€‚å®ƒçš„ä¸€ä¸ªä¾‹å­æ˜¯è¿™æ ·çš„ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Foo</span></span> &#123;</span><br><span class="line">    a: <span class="built_in">i32</span>,</span><br><span class="line">    b: <span class="built_in">f64</span>,</span><br><span class="line">    c: <span class="built_in">bool</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Foo &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; Foo &#123;</span><br><span class="line">        Foo &#123;</span><br><span class="line">            a: <span class="number">0</span>,</span><br><span class="line">            b: <span class="number">0.0</span>,</span><br><span class="line">            c: <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Rust-æœ‰å¤åˆ¶æ„é€ å‡½æ•°å—ï¼Ÿ"><a href="#Rust-æœ‰å¤åˆ¶æ„é€ å‡½æ•°å—ï¼Ÿ" class="headerlink" title="Rust æœ‰å¤åˆ¶æ„é€ å‡½æ•°å—ï¼Ÿ"></a>Rust æœ‰å¤åˆ¶æ„é€ å‡½æ•°å—ï¼Ÿ</h2><p>ä¸å®Œå…¨æ˜¯ã€‚å®ç°äº†<code>Copy</code>çš„ç±»å‹ä¼šåšä¸€ä¸ªæ ‡å‡†çš„ç±»ä¼¼äº C è¯­è¨€çš„â€œæµ…æ‹·è´â€ï¼Œä¸éœ€è¦é¢å¤–çš„å·¥ä½œï¼ˆç±»ä¼¼äº C++ ä¸­çš„ trivially copyable ç±»å‹ï¼‰ã€‚ä¸å¯èƒ½å®ç°éœ€è¦è‡ªå®šä¹‰å¤åˆ¶è¡Œä¸ºçš„<code>Copy</code>ç±»å‹ã€‚ç›¸åï¼Œåœ¨ Rust ä¸­ï¼Œâ€œå¤åˆ¶æ„é€ å™¨â€æ˜¯é€šè¿‡å®ç°<code>Clone</code>ç‰¹æ€§ï¼Œå¹¶æ˜ç¡®è°ƒç”¨<code>clone</code>æ–¹æ³•æ¥åˆ›å»ºçš„ã€‚å°†ç”¨æˆ·å®šä¹‰çš„å¤åˆ¶æ“ä½œç¬¦æ˜¾æ€§åŒ–ï¼Œä½¿å¼€å‘è€…æ›´å®¹æ˜“è¯†åˆ«æ½œåœ¨çš„æ˜‚è´µæ“ä½œã€‚</p><h2 id="Rust-æœ‰ç§»åŠ¨æ„é€ å‡½æ•°å—ï¼Ÿ"><a href="#Rust-æœ‰ç§»åŠ¨æ„é€ å‡½æ•°å—ï¼Ÿ" class="headerlink" title="Rust æœ‰ç§»åŠ¨æ„é€ å‡½æ•°å—ï¼Ÿ"></a>Rust æœ‰ç§»åŠ¨æ„é€ å‡½æ•°å—ï¼Ÿ</h2><p>æ²¡æœ‰ã€‚æ‰€æœ‰ç±»å‹çš„å€¼éƒ½æ˜¯é€šè¿‡<code>memcpy</code>ç§»åŠ¨çš„ã€‚è¿™ä½¿å¾—ç¼–å†™é€šç”¨çš„ä¸å®‰å…¨ä»£ç å˜å¾—æ›´åŠ ç®€å•ï¼Œå› ä¸ºèµ‹å€¼ã€ä¼ é€’å’Œè¿”å›éƒ½æ˜¯å·²çŸ¥çš„ï¼Œä¸ä¼šäº§ç”Ÿåƒè§£ç»‘ï¼ˆunwindingï¼‰é‚£æ ·çš„å‰¯ä½œç”¨ã€‚</p><h2 id="Go-å’Œ-Rust-æœ‰ä»€ä¹ˆç›¸ä¼¼ä¹‹å¤„ï¼Œåˆæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ"><a href="#Go-å’Œ-Rust-æœ‰ä»€ä¹ˆç›¸ä¼¼ä¹‹å¤„ï¼Œåˆæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ" class="headerlink" title="Go å’Œ Rust æœ‰ä»€ä¹ˆç›¸ä¼¼ä¹‹å¤„ï¼Œåˆæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ"></a>Go å’Œ Rust æœ‰ä»€ä¹ˆç›¸ä¼¼ä¹‹å¤„ï¼Œåˆæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ</h2><p>Rust å’Œ Go çš„è®¾è®¡ç›®æ ‡æœ‰å¾ˆå¤§ä¸åŒã€‚ä»¥ä¸‹çš„å·®å¼‚å¹¶ä¸æ˜¯å”¯ä¸€çš„å·®å¼‚ï¼ˆè¿™äº›å·®å¼‚å¤ªå¤šï¼Œæ— æ³•ä¸€ä¸€åˆ—ä¸¾ï¼‰ï¼Œä½†å´æ˜¯å…¶ä¸­å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å·®å¼‚ï¼š</p><ul><li>Rust æ¯” Go å±‚çº§æ›´ä½ã€‚ä¾‹å¦‚ï¼ŒRust ä¸éœ€è¦åƒåœ¾æ”¶é›†å™¨ï¼Œè€Œ Go éœ€è¦ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒRust æä¾›çš„æ§åˆ¶æ°´å¹³ä¸ C æˆ– C++ ç›¸å½“ã€‚</li><li>Rust çš„é‡ç‚¹æ˜¯ç¡®ä¿å®‰å…¨å’Œæ•ˆç‡ï¼ŒåŒæ—¶æä¾›é«˜å±‚æ¬¡çš„èƒ½åŠ›ï¼Œè€Œ Go çš„é‡ç‚¹æ˜¯æˆä¸ºä¸€ç§å°è€Œç®€å•çš„è¯­è¨€ï¼Œå¯ä»¥å¿«é€Ÿç¼–è¯‘å¹¶ä¸å„ç§å·¥å…·å¾ˆå¥½åœ°é…åˆã€‚</li><li>Rust å¯¹æ³›å‹æœ‰å¾ˆå¼ºçš„æ”¯æŒï¼Œè€Œ Go ï¼ˆç›®å‰ï¼‰å´æ²¡æœ‰ã€‚</li><li>Rust å—åˆ°å‡½æ•°å¼ç¼–ç¨‹ä¸–ç•Œçš„å¼ºçƒˆå½±å“ï¼ŒåŒ…æ‹¬ä» Haskell çš„ typeclasses ä¸­æå–çš„ç±»å‹ç³»ç»Ÿã€‚Go æœ‰ä¸€ä¸ªæ›´ç®€å•çš„ç±»å‹ç³»ç»Ÿï¼Œä½¿ç”¨æ¥å£è¿›è¡ŒåŸºæœ¬çš„æ³›å‹ç¼–ç¨‹ã€‚</li></ul><h2 id="Rust-traits-ä¸-Haskell-typeclasses-ç›¸æ¯”å¦‚ä½•ï¼Ÿ"><a href="#Rust-traits-ä¸-Haskell-typeclasses-ç›¸æ¯”å¦‚ä½•ï¼Ÿ" class="headerlink" title="Rust traits ä¸ Haskell typeclasses ç›¸æ¯”å¦‚ä½•ï¼Ÿ"></a>Rust traits ä¸ Haskell typeclasses ç›¸æ¯”å¦‚ä½•ï¼Ÿ</h2><p>Rust traits ç±»ä¼¼äº Haskell çš„ typeclassesï¼Œä½†ç›®å‰è¿˜æ²¡æœ‰é‚£ä¹ˆå¼ºå¤§ï¼Œå› ä¸º Rust ä¸èƒ½è¡¨è¾¾æ›´é«˜ç±»å‹çš„ç±»å‹ã€‚Rust çš„å…³è”ç±»å‹ç­‰åŒäº Haskell ç±»å‹æ—ã€‚</p><p>Haskell typeclasses å’Œ Rust traits ä¹‹é—´çš„ä¸€äº›å…·ä½“åŒºåˆ«åŒ…æ‹¬ï¼š</p><ul><li>Rust traits æœ‰ä¸€ä¸ªéšå«çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå«åš<code>Self</code>ã€‚Rust ä¸­çš„<code>trait Bar</code>å¯¹åº”äº Haskell ä¸­çš„<code>class Bar self</code>ï¼Œè€Œ Rust ä¸­çš„<code>trait Bar&lt;Foo&gt;</code>å¯¹åº”äº Haskell ä¸­çš„<code>class Bar foo self</code>ã€‚</li><li>Rust ä¸­çš„â€œSupertraitsâ€æˆ–â€œsuperclass constraintsâ€è¢«å†™æˆ<code>trait Sub: Super</code>ï¼Œè€Œ Haskell ä¸­çš„ä¸º<code>class Super self =&gt; Sub self</code>ã€‚</li><li>Rust ç¦æ­¢æ— ä¸»å®ä¾‹ï¼Œå¯¼è‡´ Rust ä¸­çš„ä¸€è‡´æ€§è§„åˆ™ä¸ Haskell ä¸åŒã€‚</li><li>Rust çš„<code>impl</code>è§£æåœ¨å†³å®šä¸¤ä¸ª<code>impl</code>æ˜¯å¦é‡å æˆ–åœ¨æ½œåœ¨çš„<code>impl</code>ä¹‹é—´è¿›è¡Œé€‰æ‹©æ—¶ï¼Œä¼šè€ƒè™‘ç›¸å…³çš„<code>where</code>æ¡æ¬¾å’Œç‰¹è´¨çº¦æŸæ¡ä»¶ã€‚Haskell åªè€ƒè™‘<code>instance</code>å£°æ˜ä¸­çš„çº¦æŸï¼Œä¸è€ƒè™‘å…¶ä»–åœ°æ–¹æä¾›çš„ä»»ä½•çº¦æŸã€‚</li><li>Rust çš„ traits çš„ä¸€ä¸ªå­é›†ï¼ˆ<a href="https://github.com/rust-lang/rfcs/blob/master/text/0255-object-safety.md">â€œå¯¹è±¡å®‰å…¨â€</a>çš„ traitsï¼‰å¯ä»¥é€šè¿‡ trait å¯¹è±¡ç”¨äºåŠ¨æ€è°ƒåº¦ã€‚åŒæ ·çš„åŠŸèƒ½åœ¨ Haskell ä¸­é€šè¿‡ GHC çš„â€œExistentialQuantificationâ€å¯ç”¨ã€‚</li></ul><h1 id="Documentation"><a href="#Documentation" class="headerlink" title="Documentation"></a>Documentation</h1><h2 id="ä¸ºä»€ä¹ˆ-Stack-Overflow-ä¸Šæœ‰è¿™ä¹ˆå¤š-Rust-çš„ç­”æ¡ˆæ˜¯é”™è¯¯çš„ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆ-Stack-Overflow-ä¸Šæœ‰è¿™ä¹ˆå¤š-Rust-çš„ç­”æ¡ˆæ˜¯é”™è¯¯çš„ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆ Stack Overflow ä¸Šæœ‰è¿™ä¹ˆå¤š Rust çš„ç­”æ¡ˆæ˜¯é”™è¯¯çš„ï¼Ÿ"></a>ä¸ºä»€ä¹ˆ Stack Overflow ä¸Šæœ‰è¿™ä¹ˆå¤š Rust çš„ç­”æ¡ˆæ˜¯é”™è¯¯çš„ï¼Ÿ</h2><p>Rust è¯­è¨€å·²ç»å­˜åœ¨äº†å¾ˆå¤šå¹´ï¼Œåœ¨ 2015 å¹´ 5 æœˆæ‰è¾¾åˆ° 1.0 ç‰ˆæœ¬ã€‚åœ¨è¿™ä¹‹å‰çš„æ—¶é—´é‡Œï¼Œè¯­è¨€å‘ç”Ÿäº†å¾ˆå¤§çš„å˜åŒ–ï¼Œè€Œ Stack Overflow çš„ä¸€äº›ç­”æ¡ˆæ˜¯åœ¨è¯­è¨€çš„æ—§ç‰ˆæœ¬æ—¶ç»™å‡ºçš„ã€‚</p><p>éšç€æ—¶é—´çš„æ¨ç§»ï¼Œè¶Šæ¥è¶Šå¤šçš„ç­”æ¡ˆå°†æä¾›ç»™å½“å‰çš„ç‰ˆæœ¬ï¼Œä»è€Œæ”¹å–„è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºè¿‡æ—¶çš„ç­”æ¡ˆçš„æ¯”ä¾‹å‡å°‘äº†ã€‚</p><h2 id="æˆ‘åœ¨å“ªé‡ŒæŠ¥å‘Š-Rust-æ–‡æ¡£ä¸­çš„é—®é¢˜ï¼Ÿ"><a href="#æˆ‘åœ¨å“ªé‡ŒæŠ¥å‘Š-Rust-æ–‡æ¡£ä¸­çš„é—®é¢˜ï¼Ÿ" class="headerlink" title="æˆ‘åœ¨å“ªé‡ŒæŠ¥å‘Š Rust æ–‡æ¡£ä¸­çš„é—®é¢˜ï¼Ÿ"></a>æˆ‘åœ¨å“ªé‡ŒæŠ¥å‘Š Rust æ–‡æ¡£ä¸­çš„é—®é¢˜ï¼Ÿ</h2><p>ä½ å¯ä»¥åœ¨ Rust ç¼–è¯‘å™¨<a href="https://github.com/rust-lang/rust/issues">issue tracker</a>ä¸ŠæŠ¥å‘Š Rust æ–‡æ¡£ä¸­çš„é—®é¢˜ã€‚è¯·åŠ¡å¿…å…ˆé˜…è¯»<a href="https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#writing-documentation">è´¡çŒ®æŒ‡å—</a>ã€‚</p><h2 id="æˆ‘å¦‚ä½•æŸ¥çœ‹æˆ‘çš„é¡¹ç›®æ‰€ä¾èµ–çš„åº“çš„-Rustdoc-æ–‡æ¡£ï¼Ÿ"><a href="#æˆ‘å¦‚ä½•æŸ¥çœ‹æˆ‘çš„é¡¹ç›®æ‰€ä¾èµ–çš„åº“çš„-Rustdoc-æ–‡æ¡£ï¼Ÿ" class="headerlink" title="æˆ‘å¦‚ä½•æŸ¥çœ‹æˆ‘çš„é¡¹ç›®æ‰€ä¾èµ–çš„åº“çš„ Rustdoc æ–‡æ¡£ï¼Ÿ"></a>æˆ‘å¦‚ä½•æŸ¥çœ‹æˆ‘çš„é¡¹ç›®æ‰€ä¾èµ–çš„åº“çš„ Rustdoc æ–‡æ¡£ï¼Ÿ</h2><p>å½“ä½ ä½¿ç”¨<code>cargo doc</code>ä¸ºä½ è‡ªå·±çš„é¡¹ç›®ç”Ÿæˆæ–‡æ¡£æ—¶ï¼Œå®ƒä¹Ÿä¼šä¸ºæ´»åŠ¨çš„ä¾èµ–ç‰ˆæœ¬ç”Ÿæˆæ–‡æ¡£ã€‚è¿™äº›æ–‡æ¡£ä¼šè¢«æ”¾åˆ°ä½ çš„é¡¹ç›®çš„<code>target/doc</code>ç›®å½•ä¸‹ã€‚ä½¿ç”¨<code>cargo doc --open</code>æ¥æ‰“å¼€è¿™äº›æ–‡æ¡£ï¼Œæˆ–è€…è‡ªå·±æ‰“å¼€<code>target/doc/index.html</code>ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;åŸæ–‡ï¼š&lt;a href=&quot;https://github.com/dtolnay/rust-faq&quot;&gt;https://github.com/dtolnay/rust-faq&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡æ¡£çš„å­˜åœ¨æ˜¯ä¸ºäº†å›ç­”æœ‰å…³ Rust ç¼–ç¨‹è¯­è¨€çš„å¸¸è§é—®é¢˜ã€‚å®ƒä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„è¯­è¨€æŒ‡å—ï¼Œä¹Ÿä¸æ˜¯ä¸€ä¸ªæ•™æˆè¯¥è¯­è¨€çš„å·¥å…·ã€‚å®ƒåªæ˜¯ä¸€ä¸ªå‚è€ƒï¼Œç”¨æ¥å›ç­” Rust ç¤¾åŒºä¸­äººä»¬ç»å¸¸é‡åˆ°çš„é—®é¢˜ï¼Œå¹¶æ¾„æ¸… Rust çš„ä¸€äº›è®¾è®¡å†³å®šèƒŒåçš„åŸå› ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="rust" scheme="https://www.purewhite.io/categories/rust/"/>
    
    
    <category term="rust" scheme="https://www.purewhite.io/tags/rust/"/>
    
  </entry>
  
  <entry>
    <title>Rust è®¤ä¸ºä»€ä¹ˆæ˜¯â€œæœªå®šä¹‰â€ä»¥åŠä»€ä¹ˆä¸æ˜¯â€œä¸å®‰å…¨â€ï¼Ÿ</title>
    <link href="https://www.purewhite.io/2021/08/11/rust-considered-unsafe-undefined/"/>
    <id>https://www.purewhite.io/2021/08/11/rust-considered-unsafe-undefined/</id>
    <published>2021-08-11T07:27:38.000Z</published>
    <updated>2021-12-02T12:51:07.229Z</updated>
    
    <content type="html"><![CDATA[<p>å¤§å®¶åº”è¯¥éƒ½å¬è¯´è¿‡ Rust è¯­è¨€æ˜¯ä»¥å®‰å…¨ï¼ˆSafeï¼‰ä½œä¸ºç‰¹æ€§ä¹‹ä¸€çš„ï¼Œä½†æ˜¯ç”±äºä¸€ä¸ªæ‚²å“€çš„äº‹å®â€”â€”ç¡¬ä»¶æ˜¯ä¸å®‰å…¨ï¼ˆUnsafeï¼‰çš„ï¼Œæ‰€ä»¥å…¶å®æ‰€æœ‰çš„â€œå®‰å…¨â€ä¸€å®šæ˜¯åœ¨â€œä¸å®‰å…¨â€ä¹‹ä¸Šçš„å°è£…ï¼Œè¿™ä¹Ÿå¯¼è‡´äº†å®Œå…¨æ„ä¹‰ä¸Šçš„â€œSafeâ€æ˜¯å¾ˆéš¾åšåˆ°ä¸”åŠŸèƒ½æå…¶å—é™çš„ã€‚</p><p>é‚£è®©æˆ‘ä»¬æ¥çœ‹çœ‹ï¼ŒRust çš„ Safe è¾¹ç•Œåœ¨å“ªé‡Œã€‚</p><span id="more"></span><h1 id="Rust-è®¤ä¸ºä»€ä¹ˆä¸æ˜¯â€œä¸å®‰å…¨â€ï¼Ÿ"><a href="#Rust-è®¤ä¸ºä»€ä¹ˆä¸æ˜¯â€œä¸å®‰å…¨â€ï¼Ÿ" class="headerlink" title="Rust è®¤ä¸ºä»€ä¹ˆä¸æ˜¯â€œä¸å®‰å…¨â€ï¼Ÿ"></a>Rust è®¤ä¸ºä»€ä¹ˆä¸æ˜¯â€œä¸å®‰å…¨â€ï¼Ÿ</h1><p>ä»€ä¹ˆæ˜¯å®‰å…¨çš„ Rust ç›¸ä¿¡å¤§å®¶éƒ½äº†è§£ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼›å®é™…ä¸Šï¼Œæœ‰ä¸€äº›è¡Œä¸ºè™½ç„¶æˆ‘ä»¬ä¼šè®¤ä¸ºæ˜¯é¢„æœŸä¹‹å¤–ç”šè‡³ä¸å®‰å…¨çš„ï¼Œä½†æ˜¯ Rust ä¸ä¼šï¼š</p><ul><li>æ­»é”</li><li>å†…å­˜ã€èµ„æºæ³„éœ²</li><li>æœªæ‰§è¡Œææ„å°±é€€å‡º</li><li>ç”±äºæŒ‡é’ˆæ³„æ¼ï¼Œæš´éœ²äº†éšæœºçš„åŸºåœ°å€</li><li>æ•´å‹æº¢å‡º</li><li>é€»è¾‘é”™è¯¯</li></ul><p>å‰å››ä¸ªéƒ½å¥½ç†è§£ï¼Œç‰¹åˆ«æ˜¯å†…å­˜æ³„æ¼è¿™ä¸ªï¼Œåœ¨ The Book ä¸­å°±æœ‰æåˆ°ï¼ˆè€Œä¸”å¯ä»¥çœ‹ä¸‹ï¼Œæ ‡å‡†åº“çš„<code>std::mem:leak</code>éƒ½ä¸æ˜¯ unsafe çš„ï¼‰ï¼›è¿™é‡Œç‰¹åˆ«è¦è®¨è®ºçš„æ˜¯ï¼Œæ•´å‹æº¢å‡ºå’Œé€»è¾‘é”™è¯¯è¿™ä¸¤ä¸ªé—®é¢˜ã€‚</p><h2 id="æ•´å‹æº¢å‡º"><a href="#æ•´å‹æº¢å‡º" class="headerlink" title="æ•´å‹æº¢å‡º"></a>æ•´å‹æº¢å‡º</h2><p>å¦‚æœä¸€æ®µä»£ç åŒ…å«ç®—æœ¯æº¢å‡ºï¼Œé‚£æ˜¯ç¨‹åºå‘˜çš„é”…ã€‚åœ¨ä¸‹é¢çš„è®¨è®ºä¸­ï¼Œæˆ‘ä»¬éœ€è¦åŒºåˆ†ç®—æœ¯æº¢å‡ºå’ŒåŒ…è£…ç®—æœ¯ï¼ˆwrapping arithmeticï¼‰ã€‚å‰è€…æ˜¯é”™è¯¯çš„ï¼Œè€Œåè€…æ˜¯é¢„æœŸä¹‹ä¸­çš„ã€‚</p><p>å½“ç¨‹åºå‘˜å¯ç”¨äº†<code>debug_assert!</code>æ–­è¨€ï¼ˆä¾‹å¦‚ï¼Œdebug æ¨¡å¼ä¸‹çš„ç¼–è¯‘ï¼‰ï¼Œç¼–è¯‘å™¨ä¼šåœ¨è¿è¡Œæ—¶æ’å…¥åŠ¨æ€æ£€æŸ¥ï¼Œå¦‚æœå‘ç”Ÿäº†æº¢å‡ºä¼š panicã€‚å…¶ä»–ç±»å‹çš„æ„å»ºï¼ˆå¦‚ release æ¨¡å¼ä¸‹ï¼‰å¯èƒ½ä¼šå¯¼è‡´ panic æˆ–åœ¨æº¢å‡ºæ—¶å•¥éƒ½ä¸åšã€‚</p><p>åœ¨éšå¼åŒ…è£…æº¢å‡ºçš„æƒ…å†µä¸‹ï¼Œå®ç°è€…å¿…é¡»é€šè¿‡ä½¿ç”¨<a href="https://zh.wikipedia.org/wiki/%E4%BA%8C%E8%A3%9C%E6%95%B8">äºŒè¡¥æ•°çš„æº¢å‡ºçº¦å®š</a>æ¥æä¾›å®šä¹‰æ˜ç¡®çš„ï¼ˆå³ä½¿ä»ç„¶è¢«è®¤ä¸ºæ˜¯é”™è¯¯çš„ï¼‰ç»“æœã€‚</p><p>Rust æ ‡å‡†åº“ä¸ºæ•´å‹æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œå…è®¸ç¨‹åºå‘˜æ˜ç¡®åœ°æ‰§è¡ŒåŒ…è£…ç®—æœ¯ã€‚ä¾‹å¦‚ï¼Œ<code>i32::wrapping_add</code>æä¾›äº†äºŒè¡¥ã€åŒ…è£…åŠ æ³•ã€‚</p><p>æ ‡å‡†åº“è¿˜æä¾›äº†ä¸€ä¸ª<code>Wrapping&lt;T&gt;</code>ç±»å‹ï¼Œç¡®ä¿<code>T</code>çš„æ‰€æœ‰æ ‡å‡†ç®—æœ¯æ“ä½œéƒ½æœ‰åŒ…è£…è¯­ä¹‰ã€‚</p><p>å…³äºæ•´æ•°æº¢å‡ºçš„é”™è¯¯æ¡ä»¶ã€åŸç†å’Œæ›´å¤šç»†èŠ‚ï¼Œå¯ä»¥å‚è€ƒ<a href="https://github.com/rust-lang/rfcs/blob/master/text/0560-integer-overflow.md">RFC 560</a>ã€‚</p><h2 id="é€»è¾‘é”™è¯¯"><a href="#é€»è¾‘é”™è¯¯" class="headerlink" title="é€»è¾‘é”™è¯¯"></a>é€»è¾‘é”™è¯¯</h2><p>å®‰å…¨ä»£ç å¯ä»¥æœ‰ä¸€äº›é¢å¤–çš„é€»è¾‘çº¦æŸï¼Œè¿™äº›çº¦æŸåœ¨ç¼–è¯‘æ—¶å’Œè¿è¡Œæ—¶éƒ½æ— æ³•æ£€æŸ¥ã€‚å¦‚æœä¸€ä¸ªç¨‹åºç ´åäº†è¿™æ ·çš„çº¦æŸï¼Œå…¶è¡Œä¸ºå¯èƒ½æ˜¯æœªæŒ‡å®šçš„ï¼Œä½†ä¸ä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚è¿™å¯èƒ½åŒ…æ‹¬ panicã€ä¸æ­£ç¡®çš„ç»“æœã€éé¢„æœŸçš„ä¸­æ­¢æˆ–è€…æ­»å¾ªç¯ã€‚è¿™ç§è¡Œä¸ºä¹Ÿå¯èƒ½åœ¨ä¸åŒçš„è¿è¡Œã€æ„å»ºæˆ–æ„å»ºç§ç±»ä¹‹é—´æœ‰æ‰€ä¸åŒã€‚</p><p>ä¾‹å¦‚ï¼Œå®ç°<code>Hash</code>å’Œ<code>Eq</code>è¦æ±‚ç›¸ç­‰çš„å€¼ä¸€å®šè¦æœ‰ç›¸ç­‰çš„å“ˆå¸Œå€¼ã€‚å¦ä¸€ä¸ªä¾‹å­æ˜¯åƒ<code>BinaryHeap</code>ã€<code>BTreeMap</code>ã€<code>BTreeSet</code>ã€<code>HashMap</code>å’Œ<code>HashSet</code>è¿™æ ·çš„æ•°æ®ç»“æ„ï¼Œå®ƒä»¬é’ˆå¯¹åœ¨å®ƒä»¬ Key ä¸­çš„å¯¹è±¡çš„ä¿®æ”¹å®šä¹‰äº†ä¸€äº›çº¦æŸã€‚è¿åè¿™æ ·çš„çº¦æŸä¸è¢«è®¤ä¸ºæ˜¯ä¸å®‰å…¨çš„ï¼Œç„¶è€Œç¨‹åºçš„è¡Œä¸ºæ˜¯ä¸å¯é¢„æµ‹çš„ï¼Œéšæ—¶æœ‰å¯èƒ½æŒ‚ã€‚</p><h1 id="Rust-è®¤ä¸ºä»€ä¹ˆæ˜¯â€œæœªå®šä¹‰â€"><a href="#Rust-è®¤ä¸ºä»€ä¹ˆæ˜¯â€œæœªå®šä¹‰â€" class="headerlink" title="Rust è®¤ä¸ºä»€ä¹ˆæ˜¯â€œæœªå®šä¹‰â€"></a>Rust è®¤ä¸ºä»€ä¹ˆæ˜¯â€œæœªå®šä¹‰â€</h1><p>æœªå®šä¹‰ï¼ˆUndefined Behaviourï¼‰æ˜¯ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„å®šä¹‰ï¼Œç®—æ˜¯å†™ C å’Œ C++ ç¨‹åºå‘˜çš„è€æœ‹å‹äº†ï¼Œç”šè‡³å¾ˆå¤šä»£ç ä¼šä¾èµ–æœªå®šä¹‰è¡Œä¸ºã€‚</p><p>å¦‚æœ Rust ä»£ç æœ‰ä»¥ä¸‹åˆ—è¡¨ä¸­çš„ä»»ä½•è¡Œä¸ºï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ä¸æ­£ç¡®çš„ï¼ŒåŒ…æ‹¬ unsafe ä¸­çš„ä»£ç ã€‚<strong>unsafe åªæ„å‘³ç€é¿å…æœªå®šä¹‰çš„è¡Œä¸ºæ˜¯ç”±ç¨‹åºå‘˜è´Ÿè´£çš„ï¼›å®ƒæ²¡æœ‰æ”¹å˜ä»»ä½•å…³äº Rust ç¨‹åºå†³ä¸èƒ½å¼•èµ·æœªå®šä¹‰è¡Œä¸ºçš„è¦æ±‚ã€‚</strong>æ¢è¨€ä¹‹ï¼Œæ— è®ºæ˜¯å¦ä½¿ç”¨ unsafeï¼Œéƒ½ä¸åº”è¯¥æœ‰æœªå®šä¹‰çš„è¡Œä¸ºå‡ºç°ã€‚</p><p>åœ¨ç¼–å†™ unsafe ä»£ç æ—¶ï¼Œç¨‹åºå‘˜æœ‰è´£ä»»ç¡®ä¿ä»»ä½•ä¸ä¸å®‰å…¨ä»£ç äº¤äº’çš„å®‰å…¨ä»£ç ä¸èƒ½è§¦å‘è¿™äº›è¡Œä¸ºã€‚å¯¹äºä»»ä½•å®‰å…¨çš„è°ƒç”¨è€…æ¥è¯´ï¼Œæ»¡è¶³è¿™ä¸€å±æ€§çš„ä¸å®‰å…¨ä»£ç è¢«ç§°ä¸ºå¥å…¨ï¼ˆsoundï¼‰çš„ï¼›å¦‚æœä¸å®‰å…¨ä»£ç å¯ä»¥è¢«å®‰å…¨ä»£ç æ»¥ç”¨è€Œè¡¨ç°å‡ºæœªå®šä¹‰çš„è¡Œä¸ºï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ä¸å¥å…¨çš„ã€‚</p><p><strong>è¦æ³¨æ„ï¼Œä¸‹é¢çš„åˆ—è¡¨å¹¶ä¸æ˜¯è¯¦å°½çš„ã€‚å¯¹äºä¸å®‰å…¨ä»£ç ä¸­å…è®¸å’Œä¸å…è®¸çš„è¡Œä¸ºï¼ŒRust çš„è¯­ä¹‰å¹¶æ²¡æœ‰æ­£å¼çš„æ¨¡å‹ï¼Œæ‰€ä»¥å¯èƒ½æœ‰æ›´å¤šçš„è¡Œä¸ºè¢«è®¤ä¸ºæ˜¯ä¸å®‰å…¨çš„ã€‚ä¸‹é¢çš„åˆ—è¡¨åªæ˜¯æˆ‘ä»¬ç¡®å®šçš„æœªå®šä¹‰è¡Œä¸ºã€‚åœ¨ç¼–å†™ä¸å®‰å…¨ä»£ç ä¹‹å‰ï¼Œè¯·é˜…è¯»æ­»çµä¹¦ï¼ˆRustonomiconï¼‰ã€‚</strong></p><ul><li><p>æ•°æ®ç«äº‰ï¼ˆData racesï¼‰</p></li><li><p>åœ¨ä¸€ä¸ªæ‚¬ç©ºæˆ–ä¸å¯¹é½çš„åŸå§‹æŒ‡é’ˆä¸Šæ‰§è¡Œè§£å¼•ç”¨è¡¨è¾¾å¼ï¼ˆ*exprï¼‰ï¼Œå³ä½¿æ˜¯åœ¨åœ°å€è¡¨è¾¾å¼ä¸Šä¸‹æ–‡ä¸­ï¼ˆä¾‹å¦‚<code>addr_of!(&amp;*expr)</code>ï¼‰ã€‚</p></li><li><p>ç ´åäº†æŒ‡é’ˆåˆ«åè§„åˆ™ã€‚<code>&amp;mut T</code>å’Œ<code>&amp;T</code>éµå¾ª LLVM çš„ä½œç”¨åŸŸ<code>noalias</code>æ¨¡å‹ï¼Œé™¤é<code>&amp;T</code>åŒ…å«ä¸€ä¸ª<code>UnsafeCell&lt;U&gt;</code>ã€‚</p></li><li><p>ä¿®æ”¹ä¸å¯å˜çš„æ•°æ®ã€‚const é¡¹ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½æ˜¯ä¸å¯å˜çš„ã€‚æ­¤å¤–ï¼Œæ‰€æœ‰å…±äº«å¼•ç”¨çš„æ•°æ®æˆ–ç”±ä¸å¯å˜çš„ç»‘å®šæ‰€æ‹¥æœ‰çš„æ•°æ®éƒ½æ˜¯ä¸å¯å˜çš„ï¼Œé™¤éè¯¥æ•°æ®åŒ…å«åœ¨ä¸€ä¸ª<code>UnsafeCell&lt;U&gt;</code>ä¸­ã€‚</p></li><li><p>é€šè¿‡ç¼–è¯‘å™¨çš„å†…å»ºæŒ‡ä»¤è°ƒç”¨æœªå®šä¹‰çš„è¡Œä¸ºã€‚</p></li><li><p>æ‰§è¡Œå½“å‰å¹³å°ä¸æ”¯æŒçš„å¹³å°ç‰¹æ€§ç¼–è¯‘çš„ä»£ç ï¼ˆè§<a href="https://doc.rust-lang.org/stable/reference/attributes/codegen.html#the-target_feature-attribute"><code>target_feature</code></a>ï¼Œè¿™é€šå¸¸ä¼šå¯¼è‡´ SIGILLï¼‰ã€‚</p></li><li><p>è°ƒç”¨å…·æœ‰é”™è¯¯è°ƒç”¨è§„çº¦ï¼ˆABIï¼‰çš„å‡½æ•°æˆ– unwind å…·æœ‰é”™è¯¯ unwind ABI çš„å‡½æ•°ã€‚</p></li><li><p>äº§ç”Ÿä¸€ä¸ªæ— æ•ˆçš„å€¼ï¼Œå“ªæ€•æ˜¯åœ¨ç§æœ‰å­—æ®µå’Œå±€éƒ¨å­—æ®µä¸­ã€‚ä¸€ä¸ªå€¼è¢«åˆ†é…åˆ°ä¸€ä¸ªåœ°æ–¹æˆ–ä»ä¸€ä¸ªåœ°æ–¹è¯»å‡ºã€ä¼ é€’åˆ°ä¸€ä¸ªå‡½æ•° / åŸå§‹æ“ä½œï¼ˆprimitive operationï¼‰æˆ–ä»ä¸€ä¸ªå‡½æ•° / åŸå§‹æ“ä½œè¿”å›éƒ½ä¼šâ€œäº§ç”Ÿâ€ä¸€ä¸ªå€¼ã€‚ä»¥ä¸‹çš„å€¼æ˜¯æ— æ•ˆçš„ï¼š</p><ul><li><p>bool ä¸­é™¤ falseï¼ˆ0ï¼‰æˆ– trueï¼ˆ1ï¼‰ä»¥å¤–çš„å€¼ã€‚</p></li><li><p>ç±»å‹å®šä¹‰ä¸­æ²¡æœ‰åŒ…æ‹¬çš„æšä¸¾ä¸­çš„åˆ¤åˆ«å¼ã€‚</p></li><li><p>ä¸€ä¸ªç©ºçš„ fn æŒ‡é’ˆã€‚</p></li><li><p>char ä¸­çš„ä¸€ä¸ªå€¼æ˜¯ä»£ç”¨çš„ï¼ˆsurrogateï¼‰æˆ–é«˜äº<code>char::MAX</code>çš„ã€‚</p></li><li><p><code>!</code> ï¼ˆæ‰€æœ‰çš„å€¼å¯¹è¿™ä¸ªç±»å‹æ¥è¯´éƒ½æ˜¯æ— æ•ˆçš„ï¼‰ã€‚</p></li><li><p>ä¸€ä¸ªæ•´æ•°ã€æµ®ç‚¹å€¼ï¼Œæˆ–ä»æœªåˆå§‹åŒ–çš„å†…å­˜ä¸­è·å¾—çš„åŸå§‹æŒ‡é’ˆï¼Œæˆ–<code>str</code>ä¸­æœªåˆå§‹åŒ–çš„å†…å­˜ã€‚</p></li><li><p>ä¸€ä¸ªå¼•ç”¨æˆ–<code>Box&lt;T&gt;</code>æ˜¯æ‚¬ç©ºçš„ã€ä¸å¯¹é½çš„ï¼Œæˆ–è€…æŒ‡å‘ä¸€ä¸ªæ— æ•ˆçš„å€¼ã€‚</p></li><li><p>æ³›å¼•ç”¨ã€<code>Box&lt;T&gt;</code>æˆ–åŸå§‹æŒ‡é’ˆä¸­æ— æ•ˆçš„å…ƒæ•°æ®ã€‚</p><ul><li>å¦‚æœä¸€ä¸ª<code>dyn Trait</code>æŒ‡é’ˆ / å¼•ç”¨æŒ‡å‘çš„ vtable å’Œå¯¹åº” Trait çš„ vtable ä¸åŒ¹é…ï¼Œé‚£ä¹ˆ<code>dyn Trait</code>çš„å…ƒæ•°æ®æ˜¯æ— æ•ˆçš„ã€‚</li><li>å¦‚æœ Slice çš„é•¿åº¦ä¸æ˜¯æœ‰æ•ˆçš„ usizeï¼ˆæ¯”å¦‚ï¼Œä»æœªåˆå§‹åŒ–çš„å†…å­˜ä¸­è¯»å–çš„ usizeï¼‰ï¼Œé‚£ä¹ˆ Slice çš„å…ƒæ•°æ®æ˜¯æ— æ•ˆçš„ã€‚</li></ul></li><li><p>å¯¹äºä¸€ä¸ªå…·æœ‰è‡ªå®šä¹‰çš„æ— æ•ˆå€¼çš„ç±»å‹æ¥è¯´æ˜¯æ— æ•ˆçš„å€¼ï¼ˆçœ‹ç€æœ‰ç‚¹ç»•ï¼‰ï¼Œæ¯”å¦‚åœ¨æ ‡å‡†åº“ä¸­çš„<code>NonNull&lt;T&gt;</code>å’Œ<code>NonZero*</code>ã€‚</p><blockquote><p>æ³¨ï¼šRustc é€šè¿‡ä¸ç¨³å®šçš„<code>rustc_layout_scalar_valid_range_*</code>å±æ€§å®ç°äº†è¿™ä¸€ç‚¹ã€‚</p></blockquote></li></ul></li></ul><p>æ³¨æ„ï¼šå¯¹äºä»»ä½•å…·æœ‰å—é™çš„æœ‰æ•ˆå€¼é›†çš„ç±»å‹ï¼Œæœªåˆå§‹åŒ–çš„å†…å­˜ä¹Ÿæ˜¯éšå¼æ— æ•ˆçš„ã€‚æ¢å¥è¯è¯´ï¼Œå”¯ä¸€å…è®¸è¯»å–æœªåˆå§‹åŒ–å†…å­˜çš„æƒ…å†µæ˜¯åœ¨ union å†…å’Œ<code>padding</code>ä¸­ï¼ˆä¸€ä¸ªç±»å‹çš„å­—æ®µ / å…ƒç´ ä¹‹é—´çš„ç©ºéš™ï¼‰ã€‚</p><blockquote><p>æ³¨ï¼šæœªå®šä¹‰è¡Œä¸ºä¼šå½±å“æ•´ä¸ªç¨‹åºã€‚ä¾‹å¦‚ï¼Œåœ¨ C è¯­è¨€ä¸­è°ƒç”¨ä¸€ä¸ªè¡¨ç°å‡º C è¯­è¨€æœªå®šä¹‰è¡Œä¸ºçš„å‡½æ•°ï¼Œæ„å‘³ç€ä½ çš„æ•´ä¸ªç¨‹åºåŒ…å«æœªå®šä¹‰è¡Œä¸ºï¼Œè¿™ä¹Ÿä¼šå½±å“ Rust ä»£ç ã€‚åä¹‹äº¦ç„¶ï¼ŒRust ä¸­çš„æœªå®šä¹‰è¡Œä¸ºä¼šå¯¹å…¶ä»–è¯­è¨€çš„ä»»ä½• FFI è°ƒç”¨æ‰€æ‰§è¡Œçš„ä»£ç é€ æˆä¸è‰¯å½±å“ã€‚</p></blockquote><h2 id="æ‚¬å‚æŒ‡é’ˆ"><a href="#æ‚¬å‚æŒ‡é’ˆ" class="headerlink" title="æ‚¬å‚æŒ‡é’ˆ"></a>æ‚¬å‚æŒ‡é’ˆ</h2><p>å¦‚æœä¸€ä¸ªå¼•ç”¨ / æŒ‡é’ˆæ˜¯ç©ºçš„ï¼Œæˆ–è€…å®ƒæ‰€æŒ‡å‘çš„æ‰€æœ‰åœ°å€å¹¶éåˆæ³•çš„åœ°å€ï¼ˆæ¯”å¦‚ malloc åˆ†é…å‡ºçš„å†…å­˜ï¼‰ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯<code>æ‚¬å‚</code>çš„ã€‚å®ƒæ‰€æŒ‡å‘çš„èŒƒå›´æ˜¯ç”±æŒ‡é’ˆå€¼å’Œè¢«æŒ‡å‘ç±»å‹çš„å¤§å°å†³å®šçš„ï¼ˆä½¿ç”¨<code>size_of_val</code>ï¼‰ã€‚å› æ­¤ï¼Œå¦‚æœæŒ‡å‘çš„èŒƒå›´æ˜¯ç©ºçš„ï¼Œ<code>æ‚¬å‚</code>ä¸<code>éç©º</code>æ˜¯ä¸€æ ·çš„ã€‚</p><p>è¦æ³¨æ„ï¼Œåˆ‡ç‰‡å’Œå­—ç¬¦ä¸²æŒ‡å‘å®ƒä»¬çš„æ•´ä¸ªèŒƒå›´ï¼Œæ‰€ä»¥å®ƒä»¬çš„é•¿åº¦ä¸å¯èƒ½å¾ˆå¤§ã€‚å†…å­˜åˆ†é…çš„é•¿åº¦ã€åˆ‡ç‰‡å’Œå­—ç¬¦ä¸²çš„é•¿åº¦ä¸èƒ½å¤§äº<code>isize::MAX</code>å­—èŠ‚ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¤§å®¶åº”è¯¥éƒ½å¬è¯´è¿‡ Rust è¯­è¨€æ˜¯ä»¥å®‰å…¨ï¼ˆSafeï¼‰ä½œä¸ºç‰¹æ€§ä¹‹ä¸€çš„ï¼Œä½†æ˜¯ç”±äºä¸€ä¸ªæ‚²å“€çš„äº‹å®â€”â€”ç¡¬ä»¶æ˜¯ä¸å®‰å…¨ï¼ˆUnsafeï¼‰çš„ï¼Œæ‰€ä»¥å…¶å®æ‰€æœ‰çš„â€œå®‰å…¨â€ä¸€å®šæ˜¯åœ¨â€œä¸å®‰å…¨â€ä¹‹ä¸Šçš„å°è£…ï¼Œè¿™ä¹Ÿå¯¼è‡´äº†å®Œå…¨æ„ä¹‰ä¸Šçš„â€œSafeâ€æ˜¯å¾ˆéš¾åšåˆ°ä¸”åŠŸèƒ½æå…¶å—é™çš„ã€‚&lt;/p&gt;
&lt;p&gt;é‚£è®©æˆ‘ä»¬æ¥çœ‹çœ‹ï¼ŒRust çš„ Safe è¾¹ç•Œåœ¨å“ªé‡Œã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="rust" scheme="https://www.purewhite.io/categories/rust/"/>
    
    
    <category term="rust" scheme="https://www.purewhite.io/tags/rust/"/>
    
  </entry>
  
  <entry>
    <title>ã€è¯‘ã€‘Inventing the Service trait</title>
    <link href="https://www.purewhite.io/2021/05/24/inventing-the-service-trait/"/>
    <id>https://www.purewhite.io/2021/05/24/inventing-the-service-trait/</id>
    <published>2021-05-24T08:21:59.000Z</published>
    <updated>2021-12-02T12:51:07.227Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å†™åœ¨å‰é¢ï¼š</p><p>æœ€è¿‘çœ‹åˆ°äº†ä¸€ç¯‡è®² Rust å¦‚ä½•å¯¹æ¡†æ¶è¿›è¡ŒæŠ½è±¡çš„æ–‡ç« ï¼Œå†™å¾—éå¸¸å¥½ï¼Œè¿™ä¸¤å¤©æŠ½ç©ºç¿»è¯‘äº†ä¸€ä¸‹ã€‚</p><p>åŸæ–‡ï¼š<a href="https://tokio.rs/blog/2021-05-14-inventing-the-service-trait">https://tokio.rs/blog/2021-05-14-inventing-the-service-trait</a></p></blockquote><h1 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h1><p><a href="https://github.com/tower-rs/tower"><code>Tower</code></a>æ˜¯ä¸€ä¸ªæ¨¡å—åŒ–å’Œå¯é‡å¤ä½¿ç”¨çš„ç”¨æ¥æ„å»º client å’Œ server çš„ç»„ä»¶åº“ã€‚å…¶æ ¸å¿ƒæ˜¯<a href="https://docs.rs/tower/latest/tower/trait.Service.html"><code>Service</code></a>ç‰¹æ€§ã€‚ä¸€ä¸ª<code>Service</code>æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªè¯·æ±‚å¹¶äº§ç”Ÿä¸€ä¸ªå“åº”ã€‚ç„¶è€Œï¼Œ<code>Tower</code>è®¾è®¡çš„æŸäº›æ–¹é¢å¯èƒ½ä¸æ˜¯é‚£ä¹ˆä¸€ç›®äº†ç„¶ã€‚</p><p>ä¸å…¶è§£é‡Šä»Šå¤©å­˜åœ¨äº<code>Tower</code>ä¸­çš„<code>Service</code>ç‰¹æ€§ï¼Œä¸å¦‚æ¥çœ‹çœ‹<code>Service</code>èƒŒåçš„è®¾è®¡è€ƒé‡ã€‚è®©æˆ‘ä»¬è¯•è¯•çœ‹ï¼Œå¦‚æœä»Šå¤©é‡æ–°è®¾è®¡å®ç°å®ƒï¼Œæˆ‘ä»¬ä¼šæ€ä¹ˆåšã€‚</p><span id="more"></span><p>æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ­£åœ¨ç”¨ Rust æ„å»ºä¸€ä¸ªç®€å•çš„ HTTP æ¡†æ¶ã€‚è¿™ä¸ªæ¡†æ¶å°†å…è®¸ç”¨æˆ·æä¾›æ¥æ”¶è¯·æ±‚å¹¶è¿”å›å“åº”çš„å¤„ç†é€»è¾‘æ¥å®ç°ä¸€ä¸ª HTTP æœåŠ¡å™¨ã€‚ä½ å¯èƒ½ä¼šæœ‰è¿™ä¹ˆä¸€ä¸ª APIï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªåœ¨ 3000 ç«¯å£ç›‘å¬çš„æœåŠ¡å™¨</span></span><br><span class="line"><span class="keyword">let</span> server = Server::new(<span class="string">&quot;127.0.0.1:3000&quot;</span>).<span class="keyword">await</span>?</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»¥æŸç§æ–¹å¼è¿è¡Œç”¨æˆ·çš„åº”ç”¨ç¨‹åº</span></span><br><span class="line">server.run(the_users_application).<span class="keyword">await</span>?</span><br></pre></td></tr></table></figure><p>ç°åœ¨é—®é¢˜æ¥äº†ï¼Œ<code>the_users_application</code>åº”è¯¥æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>æœ€ç®€å•çš„ä¸€ä¸ªå®ç°ï¼Œå¯èƒ½æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">handle_request</span></span>(request: HttpRequest) -&gt; HttpResponse &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>HttpRequest</code>å’Œ<code>HttpResponse</code>æ˜¯ç”±æˆ‘ä»¬çš„æ¡†æ¶æä¾›çš„ä¸€äº›ç»“æ„ã€‚æœ‰äº†è¿™ä¸ªï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿™æ ·å®ç°<code>Server::run</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> Server &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">run</span></span>&lt;F&gt;(<span class="keyword">self</span>, handler: F) -&gt; <span class="built_in">Result</span>&lt;(), Error&gt;</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        F: <span class="built_in">Fn</span>(HttpRequest) -&gt; HttpResponse,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> listener = TcpListener::bind(<span class="keyword">self</span>.addr).<span class="keyword">await</span>?</span><br><span class="line"></span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> connection = listener.accept().<span class="keyword">await</span>?</span><br><span class="line">            <span class="keyword">let</span> request = read_http_request(&amp;<span class="keyword">mut</span> connection).<span class="keyword">await</span>?</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è°ƒç”¨ç”±ç”¨æˆ·æä¾›çš„å¤„ç†ç¨‹åº</span></span><br><span class="line">            <span class="keyword">let</span> response = handler(request);</span><br><span class="line"></span><br><span class="line">            write_http_response(connection).<span class="keyword">await</span>?</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå¼‚æ­¥å‡½æ•°<code>run</code>ï¼Œå®ƒæ¥å—ä¸€ä¸ªé—­åŒ…ï¼Œè¿™ä¸ªé—­åŒ…æ¥å—ä¸€ä¸ª<code>HttpRequest</code>å¹¶è¿”å›<code>HttpResponse</code>ã€‚ç”¨æˆ·å¯ä»¥åƒè¿™æ ·ä½¿ç”¨æˆ‘ä»¬çš„<code>server</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">handle_request</span></span>(request: HttpRequest) -&gt; HttpResponse &#123;</span><br><span class="line">    <span class="keyword">if</span> request.path() == <span class="string">&quot;/&quot;</span> &#123;</span><br><span class="line">        HttpResponse::ok(<span class="string">&quot;Hello, World!&quot;</span> )</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        HttpResponse::not_found()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿è¡ŒæœåŠ¡å™¨å¹¶ä½¿ç”¨æˆ‘ä»¬çš„ handle_request å‡½æ•°å¤„ç†è¯·æ±‚</span></span><br><span class="line">server.run(handle_request).<span class="keyword">await</span>?</span><br></pre></td></tr></table></figure><p>æ„Ÿè§‰è¿˜è¡Œï¼Œå®ƒè®©ç”¨æˆ·å¯ä»¥å¾ˆå®¹æ˜“åœ°è¿è¡Œ HTTP æœåŠ¡å™¨è€Œä¸å¿…æ‹…å¿ƒä»»ä½•ä½å±‚æ¬¡çš„ç»†èŠ‚ã€‚</p><p>ç„¶è€Œï¼Œæˆ‘ä»¬ç›®å‰çš„è®¾è®¡æœ‰ä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬æ— æ³•å¤„ç†å¼‚æ­¥åœ°å¤„ç†è¯·æ±‚ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬çš„ç”¨æˆ·éœ€è¦æŸ¥è¯¢ä¸€ä¸ªæ•°æ®åº“ï¼Œæˆ–è€…åœ¨å¤„ç†è¯·æ±‚çš„åŒæ—¶å‘é€ä¸€ä¸ªè¯·æ±‚ç»™å…¶ä»–æœåŠ¡å™¨ã€‚ç›®å‰ï¼Œè¿™æ ·ä¼šå¯¼è‡´æˆ‘ä»¬éœ€è¦åŒæ­¥ç­‰å¾… handler çš„è¿”å›ç»“æœï¼Œä»è€Œå¯¼è‡´äº†<a href="https://ryhl.io/blog/async-what-is-blocking/">é˜»å¡</a>ã€‚</p><p>å¦‚æœæˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„æœåŠ¡å™¨èƒ½å¤Ÿå¤„ç†å¤§é‡çš„å¹¶å‘è¿æ¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç­‰å¾…è¯¥è¯·æ±‚å¼‚æ­¥å®Œæˆçš„åŒæ—¶ä¸ºå…¶ä»–è¯·æ±‚æä¾›æœåŠ¡ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è®© handler è¿”å›ä¸€ä¸ª<a href="https://doc.rust-lang.org/stable/std/future/trait.Future.html"><code>future</code></a>æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> Server &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">run</span></span>&lt;F, Fut&gt;(<span class="keyword">self</span>, handler: F) -&gt; <span class="built_in">Result</span>&lt;(), Error&gt;</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        <span class="comment">// handler ç°åœ¨è¿”å›ä¸€ä¸ªé€šç”¨ç±»å‹çš„ Fut</span></span><br><span class="line">        F: <span class="built_in">Fn</span>(HttpRequest) -&gt; Fut,</span><br><span class="line">        <span class="comment">// FUT æ˜¯ä¸€ä¸ª Futureï¼Œå…¶è¾“å‡ºæ˜¯ä¸€ä¸ª HttpResponse</span></span><br><span class="line">        Fut: Future&lt;Output = HttpResponse&gt;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> listener = TcpListener::bind(<span class="keyword">self</span>.addr).<span class="keyword">await</span>?</span><br><span class="line"></span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> connection = listener.accept().<span class="keyword">await</span>?</span><br><span class="line">            <span class="keyword">let</span> request = read_http_request(&amp;<span class="keyword">mut</span> connection).<span class="keyword">await</span>?</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ç­‰å¾…ç”± handler è¿”å›çš„ Future</span></span><br><span class="line">            <span class="keyword">let</span> response = handler(request).<span class="keyword">await</span>?</span><br><span class="line"></span><br><span class="line">            write_http_response(connection).<span class="keyword">await</span>?</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>API çš„ç”¨æ³•å’Œä¹‹å‰å·®ä¸å¤šï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç°åœ¨æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">handle_request</span></span>(request: HttpRequest) -&gt; HttpResponse &#123;</span><br><span class="line">    <span class="keyword">if</span> request.path() == <span class="string">&quot;/&quot;</span> &#123;</span><br><span class="line">        HttpResponse::ok(<span class="string">&quot;Hello, World!&quot;</span> )</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> request.path() == <span class="string">&quot;/important-data&quot;</span> &#123;</span><br><span class="line">        <span class="comment">// æˆ‘ä»¬ç°åœ¨å¯ä»¥åœ¨è¿™é‡Œåšå¼‚æ­¥çš„äº‹æƒ…äº†</span></span><br><span class="line">        <span class="keyword">let</span> some_data = fetch_data_from_database().<span class="keyword">await</span>;</span><br><span class="line">        make_response(some_data)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        HttpResponse::not_found()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿è¡Œ server ä¹Ÿæ˜¯ä¸€æ ·çš„</span></span><br><span class="line">server.run(handle_request).<span class="keyword">await</span>?</span><br></pre></td></tr></table></figure><p>è¿™å°±æ¯”ä¹‹å‰è¦å¥½å¾ˆå¤šäº†ï¼Œå› ä¸ºæˆ‘ä»¬çš„ handler ç°åœ¨å¯ä»¥è°ƒç”¨å…¶ä»–å¼‚æ­¥å‡½æ•°å•¦ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬ä»ç„¶ç¼ºäº†ç‚¹å•¥â€”â€”å¦‚æœæˆ‘ä»¬çš„å¤„ç†ç¨‹åºå‡ºé”™äº†æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬å¯ä»¥è®© Handler è¿”å›ä¸€ä¸ª<code>Result</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> server &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">run</span></span>&lt;F, Fut&gt;(<span class="keyword">self</span>, handler: F) -&gt; <span class="built_in">Result</span>&lt;(), Error&gt;</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        F: <span class="built_in">Fn</span>(HttpRequest) -&gt; Fut,</span><br><span class="line">        <span class="comment">// å“åº”çš„ Future å…è®¸è¿”å› Error</span></span><br><span class="line">        Fut: Future&lt;Output = <span class="built_in">Result</span>&lt;HttpResponse, Error&gt;&gt;ã€‚</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> listener = TcpListener::bind(<span class="keyword">self</span>.addr).<span class="keyword">await</span>?</span><br><span class="line"></span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> connection = listener.accept().<span class="keyword">await</span>?</span><br><span class="line">            <span class="keyword">let</span> request = read_http_request(&amp;<span class="keyword">mut</span> connection).<span class="keyword">await</span>?</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¯¹å“åº”çš„ Future è¿›è¡Œæ¨¡å¼åŒ¹é…</span></span><br><span class="line">            <span class="keyword">match</span> handler(request).<span class="keyword">await</span> &#123;</span><br><span class="line">                <span class="literal">Ok</span>(response) =&gt; write_http_response(connection).<span class="keyword">await</span>?</span><br><span class="line">                <span class="literal">Err</span>(error) =&gt; handle_error_somehow(error, connection)ã€‚</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ·»åŠ æ›´å¤šçš„åŠŸèƒ½"><a href="#æ·»åŠ æ›´å¤šçš„åŠŸèƒ½" class="headerlink" title="æ·»åŠ æ›´å¤šçš„åŠŸèƒ½"></a>æ·»åŠ æ›´å¤šçš„åŠŸèƒ½</h1><p>ç°åœ¨ï¼Œå‡è®¾æˆ‘ä»¬æƒ³ç¡®ä¿æ‰€æœ‰çš„è¯·æ±‚éƒ½èƒ½åŠæ—¶å®Œæˆæˆ–å¤±è´¥ï¼Œè€Œä¸æ˜¯è®©å®¢æˆ·ç«¯æ— é™æœŸåœ°ç­‰å¾…ä¸€ä¸ªå¯èƒ½æ°¸è¿œä¸ä¼šæœ‰çš„å“åº”ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ç»™æ¯ä¸ªè¯·æ±‚æ·»åŠ ä¸€ä¸ªè¶…æ—¶æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚ä¸€ä¸ªè¶…æ—¶è®¾ç½®äº†<code>handler</code>å…è®¸æŒç»­çš„æœ€å¤§æ—¶é—´çš„é™åˆ¶ã€‚å¦‚æœå®ƒåœ¨è¿™ä¸ªæ—¶é—´å†…æ²¡æœ‰äº§ç”Ÿå“åº”ï¼Œå°±ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚è¿™ä½¿å¾—å®¢æˆ·ç«¯å¯ä»¥é‡è¯•è¯¥è¯·æ±‚æˆ–å‘ç”¨æˆ·æŠ¥å‘Šé”™è¯¯ï¼Œè€Œä¸æ˜¯æ°¸è¿œç­‰å¾…ã€‚</p><p>æœ€ç®€å•çš„æ–¹æ³•å¯èƒ½æ˜¯å»ä¿®æ”¹<code>Server</code>ï¼Œä½¿å…¶å¯ä»¥é…ç½®ä¸€ä¸ªè¶…æ—¶ï¼Œç„¶ååœ¨æ¯æ¬¡è°ƒç”¨<code>handler</code>æ—¶åº”ç”¨è¯¥è¶…æ—¶ã€‚ç„¶è€Œï¼Œå…¶å®ä½ ä¹Ÿå¯ä»¥åœ¨ä¸ä¿®æ”¹<code>Server</code>çš„æƒ…å†µä¸‹æ·»åŠ ä¸€ä¸ªè¶…æ—¶ã€‚ä½¿ç”¨<a href="https://docs.rs/tokio/latest/tokio/time/fn.timeout.html"><code>tokio::time::timeout</code></a>ï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªæ–°çš„å¤„ç†å‡½æ•°ï¼Œè®©å®ƒè°ƒç”¨æˆ‘ä»¬ä¹‹å‰çš„<code>handle_request</code>ï¼Œå¹¶ä¸”è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º 30 ç§’ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">handler_with_timeout</span></span>(request: HttpRequest) -&gt; <span class="built_in">Result</span>&lt;HttpResponse, Error&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> result = tokio::time::timeout(</span><br><span class="line">        Duration::from_secs(<span class="number">30</span>),</span><br><span class="line">        handle_request(request)</span><br><span class="line">    ).<span class="keyword">await</span>ã€‚</span><br><span class="line"></span><br><span class="line">    <span class="keyword">match</span> result &#123;</span><br><span class="line">        <span class="literal">Ok</span>(<span class="literal">Ok</span>(response)) =&gt; <span class="literal">Ok</span>(response)ã€‚</span><br><span class="line">        <span class="literal">Ok</span>(<span class="literal">Err</span>(error)) =&gt; <span class="literal">Err</span>(error),</span><br><span class="line">        <span class="literal">Err</span>(_timeout_elapsed) =&gt; <span class="literal">Err</span>(Error::timeout() )ã€‚</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æä¾›äº†ä¸€ä¸ªç›¸å½“å¥½çš„æŠ½è±¡ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ·»åŠ ä¸€ä¸ªè¶…æ—¶å™¨è€Œä¸æ”¹å˜ä»»ä½•ç°æœ‰çš„ä»£ç ã€‚</p><p>è®©æˆ‘ä»¬ç”¨è¿™ç§æ–¹å¼å†å¢åŠ ä¸€ä¸ªåŠŸèƒ½ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ­£åœ¨å†™ä¸€ä¸ª JSON APIï¼Œå¹¶ä¸”å¸Œæœ›åœ¨æ‰€æœ‰çš„å“åº”ä¸Šæœ‰ä¸€ä¸ª<code>Content-Type: application/json</code>çš„å¤´ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ç±»ä¼¼çš„æ–¹å¼åŒ…è£…<code>handler_with_timeout</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">handler_with_timeout_and_content_type</span></span>(</span><br><span class="line">    request: HttpRequest,</span><br><span class="line">) -&gt; <span class="built_in">Result</span>&lt;HttpResponse, Error&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> response = handler_with_timeout(request).<span class="keyword">await</span>?</span><br><span class="line">    response.set_header(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)ã€‚</span><br><span class="line">    <span class="literal">Ok</span>(response)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ç°åœ¨æœ‰äº†ä¸€ä¸ªå¤„ç†ç¨‹åºï¼Œå®ƒå°†å¤„ç†ä¸€ä¸ª HTTP è¯·æ±‚ï¼Œè¶…æ—¶ä¸º 30 ç§’ï¼Œå¹¶ä¸”ä¼šè®¾ç½®å¥½æ­£ç¡®çš„<code>Content-Type</code>å¤´ï¼Œæ‰€æœ‰è¿™äº›éƒ½ä¸éœ€è¦ä¿®æ”¹æˆ‘ä»¬åŸæ¥çš„<code>handle_request</code>å‡½æ•°æˆ–<code>Server</code>ç»“æ„ã€‚</p><p>è®¾è®¡å¯ä»¥ä»¥è¿™ç§æ–¹å¼æ‰©å±•çš„åº“æ˜¯éå¸¸å¼ºå¤§çš„ï¼Œå› ä¸ºå®ƒå…è®¸ç”¨æˆ·é€šè¿‡å¢åŠ ä¸€å±‚æ–°è¡Œä¸ºæ¥æ‰©å±•åº“çš„åŠŸèƒ½ï¼Œè€Œä¸éœ€è¦ç­‰å¾…åº“çš„ç»´æŠ¤è€…ä¸ºå…¶æ·»åŠ æ”¯æŒã€‚</p><p>å®ƒä¹Ÿä½¿æµ‹è¯•å˜å¾—æ›´å®¹æ˜“ï¼Œå› ä¸ºä½ å¯ä»¥æŠŠä½ çš„ä»£ç åˆ†è§£æˆå°çš„éš”ç¦»çš„å­¤ç«‹çš„å•å…ƒï¼Œå¹¶ä¸ºå®ƒä»¬ç¼–å†™ç»†ç²’åº¦çš„æµ‹è¯•ï¼Œè€Œä¸å¿…æ‹…å¿ƒå…¶ä»–çš„éƒ¨åˆ†ã€‚</p><p>ç„¶è€Œï¼Œåˆæœ‰äº†ä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬ç›®å‰çš„è®¾è®¡æ˜¯å¥—å¨ƒï¼Œä¹Ÿå°±æ˜¯å®ç°ä¸€ä¸ªå¤„ç†å‡½æ•°æ¥å®ç°åŠŸèƒ½ï¼Œå¹¶åœ¨å…¶å†…éƒ¨è°ƒç”¨å…¶ä»–å¤„ç†å‡½æ•°ã€‚è¿™èƒ½ workï¼Œä½†å¦‚æœæˆ‘ä»¬æƒ³å¢åŠ æ›´å¤šçš„é¢å¤–åŠŸèƒ½ï¼Œå®ƒå¹¶ä¸èƒ½å¾ˆå¥½åœ°æ‰©å±•ã€‚</p><p>æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬æœ‰è®¸å¤š<code>handle_with_*</code>å‡½æ•°ï¼Œæ¯ä¸€ä¸ªéƒ½å¢åŠ äº†ä¸€ç‚¹å„¿æ–°çš„è¡Œä¸ºã€‚è¦ç¡¬ç¼–ç è°è°ƒç”¨è°çš„è¿™ä¸ªè°ƒç”¨é“¾å°†æˆä¸ºä¸€ç§æŒ‘æˆ˜ã€‚æˆ‘ä»¬ç›®å‰çš„è°ƒç”¨é“¾æ˜¯ï¼š</p><ol><li><code>handler_with_timeout_and_content_type</code>ï¼Œè°ƒç”¨</li><li><code>handler_with_timeout</code>ï¼Œè°ƒç”¨</li><li><code>handle_request</code>ï¼Œå®é™…å¤„ç†è¯·æ±‚ã€‚</li></ol><p>å¦‚æœæˆ‘ä»¬èƒ½ä»¥æŸç§æ–¹å¼<a href="https://en.wikipedia.org/wiki/Function_composition">ç»„åˆ</a>è¿™ä¸‰ä¸ªå‡½æ•°è€Œä¸éœ€è¦ç¡¬ç¼–ç ç¡®åˆ‡çš„é¡ºåºï¼Œé‚£å°±æ›´å¥½äº†ï¼Œå°±åƒè¿™æ ·ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> final_handler = with_content_type(with_timeout(handle_request));</span><br></pre></td></tr></table></figure><p>åŒæ—¶ä»ç„¶èƒ½å¤Ÿåƒä»¥å‰ä¸€æ ·è¿è¡Œæˆ‘ä»¬çš„å¤„ç†ç¨‹åºã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server.run(final_handler).<span class="keyword">await</span>?</span><br></pre></td></tr></table></figure><p>ä½ å¯ä»¥æŠŠ<code>with_content_type</code>å’Œ<code>with_timeout</code>ä½œä¸ºå‡½æ•°æ¥å®ç°ï¼Œè¯¥å‡½æ•°æ¥å—ä¸€ä¸ª<code>F: Fn(HttpRequest) -&gt; Future&lt;Output = Result&lt;HttpResponse, Error&gt;</code>çš„å‚æ•°å¹¶è¿”å›ä¸€ä¸ª<code>impl Fn(HttpRequest) -&gt; Future&lt;Output = Result&lt;HttpResponse, Error&gt;&gt;</code>çš„é—­åŒ…ã€‚è¿™ä¹Ÿä¸æ˜¯ä¸è¡Œï¼Œä½†æ‰€æœ‰è¿™äº›é—­åŒ…ç±»å‹ä¼šå¾ˆå¿«å˜å¾—éš¾ä»¥å¤„ç†ã€‚</p><h1 id="Handlertrait"><a href="#Handlertrait" class="headerlink" title="Handlertrait"></a><code>Handler</code>trait</h1><p>è®©æˆ‘ä»¬æ¥å°è¯•å¦ä¸€ç§æ–¹æ³•ã€‚ä¸å…¶è®©<code>Server::run</code>æ¥å—äº†ä¸€ä¸ªé—­åŒ…(<code>Fn(HttpRequest) -&gt; â€¦</code>)ï¼Œä¸å¦‚è®©æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ–°çš„ trait æ¥å°è£…<code>async fn(HttpRequest) -&gt; Result&lt;HttpResponse, Error&gt;</code>:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Handler</span></span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">call</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, request: HttpRequest) -&gt; <span class="built_in">Result</span>&lt;HttpResponse, Error&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰äº†è¿™æ ·ä¸€ä¸ª traitï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¼–å†™å®ç°å®ƒçš„å…·ä½“ç±»å‹ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸å¿…åˆ°å¤„ç”¨<code>Fn</code>äº†ã€‚</p><p>ç„¶è€Œï¼ŒRust ç›®å‰ä¸æ”¯æŒ async trait æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š</p><ol><li>è®©<code>call</code>è¿”å›ä¸€ä¸ª Boxed Futureï¼Œå¦‚<code>Pin&lt;Box&lt;dyn Future&lt;Output = Result&lt;HttpResponse, Error&gt;&gt;</code>ã€‚è¿™ä¹Ÿå°±æ˜¯<a href="https://crates.io/crates/async-trait"><code>async-trait</code></a>å¹²çš„äº‹ã€‚</li><li>åœ¨<code>Handler</code>ä¸­æ·»åŠ ä¸€ä¸ªå…³è”çš„<code>type Future</code>ï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥æŒ‡å®šè‡ªå·±çš„ç±»å‹ã€‚</li></ol><p>æˆ‘ä»¬é‡‡ç”¨æ–¹æ¡ˆäºŒï¼Œå› ä¸ºå®ƒæ˜¯æœ€çµæ´»çš„ã€‚æœ‰ä¸€ä¸ªå…·ä½“çš„ Future ç±»å‹çš„ç”¨æˆ·å¯ä»¥é¿å…<code>Box</code>çš„å¼€é”€ï¼Œè€Œä¸åœ¨ä¹çš„ç”¨æˆ·ä¹Ÿå¯ä»¥ä½¿ç”¨<code>Pin&lt;Box&lt;...&gt;&gt;</code>ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">handler</span></span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Future</span></span>: Future&lt;Output = <span class="built_in">Result</span>&lt;HttpResponse, Error&gt;&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">call</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, request: HttpRequest) -&gt; Self::Future;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä»ç„¶è¦æ±‚<code>Handler::Future</code>å®ç°è¾“å‡ºä¸º<code>Result&lt;HttpResponse, Error&gt;</code>çš„<code>Future</code>ï¼Œå› ä¸ºé‚£æ˜¯<code>Server::run</code>çš„è¦æ±‚ã€‚</p><p>è®©<code>call</code>æ¥å—<code>&amp;mut self</code>æ˜¯æœ‰ç”¨çš„ï¼Œå› ä¸ºå®ƒå…è®¸å¤„ç†ç¨‹åºåœ¨å¿…è¦æ—¶æ›´æ–°ä»–ä»¬çš„å†…éƒ¨çŠ¶æ€<sup><a href="#pin">1</a></sup>ã€‚</p><p>è®©æˆ‘ä»¬æŠŠåŸæ¥çš„<code>handle_request</code>å‡½æ•°è½¬æ¢ä¸ºä½¿ç”¨è¿™ä¸ªç‰¹æ€§çš„å®ç°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RequestHandler</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Handler <span class="keyword">for</span> RequestHandler &#123;</span><br><span class="line">    <span class="comment">// ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨ Pin&lt;Box&lt;...&gt;&gt;ï¼Œä½†ä¹Ÿå¯ä»¥å®šä¹‰æˆ‘ä»¬çš„</span></span><br><span class="line">    <span class="comment">// è‡ªå·±çš„ Future ç±»å‹ï¼Œä»¥é¿å…å¼€é”€ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Future</span></span> = Pin&lt;<span class="built_in">Box</span>&lt;<span class="keyword">dyn</span> Future&lt;Output = <span class="built_in">Result</span>&lt;HttpResponse, Error&gt;&gt;&gt;&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">call</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, request: HttpRequest) -&gt; Self::Future &#123;</span><br><span class="line">        <span class="built_in">Box</span>::pin(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">            <span class="comment">// ä¸æˆ‘ä»¬ä¹‹å‰çš„å®ç°ç›¸åŒ</span></span><br><span class="line">            <span class="keyword">if</span> request.path() == <span class="string">&quot;/&quot;</span> &#123;</span><br><span class="line">                <span class="literal">Ok</span>(HttpResponse::ok(<span class="string">&quot;Hello, World!&quot;</span>))</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> request.path() == <span class="string">&quot;/important-data&quot;</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> some_data = fetch_data_from_database().<span class="keyword">await</span>?;</span><br><span class="line">                <span class="literal">Ok</span>(make_response(some_data))</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="literal">Ok</span>(HttpResponse::not_found())</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£æˆ‘ä»¬å¦‚ä½•åŸºäºè¿™ä¸ªå®ç°è¶…æ—¶å‘¢ï¼Ÿè¯·è®°ä½ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯å…è®¸æˆ‘ä»¬åœ¨ä¸ä¿®æ”¹æ¯ä¸ªå•ç‹¬éƒ¨åˆ†çš„æƒ…å†µä¸‹ï¼Œå°†ä¸åŒçš„åŠŸèƒ½ç»„åˆåœ¨ä¸€èµ·ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªé€šç”¨çš„<code>Timeout</code>ç»“æ„ï¼Œå°±åƒè¿™æ ·ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Timeout</span></span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// T å®ç°äº†`Handler&#x27;çš„ç±»å‹</span></span><br><span class="line">    inner_handler: T,</span><br><span class="line">    duration: Duration,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å¯ä»¥ä¸º<code>Timeout&lt;T&gt;</code>å®ç°<code>Handler</code>å¹¶å§”æ‰˜ç»™<code>T</code>çš„<code>Handler</code>å®ç°ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Handler <span class="keyword">for</span> Timeout&lt;T&gt;</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    T: Handler,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Future</span></span> = Pin&lt;<span class="built_in">Box</span>&lt;<span class="keyword">dyn</span> Future&lt;Output = <span class="built_in">Result</span>&lt;HttpResponse, Error&gt;&gt;&gt;&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">call</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, request: HttpRequest) -&gt; Self::Future &#123;</span><br><span class="line">        <span class="built_in">Box</span>::pin(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> result = tokio::time::timeout(</span><br><span class="line">                <span class="keyword">self</span>.duration,</span><br><span class="line">                <span class="keyword">self</span>.inner_handler.call(request),</span><br><span class="line">            ).<span class="keyword">await</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">match</span> result &#123;</span><br><span class="line">                <span class="literal">Ok</span>(<span class="literal">Ok</span>(response)) =&gt; <span class="literal">Ok</span>(response),</span><br><span class="line">                <span class="literal">Ok</span>(<span class="literal">Err</span>(error)) =&gt; <span class="literal">Err</span>(error),</span><br><span class="line">                <span class="literal">Err</span>(_timeout) =&gt; <span class="literal">Err</span>(Error::timeout()),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé‡è¦çš„ä¸€è¡Œæ˜¯<code>self.inner_handler.call(request)</code>ï¼Œåœ¨è¿™æˆ‘ä»¬ç»§ç»­è°ƒç”¨å†…éƒ¨å¤„ç†ç¨‹åºï¼Œè®©å®ƒåšè‡ªå·±çš„äº‹æƒ…è€Œä¸ç®¡å…³å®ƒæ˜¯ä»€ä¹ˆã€‚æˆ‘ä»¬åªéœ€è¦çŸ¥é“å®ƒå®Œæˆåä¼šè¿”å›ä¸€ä¸ª<code>Result&lt;HttpResponse, Error&gt;</code>ã€‚</p><p>ä½†æ˜¯ï¼Œè¿™æ®µä»£ç ç¼–è¯‘ä¸è¿‡ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">error[E0759]: `<span class="keyword">self</span>` has an anonymous lifetime `<span class="symbol">&#x27;_</span>` but it needs to satisfy a `<span class="symbol">&#x27;static</span>` lifetime requirement</span><br><span class="line">   --&gt; src/lib.rs:<span class="number">145</span>:<span class="number">29</span></span><br><span class="line">    |</span><br><span class="line"><span class="number">144</span> |       <span class="function"><span class="keyword">fn</span> <span class="title">call</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, request: HttpRequest) -&gt; Self::Future &#123;</span><br><span class="line">    |               --------- this data with an anonymous lifetime `<span class="symbol">&#x27;_</span>`...</span><br><span class="line"><span class="number">145</span> |           <span class="built_in">Box</span>::pin(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">    |  _____________________________^</span><br><span class="line"><span class="number">146</span> | |             <span class="keyword">let</span> result = tokio::time::timeout(</span><br><span class="line"><span class="number">147</span> | |                 <span class="keyword">self</span>.duration,</span><br><span class="line"><span class="number">148</span> | |                 <span class="keyword">self</span>.inner_handler.call(request),</span><br><span class="line">...   |</span><br><span class="line"><span class="number">155</span> | |             &#125;</span><br><span class="line"><span class="number">156</span> | |         &#125;)</span><br><span class="line">    | |_________^ ...is captured here, requiring it to live <span class="keyword">as</span> long <span class="keyword">as</span> `<span class="symbol">&#x27;static</span>`</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å‡ºé”™çš„åŸå› æ˜¯ï¼Œæˆ‘ä»¬æ­£åœ¨æ•è·ä¸€ä¸ª<code>&amp;mut self</code>å¹¶å°†å…¶ç§»åˆ°ä¸€ä¸ªå¼‚æ­¥çš„ä»£ç å—ä¸­ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬çš„ Future å’Œ<code>&amp;mut self</code>çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ç›¸åŒçš„ã€‚ä½†æ˜¯è¿™å¹¶ä¸ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½æƒ³åœ¨å¤šä¸ªçº¿ç¨‹ä¸Šè¿è¡Œæˆ‘ä»¬çš„ Future ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œæˆ–è€…äº§ç”Ÿå¤šä¸ª Future å¹¶å°†å®ƒä»¬å…¨éƒ¨å¹¶è¡Œè¿è¡Œã€‚å¦‚æœå¯¹ handler çš„å¼•ç”¨å­˜åœ¨äº Future<sup><a href="#gats">2</a></sup> ä¸­ï¼Œè¿™å°±ä¸å¯èƒ½äº†ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å°†<code>&amp;mut self</code>è½¬æ¢ä¸ºä¸€ä¸ªæœ‰æ‰€æœ‰æƒçš„<code>self</code>ã€‚è¿™æ­£æ˜¯<code>Clone</code>æ‰€åšçš„ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™å¿…é¡»æ˜¯ Cloneï¼Œæ‰èƒ½ä½¿ Timeout&lt;T&gt; æˆä¸º Clone</span></span><br><span class="line"><span class="meta">#[derive(Clone)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RequestHandler</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Handler <span class="keyword">for</span> RequestHandler &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Clone)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Timeout</span></span>&lt;T&gt; &#123;</span><br><span class="line">    inner_handler: T,</span><br><span class="line">    duration: Duration,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Handler <span class="keyword">for</span> Timeout&lt;T&gt;</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    T: Handler + <span class="built_in">Clone</span>,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Future</span></span> = Pin&lt;<span class="built_in">Box</span>&lt;<span class="keyword">dyn</span> Future&lt;Output = <span class="built_in">Result</span>&lt;HttpResponse, Error&gt;&gt;&gt;&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">call</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, request: HttpRequest) -&gt; Self::Future &#123;</span><br><span class="line">        <span class="comment">// è·å¾—`&amp;mut self`çš„æ‰€æœ‰æƒ</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> this = <span class="keyword">self</span>.clone();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Box</span>::pin(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> result = tokio::time::timeout(</span><br><span class="line">                this.duration,</span><br><span class="line">                this.inner_handler.call(request),</span><br><span class="line">            ).<span class="keyword">await</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">match</span> result &#123;</span><br><span class="line">                <span class="literal">Ok</span>(<span class="literal">Ok</span>(response)) =&gt; <span class="literal">Ok</span>(response),</span><br><span class="line">                <span class="literal">Ok</span>(<span class="literal">Err</span>(error)) =&gt; <span class="literal">Err</span>(error),</span><br><span class="line">                <span class="literal">Err</span>(_timeout) =&gt; <span class="literal">Err</span>(Error::timeout()),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯·æ³¨æ„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œclone æ˜¯éå¸¸ä¾¿å®œçš„ï¼Œå› ä¸º<code>RequestHandler</code>æ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œ<code>Timeout&lt;T&gt;</code>åªå¢åŠ äº†ä¸€ä¸ª<code>Duration</code>ï¼ˆä¹Ÿå°±æ˜¯å®é™…ä¸Šæ˜¯<code>Copy</code>ï¼‰ã€‚</p><p>å¥½ï¼Œæˆ‘ä»¬ç°åœ¨æ›´è¿›ä¸€æ­¥äº†ï¼Œç°åœ¨æˆ‘ä»¬å¾—åˆ°äº†å¦ä¸€ä¸ªé”™è¯¯ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">error[E0310]: the parameter <span class="class"><span class="keyword">type</span> `<span class="title">T</span></span>` may not live long enough</span><br><span class="line">   --&gt; src/lib.rs:<span class="number">149</span>:<span class="number">9</span></span><br><span class="line">    |</span><br><span class="line"><span class="number">140</span> |   <span class="keyword">impl</span>&lt;T&gt; Handler <span class="keyword">for</span> Timeout&lt;T&gt;</span><br><span class="line">    |        - help: consider adding an explicit lifetime bound...: `T: <span class="symbol">&#x27;static</span>`</span><br><span class="line">...</span><br><span class="line"><span class="number">149</span> | /         <span class="built_in">Box</span>::pin(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line"><span class="number">150</span> | |             <span class="keyword">let</span> result = tokio::time::timeout(</span><br><span class="line"><span class="number">151</span> | |                 this.duration,</span><br><span class="line"><span class="number">152</span> | |                 this.inner_handler.call(request),</span><br><span class="line">...   |</span><br><span class="line"><span class="number">159</span> | |             &#125;</span><br><span class="line"><span class="number">160</span> | |         &#125;)</span><br><span class="line">    | |__________^ ...so that the <span class="class"><span class="keyword">type</span> `<span class="title">impl</span></span> Future` will meet its required lifetime bounds</span><br></pre></td></tr></table></figure><p>ç°åœ¨çš„é—®é¢˜æ˜¯ï¼Œå› ä¸º<code>T</code>å¯ä»¥æ˜¯ä»»ä½•ç±»å‹ã€‚å®ƒç”šè‡³å¯ä»¥æ˜¯ä¸€ä¸ªåŒ…å«å¼•ç”¨çš„ç±»å‹ï¼Œæ¯”å¦‚<code>Vec&lt;&amp;&#39;a str&gt;</code>ã€‚ç„¶è€Œè¿™å°±æ‹‰èƒ¯äº†ï¼ŒåŸå› å’Œä¹‹å‰ä¸€æ ·ã€‚æˆ‘ä»¬éœ€è¦è¿”å›çš„ Future æœ‰ä¸€ä¸ª<code>&#39;static</code>çš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥æ›´å®¹æ˜“åœ°ä¼ é€’å®ƒã€‚</p><p>ç¼–è¯‘å™¨å®é™…ä¸Šå·²ç»å‘Šè¯‰äº†æˆ‘ä»¬è¯¥å¦‚ä½•è§£å†³â€”â€”åŠ ä¸ª<code>T: &#39;static&#39;</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Handler <span class="keyword">for</span> Timeout&lt;T&gt;</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    T: Handler + <span class="built_in">Clone</span> + <span class="symbol">&#x27;static</span>,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›çš„ Future ç°åœ¨æ»¡è¶³äº†<code>&#39;static&#39;</code>å¯¿å‘½çš„è¦æ±‚ï¼Œå› ä¸ºå®ƒä¸åŒ…å«å¼•ç”¨ï¼ˆå¹¶ä¸”ä»»ä½•<code>T</code>åŒ…å«çš„å¼•ç”¨éƒ½æ˜¯<code>&#39;static&#39;</code>çš„ï¼‰ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬çš„ä»£ç å¯ä»¥ç¼–è¯‘äº†ï¼</p><p>è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç±»ä¼¼çš„ handler åœ¨å“åº”ä¸­æ·»åŠ <code>Content-Type</code>å¤´ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Clone)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">JsonContentType</span></span>&lt;T&gt; &#123;</span><br><span class="line">    inner_handler: T,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Handler <span class="keyword">for</span> JsonContentType&lt;T&gt;</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    T: Handler + <span class="built_in">Clone</span> + <span class="symbol">&#x27;static</span>,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Future</span></span> = Pin&lt;<span class="built_in">Box</span>&lt;<span class="keyword">dyn</span> Future&lt;Output = <span class="built_in">Result</span>&lt;HttpResponse, Error&gt;&gt;&gt;&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">call</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, request: HttpRequest) -&gt; Self::Future &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> this = <span class="keyword">self</span>.clone();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Box</span>::pin(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> response = this.inner_handler.call(request).<span class="keyword">await</span>?;</span><br><span class="line">            response.set_header(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">            <span class="literal">Ok</span>(response)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸<code>Timeout</code>çš„æ¨¡å¼éå¸¸ç›¸ä¼¼ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¿®æ”¹<code>Server::run</code>ä»¥æ¥å—æˆ‘ä»¬æ–°çš„<code>Handler Trait</code>ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> Server &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">run</span></span>&lt;T&gt;(<span class="keyword">self</span>, <span class="keyword">mut</span> handler: T) -&gt; <span class="built_in">Result</span>&lt;(), Error&gt;</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        T: Handler,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> listener = TcpListener::bind(<span class="keyword">self</span>.addr).<span class="keyword">await</span>?;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> connection = listener.accept().<span class="keyword">await</span>?;</span><br><span class="line">            <span class="keyword">let</span> request = read_http_request(&amp;<span class="keyword">mut</span> connection).<span class="keyword">await</span>?;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// have to call `Handler::call` here</span></span><br><span class="line">            <span class="keyword">match</span> handler.call(request).<span class="keyword">await</span> &#123;</span><br><span class="line">                <span class="literal">Ok</span>(response) =&gt; write_http_response(connection, response).<span class="keyword">await</span>?,</span><br><span class="line">                <span class="literal">Err</span>(error) =&gt; handle_error_somehow(error, connection),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ç°åœ¨å¯ä»¥å°†æˆ‘ä»¬çš„ä¸‰ä¸ª handler ç»„åˆåœ¨ä¸€èµ·ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JsonContentType &#123;</span><br><span class="line">    inner_handler: Timeout &#123;</span><br><span class="line">        inner_handler: RequestHandler,</span><br><span class="line">        duration: Duration::from_secs(<span class="number">30</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬ç»™æˆ‘ä»¬çš„ç±»å‹æ·»åŠ ä¸€äº›<code>new</code>æ–¹æ³•ï¼Œé‚£å°±æ›´å®¹æ˜“æ„å»ºå•¦ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> handler = RequestHandler;</span><br><span class="line"><span class="keyword">let</span> handler = Timeout::new(handler, Duration::from_secs(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">let</span> handler = JsonContentType::new(handler);</span><br><span class="line"></span><br><span class="line"><span class="comment">// `handler` has type `JsonContentType&lt;Timeout&lt;RequestHandler&gt;&gt;`</span></span><br><span class="line"></span><br><span class="line">server.run(handler).<span class="keyword">await</span></span><br></pre></td></tr></table></figure><p>æå®šï¼æˆ‘ä»¬ç°åœ¨å¯ä»¥ä¸º<code>RequestHandler</code>å¢åŠ é¢å¤–çš„åŠŸèƒ½è€Œä¸å¿…ä¿®æ”¹å®ƒçš„å®ç°ã€‚ç†è®ºä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæˆ‘ä»¬çš„<code>JsonContentType</code>å’Œ<code>Timeout</code> handler æ”¾åˆ°ä¸€ä¸ª<code>crate</code>ä¸­ï¼Œç„¶ååœ¨<code>crates.io</code>ä¸ŠæŠŠå®ƒä½œä¸ºä¸€ä¸ªåº“å‘å¸ƒä¾›å…¶ä»–ç”¨æˆ·ä½¿ç”¨ï¼</p><h1 id="è®©Handleræ›´åŠ çµæ´»"><a href="#è®©Handleræ›´åŠ çµæ´»" class="headerlink" title="è®©Handleræ›´åŠ çµæ´»"></a>è®©<code>Handler</code>æ›´åŠ çµæ´»</h1><p>æˆ‘ä»¬çš„<code>Handler trait</code>çœ‹ç€è¿˜ä¸é”™ï¼Œä½†ç›®å‰å®ƒåªæ”¯æŒæˆ‘ä»¬çš„<code>HttpRequest</code>å’Œ<code>HttpResponse</code>ç±»å‹ã€‚å¦‚æœè¿™äº›å˜æˆäº†æ³›å‹ï¼Œç”¨æˆ·å°±å¯ä»¥ä½¿ç”¨ä»–ä»¬æƒ³è¦çš„ä»»ä½•ç±»å‹ã€‚</p><p>æˆ‘ä»¬å°† Request ä½œä¸º Trait çš„æ³›å‹å‚æ•°ï¼Œè¿™æ ·æœåŠ¡å°±å¯ä»¥æ¥å—è®¸å¤šä¸åŒç±»å‹çš„è¯·æ±‚ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬çš„ handler å°±å¯ä»¥ç”¨äºä¸åŒçš„åè®®ï¼Œè€Œä¸ä»…ä»…æ˜¯ HTTP äº†ã€‚æˆ‘ä»¬å®šä¹‰ Response ä¸ºä¸€ä¸ªå…³è”ç±»å‹ï¼Œå› ä¸ºå¯¹äºä»»æ„ç»™å®šçš„è¯·æ±‚ç±»å‹ï¼Œåªèƒ½æœ‰ä¸”åªæœ‰ä¸€ç§ï¼ˆç›¸å…³çš„ï¼‰å“åº”ç±»å‹ï¼šå¯¹åº”çš„è°ƒç”¨è¿”å›çš„ç±»å‹ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Handler</span></span>&lt;Request&gt; &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Response</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é”™è¯¯ä¹Ÿåº”è¯¥æ˜¯ä¸€ä¸ªå…³è”ç±»å‹ã€‚æ²¡æœ‰ç†ç”±è®©å®ƒæˆä¸ºä¸€ä¸ª</span></span><br><span class="line">    <span class="comment">// ç¡¬ç¼–ç çš„ç±»å‹</span></span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Error</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¹‹å‰çš„ Future ç±»å‹ï¼Œä½†ç°åœ¨å®ƒçš„è¾“å‡ºå¿…é¡»ä½¿ç”¨</span></span><br><span class="line">    <span class="comment">// ç›¸å…³çš„ Response å’Œ Error ç±»å‹ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Future</span></span>: Future&lt;Output = <span class="built_in">Result</span>&lt;Self::Response, Self::Error&gt;&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  call æ²¡æœ‰å˜åŒ–ï¼Œä½†æ³¨æ„è¿™é‡Œçš„ Request æ˜¯ä¸ªæ³›å‹ï¼Œ</span></span><br><span class="line">    <span class="comment">//  è€Œä¸æ˜¯æˆ‘ä»¬ä¹‹å‰æ‰€ä½¿ç”¨çš„ HttpRequest ç±»å‹ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">call</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, request: Request) -&gt; Self::Future;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯¹<code>RequestHandler</code>çš„å®ç°ç°åœ¨å˜æˆäº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> Handler&lt;HttpRequest&gt; <span class="keyword">for</span> RequestHandler &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Response</span></span> = HttpResponse;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Error</span></span> = Error;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Future</span></span> = Pin&lt;<span class="built_in">Box</span>&lt;<span class="keyword">dyn</span> Future&lt;Output = <span class="built_in">Result</span>&lt;HttpResponse, Error&gt;&gt;&gt;&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">call</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, request: Request) -&gt; Self::Future &#123;</span><br><span class="line">        <span class="comment">// å’Œä¹‹å‰ä¸€æ ·</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Timeout&lt;T&gt;</code>åˆ™æœ‰ç‚¹ä¸åŒï¼Œå› ä¸ºå®ƒåŒ…è£…äº†ä¸€äº›å…¶ä»–çš„<code>Handler</code>ï¼Œå¹¶æ·»åŠ äº†ä¸€ä¸ªå¼‚æ­¥è¶…æ—¶ï¼Œå®ƒå®é™…ä¸Šå¹¶ä¸å…³å¿ƒè¯·æ±‚æˆ–å“åº”ç±»å‹æ˜¯ä»€ä¹ˆï¼Œåªè¦å®ƒæ‰€åŒ…è£…çš„<code>Handler</code>ä½¿ç”¨ç›¸åŒçš„ç±»å‹ã€‚</p><p>è€Œ<code>Error</code>ç±»å‹åˆ™æœ‰ç‚¹ä¸åŒã€‚å› ä¸º<code>tokio::time::timeout</code>ä¼šè¿”å›<code>Result&lt;T, tokio::time::error::Elapsed&gt;</code>ï¼Œæˆ‘ä»¬å¿…é¡»èƒ½å¤ŸæŠŠ<code>tokio::time::error::Elapsed</code>è½¬æ¢æˆå†…éƒ¨<code>Handler</code>çš„é”™è¯¯ç±»å‹ã€‚</p><p>å¦‚æœæˆ‘ä»¬æŠŠæ‰€æœ‰è¿™äº›ä¸œè¥¿ç»„åˆåœ¨ä¸€èµ·ï¼Œæˆ‘ä»¬å°±èƒ½è·å¾—ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// `Timeout`æ¥å—ä»»ä½•ç±»å‹çš„`R`çš„è¯·æ±‚ï¼Œåªè¦å’Œ`T`æ¥å—ç›¸åŒç±»å‹çš„è¯·æ±‚</span></span><br><span class="line"><span class="keyword">impl</span>&lt;R, T&gt; Handler&lt;R&gt; <span class="keyword">for</span> Timeout&lt;T&gt;</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    <span class="comment">// å®é™…çš„è¯·æ±‚ç±»å‹å¿…é¡»ä¸åŒ…å«</span></span><br><span class="line">    <span class="comment">// å¼•ç”¨ã€‚ç¼–è¯‘å™¨ä¼šå‘Šè¯‰æˆ‘ä»¬è¦æ·»åŠ </span></span><br><span class="line">    <span class="comment">// è¿™ä¸ªï¼Œå¦‚æœæˆ‘ä»¬ä¸è¿™æ ·åšçš„è¯</span></span><br><span class="line">    R: <span class="symbol">&#x27;static</span>,</span><br><span class="line">    <span class="comment">// `T`å¿…é¡»æ¥å—`R`ç±»å‹çš„è¯·æ±‚</span></span><br><span class="line">    T: Handler&lt;R&gt; + <span class="built_in">Clone</span> + <span class="symbol">&#x27;static</span>,</span><br><span class="line">    <span class="comment">// æˆ‘ä»¬å¿…é¡»èƒ½å¤Ÿå°†ä¸€ä¸ªè¶…æ—¶çš„è¯·æ±‚è½¬æ¢ä¸º</span></span><br><span class="line">    <span class="comment">// `T`çš„é”™è¯¯ç±»å‹</span></span><br><span class="line">    T::Error: <span class="built_in">From</span>&lt;tokio::time::error::Elapsed&gt;,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// æˆ‘ä»¬çš„å“åº”ç±»å‹ä¸`T`ç›¸åŒï¼Œå› æ­¤æˆ‘ä»¬</span></span><br><span class="line">    <span class="comment">// ä¸éœ€è¦ä¿®æ”¹å®ƒ</span></span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Response</span></span> = T::Response;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é”™è¯¯ç±»å‹ä¹Ÿæ˜¯ä¸€æ ·çš„</span></span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Error</span></span> = T::Error;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Future å¿…é¡»è¾“å‡ºä¸€ä¸ªå…·æœ‰æ­£ç¡®ç±»å‹çš„`Result`ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Future</span></span> = Pin&lt;<span class="built_in">Box</span>&lt;<span class="keyword">dyn</span> Future&lt;Output = <span class="built_in">Result</span>&lt;T::Response, T::Error&gt;&gt;&gt;&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">call</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, request: R) -&gt; Self::Future &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> this = <span class="keyword">self</span>.clone();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Box</span>::pin(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> result = tokio::time::timeout(</span><br><span class="line">                this.duration,</span><br><span class="line">                this.inner_handler.call(request),</span><br><span class="line">            ).<span class="keyword">await</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">match</span> result &#123;</span><br><span class="line">                <span class="literal">Ok</span>(<span class="literal">Ok</span>(response)) =&gt; <span class="literal">Ok</span>(response),</span><br><span class="line">                <span class="literal">Ok</span>(<span class="literal">Err</span>(error)) =&gt; <span class="literal">Err</span>(error),</span><br><span class="line">                <span class="literal">Err</span>(elapsed) =&gt; &#123;</span><br><span class="line">                    <span class="comment">// è½¬æ¢é”™è¯¯ç±»å‹</span></span><br><span class="line">                    <span class="literal">Err</span>(T::Error::from(elapsed))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>JsonContentType</code>ä¹Ÿæœ‰ç‚¹ä¸åŒã€‚å®ƒä¸å…³å¿ƒè¯·æ±‚æˆ–é”™è¯¯ç±»å‹ï¼Œä½†å®ƒå…³å¿ƒå“åº”ç±»å‹ã€‚å®ƒå¿…é¡»æ˜¯<code>Response</code>ï¼Œè¿™æ ·æˆ‘ä»¬æ‰èƒ½è°ƒç”¨<code>set_header</code>ã€‚</p><p>å› æ­¤ï¼Œå®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿˜æ˜¯ä¸€ä¸ªé€šç”¨çš„è¯·æ±‚ç±»å‹</span></span><br><span class="line"><span class="keyword">impl</span>&lt;R, T&gt; Handler&lt;R&gt; <span class="keyword">for</span> JsonContentType&lt;T&gt;</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    R: <span class="symbol">&#x27;static</span>,</span><br><span class="line">    <span class="comment">// `T`å¿…é¡»æ¥å—ä»»ä½•ç±»å‹çš„`R`çš„è¯·æ±‚ï¼Œå¹¶è¿”å›`HttpResponse`ç±»å‹çš„å“åº”ã€‚</span></span><br><span class="line">    T: Handler&lt;R, Response = HttpResponse&gt; + <span class="built_in">Clone</span> + <span class="symbol">&#x27;static</span>,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Response</span></span> = HttpResponse;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æˆ‘ä»¬çš„é”™è¯¯ç±»å‹å’Œ`T`ä¸€è‡´</span></span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Error</span></span> = T::Error;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Future</span></span> = Pin&lt;<span class="built_in">Box</span>&lt;<span class="keyword">dyn</span> Future&lt;Output = <span class="built_in">Result</span>&lt;Response, T::Error&gt;&gt;&gt;&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">call</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, request: R) -&gt; Self::Future &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> this = <span class="keyword">self</span>.clone();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Box</span>::pin(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> response = this.inner_handler.call(request).<span class="keyword">await</span>?;</span><br><span class="line">            response.set_header(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">            <span class="literal">Ok</span>(response)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œä¼ é€’ç»™<code>Server::run</code>çš„<code>Handler</code>å¿…é¡»ä½¿ç”¨<code>HttpRequest</code>å’Œ<code>HttpResponse</code>ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> Server &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">run</span></span>&lt;T&gt;(<span class="keyword">self</span>, <span class="keyword">mut</span> handler: T) -&gt; <span class="built_in">Result</span>&lt;(), Error&gt;</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        T: Handler&lt;HttpRequest, Response = HttpResponse&gt;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»º server çš„ä»£ç ä¸éœ€è¦å˜ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> handler = RequestHandler;</span><br><span class="line"><span class="keyword">let</span> handler = Timeout::new(handler, Duration::from_secs(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">let</span> handler = JsonContentType::new(handler);</span><br><span class="line"></span><br><span class="line">server.run(handler).<span class="keyword">await</span></span><br></pre></td></tr></table></figure><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬æœ‰äº†ä¸€ä¸ª<code>Handler trait</code>ï¼Œè¿™å¯ä»¥å°†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºåˆ†è§£æˆç‹¬ç«‹çš„å°éƒ¨åˆ†ï¼Œå¹¶å¯ä»¥å¤ç”¨ã€‚çœ‹ç€ä¸é”™ï¼</p><h1 id="â€œå¦‚æœæˆ‘å‘Šè¯‰ä½ â€¦â€¦â€"><a href="#â€œå¦‚æœæˆ‘å‘Šè¯‰ä½ â€¦â€¦â€" class="headerlink" title="â€œå¦‚æœæˆ‘å‘Šè¯‰ä½ â€¦â€¦â€"></a>â€œå¦‚æœæˆ‘å‘Šè¯‰ä½ â€¦â€¦â€</h1><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªè®¨è®ºäº† server æ–¹é¢çš„äº‹æƒ…ã€‚ä½†æ˜¯å®é™…ä¸Šï¼Œæˆ‘ä»¬çš„<code>Handler trait</code>ä¹Ÿé€‚ç”¨äº HTTP å®¢æˆ·ç«¯ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³è±¡æœ‰ä¸ªå®¢æˆ·ç«¯çš„<code>Handler</code>æ¥å—ä¸€äº›è¯·æ±‚å¹¶å¼‚æ­¥åœ°å°†å…¶å‘é€ç»™äº’è”ç½‘ä¸Šçš„æŸ serverï¼Œæˆ‘ä»¬çš„<code>Timeout</code>åŒ…è£…å™¨åœ¨è¿™é‡Œä¹Ÿå¾ˆæœ‰ç”¨ã€‚<code>JsonContentType</code>å¯èƒ½æ²¡å•¥ç”¨ï¼Œå› ä¸ºè®¾ç½®å“åº”å¤´ä¸æ˜¯å®¢æˆ·ç«¯çš„å·¥ä½œã€‚</p><p>ç”±äºæˆ‘ä»¬çš„<code>Handler trait</code>å¯¹äºå®šä¹‰æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½å¾ˆæœ‰ç”¨ï¼Œ<code>Handler</code>å¯èƒ½ä¸æ˜¯ä¸€ä¸ªåˆé€‚çš„åå­—ï¼Œæ¯•ç«Ÿå®¢æˆ·ç«¯å¹¶ä¸å¤„ç†ä¸€ä¸ªè¯·æ±‚ï¼Œå®ƒå°†è¯·æ±‚å‘é€ç»™æœåŠ¡å™¨ï¼Œç„¶åç”±æœåŠ¡å™¨æ¥å¤„ç†å®ƒã€‚è®©æˆ‘ä»¬æ”¹ç§°æˆ‘ä»¬çš„ trait ä¸º<code>Service</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Service</span></span>&lt;Request&gt; &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Response</span></span>;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Error</span></span>;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Future</span></span>: Future&lt;Output = <span class="built_in">Result</span>&lt;Self::Response, Self::Error&gt;&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">call</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, request: Request) -&gt; Self::Future;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™å®é™…ä¸Š<em>å‡ ä¹</em>å°±æ˜¯<code>Tower</code>ä¸­å®šä¹‰çš„<code>Service trait</code>äº†ã€‚å¦‚æœä½ å·²ç»è·Ÿç€çœ‹åˆ°äº†è¿™é‡Œï¼Œä½ ç°åœ¨å·²ç»äº†è§£äº†<code>Tower</code>çš„å¤§éƒ¨åˆ†å†…å®¹äº†ã€‚é™¤äº†<code>Service trait</code>ï¼Œ<code>Tower</code>è¿˜æä¾›äº†ä¸€äº›å®ç”¨å·¥å…·ï¼Œé€šè¿‡åŒ…è£…å…¶å®ƒçš„<code>Service</code>å¹¶å®ç°ä¸€ä¸ª<code>Service</code>ï¼Œå°±åƒæˆ‘ä»¬å¯¹<code>Timeout</code>å’Œ<code>JsonContentType</code>æ‰€åšçš„é‚£æ ·ã€‚è¿™äº›<code>Service</code>çš„ç»„æˆæ–¹å¼ä¸æˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢æ‰€åšçš„ç±»ä¼¼ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€äº›ç”±<code>Tower</code>æä¾›çš„<code>Service</code>ç¤ºä¾‹ï¼š</p><ul><li><a href="https://docs.rs/tower/latest/tower/timeout/index.html"><code>Timeout</code></a>â€”â€”è¿™ä¸æˆ‘ä»¬ä¹‹å‰å®ç°çš„è¶…æ—¶åŸºæœ¬ç›¸åŒã€‚</li><li><a href="https://docs.rs/tower/latest/tower/retry/index.html"><code>Retry</code></a>â€”â€”è‡ªåŠ¨é‡è¯•å¤±è´¥çš„è¯·æ±‚ã€‚</li><li><a href="https://docs.rs/tower/latest/tower/limit/rate/index.html"><code>RateLimit</code></a>â€”â€”é™åˆ¶ä¸€ä¸ªæœåŠ¡åœ¨ä¸€æ®µæ—¶é—´å†…æ”¶åˆ°çš„è¯·æ±‚æ•°é‡ã€‚</li></ul><p>åƒ<code>Timeout</code>å’Œ<code>JsonContentType</code>è¿™æ ·çš„ç±»å‹é€šå¸¸è¢«ç§°ä¸º<em>ä¸­é—´ä»¶</em>ï¼Œå› ä¸ºå®ƒä»¬åŒ…è£¹ç€å¦ä¸€ä¸ª<code>Service</code>å¹¶ä»¥æŸç§æ–¹å¼å¯¹è¯·æ±‚æˆ–å“åº”è¿›è¡Œå¤„ç†ã€‚åƒ<code>RequestHandler</code>è¿™æ ·çš„ç±»å‹é€šå¸¸è¢«ç§°ä¸º<code>å¶å­æœåŠ¡</code>ï¼Œå› ä¸ºå®ƒä»¬ä½äºåµŒå¥—æœåŠ¡æ ‘çš„å¶å­ä¸Šã€‚å®é™…çš„å“åº”é€šå¸¸æ˜¯åœ¨å¶å­æœåŠ¡ä¸­äº§ç”Ÿï¼Œå¹¶ç”±ä¸­é—´ä»¶ä¿®æ”¹ã€‚</p><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œå”¯ä¸€ï¼ˆå”¯äºŒï¼Ÿï¼‰æˆ‘ä»¬å‰©ä¸‹è¿˜æ²¡èŠçš„æ˜¯<em>backpressure</em>å’Œ<a href="https://docs.rs/tower/0.4.7/tower/trait.Service.html#tymethod.poll_ready"><code>poll_ready</code></a>ã€‚</p><h1 id="Backpressure"><a href="#Backpressure" class="headerlink" title="Backpressure"></a>Backpressure</h1><p>æƒ³è±¡ä¸€ä¸‹ï¼Œç°åœ¨ä½ æƒ³å†™ä¸€ä¸ªé™åˆ¶è¯·æ±‚é€Ÿç‡çš„ä¸­é—´ä»¶ï¼Œæ¥åŒ…è£…ä¸€ä¸ª<code>Service</code>ï¼Œä»¥å¯¹åº•å±‚æœåŠ¡çš„æœ€å¤§å¹¶å‘è¯·æ±‚æ•°è¿›è¡Œé™åˆ¶ã€‚å¦‚æœä½ çš„æœåŠ¡å¯¹å®ƒçš„è´Ÿè½½é‡æœ‰ä¸€ä¸ªç¡¬æ€§çš„ä¸Šé™ï¼Œè¿™å°†æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚</p><p>åœ¨æˆ‘ä»¬ç›®å‰çš„<code>Service trait</code>ä¸­ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ä¸€ä¸ªå¥½çš„æ–¹æ³•æ¥å®ç°è¿™æ ·çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•è¿™æ ·åšï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;R, T&gt; Service&lt;R&gt; <span class="keyword">for</span> ConcurrencyLimit&lt;T&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">call</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, request: R) -&gt; Self::Future &#123;</span><br><span class="line">        <span class="comment">// 1. æ£€æŸ¥å½“å‰æ­£åœ¨å¤„ç†çš„è¯·æ±‚æ•°çš„è®¡æ•°å™¨ã€‚</span></span><br><span class="line">        <span class="comment">// 2. å¦‚æœæœ‰å‰©ä½™çš„å®¹é‡ï¼Œå°†è¯·æ±‚å‘é€åˆ°`T`ï¼Œå¹¶å¢åŠ è®¡æ•°å™¨ã€‚</span></span><br><span class="line">        <span class="comment">// 3. å¦‚æœæ²¡æœ‰ï¼Œåˆ™ç­‰åˆ°æœ‰èƒ½åŠ›æ—¶å†è¿›è¡Œå¤„ç†ã€‚</span></span><br><span class="line">        <span class="comment">// 4. å½“è¿”å›å“åº”åï¼Œå‡å»è®¡æ•°å™¨ã€‚</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰å‰©ä½™çš„å®¹é‡ï¼Œæˆ‘ä»¬å¿…é¡»ç­‰å¾…ï¼Œå¹¶åœ¨å®¹é‡å¯ç”¨æ—¶ä»¥æŸç§æ–¹å¼å¾—åˆ°é€šçŸ¥ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨ç­‰å¾…æ—¶å°†è¯·æ±‚ä¿ç•™åœ¨å†…å­˜ä¸­ï¼ˆä¹Ÿç§°ä¸º<em>ç¼“å†²</em>ï¼‰ã€‚è¿™æ„å‘³ç€ï¼Œç­‰å¾…çš„è¯·æ±‚è¶Šå¤šï¼Œæˆ‘ä»¬çš„ç¨‹åºå°±ä¼šä½¿ç”¨æ›´å¤šçš„å†…å­˜â€”â€”å¦‚æœäº§ç”Ÿçš„è¯·æ±‚è¶…è¿‡æˆ‘ä»¬çš„æœåŠ¡æ‰€èƒ½å¤„ç†çš„æ•°é‡ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šè€—å°½å†…å­˜ã€‚<br>åªæœ‰å½“æˆ‘ä»¬ç¡®å®šæœåŠ¡æœ‰èƒ½åŠ›å¤„ç†è¯·æ±‚æ—¶ï¼Œæ‰ä¸ºè¯·æ±‚åˆ†é…ç©ºé—´ï¼Œè¿™å°†æ˜¯æ›´ç¨³å¥çš„åšæ³•ã€‚å¦åˆ™ï¼Œåœ¨æˆ‘ä»¬ç­‰å¾…æˆ‘ä»¬çš„æœåŠ¡å‡†å¤‡å¥½æ—¶ï¼Œæˆ‘ä»¬æœ‰å¯èƒ½ä½¿ç”¨å¤§é‡çš„å†…å­˜æ¥ç¼“å†²è¯·æ±‚ã€‚</p><p>å¦‚æœè¯´<code>Service</code>æœ‰è¿™æ ·ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£å°±å®Œç¾äº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Service</span></span>&lt;R&gt; &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">ready</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ready</code>å°†æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œå½“æœåŠ¡æœ‰è¶³å¤Ÿçš„å®¹é‡æ¥æ¥æ”¶ä¸€ä¸ªæ–°çš„è¯·æ±‚æ—¶ï¼Œå®ƒå°±ä¼šå®Œæˆå¹¶è¿”å›ã€‚æˆ‘ä»¬å°†è¦æ±‚ç”¨æˆ·é¦–å…ˆè°ƒç”¨<code>service.ready().await</code>ï¼Œç„¶åå†è¿›è¡Œ<code>service.call(require).await</code>ã€‚</p><p>å°†â€œè°ƒç”¨æœåŠ¡â€ä¸â€œé¢„ç•™å®¹é‡â€åˆ†å¼€ï¼Œè¿˜å¯ä»¥æœ‰æ–°çš„ç”¨æ³•ï¼šæ¯”å¦‚æˆ‘ä»¬å¯ä»¥ç»´æŠ¤ä¸€ç»„â€œå‡†å¤‡å¥½çš„æœåŠ¡â€ï¼Œå¹¶åœ¨åå°ä¿æŒæ›´æ–°ã€‚è¿™æ ·ï¼Œå½“ä¸€ä¸ªè¯·æ±‚åˆ°æ¥æ—¶ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªå¯ä»¥ä½¿ç”¨çš„æœåŠ¡ï¼Œè€Œä¸éœ€è¦é¦–å…ˆç­‰å¾…å®ƒå‡†å¤‡å¥½ã€‚</p><p>é€šè¿‡è¿™ç§è®¾è®¡ï¼Œ<code>ConcurrencyLimit</code>å¯ä»¥åœ¨<code>ready</code>å†…éƒ¨è®¡ç®—å®¹é‡ï¼Œè€Œä¸å…è®¸ç”¨æˆ·è°ƒç”¨<code>call</code>ï¼Œç›´åˆ°æœ‰è¶³å¤Ÿçš„å®¹é‡ã€‚</p><p>ä¸å…³å¿ƒå®¹é‡çš„æœåŠ¡å¯ä»¥ä»<code>ready</code>ä¸­ç«‹å³è¿”å›ï¼Œæˆ–è€…å¦‚æœå®ƒä»¬åŒ…å«äº†ä¸€äº›å†…éƒ¨çš„<code>Service</code>ï¼Œå®ƒä»¬å¯ä»¥å§”æ‰˜ç»™å®ƒå†…éƒ¨çš„<code>ready</code>æ–¹æ³•ã€‚</p><p>ç„¶è€Œï¼Œç°åœ¨æˆ‘ä»¬ä»ç„¶ä¸èƒ½åœ¨ trait ä¸­å®šä¹‰å¼‚æ­¥å‡½æ•°ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç»™<code>Service</code>å®šä¹‰å¦ä¸€ä¸ªå…³è”ç±»å‹ï¼Œå«åš<code>ReadyFuture</code>ï¼Œä½†æ˜¯å¿…é¡»è¿”å›ä¸€ä¸ª<code>Future</code>ä¼šç»™æˆ‘ä»¬å¸¦æ¥æˆ‘ä»¬ä¹‹å‰é‡åˆ°çš„åŒæ ·çš„ç”Ÿå‘½å‘¨æœŸé—®é¢˜ã€‚å¦‚æœæœ‰ä¸€äº›æ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜å°±å¥½äº†ã€‚</p><p>ä½œä¸ºæ›¿ä»£ï¼Œæˆ‘ä»¬å¯ä»¥ä»<code>Future</code>ç‰¹æ€§ä¸­è·å¾—ä¸€äº›çµæ„Ÿï¼Œå®šä¹‰ä¸€ä¸ªæ–¹æ³•å«åš<code>poll_ready</code>ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::task::&#123;Context, Poll&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Service</span></span>&lt;R&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">poll_ready</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, cx: &amp;<span class="keyword">mut</span> Context&lt;<span class="symbol">&#x27;_</span>&gt;) -&gt; Poll&lt;()&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæœåŠ¡æ²¡æœ‰å®¹é‡ï¼Œ<code>poll_ready</code>å°†è¿”å›<code>Poll::Pending</code>ï¼›å½“å®¹é‡å˜å¾—å¯ç”¨æ—¶ï¼Œä½¿ç”¨<code>Context</code>ä¸­çš„<code>waker</code>é€šçŸ¥è°ƒç”¨è€…ã€‚è¿™æ—¶ï¼Œå¯ä»¥å†æ¬¡è°ƒç”¨<code>poll_ready</code>ï¼Œå¦‚æœå®ƒè¿”å›<code>Poll::Ready(())</code>ï¼Œé‚£ä¹ˆå®¹é‡å°±è¢«ä¿ç•™äº†ï¼Œå°±å¯ä»¥è°ƒç”¨<code>call</code>äº†ã€‚</p><p>è¯·æ³¨æ„ï¼Œä»æŠ€æœ¯ä¸Šæ¥è¯´ï¼Œæ²¡æœ‰ä»»ä½•ä¸œè¥¿å¯ä»¥é˜»æ­¢ç”¨æˆ·åœ¨æ²¡æœ‰ç¡®å®šæœåŠ¡å‡†å¤‡å¥½çš„æƒ…å†µä¸‹è°ƒç”¨<code>call</code>ï¼Œç„¶è€Œï¼Œè¿™æ ·åšè¢«è®¤ä¸ºæ˜¯è¿åäº†<code>Service</code>çš„ API è°ƒç”¨çº¦å®šã€‚è¿™æ—¶å€™<code>call</code>å¯ä»¥<code>panic</code>å¦‚æœæœåŠ¡æ²¡æœ‰å‡†å¤‡å¥½ã€‚</p><p><code>poll_ready</code>ä¸è¿”å›<code>Future</code>ä¹Ÿæ„å‘³ç€æˆ‘ä»¬èƒ½å¤Ÿå¿«é€Ÿæ£€æŸ¥ä¸€ä¸ªæœåŠ¡æ˜¯å¦å‡†å¤‡å¥½äº†ï¼Œè€Œä¸éœ€è¦è¢«è¿«ç­‰å¾…å®ƒå‡†å¤‡å¥½ã€‚å¦‚æœæˆ‘ä»¬<br>è°ƒç”¨<code>poll_ready</code>å¹¶è¿”å›<code>Poll::Pending</code>ï¼Œæˆ‘ä»¬å¯ä»¥å†³å®šå»åšå…¶ä»–äº‹æƒ…è€Œä¸æ˜¯ç­‰å¾…ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œè¿™å…è®¸ä½ å†™ä¸ªè´Ÿè½½å‡è¡¡å™¨ï¼Œé€šè¿‡æœåŠ¡è¿”å›<code>Poll::Pending</code>çš„é¢‘ç‡æ¥ä¼°è®¡æœåŠ¡çš„è´Ÿè½½ï¼Œå¹¶å°†è¯·æ±‚å‘é€åˆ°è´Ÿè½½æœ€å°çš„æœåŠ¡ã€‚</p><p>ä½¿ç”¨ç±»ä¼¼äº<a href="https://docs.rs/futures/0.3.14/futures/future/fn.poll_fn.html"><code>futures::future::poll_fn</code></a>æˆ–è€…<a href="https://docs.rs/tower/0.4.7/tower/trait.ServiceExt.html#method.ready"><code>tower::ServiceExt::ready</code></a>çš„ä¸œè¥¿ï¼Œä»ç„¶å¯ä»¥è·å¾—ä¸€ä¸ªç­‰å¾…æœåŠ¡å®¹é‡å¯ç”¨çš„ Futureã€‚</p><p>è¿™ç§æœåŠ¡ä¸å®ƒä»¬çš„è°ƒç”¨è€…æ²Ÿé€šå…¶å®¹é‡çš„æ¦‚å¿µè¢«ç§°ä¸ºâ€œåå‹ä¼ æ’­â€ã€‚ä½ å¯ä»¥æŠŠå®ƒçœ‹ä½œæ˜¯æœåŠ¡å‘ååæ¨ä»–ä»¬çš„è°ƒç”¨è€…ï¼Œå¹¶ä¸”å¦‚æœä»–ä»¬äº§ç”Ÿçš„è¯·æ±‚å¤ªå¿«äº†æ—¶ï¼Œå‘Šè¯‰ä»–ä»¬éœ€è¦æ”¾æ…¢é€Ÿåº¦ã€‚å…¶åŸºæœ¬æ€æƒ³æ˜¯ï¼Œä½ ä¸åº”è¯¥å‘ä¸€ä¸ªæ²¡æœ‰èƒ½åŠ›å¤„ç†çš„æœåŠ¡å‘é€è¯·æ±‚ã€‚ç›¸åï¼Œä½ åº”è¯¥ç­‰å¾…ï¼ˆç¼“å†²ï¼‰ï¼Œæ”¾å¼ƒè¯·æ±‚ï¼ˆå‡è´Ÿï¼‰ï¼Œæˆ–ä»¥å…¶ä»–æ–¹å¼å¤„ç†èƒ½åŠ›ä¸è¶³çš„é—®é¢˜ã€‚ä½ å¯ä»¥åœ¨<a href="https://medium.com/@jayphelps/backpressure-explained-the-flow-of-data-through-software-2350b3e77ce7">è¿™é‡Œ</a>å’Œ<a href="https://aws.amazon.com/builders-library/using-load-shedding-to-avoid-overload/">è¿™é‡Œ</a>äº†è§£æ›´å¤šå…³äºèƒŒå‹çš„ä¸€èˆ¬æ¦‚å¿µã€‚</p><p>æœ€åï¼Œåœ¨é¢„ç•™å®¹é‡æ—¶ä¹Ÿå¯èƒ½å‘ç”Ÿä¸€äº›é”™è¯¯ï¼Œæ‰€ä»¥<code>poll_ready</code>ä¹Ÿè®¸åº”è¯¥è¿”å›<code>Poll&lt;Result&lt;(), Self::Error&gt;</code>ã€‚</p><p>æœ‰äº†è¿™ä¸€æ”¹å˜ï¼Œæˆ‘ä»¬ç°åœ¨å·²ç»æœ‰äº†å®Œæ•´çš„<code>tower::Service</code>ç‰¹æ€§ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">Service</span></span>&lt;Request&gt; &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Response</span></span>;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Error</span></span>;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Future</span></span>: Future&lt;Output = <span class="built_in">Result</span>&lt;Self::Response, Self::Error&gt;&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">poll_ready</span></span>(</span><br><span class="line">        &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">        cx: &amp;<span class="keyword">mut</span> Context&lt;<span class="symbol">&#x27;_</span>&gt;,</span><br><span class="line">    ) -&gt; Poll&lt;<span class="built_in">Result</span>&lt;(), Self::Error&gt;&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">call</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, req: Request) -&gt; Self::Future;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¸å¤šä¸­é—´ä»¶ä¸æ·»åŠ è‡ªå·±çš„èƒŒå‹ï¼Œè€Œåªæ˜¯å§”æ‰˜ç»™è¢«å°è£…çš„æœåŠ¡çš„<code>poll_ready</code>å®ç°ã€‚ç„¶è€Œï¼Œä¸­é—´ä»¶çš„èƒŒå‹ç¡®å®å¯ä»¥å®ç°ä¸€äº›æœ‰è¶£çš„ç”¨ä¾‹ï¼Œä¾‹å¦‚å„ç§é€Ÿç‡é™åˆ¶ã€è´Ÿè½½å‡è¡¡å’Œè‡ªåŠ¨æ‰©å®¹ã€‚</p><p>ç”±äºä½ æ°¸è¿œä¸çŸ¥é“ä¸€ä¸ª<code>Service</code>å¯èƒ½ç”±å“ªäº›ä¸­é—´ä»¶ç»„æˆï¼Œæ‰€ä»¥é‡è¦çš„æ˜¯ä¸è¦å¿˜è®°è°ƒç”¨<code>poll_ready</code>ã€‚</p><p>æœ‰äº†è¿™ä¸€åˆ‡ï¼Œè°ƒç”¨æœåŠ¡çš„æœ€å¸¸ç”¨æ–¹æ³•æ˜¯ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> tower::&#123;</span><br><span class="line">    Service,</span><br><span class="line">    <span class="comment">// for the `ready` method</span></span><br><span class="line">    ServiceExt,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> response = service</span><br><span class="line">    <span class="comment">// wait for the service to have capacity</span></span><br><span class="line">    .ready().<span class="keyword">await</span>?</span><br><span class="line">    <span class="comment">// send the request</span></span><br><span class="line">    .call(request).<span class="keyword">await</span>?;</span><br></pre></td></tr></table></figure><div style="text-align:right">&mdash; David Pedersen (<a href="https://github.com/davidpdrsn">@davidpdrsn</a>) </div><hr><h1 id="è„šæ³¨"><a href="#è„šæ³¨" class="headerlink" title="è„šæ³¨"></a>è„šæ³¨</h1><p><a name="pin">1</a>: å…³äº<code>call</code>æ˜¯å¦åº”è¯¥ä½¿ç”¨<code>Pin&lt;&amp;mut Self&gt;</code> ï¼Œå·²ç»æœ‰äº†ä¸€äº›è®¨è®ºã€‚ä½†æ˜¯åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å†³å®šé‡‡ç”¨ä¸€ä¸ªæ™®é€šçš„ <code>&amp;mut self</code>ï¼Œè¿™æ„å‘³ç€ handlerï¼ˆå’³ï¼Œ<em>Services</em>ï¼‰å¿…é¡»æ˜¯<code>Unpin</code>ã€‚åœ¨å®è·µä¸­ï¼Œè¿™å¾ˆå°‘å‡ºç°é—®é¢˜ã€‚æ›´å¤šç»†èŠ‚å¯ä»¥çœ‹<a href="https://github.com/tower-rs/tower/issues/319">è¿™é‡Œ</a>ã€‚</p><p><a name="gats">2</a>: è¯´å¾—æ›´å‡†ç¡®ä¸€ç‚¹ï¼Œè¿™è¦æ±‚å“åº”è¿”å›çš„ Future å¿…é¡»æ˜¯<code>&#39;static&#39;</code>çš„ï¼Œå› ä¸ºå†™<code>Box&lt;dyn Future&gt;</code>å®é™…ä¸Šä¼šè¢« desugar æˆ<code>Box&lt;dyn Future + &#39;static&gt;</code>ï¼Œå› æ­¤åœ¨<code>fn call(&amp;&#39;_ mut self, ...) </code>ä¸­çš„åŒ¿å<code>lifetime</code>å¹¶ä¸æ»¡è¶³è¿™ä¸ªè¦æ±‚ã€‚åœ¨æœªæ¥ï¼ŒRustç¼–è¯‘å™¨å›¢é˜Ÿè®¡åˆ’å¢åŠ ä¸€ä¸ªåä¸º<a href="https://github.com/rust-lang/rust/issues/44265">æ³›å‹å…³è”ç±»å‹ï¼ˆGATï¼‰</a>çš„åŠŸèƒ½ï¼Œè¿™å°†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æ³›å‹å…³è”ç±»å‹å…è®¸æˆ‘ä»¬å°†å“åº”çš„ future å®šä¹‰ä¸º<code>type Future&lt;&#39;a&gt;</code>ï¼Œ<code>call</code>å®šä¹‰ä¸º<code>fn call&lt;&#39;a&gt;(&amp;&#39;a mut self, ...) -&gt; Self::Future&lt;&#39;a&gt;</code>ï¼Œä½†ç°åœ¨å“åº”è¿”å›çš„ Future å¿…é¡»æ˜¯<code>&#39;static</code>çš„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;å†™åœ¨å‰é¢ï¼š&lt;/p&gt;
&lt;p&gt;æœ€è¿‘çœ‹åˆ°äº†ä¸€ç¯‡è®² Rust å¦‚ä½•å¯¹æ¡†æ¶è¿›è¡ŒæŠ½è±¡çš„æ–‡ç« ï¼Œå†™å¾—éå¸¸å¥½ï¼Œè¿™ä¸¤å¤©æŠ½ç©ºç¿»è¯‘äº†ä¸€ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;åŸæ–‡ï¼š&lt;a href=&quot;https://tokio.rs/blog/2021-05-14-inventing-the-service-trait&quot;&gt;https://tokio.rs/blog/2021-05-14-inventing-the-service-trait&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;æ­£æ–‡&quot;&gt;&lt;a href=&quot;#æ­£æ–‡&quot; class=&quot;headerlink&quot; title=&quot;æ­£æ–‡&quot;&gt;&lt;/a&gt;æ­£æ–‡&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/tower-rs/tower&quot;&gt;&lt;code&gt;Tower&lt;/code&gt;&lt;/a&gt;æ˜¯ä¸€ä¸ªæ¨¡å—åŒ–å’Œå¯é‡å¤ä½¿ç”¨çš„ç”¨æ¥æ„å»º client å’Œ server çš„ç»„ä»¶åº“ã€‚å…¶æ ¸å¿ƒæ˜¯&lt;a href=&quot;https://docs.rs/tower/latest/tower/trait.Service.html&quot;&gt;&lt;code&gt;Service&lt;/code&gt;&lt;/a&gt;ç‰¹æ€§ã€‚ä¸€ä¸ª&lt;code&gt;Service&lt;/code&gt;æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªè¯·æ±‚å¹¶äº§ç”Ÿä¸€ä¸ªå“åº”ã€‚ç„¶è€Œï¼Œ&lt;code&gt;Tower&lt;/code&gt;è®¾è®¡çš„æŸäº›æ–¹é¢å¯èƒ½ä¸æ˜¯é‚£ä¹ˆä¸€ç›®äº†ç„¶ã€‚&lt;/p&gt;
&lt;p&gt;ä¸å…¶è§£é‡Šä»Šå¤©å­˜åœ¨äº&lt;code&gt;Tower&lt;/code&gt;ä¸­çš„&lt;code&gt;Service&lt;/code&gt;ç‰¹æ€§ï¼Œä¸å¦‚æ¥çœ‹çœ‹&lt;code&gt;Service&lt;/code&gt;èƒŒåçš„è®¾è®¡è€ƒé‡ã€‚è®©æˆ‘ä»¬è¯•è¯•çœ‹ï¼Œå¦‚æœä»Šå¤©é‡æ–°è®¾è®¡å®ç°å®ƒï¼Œæˆ‘ä»¬ä¼šæ€ä¹ˆåšã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="rust" scheme="https://www.purewhite.io/categories/rust/"/>
    
    
    <category term="rust" scheme="https://www.purewhite.io/tags/rust/"/>
    
    <category term="tokio" scheme="https://www.purewhite.io/tags/tokio/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€æ¬¡ Golang çš„ time.Now ä¼˜åŒ–ä¹‹æ—…</title>
    <link href="https://www.purewhite.io/2021/04/29/golang-time-now-optimize/"/>
    <id>https://www.purewhite.io/2021/04/29/golang-time-now-optimize/</id>
    <published>2021-04-29T06:10:44.000Z</published>
    <updated>2021-12-02T12:51:07.226Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¼˜èµ·"><a href="#ç¼˜èµ·" class="headerlink" title="ç¼˜èµ·"></a>ç¼˜èµ·</h1><p>æœ€è¿‘æƒ³å°è¯•åœ¨ Golang é‡Œé¢å®ç°<code>clock_gettime</code>çš„<code>CLOCK_REALTIME_COARSE</code>å’Œ<code>CLOCK_MONOTONIC_COARSE</code>ï¼Œæ­£å¥½æ·±å…¥ç ”ç©¶äº†ä¸‹ <code>time.Now</code>çš„å®ç°ï¼Œè¿˜æœºç¼˜å·§åˆä¸‹é¡ºä¾¿ä¼˜åŒ–äº†ä¸€æŠŠ<code>time.Now</code>ï¼ˆè™½ç„¶æœ€ç»ˆæäº¤çš„æ˜¯ Ian å¤§ä½¬çš„ç‰ˆæœ¬ï¼‰ã€‚</p><p>åœ¨è¿™é‡Œè®°å½•ä¸‹æ¥æ•´ä¸ªè¿‡ç¨‹ï¼Œä»¥ä¾›æŸ¥é˜…ã€‚</p><span id="more"></span><h1 id="time-Now-å®ç°åŸç†"><a href="#time-Now-å®ç°åŸç†" class="headerlink" title="time.Now å®ç°åŸç†"></a>time.Now å®ç°åŸç†</h1><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹ <code>time.Now</code>çš„å®ç°åŸç†ï¼Œä»ä»£ç ï¼ˆä»¥ä¸‹ä»£ç åŸºäº Go &lt;= 1.16 ç‰ˆæœ¬ï¼‰å…¥æ‰‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Provided by package runtime.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">now</span><span class="params">()</span> <span class="params">(sec <span class="keyword">int64</span>, nsec <span class="keyword">int32</span>, mono <span class="keyword">int64</span>)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Now returns the current local time.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Now</span><span class="params">()</span> <span class="title">Time</span></span> &#123;</span><br><span class="line">sec, nsec, mono := now()</span><br><span class="line">mono -= startNano</span><br><span class="line">sec += unixToInternal - minWall</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">uint64</span>(sec)&gt;&gt;<span class="number">33</span> != <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> Time&#123;<span class="keyword">uint64</span>(nsec), sec + minWall, Local&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> Time&#123;hasMonotonic | <span class="keyword">uint64</span>(sec)&lt;&lt;nsecShift | <span class="keyword">uint64</span>(nsec), mono, Local&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>time.Now</code>é‡Œé¢å®é™…ä¸Šæ˜¯è°ƒç”¨äº†<code>now</code>æ¥è·å¾—å¯¹åº”çš„æ—¶é—´æ•°å€¼ï¼Œç„¶åè¿›è¡Œäº†ä¸€ç³»åˆ—çš„å¤„ç†ã€‚è¿™éƒ¨åˆ†å¤„ç†å°±ä¸è¯´äº†ï¼Œç½‘ä¸Šæœ‰è¾ƒå¤šèµ„æ–™ï¼Œä¹Ÿä¸æ˜¯æœ¬æ–‡é‡ç‚¹ã€‚æˆ‘ä»¬æ¥ç€å»<code>runtime</code>åŒ…é‡Œé¢æ‰¾æ‰¾<code>now</code>æ˜¯æ€ä¹ˆå®ç°çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//go:linkname time_now time.now</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">time_now</span><span class="params">()</span> <span class="params">(sec <span class="keyword">int64</span>, nsec <span class="keyword">int32</span>, mono <span class="keyword">int64</span>)</span></span> &#123;</span><br><span class="line">sec, nsec = walltime()</span><br><span class="line"><span class="keyword">return</span> sec, nsec, nanotime()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®å…³é”®å­—æœç´¢ï¼Œå¾ˆå¿«èƒ½æœåˆ°åœ¨<code>runtime</code>çš„<code>timestub.go</code>æ–‡ä»¶ä¸­çš„ä»¥ä¸Šä»£ç ï¼Œå¯ä»¥çœ‹åˆ°å®é™…ä¸Šè°ƒç”¨äº†ä¸¤ä¸ªæ–¹æ³•ï¼š<code>walltime</code>å’Œ<code>nanotime</code>ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•åˆè°ƒç”¨äº†<code>walltime1</code>å’Œ<code>nanotime1</code>ï¼Œå¹¶ä¸”æ˜¯ä»¥æ±‡ç¼–å®ç°çš„ï¼Œè®©æˆ‘ä»¬ç»§ç»­æ·±å…¥çœ‹ä¸‹è¿™ä¸¤ä¸ªæ–¹æ³•çš„æ±‡ç¼–å®ç°ï¼Œå› ä¸ºä»£ç åŸºæœ¬ç›¸åŒï¼Œè¿™è¾¹ä»¥<code>walltime1</code>ä½œä¸ºä¾‹å­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">// func walltime1() (sec int64, nsec int32)</span><br><span class="line">// non-zero frame-size means bp is saved and restored</span><br><span class="line">TEXT runtimeÂ·walltime1(SB),NOSPLIT,$16-12</span><br><span class="line">// We don&#x27;t know how much stack space the VDSO code will need,</span><br><span class="line">// so switch to g0.</span><br><span class="line">// In particular, a kernel configured with CONFIG_OPTIMIZE_INLINING=n</span><br><span class="line">// and hardening can use a full page of stack space in gettime_sym</span><br><span class="line">// due to stack probes inserted to avoid stack/heap collisions.</span><br><span class="line">// See issue #20427.</span><br><span class="line"></span><br><span class="line">MOVQSP, R12// Save old SP; R12 unchanged by C code.</span><br><span class="line"></span><br><span class="line">get_tls(CX)</span><br><span class="line">MOVQg(CX), AX</span><br><span class="line">MOVQg_m(AX), BX // BX unchanged by C code.</span><br><span class="line"></span><br><span class="line">// Set vdsoPC and vdsoSP for SIGPROF traceback.</span><br><span class="line">// Save the old values on stack and restore them on exit,</span><br><span class="line">// so this function is reentrant.</span><br><span class="line">MOVQm_vdsoPC(BX), CX</span><br><span class="line">MOVQm_vdsoSP(BX), DX</span><br><span class="line">MOVQCX, 0(SP)</span><br><span class="line">MOVQDX, 8(SP)</span><br><span class="line"></span><br><span class="line">LEAQsec+0(FP), DX</span><br><span class="line">MOVQ-8(DX), CX</span><br><span class="line">MOVQCX, m_vdsoPC(BX)</span><br><span class="line">MOVQDX, m_vdsoSP(BX)</span><br><span class="line"></span><br><span class="line">CMPQAX, m_curg(BX)// Only switch if on curg.</span><br><span class="line">JNEnoswitch</span><br><span class="line"></span><br><span class="line">MOVQm_g0(BX), DX</span><br><span class="line">MOVQ(g_sched+gobuf_sp)(DX), SP// Set SP to g0 stack</span><br><span class="line"></span><br><span class="line">noswitch:</span><br><span class="line">SUBQ$16, SP// Space for results</span><br><span class="line">ANDQ$~15, SP// Align for C code</span><br><span class="line"></span><br><span class="line">MOVL$0, DI // CLOCK_REALTIME</span><br><span class="line">LEAQ0(SP), SI</span><br><span class="line">MOVQruntimeÂ·vdsoClockgettimeSym(SB), AX</span><br><span class="line">CMPQAX, $0</span><br><span class="line">JEQfallback</span><br><span class="line">CALLAX</span><br><span class="line">ret:</span><br><span class="line">MOVQ0(SP), AX// sec</span><br><span class="line">MOVQ8(SP), DX// nsec</span><br><span class="line">MOVQR12, SP// Restore real SP</span><br><span class="line">// Restore vdsoPC, vdsoSP</span><br><span class="line">// We don&#x27;t worry about being signaled between the two stores.</span><br><span class="line">// If we are not in a signal handler, we&#x27;ll restore vdsoSP to 0,</span><br><span class="line">// and no one will care about vdsoPC. If we are in a signal handler,</span><br><span class="line">// we cannot receive another signal.</span><br><span class="line">MOVQ8(SP), CX</span><br><span class="line">MOVQCX, m_vdsoSP(BX)</span><br><span class="line">MOVQ0(SP), CX</span><br><span class="line">MOVQCX, m_vdsoPC(BX)</span><br><span class="line">MOVQAX, sec+0(FP)</span><br><span class="line">MOVLDX, nsec+8(FP)</span><br><span class="line">RET</span><br><span class="line">fallback:</span><br><span class="line">MOVQ$SYS_clock_gettime, AX</span><br><span class="line">SYSCALL</span><br><span class="line">JMP ret</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çš„æ³¨é‡Šéå¸¸çš„æ¸…æ™°ï¼Œæ ¹æ®è¿™æ®µä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå®é™…ä¸Šæ˜¯ä½¿ç”¨çš„<code>vdso call</code>æ¥è·å–åˆ°å½“å‰çš„æ—¶é—´ä¿¡æ¯ã€‚åªä¸è¿‡ï¼Œç”±äº Go æ˜¯è‡ªå·±ç»´æŠ¤çš„åç¨‹çš„æ ˆï¼Œè€Œè¿™ä¸ªæ ˆåœ¨æŸäº›å†…æ ¸ä¸Šè°ƒç”¨<code>vdso</code>ä¼šå‡ºé—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦å…ˆåˆ‡æ¢åˆ°<code>g0</code>ï¼ˆä¹Ÿå°±æ˜¯ç³»ç»Ÿçº¿ç¨‹çš„æ ˆï¼‰ä¸Šæ‰è¡Œã€‚æ‰€ä»¥è¿™é‡Œåœ¨å¼€å¤´å’Œç»“å°¾æœ‰å¾ˆå¤šé¢å¤–çš„æ“ä½œï¼Œéœ€è¦åˆ¶é€ å’Œæ¸…ç†ä½œæ¡ˆç°åœºã€‚</p><p>æœ‰åŒå­¦å¯èƒ½å¯¹<code>vdso</code>ä¸äº†è§£ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸‹ï¼Œå®é™…ä¸Šä¸€å¼€å§‹è·å–æ—¶é—´ä¿¡æ¯æ˜¯éœ€è¦é€šè¿‡ç³»ç»Ÿè°ƒç”¨çš„ï¼Œä¹Ÿå°±æ˜¯è¦ syscall æ‰è¡Œï¼Œä½†æ˜¯ä¼—æ‰€å‘¨çŸ¥ï¼Œsyscall çš„æ€§èƒ½è¾ƒå·®ï¼ŒåŒæ—¶è·å–æ—¶é—´æˆ³åˆæ˜¯ä¸ªé«˜é¢‘æ“ä½œï¼Œæ‰€ä»¥å¤§å®¶ä¹Ÿæƒ³åŠæ³•ä¼˜åŒ–äº†å‡ ç‰ˆï¼Œæœ€ç»ˆæ˜¯ç°åœ¨é‡‡ç”¨çš„<code>vdso</code>çš„æ–¹æ¡ˆã€‚<code>vdso</code>å…¨ç§°æ˜¯<code>virtual dynamic shared object</code>ï¼Œç®€å•æ¥è¯´å°±æ˜¯æŠŠè¿™æ®µåŸæœ¬éœ€è¦ç³»ç»Ÿè°ƒç”¨çš„æ–¹æ³•ï¼ŒåƒåŠ¨æ€é“¾æ¥åº“ï¼ˆ<code>so</code>åº“ï¼‰ä¸€æ ·åŠ è½½åˆ°ç”¨æˆ·å†…å­˜ç©ºé—´é‡Œé¢ï¼Œè¿™æ ·ç”¨æˆ·çš„è¿›ç¨‹å°±å¯ä»¥åƒè°ƒç”¨ä¸€ä¸ªæ™®é€šæ–¹æ³•ä¸€æ ·è°ƒç”¨è¿™ä¸ªæ–¹æ³•äº†ï¼Œå¯ä»¥é¿å…ç³»ç»Ÿè°ƒç”¨çš„é¢å¤–å¼€é”€ã€‚å…·ä½“å¯ä»¥å‚è€ƒä¸€ä¸‹ï¼š<a href="https://man7.org/linux/man-pages/man7/vdso.7.html%E3%80%82">https://man7.org/linux/man-pages/man7/vdso.7.htmlã€‚</a></p><p>çœ‹å®Œ<code>walltime1</code>ä¹‹åæˆ‘ä»¬æ¥çœ‹ä¸‹<code>nanotime1</code>ï¼Œç”±äºå¼€å¤´çš„åˆ‡æ¢åˆ°<code>g0</code>çš„ä»£ç éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥è¿™é‡Œåªæˆªå–åç»­éƒ¨åˆ†çš„ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">noswitch:</span><br><span class="line">SUBQ$16, SP// Space for results</span><br><span class="line">ANDQ$~15, SP// Align for C code</span><br><span class="line"></span><br><span class="line">MOVL$1, DI // CLOCK_MONOTONIC</span><br><span class="line">LEAQ0(SP), SI</span><br><span class="line">MOVQruntimeÂ·vdsoClockgettimeSym(SB), AX</span><br><span class="line">CMPQAX, $0</span><br><span class="line">JEQfallback</span><br><span class="line">CALLAX</span><br><span class="line">ret:</span><br><span class="line">MOVQ0(SP), AX// sec</span><br><span class="line">MOVQ8(SP), DX// nsec</span><br><span class="line">MOVQR12, SP// Restore real SP</span><br><span class="line">// Restore vdsoPC, vdsoSP</span><br><span class="line">// We don&#x27;t worry about being signaled between the two stores.</span><br><span class="line">// If we are not in a signal handler, we&#x27;ll restore vdsoSP to 0,</span><br><span class="line">// and no one will care about vdsoPC. If we are in a signal handler,</span><br><span class="line">// we cannot receive another signal.</span><br><span class="line">MOVQ8(SP), CX</span><br><span class="line">MOVQCX, m_vdsoSP(BX)</span><br><span class="line">MOVQ0(SP), CX</span><br><span class="line">MOVQCX, m_vdsoPC(BX)</span><br><span class="line">// sec is in AX, nsec in DX</span><br><span class="line">// return nsec in AX</span><br><span class="line">IMULQ$1000000000, AX</span><br><span class="line">ADDQDX, AX</span><br><span class="line">MOVQAX, ret+0(FP)</span><br><span class="line">RET</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå”¯äºŒä¿®æ”¹çš„å°±æ˜¯è°ƒç”¨çš„<code>clockid</code>â€”â€”<code>CLOCK_MONOTONIC</code>å’Œ<code>RET</code>ä¹‹å‰çš„å¤„ç†é€»è¾‘â€”â€”å°†è¿”å›ç»“æœè½¬æ¢æˆçº³ç§’ã€‚</p><h1 id="time-Now-ä¼˜åŒ–"><a href="#time-Now-ä¼˜åŒ–" class="headerlink" title="time.Now ä¼˜åŒ–"></a>time.Now ä¼˜åŒ–</h1><p>è¯´åˆ°è¿™é‡Œï¼Œå¤§å®¶åº”è¯¥å°±èƒ½å‘ç°é—®é¢˜æ‰€åœ¨äº†â€”â€”<code>time.Now</code>è°ƒç”¨äº†ä¸€æ¬¡<code>walltime</code>å’Œä¸€æ¬¡<code>nanotime</code>ï¼Œè¿™ä¸¤æ¬¡è°ƒç”¨éƒ½æœ‰å‡ ä¹ä¸€æ ·çš„åˆ‡æ¢åˆ°<code>g0</code>æ ˆå†æ¢å¤çš„ä»£ç ï¼Œè€Œä¸”è¿™æ®µä»£ç é‡è¿˜æ¯”è¾ƒå¤šã€‚å¦‚æœæˆ‘ä»¬æŠŠè¿™ä¸¤æ¬¡è°ƒç”¨ç»™åˆå¹¶åˆ°ä¸€èµ·ï¼Œå°±å¯ä»¥èŠ‚çœä¸€æ¬¡åˆ‡æ¢æ ˆå’Œå‡†å¤‡å·¥ä½œå¯¼è‡´çš„é¢å¤–å¼€é”€äº†ï¼</p><p>Go å®˜æ–¹å›¢é˜Ÿçš„ Ian å¤§ä½¬å’Œæˆ‘ï¼ˆå‡ ä¹ï¼‰åŒæ—¶æäº†å¯¹åº”çš„ pr æ¥ä¼˜åŒ–è¿™éƒ¨åˆ†çš„é€»è¾‘ï¼Œæœ€ç»ˆ Ian å¤§ä½¬å®ç°çš„æ€§èƒ½æ›´å¥½ï¼ˆ-20%ï¼Œ<a href="https://go-review.googlesource.com/c/go/+/314571">æˆ‘çš„ç‰ˆæœ¬</a>æ˜¯ -17%ï¼‰ï¼Œäºæ˜¯æœ€ç»ˆé‡‡ç”¨çš„æ˜¯ Ian å¤§ä½¬çš„ç‰ˆæœ¬ï¼š<a href="https://go-review.googlesource.com/c/go/+/314277/%E3%80%82">https://go-review.googlesource.com/c/go/+/314277/ã€‚</a></p><h1 id="åœ¨runtimeå¤–è°ƒç”¨vdsoï¼Ÿ"><a href="#åœ¨runtimeå¤–è°ƒç”¨vdsoï¼Ÿ" class="headerlink" title="åœ¨runtimeå¤–è°ƒç”¨vdsoï¼Ÿ"></a>åœ¨<code>runtime</code>å¤–è°ƒç”¨<code>vdso</code>ï¼Ÿ</h1><p>å›åˆ°å¼€å¤´ï¼Œæˆ‘æ˜¯æƒ³è‡ªå·±å®ç°<code>clock_gettime</code>çš„<code>CLOCK_REALTIME_COARSE</code>å’Œ<code>CLOCK_MONOTONIC_COARSE</code>ï¼Œè¿™å°±éœ€è¦æˆ‘åœ¨<code>runtime</code>åŒ…å¤–éƒ¨å®ç°ä»¥ä¸Šçš„ä¸€ç³»åˆ—æ“ä½œã€‚ä½†æ˜¯å¦‚æœè¦è¿™ä¹ˆå¹²ï¼Œå°±éœ€è¦æŠŠæ‰€æœ‰<code>runtime</code>åŒ…é‡Œé¢çš„ç»“æ„ä½“å®šä¹‰å…¨éƒ¨å¤åˆ¶ä¸€ä»½ï¼ˆè¿™æ ·åœ¨æ±‡ç¼–ä»£ç é‡Œé¢ include çš„ <code>go_asm.h</code>æ‰æœ‰å¯¹åº”çš„åç§»é‡ï¼‰ï¼Œè¿™æ ·å¯ç»´æŠ¤æ€§å¤ªå·®äº†ï¼Œè€Œä¸”å¦‚æœæŸä¸ªç‰ˆæœ¬è°ƒæ•´äº†ç»“æ„ä½“çš„é¡ºåºï¼Œè¡Œä¸ºå°±ä¸å¯å®šä¹‰ï¼Œå¤ªå±é™©äº†ï¼Œè¦ä¸å°±å¾—æ¯ä¸ªç‰ˆæœ¬å•ç‹¬å¤åˆ¶ä¸€ä»½å‡ºæ¥ã€‚</p><p>é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œä¹Ÿå’Œ Go å®˜æ–¹è¿›è¡Œäº†è®¨è®ºï¼Œæœ€ç»ˆç¡®å®æ²¡æœ‰ä»€ä¹ˆå¤ªå¥½çš„æ€è·¯ï¼ŒGo ç›®å‰ä¸æ”¯æŒåœ¨<code>runtime</code>å¤–éƒ¨å®‰å…¨åœ°è°ƒç”¨<code>vdso</code>ã€‚</p><p>ä¸è¿‡ä¸ç®¡æ€ä¹ˆæ ·ï¼Œåœ¨è¿™ä¸ªè®¨è®ºçš„è¿‡ç¨‹ä¸­ï¼Œä¿ƒæˆäº†<code>time.Now</code>çš„ä¼˜åŒ–ï¼Œè¿˜æ˜¯ä¸æ‰æ­¤è¡Œã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;ç¼˜èµ·&quot;&gt;&lt;a href=&quot;#ç¼˜èµ·&quot; class=&quot;headerlink&quot; title=&quot;ç¼˜èµ·&quot;&gt;&lt;/a&gt;ç¼˜èµ·&lt;/h1&gt;&lt;p&gt;æœ€è¿‘æƒ³å°è¯•åœ¨ Golang é‡Œé¢å®ç°&lt;code&gt;clock_gettime&lt;/code&gt;çš„&lt;code&gt;CLOCK_REALTIME_COARSE&lt;/code&gt;å’Œ&lt;code&gt;CLOCK_MONOTONIC_COARSE&lt;/code&gt;ï¼Œæ­£å¥½æ·±å…¥ç ”ç©¶äº†ä¸‹ &lt;code&gt;time.Now&lt;/code&gt;çš„å®ç°ï¼Œè¿˜æœºç¼˜å·§åˆä¸‹é¡ºä¾¿ä¼˜åŒ–äº†ä¸€æŠŠ&lt;code&gt;time.Now&lt;/code&gt;ï¼ˆè™½ç„¶æœ€ç»ˆæäº¤çš„æ˜¯ Ian å¤§ä½¬çš„ç‰ˆæœ¬ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨è¿™é‡Œè®°å½•ä¸‹æ¥æ•´ä¸ªè¿‡ç¨‹ï¼Œä»¥ä¾›æŸ¥é˜…ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="go" scheme="https://www.purewhite.io/categories/go/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="go" scheme="https://www.purewhite.io/tags/go/"/>
    
    <category term="asm" scheme="https://www.purewhite.io/tags/asm/"/>
    
  </entry>
  
  <entry>
    <title>Golang æ³›å‹åˆæ¢</title>
    <link href="https://www.purewhite.io/2021/03/09/golang-generic-glance/"/>
    <id>https://www.purewhite.io/2021/03/09/golang-generic-glance/</id>
    <published>2021-03-09T09:24:55.000Z</published>
    <updated>2021-12-02T12:51:07.225Z</updated>
    
    <content type="html"><![CDATA[<p>Golang çš„æ³›å‹å®ç°å·²ç»æ­£å¼åˆå¹¶åˆ° master åˆ†æ”¯ä¸Šå•¦ï¼Œä¹‹åä¹Ÿä¼šåœ¨ master åˆ†æ”¯ä¸Šè¿›è¡Œå¼€å‘ï¼Œé‚£ä¹ˆä½œä¸ºæœŸå¾…è¿™ä¸ª feature è®¸ä¹…çš„ gopherï¼Œä¹Ÿæƒ³ç¬¬ä¸€æ—¶é—´çœ‹çœ‹åˆ°åº•æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><span id="more"></span><h1 id="è¯­æ³•"><a href="#è¯­æ³•" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h1><p>è¿™é‡Œä¸è¿‡å¤šè®²è§£æ³›å‹çš„è¯­æ³•ï¼Œå…·ä½“å¯ä»¥å‚è€ƒä¸€ä¸‹ <a href="https://github.com/golang/go/issues/43651">https://github.com/golang/go/issues/43651</a> è¿™ä¸ª issueã€‚</p><p>ç®€å•æ¥è¯´ï¼Œåœ¨ struct å’Œ func çš„åå­—åé¢å¯ä»¥åŠ ä¸€ä¸ª [] é‡Œé¢åŒ…å«æ³›å‹çš„åå­—å’Œé™åˆ¶æ¡ä»¶ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> container[T any] <span class="keyword">struct</span>&#123;</span><br><span class="line">    elem T</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>any æ˜¯ä¸ªç‰¹æ®Šçš„å…³é”®å­—ï¼Œè¡¨ç¤ºæ‰€æœ‰ç±»å‹éƒ½å¯ä»¥ã€‚</p><h1 id="ç¤ºä¾‹ç¨‹åº"><a href="#ç¤ºä¾‹ç¨‹åº" class="headerlink" title="ç¤ºä¾‹ç¨‹åº"></a>ç¤ºä¾‹ç¨‹åº</h1><p>è¿™é‡Œæˆ‘ä»¬å†™ä¸€ä¸ªç¤ºä¾‹ç¨‹åºæ¥ç¼–è¯‘æˆæ±‡ç¼–ï¼Œæ¥çœ‹çœ‹æ³›å‹åˆ°åº•æ˜¯æ€ä¹ˆå®ç°çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Stringer <span class="keyword">interface</span> &#123;</span><br><span class="line">String() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Stringer2 <span class="keyword">interface</span> &#123;</span><br><span class="line">Stringer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> container[T Stringer] <span class="keyword">struct</span> &#123;</span><br><span class="line">s T</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> stringerImpl <span class="keyword">struct</span> &#123;</span><br><span class="line">s <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s stringerImpl)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> s.s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loop</span>[<span class="title">T</span> <span class="title">any</span>]<span class="params">(s []T)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> s &#123;</span><br><span class="line">_ = v</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">loop([]<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;)</span><br><span class="line"></span><br><span class="line">c := container[Stringer2]&#123;&#125;</span><br><span class="line">loop([]container[Stringer2]&#123;c&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ç¼–è¯‘æˆæ±‡ç¼–"><a href="#ç¼–è¯‘æˆæ±‡ç¼–" class="headerlink" title="ç¼–è¯‘æˆæ±‡ç¼–"></a>ç¼–è¯‘æˆæ±‡ç¼–</h1><p>æˆ‘ä»¬å…ˆåŸºäº master åˆ†æ”¯æ¥ç¼–è¯‘ä¸€ä¸ª go å‡ºæ¥ï¼Œç„¶åç”¨è¿™ä¸ª go æ¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> go build -gcflags=<span class="string">&quot;-G=3 -l -S&quot;</span> main.go &gt; main.s 2&gt;&amp;1</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å»<code>main.s</code>è¿™ä¸ªæ–‡ä»¶çœ‹çœ‹ï¼Œå°±ä¼šå‘ç°æœ‰è¿™ä¹ˆä¸€æ®µä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&quot;&quot;.#loop[int] STEXT nosplit size=18 args=0x18 locals=0x0 funcid=0x0</span><br><span class="line">0x0000 00000 (/Users/purewhite/go/src/local/study/main.go:39)TEXT&quot;&quot;.#loop[int](SB), NOSPLIT|ABIInternal, $0-24</span><br><span class="line">0x0000 00000 (/Users/purewhite/go/src/local/study/main.go:39)FUNCDATA$0, gclocalsÂ·1a65e721a2ccc325b382662e7ffee780(SB)</span><br><span class="line">0x0000 00000 (/Users/purewhite/go/src/local/study/main.go:39)FUNCDATA$1, gclocalsÂ·69c1753bd5f81501d95132d08af04464(SB)</span><br><span class="line">0x0000 00000 (/Users/purewhite/go/src/local/study/main.go:33)MOVQ&quot;&quot;.s+16(SP), AX</span><br><span class="line">0x0005 00005 (/Users/purewhite/go/src/local/study/main.go:33)XORLCX, CX</span><br><span class="line">0x0007 00007 (/Users/purewhite/go/src/local/study/main.go:33)JMP12</span><br><span class="line">0x0009 00009 (/Users/purewhite/go/src/local/study/main.go:33)INCQCX</span><br><span class="line">0x000c 00012 (/Users/purewhite/go/src/local/study/main.go:33)CMPQAX, CX</span><br><span class="line">0x000f 00015 (/Users/purewhite/go/src/local/study/main.go:33)JGT9</span><br><span class="line">0x0011 00017 (/Users/purewhite/go/src/local/study/main.go:33)RET</span><br><span class="line">0x0000 48 8b 44 24 10 31 c9 eb 03 48 ff c1 48 39 c8 7f  H.D$.1...H..H9..</span><br><span class="line">0x0010 f8 c3                                            ..</span><br><span class="line">&quot;&quot;.#loop[container[Stringer2]] STEXT nosplit size=21 args=0x18 locals=0x0 funcid=0x0</span><br><span class="line">0x0000 00000 (/Users/purewhite/go/src/local/study/main.go:44)TEXT&quot;&quot;.#loop[container[Stringer2]](SB), NOSPLIT|ABIInternal, $0-24</span><br><span class="line">0x0000 00000 (/Users/purewhite/go/src/local/study/main.go:44)FUNCDATA$0, gclocalsÂ·1a65e721a2ccc325b382662e7ffee780(SB)</span><br><span class="line">0x0000 00000 (/Users/purewhite/go/src/local/study/main.go:44)FUNCDATA$1, gclocalsÂ·69c1753bd5f81501d95132d08af04464(SB)</span><br><span class="line">0x0000 00000 (/Users/purewhite/go/src/local/study/main.go:33)MOVQ&quot;&quot;.s+16(SP), AX</span><br><span class="line">0x0005 00005 (/Users/purewhite/go/src/local/study/main.go:33)TESTQAX, AX</span><br><span class="line">0x0008 00008 (/Users/purewhite/go/src/local/study/main.go:33)JLE20</span><br><span class="line">0x000a 00010 (/Users/purewhite/go/src/local/study/main.go:33)XORLCX, CX</span><br><span class="line">0x000c 00012 (/Users/purewhite/go/src/local/study/main.go:33)INCQCX</span><br><span class="line">0x000f 00015 (/Users/purewhite/go/src/local/study/main.go:33)CMPQAX, CX</span><br><span class="line">0x0012 00018 (/Users/purewhite/go/src/local/study/main.go:33)JGT12</span><br><span class="line">0x0014 00020 (/Users/purewhite/go/src/local/study/main.go:33)RET</span><br><span class="line">0x0000 48 8b 44 24 10 48 85 c0 7e 0a 31 c9 48 ff c1 48  H.D$.H..~.1.H..H</span><br><span class="line">0x0010 39 c8 7f f8 c3                                   9....</span><br></pre></td></tr></table></figure><p>å†çœ‹ main ä¸­è°ƒç”¨çš„åœ°æ–¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x008c 00140 (/Users/purewhite/go/src/local/study/main.go:39)CALL&quot;&quot;.#loop[int](SB)</span><br><span class="line">...</span><br><span class="line">0x00c0 00192 (/Users/purewhite/go/src/local/study/main.go:44)CALL&quot;&quot;.#loop[container[Stringer2]](SB)</span><br></pre></td></tr></table></figure><p>åŸºæœ¬å¯ä»¥ç¡®å®šï¼Œgo çš„æ³›å‹ç›®å‰çš„å®ç°æ–¹æ¡ˆæ˜¯åœ¨ç¼–è¯‘æ—¶è¿›è¡Œä»£ç ç”Ÿæˆï¼Œè¿™ä¸ªæ–¹æ¡ˆè™½ç„¶ä¼šé™ä½ç¼–è¯‘é€Ÿåº¦ï¼Œä½†æ˜¯åœ¨è¿è¡Œæ—¶æ˜¯æ²¡æœ‰æ€§èƒ½æŸè€—çš„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Golang çš„æ³›å‹å®ç°å·²ç»æ­£å¼åˆå¹¶åˆ° master åˆ†æ”¯ä¸Šå•¦ï¼Œä¹‹åä¹Ÿä¼šåœ¨ master åˆ†æ”¯ä¸Šè¿›è¡Œå¼€å‘ï¼Œé‚£ä¹ˆä½œä¸ºæœŸå¾…è¿™ä¸ª feature è®¸ä¹…çš„ gopherï¼Œä¹Ÿæƒ³ç¬¬ä¸€æ—¶é—´çœ‹çœ‹åˆ°åº•æ˜¯å¦‚ä½•å®ç°çš„ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="go" scheme="https://www.purewhite.io/categories/go/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="go" scheme="https://www.purewhite.io/tags/go/"/>
    
    <category term="asm" scheme="https://www.purewhite.io/tags/asm/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ SIMD ä¼˜åŒ– Thrift ç¼–ç </title>
    <link href="https://www.purewhite.io/2021/01/06/simd-optimize-thrift/"/>
    <id>https://www.purewhite.io/2021/01/06/simd-optimize-thrift/</id>
    <published>2021-01-06T07:41:29.000Z</published>
    <updated>2021-12-02T12:51:07.230Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰æƒ…æè¦"><a href="#å‰æƒ…æè¦" class="headerlink" title="å‰æƒ…æè¦"></a>å‰æƒ…æè¦</h1><p>å¯ä»¥å…ˆçœ‹ä¸‹æˆ‘ä¹‹å‰åœ¨ JTalk ä¸Šåˆ†äº«çš„å®è·µï¼š<a href="https://www.bilibili.com/video/BV1UZ4y1g7ju">https://www.bilibili.com/video/BV1UZ4y1g7ju</a></p><p>è¿™ç¯‡æ–‡ç« æ˜¯å¯¹äºå…¶ä¸­æˆ‘æœ€åè¯´çš„â€œä½¿ç”¨ SIMD ä¼˜åŒ–â€éƒ¨åˆ†çš„è¯¦ç»†è¯´æ˜ã€‚</p><h1 id="TLï¼›DR"><a href="#TLï¼›DR" class="headerlink" title="TLï¼›DR"></a>TLï¼›DR</h1><p>List&lt;i64&gt; åœºæ™¯ä¸‹æå‡å…­å€ï¼ŒList&lt;i32&gt; æå‡åäºŒå€ã€‚</p><span id="more"></span><h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>åŸºäº FastRead/Write æ¥å£ï¼Œç”±äºæˆ‘ä»¬å·²ç»æ‹¿åˆ°äº†æ‰€æœ‰çš„å†…å­˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°è¯•é‡‡ç”¨ SIMD æ¥è¿›ä¸€æ­¥çš„ä¼˜åŒ–ã€‚</p><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><p>æœ€å®¹æ˜“æƒ³åˆ°çš„ä¼˜åŒ–ç‚¹ä¹Ÿæ˜¯å…¬å¸å†…æœ€å¸¸è§çš„ç”¨æ³• list&lt;i64/i32&gt;ï¼Œè¿™ä¸ªæ¯”è¾ƒå®¹æ˜“æƒ³åˆ°ä½¿ç”¨ SIMD è¿›è¡Œä¼˜åŒ–ã€‚</p><p>åœ¨ thrift binary é‡Œé¢ï¼Œint ç±»å‹åœ¨å¤åˆ¶åˆ° buffer ä¹‹å‰éœ€è¦å…ˆè½¬æˆå¤§ç«¯ï¼Œä¹Ÿå°±æ˜¯ binary.BigEndian.PutInt ä¸€æ¬¡ï¼Œè¿™ä¸ªæ“ä½œåŸæœ¬éœ€è¦æ¯”è¾ƒå¤šè¯­å¥ï¼Œé€šè¿‡è½¯ä»¶æ¥æ¨¡æ‹Ÿï¼Œä½†æ˜¯åœ¨ amd64 ä¸‹æœ‰ä¸€ä¸ª BSWAP æŒ‡ä»¤å¯ä»¥ç›´æ¥å®Œæˆï¼Œè¿™ä¸ªä¼˜åŒ– Go ç¼–è¯‘å™¨å·²ç»åšäº†ï¼Œæ‰€ä»¥ç°åœ¨çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> src, dst</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>; i++ &#123;</span><br><span class="line">    dst[i] = bswap(src[i])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™ä¸ªæ“ä½œå®é™…ä¸Šæ˜¯å¾ˆæœ‰è§„å¾‹çš„ï¼Œå¹¶ä¸”å…¨éƒ½æ˜¯ç›¸é‚»çš„æ“ä½œï¼Œç¬¦åˆ SIMD æŒ‡ä»¤çš„æ¨¡å¼ã€‚</p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><p>å…ˆä½¿ç”¨äº† C++ åšäº†ä¸€ä¸ª POCï¼ˆåªè´´äº†å…³é”®ä»£ç ï¼Œå®Œæ•´ä»£ç è§ <a href="https://gist.github.com/PureWhiteWu/e88f241fc8b62df06ae1eb04923a88ae%EF%BC%89%EF%BC%9A">https://gist.github.com/PureWhiteWu/e88f241fc8b62df06ae1eb04923a88aeï¼‰ï¼š</a></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> MASK = <span class="number">0x0001020304050607</span>;</span><br><span class="line"><span class="keyword">const</span> __mmask16 bit16mask[<span class="number">17</span>] = &#123;<span class="number">0x0000</span>, <span class="number">0x0001</span>, <span class="number">0x0003</span>, <span class="number">0x0007</span>, <span class="number">0x000f</span>, <span class="number">0x001f</span>, <span class="number">0x003f</span>, <span class="number">0x007f</span>, <span class="number">0x00ff</span>, <span class="number">0x01ff</span>, <span class="number">0x03ff</span>, <span class="number">0x07ff</span>, <span class="number">0x0fff</span>, <span class="number">0x1fff</span>, <span class="number">0x3fff</span>, <span class="number">0x7fff</span>, <span class="number">0xffff</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">avx512_little_2_big</span><span class="params">(<span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> *src, <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> *dst, <span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> loop_count = n / <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">int</span> remainder = n % <span class="number">8</span>;</span><br><span class="line">    __m512i mask = _mm512_set1_epi64(MASK);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loop_count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> index = i * <span class="number">8</span>;</span><br><span class="line">        __m512i input_data = _mm512_loadu_si512(&amp;src[index]);</span><br><span class="line">        __m512i output_data = _mm512_shuffle_epi8(input_data, mask);</span><br><span class="line">        _mm512_storeu_si512(&amp;avx512_data[index], output_data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (remainder != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> index = loop_count * <span class="number">8</span>;</span><br><span class="line">        __m512i padding = _mm512_set1_epi64(<span class="number">0</span>);</span><br><span class="line">        __m512i input_data = _mm512_mask_loadu_epi64(padding, bit16mask[remainder], &amp;src[index]);</span><br><span class="line">        __m512i output_data = _mm512_shuffle_epi8(input_data, mask);</span><br><span class="line">        _mm512_mask_storeu_epi64(&amp;avx512_data[index], bit16mask[remainder], output_data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">avx2_little_2_big</span><span class="params">(<span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> *src, <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> *dst, <span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> loop_count = n / <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">int</span> remainder = n % <span class="number">4</span>;</span><br><span class="line">    __m256i mask = _mm256_set1_epi64x(MASK);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loop_count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> index = i * <span class="number">4</span>;</span><br><span class="line">        __m256i input_data = _mm256_loadu_si256((__m256i *)&amp;src[index]);</span><br><span class="line">        __m256i output_data = _mm256_shuffle_epi8(input_data, mask);</span><br><span class="line">        _mm256_storeu_si256((__m256i *)&amp;avx2_data[index], output_data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (remainder != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> index = loop_count * <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = index; i &lt; index + remainder; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            avx2_data[i] = <span class="built_in">bswap_64</span>(src[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æµ‹è¯•ç»“æœ"><a href="#æµ‹è¯•ç»“æœ" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h1><p>ç¼–è¯‘å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">$</span> <span class="comment">g</span>++ <span class="comment">little_2_big_gcc</span><span class="string">.</span><span class="comment">cpp</span> <span class="literal">-</span><span class="comment">o</span> <span class="comment">ll2</span> <span class="literal">-</span><span class="comment">mavx512f</span> <span class="literal">-</span><span class="comment">mavx512bw</span> <span class="literal">-</span><span class="comment">mavx2</span> <span class="literal">-</span><span class="comment">mavx</span> <span class="literal">-</span><span class="comment">O3</span></span><br></pre></td></tr></table></figure><p>åœ¨ linux ç‰©ç†æœºä¸Šè¿›è¡Œæµ‹è¯•ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">avx512</span> time: <span class="number">27009</span> us</span><br><span class="line"><span class="attribute">avx2</span> time: <span class="number">21920</span> us</span><br><span class="line"><span class="attribute">bswap</span> time: <span class="number">49967</span> us</span><br></pre></td></tr></table></figure><p>å¯ä»¥å¾—å‡ºç»“è®ºï¼š</p><ol><li>avx512 çš„æ€§èƒ½å¾ˆä¸ç¨³å®šï¼Œæœ‰äº›æƒ…å†µä¸‹è¿˜ä¸å¦‚ avx2ï¼›</li><li>avx2 ç›¸æ¯” bswap æ–¹æ¡ˆåŸºæœ¬å¯ä»¥æå‡ä¸€å€ä»¥ä¸Šçš„æ€§èƒ½ï¼›</li><li>Linus è¯šä¸æ¬ºæˆ‘ã€‚</li></ol><h1 id="è¯¦ç»†è§£é‡Š"><a href="#è¯¦ç»†è§£é‡Š" class="headerlink" title="è¯¦ç»†è§£é‡Š"></a>è¯¦ç»†è§£é‡Š</h1><p>bswap åšçš„äº‹æƒ…æ˜¯å°†æ•´ä¸ªå­—èŠ‚åºè¿›è¡Œå€’åºï¼Œä»¥ int32 ä¸ºä¾‹ï¼ŒåŒ…å« 4 å­—èŠ‚ï¼Œå‡è®¾åŸæ¥æ•°æ®å¦‚ä¸‹ï¼š</p><p>00000000 00000001 00000010 00000011</p><p>é‚£ä¹ˆ bswap ä¹‹åï¼Œæ•°æ®ä¸ºï¼š</p><p>00000011 00000010 00000001 00000000</p><p>åœ¨ avx2 ä¸­ï¼Œä¹Ÿæœ‰ä¸€ä¸ªæŒ‡ä»¤ vpshufb èƒ½å¤Ÿè¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœï¼Œä¸è¿‡ä¸æ˜¯çº¯ç²¹çš„ bswapï¼Œè¯¦è§ï¼š<a href="https://software.intel.com/content/www/us/en/develop/documentation/cpp-compiler-developer-guide-and-reference/top/compiler-reference/intrinsics/intrinsics-for-intel-advanced-vector-extensions-2/intrinsics-for-shuffle-operations-1/mm256-shuffle-epi8.html">https://software.intel.com/content/www/us/en/develop/documentation/cpp-compiler-developer-guide-and-reference/top/compiler-reference/intrinsics/intrinsics-for-intel-advanced-vector-extensions-2/intrinsics-for-shuffle-operations-1/mm256-shuffle-epi8.html</a></p><p>shuffle çš„æ„æ€æ˜¯â€œæ´—ç‰Œâ€ï¼Œä½œç”¨æ˜¯å¯ä»¥æ ¹æ®ä¸€ä¸ªä¼ å…¥çš„ mask æ¥é‡æ’å¯¹åº” byte çš„ä½ç½®ã€‚æ‰€ä»¥è¿™é‡Œæœ€å…³é”®çš„å°±æ˜¯ä»£ç ç¤ºä¾‹ä¸­æœ€ä¸Šé¢é‚£è¡Œï¼š</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> MASK = <span class="number">0x0001020304050607</span>;</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆç”¨è¿™ä¸ª mask å°±è¡Œäº†å‘¢ï¼Ÿæˆ‘ä»¬å¾—å¤ä¹ ä¸€ä¸‹å¤§å°ç«¯çš„çŸ¥è¯†ã€‚</p><p>å¤§ç«¯å­—èŠ‚åºæ˜¯ç¬¦åˆäººç±»é˜…è¯»ä¹ æƒ¯çš„é¡ºåºï¼Œé«˜ä½åœ¨å‰ï¼Œè¿˜æ˜¯ä»¥åˆšæ‰çš„ int32 ä½œä¸ºä¾‹å­ï¼Œå‡å¦‚å¤§ç«¯åºè¡¨ç¤ºå¦‚ä¸‹ï¼š</p><p>00000011ï¼ˆé«˜ä½åœ¨è¿™é‡Œï¼‰ 00000010 00000001 00000000</p><p>é‚£ä¹ˆåœ¨æˆ‘ä»¬ç”µè„‘ä¸Šï¼Œå°ç«¯å­—èŠ‚åºå°±æ˜¯è¿™ä¹ˆå­˜çš„ï¼š</p><table><thead><tr><th>å†…å­˜åœ°å€</th><th>0</th><th>1</th><th>2</th><th>3ï¼ˆé«˜ä½åœ¨è¿™é‡Œï¼‰</th></tr></thead><tbody><tr><td>å€¼</td><td>00000000</td><td>00000001</td><td>00000010</td><td>00000011</td></tr></tbody></table><p>è¿™æ—¶å€™å¯¹åº”çš„ MASK æ˜¯ 0x00010203ï¼Œåœ¨å†…å­˜ä¸­ä»¥å°ç«¯åºè¡¨ç¤ºä¸ºï¼š</p><table><thead><tr><th>å†…å­˜åœ°å€</th><th>0</th><th>1</th><th>2</th><th>3ï¼ˆé«˜ä½åœ¨è¿™é‡Œï¼‰</th></tr></thead><tbody><tr><td>å€¼</td><td>3</td><td>2</td><td>1</td><td>0</td></tr></tbody></table><p>æˆ‘ä»¬çš„æœºå™¨éƒ½æ˜¯å°ç«¯åºçš„ï¼Œæ‰€ä»¥ï¼Œåœ¨åš shuffle çš„æ—¶å€™ï¼Œå†…å­˜åœ°å€ 0 å¯¹åº”çš„æ˜¯ å†…å­˜åœ°å€ 3 å¤„çš„å€¼ï¼Œå†…å­˜åœ°å€ 1 å¯¹åº”çš„æ˜¯ å†…å­˜åœ°å€ 2 å¤„çš„å€¼ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p><p>è¿™æ ·ï¼Œshuffle è®¡ç®—ä¸‹æ¥ä¹‹åï¼Œå†…å­˜ä¸­çš„å€¼å°±å˜æˆäº†ï¼š</p><table><thead><tr><th>å†…å­˜åœ°å€</th><th>0</th><th>1</th><th>2</th><th>3</th></tr></thead><tbody><tr><td>å€¼</td><td>00000011</td><td>00000010</td><td>00000001</td><td>00000000</td></tr></tbody></table><p><img data-src="https://static-ali-oss.purewhite.io/uPic/2021-01-06/124kux-image-20210106162329929.png!webp_90" alt="shuffle"></p><p>è¿™æ—¶å€™ï¼Œä¹Ÿå°±ç›¸å½“äºæˆåŠŸå®Œæˆäº†ä¸€æ¬¡ bswap çš„æ“ä½œäº†ã€‚</p><p>ç”±äº int64 æœ‰ 8 ä½ï¼Œæ‰€ä»¥ MASK ä¸º 0x00 01 02 03 04 05 06 07 å°±å¯ä»¥å®Œæˆä¸€æ¬¡ int64 çš„ bswapã€‚</p><p><em>ï¼ˆæ³¨ï¼šæ²¡æœ‰ 0 é”®åœ¨ç¼–å†™æ­¤èŠ‚æ—¶é­åˆ°è™å¾…ï¼‰</em></p><h1 id="Go-ä¸­æµ‹è¯•ç»“æœ"><a href="#Go-ä¸­æµ‹è¯•ç»“æœ" class="headerlink" title="Go ä¸­æµ‹è¯•ç»“æœ"></a>Go ä¸­æµ‹è¯•ç»“æœ</h1><p>æœ€åé™„ä¸Š Go ä¸­çš„æµ‹è¯•ç»“æœï¼Œæˆ‘ä»¬æµ‹è¯•äº† List ä¸­æœ‰ 12345 ä¸ªå…ƒç´ çš„ benchmarkï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">BenchmarkWriteListI64</span></span><br><span class="line"><span class="attribute">BenchmarkWriteListI64</span>-<span class="number">16</span>         <span class="number">703928</span>         <span class="number">1753</span> ns/op</span><br><span class="line"><span class="attribute">BenchmarkWriteI64</span></span><br><span class="line"><span class="attribute">BenchmarkWriteI64</span>-<span class="number">16</span>              <span class="number">98204</span>        <span class="number">11875</span> ns/op</span><br><span class="line"><span class="attribute">BenchmarkWriteListI32</span></span><br><span class="line"><span class="attribute">BenchmarkWriteListI32</span>-<span class="number">16</span>        <span class="number">1300507</span>          <span class="number">907</span> ns/op</span><br><span class="line"><span class="attribute">BenchmarkWriteI32</span></span><br><span class="line"><span class="attribute">BenchmarkWriteI32</span>-<span class="number">16</span>              <span class="number">98522</span>        <span class="number">12580</span> ns/op</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œåœ¨ Go ä¸Šçš„æ€§èƒ½æå‡éå¸¸å·¨å¤§ï¼ŒList&lt;i64&gt; åœºæ™¯ä¸‹æå‡å…­å€ï¼ŒList&lt;i32&gt; æ›´æ˜¯æå‡äº†åå‡ å€ã€‚</p><p>ç©¶å…¶åŸå› ï¼Œåº”è¯¥æ˜¯ Go åšçš„ä¼˜åŒ–å¤ªå°‘å¤ªå·®ï¼Œè¿œè¿œæ¯”ä¸ä¸Š gccã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰æƒ…æè¦&quot;&gt;&lt;a href=&quot;#å‰æƒ…æè¦&quot; class=&quot;headerlink&quot; title=&quot;å‰æƒ…æè¦&quot;&gt;&lt;/a&gt;å‰æƒ…æè¦&lt;/h1&gt;&lt;p&gt;å¯ä»¥å…ˆçœ‹ä¸‹æˆ‘ä¹‹å‰åœ¨ JTalk ä¸Šåˆ†äº«çš„å®è·µï¼š&lt;a href=&quot;https://www.bilibili.com/video/BV1UZ4y1g7ju&quot;&gt;https://www.bilibili.com/video/BV1UZ4y1g7ju&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;è¿™ç¯‡æ–‡ç« æ˜¯å¯¹äºå…¶ä¸­æˆ‘æœ€åè¯´çš„â€œä½¿ç”¨ SIMD ä¼˜åŒ–â€éƒ¨åˆ†çš„è¯¦ç»†è¯´æ˜ã€‚&lt;/p&gt;
&lt;h1 id=&quot;TLï¼›DR&quot;&gt;&lt;a href=&quot;#TLï¼›DR&quot; class=&quot;headerlink&quot; title=&quot;TLï¼›DR&quot;&gt;&lt;/a&gt;TLï¼›DR&lt;/h1&gt;&lt;p&gt;List&amp;lt;i64&amp;gt; åœºæ™¯ä¸‹æå‡å…­å€ï¼ŒList&amp;lt;i32&amp;gt; æå‡åäºŒå€ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="go" scheme="https://www.purewhite.io/categories/go/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="go" scheme="https://www.purewhite.io/tags/go/"/>
    
    <category term="asm" scheme="https://www.purewhite.io/tags/asm/"/>
    
  </entry>
  
  <entry>
    <title>æ˜é‡‘JTalk Meetup 11æœŸ - Golang è¿›é˜¶æŒ‡å—å’Œæœ€ä½³å®è·µ</title>
    <link href="https://www.purewhite.io/2020/12/21/jtalk-11-golang/"/>
    <id>https://www.purewhite.io/2020/12/21/jtalk-11-golang/</id>
    <published>2020-12-21T05:54:15.000Z</published>
    <updated>2021-12-02T12:51:07.227Z</updated>
    
    <content type="html"><![CDATA[<h1 id="è§†é¢‘"><a href="#è§†é¢‘" class="headerlink" title="è§†é¢‘"></a>è§†é¢‘</h1><p><a href="https://www.bilibili.com/video/BV1UZ4y1g7ju">https://www.bilibili.com/video/BV1UZ4y1g7ju</a></p><h1 id="PPT-ä¸‹è½½"><a href="#PPT-ä¸‹è½½" class="headerlink" title="PPT ä¸‹è½½"></a>PPT ä¸‹è½½</h1><p>é“¾æ¥: <a href="https://pan.baidu.com/s/1w8TKFZcFbAi-ug26pzkxug">https://pan.baidu.com/s/1w8TKFZcFbAi-ug26pzkxug</a>  å¯†ç : vvbh</p><p>è§£å‹å¯†ç ï¼špurewhite.io</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;è§†é¢‘&quot;&gt;&lt;a href=&quot;#è§†é¢‘&quot; class=&quot;headerlink&quot; title=&quot;è§†é¢‘&quot;&gt;&lt;/a&gt;è§†é¢‘&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://www.bilibili.com/video/BV1UZ4y1g7ju&quot;&gt;https://www.bili</summary>
      
    
    
    
    <category term="go" scheme="https://www.purewhite.io/categories/go/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="go" scheme="https://www.purewhite.io/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨äººå·¥æ™ºèƒ½ä¼˜åŒ– Golang ç¼–è¯‘å™¨</title>
    <link href="https://www.purewhite.io/2020/10/14/manual-intelligence-optimize-golang-compiler/"/>
    <id>https://www.purewhite.io/2020/10/14/manual-intelligence-optimize-golang-compiler/</id>
    <published>2020-10-14T08:26:00.000Z</published>
    <updated>2021-12-02T12:51:07.228Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ‰å¤šå°‘äººå·¥å°±æœ‰å¤šå°‘æ™ºèƒ½ã€‚                            â€”â€”é²è¿…</p></blockquote><h1 id="ç¼˜èµ·"><a href="#ç¼˜èµ·" class="headerlink" title="ç¼˜èµ·"></a>ç¼˜èµ·</h1><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œå­—èŠ‚è·³åŠ¨å†…éƒ¨ä¸»è¦ä½¿ç”¨ Thriftï¼Œä¸ºäº†æ›´å¥½åœ°æŒæ§ç”Ÿæˆä»£ç ï¼Œæˆ‘ä»¬ç”¨ Go è‡ªå·±å®ç°äº† Thrift ä»£ç ç”Ÿæˆå·¥å…·ã€‚</p><p>è€Œæˆ‘ä»¬çš„æ•…(shi)äº‹(gu)ï¼Œæ­£æ˜¯ç”±ä¸€æ¬¡é‡æ„å¼€å§‹â€¦â€¦</p><span id="more"></span><p>åœ¨ä¸€æ¬¡å¹³æ·¡æ— å¥‡çš„é‡æ„å‘ç‰ˆåï¼Œæ­£å½“æˆ‘æ‹ç€ç”µè„‘åŒ…å¾€å¤–å†²å¿ƒé‡Œå·²ç»ç›˜ç®—å¥½äº†å›å»ä¹‹åè¦æ‹¿å‡ºæˆ‘ç†Ÿç»ƒåº¦ 30W çš„è‡³è‡» KDA å¡èå¤§æ€å››æ–¹æ—¶ï¼Œä¸šåŠ¡æ–¹æ‹‰ä½äº†æˆ‘ï¼Œå‘Šè¯‰æˆ‘ä»–ä»¬åœ¨ç”¨äº†æ–°ç‰ˆçš„ç”Ÿæˆä»£ç åï¼Œæ€§èƒ½ä¸‹é™äº†10%ã€‚</p><p>å†…å¿ƒ osï¼šWhatï¼Ÿï¼Ÿï¼Ÿä½ ä»¬æ˜¯ä¸æ˜¯æœ‰å…¶å®ƒé€»è¾‘å˜æ›´ï¼Ÿ<del>æˆ‘å†™çš„ä»£ç æ€ä¹ˆå¯èƒ½æœ‰ bug</del> é€»è¾‘ä¸€æ¨¡ä¸€æ ·çš„ç”Ÿæˆä»£ç æ€ä¹ˆå¯èƒ½ä¼šæœ‰æ€§èƒ½å·®å¼‚ï¼Ÿ</p><p>å¥½å§ï¼Œä¸ºäº†é¿å…çªç„¶å“ªä¸€å¤©è´¦å·å·²åœç”¨ï¼Œæˆ‘è¿˜æ˜¯è€å¿ƒåœ°é—®äº†ä¸šåŠ¡æ–¹ä¸€ä¸ªé—®é¢˜ï¼š</p><img data-src="https://static.purewhite.io/uPic/2020-10-14/QpVggz-image-20201014151957346.png!webp_90" width="30%" alt="èƒ½é‡ç°å—ï¼Ÿ" style="margin: 0 auto;"/><p>äºæ˜¯åœ¨ä¸€é€šå¦‚æ­¤è¿™èˆ¬åœ°å„ç§æ ‡å‡†å¯¹é½ã€ç¯å¢ƒå¯¹é½ç­‰ç­‰ä¸€é€šæ“ä½œï¼ˆæ­¤å¤„çœç•¥ 2^10^10 å­—ï¼‰åï¼Œæˆ‘ä»¬ç»ˆäºææ¸…æ¥šäº†çŠ¶å†µï¼š</p><p><strong>é‡æ„åçš„ç”Ÿæˆä»£ç æ¯”é‡æ„ä¹‹å‰ï¼Œåœ¨è¯¥ä¸šåŠ¡æ–¹çš„ idl ä¸Šï¼Œæ€§èƒ½çœŸçš„è¦å·® 10%ï¼</strong></p><p>Whatï¼Ÿï¼Ÿï¼Ÿè™½ç„¶é‡æ„è¿‡ç”Ÿæˆä»£ç ï¼Œä½†æ˜¯æ–°çš„ç”Ÿæˆä»£ç æ— è®ºä»è¯­ä¹‰ä¸Šè¿˜æ˜¯å®ç°ä¸Šéƒ½æ˜¯ï¼ˆå‡ ä¹ï¼‰å’Œæ—§çš„ä¸€è‡´çš„ï¼Œæ€ä¹ˆå¯èƒ½æ€§èƒ½ä¼šå·®ï¼Ÿï¼Ÿï¼Ÿ</p><p>å¥½å§ï¼Œä¸ºäº†å‘æ‰¬æˆ‘å¤§ IG ä¸åŠ ç­çš„å…‰è¾‰ä¼ ç»Ÿï¼Œæˆ‘ä»¬å†³å®šç›´æ¥åäº”æŠ•å°±å®Œäº‹â€”â€”æŠŠç”Ÿæˆä»£ç  revert å›æ—§ç‰ˆçš„ã€‚å¥½äº†ï¼Œé—®é¢˜è§£å†³ã€‚ï¼ˆç¬¬äºŒå¤©ï¼ŒHRï¼šå°å´å•Šï¼Œè´¢åŠ¡å®¤å·¥èµ„ç»“ä¸€ä¸‹ï¼‰ã€‚</p><img data-src="https://static.purewhite.io/uPic/2020-10-14/CjPx3x-image-20201014152156510.png!webp_90" width="30%" style="margin: 0 auto;"/><h1 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h1><p>å…ˆé™„ä¸Šæˆ‘ä»¬ç”¨æ¥è®²è§£ç”Ÿæˆä»£ç çš„ IDLï¼š</p><figure class="highlight thrift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line">    <span class="number">1</span>: list&lt;list&lt;<span class="keyword">i64</span>&gt;&gt; data1,</span><br><span class="line">    <span class="number">2</span>: map&lt;<span class="keyword">i64</span>, list&lt;<span class="keyword">byte</span>&gt;&gt; data2,</span><br><span class="line">    <span class="number">3</span>: list&lt;map&lt;<span class="keyword">i64</span>, <span class="keyword">byte</span>&gt;&gt; data3,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">Serialize</span> </span>&#123;</span><br><span class="line">    Example Method (<span class="number">1</span>: Example req),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œå¯¹æ¯”ä¸€ä¸‹æ–°æ—§ç”Ÿæˆä»£ç ï¼ˆç”±äºä»£ç è¾ƒå¤šï¼Œå°±ä¸ç›´æ¥è´´åœ¨æ–‡ç« ä¸­äº†ï¼‰ã€‚</p><p>æ—§ä»£ç ï¼š<a href="https://gist.github.com/PureWhiteWu/bdd28734ab1f675bb7b73ecf0c57e994">https://gist.github.com/PureWhiteWu/bdd28734ab1f675bb7b73ecf0c57e994</a></p><p>æ–°ä»£ç ï¼š<a href="https://gist.github.com/PureWhiteWu/63ac02ee613695213fe9eac4e22493ba">https://gist.github.com/PureWhiteWu/63ac02ee613695213fe9eac4e22493ba</a></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæ–°æ—§ç”Ÿæˆä»£ç ï¼Œåœ¨ç¼–è§£ç é€»è¾‘ä¸Šæ˜¯å®Œå…¨ç­‰ä»·çš„ï¼ä¸è¿‡æ—§ä»£ç é‡‡ç”¨äº†å±€éƒ¨å˜é‡ï¼Œæ–°ä»£ç æ˜¯ç›´æ¥ç”¨çš„å¯¹åº”ç»“æ„ä½“çš„å­—æ®µã€‚æˆ‘ä»¬æ€€ç–‘æ˜¯ä¸æ˜¯è¿™é‡Œçš„å·®å¼‚å¯¼è‡´çš„ï¼ˆè¿™å¯èƒ½ä¼šå¯¼è‡´è®¡ç®— offset çš„å¼€é”€ï¼‰ï¼Œäºæ˜¯ç”Ÿæˆäº†æ±‡ç¼–è¿›è¡Œæ¯”è¾ƒï¼ˆç”±äºæ±‡ç¼–è¾ƒå¤§ï¼Œä¸ç›´æ¥è´´äº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å»ºè®®è‡ªè¡Œç”Ÿæˆä¸€ä¸‹çœ‹ä¸€ä¸‹ï¼‰ï¼Œå‘ç°ç¡®å®æ˜¯å¤šäº†ä¸€æ¡ MOVQ è¯­å¥ç”¨æ¥è®¡ç®—åç§»é‡ï¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MOVQ&quot;&quot;.p+144(SP), AX</span><br></pre></td></tr></table></figure><p>çœ‹æ¥ç½ªé­ç¥¸é¦–å¥½åƒæ‰¾åˆ°äº†ï¼Ÿä¸è¿‡åˆæ„Ÿè§‰å“ªå„¿ä¸å¤ªå¯¹ï¼Œæ¯•ç«Ÿç°ä»£ CPU éƒ½æ˜¯æœ‰å¤šçº§æµæ°´çº¿çš„ï¼Œå°±å¤šè¿™ä¹ˆä¸€æ¡ MOVQ è¯­å¥ï¼Œå¯¹äºå¤šçº§æµæ°´çº¿æ¶æ„çš„ CPU æ¥è¯´ï¼Œæ€§èƒ½å·®è·å†æ€ä¹ˆä¸å¯èƒ½å¯¼è‡´ 10% è¿™ä¹ˆå¤§ï¼Œç‰¹åˆ«æ˜¯å°½ç®¡è¿™ä¸ªè¯­å¥æ˜¯åœ¨ for å¾ªç¯ä¸­çš„ï¼Œä½†æ˜¯åœ¨æ€»çš„æ‰§è¡Œçš„æŒ‡ä»¤å æ¯”ä¸­ä¹Ÿæ²¡æœ‰ 10% è¿™ä¹ˆå¤šã€‚</p><img data-src="https://static.purewhite.io/uPic/2020-10-14/4lXjbo-image-20201014153941394.png!webp_90" width="30%" style="margin: 0 auto;"/><p>ä¸ºäº†éªŒè¯æˆ‘ä»¬çš„ç–‘é—®ï¼Œæˆ‘ä»¬æ”¹äº†ä¸€ç‰ˆç”Ÿæˆä»£ç ï¼Œæ”¹ä¸ºäº†å’ŒåŸå…ˆç”Ÿæˆçš„ä¸€æ ·ä½¿ç”¨ä¸´æ—¶å˜é‡ï¼Œå‘ç°ç¡®å®å»æ‰äº†è¿™æ¡è¯­å¥åï¼Œæ€§èƒ½æ²¡æœ‰ä»»ä½•å˜åŒ–ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ€§èƒ½çš„é—®é¢˜å¹¶ä¸æ˜¯è¿™ä¸ªé—´æ¥å¯»å€å¯¼è‡´çš„ã€‚</p><p>éšåï¼Œæ ¹æ®ç”Ÿæˆä»£ç çš„æ±‡ç¼–å·®å¼‚ï¼Œæˆ‘ä»¬æå‡ºäº†è®¸å¤šçŒœæƒ³ï¼ŒèŠ±äº†å¤§é‡æ—¶é—´è¿›è¡ŒéªŒè¯ï¼Œä½†æ˜¯å‡ä¸æ˜¯æ€§èƒ½å˜å·®çš„åŸå› ï¼ˆæ­¤å¤„è¿‡äºå¿ƒé…¸ç•¥è¿‡ä¸è¡¨ï¼‰ã€‚</p><img data-src="https://static.purewhite.io/uPic/2020-10-14/CijHWI-1602576741958_a607b2f22c9eaad1d2fa15f240e3d7f9.png!webp_90" width="30%" style="margin: 0 auto;"/><p>æœ€ç»ˆï¼Œæˆ‘ä»¬å®šä½åˆ°äº†æ˜¯ç”±äºåœ¨æ–°çš„ç”Ÿæˆä»£ç ä¸­ï¼Œç›¸æ¯”æ—§ç‰ˆæœ¬çš„ç”Ÿæˆä»£ç ï¼Œåœ¨è¿”å›é”™è¯¯çš„æ—¶å€™ä¼šé¢å¤–åŒ…è£…ä¸€ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err := ...; err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> thrift.PrependError(fmt.Sprintf(<span class="string">&quot;%T read field x &#x27;xxx&#x27; error: &quot;</span>, p), err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œæ—§ç‰ˆæœ¬çš„ç”Ÿæˆä»£ç æ˜¯ç›´æ¥è¿”å›çš„é”™è¯¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err := ...; err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è™½ç„¶è¿™äº›åªæ˜¯åœ¨å‘ç”Ÿé”™è¯¯çš„æ—¶å€™æ‰ä¼šè°ƒç”¨åˆ°ï¼Œåœ¨æ­£å¸¸æµç¨‹ä¸­ä¸ä¼šç”¨åˆ°ï¼Œä½†æ˜¯ç”Ÿæˆçš„æ±‡ç¼–ä»£ç ä¸­è¿™æ®µé€»è¾‘å äº†ç›¸å½“å¤§çš„æ¯”ä¾‹ï¼š</p><img data-src="https://static.purewhite.io/uPic/2020-10-14/5xpCC2-1602577065517_13324d0f6a7ef6f60f4eb96f78b4d23d.png!webp_90" width="70%" style="margin: 0 auto;"/><p>è€Œ Go çš„ç¼–è¯‘å™¨å¹¶æ²¡æœ‰å¸®æˆ‘ä»¬é‡æ’è¿™äº›æŒ‡ä»¤ï¼Œå¯¼è‡´åœ¨çœŸæ­£è¿è¡Œçš„æ—¶å€™ï¼ŒL1 cache miss å¤§å¤§æé«˜ï¼Œæå¤§åœ°é™ä½äº†æ€§èƒ½ï¼Œå‚è€ƒå¦‚ä¸‹å®éªŒç»“æœï¼š</p><p><img data-src="https://static.purewhite.io/uPic/2020-10-14/ZuyUfz-image-20201014154039859.png!webp_90" alt="Old"></p><p><img data-src="https://static.purewhite.io/uPic/2020-10-14/GkGorr-image-20201014154055511.png!webp_90" alt="New"></p><p>é’ˆå¯¹è¿™ç§ç¼–è¯‘å™¨å¤ªå¼±æ™ºå¯¼è‡´çš„é—®é¢˜ï¼Œåªèƒ½ä¸Šäººå·¥æ™ºèƒ½æ¥è§£å†³äº†â€”â€”æœ‰å¤šå°‘äººå·¥å°±æœ‰å¤šå°‘æ™ºèƒ½ã€‚</p><img data-src="https://static.purewhite.io/uPic/2020-10-14/OOtOtc-1602577689777_491ea856ccc372c98bbd3b7b83ecf03f.png!webp_90" width="30%" style="margin: 0 auto;"/><p>æ—¢ç„¶ç¼–è¯‘å™¨ä¸ä¼šè‡ªåŠ¨åšæŒ‡ä»¤é‡æ’ï¼Œé‚£å°±æˆ‘ä»¬æ¥å¸®ç¼–è¯‘å™¨å¹²è¿™äº‹ï¼Œæ”¹é€ å®Œæˆåçš„ç”Ÿæˆä»£ç è§ï¼š<a href="https://gist.github.com/PureWhiteWu/296f2bdac6051e4052a68c2bb1de1c07">https://gist.github.com/PureWhiteWu/296f2bdac6051e4052a68c2bb1de1c07</a></p><p>æ¯”è¾ƒå…³é”®çš„æ–¹æ³•æ˜¯ï¼Œæˆ‘ä»¬åœ¨æ‰€æœ‰åŸå…ˆ<code>return thrift.PrependError</code>çš„åœ°æ–¹ï¼Œéƒ½æ”¹ä¸ºäº†<code>goto XXXError</code>ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Example)</span> <span class="title">Read</span><span class="params">(iprot thrift.TProtocol)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line"><span class="keyword">var</span> fieldTypeId thrift.TType</span><br><span class="line"><span class="keyword">var</span> fieldId <span class="keyword">int16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> _, err = iprot.ReadStructBegin(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">goto</span> ReadStructBeginError</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">_, fieldTypeId, fieldId, err = iprot.ReadFieldBegin()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">goto</span> ReadFieldBeginError</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> fieldTypeId == thrift.STOP &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">switch</span> fieldId &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line"><span class="keyword">if</span> fieldTypeId == thrift.LIST &#123;</span><br><span class="line"><span class="keyword">if</span> err := p.ReadField1(iprot); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">goto</span> ReadFieldError</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := iprot.Skip(fieldTypeId); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">goto</span> SkipFieldError</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line"><span class="keyword">if</span> fieldTypeId == thrift.MAP &#123;</span><br><span class="line"><span class="keyword">if</span> err := p.ReadField2(iprot); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">goto</span> ReadFieldError</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := iprot.Skip(fieldTypeId); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">goto</span> SkipFieldError</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line"><span class="keyword">if</span> fieldTypeId == thrift.LIST &#123;</span><br><span class="line"><span class="keyword">if</span> err := p.ReadField3(iprot); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">goto</span> ReadFieldError</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := iprot.Skip(fieldTypeId); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">goto</span> SkipFieldError</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">if</span> err := iprot.Skip(fieldTypeId); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">goto</span> SkipFieldError</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := iprot.ReadFieldEnd(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">goto</span> ReadFieldEndError</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err := iprot.ReadStructEnd(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">goto</span> ReadStructEndError</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">ReadStructBeginError:</span><br><span class="line"><span class="keyword">return</span> thrift.PrependError(fmt.Sprintf(<span class="string">&quot;%T read struct begin error: &quot;</span>, p), err)</span><br><span class="line">ReadFieldBeginError:</span><br><span class="line"><span class="keyword">return</span> thrift.PrependError(fmt.Sprintf(<span class="string">&quot;%T read field %d begin error: &quot;</span>, p, fieldId), err)</span><br><span class="line">ReadFieldError:</span><br><span class="line"><span class="keyword">return</span> thrift.PrependError(fmt.Sprintf(<span class="string">&quot;%T read field %d &#x27;%s&#x27; error: &quot;</span>, p, fieldId, fieldIDToName_Example[fieldId]), err)</span><br><span class="line">SkipFieldError:</span><br><span class="line"><span class="keyword">return</span> thrift.PrependError(fmt.Sprintf(<span class="string">&quot;%T field %d skip type %d error: &quot;</span>, p, fieldId, fieldTypeId), err)</span><br><span class="line">ReadFieldEndError:</span><br><span class="line"><span class="keyword">return</span> thrift.PrependError(fmt.Sprintf(<span class="string">&quot;%T read field end error&quot;</span>, p), err)</span><br><span class="line">ReadStructEndError:</span><br><span class="line"><span class="keyword">return</span> thrift.PrependError(fmt.Sprintf(<span class="string">&quot;%T read struct end error: &quot;</span>, p), err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½¿å¾—æˆ‘ä»¬æ­£å¸¸æµç¨‹ä¸­ï¼Œå¦‚æœåˆ¤æ–­ err å‡ºé”™çš„æƒ…å†µä¹‹ä¸‹ï¼Œä¸å†æœ‰ä¹‹å‰çš„ä¸€å¤§æ®µå¤„ç†çš„æŒ‡ä»¤ï¼Œè€Œä»…ä»…æ˜¯å˜æˆäº†ä¸€æ¡ç®€å•çš„ jmp æŒ‡ä»¤ï¼›è€Œå¯¹åº”çš„é”™è¯¯å¤„ç†é€»è¾‘ï¼Œåˆ™å°½å¯èƒ½æ”¾åœ¨æ­£å¸¸æµç¨‹ return ä¹‹åï¼Œä½¿å¾—å°½å¯èƒ½å‡å°‘ cpu load æŒ‡ä»¤çš„æ¬¡æ•°å¹¶é™ä½ L1 icache missï¼›åŒæ—¶ï¼Œä½¿å¾—æ‰€æœ‰çš„é”™è¯¯å¤„ç†çš„é€»è¾‘åœ¨æœ€ç»ˆçš„æ±‡ç¼–ä¸­åªä¼šå‡ºç°ä¸€æ¬¡ï¼Œè€Œä¸æ˜¯å‡ºç°å¤šæ¬¡ã€‚</p><p>è¿™é‡Œå¿…é¡»åæ§½ä¸€æ³¢ï¼ŒGo ç¼–è¯‘å™¨æœ‰æ—¶å€™ä¼šâ€œè´´å¿ƒâ€åœ°å¸®ä½ æŠŠè¿™äº›ä»£ç æŒªå›åˆ°ä¸Šé¢ï¼Œä½†æ˜¯ç”±äºåªä¼šå‡ºç°ä¸€æ¬¡è€Œå…¶å®ƒé”™è¯¯å¤„ç†çš„åœ°æ–¹éƒ½ä¼šç›´æ¥ jmpï¼Œæ‰€ä»¥é—®é¢˜ä¹Ÿä¸å¤§ï¼Œåç»­å¯ä»¥è€ƒè™‘è¯•ä¸€ä¸‹æŠŠè¿™äº›é€»è¾‘æ‰”åˆ°ä¸€ä¸ªç‹¬ç«‹çš„å‡½æ•°ä¸­å¹¶æ ‡è®° noinline æ˜¯å¦å¯ä»¥å†åº¦æé«˜æ€§èƒ½ï¼ˆä½¿å¾—åœ¨ä¸»æµç¨‹ä¸­å®Œå…¨ä¸å‡ºç°ï¼‰ã€‚</p><p>ç»è¿‡è¿™ä¸ªè°ƒæ•´ï¼Œperf çš„æ€§èƒ½æ˜æ˜¾å¥½äº†å¾ˆå¤šï¼Œå¹¶ä¸”å¯èƒ½æ¯”æ—§ç‰ˆæœ¬æ›´ä¼˜ï¼š</p><p><img data-src="https://static.purewhite.io/uPic/2020-10-14/g4d2ua-image-20201014154314334.png!webp_90" alt="Newer"></p><h1 id="The-End"><a href="#The-End" class="headerlink" title="The End"></a>The End</h1><p>è‡³æ­¤ï¼Œè¿™ä¸ªé—®é¢˜ç®—æ˜¯ææ˜ç™½äº†ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæœ€å¤§çš„æ”¶è·æ˜¯ï¼š<del>Go ç¼–è¯‘å™¨ç«Ÿç„¶å¦‚æ­¤çš„å¼±æ™º</del> äººå·¥æŒ‡ä»¤é‡æ’ç«Ÿç„¶èƒ½å¸¦æ¥å¦‚æ­¤ä¹‹å¤§çš„æå‡ã€‚</p><p>è°¨ä»¥æ­¤æ–‡åˆ†äº«æˆ‘ä»¬çš„ç»éªŒï¼Œå¸Œæœ›èƒ½å¤ŸæŠ›ç –å¼•ç‰ï¼Œä¸ºæ€§èƒ½ä¼˜åŒ–æå‡ºä¸€ä¸ªæ–°çš„æ€è·¯ï¼Œæ¯•ç«Ÿé²è¿…æ›¾è¯´è¿‡ï¼š</p><img data-src="https://static.purewhite.io/uPic/2020-10-14/gz7Udp-1602579503413_8c994f7473789b1c81ac17040fd9aa1f.png!webp_90" width="40%" style="margin: 0 auto;"/>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;æœ‰å¤šå°‘äººå·¥å°±æœ‰å¤šå°‘æ™ºèƒ½ã€‚                            â€”â€”é²è¿…&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;ç¼˜èµ·&quot;&gt;&lt;a href=&quot;#ç¼˜èµ·&quot; class=&quot;headerlink&quot; title=&quot;ç¼˜èµ·&quot;&gt;&lt;/a&gt;ç¼˜èµ·&lt;/h1&gt;&lt;p&gt;ä¼—æ‰€å‘¨çŸ¥ï¼Œå­—èŠ‚è·³åŠ¨å†…éƒ¨ä¸»è¦ä½¿ç”¨ Thriftï¼Œä¸ºäº†æ›´å¥½åœ°æŒæ§ç”Ÿæˆä»£ç ï¼Œæˆ‘ä»¬ç”¨ Go è‡ªå·±å®ç°äº† Thrift ä»£ç ç”Ÿæˆå·¥å…·ã€‚&lt;/p&gt;
&lt;p&gt;è€Œæˆ‘ä»¬çš„æ•…(shi)äº‹(gu)ï¼Œæ­£æ˜¯ç”±ä¸€æ¬¡é‡æ„å¼€å§‹â€¦â€¦&lt;/p&gt;</summary>
    
    
    
    <category term="go" scheme="https://www.purewhite.io/categories/go/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="go" scheme="https://www.purewhite.io/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>è¸©äº† Golang sync.Map çš„ä¸€ä¸ªå‘</title>
    <link href="https://www.purewhite.io/2020/08/24/golang-sync-map-keys-never-delete/"/>
    <id>https://www.purewhite.io/2020/08/24/golang-sync-map-keys-never-delete/</id>
    <published>2020-08-24T08:23:44.000Z</published>
    <updated>2021-12-02T12:51:07.226Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¼˜èµ·"><a href="#ç¼˜èµ·" class="headerlink" title="ç¼˜èµ·"></a>ç¼˜èµ·</h1><p>æœ€è¿‘ Go 1.15 å‘å¸ƒäº†ï¼Œæˆ‘ä¹Ÿç¬¬ä¸€æ—¶é—´æ›´æ–°äº†è¿™ä¸ªç‰ˆæœ¬ï¼Œæ¯•ç«Ÿå¯¹ Go çš„ç¨³å®šæ€§è¿˜æ˜¯æœ‰ä¸€äº›ä¿¡å¿ƒçš„ï¼Œäºæ˜¯ç›´æ¥åœ¨å…¬å¸ä¸Šäº†ç”Ÿäº§ã€‚</p><p>ç»“æœï¼Œä¸Šçº¿å‡ åˆ†é’Ÿï¼Œå°±å‡ºç°äº† OOMï¼Œäºæ˜¯ pprof äº†ä¸€ä¸‹ heapï¼Œç„¶åèµ¶ç´§å›æ»šï¼Œå‘ç°æŸå—æœ¬åº”è¯¥åœ¨ä¸€æ¬¡è¯·æ±‚ç»“æŸæ—¶è¢«é‡Šæ”¾çš„å†…å­˜ï¼Œè¢«ä¿ç•™äº†ä¸‹æ¥è€Œä¸”ä¸€ç›´åœ¨å¢é•¿ï¼Œå¦‚å›¾ï¼ˆå›¾ä¸­çš„ linkBufferNodeï¼‰ï¼š</p><p><img data-src="https://static.purewhite.io/uPic/2020-08-24/52BZcr-image-20200824165148602.png!webp_90" alt="ç«ç„°å›¾"></p><p>è¿™æ¬¡ä¸Šçº¿çš„å˜æ›´åªæœ‰ Go ç‰ˆæœ¬çš„å‡çº§ï¼Œæ²¡æœ‰ä»»ä½•å…¶å®ƒå˜åŠ¨ï¼Œäºæ˜¯åœ¨æœ¬åœ°å¼€å§‹æµ‹è¯•ï¼Œå‘ç°åœ¨æœ¬åœ°ä¹Ÿèƒ½ç™¾åˆ†ç™¾å¤ç°ã€‚</p><span id="more"></span><h1 id="æ’æŸ¥è¿‡ç¨‹"><a href="#æ’æŸ¥è¿‡ç¨‹" class="headerlink" title="æ’æŸ¥è¿‡ç¨‹"></a>æ’æŸ¥è¿‡ç¨‹</h1><p>çœ‹äº† Go 1.15 çš„ Release Noteï¼Œå‘ç°æœ‰ä¿©é«˜åº¦ç–‘ä¼¼çš„ä¸œè¥¿ï¼š</p><ol><li>å»é™¤äº†ä¸€äº› GC Dataï¼Œä½¿å¾— binary size å‡å°‘äº† 5%ï¼›</li><li>æ–°çš„å†…å­˜åˆ†é…ç®—æ³•ã€‚</li></ol><p>äºæ˜¯æ”¹ runtimeï¼Œå…³é—­æ–°çš„å†…å­˜åˆ†é…ç®—æ³•ï¼Œåˆ‡æ¢å›æ—§çš„ï¼Œç­‰ç­‰ä¸€é¡¿æ“ä½œçŒ›å¦‚è™ä¸‹æ¥ï¼Œå‘ç°é—®é¢˜è¿˜æ˜¯æ²¡è§£å†³ï¼Œç°è±¡ä»ç„¶å­˜åœ¨ã€‚</p><img data-src="https://static.purewhite.io/uPic/2020-08-24/1ekDRH-9150e4e5gw1fbh9986ayxj205i058mwz.jpg!webp_50" width="40%" alt="æˆ‘èƒ½æ€ä¹ˆåŠï¼Ÿæˆ‘ä¹Ÿå¾ˆç»æœ›å•Š" style="margin: 0 auto;"/><p>äºæ˜¯å®åœ¨ä¸è¡Œï¼Œç¥­å‡ºäº†<code>GODEBUG=&quot;allocfreetrace=1</code>å¤§æ³•ï¼Œè‚‰çœ¼ä»100MB+çš„æ—¥å¿—æ–‡ä»¶é‡Œé¢çœ‹å•Šçœ‹å•Šçœ‹å•Šçœ‹å•Šçœ‹å•Šçœ‹å•Šçœ‹å•Šçœ‹å•Šçœ‹å•Šçœ‹å•Šâ€¦â€¦ï¼ˆæ­¤å¤„çœç•¥å¿ƒé…¸è¿‡ç¨‹ï¼‰</p><p>æœ€ç»ˆç›´è§‰å‘Šè¯‰æˆ‘ï¼Œè¿™ä¸ªé—®é¢˜å¯èƒ½å’Œ Go 1.15 ä¸­ sync.Map çš„æ”¹åŠ¨æœ‰å…³ï¼ˆåˆ«é—®æˆ‘ä¸ºå•¥ï¼ŒçœŸçš„æ˜¯ç›´è§‰ï¼Œæˆ‘ä¹Ÿè¯´ä¸å‡ºæ¥ï¼‰ã€‚</p><h1 id="ç¤ºä¾‹ä»£ç "><a href="#ç¤ºä¾‹ä»£ç " class="headerlink" title="ç¤ºä¾‹ä»£ç "></a>ç¤ºä¾‹ä»£ç </h1><p>ä¸ºäº†æ–¹ä¾¿è®²è§£ï¼Œæˆ‘å†™äº†ä¸€ä¸ªæœ€å°å¯å¤ç°çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sm sync.Map</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">insertKeys</span><span class="params">()</span></span> &#123;</span><br><span class="line">keys := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line"><span class="comment">// Store some keys</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">v := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">1000</span>)</span><br><span class="line">keys = <span class="built_in">append</span>(keys, &amp;v)</span><br><span class="line">sm.Store(keys[i], <span class="keyword">struct</span>&#123;&#125;&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// delete some keys, but not all keys</span></span><br><span class="line"><span class="keyword">for</span> i, k := <span class="keyword">range</span> keys &#123;</span><br><span class="line"><span class="keyword">if</span> i%<span class="number">2</span> == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">sm.Delete(k)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">shutdown</span><span class="params">()</span></span> &#123;</span><br><span class="line">sm.Range(<span class="function"><span class="keyword">func</span><span class="params">(key, value <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line"><span class="comment">// do something to key</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">insertKeys()</span><br><span class="line"><span class="comment">// do something ...</span></span><br><span class="line">shutdown()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Go-1-15-ä¸­-sync-Map-æ”¹åŠ¨"><a href="#Go-1-15-ä¸­-sync-Map-æ”¹åŠ¨" class="headerlink" title="Go 1.15 ä¸­ sync.Map æ”¹åŠ¨"></a>Go 1.15 ä¸­ sync.Map æ”¹åŠ¨</h1><p>åœ¨ Go 1.15 ä¸­ï¼Œsync.Map å¢åŠ äº†ä¸€ä¸ªæ–¹æ³•<code>LoadAndDelete</code>ï¼Œå…·ä½“çš„ issue åœ¨è¿™ï¼š<a href="https://github.com/golang/go/issues/33762">sync: add new Map method LoadAndDelete</a>ï¼ŒCL åœ¨è¿™ï¼š<a href="https://go-review.googlesource.com/c/go/+/205899/">CL</a>ã€‚</p><p>ä¸ºä»€ä¹ˆæˆ‘ç¡®è®¤æ˜¯è¿™ä¸ªæ”¹åŠ¨å¯¼è‡´çš„å‘¢ï¼Ÿå¾ˆç®€å•ï¼šæˆ‘åœ¨æœ¬åœ°æŠŠè¿™ä¸ªæ”¹åŠ¨ revert æ‰äº†ï¼Œé—®é¢˜å°±æ²¡äº†ï¼Œå¥½äº†å…³æœºä¸‹ç­â€¦â€¦</p><img data-src="https://static.purewhite.io/uPic/2020-08-25/KZLLqZ-temp_paste_image_ae4a910733531a94177f37fc7914689c.png!webp_90" width="40%" alt="å…³æœºä¸‹ç­" style="margin: 0 auto;"/><p>å½“ç„¶æ²¡è¿™ä¹ˆç®€å•ï¼ŒçŸ¥å…¶ç„¶è¦çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œäºæ˜¯å¼€å§‹çœ‹åˆ°åº•æ”¹äº†å“ªå—â€¦â€¦ï¼ˆæ­¤å¤„çœç•¥100000å­—ï¼‰</p><p>æœ€ç»ˆå‘ç°ï¼Œå…³é”®ä»£ç æ˜¯è¿™æ®µï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LoadAndDelete deletes the value for a key, returning the previous value if any.</span></span><br><span class="line"><span class="comment">// The loaded result reports whether the key was present.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span> <span class="title">LoadAndDelete</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(value <span class="keyword">interface</span>&#123;&#125;, loaded <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">read, _ := m.read.Load().(readOnly)</span><br><span class="line">e, ok := read.m[key]</span><br><span class="line"><span class="keyword">if</span> !ok &amp;&amp; read.amended &#123;</span><br><span class="line">m.mu.Lock()</span><br><span class="line">read, _ = m.read.Load().(readOnly)</span><br><span class="line">e, ok = read.m[key]</span><br><span class="line"><span class="keyword">if</span> !ok &amp;&amp; read.amended &#123;</span><br><span class="line">e, ok = m.dirty[key]</span><br><span class="line"><span class="comment">// Regardless of whether the entry was present, record a miss: this key</span></span><br><span class="line"><span class="comment">// will take the slow path until the dirty map is promoted to the read</span></span><br><span class="line"><span class="comment">// map.</span></span><br><span class="line">m.missLocked()</span><br><span class="line">&#125;</span><br><span class="line">m.mu.Unlock()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ok &#123;</span><br><span class="line"><span class="keyword">return</span> e.<span class="built_in">delete</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Delete deletes the value for a key.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span> <span class="title">Delete</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">m.LoadAndDelete(key)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *entry)</span> <span class="title">delete</span><span class="params">()</span> <span class="params">(value <span class="keyword">interface</span>&#123;&#125;, ok <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">p := atomic.LoadPointer(&amp;e.p)</span><br><span class="line"><span class="keyword">if</span> p == <span class="literal">nil</span> || p == expunged &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> atomic.CompareAndSwapPointer(&amp;e.p, p, <span class="literal">nil</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> *(*<span class="keyword">interface</span>&#123;&#125;)(p), <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œä¼šå‘ç°åœ¨ Delete çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰çœŸæ­£åˆ é™¤æ‰ keyï¼Œè€Œæ˜¯ä» key ä¸­å–å‡ºäº† entryï¼Œç„¶åæŠŠ entry è®¾ä¸º nilâ€¦â€¦</p><p>æ‰€ä»¥ï¼Œåœ¨æˆ‘ä»¬åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬æŠŠä¸€ä¸ªè¿æ¥ä½œä¸º key æ”¾äº†è¿›å»ï¼Œäºæ˜¯å’Œè¿™ä¸ªè¿æ¥ç›¸å…³çš„æ¯”å¦‚ buffer çš„å†…å­˜å°±æ°¸è¿œæ— æ³•é‡Šæ”¾äº†â€¦â€¦</p><p>é‚£ä¹ˆä¸ºä»€ä¹ˆåœ¨ Go 1.14 ä¸­æ²¡æœ‰é—®é¢˜å‘¢ï¼Ÿä»¥ä¸‹æ˜¯ Go 1.14 çš„ä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Delete deletes the value for a key.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span> <span class="title">Delete</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">read, _ := m.read.Load().(readOnly)</span><br><span class="line">e, ok := read.m[key]</span><br><span class="line"><span class="keyword">if</span> !ok &amp;&amp; read.amended &#123;</span><br><span class="line">m.mu.Lock()</span><br><span class="line">read, _ = m.read.Load().(readOnly)</span><br><span class="line">e, ok = read.m[key]</span><br><span class="line"><span class="keyword">if</span> !ok &amp;&amp; read.amended &#123;</span><br><span class="line"><span class="built_in">delete</span>(m.dirty, key)</span><br><span class="line">&#125;</span><br><span class="line">m.mu.Unlock()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ok &#123;</span><br><span class="line">e.<span class="built_in">delete</span>()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ Go 1.14 ä¸­ï¼Œå¦‚æœ key åœ¨ dirty ä¸­ï¼Œæ˜¯ä¼šè¢«åˆ é™¤çš„ï¼›è€Œå‡‘å·§ï¼Œæˆ‘ä»¬å…¶å®â€œè¯¯ç”¨â€äº† sync.Mapï¼Œåœ¨æˆ‘ä»¬çš„ä½¿ç”¨è¿‡ç¨‹ä¸­æ²¡æœ‰è¯»æ“ä½œï¼Œå¯¼è‡´æ‰€æœ‰çš„ key å…¶å®éƒ½åœ¨ dirty é‡Œé¢ï¼Œæ‰€ä»¥å½“è°ƒç”¨ Delete çš„æ—¶å€™æ˜¯ä¼šè¢«çœŸæ­£åˆ é™¤çš„ã€‚</p><p>è¦æ³¨æ„ï¼Œæ— è®ºå“ªä¸ªç‰ˆæœ¬çš„ Goï¼Œä¸€æ—¦ key å‡çº§åˆ°äº† read ä¸­ï¼Œåœ¨æ²¡æœ‰ miss åˆ°ä¸€å®šçš„å€¼è®© dirty æå‡ä¸º read æ—¶ï¼Œkey éƒ½æ˜¯æ°¸è¿œä¸ä¼šè¢«åˆ é™¤çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæç«¯æƒ…å†µä¹‹ä¸‹ï¼Œkey æ˜¯ä¼šæ³„éœ²çš„ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>åœ¨ Go &lt;= 1.15 ç‰ˆæœ¬ä¸­ï¼Œsync.Map ä¸­çš„ key åœ¨æç«¯æƒ…å†µä¸‹æ˜¯ä¸ä¼šè¢«åˆ é™¤çš„ï¼Œå¦‚æœåœ¨ Key ä¸­æ”¾äº†ä¸€ä¸ªå¤§çš„å¯¹è±¡ï¼Œæˆ–è€…å…³è”æœ‰å†…å­˜ï¼Œå°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p><p>é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘å·²ç»å‘ Go å®˜æ–¹æå‡ºäº†<a href="https://github.com/golang/go/issues/40999">Issue</a>ï¼Œç›®å‰æ¥çœ‹è¿™ä¸ª behaviour å®šä¹‰ä¸ºäº† bugï¼ˆå› ä¸ºè¿èƒŒäº† Go 1 å…¼å®¹æ€§æ‰¿è¯ºï¼Œå’Œ 1.14 ä¸­çš„ behaviour ä¸åŒäº†ï¼‰ï¼Œå·²ç»ç”± @ChangKun Ou å¤§ä½¬æäº† pr ä¿®å¤äº†ï¼Œå¹¶ä¸” backport åˆ°äº† 1.15.1 ä¸­ã€‚</p><p>è€Œé’ˆå¯¹ read ä¸­çš„ key åœ¨æ²¡æœ‰ dirty è¢«æå‡æ—¶ä¸ä¼šåˆ é™¤çš„é—®é¢˜ï¼Œç›®å‰çœ‹æ¥æ˜¯ä¸€ä¸ªè®¾è®¡ä¸Šçš„ trade-offï¼Œå¦‚æœæœ‰çœŸå®ä¸–ç•Œä¸­çš„ç¨‹åºï¼ˆreal-world programï¼‰å‡ºé—®é¢˜çš„è¯ï¼Œå†æ issueï¼Œçœ‹çœ‹æ˜¯å¦è¦è§£å†³ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;ç¼˜èµ·&quot;&gt;&lt;a href=&quot;#ç¼˜èµ·&quot; class=&quot;headerlink&quot; title=&quot;ç¼˜èµ·&quot;&gt;&lt;/a&gt;ç¼˜èµ·&lt;/h1&gt;&lt;p&gt;æœ€è¿‘ Go 1.15 å‘å¸ƒäº†ï¼Œæˆ‘ä¹Ÿç¬¬ä¸€æ—¶é—´æ›´æ–°äº†è¿™ä¸ªç‰ˆæœ¬ï¼Œæ¯•ç«Ÿå¯¹ Go çš„ç¨³å®šæ€§è¿˜æ˜¯æœ‰ä¸€äº›ä¿¡å¿ƒçš„ï¼Œäºæ˜¯ç›´æ¥åœ¨å…¬å¸ä¸Šäº†ç”Ÿäº§ã€‚&lt;/p&gt;
&lt;p&gt;ç»“æœï¼Œä¸Šçº¿å‡ åˆ†é’Ÿï¼Œå°±å‡ºç°äº† OOMï¼Œäºæ˜¯ pprof äº†ä¸€ä¸‹ heapï¼Œç„¶åèµ¶ç´§å›æ»šï¼Œå‘ç°æŸå—æœ¬åº”è¯¥åœ¨ä¸€æ¬¡è¯·æ±‚ç»“æŸæ—¶è¢«é‡Šæ”¾çš„å†…å­˜ï¼Œè¢«ä¿ç•™äº†ä¸‹æ¥è€Œä¸”ä¸€ç›´åœ¨å¢é•¿ï¼Œå¦‚å›¾ï¼ˆå›¾ä¸­çš„ linkBufferNodeï¼‰ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&quot;https://static.purewhite.io/uPic/2020-08-24/52BZcr-image-20200824165148602.png!webp_90&quot; alt=&quot;ç«ç„°å›¾&quot;&gt;&lt;/p&gt;
&lt;p&gt;è¿™æ¬¡ä¸Šçº¿çš„å˜æ›´åªæœ‰ Go ç‰ˆæœ¬çš„å‡çº§ï¼Œæ²¡æœ‰ä»»ä½•å…¶å®ƒå˜åŠ¨ï¼Œäºæ˜¯åœ¨æœ¬åœ°å¼€å§‹æµ‹è¯•ï¼Œå‘ç°åœ¨æœ¬åœ°ä¹Ÿèƒ½ç™¾åˆ†ç™¾å¤ç°ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="go" scheme="https://www.purewhite.io/categories/go/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="go" scheme="https://www.purewhite.io/tags/go/"/>
    
    <category term="sync" scheme="https://www.purewhite.io/tags/sync/"/>
    
    <category term="map" scheme="https://www.purewhite.io/tags/map/"/>
    
    <category term="memory leak" scheme="https://www.purewhite.io/tags/memory-leak/"/>
    
  </entry>
  
  <entry>
    <title>ä¸ºä»€ä¹ˆ Golang å‡½æ•°èµ‹å€¼ä¼šäº§ç”Ÿå†…å­˜åˆ†é…ï¼Ÿ</title>
    <link href="https://www.purewhite.io/2020/06/30/golang-indirect-function-allocate/"/>
    <id>https://www.purewhite.io/2020/06/30/golang-indirect-function-allocate/</id>
    <published>2020-06-30T03:05:51.000Z</published>
    <updated>2021-12-02T12:51:07.226Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç¼˜èµ·"><a href="#ç¼˜èµ·" class="headerlink" title="ç¼˜èµ·"></a>ç¼˜èµ·</h2><p>è¿™å‡ å¤©åœ¨é‡æ„æŸæ®µä»£ç åï¼Œåšäº†ä¸€æ¬¡æ€§èƒ½æµ‹è¯•ï¼Œç«ç„°å›¾ä¸­å‘ç°äº†ä¸€ä¸ªååˆ†å¥‡æ€ªçš„<code>runtime.newobject</code>çš„è°ƒç”¨ï¼Œå¤§è‡´å ç”¨2%ï¼Œè€Œæ‰¾éäº†æ•´æ®µä»£ç éƒ½æ²¡æœ‰å‘ç°æœ‰æ–°å»ºå¯¹è±¡ç›¸å…³çš„é€»è¾‘ã€‚äºæ˜¯è¿«ä¸å¾—å·²ï¼Œç¥­å‡ºäº†æ±‡ç¼–å¤§æ³•ï¼Œç»ˆäºå®šä½åˆ°äº†é—®é¢˜æ‰€åœ¨ã€‚è¿™ç¯‡æ–‡ç« ä¼šä½¿ç”¨ä¸€æ®µæœ€å°å¯å¤ç°çš„ä»£ç æ¥åˆ†äº«è¿™ä¸ªé—®é¢˜ä»¥åŠèƒŒåçš„åŸå› ã€‚</p><span id="more"></span><h2 id="Show-me-the-code"><a href="#Show-me-the-code" class="headerlink" title="Show me the code"></a>Show me the code</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">_ <span class="string">&quot;unsafe&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MyFunc <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> myFuncImplStruct <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:noinline</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *myFuncImplStruct)</span> <span class="title">myFunc</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:noinline</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m myFuncImplStruct)</span> <span class="title">myFunc2</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:noinline</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">myFunc</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> myFuncContainer <span class="keyword">struct</span> &#123;</span><br><span class="line">f MyFunc</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:noinline</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newFuncContainer</span><span class="params">(f MyFunc)</span> *<span class="title">myFuncContainer</span></span> &#123;</span><br><span class="line">n := &amp;myFuncContainer&#123;&#125;</span><br><span class="line">n.f = f</span><br><span class="line"><span class="keyword">return</span> n</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">m := &amp;myFuncImplStruct&#123;&#125;</span><br><span class="line">m2 := myFuncImplStruct&#123;&#125;</span><br><span class="line">c1 := newFuncContainer(myFunc)</span><br><span class="line">c2 := newFuncContainer(m.myFunc)</span><br><span class="line">c3 := newFuncContainer(m2.myFunc2)</span><br><span class="line"></span><br><span class="line">_, _, _ = c1, c2, c3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ä¸­ï¼Œåˆçœ‹èµ·æ¥è²Œä¼¼åœ¨ main å‡½æ•°ä¸­ï¼ˆä¸è€ƒè™‘ newFuncContainer å‡½æ•°ä¸­å¯¼è‡´çš„å†…å­˜åˆ†é…ï¼‰æ²¡æœ‰è¿è¡Œæ—¶å†…å­˜åˆ†é…ï¼ˆm ä¼šè¢«ä¼˜åŒ–æˆå…¨å±€åŒºï¼Œæ‰€ä»¥ä¸ä¼šçœŸçš„å¯¼è‡´è¿è¡Œæ—¶å†…å­˜åˆ†é…ï¼‰ï¼Œä½†æ˜¯å®é™…ä¸Šåœ¨ main ä¸­æ˜¯æœ‰ä¸¤æ¬¡è¿è¡Œæ—¶å†…å­˜åˆ†é…çš„ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿ</p><h2 id="å‡½æ•°è¿˜èƒ½é€ƒé€¸åˆ°å †ä¸Šï¼Ÿ"><a href="#å‡½æ•°è¿˜èƒ½é€ƒé€¸åˆ°å †ä¸Šï¼Ÿ" class="headerlink" title="å‡½æ•°è¿˜èƒ½é€ƒé€¸åˆ°å †ä¸Šï¼Ÿ"></a>å‡½æ•°è¿˜èƒ½é€ƒé€¸åˆ°å †ä¸Šï¼Ÿ</h2><p>æˆ‘ä»¬ç”¨<code>-gcflags=&quot;-m&quot;</code>æ¥æ‰“å°ä¸€ä¸‹ç¼–è¯‘å™¨çš„ä¼˜åŒ–ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">./<span class="selector-tag">main</span><span class="selector-class">.go</span>:<span class="number">13</span>:<span class="number">7</span>: m does not escape</span><br><span class="line">./<span class="selector-tag">main</span><span class="selector-class">.go</span>:<span class="number">32</span>:<span class="number">23</span>: leaking param: f</span><br><span class="line">./<span class="selector-tag">main</span><span class="selector-class">.go</span>:<span class="number">33</span>:<span class="number">7</span>: &amp;myFuncContainer literal escapes to heap</span><br><span class="line">./<span class="selector-tag">main</span><span class="selector-class">.go</span>:<span class="number">39</span>:<span class="number">7</span>: &amp;myFuncImplStruct literal escapes to heap</span><br><span class="line">./<span class="selector-tag">main</span><span class="selector-class">.go</span>:<span class="number">42</span>:<span class="number">26</span>: m<span class="selector-class">.myFunc</span> escapes to heap</span><br><span class="line">./<span class="selector-tag">main</span><span class="selector-class">.go</span>:<span class="number">43</span>:<span class="number">27</span>: m2<span class="selector-class">.myFunc2</span> escapes to heap</span><br><span class="line">&lt;autogenerated&gt;:<span class="number">1</span>: <span class="selector-class">.this</span> does not escape</span><br></pre></td></tr></table></figure><p>ç«Ÿç„¶è¯´ 42ã€43 ä¸¤è¡Œä¸­çš„<code>m.myFunc</code>å’Œ<code>m2.myFunc2</code>â€œé€ƒé€¸åˆ°äº†å †ä¸Šâ€ï¼Ÿä¸€ä¸ªå‡½æ•°è¿˜èƒ½é€ƒé€¸åˆ°å †ä¸Šï¼Ÿï¼Ÿï¼Ÿ</p><p><img data-src="https://static.purewhite.io/uPic/2020-06-30/u4KRrc-006Cmetyly1ff16b3zxvxj308408caa8.jpg!webp_90"></p><h2 id="å®é”¤äº†"><a href="#å®é”¤äº†" class="headerlink" title="å®é”¤äº†"></a>å®é”¤äº†</h2><p>è™½ç„¶çœ‹èµ·æ¥è²Œä¼¼çœŸçš„æ˜¯è¿™é‡Œå¯¼è‡´çš„ï¼Œä½†æ˜¯æˆ‘ä»¬è¯´è¯åšäº‹è¦æœ‰è¯æ®ï¼Œäºæ˜¯ç¥­å‡ºæ±‡ç¼–å¤§æ³•ï¼ˆ<code>-gcflags=&quot;-S&quot;</code>ï¼‰ï¼Œçœ‹ä¸€ä¸‹ç”Ÿæˆçš„æ±‡ç¼–ä»£ç æ˜¯å•¥æ ·çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&quot;&quot;.main STEXT size=160 args=0x0 locals=0x18</span><br><span class="line">â€¦â€¦</span><br><span class="line">0x0031 00049 (main.go:42)PCDATA$0, $1</span><br><span class="line">0x0031 00049 (main.go:42)LEAQtype.noalg.struct &#123; F uintptr; R *&quot;&quot;.myFuncImplStruct &#125;(SB), AX</span><br><span class="line">0x0038 00056 (main.go:42)PCDATA$0, $0</span><br><span class="line">0x0038 00056 (main.go:42)MOVQAX, (SP)</span><br><span class="line">0x003c 00060 (main.go:42)CALLruntime.newobject(SB)</span><br><span class="line">0x0041 00065 (main.go:42)PCDATA$0, $1</span><br><span class="line">0x0041 00065 (main.go:42)MOVQ8(SP), AX</span><br><span class="line">0x0046 00070 (main.go:42)LEAQ&quot;&quot;.(*myFuncImplStruct).myFunc-fm(SB), CX</span><br><span class="line">0x004d 00077 (main.go:42)MOVQCX, (AX)</span><br><span class="line">0x0050 00080 (main.go:42)PCDATA$0, $2</span><br><span class="line">0x0050 00080 (main.go:42)LEAQruntime.zerobase(SB), CX</span><br><span class="line">0x0057 00087 (main.go:42)PCDATA$0, $1</span><br><span class="line">0x0057 00087 (main.go:42)MOVQCX, 8(AX)</span><br><span class="line">0x005b 00091 (main.go:42)PCDATA$0, $0</span><br><span class="line">0x005b 00091 (main.go:42)MOVQAX, (SP)</span><br><span class="line">0x005f 00095 (main.go:42)CALL&quot;&quot;.newFuncContainer(SB)</span><br><span class="line">0x0064 00100 (main.go:43)PCDATA$0, $1</span><br><span class="line">0x0064 00100 (main.go:43)LEAQtype.noalg.struct &#123; F uintptr; R &quot;&quot;.myFuncImplStruct &#125;(SB), AX</span><br><span class="line">0x006b 00107 (main.go:43)PCDATA$0, $0</span><br><span class="line">0x006b 00107 (main.go:43)MOVQAX, (SP)</span><br><span class="line">0x006f 00111 (main.go:43)CALLruntime.newobject(SB)</span><br><span class="line">0x0074 00116 (main.go:43)PCDATA$0, $1</span><br><span class="line">0x0074 00116 (main.go:43)MOVQ8(SP), AX</span><br><span class="line">0x0079 00121 (main.go:43)LEAQ&quot;&quot;.myFuncImplStruct.myFunc2-fm(SB), CX</span><br><span class="line">0x0080 00128 (main.go:43)MOVQCX, (AX)</span><br><span class="line">0x0083 00131 (main.go:43)PCDATA$0, $0</span><br><span class="line">0x0083 00131 (main.go:43)MOVQAX, (SP)</span><br><span class="line">0x0087 00135 (main.go:43)CALL&quot;&quot;.newFuncContainer(SB)</span><br><span class="line">â€¦â€¦</span><br></pre></td></tr></table></figure><p>è¿™ä¸‹å­å®é”¤äº†ï¼ŒçœŸçš„æ˜¯è¿™é‡Œå¯¼è‡´çš„ï¼Œä½†æ˜¯ä¸ºå•¥å‘¢ï¼Ÿæˆ‘æŠŠä¸€ä¸ªå‡½æ•°èµ‹å€¼ç»™æŸä¸ªå˜é‡ï¼Œä¸ºä»€ä¹ˆä¼šå¯¼è‡´ä¸€æ¬¡å†…å­˜åˆ†é…å‘¢ï¼Ÿå‡½æ•°åä¸æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å‡½æ•°æ‰€åœ¨çš„ä»£ç åœ°å€ä¹ˆï¼Ÿ</p><h2 id="Golang-å‡½æ•°è°ƒç”¨æœºåˆ¶"><a href="#Golang-å‡½æ•°è°ƒç”¨æœºåˆ¶" class="headerlink" title="Golang å‡½æ•°è°ƒç”¨æœºåˆ¶"></a>Golang å‡½æ•°è°ƒç”¨æœºåˆ¶</h2><p>åœ¨ Golang ä¸­ï¼Œå‡½æ•°è°ƒç”¨å…¶å®å¹¶ä¸åƒ C é‚£ä¹ˆç®€å•ï¼Œæœ‰ä¸€å®šçš„åˆ†ç±»ï¼š</p><h3 id="å‡½æ•°è°ƒç”¨åˆ†ç±»"><a href="#å‡½æ•°è°ƒç”¨åˆ†ç±»" class="headerlink" title="å‡½æ•°è°ƒç”¨åˆ†ç±»"></a>å‡½æ•°è°ƒç”¨åˆ†ç±»</h3><p>åœ¨ Go ä¸­ï¼Œä¸€å…±æœ‰ 4 ç§ç±»å‹çš„å‡½æ•°ï¼š</p><ol><li>é¡¶å±‚å‡½æ•°ï¼ˆæ™®é€šçš„å‡½æ•°ï¼‰</li><li>æœ‰å€¼æ¥æ”¶è€…çš„å‡½æ•°</li><li>æœ‰æŒ‡é’ˆæ¥æ”¶è€…çš„å‡½æ•°</li><li>å‡½æ•°å­—é¢é‡</li></ol><p>æœ‰ 5 ç§ç±»å‹çš„å‡½æ•°è°ƒç”¨ï¼š</p><ol><li>ç›´æ¥è°ƒç”¨é¡¶å±‚å‡½æ•°</li><li>ç›´æ¥è°ƒç”¨æœ‰å€¼æ¥æ”¶è€…çš„å‡½æ•°</li><li>ç›´æ¥è°ƒç”¨æœ‰æŒ‡é’ˆæ¥æ”¶è€…çš„å‡½æ•°</li><li>é—´æ¥è°ƒç”¨å‡½æ•°å€¼ï¼ˆfunc valueï¼‰</li><li>é—´æ¥è°ƒç”¨ interface ä¸­å‡½æ•°</li></ol><p>ä»¥ä¸‹çš„ç¤ºä¾‹ç¨‹åºå±•ç¤ºäº†æ‰€æœ‰å¯èƒ½çš„å‡½æ•°è°ƒç”¨æ–¹å¼ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TopLevel</span><span class="params">(x <span class="keyword">int</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Pointer <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*Pointer)</span> <span class="title">M</span><span class="params">(<span class="keyword">int</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Value <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(Value)</span> <span class="title">M</span><span class="params">(<span class="keyword">int</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Interface <span class="keyword">interface</span>&#123; M(<span class="keyword">int</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> literal = <span class="function"><span class="keyword">func</span><span class="params">(x <span class="keyword">int</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// direct call of top-level func</span></span><br><span class="line">TopLevel(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// direct call of method with value receiver (two spellings, but same)</span></span><br><span class="line"><span class="keyword">var</span> v Value</span><br><span class="line">v.M(<span class="number">1</span>)</span><br><span class="line">Value.M(v, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// direct call of method with pointer receiver (two spellings, but same)</span></span><br><span class="line"><span class="keyword">var</span> p Pointer</span><br><span class="line">(&amp;p).M(<span class="number">1</span>)</span><br><span class="line">(*Pointer).M(&amp;p, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// indirect call of func value (Ã—4)</span></span><br><span class="line">f1 := TopLevel</span><br><span class="line">f1(<span class="number">1</span>)</span><br><span class="line">f2 := Value.M</span><br><span class="line">f2(v, <span class="number">1</span>)</span><br><span class="line">f3 := (*Pointer).M</span><br><span class="line">f3(&amp;p, <span class="number">1</span>)</span><br><span class="line">f4 := literal</span><br><span class="line">f4(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// indirect call of method on interface (Ã—3)</span></span><br><span class="line"><span class="keyword">var</span> i Interface</span><br><span class="line">i = v</span><br><span class="line">i.M(<span class="number">1</span>)</span><br><span class="line">i = &amp;v</span><br><span class="line">i.M(<span class="number">1</span>)</span><br><span class="line">i = &amp;p</span><br><span class="line">i.M(<span class="number">1</span>)</span><br><span class="line">Interface.M(i, <span class="number">1</span>)</span><br><span class="line">Interface.M(v, <span class="number">1</span>)</span><br><span class="line">Interface.M(&amp;p, <span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šç¨‹åºæ‰€ç¤ºï¼Œä¸€å…±æœ‰ 10 ç§å¯èƒ½çš„è°ƒç”¨ç»„åˆï¼š</p><ol><li>ç›´æ¥è°ƒç”¨é¡¶å±‚å‡½æ•° / </li><li>ç›´æ¥è°ƒç”¨å€¼æ¥æ”¶è€…å‡½æ•° /</li><li>ç›´æ¥è°ƒç”¨æŒ‡é’ˆæ¥æ”¶è€…å‡½æ•° /</li><li>é—´æ¥è°ƒç”¨å‡½æ•°å€¼ï¼ˆfunc valueï¼‰ / å‡½æ•°å€¼ä¸ºé¡¶å±‚å‡½æ•°</li><li>é—´æ¥è°ƒç”¨å‡½æ•°å€¼ / å‡½æ•°å€¼ä¸ºå€¼æ¥æ”¶è€…å‡½æ•°</li><li>é—´æ¥è°ƒç”¨å‡½æ•°å€¼ / å‡½æ•°å€¼ä¸ºæŒ‡é’ˆæ¥æ”¶è€…å‡½æ•°</li><li>é—´æ¥è°ƒç”¨å‡½æ•°å€¼ / å‡½æ•°å€¼å‡½æ•°å­—é¢é‡</li><li>é—´æ¥è°ƒç”¨ interface ä¸­å‡½æ•° / interface ä¸ºå€¼ï¼Œè°ƒç”¨å€¼æ¥æ”¶è€…å‡½æ•°</li><li>é—´æ¥è°ƒç”¨ interface ä¸­å‡½æ•° / interface ä¸ºæŒ‡é’ˆï¼Œè°ƒç”¨å€¼æ¥æ”¶è€…å‡½æ•°</li><li>é—´æ¥è°ƒç”¨ interface ä¸­å‡½æ•° / interface ä¸ºæŒ‡é’ˆï¼Œè°ƒç”¨æŒ‡é’ˆæ¥æ”¶è€…å‡½æ•°</li></ol><p>ä»¥ä¸Šåˆ—è¡¨ä¸­ï¼Œæ–œæ  / å·¦ä¾§æ˜¯åœ¨ç¼–è¯‘æ—¶å°±å·²çŸ¥çš„ä¿¡æ¯ï¼Œå³ä¾§æ˜¯åœ¨è¿è¡Œæ—¶æ‰çŸ¥é“çš„ä¿¡æ¯ã€‚åœ¨ç¼–è¯‘æ—¶ç”Ÿæˆçš„ä»£ç æ˜¯ä¸çŸ¥é“è¿è¡Œæ—¶çš„ä¿¡æ¯çš„ï¼Œæ‰€ä»¥åœ¨è¿è¡Œæ—¶éœ€è¦ç”Ÿæˆä¸€äº›é¢å¤–çš„é€‚é…å™¨å‡½æ•°ï¼ˆadapter functionsï¼‰æ¥è¾¾æˆé—´æ¥è°ƒç”¨ã€‚</p><h3 id="å‡½æ•°é—´æ¥è°ƒç”¨å®ç°"><a href="#å‡½æ•°é—´æ¥è°ƒç”¨å®ç°" class="headerlink" title="å‡½æ•°é—´æ¥è°ƒç”¨å®ç°"></a>å‡½æ•°é—´æ¥è°ƒç”¨å®ç°</h3><p>çœ‹åˆ°è¿™é‡Œï¼Œå¤§å®¶åº”è¯¥èƒ½éšçº¦çŒœæµ‹åˆ°åŸå› äº†ï¼Œæ­£å¦‚ä½ æ‰€çŒœæµ‹ï¼Œåœ¨æˆ‘ä»¬å¼€å¤´çš„ç¨‹åºä¸­ï¼Œå­˜åœ¨ç€é—´æ¥è°ƒç”¨ï¼ŒGo åˆ†é…çš„è¿™ä¸ªå¯¹è±¡å’Œé—´æ¥è°ƒç”¨è„±ä¸äº†å…³ç³»ã€‚ç”±äºç›´æ¥è°ƒç”¨æ²¡å•¥å¯è¯´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç•¥è¿‡ä¸è°ˆï¼Œåªè¯´é—´æ¥è°ƒç”¨ã€‚</p><p>åœ¨ Go é‡Œé¢ï¼Œé—´æ¥è°ƒç”¨çš„å®ç°å¦‚ä¸‹å›¾ï¼š</p><p><img data-src="https://static.purewhite.io/uPic/2020-06-30/LMj4f9-image.png!webp_90"></p><p>å®é™…ä¸Šï¼ŒGo åˆ†é…äº†ä¸€ä¸ªé¢å¤–çš„å¯¹è±¡ï¼Œå…¶ç¬¬ä¸€ä¸ªå­—æ®µæ˜¯ä¸€ä¸ªæŒ‡å‘æˆ‘ä»¬çœŸå®å‡½æ•°çš„æŒ‡é’ˆï¼Œç¬¬äºŒä¸ªå¯¹è±¡æ˜¯ä¸å‡½æ•°å¼ºç›¸å…³çš„ä¸€äº›æ•°æ®ï¼ˆå¯¹ï¼Œæ²¡é”™ï¼Œè¯´çš„å°±æ˜¯æ¥æ”¶è€… receiverï¼‰ã€‚äºæ˜¯ï¼Œä¸€æ¬¡å‡½æ•°è°ƒç”¨å®é™…ä¸Šä¼šç”Ÿæˆç±»ä¼¼å¦‚ä¸‹çš„ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MOV â€¦, R0</span><br><span class="line">MOV 0(R0), R1</span><br><span class="line">CALL R1  # called code can access â€œdataâ€ using R0</span><br></pre></td></tr></table></figure><p>æœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œå°±æ˜¯å½“ä¸€ä¸ªå‡½æ•°å¹¶æ²¡æœ‰ç›¸å…³æ•°æ®ï¼Œå¦‚ä»…ä»…ä¼šæ•è·å¤–éƒ¨çš„å±€éƒ¨å˜é‡çš„å‡½æ•°å­—é¢é‡ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°å°±ä¸ä¼šæœ‰ç›¸å…³è”çš„æ•°æ®ï¼Œäºæ˜¯å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š</p><p><img data-src="https://static.purewhite.io/uPic/2020-06-30/dkSyuM-image-20200630183251856.png!webp_90"></p><p>åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼ŒGo ä¼šå°†è¿™ä¸ªå˜é‡çš„åˆ†é…ä¼˜åŒ–åœ¨åªè¯»åŒºï¼Œä¸ä¼šåœ¨æ¯æ¬¡è°ƒç”¨æ—¶éƒ½è¿›è¡Œåˆ†é…ï¼Œä¹Ÿå°±æ˜¯ç”Ÿæˆå¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MOV $MyFuncÂ·f(SB), f1</span><br><span class="line"></span><br><span class="line">DATA MyFuncÂ·f(SB)/8, $MyFunc(SB)</span><br><span class="line">GLOBL MyFuncÂ·f(SB), 10, $8</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬å…¶å®ä¸å¿…å¤ªè¿‡æ‹…å¿ƒè¿™ç§åœºæ™¯ä¸‹çš„æ€§èƒ½æŸè€—ï¼Œåœ¨è¿™ç§åœºæ™¯ä¸‹æ˜¯ 0 æŸè€—çš„ã€‚</p><p>å¯¹äºéä¾‹å¤–çš„åœºæ™¯ï¼Œä¸€ä¸ªé€‚é…å™¨å‡½æ•°ç”Ÿæˆçš„ä»£ç ç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> funcValue <span class="keyword">struct</span> &#123;</span><br><span class="line">f <span class="keyword">uintptr</span> <span class="comment">// æŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆ</span></span><br><span class="line">r associatedType</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™é‡Œä¸ºå®é™…å‡½æ•°ç­¾å</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">funcAdapter</span><span class="params">(...)</span> <span class="params">(...)</span></span> &#123;</span><br><span class="line">r := (associatedType)(R0 + <span class="number">8</span>)</span><br><span class="line"><span class="keyword">return</span> r.f(...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f := &amp;funcValue&#123;funcAdapter, r&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è°ƒç”¨æ—¶ï¼Œè°ƒç”¨çš„å®é™…ä¸Šæ˜¯é€‚é…å™¨å‡½æ•°ï¼Œé€‚é…å™¨å‡½æ•°éšåå»è°ƒç”¨çœŸå®çš„å‡½æ•°ã€‚</p><h3 id="ä¸ºå•¥è¦è¿™ä¹ˆå¹²å‘¢ï¼Ÿ"><a href="#ä¸ºå•¥è¦è¿™ä¹ˆå¹²å‘¢ï¼Ÿ" class="headerlink" title="ä¸ºå•¥è¦è¿™ä¹ˆå¹²å‘¢ï¼Ÿ"></a>ä¸ºå•¥è¦è¿™ä¹ˆå¹²å‘¢ï¼Ÿ</h3><p>å…¶å®æƒ³æƒ³ä¹Ÿå¾ˆç®€å•ï¼Œå¯¹äºå€¼æ¥æ”¶è€…å’ŒæŒ‡é’ˆæ¥æ”¶è€…å‡½æ•°ï¼Œè°ƒç”¨æ—¶ç¬¬ä¸€ä¸ªå‚æ•°ä¸º selfï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ç°åœ¨æ˜¯éœ€è¦æŠŠæŸä¸ªå…³è”åœ¨ç‰¹å®šå€¼ / æŒ‡é’ˆä¸Šçš„å‡½æ•°ä½œä¸ºä¸€ä¸ªå‡½æ•°å€¼èµ‹å€¼ç»™æŸä¸ªå‡½æ•°å˜é‡æ—¶ï¼Œæˆ‘ä¹Ÿéœ€è¦ä¸€èµ·æŠŠå¯¹åº”çš„å€¼ / æŒ‡é’ˆä¿¡æ¯ä¸€èµ·å¸¦ä¸Šï¼Œä¸ç„¶ç­‰æˆ‘çœŸæ­£è°ƒç”¨çš„æ—¶å€™ï¼Œæˆ‘æ€ä¹ˆçŸ¥é“åº”è¯¥è°ƒç”¨çš„æ˜¯å“ªä¸ªå€¼ / æŒ‡é’ˆä¸Šçš„æ–¹æ³•å‘¢ï¼Ÿä¹Ÿå°±æ˜¯è¯´ï¼Œä¼ å…¥å‡½æ•°çš„ self å€¼åº”è¯¥æ˜¯å¤šå°‘å‘¢ï¼Ÿ</p><h2 id="è¯´äº†é‚£ä¹ˆå¤šï¼Œåˆ°åº•ä¸ºå•¥å‘¢ï¼Ÿ"><a href="#è¯´äº†é‚£ä¹ˆå¤šï¼Œåˆ°åº•ä¸ºå•¥å‘¢ï¼Ÿ" class="headerlink" title="è¯´äº†é‚£ä¹ˆå¤šï¼Œåˆ°åº•ä¸ºå•¥å‘¢ï¼Ÿ"></a>è¯´äº†é‚£ä¹ˆå¤šï¼Œåˆ°åº•ä¸ºå•¥å‘¢ï¼Ÿ</h2><p>å›åˆ°æˆ‘ä»¬å¼€å¤´çš„é—®é¢˜ï¼Œå¯ä»¥çœ‹åˆ°é€ æˆä¸¤æ¬¡å†…å­˜åˆ†é…çš„ç½ªé­ç¥¸é¦–å·²ç„¶æ‰¾åˆ°ï¼Œåœ¨æ±‡ç¼–ä»£ç é‡Œé¢å…¶å®ä¹Ÿå·²ç»èƒ½çœ‹å‡ºç«¯å€ªï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> 0x0031 00049 (main.go:42)PCDATA$0, $1</span><br><span class="line">0x0031 00049 (main.go:42)LEAQtype.noalg.struct &#123; F uintptr; R *&quot;&quot;.myFuncImplStruct &#125;(SB), AX</span><br><span class="line">0x0038 00056 (main.go:42)PCDATA$0, $0</span><br><span class="line">0x0038 00056 (main.go:42)MOVQAX, (SP)</span><br><span class="line">0x003c 00060 (main.go:42)CALLruntime.newobject(SB)</span><br><span class="line">0x0041 00065 (main.go:42)PCDATA$0, $1</span><br><span class="line">0x0041 00065 (main.go:42)MOVQ8(SP), AX</span><br><span class="line">0x0046 00070 (main.go:42)LEAQ&quot;&quot;.(*myFuncImplStruct).myFunc-fm(SB), CX</span><br><span class="line">0x004d 00077 (main.go:42)MOVQCX, (AX)</span><br><span class="line">0x0050 00080 (main.go:42)PCDATA$0, $2</span><br><span class="line">0x0050 00080 (main.go:42)LEAQruntime.zerobase(SB), CX</span><br><span class="line">0x0057 00087 (main.go:42)PCDATA$0, $1</span><br><span class="line">0x0057 00087 (main.go:42)MOVQCX, 8(AX)</span><br><span class="line">0x005b 00091 (main.go:42)PCDATA$0, $0</span><br><span class="line">0x005b 00091 (main.go:42)MOVQAX, (SP)</span><br><span class="line">0x005f 00095 (main.go:42)CALL&quot;&quot;.newFuncContainer(SB)</span><br><span class="line">0x0064 00100 (main.go:43)PCDATA$0, $1</span><br><span class="line">0x0064 00100 (main.go:43)LEAQtype.noalg.struct &#123; F uintptr; R &quot;&quot;.myFuncImplStruct &#125;(SB), AX</span><br><span class="line">0x006b 00107 (main.go:43)PCDATA$0, $0</span><br><span class="line">0x006b 00107 (main.go:43)MOVQAX, (SP)</span><br><span class="line">0x006f 00111 (main.go:43)CALLruntime.newobject(SB)</span><br><span class="line">0x0074 00116 (main.go:43)PCDATA$0, $1</span><br><span class="line">0x0074 00116 (main.go:43)MOVQ8(SP), AX</span><br><span class="line">0x0079 00121 (main.go:43)LEAQ&quot;&quot;.myFuncImplStruct.myFunc2-fm(SB), CX</span><br><span class="line">0x0080 00128 (main.go:43)MOVQCX, (AX)</span><br><span class="line">0x0083 00131 (main.go:43)PCDATA$0, $0</span><br><span class="line">0x0083 00131 (main.go:43)MOVQAX, (SP)</span><br><span class="line">0x0087 00135 (main.go:43)CALL&quot;&quot;.newFuncContainer(SB)</span><br></pre></td></tr></table></figure><p>æ³¨æ„ä¸Šè¿° <code>LEAQ    type.noalg.struct &#123; F uintptr; R *&quot;&quot;.myFuncImplStruct &#125;(SB), AX</code>è¿™æ®µä»£ç ï¼Œå’±ä¹Ÿåˆ«ç®¡å•¥æ„æ€ï¼Œåæ­£çœ‹åˆ°äº†ä¸€ä¸ªå’Œä¹‹å‰è¯´çš„é€‚é…å™¨å¾ˆåƒçš„ä¸€ä¸ª structï¼Œè¿™ä¸ª struct æœ‰ä¸¤ä¸ªå­—æ®µï¼Œç¬¬ä¸€ä¸ªæ˜¯<code>F uintptr</code>ï¼Œç¬¬äºŒä¸ªæ˜¯<code>R *myFuncImplStruct</code>ï¼›ä¸‹é¢è¿˜æœ‰ä¸€ä¸ª<code>LEAQ    type.noalg.struct &#123; F uintptr; R &quot;&quot;.myFuncImplStruct &#125;(SB), AX</code>ï¼Œåªä¸è¿‡è¿™é‡Œçš„ R æ˜¯<code>myFuncImplStruct</code>çš„å€¼è€Œä¸æ˜¯æŒ‡é’ˆï¼Œè¿™æ­£å¥½å’Œæˆ‘ä»¬ä»£ç å»åˆã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¥½äº†ï¼Œåˆ°è¿™åŸºæœ¬ä¸Šè¿™ä¸ªé—®é¢˜æ¸…æ¥šäº†ï¼Œè¦ä¼˜åŒ–çš„è¯ä¹Ÿå¾ˆç®€å•ï¼Œåªè¦æŠŠå®é™…ä¸Šå¹¶ä¸éœ€è¦æœ‰å€¼æ¥æ”¶è€…æˆ–è€…æŒ‡é’ˆæ¥æ”¶è€…çš„å‡½æ•°æ”¹ä¸ºé¡¶å±‚å‡½æ•°å³å¯ï¼Œæˆ–è€…å°½å¯èƒ½ä¸è¦å°†ä¸€ä¸ªå€¼æ¥æ”¶è€… / æŒ‡é’ˆæ¥æ”¶è€…å‡½æ•°è¿›è¡Œé—´æ¥è°ƒç”¨ã€‚</p><p>ç”±æ­¤å¯ä»¥çœ‹å‡ºï¼Œæœ‰æ¥æ”¶è€…çš„å‡½æ•°æ˜¯æœ‰ä»£ä»·çš„ï¼Œä¸èƒ½ä¹±ç”¨å•Šï¼Œä»£ç è®¾è®¡è¿˜æ˜¯è¦åˆç†ï¼Œå¦åˆ™æ˜¯ä¼šå¼•å…¥é¢å¤–çš„æ€§èƒ½å¼€é”€çš„ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol><li><a href="https://docs.google.com/document/d/1bMwCey-gmqZVTpRax-ESeVuZGmjwbocYs1iHplK-cjo/pub">https://docs.google.com/document/d/1bMwCey-gmqZVTpRax-ESeVuZGmjwbocYs1iHplK-cjo/pub</a></li></ol>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;ç¼˜èµ·&quot;&gt;&lt;a href=&quot;#ç¼˜èµ·&quot; class=&quot;headerlink&quot; title=&quot;ç¼˜èµ·&quot;&gt;&lt;/a&gt;ç¼˜èµ·&lt;/h2&gt;&lt;p&gt;è¿™å‡ å¤©åœ¨é‡æ„æŸæ®µä»£ç åï¼Œåšäº†ä¸€æ¬¡æ€§èƒ½æµ‹è¯•ï¼Œç«ç„°å›¾ä¸­å‘ç°äº†ä¸€ä¸ªååˆ†å¥‡æ€ªçš„&lt;code&gt;runtime.newobject&lt;/code&gt;çš„è°ƒç”¨ï¼Œå¤§è‡´å ç”¨2%ï¼Œè€Œæ‰¾éäº†æ•´æ®µä»£ç éƒ½æ²¡æœ‰å‘ç°æœ‰æ–°å»ºå¯¹è±¡ç›¸å…³çš„é€»è¾‘ã€‚äºæ˜¯è¿«ä¸å¾—å·²ï¼Œç¥­å‡ºäº†æ±‡ç¼–å¤§æ³•ï¼Œç»ˆäºå®šä½åˆ°äº†é—®é¢˜æ‰€åœ¨ã€‚è¿™ç¯‡æ–‡ç« ä¼šä½¿ç”¨ä¸€æ®µæœ€å°å¯å¤ç°çš„ä»£ç æ¥åˆ†äº«è¿™ä¸ªé—®é¢˜ä»¥åŠèƒŒåçš„åŸå› ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="go" scheme="https://www.purewhite.io/categories/go/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="go" scheme="https://www.purewhite.io/tags/go/"/>
    
    <category term="asm" scheme="https://www.purewhite.io/tags/asm/"/>
    
  </entry>
  
  <entry>
    <title>golang åœ¨ runtime ä¸­çš„ä¸€äº›éªšä¸œè¥¿</title>
    <link href="https://www.purewhite.io/2019/11/28/runtime-hacking-translate/"/>
    <id>https://www.purewhite.io/2019/11/28/runtime-hacking-translate/</id>
    <published>2019-11-28T14:00:43.000Z</published>
    <updated>2021-12-02T12:51:07.229Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨ç ”ç©¶æ€§èƒ½ä¼˜åŒ–çš„æ—¶å€™ï¼Œçœ‹åˆ°äº† golang runtime åŒ…ä¸‹çš„ä¸€ä¸ªæ–‡æ¡£<a href="https://github.com/golang/go/blob/master/src/runtime/HACKING.md"><code>HACKING.md</code></a>è§‰å¾—é¢‡æœ‰æ„æ€ï¼Œè¯»å®Œä¹‹åè§‰å¾—å¯¹äº runtime çš„ç†è§£æ›´ä¸Šä¸€å±‚ï¼Œäºæ˜¯æƒ³ç€ç¿»è¯‘ä¸€ä¸‹ã€‚</p><p>æœ¬ç« å†…å®¹ä¼šæœ‰ä¸€å®šæ·±åº¦ï¼Œéœ€è¦æœ‰ä¸€å®šåŸºç¡€çš„è¯»è€…ï¼Œé™äºç¯‡å¹…åœ¨è¿™é‡Œä¸å¯èƒ½å®Œå…¨å±•å¼€å„ä¸ªç»†èŠ‚ã€‚</p><p>è¿™ä¸€ç¯‡æ–‡æ¡£é¢å‘çš„è¯»è€…æ˜¯ runtime çš„å¼€å‘è€…ï¼Œæ‰€ä»¥æœ‰å¾ˆå¤šå†…å®¹åœ¨æˆ‘ä»¬æ™®é€šä½¿ç”¨ä¸­æ˜¯æ¥è§¦ä¸åˆ°çš„ã€‚</p><span id="more"></span><p>è¿™ç¯‡æ–‡æ¡£æ˜¯ä¼šè¢«ç»å¸¸ç¼–è¾‘çš„ï¼Œå¹¶ä¸”éšç€æ—¶é—´æ¨ç§»ç›®å‰çš„å†…å®¹å¯èƒ½ä¼šè¿‡æ—¶ã€‚è¿™ç¯‡æ–‡æ¡£æ—¨åœ¨è¯´æ˜å†™ runtime ä»£ç å’Œæ™®é€šçš„ go ä»£ç æœ‰ä»€ä¹ˆä¸åŒï¼Œæ‰€ä»¥å…³æ³¨äºä¸€äº›æ™®éçš„æ¦‚å¿µè€Œä¸æ˜¯ä¸€äº›ç»†èŠ‚çš„å®ç°ã€‚</p><h1 id="è°ƒåº¦å™¨ç»“æ„"><a href="#è°ƒåº¦å™¨ç»“æ„" class="headerlink" title="è°ƒåº¦å™¨ç»“æ„"></a>è°ƒåº¦å™¨ç»“æ„</h1><p>è°ƒåº¦å™¨ç®¡ç†ä¸‰ä¸ªåœ¨ runtime ä¸­ååˆ†é‡è¦çš„ç±»å‹ï¼š<code>G</code>ã€<code>M</code>å’Œ<code>P</code>ã€‚å“ªæ€•ä½ ä¸å†™ scheduler ç›¸å…³ä»£ç ï¼Œä½ ä¹Ÿåº”å½“è¦äº†è§£è¿™äº›æ¦‚å¿µã€‚</p><h2 id="Gã€M-å’Œ-P"><a href="#Gã€M-å’Œ-P" class="headerlink" title="Gã€M å’Œ P"></a>Gã€M å’Œ P</h2><p>ä¸€ä¸ª<code>G</code>å°±æ˜¯ä¸€ä¸ª goroutineï¼Œåœ¨ runtime ä¸­é€šè¿‡ç±»å‹<code>g</code>æ¥è¡¨ç¤ºã€‚å½“ä¸€ä¸ª goroutine é€€å‡ºæ—¶ï¼Œ<code>g</code>å¯¹è±¡ä¼šè¢«æ”¾åˆ°ä¸€ä¸ªç©ºé—²çš„<code>g</code>å¯¹è±¡æ± ä¸­ä»¥ç”¨äºåç»­çš„ goroutine çš„ä½¿ç”¨ï¼ˆè¯‘è€…æ³¨ï¼šå‡å°‘å†…å­˜åˆ†é…å¼€é”€ï¼‰ã€‚</p><p>ä¸€ä¸ª<code>M</code>å°±æ˜¯ä¸€ä¸ªç³»ç»Ÿçš„çº¿ç¨‹ï¼Œç³»ç»Ÿçº¿ç¨‹å¯ä»¥æ‰§è¡Œç”¨æˆ·çš„ go ä»£ç ã€runtime ä»£ç ã€ç³»ç»Ÿè°ƒç”¨æˆ–è€…ç©ºé—²ç­‰å¾…ã€‚åœ¨ runtime ä¸­é€šè¿‡ç±»å‹<code>m</code>æ¥è¡¨ç¤ºã€‚åœ¨åŒä¸€æ—¶é—´ï¼Œå¯èƒ½æœ‰ä»»æ„æ•°é‡çš„<code>M</code>ï¼Œå› ä¸ºä»»æ„æ•°é‡çš„<code>M</code>å¯èƒ½ä¼šé˜»å¡åœ¨ç³»ç»Ÿè°ƒç”¨ä¸­ã€‚ï¼ˆè¯‘è€…æ³¨ï¼šå½“ä¸€ä¸ª<code>M</code>æ‰§è¡Œé˜»å¡çš„ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä¼šå°†<code>M</code>å’Œ<code>P</code>è§£ç»‘ï¼Œå¹¶åˆ›å»ºå‡ºä¸€ä¸ªæ–°çš„<code>M</code>æ¥æ‰§è¡Œ<code>P</code>ä¸Šçš„å…¶å®ƒ<code>G</code>ã€‚ï¼‰</p><p>æœ€åï¼Œä¸€ä¸ª<code>P</code>ä»£è¡¨äº†æ‰§è¡Œç”¨æˆ· go ä»£ç æ‰€éœ€è¦çš„èµ„æºï¼Œæ¯”å¦‚è°ƒåº¦å™¨çŠ¶æ€ã€å†…å­˜åˆ†é…å™¨çŠ¶æ€ç­‰ã€‚åœ¨ runtime ä¸­é€šè¿‡ç±»å‹<code>p</code>æ¥è¡¨ç¤ºã€‚<code>P</code>çš„æ•°é‡ç²¾ç¡®åœ°ï¼ˆexactlyï¼‰ç­‰äº<code>GOMAXPROCS</code>ã€‚ä¸€ä¸ª<code>P</code>å¯ä»¥è¢«ç†è§£ä¸ºæ˜¯æ“ä½œç³»ç»Ÿè°ƒåº¦å™¨ä¸­çš„ CPUï¼Œ<code>p</code>ç±»å‹å¯ä»¥è¢«ç†è§£ä¸ºæ˜¯æ¯ä¸ª CPU çš„çŠ¶æ€ã€‚åœ¨è¿™é‡Œå¯ä»¥æ”¾ä¸€äº›éœ€è¦é«˜æ•ˆå…±äº«ä½†å¹¶ä¸æ˜¯é’ˆå¯¹æ¯ä¸ª<code>P</code>ï¼ˆPer <code>P</code>ï¼‰æˆ–è€…æ¯ä¸ª<code>M</code>ï¼ˆPer <code>M</code>ï¼‰çš„çŠ¶æ€ï¼ˆè¯‘è€…æ³¨ï¼šæ„æ€æ˜¯ï¼Œå¯ä»¥æ”¾ä¸€äº›ä»¥<code>P</code>çº§åˆ«å…±äº«çš„æ•°æ®ï¼‰ã€‚</p><p>è°ƒåº¦å™¨çš„å·¥ä½œæ˜¯å°†ä¸€ä¸ª<code>G</code>ï¼ˆéœ€è¦æ‰§è¡Œçš„ä»£ç ï¼‰ã€ä¸€ä¸ª<code>M</code>ï¼ˆä»£ç æ‰§è¡Œçš„åœ°æ–¹ï¼‰å’Œä¸€ä¸ª<code>P</code>ï¼ˆä»£ç æ‰§è¡Œæ‰€éœ€è¦çš„æƒé™å’Œèµ„æºï¼‰ç»“åˆèµ·æ¥ã€‚å½“ä¸€ä¸ª<code>M</code>åœæ­¢æ‰§è¡Œç”¨æˆ·ä»£ç çš„æ—¶å€™ï¼ˆæ¯”å¦‚è¿›å…¥é˜»å¡çš„ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ï¼‰ï¼Œå°±éœ€è¦æŠŠå®ƒçš„<code>P</code>å½’è¿˜åˆ°ç©ºé—²çš„<code>P</code>æ± ä¸­ï¼›ä¸ºäº†ç»§ç»­æ‰§è¡Œç”¨æˆ·çš„ go ä»£ç ï¼ˆæ¯”å¦‚ä»é˜»å¡çš„ç³»ç»Ÿè°ƒç”¨é€€å‡ºçš„æ—¶å€™ï¼‰ï¼Œå°±éœ€è¦ä»ç©ºé—²çš„<code>P</code>æ± ä¸­è·å–ä¸€ä¸ª<code>P</code>ã€‚</p><p>æ‰€æœ‰çš„<code>g</code>ã€<code>m</code>å’Œ<code>p</code>å¯¹è±¡éƒ½æ˜¯åˆ†é…åœ¨å †ä¸Šä¸”æ°¸ä¸é‡Šæ”¾çš„ï¼Œæ‰€ä»¥å®ƒä»¬çš„å†…å­˜ä½¿ç”¨æ˜¯å¾ˆç¨³å®šçš„ã€‚å¾—ç›Šäºæ­¤ï¼Œruntime å¯ä»¥åœ¨è°ƒåº¦å™¨å®ç°ä¸­é¿å…å†™å±éšœï¼ˆè¯‘è€…æ³¨ï¼šåƒåœ¾å›æ”¶æ—¶éœ€è¦çš„ä¸€ç§å±éšœï¼Œä¼šå¸¦æ¥ä¸€äº›æ€§èƒ½å¼€é”€ï¼‰ã€‚</p><h2 id="ç”¨æˆ·æ ˆå’Œç³»ç»Ÿæ ˆ"><a href="#ç”¨æˆ·æ ˆå’Œç³»ç»Ÿæ ˆ" class="headerlink" title="ç”¨æˆ·æ ˆå’Œç³»ç»Ÿæ ˆ"></a>ç”¨æˆ·æ ˆå’Œç³»ç»Ÿæ ˆ</h2><p>æ¯ä¸ªå­˜æ´»ç€çš„ï¼ˆnon-deadï¼‰<code>G</code>éƒ½ä¼šæœ‰ä¸€ä¸ªç›¸å…³è”çš„ç”¨æˆ·æ ˆï¼Œç”¨æˆ·çš„ä»£ç å°±æ˜¯åœ¨è¿™ä¸ªç”¨æˆ·æ ˆä¸Šæ‰§è¡Œçš„ã€‚ç”¨æˆ·æ ˆä¸€å¼€å§‹å¾ˆå°ï¼ˆæ¯”å¦‚ 2Kï¼‰ï¼Œå¹¶ä¸”åŠ¨æ€åœ°ç”Ÿé•¿æˆ–è€…æ”¶ç¼©ã€‚</p><p>æ¯ä¸€ä¸ª<code>M</code>éƒ½æœ‰ä¸€ä¸ªç›¸å…³è”çš„ç³»ç»Ÿæ ˆï¼ˆä¹Ÿè¢«ç§°ä¸º<code>g0</code>æ ˆï¼Œå› ä¸ºè¿™ä¸ªæ ˆä¹Ÿæ˜¯é€šè¿‡<code>g</code>å®ç°çš„ï¼‰ï¼›å¦‚æœæ˜¯åœ¨ Unix å¹³å°ä¸Šï¼Œè¿˜ä¼šæœ‰ä¸€ä¸ª <code>signal</code>æ ˆï¼ˆä¹Ÿè¢«ç§°ä¸º<code>gsignal</code>æ ˆï¼‰ã€‚ç³»ç»Ÿæ ˆå’Œ<code>signal</code>æ ˆä¸èƒ½ç”Ÿé•¿ï¼Œä½†æ˜¯è¶³å¤Ÿå¤§åˆ°è¿è¡Œä»»ä½• runtime å’Œ cgo çš„ä»£ç ï¼ˆåœ¨çº¯ go äºŒè¿›åˆ¶ä¸­ä¸º 8Kï¼Œåœ¨ cgo æƒ…å†µä¸‹ç”±ç³»ç»Ÿåˆ†é…ï¼‰ã€‚</p><p>runtime ä»£ç ç»å¸¸é€šè¿‡è°ƒç”¨<code>systemstack</code>ã€<code>mcall</code>æˆ–è€…<code>asmcgocall</code>ä¸´æ—¶æ€§çš„åˆ‡æ¢åˆ°ç³»ç»Ÿæ ˆå»æ‰§è¡Œä¸€äº›ç‰¹æ®Šçš„ä»»åŠ¡ï¼Œæ¯”å¦‚ï¼šä¸èƒ½è¢«æŠ¢å çš„ã€ä¸åº”è¯¥æ‰©å¼ ç”¨æˆ·æ ˆçš„å’Œä¼šåˆ‡æ¢ç”¨æˆ· goroutine çš„ã€‚åœ¨ç³»ç»Ÿæ ˆä¸Šè¿è¡Œçš„ä»£ç éšå«äº†ä¸å¯æŠ¢å çš„å«ä¹‰ï¼ŒåŒæ—¶åƒåœ¾å›æ”¶å™¨ä¸ä¼šæ‰«æç³»ç»Ÿæ ˆã€‚å½“ä¸€ä¸ª<code>M</code>åœ¨ç³»ç»Ÿæ ˆä¸Šè¿è¡Œæ—¶ï¼Œå½“å‰çš„ç”¨æˆ·æ ˆæ˜¯æ²¡æœ‰è¢«è¿è¡Œçš„ã€‚</p><h2 id="getg-å’Œgetg-m-curg"><a href="#getg-å’Œgetg-m-curg" class="headerlink" title="getg()å’Œgetg().m.curg"></a><code>getg()</code>å’Œ<code>getg().m.curg</code></h2><p>å¦‚æœæƒ³è¦è·å–å½“å‰ç”¨æˆ·çš„<code>g</code>ï¼Œéœ€è¦ä½¿ç”¨<code>getg().m.curg</code>ã€‚</p><p><code>getg()</code>è™½ç„¶ä¼šè¿”å›å½“å‰çš„<code>g</code>ï¼Œä½†æ˜¯å½“æ­£åœ¨ç³»ç»Ÿæ ˆæˆ–è€…<code>signal</code>æ ˆä¸Šæ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šè¿”å›çš„æ˜¯å½“å‰<code>M</code>çš„<code>g0</code>æˆ–è€…<code>gsignal</code>ï¼Œè€Œè¿™å¾ˆå¯èƒ½ä¸æ˜¯ä½ æƒ³è¦çš„ã€‚</p><p>å¦‚æœè¦åˆ¤æ–­å½“å‰æ­£åœ¨ç³»ç»Ÿæ ˆä¸Šæ‰§è¡Œè¿˜æ˜¯ç”¨æˆ·æ ˆä¸Šæ‰§è¡Œï¼Œå¯ä»¥ä½¿ç”¨<code>getg() == getg().m.curg</code>ã€‚</p><h1 id="é”™è¯¯å¤„ç†å’Œä¸ŠæŠ¥"><a href="#é”™è¯¯å¤„ç†å’Œä¸ŠæŠ¥" class="headerlink" title="é”™è¯¯å¤„ç†å’Œä¸ŠæŠ¥"></a>é”™è¯¯å¤„ç†å’Œä¸ŠæŠ¥</h1><p>åœ¨ç”¨æˆ·ä»£ç ä¸­ï¼Œæœ‰ä¸€äº›å¯ä»¥è¢«åˆç†åœ°ï¼ˆreasonablyï¼‰æ¢å¤çš„é”™è¯¯å¯ä»¥åƒå¾€å¸¸ä¸€æ ·ä½¿ç”¨<code>panic</code>ï¼Œä½†æ˜¯æœ‰ä¸€äº›æƒ…å†µä¸‹ï¼Œ<code>panic</code>å¯èƒ½å¯¼è‡´ç«‹å³çš„è‡´å‘½çš„é”™è¯¯ï¼Œæ¯”å¦‚åœ¨ç³»ç»Ÿæ ˆä¸­è°ƒç”¨æˆ–è€…å½“æ‰§è¡Œ<code>mallocgc</code>æ—¶ã€‚</p><p>å¤§éƒ¨åˆ†çš„ runtime çš„é”™è¯¯æ˜¯ä¸å¯æ¢å¤çš„ï¼Œå¯¹äºè¿™äº›ä¸å¯æ¢å¤çš„é”™è¯¯åº”è¯¥ä½¿ç”¨<code>throw</code>ï¼Œ<code>throw</code>ä¼šæ‰“å°å‡º<code>traceback</code>å¹¶ç«‹å³ç»ˆæ­¢è¿›ç¨‹ã€‚<code>throw</code>åº”å½“è¢«ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡ä»¥é¿å…åœ¨è¯¥æƒ…å†µä¸‹è¿˜éœ€è¦ä¸º string åˆ†é…å†…å­˜ã€‚æ ¹æ®çº¦å®šï¼Œæ›´å¤šçš„ä¿¡æ¯åº”å½“åœ¨<code>throw</code>ä¹‹å‰ä½¿ç”¨<code>print</code>æˆ–è€…<code>println</code>æ‰“å°å‡ºæ¥ï¼Œå¹¶ä¸”åº”å½“ä»¥<code>runtime.</code>å¼€å¤´ã€‚</p><p>ä¸ºäº†è¿›è¡Œ runtime çš„é”™è¯¯è°ƒè¯•ï¼Œæœ‰ä¸€ä¸ªå¾ˆå®ç”¨çš„æ–¹æ³•æ˜¯è®¾ç½®<code>GOTRACEBACK=system</code> æˆ– <code>GOTRACEBACK=crash</code>ã€‚</p><h1 id="åŒæ­¥"><a href="#åŒæ­¥" class="headerlink" title="åŒæ­¥"></a>åŒæ­¥</h1><p>runtime ä¸­æœ‰å¤šç§åŒæ­¥æœºåˆ¶ï¼Œè¿™äº›åŒæ­¥æœºåˆ¶ä¸ä»…æ˜¯è¯­ä¹‰ä¸Šä¸åŒï¼Œå’Œ go è°ƒåº¦å™¨ä»¥åŠæ“ä½œç³»ç»Ÿè°ƒåº¦å™¨ä¹‹é—´çš„äº¤äº’ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ã€‚</p><p>æœ€ç®€å•çš„å°±æ˜¯<code>mutex</code>ï¼Œå¯ä»¥ä½¿ç”¨<code>lock</code>å’Œ<code>unlock</code>æ¥æ“ä½œã€‚è¿™ç§æ–¹æ³•ä¸»è¦ç”¨æ¥çŸ­æœŸï¼ˆé•¿æœŸçš„è¯æ€§èƒ½å·®ï¼‰åœ°ä¿æŠ¤ä¸€äº›å…±äº«çš„æ•°æ®ã€‚åœ¨<code>mutex</code>ä¸Šé˜»å¡ä¼šç›´æ¥é˜»å¡æ•´ä¸ª<code>M</code>ï¼Œè€Œä¸ä¼šå’Œ go çš„è°ƒåº¦å™¨è¿›è¡Œäº¤äº’ã€‚å› æ­¤ï¼Œåœ¨ runtime ä¸­çš„æœ€åº•å±‚ä½¿ç”¨ <code>mutex</code>æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºå®ƒè¿˜ä¼šé˜»æ­¢ç›¸å…³è”çš„<code>G</code>å’Œ<code>P</code>è¢«é‡æ–°è°ƒåº¦ï¼ˆ<code>M</code>éƒ½é˜»å¡äº†ï¼Œæ— æ³•æ‰§è¡Œè°ƒåº¦äº†ï¼‰ã€‚<code>rwmutex</code>ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚</p><p>å¦‚æœæ˜¯è¦è¿›è¡Œä¸€æ¬¡æ€§çš„é€šçŸ¥ï¼Œå¯ä»¥ä½¿ç”¨<code>note</code>ã€‚<code>note</code>æä¾›äº†<code>notesleep</code>å’Œ<code>notewakeup</code>ã€‚ä¸åƒä¼ ç»Ÿçš„ UNIX çš„<code>sleep/wakeup</code>ï¼Œ<code>note</code>æ˜¯æ— ç«äº‰çš„ï¼ˆrace-freeï¼‰ï¼Œæ‰€ä»¥å¦‚æœ<code>notewakeup</code>å·²ç»å‘ç”Ÿäº†ï¼Œé‚£ä¹ˆ<code>notesleep</code>å°†ä¼šç«‹å³è¿”å›ã€‚<code>note</code>å¯ä»¥åœ¨ä½¿ç”¨åé€šè¿‡<code>noteclear</code>æ¥é‡ç½®ï¼Œä½†æ˜¯è¦æ³¨æ„<code>noteclear</code>å’Œ<code>notesleep</code>ã€<code>notewakeup</code>ä¸èƒ½å‘ç”Ÿç«äº‰ã€‚ç±»ä¼¼<code>mutex</code>ï¼Œé˜»å¡åœ¨<code>note</code>ä¸Šä¼šé˜»å¡æ•´ä¸ª<code>M</code>ã€‚ç„¶è€Œï¼Œ<code>note</code>æä¾›äº†ä¸åŒçš„æ–¹å¼æ¥è°ƒç”¨<code>sleep</code>ï¼š<code>notesleep</code>ä¼šé˜»æ­¢ç›¸å…³è”çš„<code>G</code>å’Œ<code>P</code>è¢«é‡æ–°è°ƒåº¦ï¼›<code>notetsleepg</code>çš„è¡¨ç°å´åƒä¸€ä¸ªé˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ä¸€æ ·ï¼Œå…è®¸<code>P</code>è¢«é‡ç”¨å»è¿è¡Œå¦ä¸€ä¸ª<code>G</code>ã€‚å°½ç®¡å¦‚æ­¤ï¼Œè¿™ä»ç„¶æ¯”ç›´æ¥é˜»å¡ä¸€ä¸ª<code>G</code>è¦ä½æ•ˆï¼Œå› ä¸ºè¿™éœ€è¦æ¶ˆè€—ä¸€ä¸ª<code>M</code>ã€‚</p><p>å¦‚æœéœ€è¦ç›´æ¥å’Œ go è°ƒåº¦å™¨äº¤äº’ï¼Œå¯ä»¥ä½¿ç”¨<code>gopark</code>å’Œ<code>goready</code>ã€‚<code>gopark</code>æŒ‚èµ·å½“å‰çš„ goroutineâ€”â€”æŠŠå®ƒå˜æˆ<code>waiting</code>çŠ¶æ€ï¼Œå¹¶ä»è°ƒåº¦å™¨çš„è¿è¡Œé˜Ÿåˆ—ä¸­ç§»é™¤â€”â€”ç„¶åè°ƒåº¦å¦ä¸€ä¸ª goroutine åˆ°å½“å‰çš„<code>M</code>æˆ–è€…<code>P</code>ã€‚<code>goready</code>å°†ä¸€ä¸ªè¢«æŒ‚èµ·çš„ goroutine æ¢å¤åˆ°<code>runnable</code>çŠ¶æ€å¹¶å°†å®ƒæ”¾åˆ°è¿è¡Œé˜Ÿåˆ—ä¸­ã€‚</p><p>æ€»ç»“èµ·æ¥å¦‚ä¸‹è¡¨ï¼š</p><table><tbody><tr><th></th><th colspan="3">Blocks</th></tr><tr><th>Interface</th><th>G</th><th>M</th><th>P</th></tr><tr><td>(rw)mutex</td><td>Y</td><td>Y</td><td>Y</td></tr><tr><td>note</td><td>Y</td><td>Y</td><td>Y/N</td></tr><tr><td>park</td><td>Y</td><td>N</td><td>N</td></tr></tbody></table><h1 id="åŸå­æ€§"><a href="#åŸå­æ€§" class="headerlink" title="åŸå­æ€§"></a>åŸå­æ€§</h1><p>runtime ä½¿ç”¨<code>runtime/internal/atomic</code>ä¸­è‡ªæœ‰çš„ä¸€äº›åŸå­æ“ä½œã€‚è¿™ä¸ªå’Œ<code>sync/atomic</code>æ˜¯å¯¹åº”çš„ï¼Œé™¤äº†æ–¹æ³•åç”±äºå†å²åŸå› æœ‰ä¸€äº›åŒºåˆ«ï¼Œå¹¶ä¸”æœ‰ä¸€äº›é¢å¤–çš„ runtime éœ€è¦çš„æ–¹æ³•ã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬å¯¹äº runtime ä¸­ atomic çš„ä½¿ç”¨éå¸¸è°¨æ…ï¼Œå¹¶ä¸”å°½å¯èƒ½é¿å…ä¸éœ€è¦çš„åŸå­æ“ä½œã€‚å¦‚æœå¯¹äºä¸€ä¸ªå˜é‡çš„è®¿é—®å·²ç»è¢«å¦ä¸€ç§åŒæ­¥æœºåˆ¶æ‰€ä¿æŠ¤ï¼Œé‚£ä¹ˆè¿™ä¸ªå·²ç»è¢«ä¿æŠ¤çš„è®¿é—®ä¸€èˆ¬å°±ä¸éœ€è¦æ˜¯åŸå­çš„ã€‚è¿™ä¹ˆåšä¸»è¦æœ‰ä»¥ä¸‹åŸå› ï¼š</p><ol><li>åˆç†åœ°ä½¿ç”¨éåŸå­å’ŒåŸå­æ“ä½œä½¿å¾—ä»£ç æ›´åŠ æ¸…æ™°å¯è¯»ï¼Œå¯¹äºä¸€ä¸ªå˜é‡çš„åŸå­æ“ä½œæ„å‘³ç€åœ¨å¦ä¸€å¤„å¯èƒ½ä¼šæœ‰å¹¶å‘çš„å¯¹äºè¿™ä¸ªå˜é‡çš„æ“ä½œã€‚</li><li>éåŸå­çš„æ“ä½œå…è®¸è‡ªåŠ¨çš„ç«äº‰æ£€æµ‹ã€‚runtime æœ¬èº«ç›®å‰å¹¶æ²¡æœ‰ä¸€ä¸ªç«äº‰æ£€æµ‹å™¨ï¼Œä½†æ˜¯æœªæ¥å¯èƒ½ä¼šæœ‰ã€‚åŸå­æ“ä½œä¼šä½¿å¾—ç«äº‰æ£€æµ‹å™¨å¿½è§†æ‰è¿™ä¸ªæ£€æµ‹ï¼Œä½†æ˜¯éåŸå­çš„æ“ä½œå¯ä»¥é€šè¿‡ç«äº‰æ£€æµ‹å™¨æ¥éªŒè¯ä½ çš„å‡è®¾ï¼ˆæ˜¯å¦ä¼šå‘ç”Ÿç«äº‰ï¼‰ã€‚</li><li>éåŸå­çš„æ“ä½œå¯ä»¥æé«˜æ€§èƒ½ã€‚</li></ol><p>å½“ç„¶ï¼Œæ‰€æœ‰å¯¹äºä¸€ä¸ªå…±äº«å˜é‡çš„éåŸå­çš„æ“ä½œéƒ½åº”å½“åœ¨æ–‡æ¡£ä¸­æ³¨æ˜è¯¥æ“ä½œæ˜¯å¦‚ä½•è¢«ä¿æŠ¤çš„ã€‚</p><p>æœ‰ä¸€äº›æ¯”è¾ƒæ™®éçš„å°†åŸå­æ“ä½œå’ŒéåŸå­æ“ä½œæ··åˆåœ¨ä¸€èµ·çš„åœºæ™¯æœ‰ï¼š</p><ul><li>å¤§éƒ¨åˆ†æ“ä½œéƒ½æ˜¯è¯»ï¼Œä¸”å†™æ“ä½œè¢«é”ä¿æŠ¤çš„å˜é‡ã€‚åœ¨é”ä¿æŠ¤çš„èŒƒå›´å†…ï¼Œè¯»æ“ä½œæ²¡å¿…è¦æ˜¯åŸå­çš„ï¼Œä½†æ˜¯å†™æ“ä½œå¿…é¡»æ˜¯åŸå­çš„ã€‚åœ¨é”ä¿æŠ¤çš„èŒƒå›´å¤–ï¼Œè¯»æ“ä½œå¿…é¡»æ˜¯åŸå­çš„ã€‚</li><li>ä»…ä»…åœ¨ STW æœŸé—´å‘ç”Ÿçš„è¯»æ“ä½œï¼Œä¸” STW æœŸé—´ä¸ä¼šæœ‰å†™æ“ä½œã€‚é‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œè¯»æ“ä½œä¸éœ€è¦æ˜¯åŸå­çš„ã€‚</li></ul><p>è¯è™½å¦‚æ­¤ï¼Œ<code>Go Memory Model</code>ç»™å‡ºçš„å»ºè®®ä»ç„¶æˆç«‹<code>Don&#39;t be [too] clever</code>ã€‚runtime çš„æ€§èƒ½å›ºç„¶é‡è¦ï¼Œä½†æ˜¯é²æ£’æ€§ï¼ˆrobustnessï¼‰å´æ›´åŠ é‡è¦ã€‚</p><h1 id="å †å¤–å†…å­˜ï¼ˆUnmanaged-memoryï¼‰"><a href="#å †å¤–å†…å­˜ï¼ˆUnmanaged-memoryï¼‰" class="headerlink" title="å †å¤–å†…å­˜ï¼ˆUnmanaged memoryï¼‰"></a>å †å¤–å†…å­˜ï¼ˆUnmanaged memoryï¼‰</h1><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œruntime ä¼šå°è¯•ä½¿ç”¨æ™®é€šçš„æ–¹æ³•æ¥ç”³è¯·å†…å­˜ï¼ˆå †ä¸Šå†…å­˜ï¼Œgc ç®¡ç†çš„ï¼‰ï¼Œç„¶è€Œåœ¨æŸäº›æƒ…å†µ runtime å¿…é¡»ç”³è¯·ä¸€äº›ä¸è¢« gc æ‰€ç®¡ç†çš„å †å¤–å†…å­˜ï¼ˆunmanaged memoryï¼‰ã€‚è¿™æ˜¯å¾ˆå¿…è¦çš„ï¼Œå› ä¸ºæœ‰å¯èƒ½è¯¥ç‰‡å†…å­˜å°±æ˜¯å†…å­˜ç®¡ç†å™¨è‡ªèº«ï¼Œæˆ–è€…è¯´è°ƒç”¨è€…æ²¡æœ‰ä¸€ä¸ª<code>P</code>ï¼ˆè¯‘è€…æ³¨ï¼šæ¯”å¦‚åœ¨è°ƒåº¦å™¨åˆå§‹åŒ–ä¹‹å‰ï¼Œæ˜¯ä¸å­˜åœ¨<code>P</code>çš„ï¼‰ã€‚</p><p>æœ‰ä¸‰ç§æ–¹å¼å¯ä»¥ç”³è¯·å †å¤–å†…å­˜ï¼š</p><ul><li><code>sysAlloc</code>ç›´æ¥ä»æ“ä½œç³»ç»Ÿè·å–å†…å­˜ï¼Œç”³è¯·çš„å†…å­˜å¿…é¡»æ˜¯ç³»ç»Ÿé¡µè¡¨é•¿åº¦çš„æ•´æ•°å€ã€‚å¯ä»¥é€šè¿‡<code>sysFree</code>æ¥é‡Šæ”¾ã€‚</li><li><code>persistentalloc</code>å°†å¤šä¸ªå°çš„å†…å­˜ç”³è¯·åˆå¹¶åœ¨ä¸€èµ·ä¸ºä¸€ä¸ªå¤§çš„<code>sysAlloc</code>ä»¥é¿å…å†…å­˜ç¢ç‰‡ï¼ˆfragmentationï¼‰ã€‚ç„¶è€Œï¼Œé¡¾åæ€ä¹‰ï¼Œé€šè¿‡<code>persistentalloc</code>ç”³è¯·çš„å†…å­˜æ˜¯æ— æ³•è¢«é‡Šæ”¾çš„ã€‚</li><li><code>fixalloc</code>æ˜¯ä¸€ä¸ª<a href="https://en.wikipedia.org/wiki/Slab_allocation"><code>SLAB</code></a>é£æ ¼çš„å†…å­˜åˆ†é…å™¨ï¼Œåˆ†é…å›ºå®šå¤§å°çš„å†…å­˜ã€‚é€šè¿‡<code>fixalloc</code>åˆ†é…çš„å¯¹è±¡å¯ä»¥è¢«é‡Šæ”¾ï¼Œä½†æ˜¯å†…å­˜ä»…å¯ä»¥è¢«ç›¸åŒçš„<code>fixalloc</code>æ± æ‰€é‡ç”¨ã€‚æ‰€ä»¥<code>fixalloc</code>é€‚åˆç”¨äºç›¸åŒç±»å‹çš„å¯¹è±¡ã€‚</li></ul><p>æ™®éæ¥è¯´ï¼Œä½¿ç”¨ä»¥ä¸Šä¸‰ç§æ–¹æ³•åˆ†é…å†…å­˜çš„ç±»å‹éƒ½åº”è¯¥è¢«æ ‡è®°ä¸º<code>//go:notinheap</code>ï¼ˆè§åæ–‡ï¼‰ã€‚</p><p>åœ¨å †å¤–å†…å­˜æ‰€åˆ†é…çš„å¯¹è±¡<strong>ä¸åº”è¯¥</strong>åŒ…å«å †ä¸Šçš„æŒ‡é’ˆå¯¹è±¡ï¼Œé™¤éåŒæ—¶éµå®ˆäº†ä»¥ä¸‹çš„è§„åˆ™ï¼š</p><ol><li>æ‰€æœ‰åœ¨å †å¤–å†…å­˜æŒ‡å‘å †ä¸Šçš„æŒ‡é’ˆéƒ½å¿…é¡»æ˜¯åƒåœ¾å›æ”¶çš„æ ¹ï¼ˆgarbage collection rootsï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€æœ‰æŒ‡é’ˆå¿…é¡»å¯ä»¥é€šè¿‡ä¸€ä¸ªå…¨å±€å˜é‡æ‰€è®¿é—®åˆ°ï¼Œæˆ–è€…æ˜¾å¼åœ°ä½¿ç”¨<code>runtime.markroot</code>æ¥æ ‡è®°ã€‚</li><li>å¦‚æœå†…å­˜è¢«é‡ç”¨äº†ï¼Œå †ä¸Šçš„æŒ‡é’ˆåœ¨è¢«æ ‡è®°ä¸º GC æ ¹å¹¶ä¸”å¯¹ GC å¯è§å‰å¿…é¡» ä»¥ 0 åˆå§‹åŒ–ï¼ˆzero-initializedï¼Œè§åæ–‡ï¼‰ã€‚ä¸ç„¶çš„è¯ï¼ŒGC å¯èƒ½ä¼šè§‚å¯Ÿåˆ°è¿‡æœŸçš„ï¼ˆstaleï¼‰å †æŒ‡é’ˆã€‚å¯ä»¥å‚è§ä¸‹æ–‡<code>Zero-initialization versus zeroing</code>.</li></ol><h1 id="Zero-initialization-versus-zeroing"><a href="#Zero-initialization-versus-zeroing" class="headerlink" title="Zero-initialization versus zeroing"></a>Zero-initialization versus zeroing</h1><p>åœ¨ runtime ä¸­æœ‰ä¸¤ç§ç±»å‹çš„é›¶åˆå§‹åŒ–ï¼Œå–å†³äºå†…å­˜æ˜¯å¦å·²ç»åˆå§‹åŒ–ä¸ºäº†ä¸€ä¸ªç±»å‹å®‰å…¨çš„çŠ¶æ€ã€‚</p><p>å¦‚æœå†…å­˜ä¸åœ¨ä¸€ä¸ªç±»å‹å®‰å…¨çš„çŠ¶æ€ï¼Œæ„æ€æ˜¯å¯èƒ½ç”±äºåˆšè¢«åˆ†é…ï¼Œå¹¶ä¸”ç¬¬ä¸€æ¬¡åˆå§‹åŒ–ä½¿ç”¨ï¼Œä¼šå«æœ‰ä¸€äº›åƒåœ¾å€¼ï¼ˆè¯‘è€…æ³¨ï¼šè¿™ä¸ªæ¦‚å¿µåœ¨æ—¥å¸¸çš„ Go ä»£ç ä¸­æ˜¯é‡ä¸åˆ°çš„ï¼Œå¦‚æœå­¦è¿‡ C è¯­è¨€çš„åŒå­¦åº”è¯¥èƒ½ç†è§£ä»€ä¹ˆæ„æ€ï¼‰ï¼Œé‚£ä¹ˆè¿™ç‰‡å†…å­˜å¿…é¡»ä½¿ç”¨<code>memclrNoHeapPointers</code>è¿›è¡Œ<code>zero-initialized</code>æˆ–è€…æ— æŒ‡é’ˆçš„å†™ã€‚è¿™ä¸ä¼šè§¦å‘å†™å±éšœï¼ˆè¯‘è€…æ³¨ï¼šå†™å±éšœæ˜¯ GC ä¸­çš„ä¸€ä¸ªæ¦‚å¿µï¼‰ã€‚</p><p>å†…å­˜å¯ä»¥é€šè¿‡<code>typedmemclr</code>æˆ–è€…<code>memclrHasPointers</code>æ¥å†™å…¥é›¶å€¼ï¼Œè®¾ç½®ä¸ºç±»å‹å®‰å…¨çš„çŠ¶æ€ã€‚è¿™ä¼šè§¦å‘å†™å±éšœã€‚</p><h1 id="Runtime-only-ç¼–è¯‘æŒ‡ä»¤ï¼ˆcompiler-directivesï¼‰"><a href="#Runtime-only-ç¼–è¯‘æŒ‡ä»¤ï¼ˆcompiler-directivesï¼‰" class="headerlink" title="Runtime-only ç¼–è¯‘æŒ‡ä»¤ï¼ˆcompiler directivesï¼‰"></a>Runtime-only ç¼–è¯‘æŒ‡ä»¤ï¼ˆcompiler directivesï¼‰</h1><p>é™¤äº†<code>go doc compile</code>ä¸­æ³¨æ˜çš„<code>//go:</code>ç¼–è¯‘æŒ‡ä»¤å¤–ï¼Œç¼–è¯‘å™¨åœ¨ runtime åŒ…ä¸­æ”¯æŒäº†é¢å¤–çš„ä¸€äº›æŒ‡ä»¤ã€‚</p><h2 id="go-systemstack"><a href="#go-systemstack" class="headerlink" title="go:systemstack"></a>go:systemstack</h2><p><code>go:systemstack</code>è¡¨æ˜ä¸€ä¸ªå‡½æ•°å¿…é¡»åœ¨ç³»ç»Ÿæ ˆä¸Šè¿è¡Œï¼Œè¿™ä¸ªä¼šé€šè¿‡ä¸€ä¸ªç‰¹æ®Šçš„å‡½æ•°å‰å¼•ï¼ˆprologueï¼‰åŠ¨æ€åœ°éªŒè¯ã€‚</p><h2 id="go-nowritebarrier"><a href="#go-nowritebarrier" class="headerlink" title="go:nowritebarrier"></a>go:nowritebarrier</h2><p><code>go:nowritebarrier</code>å‘ŠçŸ¥ç¼–è¯‘å™¨å¦‚æœä»¥ä¸‹å‡½æ•°åŒ…å«äº†å†™å±éšœï¼Œè§¦å‘ä¸€ä¸ªé”™è¯¯ï¼ˆè¿™ä¸ä¼šé˜»æ­¢å†™å±éšœçš„ç”Ÿæˆï¼Œåªæ˜¯å•çº¯ä¸€ä¸ªå‡è®¾ï¼‰ã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ä½ åº”è¯¥ä½¿ç”¨<code>go:nowritebarrierrec</code>ã€‚<code>go:nowritebarrier</code>å½“ä¸”ä»…å½“â€œæœ€å¥½ä¸è¦â€å†™å±éšœï¼Œä½†æ˜¯éæ­£ç¡®æ€§å¿…é¡»çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚</p><h2 id="go-nowritebarrierrec-ä¸-go-yeswritebarrierrec"><a href="#go-nowritebarrierrec-ä¸-go-yeswritebarrierrec" class="headerlink" title="go:nowritebarrierrec ä¸ go:yeswritebarrierrec"></a>go:nowritebarrierrec ä¸ go:yeswritebarrierrec</h2><p><code>go:nowritebarrierrec</code>å‘ŠçŸ¥ç¼–è¯‘å™¨å¦‚æœä»¥ä¸‹å‡½æ•°ä»¥åŠå®ƒè°ƒç”¨çš„å‡½æ•°ï¼ˆé€’å½’ä¸‹å»ï¼‰ï¼Œç›´åˆ°ä¸€ä¸ª<code>go:yeswritebarrierrec</code>ä¸ºæ­¢ï¼ŒåŒ…å«äº†ä¸€ä¸ªå†™å±éšœçš„è¯ï¼Œè§¦å‘ä¸€ä¸ªé”™è¯¯ã€‚</p><p>é€»è¾‘ä¸Šï¼Œç¼–è¯‘å™¨ä¼šåœ¨ç”Ÿæˆçš„è°ƒç”¨å›¾ä¸Šä»æ¯ä¸ª<code>go:nowritebarrierrec</code>å‡½æ•°å‡ºå‘ï¼Œç›´åˆ°é‡åˆ°äº†<code>go:yeswritebarrierrec</code>çš„å‡½æ•°ï¼ˆæˆ–è€…ç»“æŸï¼‰ä¸ºæ­¢ã€‚å¦‚æœå…¶ä¸­é‡åˆ°ä¸€ä¸ªå‡½æ•°åŒ…å«å†™å±éšœï¼Œé‚£ä¹ˆå°±ä¼šäº§ç”Ÿä¸€ä¸ªé”™è¯¯ã€‚</p><p><code>go:nowritebarrierrec</code>ä¸»è¦ç”¨æ¥å®ç°å†™å±éšœè‡ªèº«ï¼Œç”¨æ¥é¿å…æ­»å¾ªç¯ã€‚</p><p>è¿™ä¸¤ç§ç¼–è¯‘æŒ‡ä»¤éƒ½åœ¨è°ƒåº¦å™¨ä¸­æ‰€ä½¿ç”¨ã€‚å†™å±éšœéœ€è¦ä¸€ä¸ªæ´»è·ƒçš„<code>P</code>(<code>getg().m.p != nil</code>)ï¼Œç„¶è€Œè°ƒåº¦å™¨ç›¸å…³ä»£ç æœ‰å¯èƒ½åœ¨æ²¡æœ‰ä¸€ä¸ªæ´»è·ƒçš„<code>P</code>çš„æƒ…å†µä¸‹è¿è¡Œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>go:nowritebarrierrec</code>ä¼šç”¨åœ¨ä¸€äº›é‡Šæ”¾<code>P</code>æˆ–è€…æ²¡æœ‰<code>P</code>çš„å‡½æ•°ä¸Šè¿è¡Œï¼Œ<code>go:yeswritebarrierrec</code>ä¼šç”¨åœ¨é‡æ–°è·å–åˆ°äº†<code>P</code>çš„ä»£ç ä¸Šã€‚å› ä¸ºè¿™äº›éƒ½æ˜¯å‡½æ•°çº§åˆ«çš„æ³¨é‡Šï¼Œæ‰€ä»¥é‡Šæ”¾<code>P</code>å’Œè·å–<code>P</code>çš„ä»£ç å¿…é¡»è¢«æ‹†åˆ†æˆä¸¤ä¸ªå‡½æ•°ã€‚</p><h2 id="go-notinheap"><a href="#go-notinheap" class="headerlink" title="go:notinheap"></a>go:notinheap</h2><p><code>go:notinheap</code>é€‚ç”¨äºç±»å‹å£°æ˜ï¼Œè¡¨æ˜äº†ä¸€ä¸ªç±»å‹å¿…é¡»ä¸è¢«åˆ†é…åœ¨ GC å †ä¸Šã€‚ç‰¹åˆ«çš„ï¼ŒæŒ‡å‘è¯¥ç±»å‹çš„æŒ‡é’ˆæ€»æ˜¯åº”å½“åœ¨<code>runtime.inheap</code>åˆ¤æ–­ä¸­å¤±è´¥ã€‚è¿™ä¸ªç±»å‹å¯èƒ½è¢«ç”¨äºå…¨å±€å˜é‡ã€æ ˆä¸Šå˜é‡ï¼Œæˆ–è€…å †å¤–å†…å­˜ä¸Šçš„å¯¹è±¡ï¼ˆæ¯”å¦‚é€šè¿‡<code>sysAlloc</code>ã€<code>persistentalloc</code>ã€<code>fixalloc</code>æˆ–è€…å…¶å®ƒæ‰‹åŠ¨ç®¡ç†çš„<code>span</code>è¿›è¡Œåˆ†é…ï¼‰ã€‚ç‰¹åˆ«çš„ï¼š</p><ol><li><code>new(T)</code>ã€<code>make([]T)</code>ã€<code>append([]T, ...)</code>å’Œéšå¼çš„å¯¹äº<code>T</code>çš„å †ä¸Šåˆ†é…æ˜¯ä¸å…è®¸çš„ï¼ˆå°½ç®¡éšå¼çš„åˆ†é…åœ¨ runtime ä¸­æ˜¯ä»æ¥ä¸è¢«å…è®¸çš„ï¼‰ã€‚</li><li>ä¸€ä¸ªæŒ‡å‘æ™®é€šç±»å‹çš„æŒ‡é’ˆï¼ˆé™¤äº†<code>unsafe.Pointer</code>ï¼‰ä¸èƒ½è¢«è½¬æ¢æˆä¸€ä¸ªæŒ‡å‘<code>go:notinheap</code>ç±»å‹çš„æŒ‡é’ˆï¼Œå°±ç®—å®ƒä»¬æœ‰ç›¸åŒçš„åº•å±‚ç±»å‹ï¼ˆunderlying typeï¼‰ã€‚</li><li>ä»»ä½•ä¸€ä¸ªåŒ…å«äº†<code>go:notinheap</code>ç±»å‹çš„ç±»å‹è‡ªèº«ä¹Ÿæ˜¯<code>go:notinheap</code>çš„ã€‚å¦‚æœç»“æ„ä½“å’Œæ•°ç»„åŒ…å«<code>go:notinheap</code>çš„å…ƒç´ ï¼Œé‚£ä¹ˆå®ƒä»¬è‡ªèº«ä¹Ÿæ˜¯<code>go:notinheap</code>ç±»å‹ã€‚map å’Œ channel ä¸å…è®¸æœ‰<code>go:notinheap</code>ç±»å‹ã€‚ä¸ºäº†ä½¿å¾—äº‹æƒ…æ›´åŠ æ¸…æ™°ï¼Œä»»ä½•éšå¼çš„<code>go:notinheap</code>ç±»å‹éƒ½åº”è¯¥æ˜¾å¼åœ°æ ‡æ˜<code>go:notinheap</code>ã€‚</li><li>æŒ‡å‘<code>go:notinheap</code>ç±»å‹çš„æŒ‡é’ˆçš„å†™å±éšœå¯ä»¥è¢«å¿½ç•¥ã€‚</li></ol><p>æœ€åä¸€ç‚¹æ˜¯<code>go:notinheap</code>ç±»å‹çœŸæ­£çš„å¥½å¤„ã€‚runtime åœ¨åº•å±‚ç»“æ„ä¸­ä½¿ç”¨è¿™ä¸ªæ¥é¿å…è°ƒåº¦å™¨å’Œå†…å­˜åˆ†é…å™¨çš„å†…å­˜å±éšœä»¥é¿å…éæ³•æ£€æŸ¥æˆ–è€…å•çº¯æé«˜æ€§èƒ½ã€‚è¿™ç§æ–¹æ³•æ˜¯é€‚åº¦çš„å®‰å…¨ï¼ˆreasonably safeï¼‰çš„å¹¶ä¸”ä¸ä¼šä½¿å¾— runtime çš„å¯è¯»æ€§é™ä½ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘åœ¨ç ”ç©¶æ€§èƒ½ä¼˜åŒ–çš„æ—¶å€™ï¼Œçœ‹åˆ°äº† golang runtime åŒ…ä¸‹çš„ä¸€ä¸ªæ–‡æ¡£&lt;a href=&quot;https://github.com/golang/go/blob/master/src/runtime/HACKING.md&quot;&gt;&lt;code&gt;HACKING.md&lt;/code&gt;&lt;/a&gt;è§‰å¾—é¢‡æœ‰æ„æ€ï¼Œè¯»å®Œä¹‹åè§‰å¾—å¯¹äº runtime çš„ç†è§£æ›´ä¸Šä¸€å±‚ï¼Œäºæ˜¯æƒ³ç€ç¿»è¯‘ä¸€ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬ç« å†…å®¹ä¼šæœ‰ä¸€å®šæ·±åº¦ï¼Œéœ€è¦æœ‰ä¸€å®šåŸºç¡€çš„è¯»è€…ï¼Œé™äºç¯‡å¹…åœ¨è¿™é‡Œä¸å¯èƒ½å®Œå…¨å±•å¼€å„ä¸ªç»†èŠ‚ã€‚&lt;/p&gt;
&lt;p&gt;è¿™ä¸€ç¯‡æ–‡æ¡£é¢å‘çš„è¯»è€…æ˜¯ runtime çš„å¼€å‘è€…ï¼Œæ‰€ä»¥æœ‰å¾ˆå¤šå†…å®¹åœ¨æˆ‘ä»¬æ™®é€šä½¿ç”¨ä¸­æ˜¯æ¥è§¦ä¸åˆ°çš„ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="go" scheme="https://www.purewhite.io/categories/go/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="go" scheme="https://www.purewhite.io/tags/go/"/>
    
    <category term="asm" scheme="https://www.purewhite.io/tags/asm/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€ç§åŸºäº gitlab çš„é€‚ç”¨äºç‰ˆæœ¬å‘å¸ƒçš„ git-flow åä½œè§„èŒƒ</title>
    <link href="https://www.purewhite.io/2019/11/06/new-gitlab-git-flow-spec/"/>
    <id>https://www.purewhite.io/2019/11/06/new-gitlab-git-flow-spec/</id>
    <published>2019-11-06T09:09:25.000Z</published>
    <updated>2021-12-02T12:51:07.229Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘è‡ªå·±æäº†ä¸€ä¸ªåŸºäº gitlab çš„é€‚ç”¨äºç‰ˆæœ¬å‘å¸ƒï¼ˆéæŒç»­é›†æˆï¼‰çš„è„±èƒäº git-flow çš„åä½œè§„èŒƒï¼Œå‘å¸ƒå‡ºæ¥å¤§å®¶å¯ä»¥ä½œä¸ºå€Ÿé‰´ã€‚</p><span id="more"></span><h1 id="Branch-è§„èŒƒ"><a href="#Branch-è§„èŒƒ" class="headerlink" title="Branch è§„èŒƒ"></a>Branch è§„èŒƒ</h1><p>ä¸€å…±æ‹¥æœ‰ä»¥ä¸‹å‡ ä¸ªï¼ˆç§ï¼‰branchï¼š</p><ol><li>masterï¼šmaster ä¸Šçš„éƒ½æ˜¯ production-ready çš„ stable çš„ä»£ç ã€‚</li><li>developï¼šä½œä¸ºå¼€å‘çš„ä¸»åˆ†æ”¯ï¼Œ<u><strong>æ‰€æœ‰çš„ mr éƒ½åº”å½“ï¼ˆå…ˆï¼‰åˆå¹¶åˆ° develop åˆ†æ”¯</strong></u>ï¼Œå®šæœŸ merge åˆ° master å‘ç‰ˆã€‚</li><li>release-*ï¼šLTS ç‰ˆæœ¬éœ€è¦æœ‰ç‹¬ç«‹çš„ branchï¼Œä»¥ä½œä¸ºåç»­ï¼ˆä¸‡ä¸€ï¼‰hotfix ä½¿ç”¨ï¼Œç²¾ç¡®åˆ° minor versionï¼Œå¦‚ release-v1.2ï¼Œä¸ºé•¿æœŸä¿ç•™çš„åˆ†æ”¯ã€‚</li><li>feature/*ï¼šæ‰€æœ‰æ–°çš„ featureï¼ˆå¦‚æ–°åŠŸèƒ½ã€æ€§èƒ½ä¼˜åŒ–ï¼‰éƒ½åº”å½“å…ˆ checkout åˆ°ä¸€ä¸ªæ–°çš„ feature åˆ†æ”¯å¼€å‘ï¼ŒåŸåˆ™ä¸Šå¿…é¡»ä¸”åªèƒ½ merge åˆ° develop åˆ†æ”¯ã€‚</li><li>bugfix/*ï¼šbug çš„ä¿®å¤åˆ†æ”¯ï¼ŒåŸåˆ™ä¸Šå¿…é¡»ä¸”åªèƒ½ merge åˆ° develop åˆ†æ”¯ã€‚</li><li>test/*ï¼štest åˆ†æ”¯ä¸»è¦åšä»¥ä¸‹ä¸‰ä»¶äº‹ï¼š1. å¢åŠ  unit testï¼›2. ä¿®æ”¹ä»“åº“çº§åˆ«é…ç½®æ–‡ä»¶ï¼ˆå¦‚ .gitlab-ci.ymlï¼‰ï¼›3. ç”¨æ¥æ‰¿è½½ä¸€äº›ä¸€æ¬¡æ€§çš„æµ‹è¯•ï¼ˆä¸åˆå…¥ developï¼‰ã€‚</li><li>hotfix/*ï¼šç”¨æ¥å‘å¸ƒ hotfix çš„åˆ†æ”¯ï¼Œè¯¦è§ä¸‹èŠ‚ã€‚</li><li>release/*ï¼šç”¨æ¥åšå‘ç‰ˆå·¥ä½œï¼ˆå¦‚æ›´æ–°ç‰ˆæœ¬å·ï¼Œbugfixï¼‰çš„åˆ†æ”¯ï¼Œè¿˜æœ‰ä¸€ä¸ªä½œç”¨æ˜¯ freeze featureï¼Œ<u><strong>ä¸å…è®¸åˆå…¥ featureï¼Œå¯ä»¥åˆå…¥ bugfix</strong></u>ï¼Œè¯¦è§ä¸‹èŠ‚ã€‚</li></ol><p><u>branch name åº”å½“é‡‡ç”¨ ä¸‹åˆ’çº¿å‘½åæ³•ã€‚</u>ä¼šåœ¨ ci ä¸­å¯¹äº branch name åšå¼ºåˆ¶æ£€æŸ¥ï¼Œå¦‚æœä¸åˆè§„ä¼šç›´æ¥ failã€‚ç•™å‡º test/* çš„ branch ä¹Ÿæ˜¯ä¸ºäº†èƒ½å¤Ÿæ”¯æŒä¸€äº›æµ‹è¯•æ€§çš„å·¥ä½œèƒ½å¤Ÿé€šè¿‡ ci æ£€æŸ¥ã€‚</p><h1 id="åä½œæµç¨‹"><a href="#åä½œæµç¨‹" class="headerlink" title="åä½œæµç¨‹"></a>åä½œæµç¨‹</h1><h2 id="å¼€å‘æµç¨‹"><a href="#å¼€å‘æµç¨‹" class="headerlink" title="å¼€å‘æµç¨‹"></a>å¼€å‘æµç¨‹</h2><ol><li><p>é¦–å…ˆï¼Œç¡®è®¤è‡ªå·±åœ¨ develop åˆ†æ”¯ä¸Šï¼›</p></li><li><p><code>git checkout -b feature/your_feature</code>ï¼›</p></li><li><p>å¼€å‘å®Œæˆåï¼Œpush åˆ° originï¼›</p></li><li><p>æ mrï¼ˆå¦‚æœæ˜¯ æ€§èƒ½ä¼˜åŒ–ï¼Œè¯·åœ¨ description ä¸­é™„å¸¦ä¸Š benchcmp çš„ç»“æœï¼‰ï¼Œtarget branch ä¸º developï¼Œå¹¶å‹¾é€‰æœ€ä¸‹æ–¹ä¸¤ä¸ªé€‰é¡¹ï¼š</p><p><img data-src="https://static.purewhite.io/images/2019-11-06-092017.png!webp_90" alt="image-20191106172016506"></p></li><li><p>ç­‰å¾… review é€šè¿‡ï¼Œé€šè¿‡åç‚¹å‡» mergeï¼Œè¯·å†æ¬¡ç¡®è®¤ squash å’Œ delete branch è¢«å‹¾é€‰ï¼š</p><p><img data-src="https://static.purewhite.io/images/2019-11-06-092101.png!webp_90" alt="image-20191106172100840"></p></li><li><p>å¦‚æœ merge request æœ‰ descriptionï¼Œå¯ä»¥ç‚¹å‡» â€œModify commit messageâ€ å¹¶ç‚¹å‡»æœ€ä¸‹æ–¹çš„ include descriptionï¼Œç„¶åå†ç‚¹å‡» mergeï¼š</p><p><img data-src="https://static.purewhite.io/images/2019-11-06-092136.png!webp_90" alt="image-20191106172136296"></p></li><li><p>doneã€‚</p></li></ol><h2 id="bugfix-æµç¨‹"><a href="#bugfix-æµç¨‹" class="headerlink" title="bugfix æµç¨‹"></a>bugfix æµç¨‹</h2><h3 id="develop-ä¸Š-bugfix"><a href="#develop-ä¸Š-bugfix" class="headerlink" title="develop ä¸Š bugfix"></a>develop ä¸Š bugfix</h3><ol><li>é¦–å…ˆï¼Œç¡®è®¤è‡ªå·±åœ¨ develop åˆ†æ”¯ä¸Šï¼›</li><li><code>git checkout -b bugfix/your_bugfix</code>ï¼›</li><li>å¼€å‘å®Œæˆåï¼Œpush åˆ° originï¼›</li><li>æ mrï¼Œtarget branch ä¸º developï¼Œå¹¶å¦‚<a href="#%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B">å¼€å‘æµç¨‹</a>ä¸€æ ·å‹¾é€‰æœ€ä¸‹æ–¹ä¸¤ä¸ªé€‰é¡¹ï¼›</li><li>ç­‰å¾… review é€šè¿‡ï¼Œé€šè¿‡åç‚¹å‡» mergeï¼Œè¯·å†æ¬¡ç¡®è®¤ squash å’Œ delete branch è¢«å‹¾é€‰ï¼›</li><li>å¦‚æœ merge request æœ‰ descriptionï¼Œå¯ä»¥ç‚¹å‡» â€œModify commit messageâ€ å¹¶ç‚¹å‡»æœ€ä¸‹æ–¹çš„ include descriptionï¼Œç„¶åå†ç‚¹å‡» mergeï¼›</li><li>doneã€‚</li></ol><h3 id="release-ä¸Š-bugfix"><a href="#release-ä¸Š-bugfix" class="headerlink" title="release/* ä¸Š bugfix"></a>release/* ä¸Š bugfix</h3><p>è¿™é‡Œä¸éœ€è¦ç›´æ¥ merge å› develop æ˜¯å› ä¸º release/* æœ€ç»ˆä¼š merge å› developã€‚</p><ol><li>é¦–å…ˆï¼Œç¡®è®¤è‡ªå·±åœ¨ release/vX.Y.Z åˆ†æ”¯ä¸Šï¼›</li><li><code>git checkout -b bugfix/your_bugfix</code>ï¼›</li><li>å¼€å‘å®Œæˆåï¼Œpush åˆ° originï¼›</li><li>æ mrï¼Œtarget branch ä¸º release/vX.Y.Zï¼Œå¹¶å¦‚<a href="#%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B">å¼€å‘æµç¨‹</a>ä¸€æ ·å‹¾é€‰æœ€ä¸‹æ–¹ä¸¤ä¸ªé€‰é¡¹ï¼›</li><li>ç­‰å¾… review é€šè¿‡ï¼Œé€šè¿‡åç‚¹å‡» mergeï¼Œè¯·å†æ¬¡ç¡®è®¤ squash å’Œ delete branch è¢«å‹¾é€‰ï¼›</li><li>å¦‚æœ merge request æœ‰ descriptionï¼Œå¯ä»¥ç‚¹å‡» â€œModify commit messageâ€ å¹¶ç‚¹å‡»æœ€ä¸‹æ–¹çš„ include descriptionï¼Œç„¶åå†ç‚¹å‡» mergeï¼›</li><li>doneã€‚</li></ol><h2 id="hotfix-æµç¨‹"><a href="#hotfix-æµç¨‹" class="headerlink" title="hotfix æµç¨‹"></a>hotfix æµç¨‹</h2><h3 id="éœ€è¦-merge-åˆ°-develop"><a href="#éœ€è¦-merge-åˆ°-develop" class="headerlink" title="éœ€è¦ merge åˆ° develop"></a>éœ€è¦ merge åˆ° develop</h3><ol><li>æŒ‰ç…§ <em>æ™®é€š bugfix æµç¨‹</em> å®Œæˆ bug ä¿®å¤ï¼Œè®°å¾—è¦æ›´æ–°ä»£ç ä¸­çš„ç‰ˆæœ¬å·ï¼ˆä¸ºäº†é˜²æ­¢ merge åˆ° master åå¿˜è®° merge å› developï¼‰ï¼›</li><li>åˆ‡æ¢åˆ° master åˆ†æ”¯ä¸Šï¼›</li><li><code>git checkout -b hotfix/your_hotfix</code>ï¼›</li><li>cherry-pick bugfix çš„ commitï¼›</li><li>æ£€æŸ¥æ— è¯¯åï¼Œpush åˆ° originï¼›</li><li>æ mrï¼Œtarget branch ä¸º masterï¼Œå¹¶å¦‚<a href="#%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B">å¼€å‘æµç¨‹</a>ä¸€æ ·å‹¾é€‰æœ€ä¸‹æ–¹ä¸¤ä¸ªé€‰é¡¹ï¼›</li><li>ç­‰å¾… review é€šè¿‡ï¼Œé€šè¿‡åç‚¹å‡» mergeï¼Œè¯·å†æ¬¡ç¡®è®¤ squash å’Œ delete branch è¢«å‹¾é€‰ï¼›</li><li>å¦‚æœ merge request æœ‰ descriptionï¼Œå¯ä»¥ç‚¹å‡» â€œModify commit messageâ€ å¹¶ç‚¹å‡»æœ€ä¸‹æ–¹çš„ include descriptionï¼Œç„¶åå†ç‚¹å‡» mergeï¼›</li><li>åˆ‡æ¢åˆ° master åˆ†æ”¯ä¸Šï¼Œæ‰“ä¸€ä¸ªæ–°çš„ tagï¼›</li><li>doneã€‚</li></ol><h3 id="ä»…éœ€è¦-merge-åˆ°-master"><a href="#ä»…éœ€è¦-merge-åˆ°-master" class="headerlink" title="ä»…éœ€è¦ merge åˆ° master"></a>ä»…éœ€è¦ merge åˆ° master</h3><p>é€‚ç”¨äºéœ€è¦ä¿®å¤çš„ bug åœ¨ develop åˆ†æ”¯ä¸Šå·²ä¸å­˜åœ¨çš„æƒ…å†µã€‚</p><p>ç‰ˆæœ¬å·çš„æ›´æ–°ä¸éœ€è¦åŒæ­¥åˆ°developï¼Œåœ¨ä¸‹æ¬¡mergeçš„æ—¶å€™è§£å†³å†²çªå³å¯ã€‚</p><ol><li>é¦–å…ˆï¼Œç¡®è®¤è‡ªå·±åœ¨ master åˆ†æ”¯ä¸Šï¼›</li><li><code>git checkout -b hotfix/your_hotfix</code>ï¼›</li><li>ä¿®å¤å®Œæˆåï¼Œ<u><strong>æ–°å¢ä¸€ä¸ªç‹¬ç«‹çš„commitï¼Œæ›´æ–°ä»£ç ä¸­ç‰ˆæœ¬å·</strong></u>ï¼Œpush åˆ° originï¼›</li><li>æ mrï¼Œtarget branch ä¸º masterï¼Œå¹¶å¦‚<a href="#%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B">å¼€å‘æµç¨‹</a>ä¸€æ ·å‹¾é€‰æœ€ä¸‹æ–¹ä¸¤ä¸ªé€‰é¡¹ï¼›</li><li>ç­‰å¾… review é€šè¿‡ï¼Œé€šè¿‡åç‚¹å‡» mergeï¼Œè¯·å†æ¬¡ç¡®è®¤ squash å’Œ delete branch è¢«å‹¾é€‰ï¼›</li><li>å¦‚æœ merge request æœ‰ descriptionï¼Œå¯ä»¥ç‚¹å‡» â€œModify commit messageâ€ å¹¶ç‚¹å‡»æœ€ä¸‹æ–¹çš„ include descriptionï¼Œç„¶åå†ç‚¹å‡» mergeï¼›</li><li>åˆ‡æ¢åˆ° master åˆ†æ”¯ä¸Šï¼Œæ‰“ä¸€ä¸ªæ–°çš„ tagï¼›</li><li>å°†ç¬¬ä¸‰æ­¥ä¸­æ›´æ–°ç‰ˆæœ¬å·çš„ç‹¬ç«‹çš„commit cherry-pickåˆ°developåˆ†æ”¯ä¸Šï¼›</li><li>doneã€‚</li></ol><h3 id="éœ€è¦-merge-åˆ°-LTS-release-branch"><a href="#éœ€è¦-merge-åˆ°-LTS-release-branch" class="headerlink" title="éœ€è¦ merge åˆ° LTS release branch"></a>éœ€è¦ merge åˆ° LTS release branch</h3><ol><li>æ ¹æ®æƒ…å†µï¼Œå®Œæˆ<a href="#%E9%9C%80%E8%A6%81-merge-%E5%88%B0-develop">éœ€è¦ merge åˆ° develop</a>æˆ–è€…<a href="#%E4%BB%85%E9%9C%80%E8%A6%81-merge-%E5%88%B0-master">ä»…éœ€è¦ merge åˆ° master</a>ä¸­çš„ä¸€ä¸ªï¼›</li><li>åˆ‡æ¢åˆ° release-vX.Y åˆ†æ”¯ä¸Šï¼ˆå¾…ä¿®å¤çš„åˆ†æ”¯ï¼‰ï¼›</li><li><code>git checkout -b hotfix/your_hotfix</code>ï¼›</li><li>cherry-pick hotfix çš„ commitï¼›</li><li>æ›´æ–°ä»£ç ä¸­ç‰ˆæœ¬å·ï¼Œæ£€æŸ¥æ— è¯¯åï¼Œpush åˆ° originï¼›</li><li>æ mrï¼Œtarget branch ä¸º release-vX.Yï¼Œå¹¶å¦‚<a href="#%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B">å¼€å‘æµç¨‹</a>ä¸€æ ·å‹¾é€‰æœ€ä¸‹æ–¹ä¸¤ä¸ªé€‰é¡¹ï¼›</li><li>ç­‰å¾… review é€šè¿‡ï¼Œé€šè¿‡åç‚¹å‡» mergeï¼Œè¯·å†æ¬¡ç¡®è®¤ squash å’Œ delete branch è¢«å‹¾é€‰ï¼›</li><li>å¦‚æœ merge request æœ‰ descriptionï¼Œå¯ä»¥ç‚¹å‡» â€œModify commit messageâ€ å¹¶ç‚¹å‡»æœ€ä¸‹æ–¹çš„ include descriptionï¼Œç„¶åå†ç‚¹å‡» mergeï¼›</li><li>åˆ‡æ¢åˆ° release-vX.Y åˆ†æ”¯ä¸Šï¼Œæ‰“ä¸€ä¸ª tagï¼›</li><li>doneã€‚</li></ol><h2 id="å‘ç‰ˆæµç¨‹"><a href="#å‘ç‰ˆæµç¨‹" class="headerlink" title="å‘ç‰ˆæµç¨‹"></a>å‘ç‰ˆæµç¨‹</h2><p>å‘ç‰ˆæµç¨‹æ¯”è¾ƒç‰¹æ®Šï¼Œå’Œå…¶å®ƒæµç¨‹æœ‰è¾ƒå¤§åŒºåˆ«ï¼Œè¯·æ³¨æ„ç»†èŠ‚ã€‚</p><p>è¿™ä¹ˆåšçš„åŸå› æ˜¯ï¼Œå¦‚æœå…ˆæŠŠ release branch merge åˆ° develop åˆ†æ”¯ä¸Šï¼Œå†å°† develop åˆ†æ”¯ merge è¿› master çš„è¯ï¼Œå¯èƒ½ä¼šå¸¦ä¸Šé¢„æ–™ä¹‹å¤–çš„ commitï¼ˆåœ¨æ•´ç† release çš„æ—¶å€™æœ‰æ–°çš„ mr è¢« merge åˆ° developï¼‰ã€‚</p><ol><li>é¦–å…ˆï¼Œç¡®è®¤è‡ªå·±åœ¨ develop åˆ†æ”¯ä¸Šï¼›</li><li><code>git checkout -b release/vX.Y.Z</code>ï¼›</li><li>åšä¸€äº›å‘ç‰ˆéœ€è¦çš„å·¥ä½œï¼ˆå¦‚æ›´æ–°ç‰ˆæœ¬å·ç­‰ï¼‰ï¼›</li><li>å®Œæˆåï¼Œpush åˆ° originï¼›</li><li>æ mrï¼Œtarget branch ä¸º masterï¼Œ**<u>ä¸å‹¾é€‰ squash å’Œ remove source branch</u>**ï¼›</li><li>ç­‰å¾… review é€šè¿‡ï¼Œé€šè¿‡åç‚¹å‡» mergeï¼Œ<u>è¯·å†æ¬¡ç¡®è®¤ squash å’Œ delete branch <strong>æœª</strong>è¢«å‹¾é€‰</u>ï¼›</li><li>å¦‚æœ merge request æœ‰ descriptionï¼Œå¯ä»¥ç‚¹å‡» â€œModify commit messageâ€ å¹¶ç‚¹å‡»æœ€ä¸‹æ–¹çš„ include descriptionï¼Œç„¶åå†ç‚¹å‡» mergeï¼›</li><li>åˆ‡æ¢åˆ° masterï¼Œæ‰“ä¸€ä¸ª vX.Y.Z çš„ tagã€‚</li><li>å†æä¸€ä¸ª mrï¼Œtarget branch ä¸º developï¼Œ**<u>ä¸å‹¾é€‰ squashï¼Œå‹¾é€‰ remove source branch</u>**ï¼›</li><li>ç­‰å¾… review é€šè¿‡ï¼Œé€šè¿‡åç‚¹å‡» mergeï¼Œ<u>å†æ¬¡ç¡®è®¤ä¸å‹¾é€‰ squashï¼Œä½† delete branch <strong>è¢«</strong>å‹¾é€‰</u>ï¼›</li><li>å¦‚æœ merge request æœ‰ descriptionï¼Œå¯ä»¥ç‚¹å‡» â€œModify commit messageâ€ å¹¶ç‚¹å‡»æœ€ä¸‹æ–¹çš„ include descriptionï¼Œç„¶åå†ç‚¹å‡» mergeï¼›</li><li>doneã€‚</li></ol><h1 id="CI-check-script"><a href="#CI-check-script" class="headerlink" title="CI check script"></a>CI check script</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line">echo &quot;branch name is: $1&quot;</span><br><span class="line">if [[ ! $1 =~ ^(((feature|bugfix|test|hotfix)/.+)|(master|develop)|(release-v[0-9]+\.[0-9]+)|(release/v[0-9]+\.[0-9]+\.[0-9]+(-[a-z0-9.]+(\+[a-z0-9.]+)?)?))$ ]]; then</span><br><span class="line">  echo &quot;branch name invalid!&quot; &gt;&amp;2</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘è‡ªå·±æäº†ä¸€ä¸ªåŸºäº gitlab çš„é€‚ç”¨äºç‰ˆæœ¬å‘å¸ƒï¼ˆéæŒç»­é›†æˆï¼‰çš„è„±èƒäº git-flow çš„åä½œè§„èŒƒï¼Œå‘å¸ƒå‡ºæ¥å¤§å®¶å¯ä»¥ä½œä¸ºå€Ÿé‰´ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="éšç¬”" scheme="https://www.purewhite.io/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
    <category term="éšç¬”" scheme="https://www.purewhite.io/tags/%E9%9A%8F%E7%AC%94/"/>
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="git" scheme="https://www.purewhite.io/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>Thriftç›¸å…³æ¦‚å¿µå­¦ä¹ ç¬”è®°</title>
    <link href="https://www.purewhite.io/2019/09/23/thrift-concepts-notes/"/>
    <id>https://www.purewhite.io/2019/09/23/thrift-concepts-notes/</id>
    <published>2019-09-23T06:14:02.000Z</published>
    <updated>2021-12-02T12:51:07.230Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸€ç›´åœ¨å·¥ä½œä¸­ä½¿ç”¨ Apache Thriftï¼Œä½†æ˜¯ä¸€ç›´å¯¹å…¶ä¸­çš„ä¸€äº›æ¦‚å¿µä¸€çŸ¥åŠè§£ï¼Œäºæ˜¯ç»ˆäºæŠ½ç©ºå­¦ä¹ äº†ä¸€ä¸‹ï¼Œè®°å½•ä¸‹æ¥ä½œä¸ºå­¦ä¹ ç¬”è®°ã€‚</p><span id="more"></span><h2 id="Thrift-ç½‘ç»œå±‚çº§"><a href="#Thrift-ç½‘ç»œå±‚çº§" class="headerlink" title="Thrift ç½‘ç»œå±‚çº§"></a>Thrift ç½‘ç»œå±‚çº§</h2><p>ç®€å•ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">+-------------------------------------------+</span></span><br><span class="line">| Server                                    |</span><br><span class="line"><span class="section">| (single-threaded, event-driven etc)       |</span></span><br><span class="line"><span class="section">+-------------------------------------------+</span></span><br><span class="line">| Processor                                 |</span><br><span class="line"><span class="section">| (compiler generated)                      |</span></span><br><span class="line"><span class="section">+-------------------------------------------+</span></span><br><span class="line">| Protocol                                  |</span><br><span class="line"><span class="section">| (JSON, compact etc)                       |</span></span><br><span class="line"><span class="section">+-------------------------------------------+</span></span><br><span class="line">| Transport                                 |</span><br><span class="line"><span class="section">| (raw TCP, HTTP etc)                       |</span></span><br><span class="line"><span class="section">+-------------------------------------------+</span></span><br></pre></td></tr></table></figure><h2 id="Transport"><a href="#Transport" class="headerlink" title="Transport"></a>Transport</h2><p>Transportå±‚æä¾›äº†ä¸€ä¸ªè¯»å†™åº•å±‚ç½‘ç»œçš„ç®€å•æŠ½è±¡ï¼Œè¿™ä½¿å¾—Thriftå¯ä»¥æŠŠåº•å±‚çš„ç½‘ç»œä¼ è¾“å’Œå…¶å®ƒéƒ¨åˆ†ï¼ˆæ¯”å¦‚åºåˆ—åŒ–ã€ååºåˆ—åŒ–ï¼‰è§£è€¦å¼€ã€‚</p><p>Transportä¸»è¦åŒ…å«ä»¥ä¸‹æ¥å£ï¼š</p><ul><li>open</li><li>close</li><li>read</li><li>write</li><li>flush</li></ul><p>é™¤äº†ä¸Šé¢è¿™ä¸ªTransportçš„æ¥å£ï¼ŒThriftè¿˜æä¾›äº†ä¸€ä¸ªServerTransportçš„æ¥å£ï¼Œç”¨æ¥acceptæˆ–è€…createä¸Šé¢çš„Transportå¯¹è±¡ã€‚é¡¾åæ€ä¹‰ï¼ŒServerTransportä¸»è¦ç”¨åœ¨æœåŠ¡ç«¯ï¼Œç”¨æ¥æ¥å—è¿æ¥å¹¶åˆ›å»ºTransportå¯¹è±¡ã€‚</p><p>ServerTransportä¸»è¦åŒ…å«ä»¥ä¸‹æ¥å£ï¼š</p><ul><li>open</li><li>listen</li><li>accept</li><li>close</li></ul><p>Thriftä¸»è¦æ”¯æŒçš„è¯­è¨€ä¸­æœ‰çš„éƒ¨åˆ†æ¥å£ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><ul><li>file: read/write to/from a file on disk</li><li>http: é¡¾åæ€ä¹‰</li></ul><h2 id="Protocol"><a href="#Protocol" class="headerlink" title="Protocol"></a>Protocol</h2><p>Protocolå±‚å®šä¹‰äº†åºåˆ—åŒ–ã€ååºåˆ—åŒ–çš„æ ¼å¼å’Œæ–¹æ³•ï¼Œæ¯”å¦‚jsonã€xmlã€plain textã€compact binaryç­‰ç­‰ã€‚</p><p>Protocolçš„æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">write<span class="constructor">MessageBegin(<span class="params">name</span>, <span class="params">type</span>, <span class="params">seq</span>)</span></span><br><span class="line">write<span class="constructor">MessageEnd()</span></span><br><span class="line">write<span class="constructor">StructBegin(<span class="params">name</span>)</span></span><br><span class="line">write<span class="constructor">StructEnd()</span></span><br><span class="line">write<span class="constructor">FieldBegin(<span class="params">name</span>, <span class="params">type</span>, <span class="params">id</span>)</span></span><br><span class="line">write<span class="constructor">FieldEnd()</span></span><br><span class="line">write<span class="constructor">FieldStop()</span></span><br><span class="line">write<span class="constructor">MapBegin(<span class="params">ktype</span>, <span class="params">vtype</span>, <span class="params">size</span>)</span></span><br><span class="line">write<span class="constructor">MapEnd()</span></span><br><span class="line">write<span class="constructor">ListBegin(<span class="params">etype</span>, <span class="params">size</span>)</span></span><br><span class="line">write<span class="constructor">ListEnd()</span></span><br><span class="line">write<span class="constructor">SetBegin(<span class="params">etype</span>, <span class="params">size</span>)</span></span><br><span class="line">write<span class="constructor">SetEnd()</span></span><br><span class="line">write<span class="constructor">Bool(<span class="params">bool</span>)</span></span><br><span class="line">write<span class="constructor">Byte(<span class="params">byte</span>)</span></span><br><span class="line">write<span class="constructor">I16(<span class="params">i16</span>)</span></span><br><span class="line">write<span class="constructor">I32(<span class="params">i32</span>)</span></span><br><span class="line">write<span class="constructor">I64(<span class="params">i64</span>)</span></span><br><span class="line">write<span class="constructor">Double(<span class="params">double</span>)</span></span><br><span class="line">write<span class="constructor">String(<span class="params">string</span>)</span></span><br><span class="line"></span><br><span class="line">name, <span class="keyword">type</span>, seq = read<span class="constructor">MessageBegin()</span></span><br><span class="line">                  read<span class="constructor">MessageEnd()</span></span><br><span class="line">name = read<span class="constructor">StructBegin()</span></span><br><span class="line">       read<span class="constructor">StructEnd()</span></span><br><span class="line">name, <span class="keyword">type</span>, id = read<span class="constructor">FieldBegin()</span></span><br><span class="line">                 read<span class="constructor">FieldEnd()</span></span><br><span class="line">k, v, size = read<span class="constructor">MapBegin()</span></span><br><span class="line">             read<span class="constructor">MapEnd()</span></span><br><span class="line">etype, size = read<span class="constructor">ListBegin()</span></span><br><span class="line">              read<span class="constructor">ListEnd()</span></span><br><span class="line">etype, size = read<span class="constructor">SetBegin()</span></span><br><span class="line">              read<span class="constructor">SetEnd()</span></span><br><span class="line"><span class="built_in">bool</span> = read<span class="constructor">Bool()</span></span><br><span class="line">byte = read<span class="constructor">Byte()</span></span><br><span class="line">i16 = read<span class="constructor">I16()</span></span><br><span class="line">i32 = read<span class="constructor">I32()</span></span><br><span class="line">i64 = read<span class="constructor">I64()</span></span><br><span class="line">double = read<span class="constructor">Double()</span></span><br><span class="line"><span class="built_in">string</span> = read<span class="constructor">String()</span></span><br></pre></td></tr></table></figure><p>Thrift Protocolåœ¨è®¾è®¡ä¸Šå°±æ˜¯ä»¥æµä¸ºç›®æ ‡çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦ä»»ä½•æ˜¾å¼çš„å¸§ã€‚æ¯”å¦‚ï¼Œå½“æˆ‘ä»¬åœ¨åºåˆ—åŒ–ä¸€ä¸ªstringä¹‹å‰ï¼Œæˆ‘ä»¬ä¸éœ€è¦çŸ¥é“å®ƒæœ‰å¤šé•¿ï¼›åŒæ ·çš„ï¼Œå½“æˆ‘ä»¬åºåˆ—åŒ–ä¸€ä¸ªlistä¹‹å‰ï¼Œä¸éœ€è¦çŸ¥é“é‡Œé¢æœ‰å‡ ä¸ªitemã€‚éƒ¨åˆ†Thriftä¸»è¦æ”¯æŒè¯­è¨€æ‰€å¸¸ç”¨çš„Protocolå¦‚ä¸‹ï¼š</p><ul><li>binary: éå¸¸ç®€å•çš„äºŒè¿›åˆ¶ç¼–ç ï¼Œå…ˆç¼–ç é•¿åº¦å’Œç±»å‹ï¼Œç„¶åç¼–ç çœŸå®çš„å€¼ã€‚</li><li>compact: å‚è€ƒ<a href="https://issues.apache.org/jira/browse/THRIFT-110">THRIFT-110</a></li><li>json</li></ul><h2 id="Processor"><a href="#Processor" class="headerlink" title="Processor"></a>Processor</h2><p>Processoræä¾›äº†ä»è¾“å…¥æµè¯»å–æ•°æ®ä»¥åŠå†™å‡ºåˆ°è¾“å‡ºæµçš„èƒ½åŠ›ï¼Œè¾“å…¥å’Œè¾“å‡ºæµéƒ½æ˜¯ç”±Protocolå±‚å®ç°ï¼ŒProcessoræœ¬èº«å¾ˆç®€å•ï¼š</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="symbol">TProcessor</span> &#123;</span><br><span class="line">    <span class="built_in">bool</span> process(TProtocol <span class="keyword">in</span>, TProtocol <span class="keyword">out</span>) throws TException</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªæœåŠ¡çš„Processoréƒ½æ˜¯ç”±compilerç”Ÿæˆçš„ï¼ŒProcessorä»è¾“å…¥æµè¯»å–æ•°æ®ï¼Œæ‰”ç»™ç”¨æˆ·çš„handlerå¤„ç†ï¼Œå†æŠŠresponseå†™å›è¾“å‡ºæµã€‚</p><h2 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h2><p>ServeræŠŠä¸Šè¿°æ‰€æœ‰çš„ç‰¹æ€§ç»„åˆåœ¨ä¸€èµ·ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ªTransport</li><li>æ ¹æ®Transportåˆ›å»ºè¾“å…¥è¾“å‡ºæµï¼ˆProtocolï¼‰</li><li>åŸºäºè¾“å…¥è¾“å‡ºæµåˆ›å»ºProcessor</li><li>ç­‰å¾…å¹¶å¤„ç†è¿æ¥</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸€ç›´åœ¨å·¥ä½œä¸­ä½¿ç”¨ Apache Thriftï¼Œä½†æ˜¯ä¸€ç›´å¯¹å…¶ä¸­çš„ä¸€äº›æ¦‚å¿µä¸€çŸ¥åŠè§£ï¼Œäºæ˜¯ç»ˆäºæŠ½ç©ºå­¦ä¹ äº†ä¸€ä¸‹ï¼Œè®°å½•ä¸‹æ¥ä½œä¸ºå­¦ä¹ ç¬”è®°ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/categories/%E5%90%8E%E7%AB%AF/"/>
    
    
    <category term="éšç¬”" scheme="https://www.purewhite.io/tags/%E9%9A%8F%E7%AC%94/"/>
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="å¼€æº" scheme="https://www.purewhite.io/tags/%E5%BC%80%E6%BA%90/"/>
    
  </entry>
  
  <entry>
    <title>éªŒè¯golangä¸­unsafeåŒ…ä¸å®‰å…¨</title>
    <link href="https://www.purewhite.io/2019/04/02/golang-validate-unsafe-is-unsafe/"/>
    <id>https://www.purewhite.io/2019/04/02/golang-validate-unsafe-is-unsafe/</id>
    <published>2019-04-02T05:32:28.000Z</published>
    <updated>2021-12-02T12:51:07.226Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨goä¸­ï¼Œuintpträ¸èƒ½æŒæœ‰å¯¹è±¡ï¼ŒunsafeåŒ…ä¸å®‰å…¨ï¼Œä½†æ˜¯æˆ‘ä¹‹å‰ä¸€ç›´æ²¡æœ‰æ—¶é—´éªŒè¯ï¼Œä»Šå¤©å†™äº†æ®µä»£ç éªŒè¯äº†ä¸€ä¸‹ã€‚</p><span id="more"></span><h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;unsafe&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := f()</span><br><span class="line">b := f2()</span><br><span class="line">fmt.Println(a)</span><br><span class="line">fmt.Println(b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:noinline</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span> <span class="title">unsafe</span>.<span class="title">Pointer</span></span> &#123;</span><br><span class="line">d := <span class="number">1</span></span><br><span class="line">p := unsafe.Pointer(&amp;d)</span><br><span class="line"><span class="keyword">return</span> p</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:noinline</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f2</span><span class="params">()</span> <span class="title">uintptr</span></span> &#123;</span><br><span class="line">d := <span class="number">1</span></span><br><span class="line">p := <span class="keyword">uintptr</span>(unsafe.Pointer(&amp;d))</span><br><span class="line"><span class="keyword">return</span> p</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é€ƒé€¸åˆ†æ"><a href="#é€ƒé€¸åˆ†æ" class="headerlink" title="é€ƒé€¸åˆ†æ"></a>é€ƒé€¸åˆ†æ</h2><p>æ ¹æ®é€ƒé€¸åˆ†æå¯ä»¥çœ‹å‡ºæ¥få’Œf2è¿™ä¸¤ä¸ªå‡½æ•°ä¸­çš„då˜é‡åˆ†åˆ«åˆ†é…åœ¨å“ªé‡Œï¼š</p><h3 id="ç¼–è¯‘å‚æ•°æ–¹æ³•"><a href="#ç¼–è¯‘å‚æ•°æ–¹æ³•" class="headerlink" title="ç¼–è¯‘å‚æ•°æ–¹æ³•"></a>ç¼–è¯‘å‚æ•°æ–¹æ³•</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> go build -gcflags <span class="string">&#x27;-m -m&#x27;</span> unsafe.go</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> command-line-arguments</span></span><br><span class="line">./unsafe.go:16:6: cannot inline f: marked go:noinline</span><br><span class="line">./unsafe.go:23:6: cannot inline f2: marked go:noinline</span><br><span class="line">./unsafe.go:8:6: cannot inline main: function too complex: cost 260 exceeds budget 80</span><br><span class="line">./unsafe.go:11:13: inlining call to fmt.Println func(...interface &#123;&#125;) (int, error) &#123; return fmt.Fprintln(io.Writer(os.Stdout), fmt.a...) &#125;</span><br><span class="line">./unsafe.go:12:13: inlining call to fmt.Println func(...interface &#123;&#125;) (int, error) &#123; return fmt.Fprintln(io.Writer(os.Stdout), fmt.a...) &#125;</span><br><span class="line">./unsafe.go:18:22: &amp;d escapes to heap</span><br><span class="line">./unsafe.go:18:22: from p (assigned) at ./unsafe.go:18:4</span><br><span class="line">./unsafe.go:18:22: from ~r0 (return) at ./unsafe.go:19:2</span><br><span class="line">./unsafe.go:17:2: moved to heap: d</span><br><span class="line">./unsafe.go:25:30: f2 &amp;d does not escape</span><br><span class="line">./unsafe.go:11:13: a escapes to heap</span><br><span class="line">./unsafe.go:11:13: from ~arg0 (assign-pair) at ./unsafe.go:11:13</span><br><span class="line">./unsafe.go:11:13: io.Writer(os.Stdout) escapes to heap</span><br><span class="line">./unsafe.go:11:13: from io.Writer(os.Stdout) (passed to call[argument escapes]) at ./unsafe.go:11:13</span><br><span class="line">./unsafe.go:12:13: io.Writer(os.Stdout) escapes to heap</span><br><span class="line">./unsafe.go:12:13: from io.Writer(os.Stdout) (passed to call[argument escapes]) at ./unsafe.go:12:13</span><br><span class="line">./unsafe.go:12:13: b escapes to heap</span><br><span class="line">./unsafe.go:12:13: from ~arg0 (assign-pair) at ./unsafe.go:12:13</span><br><span class="line">./unsafe.go:12:13: from []interface &#123;&#125; literal (slice-literal-element) at ./unsafe.go:12:13</span><br><span class="line">./unsafe.go:12:13: from fmt.a (assigned) at ./unsafe.go:12:13</span><br><span class="line">./unsafe.go:12:13: from *fmt.a (indirection) at ./unsafe.go:12:13</span><br><span class="line">./unsafe.go:12:13: from fmt.a (passed to call[argument content escapes]) at ./unsafe.go:12:13</span><br><span class="line">./unsafe.go:11:13: main []interface &#123;&#125; literal does not escape</span><br><span class="line">./unsafe.go:12:13: main []interface &#123;&#125; literal does not escape</span><br><span class="line">&lt;autogenerated&gt;:1: os.(*File).close .this does not escape</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥åœ¨å‡½æ•°fä¸­ï¼Œdé€ƒé€¸åˆ°å †ä¸Šï¼›ä½†æ˜¯åœ¨å‡½æ•°f2ä¸­ï¼Œdæ²¡æœ‰å‘ç”Ÿé€ƒé€¸ï¼Œuintptræ²¡æœ‰æŒæœ‰å¯¹è±¡ã€‚</p><h3 id="æ±‡ç¼–"><a href="#æ±‡ç¼–" class="headerlink" title="æ±‡ç¼–"></a>æ±‡ç¼–</h3><p>å†æ¥çœ‹çœ‹æ±‡ç¼–çš„ç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ go tool compile -S unsafe.go | grep unsafe.go:24</span><br><span class="line">0x000e 00014 (unsafe.go:24)PCDATA$2, $0</span><br><span class="line">0x000e 00014 (unsafe.go:24)PCDATA$0, $0</span><br><span class="line">0x000e 00014 (unsafe.go:24)MOVQ$1, &quot;&quot;.d(SP)</span><br><span class="line">$ go tool compile -S unsafe.go | grep unsafe.go:17</span><br><span class="line">0x001d 00029 (unsafe.go:17)PCDATA$2, $1</span><br><span class="line">0x001d 00029 (unsafe.go:17)PCDATA$0, $0</span><br><span class="line">0x001d 00029 (unsafe.go:17)LEAQtype.int(SB), AX</span><br><span class="line">0x0024 00036 (unsafe.go:17)PCDATA$2, $0</span><br><span class="line">0x0024 00036 (unsafe.go:17)MOVQAX, (SP)</span><br><span class="line">0x0028 00040 (unsafe.go:17)CALLruntime.newobject(SB)</span><br><span class="line">0x002d 00045 (unsafe.go:17)PCDATA$2, $1</span><br><span class="line">0x002d 00045 (unsafe.go:17)MOVQ8(SP), AX</span><br><span class="line">0x0032 00050 (unsafe.go:17)MOVQ$1, (AX)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥ï¼Œç»“æœä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œfä¸­çš„dè°ƒç”¨äº†newobjectï¼Œä½†æ˜¯f2ä¸­æ²¡æœ‰ã€‚</p><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>æ‰€ä»¥ä¸ºä»€ä¹ˆè¯´unsafeåŒ…ä¸å®‰å…¨å‘¢ï¼ŒåŸå› ä¹‹ä¸€å°±æ˜¯å› ä¸ºgoä¸ä¿è¯åœ°å€ä¸€å®šæ˜¯æœ‰æ•ˆçš„ï¼Œå½“ç„¶è¿˜æœ‰å…¶å®ƒçš„åŸå› ï¼Œæœ‰æ—¶é—´å†éªŒè¯åˆ†äº«ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨goä¸­ï¼Œuintpträ¸èƒ½æŒæœ‰å¯¹è±¡ï¼ŒunsafeåŒ…ä¸å®‰å…¨ï¼Œä½†æ˜¯æˆ‘ä¹‹å‰ä¸€ç›´æ²¡æœ‰æ—¶é—´éªŒè¯ï¼Œä»Šå¤©å†™äº†æ®µä»£ç éªŒè¯äº†ä¸€ä¸‹ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="go" scheme="https://www.purewhite.io/categories/go/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="go" scheme="https://www.purewhite.io/tags/go/"/>
    
    <category term="asm" scheme="https://www.purewhite.io/tags/asm/"/>
    
  </entry>
  
  <entry>
    <title>golang çš„ GC å¦‚ä½•å¤„ç† unsafe.Pointerï¼Ÿ</title>
    <link href="https://www.purewhite.io/2019/04/01/golang-gc-consider-unsafe/"/>
    <id>https://www.purewhite.io/2019/04/01/golang-gc-consider-unsafe/</id>
    <published>2019-04-01T12:42:37.000Z</published>
    <updated>2021-12-02T12:51:07.225Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨golangçš„é‚®ä»¶åˆ—è¡¨ä¸­çœ‹åˆ°äº†ä¸€ç¯‡å…³äºGCå¦‚ä½•å¤„ç†<code>unsafe.Pointer</code>çš„è®¨è®ºï¼Œè§‰å¾—åº”å½“è®°å½•ä¸€ä¸‹ã€‚</p><span id="more"></span><hr><p>é—®é¢˜1ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡åªè¢«<code>unsafe.Pointer</code>æ‰€æŒ‡å‘ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡ä¼šè¢«å›æ”¶ä¹ˆï¼Ÿ</p><p>å›ç­”1ï¼šä¸ä¼šã€‚å¦‚æœ<code>unsafe.Pointer</code>æŒ‡å‘äº†ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆgoçš„GCä¼šçŸ¥é“æœ‰è¿™ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”ä¸ä¼šé‡Šæ”¾è¿™ä¸ªå¯¹è±¡çš„å†…å­˜ã€‚</p><p>ä½†æ˜¯æ³¨æ„ï¼Œæœ‰ä¸€ä¸ªä¾‹å¤–ï¼šå¦‚æœè¿™ä¸ªå¯¹è±¡çš„å†…å­˜æ˜¯åœ¨goå¤–è¢«åˆ†é…çš„ï¼ˆæ¯”å¦‚<code>C.malloc</code>ï¼‰ï¼Œé‚£ä¹ˆä»¥ä¸Šçš„è§„åˆ™ä¸ç”Ÿæ•ˆã€‚</p><hr><p>é—®é¢˜2ï¼šå¦‚æœè¿™ä¸ªå¯¹è±¡å†…éƒ¨ä¹Ÿæœ‰ä¸€äº›æŒ‡é’ˆï¼Œé‚£ä¹ˆGCä¼šå¦‚ä½•å¤„ç†è¿™äº›æŒ‡é’ˆï¼Ÿ</p><p>å›ç­”2ï¼šå¦‚æœè¿™ä¸ªå¯¹è±¡æ˜¯åœ¨goå†…éƒ¨åˆ†é…çš„ï¼Œé‚£ä¹ˆGCä¹Ÿä¼šéå†è¿™äº›æŒ‡é’ˆï¼ˆä¹Ÿå°±æ˜¯ä¸ä¼šè¢«é‡Šæ”¾ï¼‰ã€‚</p><hr><p>é—®é¢˜3ï¼šå¦‚æœåœ¨ä»¥ä¸Šä¸¤ä¸ªé—®é¢˜ä¸­ï¼Œå¯¹è±¡éƒ½ä¸ä¼šè¢«é‡Šæ”¾ï¼Œé‚£ä¹ˆGCæ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Ÿ<code>unsafe.Pointer</code>ä¼šå­˜å¯¹è±¡çš„ç±»å‹ä¿¡æ¯ä¹ˆï¼Ÿ</p><p>å›ç­”3ï¼šä¸ä¼šå­˜ç±»å‹ä¿¡æ¯ï¼Œä½†æ˜¯å¦‚æœå¯¹è±¡æ˜¯åœ¨goä¸­ç”³è¯·çš„ï¼Œé‚£ä¹ˆåœ¨å¯¹åº”çš„å†…å­˜ä¸­æ˜¯ä¼šå­˜æœ‰ç±»å‹ä¿¡æ¯çš„ï¼›å¦‚æœæ²¡æœ‰ç±»å‹ä¿¡æ¯ï¼Œé‚£ä¹ˆGCä¼šé‡‡ç”¨éå¸¸ä¿å®ˆçš„ç­–ç•¥ï¼šéå†æ•´ä¸ªå¯¹è±¡ï¼Œåªè¦å…¶ä¸­æœ‰8bitçš„å€¼æ˜¯åˆæ³•çš„å†…å­˜åœ°å€ï¼ˆåœ¨æ ˆèŒƒå›´å†…ï¼Œæˆ–è€…åœ¨å †ä¸Šï¼‰ï¼Œå°±è®¤ä¸ºæ˜¯æŒ‡é’ˆï¼Œä¸ä¼šè¿›è¡Œå›æ”¶ã€‚</p><hr><p>é—®é¢˜4ï¼šæœ‰æ²¡æœ‰ä¸€ç§æƒ…å†µ<code>unsafe.Pointer</code>ä¼šå˜æˆéæ³•çš„ï¼ˆé‡æŒ‡é’ˆï¼‰ï¼Ÿ</p><p>å›ç­”4ï¼šåœ¨goä¸­ï¼Œåªè¦<code>unsafe.Pointer</code>æœ‰ä¸€åˆ»æ˜¯åˆæ³•çš„ï¼Œå¹¶ä¸”å®ƒçš„å€¼æ²¡æœ‰ä¿®æ”¹ï¼Œé‚£ä¹ˆgoä¼šä¿è¯å®ƒåœ¨æ•´ä¸ªç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸä¸­éƒ½æ˜¯åˆæ³•çš„ã€‚åœ¨<code>unsafe.Pointer</code>å’Œ<code>unsafe.Pointer</code>é—´çš„èµ‹å€¼ä¸€å®šæ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯é—´æ¥çš„èµ‹å€¼ï¼ˆæ¯”å¦‚åŒè¿‡uintptrï¼‰å¯èƒ½æ˜¯éæ³•çš„ï¼Œå› ä¸ºuintpträ¸è¢«è®¤ä¸ºæŒæœ‰äº†å¯¹è±¡ã€‚</p><hr><p>goä¼šå¿½è§†æ‰€æœ‰égoåˆ†é…çš„å¯¹è±¡ï¼ˆæ¯”å¦‚C.mallocï¼‰ï¼Œæ‰€ä»¥å¦‚æœåœ¨Cä¸­æœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘çš„åœ°å€åŒ…å«äº†goçš„å¯¹è±¡ï¼Œé‚£ä¹ˆå¿…é¡»ä¿è¯è¿™ä¸ªæŒ‡é’ˆåœ¨goä¸­ä¹Ÿè¢«ä¸€ä¸ªå¯¹è±¡å­˜å‚¨ä¸‹æ¥ã€‚</p><p><a href="https://groups.google.com/d/msg/golang-nuts/yNis7bQG_rY/yaJFoSx1hgIJ">åŸæ–‡</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘åœ¨golangçš„é‚®ä»¶åˆ—è¡¨ä¸­çœ‹åˆ°äº†ä¸€ç¯‡å…³äºGCå¦‚ä½•å¤„ç†&lt;code&gt;unsafe.Pointer&lt;/code&gt;çš„è®¨è®ºï¼Œè§‰å¾—åº”å½“è®°å½•ä¸€ä¸‹ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="go" scheme="https://www.purewhite.io/categories/go/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="go" scheme="https://www.purewhite.io/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>æºç å‰–ægolangä¸­sync.Mutex</title>
    <link href="https://www.purewhite.io/2019/03/28/golang-mutex-source/"/>
    <id>https://www.purewhite.io/2019/03/28/golang-mutex-source/</id>
    <published>2019-03-28T13:01:18.000Z</published>
    <updated>2021-12-02T12:51:07.226Z</updated>
    
    <content type="html"><![CDATA[<p>goè¯­è¨€ä»¥å¹¶å‘ä½œä¸ºå…¶ç‰¹æ€§ä¹‹ä¸€ï¼Œå¹¶å‘å¿…ç„¶ä¼šå¸¦æ¥å¯¹äºèµ„æºçš„ç«äº‰ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨goæä¾›çš„<code>sync.Mutex</code>è¿™æŠŠäº’æ–¥é”æ¥ä¿è¯ä¸´ç•Œèµ„æºçš„è®¿é—®äº’æ–¥ã€‚</p><p>æ—¢ç„¶ç»å¸¸ä¼šç”¨è¿™æŠŠé”ï¼Œé‚£ä¹ˆäº†è§£ä¸€ä¸‹å…¶å†…éƒ¨å®ç°ï¼Œå°±èƒ½äº†è§£è¿™æŠŠé”é€‚ç”¨ä»€ä¹ˆåœºæ™¯ï¼Œç‰¹æ€§å¦‚ä½•äº†ã€‚</p><span id="more"></span><h2 id="å¼•å­"><a href="#å¼•å­" class="headerlink" title="å¼•å­"></a>å¼•å­</h2><p>åœ¨çœ‹<code>sync.Mutex</code>çš„ä»£ç çš„æ—¶å€™ï¼Œä¸€å®šè¦è®°ä½ï¼ŒåŒæ—¶ä¼šæœ‰å¤šä¸ªgoroutineä¼šæ¥è¦è¿™æŠŠé”ï¼Œæ‰€ä»¥é”çš„çŠ¶æ€<code>state</code>æ˜¯å¯èƒ½ä¼šä¸€ç›´æ›´æ”¹çš„ã€‚</p><h2 id="é”çš„æ€§è´¨"><a href="#é”çš„æ€§è´¨" class="headerlink" title="é”çš„æ€§è´¨"></a>é”çš„æ€§è´¨</h2><p>å…ˆè¯´ç»“è®ºï¼š<code>sync.Mutex</code>æ˜¯æŠŠå…¬å¹³é”ã€‚</p><p>åœ¨æºä»£ç ä¸­ï¼Œæœ‰ä¸€æ®µæ³¨é‡Šï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Mutex fairness.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Mutex can be in 2 modes of operations: normal and starvation.</span></span><br><span class="line"><span class="comment">// In normal mode waiters are queued in FIFO order, but a woken up waiter</span></span><br><span class="line"><span class="comment">// does not own the mutex and competes with new arriving goroutines over</span></span><br><span class="line"><span class="comment">// the ownership. New arriving goroutines have an advantage -- they are</span></span><br><span class="line"><span class="comment">// already running on CPU and there can be lots of them, so a woken up</span></span><br><span class="line"><span class="comment">// waiter has good chances of losing. In such case it is queued at front</span></span><br><span class="line"><span class="comment">// of the wait queue. If a waiter fails to acquire the mutex for more than 1ms,</span></span><br><span class="line"><span class="comment">// it switches mutex to the starvation mode.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// In starvation mode ownership of the mutex is directly handed off from</span></span><br><span class="line"><span class="comment">// the unlocking goroutine to the waiter at the front of the queue.</span></span><br><span class="line"><span class="comment">// New arriving goroutines don&#x27;t try to acquire the mutex even if it appears</span></span><br><span class="line"><span class="comment">// to be unlocked, and don&#x27;t try to spin. Instead they queue themselves at</span></span><br><span class="line"><span class="comment">// the tail of the wait queue.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If a waiter receives ownership of the mutex and sees that either</span></span><br><span class="line"><span class="comment">// (1) it is the last waiter in the queue, or (2) it waited for less than 1 ms,</span></span><br><span class="line"><span class="comment">// it switches mutex back to normal operation mode.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Normal mode has considerably better performance as a goroutine can acquire</span></span><br><span class="line"><span class="comment">// a mutex several times in a row even if there are blocked waiters.</span></span><br><span class="line"><span class="comment">// Starvation mode is important to prevent pathological cases of tail latency.</span></span><br></pre></td></tr></table></figure><p>çœ‹æ‡‚è¿™æ®µæ³¨é‡Šå¯¹äºæˆ‘ä»¬ç†è§£mutexè¿™æŠŠé”æœ‰å¾ˆå¤§çš„å¸®åŠ©ï¼Œè¿™é‡Œé¢è®²äº†è¿™æŠŠé”çš„è®¾è®¡ç†å¿µã€‚å¤§è‡´æ„æ€å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…¬å¹³é”</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// é”æœ‰ä¸¤ç§æ¨¡å¼ï¼šæ­£å¸¸æ¨¡å¼å’Œé¥¥é¥¿æ¨¡å¼ã€‚</span></span><br><span class="line"><span class="comment">// åœ¨æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰çš„ç­‰å¾…é”çš„goroutineéƒ½ä¼šå­˜åœ¨ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ä¸­ï¼ˆè½®æµè¢«å”¤é†’ï¼‰</span></span><br><span class="line"><span class="comment">// ä½†æ˜¯ä¸€ä¸ªè¢«å”¤é†’çš„goroutineå¹¶ä¸æ˜¯ç›´æ¥è·å¾—é”ï¼Œè€Œæ˜¯ä»ç„¶éœ€è¦å’Œé‚£äº›æ–°è¯·æ±‚é”çš„ï¼ˆnew arrivialï¼‰</span></span><br><span class="line"><span class="comment">// çš„goroutineç«äº‰ï¼Œè€Œè¿™å…¶å®æ˜¯ä¸å…¬å¹³çš„ï¼Œå› ä¸ºæ–°è¯·æ±‚é”çš„goroutineæœ‰ä¸€ä¸ªä¼˜åŠ¿â€”â€”å®ƒä»¬æ­£åœ¨CPUä¸Š</span></span><br><span class="line"><span class="comment">// è¿è¡Œï¼Œå¹¶ä¸”æ•°é‡å¯èƒ½ä¼šå¾ˆå¤šã€‚æ‰€ä»¥ä¸€ä¸ªè¢«å”¤é†’çš„goroutineæ‹¿åˆ°é”çš„æ¦‚ç‡æ˜¯å¾ˆå°çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªè¢«å”¤é†’çš„goroutineä¼šåŠ å…¥åˆ°é˜Ÿåˆ—çš„å¤´éƒ¨ã€‚å¦‚æœä¸€ä¸ªç­‰å¾…çš„goroutineæœ‰è¶…è¿‡1msï¼ˆå†™æ­»åœ¨ä»£ç ä¸­ï¼‰</span></span><br><span class="line"><span class="comment">// éƒ½æ²¡è·å–åˆ°é”ï¼Œé‚£ä¹ˆå°±ä¼šæŠŠé”è½¬å˜ä¸ºé¥¥é¥¿æ¨¡å¼ã€‚</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// åœ¨é¥¥é¥¿æ¨¡å¼ä¸­ï¼Œé”çš„æ‰€æœ‰æƒä¼šç›´æ¥ä»é‡Šæ”¾é”(unlock)çš„goroutineè½¬äº¤ç»™é˜Ÿåˆ—å¤´çš„goroutineï¼Œ</span></span><br><span class="line"><span class="comment">// æ–°è¯·æ±‚é”çš„goroutineå°±ç®—é”æ˜¯ç©ºé—²çŠ¶æ€ä¹Ÿä¸ä¼šå»è·å–é”ï¼Œå¹¶ä¸”ä¹Ÿä¸ä¼šå°è¯•è‡ªæ—‹ã€‚å®ƒä»¬åªæ˜¯æ’åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// å¦‚æœä¸€ä¸ªgoroutineè·å–åˆ°äº†é”ä¹‹åï¼Œå®ƒä¼šåˆ¤æ–­ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š</span></span><br><span class="line"><span class="comment">// 1. å®ƒæ˜¯é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªgoroutineï¼›</span></span><br><span class="line"><span class="comment">// 2. å®ƒæ‹¿åˆ°é”æ‰€èŠ±çš„æ—¶é—´å°äº1msï¼›</span></span><br><span class="line"><span class="comment">// ä»¥ä¸Šåªè¦æœ‰ä¸€ä¸ªæˆç«‹ï¼Œå®ƒå°±ä¼šæŠŠé”è½¬å˜å›æ­£å¸¸æ¨¡å¼ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£å¸¸æ¨¡å¼ä¼šæœ‰æ¯”è¾ƒå¥½çš„æ€§èƒ½ï¼Œå› ä¸ºå³ä½¿æœ‰å¾ˆå¤šé˜»å¡çš„ç­‰å¾…é”çš„goroutineï¼Œ</span></span><br><span class="line"><span class="comment">// ä¸€ä¸ªgoroutineä¹Ÿå¯ä»¥å°è¯•è¯·æ±‚å¤šæ¬¡é”ã€‚</span></span><br><span class="line"><span class="comment">// é¥¥é¥¿æ¨¡å¼å¯¹äºé˜²æ­¢å°¾éƒ¨å»¶è¿Ÿæ¥è¯´éå¸¸çš„é‡è¦ã€‚</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸‹ä¸€æ­¥çœŸæ­£çœ‹æºä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»è¦ç†è§£ä¸€ç‚¹ï¼šå½“ä¸€ä¸ªgoroutineè·å–åˆ°é”çš„æ—¶å€™ï¼Œæœ‰å¯èƒ½æ²¡æœ‰ç«äº‰è€…ï¼Œä¹Ÿæœ‰å¯èƒ½ä¼šæœ‰å¾ˆå¤šç«äº‰è€…ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ç«™åœ¨ä¸åŒçš„goroutineçš„è§’åº¦ä¸Šå»è€ƒè™‘goroutineçœ‹åˆ°çš„é”çš„çŠ¶æ€å’Œå®é™…çŠ¶æ€ã€æœŸæœ›çŠ¶æ€ä¹‹é—´çš„è½¬åŒ–ã€‚</p><h2 id="å­—æ®µå®šä¹‰"><a href="#å­—æ®µå®šä¹‰" class="headerlink" title="å­—æ®µå®šä¹‰"></a>å­—æ®µå®šä¹‰</h2><p><code>sync.Mutex</code>åªåŒ…å«ä¸¤ä¸ªå­—æ®µï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A Mutex is a mutual exclusion lock.</span></span><br><span class="line"><span class="comment">// The zero value for a Mutex is an unlocked mutex.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// A Mutex must not be copied after first use.</span></span><br><span class="line"><span class="keyword">type</span> Mutex <span class="keyword">struct</span> &#123;</span><br><span class="line">state <span class="keyword">int32</span></span><br><span class="line">sema<span class="keyword">uint32</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">mutexLocked = <span class="number">1</span> &lt;&lt; <span class="literal">iota</span> <span class="comment">// mutex is locked</span></span><br><span class="line">mutexWoken</span><br><span class="line">mutexStarving</span><br><span class="line">mutexWaiterShift = <span class="literal">iota</span></span><br><span class="line"></span><br><span class="line">starvationThresholdNs = <span class="number">1e6</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>state</code>æ˜¯ä¸€ä¸ªè¡¨ç¤ºé”çš„çŠ¶æ€çš„å­—æ®µï¼Œè¿™ä¸ªå­—æ®µä¼šåŒæ—¶è¢«å¤šä¸ªgoroutineæ‰€å…±ç”¨ï¼ˆä½¿ç”¨atomic.CASæ¥ä¿è¯åŸå­æ€§ï¼‰ï¼Œç¬¬0ä¸ªbitï¼ˆ1ï¼‰è¡¨ç¤ºé”å·²è¢«è·å–ï¼Œä¹Ÿå°±æ˜¯å·²åŠ é”ï¼Œè¢«æŸä¸ªgoroutineæ‹¥æœ‰ï¼›ç¬¬1ä¸ªbitï¼ˆ2ï¼‰è¡¨ç¤ºæœ‰goroutineè¢«å”¤é†’ï¼Œå°è¯•è·å–é”ï¼›ç¬¬2ä¸ªbitï¼ˆ4ï¼‰æ ‡è®°è¿™æŠŠé”æ˜¯å¦ä¸ºé¥¥é¥¿çŠ¶æ€ã€‚</p><p><code>sema</code>å­—æ®µå°±æ˜¯ç”¨æ¥å”¤é†’goroutineæ‰€ç”¨çš„ä¿¡å·é‡ã€‚</p><h2 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h2><p>åœ¨çœ‹ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æœ‰ä¸€ä¸ªæ¦‚å¿µï¼šæ¯ä¸ªgoroutineä¹Ÿæœ‰è‡ªå·±çš„çŠ¶æ€ï¼Œå­˜åœ¨å±€éƒ¨å˜é‡é‡Œé¢ï¼ˆä¹Ÿå°±æ˜¯å‡½æ•°æ ˆé‡Œé¢ï¼‰ï¼Œgoroutineæœ‰å¯èƒ½æ˜¯æ–°åˆ°çš„ã€è¢«å”¤é†’çš„ã€æ­£å¸¸çš„ã€é¥¥é¥¿çš„ã€‚</p><h3 id="atomic-CAS"><a href="#atomic-CAS" class="headerlink" title="atomic.CAS"></a>atomic.CAS</h3><p>å…ˆçœ‹ä¸€ä¸‹æœ€åŸºç¡€çš„ä¸€è¡Œä»£ç åŠ é”çš„CASæ“ä½œï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Lock locks m.</span></span><br><span class="line"><span class="comment">// If the lock is already in use, the calling goroutine</span></span><br><span class="line"><span class="comment">// blocks until the mutex is available.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Lock</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// Fast path: grab unlocked mutex.</span></span><br><span class="line"><span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, <span class="number">0</span>, mutexLocked) &#123;</span><br><span class="line"><span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">race.Acquire(unsafe.Pointer(m))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ç¬¬ä¸€æ®µä»£ç ï¼Œè¿™æ®µä»£ç è°ƒç”¨äº†<code>atomic</code>åŒ…ä¸­çš„<code>CompareAndSwapInt32</code>è¿™ä¸ªæ–¹æ³•æ¥å°è¯•å¿«é€Ÿè·å–é”ï¼Œè¿™ä¸ªæ–¹æ³•çš„ç­¾åå¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CompareAndSwapInt32 executes the compare-and-swap operation for an int32 value.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CompareAndSwapInt32</span><span class="params">(addr *<span class="keyword">int32</span>, old, <span class="built_in">new</span> <span class="keyword">int32</span>)</span> <span class="params">(swapped <span class="keyword">bool</span>)</span></span></span><br></pre></td></tr></table></figure><p>æ„æ€æ˜¯ï¼Œå¦‚æœaddræŒ‡å‘çš„åœ°å€ä¸­å­˜çš„å€¼å’Œoldä¸€æ ·ï¼Œé‚£ä¹ˆå°±æŠŠaddrä¸­çš„å€¼æ”¹ä¸ºnewå¹¶è¿”å›trueï¼›å¦åˆ™ä»€ä¹ˆéƒ½ä¸åšï¼Œè¿”å›falseã€‚ç”±äºæ˜¯<code>atomic</code>ä¸­çš„å‡½æ•°ï¼Œæ‰€ä»¥æ˜¯ä¿è¯äº†åŸå­æ€§çš„ã€‚</p><p>æˆ‘ä»¬æ¥å…·ä½“çœ‹çœ‹CASçš„å®ç°ï¼ˆ<code>src/runtime/internal/atomic/asm_amd64.s</code>ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">// bool Cas(int32 *val, int32 old, int32 new)</span><br><span class="line">// Atomically:</span><br><span class="line">//if(*val == old)&#123;</span><br><span class="line">//*val = new;</span><br><span class="line">//return 1;</span><br><span class="line">//&#125; else</span><br><span class="line">//return 0;</span><br><span class="line">// è¿™é‡Œå‚æ•°åŠè¿”å›å€¼å¤§å°åŠ èµ·æ¥æ˜¯17ï¼Œæ˜¯å› ä¸ºä¸€ä¸ªæŒ‡é’ˆåœ¨amd64ä¸‹æ˜¯8å­—èŠ‚ï¼Œ</span><br><span class="line">// ç„¶åint32åˆ†åˆ«æ˜¯å ç”¨4å­—èŠ‚ï¼Œæœ€åçš„è¿”å›å€¼æ˜¯boolå ç”¨1å­—èŠ‚ï¼Œæ‰€ä»¥åŠ èµ·æ¥æ˜¯17</span><br><span class="line">TEXT runtimeâˆ•internalâˆ•atomicÂ·Cas(SB),NOSPLIT,$0-17 </span><br><span class="line">// ä¸ºä»€ä¹ˆä¸æŠŠ*valæŒ‡é’ˆæ”¾åˆ°AXä¸­å‘¢ï¼Ÿå› ä¸ºAXæœ‰ç‰¹æ®Šç”¨å¤„ï¼Œ</span><br><span class="line">// åœ¨ä¸‹é¢çš„CMPXCHGLé‡Œé¢ï¼Œä¼šä»AXä¸­è¯»å–è¦æ¯”è¾ƒçš„å…¶ä¸­ä¸€ä¸ªæ•°</span><br><span class="line">MOVQptr+0(FP), BX</span><br><span class="line">// æ‰€ä»¥AXè¦ç”¨æ¥å­˜å‚æ•°old</span><br><span class="line">MOVLold+8(FP), AX</span><br><span class="line">// æŠŠnewä¸­çš„æ•°å­˜åˆ°å¯„å­˜å™¨CXä¸­</span><br><span class="line">MOVLnew+12(FP), CX</span><br><span class="line">// æ³¨æ„è¿™é‡Œäº†ï¼Œè¿™é‡Œä½¿ç”¨äº†LOCKå‰ç¼€ï¼Œæ‰€ä»¥ä¿è¯æ“ä½œæ˜¯åŸå­çš„</span><br><span class="line">LOCK</span><br><span class="line">// 0(BX) å¯ä»¥ç†è§£ä¸º *val</span><br><span class="line">// æŠŠ AXä¸­çš„æ•° å’Œ ç¬¬äºŒä¸ªæ“ä½œæ•° 0(BX)â€”â€”ä¹Ÿå°±æ˜¯BXå¯„å­˜å™¨æ‰€æŒ‡å‘çš„åœ°å€ä¸­å­˜çš„å€¼ è¿›è¡Œæ¯”è¾ƒ</span><br><span class="line">// å¦‚æœç›¸ç­‰ï¼Œå°±æŠŠ ç¬¬ä¸€ä¸ªæ“ä½œæ•° CXå¯„å­˜å™¨ä¸­å­˜çš„å€¼ èµ‹ç»™ ç¬¬äºŒä¸ªæ“ä½œæ•° BXå¯„å­˜å™¨æ‰€æŒ‡å‘çš„åœ°å€</span><br><span class="line">// å¹¶å°†æ ‡å¿—å¯„å­˜å™¨ZFè®¾ä¸º1</span><br><span class="line">// å¦åˆ™å°†æ ‡å¿—å¯„å­˜å™¨ZFæ¸…é›¶</span><br><span class="line">CMPXCHGLCX, 0(BX)</span><br><span class="line">// SETEçš„ä½œç”¨æ˜¯ï¼š</span><br><span class="line">// å¦‚æœZero Flagæ ‡å¿—å¯„å­˜å™¨ä¸º1ï¼Œé‚£ä¹ˆå°±æŠŠæ“ä½œæ•°è®¾ä¸º1</span><br><span class="line">// å¦åˆ™æŠŠæ“ä½œæ•°è®¾ä¸º0</span><br><span class="line">// ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸Šé¢çš„æ¯”è¾ƒç›¸ç­‰äº†ï¼Œå°±è¿”å›trueï¼Œå¦åˆ™ä¸ºfalse</span><br><span class="line">// ret+16(FP)ä»£è¡¨äº†è¿”å›å€¼çš„åœ°å€</span><br><span class="line">SETEQret+16(FP)</span><br><span class="line">RET</span><br></pre></td></tr></table></figure><p>å¦‚æœçœ‹ä¸æ‡‚ä¹Ÿæ²¡å¤ªå¤§å…³ç³»ï¼Œåªè¦çŸ¥é“è¿™ä¸ªå‡½æ•°çš„ä½œç”¨ï¼Œä»¥åŠè¿™ä¸ªå‡½æ•°æ˜¯åŸå­æ€§çš„å³å¯ã€‚</p><p>é‚£ä¹ˆè¿™æ®µä»£ç çš„æ„æ€å°±æ˜¯ï¼šå…ˆçœ‹çœ‹è¿™æŠŠé”æ˜¯ä¸æ˜¯ç©ºé—²çŠ¶æ€ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œç›´æ¥åŸå­æ€§åœ°ä¿®æ”¹ä¸€ä¸‹<code>state</code>ä¸ºå·²è¢«è·å–å°±è¡Œäº†ã€‚å¤šä¹ˆç®€æ´ï¼ˆè™½ç„¶åé¢çš„ä»£ç å¹¶ä¸æ˜¯â€¦â€¦ï¼‰ï¼</p><h3 id="ä¸»æµç¨‹"><a href="#ä¸»æµç¨‹" class="headerlink" title="ä¸»æµç¨‹"></a>ä¸»æµç¨‹</h3><p>æ¥ä¸‹æ¥å…·ä½“çœ‹ä¸»æµç¨‹çš„ä»£ç ï¼Œä»£ç ä¸­æœ‰ä¸€äº›ä½è¿ç®—çœ‹èµ·æ¥æ¯”è¾ƒæ™•ï¼Œæˆ‘ä¼šè¯•ç€ç”¨ä¼ªä»£ç åœ¨è¾¹ä¸Šæ³¨é‡Šã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Lock locks m.</span></span><br><span class="line"><span class="comment">// If the lock is already in use, the calling goroutine</span></span><br><span class="line"><span class="comment">// blocks until the mutex is available.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Lock</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// Fast path: grab unlocked mutex.</span></span><br><span class="line"><span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, <span class="number">0</span>, mutexLocked) &#123;</span><br><span class="line"><span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">race.Acquire(unsafe.Pointer(m))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨æ¥å­˜å½“å‰goroutineç­‰å¾…çš„æ—¶é—´</span></span><br><span class="line"><span class="keyword">var</span> waitStartTime <span class="keyword">int64</span></span><br><span class="line"><span class="comment">// ç”¨æ¥å­˜å½“å‰goroutineæ˜¯å¦é¥¥é¥¿</span></span><br><span class="line">starving := <span class="literal">false</span></span><br><span class="line"><span class="comment">// ç”¨æ¥å­˜å½“å‰goroutineæ˜¯å¦å·²å”¤é†’</span></span><br><span class="line">awoke := <span class="literal">false</span></span><br><span class="line"><span class="comment">// ç”¨æ¥å­˜å½“å‰goroutineçš„å¾ªç¯æ¬¡æ•°(æƒ³ä¸€æƒ³ä¸€ä¸ªgoroutineå¦‚æœå¾ªç¯äº†2147483648æ¬¡å’‹åŠâ€¦â€¦)</span></span><br><span class="line">iter := <span class="number">0</span></span><br><span class="line"><span class="comment">// å¤åˆ¶ä¸€ä¸‹å½“å‰é”çš„çŠ¶æ€</span></span><br><span class="line">old := m.state</span><br><span class="line"><span class="comment">// è‡ªæ—‹</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="comment">// å¦‚æœæ˜¯é¥¥é¥¿æƒ…å†µä¹‹ä¸‹ï¼Œå°±ä¸è¦è‡ªæ—‹äº†ï¼Œå› ä¸ºé”ä¼šç›´æ¥äº¤ç»™é˜Ÿåˆ—å¤´éƒ¨çš„goroutine</span></span><br><span class="line"><span class="comment">// å¦‚æœé”æ˜¯è¢«è·å–çŠ¶æ€ï¼Œå¹¶ä¸”æ»¡è¶³è‡ªæ—‹æ¡ä»¶ï¼ˆcanSpinè§åæ–‡åˆ†æï¼‰ï¼Œé‚£ä¹ˆå°±è‡ªæ—‹ç­‰é”</span></span><br><span class="line"><span class="comment">// ä¼ªä»£ç ï¼šif isLocked() and isNotStarving() and canSpin()</span></span><br><span class="line"><span class="keyword">if</span> old&amp;(mutexLocked|mutexStarving) == mutexLocked &amp;&amp; runtime_canSpin(iter) &#123;</span><br><span class="line"><span class="comment">// å°†è‡ªå·±çš„çŠ¶æ€ä»¥åŠé”çš„çŠ¶æ€è®¾ç½®ä¸ºå”¤é†’ï¼Œè¿™æ ·å½“Unlockçš„æ—¶å€™å°±ä¸ä¼šå»å”¤é†’å…¶å®ƒè¢«é˜»å¡çš„goroutineäº†</span></span><br><span class="line"><span class="keyword">if</span> !awoke &amp;&amp; old&amp;mutexWoken == <span class="number">0</span> &amp;&amp; old&gt;&gt;mutexWaiterShift != <span class="number">0</span> &amp;&amp;</span><br><span class="line">atomic.CompareAndSwapInt32(&amp;m.state, old, old|mutexWoken) &#123;</span><br><span class="line">awoke = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¿›è¡Œè‡ªæ—‹(åˆ†æè§åæ–‡)</span></span><br><span class="line">runtime_doSpin()</span><br><span class="line">iter++</span><br><span class="line"><span class="comment">// æ›´æ–°é”çš„çŠ¶æ€(æœ‰å¯èƒ½åœ¨è‡ªæ—‹çš„è¿™æ®µæ—¶é—´ä¹‹å†…é”çš„çŠ¶æ€å·²ç»è¢«å…¶å®ƒgoroutineæ”¹å˜)</span></span><br><span class="line">old = m.state</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“èµ°åˆ°è¿™ä¸€æ­¥çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šæœ‰ä»¥ä¸‹çš„æƒ…å†µï¼š</span></span><br><span class="line"><span class="comment">// 1. é”è¢«è·å–+é¥¥é¥¿</span></span><br><span class="line"><span class="comment">// 2. é”è¢«è·å–+æ­£å¸¸</span></span><br><span class="line"><span class="comment">// 3. é”ç©ºé—²+é¥¥é¥¿</span></span><br><span class="line"><span class="comment">// 4. é”ç©ºé—²+æ­£å¸¸</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// goroutineçš„çŠ¶æ€å¯èƒ½æ˜¯å”¤é†’ä»¥åŠéå”¤é†’</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤åˆ¶ä¸€ä»½å½“å‰çš„çŠ¶æ€ï¼Œç›®çš„æ˜¯æ ¹æ®å½“å‰çŠ¶æ€è®¾ç½®å‡ºæœŸæœ›çš„çŠ¶æ€ï¼Œå­˜åœ¨newé‡Œé¢ï¼Œ</span></span><br><span class="line"><span class="comment">// å¹¶ä¸”é€šè¿‡CASæ¥æ¯”è¾ƒä»¥åŠæ›´æ–°é”çš„çŠ¶æ€</span></span><br><span class="line"><span class="comment">// oldç”¨æ¥å­˜é”çš„å½“å‰çŠ¶æ€</span></span><br><span class="line"><span class="built_in">new</span> := old</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœè¯´é”ä¸æ˜¯é¥¥é¥¿çŠ¶æ€ï¼Œå°±æŠŠæœŸæœ›çŠ¶æ€è®¾ç½®ä¸ºè¢«è·å–(è·å–é”)</span></span><br><span class="line"><span class="comment">// ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ˜¯é¥¥é¥¿çŠ¶æ€ï¼Œå°±ä¸è¦æŠŠæœŸæœ›çŠ¶æ€è®¾ç½®ä¸ºè¢«è·å–</span></span><br><span class="line"><span class="comment">// æ–°åˆ°çš„goroutineä¹–ä¹–æ’é˜Ÿå»</span></span><br><span class="line"><span class="comment">// ä¼ªä»£ç ï¼šif isNotStarving()</span></span><br><span class="line"><span class="keyword">if</span> old&amp;mutexStarving == <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// ä¼ªä»£ç ï¼šnewState = locked</span></span><br><span class="line"><span class="built_in">new</span> |= mutexLocked</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¦‚æœé”æ˜¯è¢«è·å–çŠ¶æ€ï¼Œæˆ–è€…é¥¥é¥¿çŠ¶æ€</span></span><br><span class="line"><span class="comment">// å°±æŠŠæœŸæœ›çŠ¶æ€ä¸­çš„ç­‰å¾…é˜Ÿåˆ—çš„ç­‰å¾…è€…æ•°é‡+1(å®é™…ä¸Šæ˜¯new + 8)</span></span><br><span class="line"><span class="comment">// (ä¼šä¸ä¼šå¯èƒ½æœ‰ä¸‰äº¿ä¸ªgoroutineç­‰å¾…æ‹¿é”â€¦â€¦)</span></span><br><span class="line"><span class="keyword">if</span> old&amp;(mutexLocked|mutexStarving) != <span class="number">0</span> &#123;</span><br><span class="line"><span class="built_in">new</span> += <span class="number">1</span> &lt;&lt; mutexWaiterShift</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¦‚æœè¯´å½“å‰çš„goroutineæ˜¯é¥¥é¥¿çŠ¶æ€ï¼Œå¹¶ä¸”é”è¢«å…¶å®ƒgoroutineè·å–</span></span><br><span class="line"><span class="comment">// é‚£ä¹ˆå°†æœŸæœ›çš„é”çš„çŠ¶æ€è®¾ç½®ä¸ºé¥¥é¥¿çŠ¶æ€</span></span><br><span class="line"><span class="comment">// å¦‚æœé”æ˜¯é‡Šæ”¾çŠ¶æ€ï¼Œé‚£ä¹ˆå°±ä¸ç”¨åˆ‡æ¢äº†</span></span><br><span class="line"><span class="comment">// UnlockæœŸæœ›ä¸€ä¸ªé¥¥é¥¿çš„é”ä¼šæœ‰ä¸€äº›ç­‰å¾…æ‹¿é”çš„goroutineï¼Œè€Œä¸åªæ˜¯ä¸€ä¸ª</span></span><br><span class="line"><span class="comment">// è¿™ç§æƒ…å†µä¸‹ä¸ä¼šæˆç«‹</span></span><br><span class="line"><span class="keyword">if</span> starving &amp;&amp; old&amp;mutexLocked != <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// æœŸæœ›çŠ¶æ€è®¾ç½®ä¸ºé¥¥é¥¿çŠ¶æ€</span></span><br><span class="line"><span class="built_in">new</span> |= mutexStarving</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¦‚æœè¯´å½“å‰goroutineæ˜¯è¢«å”¤é†’çŠ¶æ€ï¼Œæˆ‘ä»¬éœ€è¦resetè¿™ä¸ªçŠ¶æ€</span></span><br><span class="line"><span class="comment">// å› ä¸ºgoroutineè¦ä¹ˆæ˜¯æ‹¿åˆ°é”äº†ï¼Œè¦ä¹ˆæ˜¯è¿›å…¥sleepäº†</span></span><br><span class="line"><span class="keyword">if</span> awoke &#123;</span><br><span class="line"><span class="comment">// å¦‚æœè¯´æœŸæœ›çŠ¶æ€ä¸æ˜¯wokençŠ¶æ€ï¼Œé‚£ä¹ˆè‚¯å®šå‡ºé—®é¢˜äº†</span></span><br><span class="line"><span class="comment">// è¿™é‡Œçœ‹ä¸æ‡‚æ²¡å…³ç³»ï¼Œwakeçš„é€»è¾‘åœ¨ä¸‹é¢</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">new</span>&amp;mutexWoken == <span class="number">0</span> &#123;</span><br><span class="line">throw(<span class="string">&quot;sync: inconsistent mutex state&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¿™å¥å°±æ˜¯æŠŠnewè®¾ç½®ä¸ºéå”¤é†’çŠ¶æ€</span></span><br><span class="line"><span class="comment">// &amp;^çš„æ„æ€æ˜¯and not</span></span><br><span class="line"><span class="built_in">new</span> &amp;^= mutexWoken</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// é€šè¿‡CASæ¥å°è¯•è®¾ç½®é”çš„çŠ¶æ€</span></span><br><span class="line"><span class="comment">// è¿™é‡Œå¯èƒ½æ˜¯è®¾ç½®é”ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯åªè®¾ç½®ä¸ºé¥¥é¥¿çŠ¶æ€å’Œç­‰å¾…æ•°é‡</span></span><br><span class="line"><span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="built_in">new</span>) &#123;</span><br><span class="line"><span class="comment">// å¦‚æœè¯´oldçŠ¶æ€ä¸æ˜¯é¥¥é¥¿çŠ¶æ€ä¹Ÿä¸æ˜¯è¢«è·å–çŠ¶æ€</span></span><br><span class="line"><span class="comment">// é‚£ä¹ˆä»£è¡¨å½“å‰goroutineå·²ç»é€šè¿‡CASæˆåŠŸè·å–äº†é”</span></span><br><span class="line"><span class="comment">// (èƒ½è¿›å…¥è¿™ä¸ªä»£ç å—è¡¨ç¤ºçŠ¶æ€å·²æ”¹å˜ï¼Œä¹Ÿå°±æ˜¯è¯´çŠ¶æ€æ˜¯ä»ç©ºé—²åˆ°è¢«è·å–)</span></span><br><span class="line"><span class="keyword">if</span> old&amp;(mutexLocked|mutexStarving) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">break</span> <span class="comment">// locked the mutex with CAS</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¦‚æœä¹‹å‰å·²ç»ç­‰å¾…è¿‡äº†ï¼Œé‚£ä¹ˆå°±è¦æ”¾åˆ°é˜Ÿåˆ—å¤´</span></span><br><span class="line">queueLifo := waitStartTime != <span class="number">0</span></span><br><span class="line"><span class="comment">// å¦‚æœè¯´ä¹‹å‰æ²¡æœ‰ç­‰å¾…è¿‡ï¼Œå°±åˆå§‹åŒ–è®¾ç½®ç°åœ¨çš„ç­‰å¾…æ—¶é—´</span></span><br><span class="line"><span class="keyword">if</span> waitStartTime == <span class="number">0</span> &#123;</span><br><span class="line">waitStartTime = runtime_nanotime()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ—¢ç„¶è·å–é”å¤±è´¥äº†ï¼Œå°±ä½¿ç”¨sleepåŸè¯­æ¥é˜»å¡å½“å‰goroutine</span></span><br><span class="line"><span class="comment">// é€šè¿‡ä¿¡å·é‡æ¥æ’é˜Ÿè·å–é”</span></span><br><span class="line"><span class="comment">// å¦‚æœæ˜¯æ–°æ¥çš„goroutineï¼Œå°±æ”¾åˆ°é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line"><span class="comment">// å¦‚æœæ˜¯è¢«å”¤é†’çš„ç­‰å¾…é”çš„goroutineï¼Œå°±æ”¾åˆ°é˜Ÿåˆ—å¤´éƒ¨</span></span><br><span class="line">runtime_SemacquireMutex(&amp;m.sema, queueLifo)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™é‡Œsleepå®Œäº†ï¼Œè¢«å”¤é†’</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœå½“å‰goroutineå·²ç»æ˜¯é¥¥é¥¿çŠ¶æ€äº†</span></span><br><span class="line"><span class="comment">// æˆ–è€…å½“å‰goroutineå·²ç»ç­‰å¾…äº†1msï¼ˆåœ¨ä¸Šé¢å®šä¹‰å¸¸é‡ï¼‰ä»¥ä¸Š</span></span><br><span class="line"><span class="comment">// å°±æŠŠå½“å‰goroutineçš„çŠ¶æ€è®¾ç½®ä¸ºé¥¥é¥¿</span></span><br><span class="line">starving = starving || runtime_nanotime()-waitStartTime &gt; starvationThresholdNs</span><br><span class="line"><span class="comment">// å†æ¬¡è·å–ä¸€ä¸‹é”ç°åœ¨çš„çŠ¶æ€</span></span><br><span class="line">old = m.state</span><br><span class="line"><span class="comment">// å¦‚æœè¯´é”ç°åœ¨æ˜¯é¥¥é¥¿çŠ¶æ€ï¼Œå°±ä»£è¡¨ç°åœ¨é”æ˜¯è¢«é‡Šæ”¾çš„çŠ¶æ€ï¼Œå½“å‰goroutineæ˜¯è¢«ä¿¡å·é‡æ‰€å”¤é†’çš„</span></span><br><span class="line"><span class="comment">// ä¹Ÿå°±æ˜¯è¯´ï¼Œé”è¢«ç›´æ¥äº¤ç»™äº†å½“å‰goroutine</span></span><br><span class="line"><span class="keyword">if</span> old&amp;mutexStarving != <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// å¦‚æœè¯´å½“å‰é”çš„çŠ¶æ€æ˜¯è¢«å”¤é†’çŠ¶æ€æˆ–è€…è¢«è·å–çŠ¶æ€ï¼Œæˆ–è€…è¯´ç­‰å¾…çš„é˜Ÿåˆ—ä¸ºç©º</span></span><br><span class="line"><span class="comment">// é‚£ä¹ˆæ˜¯ä¸å¯èƒ½çš„ï¼Œè‚¯å®šæ˜¯å‡ºé—®é¢˜äº†ï¼Œå› ä¸ºå½“å‰çŠ¶æ€è‚¯å®šåº”è¯¥æœ‰ç­‰å¾…çš„é˜Ÿåˆ—ï¼Œé”ä¹Ÿä¸€å®šæ˜¯è¢«é‡Šæ”¾çŠ¶æ€ä¸”æœªå”¤é†’</span></span><br><span class="line"><span class="keyword">if</span> old&amp;(mutexLocked|mutexWoken) != <span class="number">0</span> || old&gt;&gt;mutexWaiterShift == <span class="number">0</span> &#123;</span><br><span class="line">throw(<span class="string">&quot;sync: inconsistent mutex state&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å½“å‰çš„goroutineè·å¾—äº†é”ï¼Œé‚£ä¹ˆå°±æŠŠç­‰å¾…é˜Ÿåˆ—-1</span></span><br><span class="line">delta := <span class="keyword">int32</span>(mutexLocked - <span class="number">1</span>&lt;&lt;mutexWaiterShift)</span><br><span class="line"><span class="comment">// å¦‚æœå½“å‰goroutineéé¥¥é¥¿çŠ¶æ€ï¼Œæˆ–è€…è¯´å½“å‰goroutineæ˜¯é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªgoroutine</span></span><br><span class="line"><span class="comment">// é‚£ä¹ˆå°±é€€å‡ºé¥¥é¥¿æ¨¡å¼ï¼ŒæŠŠçŠ¶æ€è®¾ç½®ä¸ºæ­£å¸¸</span></span><br><span class="line"><span class="keyword">if</span> !starving || old&gt;&gt;mutexWaiterShift == <span class="number">1</span> &#123;</span><br><span class="line"><span class="comment">// Exit starvation mode.</span></span><br><span class="line"><span class="comment">// Critical to do it here and consider wait time.</span></span><br><span class="line"><span class="comment">// Starvation mode is so inefficient, that two goroutines</span></span><br><span class="line"><span class="comment">// can go lock-step infinitely once they switch mutex</span></span><br><span class="line"><span class="comment">// to starvation mode.</span></span><br><span class="line">delta -= mutexStarving</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åŸå­æ€§åœ°åŠ ä¸Šæ”¹åŠ¨çš„çŠ¶æ€</span></span><br><span class="line">atomic.AddInt32(&amp;m.state, delta)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¦‚æœé”ä¸æ˜¯é¥¥é¥¿æ¨¡å¼ï¼Œå°±æŠŠå½“å‰çš„goroutineè®¾ä¸ºè¢«å”¤é†’</span></span><br><span class="line"><span class="comment">// å¹¶ä¸”é‡ç½®iter(é‡ç½®spin)</span></span><br><span class="line">awoke = <span class="literal">true</span></span><br><span class="line">iter = <span class="number">0</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// å¦‚æœCASä¸æˆåŠŸï¼Œä¹Ÿå°±æ˜¯è¯´æ²¡èƒ½æˆåŠŸè·å¾—é”ï¼Œé”è¢«åˆ«çš„goroutineè·å¾—äº†æˆ–è€…é”ä¸€ç›´æ²¡è¢«é‡Šæ”¾</span></span><br><span class="line"><span class="comment">// é‚£ä¹ˆå°±æ›´æ–°çŠ¶æ€ï¼Œé‡æ–°å¼€å§‹å¾ªç¯å°è¯•æ‹¿é”</span></span><br><span class="line">old = m.state</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">race.Acquire(unsafe.Pointer(m))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä¸ºä»€ä¹ˆCASèƒ½æ‹¿åˆ°é”å‘¢ï¼Ÿå› ä¸ºCASä¼šåŸå­æ€§åœ°åˆ¤æ–­<code>old state</code>å’Œå½“å‰é”çš„çŠ¶æ€æ˜¯å¦ä¸€è‡´ï¼›è€Œæ€»æœ‰ä¸€ä¸ªgoroutineä¼šæ»¡è¶³ä»¥ä¸Šæ¡ä»¶æˆåŠŸæ‹¿é”ã€‚</p><h3 id="canSpin"><a href="#canSpin" class="headerlink" title="canSpin"></a>canSpin</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹ä¸Šæ–‡æåˆ°çš„<code>canSpin</code>æ¡ä»¶å¦‚ä½•ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Active spinning for sync.Mutex.</span></span><br><span class="line"><span class="comment">//go:linkname sync_runtime_canSpin sync.runtime_canSpin</span></span><br><span class="line"><span class="comment">//go:nosplit</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sync_runtime_canSpin</span><span class="params">(i <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line"><span class="comment">// è¿™é‡Œçš„active_spinæ˜¯ä¸ªå¸¸é‡ï¼Œå€¼ä¸º4</span></span><br><span class="line"><span class="comment">// ç®€å•æ¥è¯´ï¼Œsync.Mutexæ˜¯æœ‰å¯èƒ½è¢«å¤šä¸ªgoroutineç«äº‰çš„ï¼Œæ‰€ä»¥ä¸åº”è¯¥å¤§é‡è‡ªæ—‹(æ¶ˆè€—CPU)</span></span><br><span class="line"><span class="comment">// è‡ªæ—‹çš„æ¡ä»¶å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="comment">// 1. è‡ªæ—‹æ¬¡æ•°å°äºactive_spin(è¿™é‡Œæ˜¯4)æ¬¡ï¼›</span></span><br><span class="line"><span class="comment">// 2. åœ¨å¤šæ ¸æœºå™¨ä¸Šï¼›</span></span><br><span class="line"><span class="comment">// 3. GOMAXPROCS &gt; 1å¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªå…¶å®ƒçš„å¤„äºè¿è¡ŒçŠ¶æ€çš„Pï¼›</span></span><br><span class="line"><span class="comment">// 4. å½“å‰Pæ²¡æœ‰å…¶å®ƒç­‰å¾…è¿è¡Œçš„Gï¼›</span></span><br><span class="line"><span class="comment">// æ»¡è¶³ä»¥ä¸Šå››ä¸ªæ¡ä»¶æ‰å¯ä»¥è¿›è¡Œè‡ªæ—‹ã€‚</span></span><br><span class="line"><span class="keyword">if</span> i &gt;= active_spin || ncpu &lt;= <span class="number">1</span> || gomaxprocs &lt;= <span class="keyword">int32</span>(sched.npidle+sched.nmspinning)+<span class="number">1</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> p := getg().m.p.ptr(); !runqempty(p) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å¯ä»¥çœ‹å‡ºæ¥ï¼Œå¹¶ä¸æ˜¯ä¸€ç›´æ— é™è‡ªæ—‹ä¸‹å»çš„ï¼Œå½“è‡ªæ—‹æ¬¡æ•°åˆ°è¾¾4æ¬¡æˆ–è€…å…¶å®ƒæ¡ä»¶ä¸ç¬¦åˆçš„æ—¶å€™ï¼Œå°±æ”¹ä¸ºä¿¡å·é‡æ‹¿é”äº†ã€‚</p><h3 id="doSpin"><a href="#doSpin" class="headerlink" title="doSpin"></a>doSpin</h3><p>ç„¶åæˆ‘ä»¬æ¥çœ‹çœ‹<code>doSpin</code>çš„å®ç°ï¼ˆå…¶å®ä¹Ÿæ²¡å•¥å¥½çœ‹çš„ï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//go:linkname sync_runtime_doSpin sync.runtime_doSpin</span></span><br><span class="line"><span class="comment">//go:nosplit</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sync_runtime_doSpin</span><span class="params">()</span></span> &#123;</span><br><span class="line">procyield(active_spin_cnt)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªæ±‡ç¼–å®ç°çš„å‡½æ•°ï¼Œç®€å•çœ‹ä¸¤çœ¼amd64ä¸Šçš„å®ç°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TEXT runtimeÂ·procyield(SB),NOSPLIT,$0-0</span><br><span class="line">MOVLcycles+0(FP), AX</span><br><span class="line">again:</span><br><span class="line">PAUSE</span><br><span class="line">SUBL$1, AX</span><br><span class="line">JNZagain</span><br><span class="line">RET</span><br></pre></td></tr></table></figure><p>çœ‹èµ·æ¥æ²¡å•¥å¥½çœ‹çš„ï¼Œç›´æ¥è·³è¿‡å§ã€‚</p><h2 id="Unlock"><a href="#Unlock" class="headerlink" title="Unlock"></a>Unlock</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹Unlockçš„å®ç°ï¼Œå¯¹äºUnlockæ¥è¯´ï¼Œæœ‰ä¸¤ä¸ªæ¯”è¾ƒå…³é”®çš„ç‰¹æ€§ï¼š</p><ol><li>å¦‚æœè¯´é”ä¸æ˜¯å¤„äºlockedçŠ¶æ€ï¼Œé‚£ä¹ˆå¯¹é”æ‰§è¡ŒUnlockä¼šå¯¼è‡´panicï¼›</li><li>é”å’Œgoroutineæ²¡æœ‰å¯¹åº”å…³ç³»ï¼Œæ‰€ä»¥æˆ‘ä»¬å®Œå…¨å¯ä»¥åœ¨goroutine 1ä¸­è·å–åˆ°é”ï¼Œç„¶ååœ¨goroutine 2ä¸­è°ƒç”¨Unlockæ¥é‡Šæ”¾é”ï¼ˆè¿™æ˜¯ä»€ä¹ˆéªšæ“ä½œï¼ï¼‰ï¼ˆè™½ç„¶ä¸æ¨èå¤§å®¶è¿™ä¹ˆå¹²â€¦â€¦ï¼‰</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Unlock</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">_ = m.state</span><br><span class="line">race.Release(unsafe.Pointer(m))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Fast path: drop lock bit.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œè·å–åˆ°é”çš„çŠ¶æ€ï¼Œç„¶åå°†çŠ¶æ€å‡å»è¢«è·å–çš„çŠ¶æ€(ä¹Ÿå°±æ˜¯è§£é”)ï¼Œç§°ä¸ºnew(æœŸæœ›)çŠ¶æ€</span></span><br><span class="line"><span class="comment">// æ³¨æ„ä»¥ä¸Šä¸¤ä¸ªæ“ä½œæ˜¯åŸå­çš„ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒå¤šä¸ªgoroutineå¹¶å‘çš„é—®é¢˜</span></span><br><span class="line"><span class="built_in">new</span> := atomic.AddInt32(&amp;m.state, -mutexLocked)</span><br><span class="line"><span class="comment">// å¦‚æœè¯´ï¼ŒæœŸæœ›çŠ¶æ€åŠ ä¸Šè¢«è·å–çš„çŠ¶æ€ï¼Œä¸æ˜¯è¢«è·å–çš„è¯</span></span><br><span class="line"><span class="comment">// é‚£ä¹ˆå°±panic</span></span><br><span class="line"><span class="comment">// åœ¨è¿™é‡Œç»™å¤§å®¶æä¸€ä¸ªé—®é¢˜ï¼šå¹²å˜›è¦è¿™ä¹ˆå¤§è´¹å‘¨ç« å…ˆå‡å»å†åŠ ä¸Šï¼Œç›´æ¥æ¯”è¾ƒä¸€ä¸‹åŸæ¥é”çš„çŠ¶æ€æ˜¯å¦è¢«è·å–ä¸å°±å®Œäº‹äº†ï¼Ÿ</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">new</span>+mutexLocked)&amp;mutexLocked == <span class="number">0</span> &#123;</span><br><span class="line">throw(<span class="string">&quot;sync: unlock of unlocked mutex&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¦‚æœè¯´newçŠ¶æ€(ä¹Ÿå°±æ˜¯é”çš„çŠ¶æ€)ä¸æ˜¯é¥¥é¥¿çŠ¶æ€</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">new</span>&amp;mutexStarving == <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// å¤åˆ¶ä¸€ä¸‹åŸå…ˆçŠ¶æ€</span></span><br><span class="line">old := <span class="built_in">new</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="comment">// å¦‚æœè¯´é”æ²¡æœ‰ç­‰å¾…æ‹¿é”çš„goroutine</span></span><br><span class="line"><span class="comment">// æˆ–è€…é”è¢«è·å–äº†(åœ¨å¾ªç¯çš„è¿‡ç¨‹ä¸­è¢«å…¶å®ƒgoroutineè·å–äº†)</span></span><br><span class="line"><span class="comment">// æˆ–è€…é”æ˜¯è¢«å”¤é†’çŠ¶æ€(è¡¨ç¤ºæœ‰goroutineè¢«å”¤é†’ï¼Œä¸éœ€è¦å†å»å°è¯•å”¤é†’å…¶å®ƒgoroutine)</span></span><br><span class="line"><span class="comment">// æˆ–è€…é”æ˜¯é¥¥é¥¿æ¨¡å¼(ä¼šç›´æ¥è½¬äº¤ç»™é˜Ÿåˆ—å¤´çš„goroutine)</span></span><br><span class="line"><span class="comment">// é‚£ä¹ˆå°±ç›´æ¥è¿”å›ï¼Œå•¥éƒ½ä¸ç”¨åšäº†</span></span><br><span class="line"><span class="keyword">if</span> old&gt;&gt;mutexWaiterShift == <span class="number">0</span> || old&amp;(mutexLocked|mutexWoken|mutexStarving) != <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// èµ°åˆ°è¿™ä¸€æ­¥çš„æ—¶å€™ï¼Œè¯´æ˜é”ç›®å‰è¿˜æ˜¯ç©ºé—²çŠ¶æ€ï¼Œå¹¶ä¸”æ²¡æœ‰goroutineè¢«å”¤é†’ä¸”é˜Ÿåˆ—ä¸­æœ‰goroutineç­‰å¾…æ‹¿é”</span></span><br><span class="line"><span class="comment">// é‚£ä¹ˆæˆ‘ä»¬å°±è¦æŠŠé”çš„çŠ¶æ€è®¾ç½®ä¸ºè¢«å”¤é†’ï¼Œç­‰å¾…é˜Ÿåˆ—-1</span></span><br><span class="line"><span class="built_in">new</span> = (old - <span class="number">1</span>&lt;&lt;mutexWaiterShift) | mutexWoken</span><br><span class="line"><span class="comment">// åˆæ˜¯ç†Ÿæ‚‰çš„CAS</span></span><br><span class="line"><span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="built_in">new</span>) &#123;</span><br><span class="line"><span class="comment">// å¦‚æœçŠ¶æ€è®¾ç½®æˆåŠŸäº†ï¼Œæˆ‘ä»¬å°±é€šè¿‡ä¿¡å·é‡å»å”¤é†’goroutine</span></span><br><span class="line">runtime_Semrelease(&amp;m.sema, <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¾ªç¯ç»“æŸçš„æ—¶å€™ï¼Œæ›´æ–°ä¸€ä¸‹çŠ¶æ€ï¼Œå› ä¸ºæœ‰å¯èƒ½åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼ŒçŠ¶æ€è¢«ä¿®æ”¹äº†(æ¯”å¦‚è¢«Lockæ”¹ä¸ºäº†é¥¥é¥¿çŠ¶æ€)</span></span><br><span class="line">old = m.state</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// å¦‚æœæ˜¯é¥¥é¥¿çŠ¶æ€ä¸‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ç›´æ¥æŠŠé”çš„æ‰€æœ‰æƒé€šè¿‡ä¿¡å·é‡ç§»äº¤ç»™é˜Ÿåˆ—å¤´çš„goroutineå°±å¥½äº†</span></span><br><span class="line"><span class="comment">// handoff = trueè¡¨ç¤ºç›´æ¥æŠŠé”äº¤ç»™é˜Ÿåˆ—å¤´éƒ¨çš„goroutine</span></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼šåœ¨è¿™ä¸ªæ—¶å€™ï¼Œé”è¢«è·å–çš„çŠ¶æ€æ²¡æœ‰è¢«è®¾ç½®ï¼Œä¼šç”±è¢«å”¤é†’çš„goroutineåœ¨å”¤é†’åè®¾ç½®</span></span><br><span class="line"><span class="comment">// ä½†æ˜¯å½“é”å¤„äºé¥¥é¥¿çŠ¶æ€çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿè®¤ä¸ºé”æ˜¯è¢«è·å–çš„(å› ä¸ºæˆ‘ä»¬æ‰‹åŠ¨æŒ‡å®šäº†è·å–çš„goroutine)</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥è¯´æ–°æ¥çš„goroutineä¸ä¼šå°è¯•å»è·å–é”(åœ¨Lockä¸­æœ‰ä½“ç°)</span></span><br><span class="line">runtime_Semrelease(&amp;m.sema, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ ¹æ®ä»¥ä¸Šä»£ç çš„åˆ†æï¼Œå¯ä»¥çœ‹å‡ºï¼Œ<code>sync.Mutex</code>è¿™æŠŠé”åœ¨ä½ çš„å·¥ä½œè´Ÿè½½ï¼ˆæ‰€éœ€æ—¶é—´ï¼‰æ¯”è¾ƒä½ï¼Œæ¯”å¦‚åªæ˜¯å¯¹æŸä¸ªå…³é”®å˜é‡èµ‹å€¼çš„æ—¶å€™ï¼Œæ€§èƒ½è¿˜æ˜¯æ¯”è¾ƒå¥½çš„ï¼Œä½†æ˜¯å¦‚æœè¯´å¯¹äºä¸´ç•Œèµ„æºçš„æ“ä½œè€—æ—¶å¾ˆé•¿ï¼ˆç‰¹åˆ«æ˜¯å•ä¸ªæ“ä½œå°±å¤§äº1msï¼‰çš„è¯ï¼Œå®é™…ä¸Šæ€§èƒ½ä¸Šä¼šæœ‰ä¸€å®šçš„é—®é¢˜ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸çœ‹åˆ°â€œçš„é”ä¸€ç›´å¤„äºé¥¥é¥¿çŠ¶æ€â€çš„é—®é¢˜ï¼Œå¯¹äºè¿™ç§æƒ…å†µï¼Œå¯èƒ½å°±éœ€è¦å¦å¯»ä»–æ³•äº†ã€‚</p><p>å¥½äº†ï¼Œè‡³æ­¤æ•´ä¸ª<code>sync.Mutex</code>çš„åˆ†æå°±æ­¤ç»“æŸäº†ï¼Œè™½ç„¶åªæœ‰çŸ­çŸ­200è¡Œä»£ç ï¼ˆåŒ…æ‹¬150è¡Œæ³¨é‡Šï¼Œå®é™…ä»£ç ä¼°è®¡å°±50è¡Œï¼‰ï¼Œä½†æ˜¯å…¶ä¸­çš„ç®—æ³•ã€è®¾è®¡çš„æ€æƒ³ã€ç¼–ç¨‹çš„ç†å¿µå´æ˜¯å€¼å¾—æ„Ÿæ‚Ÿï¼Œæ‰€è°“å¤§é“è‡³ç®€ã€å°‘å³æ˜¯å¤šå¯èƒ½å°±æ˜¯å¦‚æ­¤å§ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;goè¯­è¨€ä»¥å¹¶å‘ä½œä¸ºå…¶ç‰¹æ€§ä¹‹ä¸€ï¼Œå¹¶å‘å¿…ç„¶ä¼šå¸¦æ¥å¯¹äºèµ„æºçš„ç«äº‰ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨goæä¾›çš„&lt;code&gt;sync.Mutex&lt;/code&gt;è¿™æŠŠäº’æ–¥é”æ¥ä¿è¯ä¸´ç•Œèµ„æºçš„è®¿é—®äº’æ–¥ã€‚&lt;/p&gt;
&lt;p&gt;æ—¢ç„¶ç»å¸¸ä¼šç”¨è¿™æŠŠé”ï¼Œé‚£ä¹ˆäº†è§£ä¸€ä¸‹å…¶å†…éƒ¨å®ç°ï¼Œå°±èƒ½äº†è§£è¿™æŠŠé”é€‚ç”¨ä»€ä¹ˆåœºæ™¯ï¼Œç‰¹æ€§å¦‚ä½•äº†ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="go" scheme="https://www.purewhite.io/categories/go/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="go" scheme="https://www.purewhite.io/tags/go/"/>
    
    <category term="asm" scheme="https://www.purewhite.io/tags/asm/"/>
    
  </entry>
  
  <entry>
    <title>golangé€ƒé€¸åˆ†æ</title>
    <link href="https://www.purewhite.io/2019/03/25/golang-escape-check/"/>
    <id>https://www.purewhite.io/2019/03/25/golang-escape-check/</id>
    <published>2019-03-24T16:22:51.000Z</published>
    <updated>2021-12-02T12:51:07.225Z</updated>
    
    <content type="html"><![CDATA[<p>å¸¦GCè¯­è¨€ç»™æˆ‘ä»¬ç¨‹åºçš„ç¼–å†™å¸¦æ¥äº†æå¤§çš„ä¾¿åˆ©ï¼Œä½†æ˜¯ä¸æ­¤åŒæ—¶å±è”½äº†å¾ˆå¤šåº•å±‚çš„ç»†èŠ‚ï¼Œæ¯”å¦‚ä¸€ä¸ªå¯¹è±¡æ˜¯åœ¨æ ˆä¸Šåˆ†é…è¿˜æ˜¯åœ¨å †ä¸Šåˆ†é…ã€‚å¯¹äºæ™®é€šçš„ä»£ç æ¥è¯´è™½ç„¶ä¸éœ€è¦å…³å¿ƒè¿™ä¹ˆå¤šï¼Œä½†æ˜¯ä½œä¸ºå¼ºè¿«ç—‡ç¨‹åºçŒ¿ï¼Œè¿˜æ˜¯å¸Œæœ›èƒ½è®©è‡ªå·±å†™å‡ºæ¥çš„ä»£ç æ€§èƒ½æœ€ä¼˜ï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦äº†è§£ä»€ä¹ˆæ˜¯é€ƒé€¸ï¼Œä»¥åŠå¦‚ä½•åˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº†é€ƒé€¸ã€‚</p><span id="more"></span><h2 id="ä»€ä¹ˆæ˜¯å †å’Œæ ˆï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯å †å’Œæ ˆï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯å †å’Œæ ˆï¼Ÿ"></a>ä»€ä¹ˆæ˜¯å †å’Œæ ˆï¼Ÿ</h2><p>é¦–å…ˆéœ€è¦çŸ¥é“ï¼Œæˆ‘ä»¬è¯´çš„å †å’Œæ ˆæ˜¯å•¥ã€‚è¿™ä¸ªå¯ä¸æ˜¯æ•°æ®ç»“æ„é‡Œé¢çš„â€å †â€å’Œâ€æ ˆâ€ï¼Œè€Œæ˜¯æ“ä½œç³»ç»Ÿé‡Œé¢çš„æ¦‚å¿µã€‚</p><h3 id="æ ˆ"><a href="#æ ˆ" class="headerlink" title="æ ˆ"></a>æ ˆ</h3><p>åœ¨ç¨‹åºä¸­ï¼Œæ¯ä¸ªå‡½æ•°å—éƒ½ä¼šæœ‰è‡ªå·±çš„å†…å­˜åŒºåŸŸç”¨æ¥å­˜è‡ªå·±çš„å±€éƒ¨å˜é‡ï¼ˆå†…å­˜å ç”¨å°‘ï¼‰ã€è¿”å›åœ°å€ã€è¿”å›å€¼ä¹‹ç±»çš„æ•°æ®ï¼Œè¿™ä¸€å—å†…å­˜åŒºåŸŸæœ‰ç‰¹å®šçš„ç»“æ„å’Œå¯»å€æ–¹å¼ï¼Œå¤§å°åœ¨ç¼–è¯‘æ—¶å·²ç»ç¡®å®šï¼Œå¯»å€èµ·æ¥ä¹Ÿååˆ†è¿…é€Ÿï¼Œå¼€é”€å¾ˆå°‘ã€‚è¿™ä¸€å—å†…å­˜åœ°å€ç§°ä¸ºæ ˆã€‚æ ˆæ˜¯çº¿ç¨‹çº§åˆ«çš„ï¼Œå¤§å°åœ¨åˆ›å»ºçš„æ—¶å€™å·²ç»ç¡®å®šï¼Œæ‰€ä»¥å½“æ•°æ®å¤ªå¤§çš„æ—¶å€™ï¼Œå°±ä¼šå‘ç”Ÿâ€stack overflowâ€ã€‚</p><h3 id="å †"><a href="#å †" class="headerlink" title="å †"></a>å †</h3><p>åœ¨ç¨‹åºä¸­ï¼Œå…¨å±€å˜é‡ã€å†…å­˜å ç”¨å¤§çš„å±€éƒ¨å˜é‡ã€å‘ç”Ÿäº†é€ƒé€¸çš„å±€éƒ¨å˜é‡å­˜åœ¨çš„åœ°æ–¹å°±æ˜¯å †ï¼Œè¿™ä¸€å—å†…å­˜æ²¡æœ‰ç‰¹å®šçš„ç»“æ„ï¼Œä¹Ÿæ²¡æœ‰å›ºå®šçš„å¤§å°ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œè°ƒæ•´ã€‚ç®€å•æ¥è¯´ï¼Œæœ‰å¤§é‡æ•°æ®è¦å­˜çš„æ—¶å€™ï¼Œå°±å­˜åœ¨å †é‡Œé¢ã€‚å †æ˜¯è¿›ç¨‹çº§åˆ«çš„ã€‚å½“ä¸€ä¸ªå˜é‡éœ€è¦åˆ†é…åœ¨å †ä¸Šçš„æ—¶å€™ï¼Œå¼€é”€ä¼šæ¯”è¾ƒå¤§ï¼Œå¯¹äºgoè¿™ç§å¸¦GCçš„è¯­è¨€æ¥è¯´ï¼Œä¹Ÿä¼šå¢åŠ gcå‹åŠ›ï¼ŒåŒæ—¶ä¹Ÿå®¹æ˜“é€ æˆå†…å­˜ç¢ç‰‡ã€‚</p><h2 id="ä¸ºä»€ä¹ˆæœ‰çš„å˜é‡è¦åˆ†é…åœ¨å †ï¼Œæœ‰çš„è¦åˆ†é…åœ¨æ ˆï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆæœ‰çš„å˜é‡è¦åˆ†é…åœ¨å †ï¼Œæœ‰çš„è¦åˆ†é…åœ¨æ ˆï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆæœ‰çš„å˜é‡è¦åˆ†é…åœ¨å †ï¼Œæœ‰çš„è¦åˆ†é…åœ¨æ ˆï¼Ÿ"></a>ä¸ºä»€ä¹ˆæœ‰çš„å˜é‡è¦åˆ†é…åœ¨å †ï¼Œæœ‰çš„è¦åˆ†é…åœ¨æ ˆï¼Ÿ</h2><p>è¿™ä¸ªé—®é¢˜è¦ä»C++è¯´èµ·äº†ã€‚åœ¨C++ä¸­ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span>* <span class="title">f1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">5</span>;</span><br><span class="line">  <span class="keyword">return</span> &amp;i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> *i = <span class="built_in">f1</span>();</span><br><span class="line">  *i = <span class="number">6</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™ç¨‹åºç»“æœæ˜¯æ— æ³•é¢„æœŸçš„ï¼Œå› ä¸ºåœ¨å‡½æ•°f1ä¸­ï¼Œiæ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œä¼šåˆ†é…åœ¨æ ˆä¸Šï¼Œè€Œæ ˆåœ¨å‡½æ•°è¿”å›ä¹‹åå°±å¤±æ•ˆäº†(Plan9 æ±‡ç¼–ä¸­SPæŒ‡é’ˆè¢«ä¿®æ”¹)ï¼Œäºæ˜¯içš„åœ°å€æ‰€å­˜çš„å€¼æ˜¯ä¸å¯é¢„æœŸçš„ï¼Œåç»­åœ¨mainä¸­å¯¹è¿”å›çš„içš„åœ°å€ä¸­çš„å€¼çš„ä¿®æ”¹å¯èƒ½ä¼šä¿®æ”¹æ‰ç¨‹åºè¿è¡Œçš„æ•°æ®ï¼Œé€ æˆç»“æœæ— æ³•é¢„æœŸã€‚</p><p>æ‰€ä»¥å¯¹äºéœ€è¦è¿”å›ä¸€ä¸ªåœ°å€å›å»çš„æƒ…å†µï¼Œåœ¨C++ä¸­éœ€è¦ç”¨newæ¥åˆ†é…ä¸€å—å †ä¸Šçš„å†…å­˜æ‰è¡Œï¼Œå› ä¸ºå †æ˜¯è¿›ç¨‹çº§åˆ«çš„ï¼Œä¹Ÿå°±æ˜¯å…¨å±€çš„ï¼Œé™¤éç¨‹åºçŒ¿æ‰‹åŠ¨é‡Šæ”¾ï¼Œå¦åˆ™ä¸ä¼šè¢«å›æ”¶ï¼ˆé‡Šæ”¾ä¸å¥½ä¼šæ®µé”™è¯¯ï¼Œå¿˜äº†é‡Šæ”¾ä¼šå†…å­˜æ³„æ¼ï¼‰ï¼Œäºæ˜¯å°±å¯ä»¥ä½¿å¾—è¿™ä¸ªåœ°å€ä¸ä¼šå†è¢«ä½¿ç”¨åˆ°ï¼Œå¯ä»¥å®‰å…¨åœ°è¿”å›ã€‚</p><h2 id="å¦‚ä½•è¿›è¡Œé€ƒé€¸åˆ†æï¼Ÿ"><a href="#å¦‚ä½•è¿›è¡Œé€ƒé€¸åˆ†æï¼Ÿ" class="headerlink" title="å¦‚ä½•è¿›è¡Œé€ƒé€¸åˆ†æï¼Ÿ"></a>å¦‚ä½•è¿›è¡Œé€ƒé€¸åˆ†æï¼Ÿ</h2><p>åœ¨golangä¸­ï¼Œæ‰€æœ‰å†…å­˜éƒ½æ˜¯ç”±runtimeç®¡ç†çš„ï¼Œç¨‹åºçŒ¿ä¸éœ€è¦å…³å¿ƒå…·ä½“å˜é‡åˆ†é…åœ¨å“ªé‡Œï¼Œä»€ä¹ˆæ—¶å€™å›æ”¶ï¼Œä½†æ˜¯ç¼–è¯‘å™¨éœ€è¦çŸ¥é“è¿™ä¸€ç‚¹ï¼Œè¿™æ ·æ‰èƒ½ç¡®å®šå‡½æ•°æ ˆå¸§å¤§å°ã€å“ªäº›å˜é‡éœ€è¦â€newâ€åœ¨å †ä¸Šï¼Œæ‰€ä»¥ç¼–è¯‘å™¨éœ€è¦è¿›è¡Œ<code>é€ƒé€¸åˆ†æ</code>ã€‚ç®€å•æ¥è¯´ï¼Œ<code>é€ƒé€¸åˆ†æ</code>å†³å®šäº†ä¸€ä¸ªå˜é‡æ˜¯åˆ†é…åœ¨æ ˆä¸Šè¿˜æ˜¯åˆ†é…åœ¨å †ä¸Šã€‚</p><p>golangé€ƒé€¸åˆ†ææœ€åŸºæœ¬çš„åŸåˆ™æ˜¯ï¼š<code>å¦‚æœä¸€ä¸ªå‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªï¼ˆå±€éƒ¨ï¼‰å˜é‡çš„åœ°å€ï¼Œé‚£ä¹ˆè¿™ä¸ªå˜é‡å°±å‘ç”Ÿé€ƒé€¸</code>ã€‚</p><p>åœ¨golangé‡Œé¢ï¼Œå˜é‡åˆ†é…åœ¨ä½•å¤„å’Œæ˜¯å¦ä½¿ç”¨newæ— å…³ï¼Œæ„å‘³ç€ç¨‹åºçŒ¿æ— æ³•æ‰‹åŠ¨æŒ‡å®šæŸä¸ªå˜é‡å¿…é¡»åˆ†é…åœ¨æ ˆä¸Šæˆ–è€…å †ä¸Š(è‡ªå·±æ’¸asmçš„å½“æˆ‘æ²¡è¯´)ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é€šè¿‡ä¸€äº›æ–¹æ³•æ¥ç¡®å®šæŸä¸ªå˜é‡åˆ°åº•æ˜¯åˆ†é…åœ¨äº†æ ˆä¸Šè¿˜æ˜¯å †ä¸Šã€‚</p><p>æˆ‘ä»¬ç”¨ä»¥ä¸‹ä»£ç ä½œä¸ºä¾‹å­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := f1()</span><br><span class="line">*a++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:noinline</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f1</span><span class="params">()</span> *<span class="title">int</span></span> &#123;</span><br><span class="line">i := <span class="number">1</span></span><br><span class="line"><span class="keyword">return</span> &amp;i</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä»¥ä¸Šä»£ç ä¸­ï¼Œç»™f1å¢åŠ äº†noinlineæ ‡è®°ï¼Œè®©goç¼–è¯‘å™¨ä¸è¦å°†å‡½æ•°å†…è”ã€‚</p><h3 id="ä½¿ç”¨ç¼–è¯‘å‚æ•°"><a href="#ä½¿ç”¨ç¼–è¯‘å‚æ•°" class="headerlink" title="ä½¿ç”¨ç¼–è¯‘å‚æ•°"></a>ä½¿ç”¨ç¼–è¯‘å‚æ•°</h3><p>golangæä¾›äº†ç¼–è¯‘çš„å‚æ•°è®©æˆ‘ä»¬å¯ä»¥ç›´è§‚åœ°çœ‹åˆ°å˜é‡æ˜¯å¦å‘ç”Ÿäº†é€ƒé€¸ï¼Œåªéœ€è¦åœ¨go buildæ—¶æŒ‡å®š <code>-gcflags &#39;-m&#39;</code>å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> go build -gcflags <span class="string">&#x27;-m&#x27;</span> escape.go</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> command-line-arguments</span></span><br><span class="line">./escape.go:3:6: can inline main</span><br><span class="line">./escape.go:11:9: &amp;i escapes to heap</span><br><span class="line">./escape.go:10:2: moved to heap: i</span><br></pre></td></tr></table></figure><p>è¿™æ ·å¯ä»¥å¾ˆç›´è§‚åœ°çœ‹åˆ°åœ¨ç¬¬10ã€11è¡Œï¼Œiå‘ç”Ÿäº†é€ƒé€¸ï¼Œå†…å­˜ä¼šåˆ†é…åœ¨å †ä¸Šã€‚</p><p>é™¤äº†ä½¿ç”¨ç¼–è¯‘å‚æ•°ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ä¸€ç§æ›´åº•å±‚çš„ï¼Œæ›´ç¡¬æ ¸ï¼Œä¹Ÿæ›´å‡†ç¡®çš„æ–¹å¼æ¥åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦é€ƒé€¸ï¼Œé‚£å°±æ˜¯ï¼šç›´æ¥çœ‹æ±‡ç¼–ï¼</p><h3 id="ä½¿ç”¨æ±‡ç¼–"><a href="#ä½¿ç”¨æ±‡ç¼–" class="headerlink" title="ä½¿ç”¨æ±‡ç¼–"></a>ä½¿ç”¨æ±‡ç¼–</h3><p>æˆ‘ä»¬ä½¿ç”¨<code>go tool compile -S</code>ç”Ÿæˆæ±‡ç¼–ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ go tool compile -S escape.go | grep escape.go:10</span><br><span class="line">0x001d 00029 (escape.go:10)PCDATA$2, $1</span><br><span class="line">0x001d 00029 (escape.go:10)PCDATA$0, $0</span><br><span class="line">0x001d 00029 (escape.go:10)LEAQtype.int(SB), AX</span><br><span class="line">0x0024 00036 (escape.go:10)PCDATA$2, $0</span><br><span class="line">0x0024 00036 (escape.go:10)MOVQAX, (SP)</span><br><span class="line">0x0028 00040 (escape.go:10)CALLruntime.newobject(SB)</span><br><span class="line">0x002d 00045 (escape.go:10)PCDATA$2, $1</span><br><span class="line">0x002d 00045 (escape.go:10)MOVQ8(SP), AX</span><br><span class="line">0x0032 00050 (escape.go:10)MOVQ$1, (AX)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œçš„00040æœ‰è°ƒç”¨<code>runtime.newobject(SB)</code>è¿™ä¸ªæ–¹æ³•ï¼Œçœ‹åˆ°è¿™ä¸ªæ–¹æ³•å¤§å®¶å°±åº”è¯¥æ‡‚äº†ï¼</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä»¥ä¸Šæä¾›äº†ä¸¤ç§æ–¹æ³•å¯ä»¥ç”¨æ¥åˆ¤æ–­æŸä¸ªå˜é‡æ˜¯å¦å‘ç”Ÿäº†é€ƒé€¸ï¼Œå…¶ä¸­ä½¿ç”¨ç¼–è¯‘å‚æ•°æ¯”è¾ƒç®€å•ï¼Œä½¿ç”¨æ±‡ç¼–æ¯”è¾ƒç¡¬æ ¸ã€‚é€šè¿‡è¿™ä¸¤ç§æ–¹æ³•åˆ†æå®Œé€ƒé€¸ï¼Œå°±èƒ½è¿›ä¸€æ­¥ä¼˜åŒ–å †ä¸Šå†…å­˜æ•°é‡ï¼Œå‡è½»GCå‹åŠ›äº†ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¸¦GCè¯­è¨€ç»™æˆ‘ä»¬ç¨‹åºçš„ç¼–å†™å¸¦æ¥äº†æå¤§çš„ä¾¿åˆ©ï¼Œä½†æ˜¯ä¸æ­¤åŒæ—¶å±è”½äº†å¾ˆå¤šåº•å±‚çš„ç»†èŠ‚ï¼Œæ¯”å¦‚ä¸€ä¸ªå¯¹è±¡æ˜¯åœ¨æ ˆä¸Šåˆ†é…è¿˜æ˜¯åœ¨å †ä¸Šåˆ†é…ã€‚å¯¹äºæ™®é€šçš„ä»£ç æ¥è¯´è™½ç„¶ä¸éœ€è¦å…³å¿ƒè¿™ä¹ˆå¤šï¼Œä½†æ˜¯ä½œä¸ºå¼ºè¿«ç—‡ç¨‹åºçŒ¿ï¼Œè¿˜æ˜¯å¸Œæœ›èƒ½è®©è‡ªå·±å†™å‡ºæ¥çš„ä»£ç æ€§èƒ½æœ€ä¼˜ï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦äº†è§£ä»€ä¹ˆæ˜¯é€ƒé€¸ï¼Œä»¥åŠå¦‚ä½•åˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº†é€ƒé€¸ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="go" scheme="https://www.purewhite.io/categories/go/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="go" scheme="https://www.purewhite.io/tags/go/"/>
    
    <category term="asm" scheme="https://www.purewhite.io/tags/asm/"/>
    
  </entry>
  
  <entry>
    <title>ç®—æ³•è¯¦è§£ï¼šæœ€é•¿ä¸Šå‡å­åºåˆ—</title>
    <link href="https://www.purewhite.io/2018/07/25/lis/"/>
    <id>https://www.purewhite.io/2018/07/25/lis/</id>
    <published>2018-07-24T16:46:52.000Z</published>
    <updated>2021-12-02T12:51:07.228Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é¢˜ç›®æè¿°"><a href="#é¢˜ç›®æè¿°" class="headerlink" title="é¢˜ç›®æè¿°"></a>é¢˜ç›®æè¿°</h1><p>ç»™å®šä¸€ä¸ªé•¿åº¦ä¸ºnçš„æ•°åˆ—<code>a0, a1, a2...an-1</code>ï¼Œæ±‚å‡ºè¿™ä¸ªåºåˆ—ä¸­çš„æœ€é•¿çš„ä¸Šå‡å­åºåˆ—çš„é•¿åº¦ï¼Œä¸Šå‡å­åºåˆ—çš„å®šä¹‰ä¸ºï¼šå¯¹äºä»»æ„çš„<code>i&lt;j</code>ï¼Œéƒ½æ»¡è¶³<code>ai&lt;aj</code>ã€‚</p><span id="more"></span><p><strong>é™åˆ¶æ¡ä»¶ï¼š</strong>1â‰¤nâ‰¤1000ï¼Œ0â‰¤aâ‰¤1000000</p><p><strong>æ ·ä¾‹ï¼š</strong></p><p>è¾“å…¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">n = 5</span><br><span class="line">a = &#123;4, 2, 3, 1, 5&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">3</span>ï¼ˆa<span class="number">1</span>, a<span class="number">2</span>, a<span class="number">4</span>æ„æˆçš„å­åºåˆ—<span class="number">2</span>ï¼Œ<span class="number">3</span>ï¼Œ<span class="number">5</span>æœ€é•¿ï¼‰</span><br></pre></td></tr></table></figure><h1 id="é¢˜è§£"><a href="#é¢˜è§£" class="headerlink" title="é¢˜è§£"></a>é¢˜è§£</h1><p>è¿™ä¸ªé—®é¢˜å°±æ˜¯è‘—åçš„æœ€é•¿ä¸Šå‡å­åºåˆ—ï¼ˆLISï¼ŒLongest  Increasing Subsequenceï¼‰é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜æœ‰ä¸¤ç§è§£æ³•ï¼Œç¬¬ä¸€ç§è§£æ³•æ˜¯O(nÂ²)çš„DPè§£æ³•ï¼Œç¬¬äºŒç§è§£æ³•æ˜¯O(nlogn)çš„DPåŠ äºŒåˆ†è§£æ³•ã€‚</p><h2 id="O-nÂ²-ç®—æ³•"><a href="#O-nÂ²-ç®—æ³•" class="headerlink" title="O(nÂ²)ç®—æ³•"></a>O(nÂ²)ç®—æ³•</h2><p>é¦–å…ˆæˆ‘ä»¬å¯ä»¥æ¥å»ºç«‹ä¸€ä¸‹DPçš„é€’æ¨å…³ç³»ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å®šä¹‰dp<span class="selector-attr">[i]</span>:=ä»¥aiä¸ºæœ«å°¾çš„æœ€é•¿ä¸Šå‡å­åºåˆ—çš„é•¿åº¦</span><br></pre></td></tr></table></figure><p>ä»¥aiç»“å°¾çš„ä¸Šå‡å­åºåˆ—æ˜¯ï¼š</p><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">åªåŒ…å«aiçš„å­åºåˆ—</span><br><span class="line">åœ¨æ»¡è¶³j&lt;iå¹¶ä¸”<span class="built_in">aj</span>&lt;aiçš„ä»¥<span class="built_in">aj</span>ä¸ºç»“å°¾çš„ä¸Šå‡å­åˆ—æœ«å°¾ï¼Œè¿½åŠ ä¸Šaiåå¾—åˆ°çš„å­åºåˆ—</span><br></pre></td></tr></table></figure><p>è¿™äºŒè€…ä¹‹ä¸€ã€‚è¿™æ ·å°±èƒ½å¾—åˆ°å¦‚ä¸‹çš„é€’æ¨å…³ç³»ï¼š</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dp</span>[i]=<span class="built_in">max</span>&#123;<span class="number">1</span>, <span class="keyword">dp</span>[<span class="keyword">j</span>]+<span class="number">1</span>|<span class="keyword">j</span>&lt;iä¸”aj&lt;ai&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¿™ä¸ªé€’æ¨å…¬å¼å¯ä»¥åœ¨O(nÂ²)æ—¶é—´å†…è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¾“å…¥</span></span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line"><span class="keyword">int</span> a[MAX_N];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> dp[MAX_N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">solve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        dp[i] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; i; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (a[j] &lt; a[i]) &#123;</span><br><span class="line">                dp[i] = <span class="built_in">max</span>(dp[i], dp[j] + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        res = <span class="built_in">max</span>(res, dp[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, res);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯æ—¶é—´å¤æ‚åº¦ä¹Ÿæ¯”è¾ƒé«˜ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ›´ä¼˜çš„è§£æ³•ã€‚</p><h2 id="O-nlogn"><a href="#O-nlogn" class="headerlink" title="O(nlogn)"></a>O(nlogn)</h2><p>ä¹‹å‰æˆ‘ä»¬çš„æ€è·¯æ˜¯æ±‚å‡ºä»¥ç¬¬iä¸ªå…ƒç´ ä¸ºç»“å°¾çš„æœ€é•¿ä¸Šå‡å­åºåˆ—é•¿åº¦ï¼Œæˆ‘ä»¬å¯ä»¥æ¢ä¸ªæ€è·¯ï¼Œè€ƒè™‘ä¸€ä¸‹<code>dp[i]</code>ä¸º<code>æœ€é•¿ä¸Šå‡å­åºåˆ—é•¿åº¦ä¸ºiæƒ…å†µä¸‹æœ€å°çš„å…ƒç´ </code>ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡äºŒåˆ†æ¥è¿›è¡Œä¼˜åŒ–ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> dp[MAX_N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">solve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">fill</span>(dp, dp+n, INF);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        *<span class="built_in">lower_bound</span>(dp, dp + n, a[i]) = a[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, <span class="built_in">lower_bound</span>(dp, dp + n, INF) - dp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;é¢˜ç›®æè¿°&quot;&gt;&lt;a href=&quot;#é¢˜ç›®æè¿°&quot; class=&quot;headerlink&quot; title=&quot;é¢˜ç›®æè¿°&quot;&gt;&lt;/a&gt;é¢˜ç›®æè¿°&lt;/h1&gt;&lt;p&gt;ç»™å®šä¸€ä¸ªé•¿åº¦ä¸ºnçš„æ•°åˆ—&lt;code&gt;a0, a1, a2...an-1&lt;/code&gt;ï¼Œæ±‚å‡ºè¿™ä¸ªåºåˆ—ä¸­çš„æœ€é•¿çš„ä¸Šå‡å­åºåˆ—çš„é•¿åº¦ï¼Œä¸Šå‡å­åºåˆ—çš„å®šä¹‰ä¸ºï¼šå¯¹äºä»»æ„çš„&lt;code&gt;i&amp;lt;j&lt;/code&gt;ï¼Œéƒ½æ»¡è¶³&lt;code&gt;ai&amp;lt;aj&lt;/code&gt;ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://www.purewhite.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://www.purewhite.io/tags/%E7%AE%97%E6%B3%95/"/>
    
    <category term="æ•°æ®ç»“æ„" scheme="https://www.purewhite.io/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>LintCode 428. xçš„næ¬¡å¹‚</title>
    <link href="https://www.purewhite.io/2018/07/11/lintcode-powx-n/"/>
    <id>https://www.purewhite.io/2018/07/11/lintcode-powx-n/</id>
    <published>2018-07-11T08:43:16.000Z</published>
    <updated>2021-12-02T12:51:07.228Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é¢˜æ„"><a href="#é¢˜æ„" class="headerlink" title="é¢˜æ„"></a>é¢˜æ„</h1><p>å®ç° pow(x,n)</p><h5 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h5><p>ä¸ç”¨æ‹…å¿ƒç²¾åº¦ï¼Œå½“ç­”æ¡ˆå’Œæ ‡å‡†è¾“å‡ºå·®ç»å¯¹å€¼å°äº<code>1e-3</code>æ—¶éƒ½ç®—æ­£ç¡®</p><span id="more"></span><h1 id="æ ·ä¾‹"><a href="#æ ·ä¾‹" class="headerlink" title="æ ·ä¾‹"></a>æ ·ä¾‹</h1><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Pow</span>(<span class="number">2</span>.<span class="number">1</span>, <span class="number">3</span>) = <span class="number">9</span>.<span class="number">261</span></span><br><span class="line"><span class="attribute">Pow</span>(<span class="number">0</span>, <span class="number">1</span>) = <span class="number">0</span></span><br><span class="line"><span class="attribute">Pow</span>(<span class="number">1</span>, <span class="number">0</span>) = <span class="number">1</span></span><br></pre></td></tr></table></figure><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><p>ä»æ•°å­¦ä¸Šæ¥è¯´ï¼Œ<code>(x)çš„4æ¬¡æ–¹</code> ç­‰äº <code>(xçš„å¹³æ–¹)çš„å¹³æ–¹</code>ã€‚æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªæ€æƒ³æ¥åšè¿™é“é¢˜å°±è¡Œäº†ã€‚</p><p>å…¶å®å°±å’ŒæŠŠåè¿›åˆ¶æ•°è½¬æˆäºŒè¿›åˆ¶çš„æ€æƒ³æ˜¯ä¸€æ ·çš„ã€‚</p><p>éœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œnå¯èƒ½ä¸ºè´Ÿæ•°ã€‚</p><h1 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    @param: x: the base number</span></span><br><span class="line"><span class="string">    @param: n: the power number</span></span><br><span class="line"><span class="string">    @return: the result</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">myPow</span>(<span class="params">self, x, n</span>):</span></span><br><span class="line">        <span class="keyword">if</span> n == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> x == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        t = x</span><br><span class="line">        <span class="keyword">if</span> n &lt; <span class="number">0</span>:</span><br><span class="line">            t = <span class="number">1</span> / t</span><br><span class="line">            n = -n</span><br><span class="line">        ans = <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> n != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> n % <span class="number">2</span> != <span class="number">0</span>:</span><br><span class="line">                ans *= t</span><br><span class="line">            t *= t</span><br><span class="line">            n = <span class="built_in">int</span>(n / <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">return</span> ans</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;é¢˜æ„&quot;&gt;&lt;a href=&quot;#é¢˜æ„&quot; class=&quot;headerlink&quot; title=&quot;é¢˜æ„&quot;&gt;&lt;/a&gt;é¢˜æ„&lt;/h1&gt;&lt;p&gt;å®ç° pow(x,n)&lt;/p&gt;
&lt;h5 id=&quot;æ³¨æ„äº‹é¡¹&quot;&gt;&lt;a href=&quot;#æ³¨æ„äº‹é¡¹&quot; class=&quot;headerlink&quot; title=&quot;æ³¨æ„äº‹é¡¹&quot;&gt;&lt;/a&gt;æ³¨æ„äº‹é¡¹&lt;/h5&gt;&lt;p&gt;ä¸ç”¨æ‹…å¿ƒç²¾åº¦ï¼Œå½“ç­”æ¡ˆå’Œæ ‡å‡†è¾“å‡ºå·®ç»å¯¹å€¼å°äº&lt;code&gt;1e-3&lt;/code&gt;æ—¶éƒ½ç®—æ­£ç¡®&lt;/p&gt;</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://www.purewhite.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://www.purewhite.io/tags/%E7%AE%97%E6%B3%95/"/>
    
    <category term="LintCode" scheme="https://www.purewhite.io/tags/LintCode/"/>
    
    <category term="æ•°æ®ç»“æ„" scheme="https://www.purewhite.io/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>LintCode 460.åœ¨æ’åºæ•°ç»„ä¸­æ‰¾æœ€æ¥è¿‘çš„Kä¸ªæ•°</title>
    <link href="https://www.purewhite.io/2018/07/11/lintcode-find-k-closest-elements/"/>
    <id>https://www.purewhite.io/2018/07/11/lintcode-find-k-closest-elements/</id>
    <published>2018-07-11T08:15:34.000Z</published>
    <updated>2021-12-02T12:51:07.228Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é¢˜æ„"><a href="#é¢˜æ„" class="headerlink" title="é¢˜æ„"></a>é¢˜æ„</h1><p>ç»™ä¸€ä¸ªç›®æ ‡æ•° target, ä¸€ä¸ªéè´Ÿæ•´æ•°Â <code>k</code>, ä¸€ä¸ªæŒ‰ç…§å‡åºæ’åˆ—çš„æ•°ç»„ Aã€‚åœ¨Aä¸­æ‰¾ä¸targetæœ€æ¥è¿‘çš„kä¸ªæ•´æ•°ã€‚è¿”å›è¿™kä¸ªæ•°å¹¶æŒ‰ç…§ä¸targetçš„æ¥è¿‘ç¨‹åº¦ä»å°åˆ°å¤§æ’åºï¼Œå¦‚æœæ¥è¿‘ç¨‹åº¦ç›¸å½“ï¼Œé‚£ä¹ˆå°çš„æ•°æ’åœ¨å‰é¢ã€‚</p><h5 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h5><p>The value k is a non-negative integer and will always be smaller than the length of the sorted array.</p><p>Length of the given array is positive and will not exceed 10^4</p><p>Absolute value of elements in the array and x will not exceed 10^4</p><span id="more"></span><h1 id="æ ·ä¾‹"><a href="#æ ·ä¾‹" class="headerlink" title="æ ·ä¾‹"></a>æ ·ä¾‹</h1><p>å¦‚æœ A = <code>[1, 2, 3]</code>, target = <code>2</code> and k = <code>3</code>, é‚£ä¹ˆè¿”å› <code>[2, 1, 3]</code>.</p><p>å¦‚æœ A = <code>[1, 4, 6, 8]</code>, target = <code>3</code> and k = <code>3</code>, é‚£ä¹ˆè¿”å› <code>[4, 1, 6]</code>.</p><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><p>è¿™é“é¢˜çš„ä¸€èˆ¬è§£æ³•éƒ½å¾ˆå®¹æ˜“æƒ³å‡ºæ¥ï¼Œæš´åŠ›å‡ºå¥‡è¿¹å˜›ï¼Œè¿™é‡Œæˆ‘ä»¬åªè¯´æœ€ä¼˜è§£ï¼Œä¹Ÿå°±æ˜¯ O(logn + k) çš„æ—¶é—´å¤æ‚åº¦ çš„è§£æ³•ã€‚</p><p>è¿™é“é¢˜çš„è§£é¢˜å…³é”®æ˜¯æ•°ç»„Aæ˜¯æœ‰åºçš„ï¼Œåªè¦æœ‰åºå°±å¯ä»¥è€ƒè™‘ç”¨äºŒåˆ†ã€‚</p><p>æˆ‘ä»¬é€šè¿‡å¯¹Aè¿›è¡ŒäºŒåˆ†ï¼Œæ‰¾åˆ°æœ€æ¥è¿‘targetçš„æ•°ï¼Œæ‰¾åˆ°ä¹‹åç”¨åŒæŒ‡é’ˆçš„æ€æƒ³ï¼Œä¾æ¬¡ä»æ‰¾åˆ°çš„é‚£ä¸ªæ•°å‘ä¸¤è¾¹æ‰©æ•£ï¼Œç›´åˆ°æ»¡è¶³kä¸ªæ•°ä¸ºæ­¢ã€‚</p><p>æ€è·¯è¾ƒä¸ºç®€å•ï¼Œç¼–ç è¿‡ç¨‹æ³¨æ„ä¸€äº›è¾¹ç•Œæ¡ä»¶çš„åˆ¤æ–­å³å¯ã€‚</p><h1 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    @param A: an integer array</span></span><br><span class="line"><span class="string">    @param target: An integer</span></span><br><span class="line"><span class="string">    @param k: An integer</span></span><br><span class="line"><span class="string">    @return: an integer array</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">kClosestNumbers</span>(<span class="params">self, A, target, k</span>):</span></span><br><span class="line">        <span class="keyword">if</span> k == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> A:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        lp = <span class="literal">None</span></span><br><span class="line">        rp = <span class="literal">None</span></span><br><span class="line">        start = <span class="number">0</span></span><br><span class="line">        end = <span class="built_in">len</span>(A) - <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> start + <span class="number">1</span> &lt; end:</span><br><span class="line">            mid = <span class="built_in">int</span>(start + (end - start) / <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">if</span> A[mid] == target:</span><br><span class="line">                start = mid</span><br><span class="line">                end = mid + <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">elif</span> A[mid] &lt; target:</span><br><span class="line">                start = mid</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                end = mid</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">abs</span>(A[start] - target) &lt;= <span class="built_in">abs</span>(A[start] - target):</span><br><span class="line">            lp = start</span><br><span class="line">            rp = end</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            lp = end</span><br><span class="line">            rp = end + <span class="number">1</span></span><br><span class="line">        cnt = <span class="number">0</span></span><br><span class="line">        ans = <span class="built_in">list</span>()</span><br><span class="line">        <span class="keyword">while</span> cnt &lt; k:</span><br><span class="line">            cnt += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> lp &lt; <span class="number">0</span> <span class="keyword">and</span> rp &gt;= <span class="built_in">len</span>(A):</span><br><span class="line">                <span class="keyword">return</span> []</span><br><span class="line">            <span class="keyword">elif</span> lp &lt; <span class="number">0</span>:</span><br><span class="line">                ans.append(A[rp])</span><br><span class="line">                rp += <span class="number">1</span></span><br><span class="line">            <span class="keyword">elif</span> rp &gt;= <span class="built_in">len</span>(A):</span><br><span class="line">                ans.append(A[lp])</span><br><span class="line">                lp -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">abs</span>(A[lp] - target) &lt;= <span class="built_in">abs</span>(A[rp] - target):</span><br><span class="line">                ans.append(A[lp])</span><br><span class="line">                lp -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                ans.append(A[rp])</span><br><span class="line">                rp += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> ans</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;é¢˜æ„&quot;&gt;&lt;a href=&quot;#é¢˜æ„&quot; class=&quot;headerlink&quot; title=&quot;é¢˜æ„&quot;&gt;&lt;/a&gt;é¢˜æ„&lt;/h1&gt;&lt;p&gt;ç»™ä¸€ä¸ªç›®æ ‡æ•° target, ä¸€ä¸ªéè´Ÿæ•´æ•°Â &lt;code&gt;k&lt;/code&gt;, ä¸€ä¸ªæŒ‰ç…§å‡åºæ’åˆ—çš„æ•°ç»„ Aã€‚åœ¨Aä¸­æ‰¾ä¸targetæœ€æ¥è¿‘çš„kä¸ªæ•´æ•°ã€‚è¿”å›è¿™kä¸ªæ•°å¹¶æŒ‰ç…§ä¸targetçš„æ¥è¿‘ç¨‹åº¦ä»å°åˆ°å¤§æ’åºï¼Œå¦‚æœæ¥è¿‘ç¨‹åº¦ç›¸å½“ï¼Œé‚£ä¹ˆå°çš„æ•°æ’åœ¨å‰é¢ã€‚&lt;/p&gt;
&lt;h5 id=&quot;æ³¨æ„äº‹é¡¹&quot;&gt;&lt;a href=&quot;#æ³¨æ„äº‹é¡¹&quot; class=&quot;headerlink&quot; title=&quot;æ³¨æ„äº‹é¡¹&quot;&gt;&lt;/a&gt;æ³¨æ„äº‹é¡¹&lt;/h5&gt;&lt;p&gt;The value k is a non-negative integer and will always be smaller than the length of the sorted array.&lt;/p&gt;
&lt;p&gt;Length of the given array is positive and will not exceed 10^4&lt;/p&gt;
&lt;p&gt;Absolute value of elements in the array and x will not exceed 10^4&lt;/p&gt;</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://www.purewhite.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://www.purewhite.io/tags/%E7%AE%97%E6%B3%95/"/>
    
    <category term="LintCode" scheme="https://www.purewhite.io/tags/LintCode/"/>
    
    <category term="æ•°æ®ç»“æ„" scheme="https://www.purewhite.io/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>Service Mesh Istio åˆæ¢</title>
    <link href="https://www.purewhite.io/2018/06/27/service-mesh-0/"/>
    <id>https://www.purewhite.io/2018/06/27/service-mesh-0/</id>
    <published>2018-06-27T03:41:13.000Z</published>
    <updated>2021-12-02T12:51:07.230Z</updated>
    
    <content type="html"><![CDATA[<p>æ—©åœ¨å»å¹´ï¼ŒService Meshè¿™ä¸ªæ¦‚å¿µå°±å¼€å§‹ç«èµ·æ¥äº†ï¼Œä»Šå¹´çš„æ—¶å€™Service Meshæ›´æ˜¯çˆ†å‘å¼åœ°å‘å±•ï¼ŒService Meshä¸­çš„æ˜æ˜Ÿé¡¹ç›®Istioæ›´æ˜¯åªç”¨äº†å‡ ä¸ªæœˆçš„æ—¶é—´å°±å·²ç»ä»0.1åˆ°äº†0.8 LTSäº†ã€‚ç”±äºå·¥ä½œå’Œæ¯•ä¸šçš„å‹åŠ›ï¼Œä¹‹å‰ä¸€ç›´æ²¡æœ‰æ—¶é—´æ·±å…¥ç ”ç©¶Service Meshã€‚ç°åœ¨ç¨å¾®æœ‰äº›æ—¶é—´äº†ï¼Œæ‰€ä»¥æ‰“ç®—å†™ç‚¹ä»€ä¹ˆå…³äºService Meshçš„ã€‚</p><span id="more"></span><h1 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h1><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯Service Meshã€‚ä»Šå¤©æˆ‘ä»¬çš„ä¸»è§’æ˜¯Istioï¼ŒIstioçš„èƒŒæ™¯æˆ‘ä¸è¿‡å¤šä»‹ç»ï¼ŒGå®¶ç­‰å¤§å‚æå‡ºæ¥å¹¶ä¸”åœ¨åé¢æ¨åŠ¨æ”¯æŒçš„è‚¯å®šä¸ä¼šå¼±ã€‚</p><p>æ ¹æ®Istioçš„å®˜æ–¹æ–‡æ¡£ï¼Œæ˜¯è¿™ä¹ˆå®šä¹‰è‡ªå·±çš„ï¼šä¸€ä¸ªç”¨æ¥è¿æ¥ã€ç®¡ç†å’ŒåŠ å¯†å¾®æœåŠ¡ï¼ˆæµé‡ï¼‰çš„å¼€æ”¾å¹³å°ã€‚</p><blockquote><p>an open platform to connect, manage, and secure microservices</p></blockquote><p>Istioå¯ä»¥è®©ä½ åœ¨ä¸ä¿®æ”¹å¾®æœåŠ¡æºä»£ç çš„æƒ…å†µä¹‹ä¸‹ï¼Œå¾ˆè½»æ¾åœ°ç»™å¾®æœåŠ¡åŠ ä¸Šè¯¸å¦‚è´Ÿè½½å‡è¡¡ã€èº«ä»½éªŒè¯ã€ç›‘æ§ç­‰ç­‰çš„åŠŸèƒ½ã€‚Istioé€šè¿‡åœ¨ä½ çš„å¾®æœåŠ¡ä¸­éƒ¨ç½²ä¸€ä¸ªsidecarä½œä¸ºæ‰€æœ‰æµé‡çš„ä»£ç†æ¥è¾¾æˆè¿™ä¸ªç›®æ ‡ã€‚</p><p>æ€»ç»“ä¸‹æ¥ï¼ŒIstioæä¾›äº†ä»¥ä¸‹åŠŸèƒ½ï¼š</p><ul><li>æµé‡ç®¡ç†ï¼ˆTraffic Managementï¼‰</li><li>æœåŠ¡çš„èº«ä»½è®¤è¯å’Œå®‰å…¨ï¼ˆService Identity and Securityï¼‰</li><li>ç­–ç•¥é…ç½®ï¼ˆPolicy Enforcementï¼‰</li><li>é¥æ„Ÿï¼ˆTelemetryï¼‰</li></ul><p>é™¤äº†è¿™äº›ä¹‹å¤–ï¼ŒIstioè¿˜æ”¯æŒå¾ˆå¤šä¸åŒçš„å¹³å°ï¼ˆå°¤å…¶æ˜¯Kubernetesï¼‰ï¼Œå¹¶ä¸”æ”¯æŒè‡ªå®šä¹‰çš„ç»„ä»¶å’Œé›†æˆã€‚</p><p>é€šè¿‡è¿™äº›åŠŸèƒ½ï¼Œå¾®æœåŠ¡çš„å¼€å‘å’Œè¿ç§»ä¼šå˜å¾—éå¸¸å®¹æ˜“ï¼Œè€Œè¿ç»´äººå‘˜ä¹Ÿå¯ä»¥æ›´æ–¹ä¾¿çš„æ›´æ”¹éƒ¨ç½²çš„ç­–ç•¥ã€‚</p><h1 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h1><p>Istioæ˜¯ä¸¤å±‚æ¶æ„çš„ï¼Œåˆ†åˆ«æ˜¯<strong>æ•°æ®å±‚</strong>å’Œ<strong>æ§åˆ¶å±‚</strong>ï¼š</p><ul><li>æ•°æ®å±‚æ˜¯ç”±æ‰€æœ‰çš„éƒ¨ç½²ä¸ºsidecarçš„Envoyæ‰€ç»„æˆçš„ã€‚</li><li>æ§åˆ¶å±‚æœ‰ä¸‰ä¸ªç»„ä»¶ï¼šPilotã€Mixerå’ŒCitadelï¼Œé¡¾åæ€ä¹‰æ˜¯ç”¨æ¥æ§åˆ¶Service Meshçš„è¡Œä¸ºçš„ã€‚</li></ul><p>æ€»ä½“çš„æ¶æ„å¦‚ä¸‹å›¾ï¼š</p><p><img data-src="https://istio.io/docs/concepts/what-is-istio/img/overview/arch.svg" alt="Istio Architecture"></p><h2 id="Envoy"><a href="#Envoy" class="headerlink" title="Envoy"></a>Envoy</h2><p>Istioç”¨äº†ä¸€ä¸ªæ‰©å±•ç‰ˆæœ¬çš„Envoyä½œä¸ºåº•å±‚çš„ä»£ç†ã€‚Envoyæ˜¯ä¸€ä¸ªç”¨C++å¼€å‘çš„é«˜æ€§èƒ½çš„ä»£ç†ï¼Œå…·æœ‰éå¸¸å¤šåŠŸèƒ½ï¼Œå…·ä½“çš„å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œåœ¨æ­¤ä¸åšèµ˜è¿°ã€‚</p><p>Envoyåœ¨Istioä¸­æ˜¯ä»¥sidecaræ¨¡å¼éƒ¨ç½²åœ¨podé‡Œé¢çš„ï¼ŒIstioé€šè¿‡æ§åˆ¶Envoyæ¥æ§åˆ¶æ‰€æœ‰çš„æµé‡ï¼Œè·å–ç›‘æ§æ•°æ®ç­‰ã€‚</p><h2 id="Mixer"><a href="#Mixer" class="headerlink" title="Mixer"></a>Mixer</h2><p>Mixeræ˜¯ä¸€ä¸ªå¹³å°æ— å…³çš„ç»„ä»¶ï¼Œç”¨æ¥æ§åˆ¶è®¿é—®ç­–ç•¥å’Œä½¿ç”¨ç­–ç•¥ï¼ŒåŒæ—¶ä¼šæ”¶é›†ç›‘æ§ä¿¡æ¯ï¼Œå°†æ”¶é›†åˆ°çš„ä¿¡æ¯ä¼ ç»™ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰çš„åç«¯è¿›è¡Œå¤„ç†ã€‚</p><h2 id="Pilot"><a href="#Pilot" class="headerlink" title="Pilot"></a>Pilot</h2><p>Pilotä¸ºEnvoyæä¾›æœåŠ¡å‘ç°ã€æ™ºèƒ½è·¯ç”±ï¼ˆå¦‚ABæµ‹è¯•ã€é‡‘ä¸é›€éƒ¨ç½²ï¼‰å’Œå¼¹æ€§æµé‡ç®¡ç†åŠŸèƒ½ï¼ˆå¦‚è¶…æ—¶ã€é‡è¯•ã€ç†”æ–­ï¼‰ã€‚å®ƒè´Ÿè´£å°†é«˜å±‚çš„æŠ½è±¡çš„è·¯ç”±è§„åˆ™è½¬åŒ–æˆä½çº§çš„envoyçš„é…ç½®ã€‚</p><h2 id="Citadel"><a href="#Citadel" class="headerlink" title="Citadel"></a>Citadel</h2><p>Citadelæä¾›äº†æœåŠ¡é—´å’ŒæœåŠ¡åˆ°ç»ˆç«¯ç”¨æˆ·çš„è®¤è¯ï¼ŒåŒæ—¶å¯ä»¥ç›´æ¥å°†httpæµé‡å‡çº§æˆhttpsæµé‡ã€‚å…·ä½“çš„å¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ã€‚</p><h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><p>åœ¨è¿™é‡Œæˆ‘æ‰“ç®—ä½¿ç”¨helmè¿›è¡Œå®‰è£…ã€‚</p><h2 id="Prerequisite"><a href="#Prerequisite" class="headerlink" title="Prerequisite"></a>Prerequisite</h2><p>é¦–å…ˆï¼Œä½ å¾—æœ‰ä¸€ä¸ªå¯è¿è¡Œçš„k8sé›†ç¾¤ï¼Œæˆ‘æ˜¯åœ¨gkeä¸Šå¼€äº†ä¸€ä¸ªä¸‰èŠ‚ç‚¹çš„é›†ç¾¤ä½œä¸ºæµ‹è¯•ä½¿ç”¨ã€‚</p><p>å…¶æ¬¡ï¼Œä½ å¾—éœ€è¦æœ‰helmçš„å®¢æˆ·ç«¯ã€‚macç”¨æˆ·å¯ä»¥é€šè¿‡brewæ¥å®‰è£…ã€‚</p><h2 id="ä¸‹è½½release"><a href="#ä¸‹è½½release" class="headerlink" title="ä¸‹è½½release"></a>ä¸‹è½½release</h2><p>Istioæä¾›äº†ä¸€ä¸ªå¾ˆæ–¹ä¾¿çš„è„šæœ¬æ¥ä¸‹è½½å¹¶è§£å‹æœ€æ–°ç‰ˆçš„Istioï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -L https://git.io/getLatestIstio | sh -</span></span><br></pre></td></tr></table></figure><p>ç­‰ä¸‹è½½å®Œä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥è¿›å…¥æ–‡ä»¶å¤¹ï¼Œå¹¶æŠŠbinç›®å½•åŠ åˆ°pathé‡Œé¢ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> istio-0.8.0</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> PATH=<span class="variable">$PWD</span>/bin:<span class="variable">$PATH</span></span></span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨helmè¿›è¡Œå®‰è£…"><a href="#ä½¿ç”¨helmè¿›è¡Œå®‰è£…" class="headerlink" title="ä½¿ç”¨helmè¿›è¡Œå®‰è£…"></a>ä½¿ç”¨helmè¿›è¡Œå®‰è£…</h2><p>è¦ä½¿ç”¨helmæ¥å®‰è£…istioï¼Œé¦–å…ˆéœ€è¦åœ¨é›†ç¾¤é‡Œé¢é…ç½®å¥½helmå’Œtillerï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f install/kubernetes/helm/helm-service-account.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> helm init --service-account tiller</span></span><br></pre></td></tr></table></figure><p>ç­‰helmå’Œtilleré…ç½®å®Œä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨helmæ¥ä¸€é”®å®‰è£…Istioäº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> helm install install/kubernetes/helm/istio --name istio --namespace istio-system</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼ŒIstioå°±å®‰è£…å¥½äº†ã€‚</p><p>ä¸ºäº†éªŒè¯å®‰è£…æ˜¯å¦æˆåŠŸï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹æ˜¯å¦éƒ¨ç½²äº†ä»¥ä¸‹çš„serviceï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get svc -n istio-system</span></span><br><span class="line">NAME                       TYPE           CLUSTER-IP      EXTERNAL-IP       PORT(S)                                                               AGE</span><br><span class="line">istio-citadel              ClusterIP      10.19.247.33    &lt;none&gt;            8060/TCP,9093/TCP                                                     2m</span><br><span class="line">istio-egressgateway        ClusterIP      10.19.244.143   &lt;none&gt;            80/TCP,443/TCP                                                        2m</span><br><span class="line">istio-ingress              LoadBalancer   10.19.248.42    104.199.155.220   80:32000/TCP,443:30434/TCP                                            2m</span><br><span class="line">istio-ingressgateway       LoadBalancer   10.19.254.155   35.229.183.83     80:31380/TCP,443:31390/TCP,31400:31400/TCP                            2m</span><br><span class="line">istio-pilot                ClusterIP      10.19.252.30    &lt;none&gt;            15003/TCP,15005/TCP,15007/TCP,15010/TCP,15011/TCP,8080/TCP,9093/TCP   2m</span><br><span class="line">istio-policy               ClusterIP      10.19.242.187   &lt;none&gt;            9091/TCP,15004/TCP,9093/TCP                                           2m</span><br><span class="line">istio-sidecar-injector     ClusterIP      10.19.252.155   &lt;none&gt;            443/TCP                                                               2m</span><br><span class="line">istio-statsd-prom-bridge   ClusterIP      10.19.246.99    &lt;none&gt;            9102/TCP,9125/UDP                                                     2m</span><br><span class="line">istio-telemetry            ClusterIP      10.19.240.18    &lt;none&gt;            9091/TCP,15004/TCP,9093/TCP,42422/TCP                                 2m</span><br><span class="line">prometheus                 ClusterIP      10.19.255.53    &lt;none&gt;            9090/TCP                                                              2m</span><br></pre></td></tr></table></figure><p>å¹¶ä¸”ç¡®è®¤ä»¥ä¸‹çš„Podæ˜¯å¦åœ¨runningçŠ¶æ€ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pods -n istio-system</span></span><br><span class="line">NAME                                       READY     STATUS      RESTARTS   AGE</span><br><span class="line">istio-citadel-7bdc7775c7-ntfkf             1/1       Running     0          3m</span><br><span class="line">istio-egressgateway-795fc9b47-2hw69        1/1       Running     0          3m</span><br><span class="line">istio-ingress-84659cf44c-dkgf4             1/1       Running     0          3m</span><br><span class="line">istio-ingressgateway-7d89dbf85f-9kgth      1/1       Running     0          3m</span><br><span class="line">istio-mixer-post-install-vg5gh             0/1       Completed   0          3m</span><br><span class="line">istio-pilot-66f4dd866c-nwr2j               2/2       Running     0          3m</span><br><span class="line">istio-policy-76c8896799-7l9nz              2/2       Running     0          3m</span><br><span class="line">istio-sidecar-injector-645c89bc64-6rs5k    1/1       Running     0          3m</span><br><span class="line">istio-statsd-prom-bridge-949999c4c-mpk6d   1/1       Running     0          3m</span><br><span class="line">istio-telemetry-6554768879-vqmjd           2/2       Running     0          3m</span><br><span class="line">prometheus-86cb6dd77c-vhf9s                1/1       Running     0          3m</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ä¸€äº›å‚æ•°ï¼Œå…·ä½“çš„è¯·çœ‹[å®˜æ–¹æ–‡æ¡£]($ helm install <a href="https://raw.githubusercontent.com/istio/istio/release-0.8/install/kubernetes/helm/istio">install/kubernetes/helm/istio</a> â€“name istio â€“namespace istio-system)ã€‚</p><h1 id="æ ·ä¾‹åº”ç”¨"><a href="#æ ·ä¾‹åº”ç”¨" class="headerlink" title="æ ·ä¾‹åº”ç”¨"></a>æ ·ä¾‹åº”ç”¨</h1><p>è®©æˆ‘ä»¬éƒ¨ç½²æˆ‘ä»¬çš„ä¸€ä¸ªæ ·ä¾‹åº”ç”¨æ¥çœ‹çœ‹Istioåˆ°åº•å¹²äº†å•¥ã€‚</p><p>æˆ‘ä»¬çš„æ ·ä¾‹åº”ç”¨å«åšBookInfoï¼Œè¿™ä¸ªåº”ç”¨ç”±å››ä¸ªå¾®æœåŠ¡æ‰€ç»„æˆï¼Œå…·ä½“æ¶æ„å›¾å¦‚ä¸‹ï¼š</p><p><img data-src="https://istio.io/docs/guides/img/bookinfo/noistio.svg" alt="Bookinfo Application without Istio"></p><p>è¿™ä¸ªåº”ç”¨æ˜¯ç”¨ä¸åŒçš„è¯­è¨€æ‰€å†™çš„ï¼Œè®©æˆ‘ä»¬æ¥è§è¯†ä¸€ä¸‹Istioçš„é­”åŠ›å§ã€‚</p><p>å®‰è£…è¿™ä¸ªåº”ç”¨éå¸¸ç®€å•ï¼Œæˆ‘ä»¬åªè¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f samples/bookinfo/kube/bookinfo.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> istioctl create -f samples/bookinfo/routing/bookinfo-gateway.yaml</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥æ³¨æ„ä¸€ä¸‹ï¼Œåœ¨<code>bookinfo.yaml</code>ä¸­çš„manifestå¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright 2017 Istio Authors</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment">#   you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">#   You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#       http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">#   distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment">#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">#   See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">#   limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##################################################################################################</span></span><br><span class="line"><span class="comment"># Details service</span></span><br><span class="line"><span class="comment">##################################################################################################</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">details</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">details</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9080</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">details</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">details-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">details</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">details</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">istio/examples-bookinfo-details-v1:1.5.0</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9080</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æˆ‘ä»¬çœŸæ­£éƒ¨ç½²å‡ºæ¥åï¼Œå˜æˆäº†è¿™æ ·ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">sidecar.istio.io/status:</span> <span class="string">&#x27;&#123;&quot;version&quot;:&quot;55c9e544b52e1d4e45d18a58d0b34ba4b72531e45fb6d1572c77191422556ffc&quot;,&quot;initContainers&quot;:[&quot;istio-init&quot;],&quot;containers&quot;:[&quot;istio-proxy&quot;],&quot;volumes&quot;:[&quot;istio-envoy&quot;,&quot;istio-certs&quot;],&quot;imagePullSecrets&quot;:null&#125;&#x27;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="number">2018-07-05T09:10:55Z</span></span><br><span class="line">  <span class="attr">generateName:</span> <span class="string">details-v1-5f94c6d66b-</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">details</span></span><br><span class="line">    <span class="attr">pod-template-hash:</span> <span class="string">&quot;1950728226&quot;</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">details-v1-5f94c6d66b-jj6lz</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">ownerReferences:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">blockOwnerDeletion:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">details-v1-5f94c6d66b</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">528aa360-8033-11e8-8cec-0e04fb7e7092</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;15620&quot;</span></span><br><span class="line">  <span class="attr">selfLink:</span> <span class="string">/api/v1/namespaces/default/pods/details-v1-5f94c6d66b-jj6lz</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">528d5618-8033-11e8-8cec-0e04fb7e7092</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">istio/examples-bookinfo-details-v1:1.5.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">details</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9080</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">    <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">default-token-f9mls</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">proxy</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sidecar</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--configPath</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/etc/istio/proxy</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--binaryPath</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/usr/local/bin/envoy</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--serviceCluster</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">details</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--drainDuration</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">45s</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--parentShutdownDuration</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">1m0s</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--discoveryAddress</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">istio-pilot.istio-system:15007</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--discoveryRefreshDelay</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">10s</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--zipkinAddress</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">zipkin.istio-system:9411</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--connectTimeout</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">10s</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--statsdUdpAddress</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">istio-statsd-prom-bridge.istio-system:9125</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--proxyAdminPort</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;15000&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--controlPlaneAuthPolicy</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">NONE</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">INSTANCE_IP</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ISTIO_META_POD_NAME</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ISTIO_META_INTERCEPTION_MODE</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">REDIRECT</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/istio/proxyv2:0.8.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">istio-proxy</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">128Mi</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">runAsUser:</span> <span class="number">1337</span></span><br><span class="line">    <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">    <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/istio/proxy</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">istio-envoy</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/certs/</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">istio-certs</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">default-token-f9mls</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-p</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;15001&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-u</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;1337&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-m</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">REDIRECT</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-i</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-x</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-b</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">9080</span><span class="string">,</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-d</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/istio/proxy_init:0.8.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">istio-init</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">capabilities:</span></span><br><span class="line">        <span class="attr">add:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">NET_ADMIN</span></span><br><span class="line">      <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">    <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">default-token-f9mls</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">ip-172-31-39-23</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">  <span class="attr">securityContext:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">serviceAccount:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">node.kubernetes.io/not-ready</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">node.kubernetes.io/unreachable</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">emptyDir:</span></span><br><span class="line">      <span class="attr">medium:</span> <span class="string">Memory</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">istio-envoy</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">istio-certs</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">optional:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">istio.default</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-token-f9mls</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">default-token-f9mls</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæœ¬æ¥åªæœ‰ä¸€ä¸ªcontainerçš„ï¼Œç°åœ¨é‡Œé¢å¤šäº†ä¸€ä¸ªcontainerå’ŒinitContainerã€‚è¿™ä¸ªå°±æ˜¯Istioçš„Auto Injectionï¼Œå¯ä»¥è‡ªåŠ¨æŠŠsidecaræ³¨å…¥åˆ°Podé‡Œé¢ï¼Œè®©æˆ‘ä»¬ä¸éœ€è¦æ‰‹åŠ¨ä¸€ä¸ªä¸€ä¸ªä¿®æ”¹yamlæ–‡ä»¶ï¼Œä¹Ÿé˜²æ­¢æ‰‹åŠ¨ä¿®æ”¹è¿‡ç¨‹ä¸­å‡ºé”™çš„å¯èƒ½ã€‚</p><h1 id="ä½¿ç”¨å®ä¾‹"><a href="#ä½¿ç”¨å®ä¾‹" class="headerlink" title="ä½¿ç”¨å®ä¾‹"></a>ä½¿ç”¨å®ä¾‹</h1><p>è¿™é‡Œæˆ‘ä»¬ä»¥è·¯ç”±è®¾ç½®ä¸ºä¾‹å­ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬æ‰“å¼€åˆšæ‰éƒ¨ç½²å¥½çš„è¿™ä¸ªåº”ç”¨çš„ç½‘é¡µï¼Œå¯ä»¥çœ‹åˆ°é¡µé¢å³æ–¹çš„Book Reviewséƒ¨åˆ†é‡Œé¢æ¯æ¬¡åˆ·æ–°éƒ½ä¼šéšæœºæ€§åœ°å‡ºç°é»‘æ˜Ÿæ˜Ÿã€çº¢æ˜Ÿæ˜Ÿå’Œæ²¡æœ‰æ˜Ÿæ˜Ÿä¸‰ç§æƒ…å†µï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬æœ‰ä¸‰ä¸ªä¸åŒçš„backendï¼Œè·¯ç”±åœ¨é»˜è®¤æƒ…å†µä¸‹ä¼šéšæœºè·¯ç”±åˆ°ä»»æ„ä¸€ä¸ªbackendä¸Šã€‚</p><p>æˆ‘ä»¬å…ˆå°è¯•æŠŠæ‰€æœ‰çš„è·¯ç”±éƒ½è·¯ç”±åˆ°v1ç‰ˆæœ¬ä¸Šï¼ˆå°±æ˜¯æ²¡æœ‰æ˜Ÿæ˜Ÿçš„ç‰ˆæœ¬ï¼‰ï¼Œè·¯ç”±è§„åˆ™å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">details</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">details</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">details</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">productpage</span></span><br><span class="line">  <span class="string">...</span></span><br></pre></td></tr></table></figure><p>å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> istioctl create -f samples/bookinfo/routing/route-rule-all-v1.yaml</span></span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å†å»åˆ·æ–°ï¼Œå°±ä¼šå‘ç°ä¸ç®¡æ€ä¹ˆåˆ·æ–°æ˜Ÿæ˜Ÿéƒ½ä¸è§äº†ã€‚</p><p>æ¥ç€ï¼Œå‡å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªç”¨æˆ·æ˜¯jasonï¼Œæˆ‘ä»¬å¸Œæœ›ä»–èƒ½æµ‹è¯•v2çš„backendï¼Œå°±å¯ä»¥ç”¨ä¸‹é¢çš„è·¯ç”±è§„åˆ™ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">cookie:</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">^(.*?;)?(user=jason)(;.*)?$</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure><p>å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> istioctl replace -f samples/bookinfo/routing/route-rule-reviews-test-v2.yaml</span></span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™ï¼Œæˆ‘ä»¬æ‰“å¼€ç½‘é¡µï¼Œä»¥jasonè¿™ä¸ªç”¨æˆ·ç™»å½•ï¼ˆå¯†ç éšä¾¿å¡«ï¼‰ï¼Œå°±ä¼šå‘ç°æ¯ä¸€æ¬¡è®¿é—®åˆ°çš„éƒ½æ˜¯å¸¦æœ‰é»‘æ˜Ÿæ˜Ÿçš„ç‰ˆæœ¬ã€‚</p><p>è¿™å°±æ˜¯Istioæä¾›çš„è·¯ç”±åŠŸèƒ½ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ¬æ–‡ä¸­æˆ‘ä»¬ç®€å•è®²äº†Service Meshçš„æ¦‚å¿µï¼Œå¦‚ä½•åˆ›å»ºIstioä»¥åŠç®€å•çš„ä½¿ç”¨è¿‡ç¨‹ï¼Œå¦‚æœå¤§å®¶æœ‰å…´è¶£æ¢ç´¢Istioæ›´å¤šçš„åŠŸèƒ½ï¼Œå¯ä»¥ç›´æ¥è®¿é—®<a href="https://istio.io/">Istioçš„å®˜ç½‘</a>ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ—©åœ¨å»å¹´ï¼ŒService Meshè¿™ä¸ªæ¦‚å¿µå°±å¼€å§‹ç«èµ·æ¥äº†ï¼Œä»Šå¹´çš„æ—¶å€™Service Meshæ›´æ˜¯çˆ†å‘å¼åœ°å‘å±•ï¼ŒService Meshä¸­çš„æ˜æ˜Ÿé¡¹ç›®Istioæ›´æ˜¯åªç”¨äº†å‡ ä¸ªæœˆçš„æ—¶é—´å°±å·²ç»ä»0.1åˆ°äº†0.8 LTSäº†ã€‚ç”±äºå·¥ä½œå’Œæ¯•ä¸šçš„å‹åŠ›ï¼Œä¹‹å‰ä¸€ç›´æ²¡æœ‰æ—¶é—´æ·±å…¥ç ”ç©¶Service Meshã€‚ç°åœ¨ç¨å¾®æœ‰äº›æ—¶é—´äº†ï¼Œæ‰€ä»¥æ‰“ç®—å†™ç‚¹ä»€ä¹ˆå…³äºService Meshçš„ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://www.purewhite.io/categories/kubernetes/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="æ¶æ„" scheme="https://www.purewhite.io/tags/%E6%9E%B6%E6%9E%84/"/>
    
    <category term="docker" scheme="https://www.purewhite.io/tags/docker/"/>
    
    <category term="linux" scheme="https://www.purewhite.io/tags/linux/"/>
    
    <category term="è¿ç»´" scheme="https://www.purewhite.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="kubernetes" scheme="https://www.purewhite.io/tags/kubernetes/"/>
    
    <category term="Service Mesh" scheme="https://www.purewhite.io/tags/Service-Mesh/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•ç”¨æŠ€æœ¯å˜ç° â€”â€” å·¦è€³æœµè€—å­ä¸“æ è®°å½•</title>
    <link href="https://www.purewhite.io/2018/06/14/skill-sell-off/"/>
    <id>https://www.purewhite.io/2018/06/14/skill-sell-off/</id>
    <published>2018-06-14T05:35:58.000Z</published>
    <updated>2021-12-02T12:51:07.230Z</updated>
    
    <content type="html"><![CDATA[<p>æ˜¨å¤©è´­ä¹°äº†å·¦è€³æœµè€—å­çš„<a href="http://stuq.com/a/100aD">ä»˜è´¹ä¸“æ </a>ï¼Œæ‹œè¯»äº†å‰å‡ ç¯‡æ–‡ç« ï¼Œå—ç›ŠåŒªæµ…ï¼Œæ•…æ€»ç»“å¹¶å†™ä¸‹æ­¤æ–‡ä½œä¸ºè®°å½•ã€‚</p><span id="more"></span><p>ç¨‹åºå‘˜æ˜¯æ‰‹è‰ºäººï¼Œæ˜¯é æ‰‹è‰ºé æŠ€æœ¯åƒé¥­çš„äººï¼Œé‚£ä¹ˆæ€ä¹ˆæ ·èƒ½é€šè¿‡è‡ªå·±çš„æ‰‹è‰ºè‡ªå·±çš„æŠ€æœ¯èµšé’±å‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œå°±æ˜¯åˆ«äººä¸è¡Œçš„ï¼Œä½ å¯ä»¥ï¼Œè¿™æ‰æ˜¯æ ¸å¿ƒã€‚åœ¨åˆ«çš„æ–‡ç« ä¸­ä¹Ÿçœ‹åˆ°è¿‡ç±»ä¼¼æ¦‚å¿µï¼Œå¤§åŒå°å¼‚ï¼Œå¼ºè°ƒçš„éƒ½æ˜¯<strong>ä¸å¯æ›¿ä»£æ€§</strong>ã€‚</p><p>é‚£ä¹ˆé—®é¢˜å°±å˜æˆäº†ï¼šå¦‚ä½•è®©è‡ªå·±çš„â€œæ‰‹è‰ºâ€æ›´å€¼é’±ï¼Œæ›´æ— æ³•æ›¿ä»£ï¼Ÿ</p><p>è€—å­å“¥æ€»ç»“ä¸‹æ¥ï¼Œä¸€å…±æ˜¯æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ol><li><p>åƒé‡Œä¹‹è¡Œï¼Œç§¯äºè·¬æ­¥ã€‚ä¸å¯èƒ½ä¸€è¹´è€Œå°±ï¼Œè‚¯å®šéœ€è¦è„šè¸å®åœ°ä¸€ç‚¹ä¸€ç‚¹ç§¯ç´¯æ‰å¯ä»¥ï¼Œåšç§¯è€Œè–„å‘ã€‚éœ€è¦è‡ªå·±æ¯”åˆ«äººæ›´å¤šåœ°å»å­¦ä¹ æ–°çš„æŠ€æœ¯å’ŒæŠ€èƒ½ï¼Œæœ‰åˆ«äººæ²¡æœ‰çš„ç»éªŒå’Œç»å†ã€‚</p></li><li><p>å…³æ³¨æœ‰ä»·å€¼çš„ä¸œè¥¿ã€‚è¿™ä¸€æ®µæˆ‘è®¤ä¸ºæˆ‘æ— æ³•æ€»ç»“å¾—æ›´å¥½ï¼Œæ‰€ä»¥ç›´æ¥å¼•ç”¨åŸæ–‡ï¼š</p><blockquote><p>ä»€ä¹ˆæ˜¯æœ‰ä»·å€¼çš„ä¸œè¥¿ï¼Ÿä»·å€¼å…¶å®æ˜¯å—ä¾›éœ€å…³ç³»å½±å“çš„ï¼Œä¾›å¤§äºæ±‚ï¼Œå°±æ²¡ä»€ä¹ˆä»·å€¼ï¼Œä¾›ä¸åº”æ±‚ï¼Œå°±æœ‰ä»·å€¼ã€‚è¿™æ„å‘³ç€ä½ ä¸ä»…è¦çœ‹åˆ°å¸‚åœºï¼Œè¿˜è¦çœ‹åˆ°æŠ€æœ¯çš„è¶‹åŠ¿ï¼Œèƒ½å¤Ÿåˆ†è¾¨å‡ºä»€ä¹ˆæ˜¯ä¸»æµæŠ€æœ¯ï¼Œä»€ä¹ˆæ˜¯è¿‡æ¸¡å¼çš„æŠ€æœ¯ã€‚å½“ä½ æ¯”åˆ«äººæœ‰æ›´å¥½çš„å—…è§‰æ—¶ï¼Œä½ å°±èƒ½èµ·åŠ¨å¾—æ›´å¿«ï¼Œä¹Ÿå°±æ¯”åˆ«äººæœ‰å…ˆå‘ä¼˜åŠ¿ã€‚</p><ul><li><strong>å…³äºå¸‚åœºéœ€æ±‚</strong>ã€‚è¦çœ‹æ¸…å¸‚åœºï¼Œå°±éœ€è¦çœ‹çœ‹å„ä¸ªå…¬å¸åœ¨åšä»€ä¹ˆï¼Œä»–ä»¬çš„éš¾é¢˜æ˜¯ä»€ä¹ˆã€‚ç®€å•æ¥è¯´ï¼Œç°åœ¨çš„æ¯å®¶å…¬å¸æ— è®ºå¤§å°éƒ½ç¼ºäººã€‚æ˜¯çœŸçš„ç¼ºäººå—ï¼Ÿä¸­å›½æ˜¯äººå£å¤§å›½ï¼Œä¸ç¼ºå†™ä»£ç æ¬ç –çš„ï¼ŒçœŸæ­£ç¼ºçš„æ˜¯æœ‰èƒ½åŠ›èƒ½å¤Ÿè§£å†³æŠ€æœ¯éš¾é¢˜çš„äººï¼Œèƒ½å¤Ÿæé«˜å›¢é˜Ÿäººæ•ˆçš„äººã€‚æ‰€ä»¥ï¼Œä»è¿™äº›æ–¹é¢æ€è€ƒï¼Œä½ ä¼šçŸ¥é“å“ªäº›æŠ€èƒ½æ‰æ˜¯çœŸæ­£çš„â€œä¾›ä¸åº”æ±‚â€ï¼Œè¿™æ ·å¯ä»¥è®©ä½ æ›´æœ‰ä»·å€¼ã€‚</li><li><strong>å…³äºæŠ€æœ¯è¶‹åŠ¿</strong>ã€‚è¦çœ‹æ¸…æŠ€æœ¯è¶‹åŠ¿ï¼Œä½ éœ€è¦äº†è§£å†å²ï¼Œå°±åƒä¸€ä¸ªçƒè¿åŠ¨ä¸€æ ·ï¼Œä½ è¦çŸ¥é“è¿™ä¸ªçƒæœªæ¥è¿åŠ¨çš„åœ°æ–¹ï¼Œæ˜¯éœ€è¦è§‚å¯Ÿçƒçš„å·²ç»å®Œæˆè¿åŠ¨çš„è½¨è¿¹æ‰çŸ¥é“çš„ã€‚å› æ­¤ï¼Œäº†è§£æŠ€æœ¯å‘å±•è½¨è¿¹æ˜¯ä¸€ä»¶å¾ˆé‡è¦çš„äº‹ã€‚è¦çœ‹ä¸€ä¸ªæ–°çš„æŠ€æœ¯æ˜¯å¦é¡ºåº”æŠ€æœ¯å‘å±•è¶‹åŠ¿ï¼Œä½ éœ€è¦å°†ä¸€äº›è€æŠ€æœ¯çš„æœ¬è´¨åƒå¾—å¾ˆé€ã€‚</li></ul><p>å› æ­¤ï¼Œåœ¨å­¦ä¹ æŠ€æœ¯çš„è¿‡ç¨‹ä¸€å®šè¦å¤šé—®è‡ªå·±ä¸¤ä¸ªé—®é¢˜ï¼šâ€œ1. è¿™ä¸ªæŠ€æœ¯è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿä¸ºä»€ä¹ˆåˆ«çš„åŒç±»æŠ€æœ¯åšä¸åˆ°ï¼Ÿ2. ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·è§£å†³çš„ï¼Ÿæœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹å¼ï¼Ÿâ€å¦å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªç®€å•çš„åˆ¤æ–­æ–¹æ³•ï¼Œå¦‚æœä¸€ä¸ªæ–°çš„æŠ€æœ¯é¡ºåº”æŠ€æœ¯å‘å±•è¶‹åŠ¿ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªæ–°çš„æŠ€æœ¯å‡ºç°æ—¶ï¼Œåé¢ä¸€å®šä¼šæœ‰å¤§å‹çš„å•†ä¸šå…¬å¸æ”¯æŒï¼Œè¿™ç±»å…¬å¸æ”¯æŒå¾—è¶Šå¤šï¼Œå°±è¯´æ˜ä½ è¶Šéœ€è¦å…³æ³¨ã€‚</p></blockquote></li><li><p>æ‰¾åˆ°èƒ½ä½“ç°ä»·å€¼çš„åœ°æ–¹ã€‚åœ¨ä¸€å®¶é«˜é€Ÿå‘å±•çš„å…¬å¸ä¸­ï¼ŒæŠ€æœ¯äººå‘˜çš„ä»·å€¼å¯ä»¥æœ€å¤§åŒ–ã€‚è¿™å°±è¦æ±‚è‡ªå·±ä¸€å®šè¦èƒ½æ‰¾åˆ°ä¸€ä¸ªé«˜é€Ÿå‘å±•çš„å…¬å¸ä»¥åŠä¸€ä¸ªé«˜é€Ÿå‘å±•çš„é¢†åŸŸã€‚</p></li><li><p>åŠ¨æ‰‹èƒ½åŠ›å¾ˆé‡è¦ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯è¦ä¼šå†™ä»£ç ï¼ç»†èŠ‚æ˜¯é­”é¬¼ï¼è€Œä¸æ˜¯åšä¸€ä¸ªpptæ¶æ„å¸ˆï¼</p></li><li><p>å…³æ³¨æŠ€æœ¯ä»˜è´¹ç‚¹ã€‚æŠ€æœ¯ä»˜è´¹ç‚¹åœ¨è€—å­å“¥çš„æ€»ç»“é‡Œé¢æœ‰ä¸¤ä¸ªåœ°æ–¹ï¼šä¸€ä¸ªæ˜¯èƒ½å¸®åˆ«äººæŒ£é’±çš„åœ°æ–¹ï¼Œä¸€ä¸ªæ˜¯èƒ½å¸®åˆ«äººçœé’±çš„åœ°æ–¹ã€‚è¿™ä¹Ÿæ˜¯æ‰€æœ‰æŠ€æœ¯çš„æ ¸å¿ƒç«äº‰åŠ›ã€‚</p></li><li><p>æå‡è‡ªå·±çš„èƒ½åŠ›å’Œç»å†ã€‚åˆ«äººè¦ä»˜è´¹ç»™ä½ ï¼Œå‰ææ˜¯ä¿¡ä»»ä½ ï¼Œæ‰€ä»¥ä½ éœ€è¦æå‡è‡ªå·±çš„èƒ½åŠ›å’Œç»å†æ‰å¯ä»¥ä½¿å¾—åˆ«äººæ„¿æ„ä¿¡ä»»ä½ ä»˜è´¹ç»™ä½ ã€‚</p></li><li><p>æ‰¾åˆ°æœ‰ä»·å€¼çš„ä¿¡æ¯æºã€‚è¿™ä¸ªæ˜¯ç¨‹åºçŒ¿åŸºæœ¬åŠŸäº†ï¼Œä¸å†èµ˜è¿°ã€‚</p></li><li><p>è¾“å‡ºè§‚ç‚¹å’Œä»·å€¼è§‚ã€‚åŒæ ·çš„ï¼Œéœ€è¦ç§¯è·¬æ­¥ï¼Œåšç§¯è€Œè–„å‘ã€‚</p></li><li><p>æœ‹å‹åœˆå¾ˆé‡è¦ã€‚ä½ å’Œè°åœ¨ä¸€èµ·ï¼Œå°±ä¼šæˆä¸ºä»€ä¹ˆæ ·çš„äººã€‚ç‰©ä»¥ç±»èšï¼Œäººä»¥ç¾¤åˆ†ã€‚</p></li></ol><p>æœ€åå¥—ç”¨è€—å­å“¥çš„ç»“æŸè¯­å§ï¼Œæˆ‘ä¹Ÿè®¤ä¸ºæ— æ³•æç‚¼åœ°æ›´å¥½äº†ï¼š</p><blockquote><p>æ€»ä¹‹ï¼Œå°±ä¸€å¥è¯ï¼Œ<strong>ä¼šæŒ£é’±çš„äººä¸€å®šæ˜¯ä¼šæŠ•èµ„çš„äºº</strong>ã€‚æˆ‘ä¸€ç›´è®¤ä¸ºï¼Œ<strong>æœ€å®è´µçš„è´¢å¯Œå¹¶ä¸æ˜¯é’±ï¼Œè€Œæ˜¯ä½ çš„æ—¶é—´ï¼Œæ—¶é—´æ¯”é’±æ›´å®è´µï¼Œå› ä¸ºé’±ä½ ä¸ç”¨è¿˜åœ¨é‚£é‡Œï¼Œè€Œæ—¶é—´ä½ ä¸ç”¨å°±æµªè´¹æ‰äº†ã€‚ä½ æŠŠä½ çš„æ—¶é—´æŠ•èµ„åœ¨å“ªäº›åœ°æ–¹ï¼Œå°±æ„å‘³ç€ä½ æœªæ¥ä¼šèµ°ä»€ä¹ˆæ ·çš„è·¯ã€‚æ‰€ä»¥ï¼Œåˆ©ç”¨å¥½ä½ çš„æ—¶é—´ï¼ŒæŠ•åˆ°ä¸€äº›æœ‰æ„ä¹‰çš„åœ°æ–¹å§</strong>ã€‚</p></blockquote><p>æœ€åé™„ä¸Šè€—å­å“¥ä¸“æ æµ·æŠ¥ï¼š</p><p><img data-src="https://static.purewhite.io/images/2018-06-14-063400.png!webp_50" alt="image-20180614143359989"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ˜¨å¤©è´­ä¹°äº†å·¦è€³æœµè€—å­çš„&lt;a href=&quot;http://stuq.com/a/100aD&quot;&gt;ä»˜è´¹ä¸“æ &lt;/a&gt;ï¼Œæ‹œè¯»äº†å‰å‡ ç¯‡æ–‡ç« ï¼Œå—ç›ŠåŒªæµ…ï¼Œæ•…æ€»ç»“å¹¶å†™ä¸‹æ­¤æ–‡ä½œä¸ºè®°å½•ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="éšç¬”" scheme="https://www.purewhite.io/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
    <category term="éšç¬”" scheme="https://www.purewhite.io/tags/%E9%9A%8F%E7%AC%94/"/>
    
    <category term="å¿ƒå¾—" scheme="https://www.purewhite.io/tags/%E5%BF%83%E5%BE%97/"/>
    
  </entry>
  
  <entry>
    <title>è‹¥é¥­æ¶²ä½“ç‰ˆv3.1è¯„æµ‹</title>
    <link href="https://www.purewhite.io/2018/06/13/ruffood-evaluate/"/>
    <id>https://www.purewhite.io/2018/06/13/ruffood-evaluate/</id>
    <published>2018-06-13T06:32:51.000Z</published>
    <updated>2021-12-02T12:51:07.229Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¼˜èµ·"><a href="#ç¼˜èµ·" class="headerlink" title="ç¼˜èµ·"></a>ç¼˜èµ·</h1><p>å¾ˆä¹…ä¹‹å‰å°±çœ‹åˆ°å¤§å­¦å®¤å‹æœ‰åƒè¿‡è‹¥é¥­ï¼Œå½“æ—¶è¿˜æ¨èç»™æˆ‘ä¸è¿‡æˆ‘å½“æ—¶å¿™äºå†™ï¼ˆæ’¸ï¼‰ä»£ï¼ˆå•Šï¼‰ç ï¼ˆæ’¸ï¼‰å¹¶æ²¡æœ‰ç†ï¼Œæ˜¨å¤©åœ¨ç½‘ä¸Šåˆç¢°å·§çœ‹åˆ°äº†è‹¥é¥­ï¼Œäºæ˜¯æŠ±ç€åƒèƒèŸ¹çš„å¿ƒæ€æ‰“ç®—ä¹°æ¥å°ä¸€å°ã€‚</p><p>è‹¥é¥­æ˜¯ä¸€ç§ä»£é¤é£Ÿå“ï¼ˆé¥®æ–™ï¼Ÿï¼‰ï¼Œæ˜¯ä¸ºäº†é‚£äº›å¿™çš„æ²¡æ—¶é—´åƒé¥­çš„äººæ‰€è®¾è®¡çš„ï¼Œæ®è¯´åˆ›å§‹äººåŸæ¥ä¹Ÿæ˜¯ç¨‹åºçŒ¿ï¼Œå¿™çš„æ²¡æ³•åƒé¥­ï¼Œäºæ˜¯è‡ªå·±çé¼“æ£å‡ºäº†ä¸€äº›ç”¨æ¥è§£å†³åƒé¥­é—®é¢˜çš„æ··åˆç‰©ï¼Œè‡ªå·±åƒä¸‹æ¥è§‰å¾—ä¸é”™ï¼Œäºæ˜¯æƒ³ä»¥æ­¤åˆ›ä¸šã€‚</p><span id="more"></span><p>è‹¥é¥­ç›®å‰æœ‰ä¸‰ä¸ªäº§å“çº¿ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ol><li>V1.xï¼Œä»£é¤è±†</li><li>V2.xï¼Œç²‰æœ«ç‰ˆ</li><li>V3.xï¼Œæ¶²ä½“ç‰ˆ</li></ol><p>æ˜¨å¤©æˆ‘ä¹°äº†ç²‰æœ«ç‰ˆå’Œæ¶²ä½“ç‰ˆçš„ï¼Œä»˜å®Œé’±å·²ç»4ç‚¹äº†ï¼Œè”ç³»å®¢æœè¯´3ç‚¹30å¿«é€’èµ°å¾—ç¬¬äºŒå¤©å‘è´§ï¼Œä½†æ˜¯æˆ‘å°±è¯´æˆ‘ä¹‹åä¸æ–¹ä¾¿æ”¶å¿«é€’ï¼Œäºæ˜¯å®¢æœé©¬ä¸Šè”ç³»äº†ä»“åº“ï¼Œä»“åº“è¯´å·²ç»ä¸‹ç­äº†ï¼Œå®¢æœè¯´ç»™æˆ‘å«ä¸ªé¡ºä¸°å‘è´§ï¼Œåœ¨è¿™é‡Œèµä¸€ä¸ª é¥­æ¡¶@è‹¥é¥­ ã€‚</p><p>å‘äº†é¡ºä¸°ä»Šå¤©æ—©ä¸Š8ç‚¹å¤šå°±é€åˆ°äº†ï¼Œé€Ÿåº¦é£å¿«ï¼Œä¸€å…±å°±èŠ±äº†å¤§æ¦‚åå‡ ä¸ªå°æ—¶ä»æ¹–å·å‘è´§åˆ°ä¸Šæµ·ã€‚</p><h1 id="åˆè§"><a href="#åˆè§" class="headerlink" title="åˆè§"></a>åˆè§</h1><p>æœ¬æ¥ä»¥ä¸ºå†æ€ä¹ˆä¹Ÿå¾—ç­‰ä¸‹ç­å›å®¶æ‰èƒ½æ‹¿åˆ°ï¼Œæ²¡æƒ³åˆ°ä¸€æ—©ä¸Šåˆšå‡†å¤‡å‡ºé—¨ä¸Šç­å°±é‡ä¸Šäº†æ¥é€è‹¥é¥­çš„å¿«é€’å°å“¥ã€‚</p><p>è‹¥é¥­åŒ…è£…å¦‚ä¸‹ï¼š</p><p><img data-src="https://static.purewhite.io/images/2018-06-13-065035.png!webp_50" alt="image-20180613145034726"></p><p>ç²‰æœ«ç‰ˆçš„åŒ…è£…å¦‚ä¸‹ï¼š</p><p><img data-src="https://static.purewhite.io/images/2018-06-13-065109.png!webp_50" alt="image-20180613145108927"></p><p><img data-src="https://static.purewhite.io/images/2018-06-13-065129.png!webp_50" alt="image-20180613145128818"></p><p>ä¹°äº†ç²‰æœ«ç‰ˆï¼Œå¥—é¤é‡Œé¢è¿˜é€äº†ä¸€ä¸ªæ…æ‹Œæ¯å’Œé‡å‹ºï¼š</p><p><img data-src="https://static.purewhite.io/images/2018-06-13-065229.png!webp_50" alt="image-20180613145228863"></p><p><img data-src="https://static.purewhite.io/images/2018-06-13-065318.png!webp_50" alt="image-20180613145318586"></p><p><img data-src="https://static.purewhite.io/images/2018-06-13-065357.png!webp_50" alt="image-20180613145357287"></p><p>å¯¹äºç²‰æœ«ç‰ˆè€Œè¨€ï¼Œéœ€è¦è‡ªå·±å†²æ³¡ã€‚ç”±äºæ—¶é—´å…³ç³»ï¼Œä»Šå¤©æ‰“ç®—ä½¿ç”¨çš„æ˜¯V3.1æ¶²ä½“ç‰ˆï¼š</p><p><img data-src="https://static.purewhite.io/images/2018-06-13-065538.png!webp_50" alt="image-20180613145537598"></p><p><img data-src="https://static.purewhite.io/images/2018-06-13-065614.png!webp_50" alt="image-20180613145614640"></p><h1 id="è¯„æµ‹"><a href="#è¯„æµ‹" class="headerlink" title="è¯„æµ‹"></a>è¯„æµ‹</h1><p>æ€»ç®—ç­‰åˆ°ä¸­åˆäº†ï¼Œå¯ä»¥å¼€å§‹åƒè‹¥é¥­äº†ã€‚ä»Šå¤©å¸¦äº†ä¸€ç“¶æ¶²ä½“ç‰ˆçš„æ¥å…¬å¸å½“åšåˆé¤ã€‚æ¶²ä½“ç‰ˆçš„ç“¶å£æœ‰å¯†å°æªæ–½ï¼Œä¸è¿‡æœ‰ç¼ºå£ï¼Œå¾ˆå®¹æ˜“æ‰“å¼€ï¼Œè®¾è®¡çš„ä¸é”™ã€‚</p><p>æ‘‡æ™ƒå‡åŒ€åï¼Œæ‰“å¼€ç“¶ç›–ï¼Œé¢œè‰²æ˜¯å’–å•¡è‰²çš„ã€‚å°äº†ç¬¬ä¸€å£ï¼Œæ„Ÿè§‰é‡Œé¢æœ‰ç‚¹ç²‰æœ«çŠ¶çš„ä¸œè¥¿æ²¡æœ‰æº¶è§£åœ¨æ¶²ä½“ä¸­ï¼Œåº”è¯¥æ˜¯å„ç§è›‹ç™½ç²‰ä¹‹ç±»çš„ç‰©è´¨ï¼Œå£æ„Ÿç”±äºæœ‰ç²‰æœ«çŠ¶çš„ç‰©è´¨åœ¨é‡Œé¢æ··ç€ï¼Œæ‰€ä»¥å¤šå¤šå°‘å°‘å—äº†ä¸€ç‚¹å½±å“ï¼Œä¸æ˜¯æˆ‘é¢„è®¡ä¸­çš„ä¸æ»‘æˆ–è€…ç±»ä¼¼é¥®æ–™çš„å£æ„Ÿã€‚å‘³é“æ¯”è¾ƒæ·¡ï¼Œå¸¦æœ‰ä¸€ç‚¹ç‚¹çš„å’–å•¡çš„å‘³é“ï¼Œè¿˜æœ‰è±†å¥¶çš„å‘³é“æ··æ‚åœ¨ä¸€èµ·ï¼Œå…¶ä¸­è±†åˆ¶å“çš„å‘³é“è¾ƒä¸ºæ˜æ˜¾ï¼Œåº”è¯¥å’Œå…¶ä¸­æœ‰è±†ç±»æˆåˆ†æ˜¯ç›¸å…³çš„ã€‚</p><p>è™½ç„¶å‰å‡ å£å–ä¸‹å»å¹¶æ²¡æœ‰ä»€ä¹ˆæƒŠè‰³çš„æ„Ÿè§‰ï¼Œå‘³é“ä¹Ÿä¸æ˜¯é‚£ç§ç‰¹åˆ«å‡ºä¼—çš„å‘³é“ï¼Œä½†æ˜¯è¿˜æ˜¯æŒºç»å–çš„ï¼Œå› ä¸ºåœ¨å–å®Œå‡ å£ä¹‹åå“å‘³äº†ä¸€ä¸‹ï¼Œæœ‰ç§æ¬²æœ›æƒ³è¦æ¥ç€å»å†å–å‡ å£ã€‚ä»”ç»†æ€è€ƒä¸‹æ¥ï¼Œåº”è¯¥æ˜¯å£å‘³ç‰¹æ„åšæˆè¿™æ ·çš„ï¼Œä¸å®¹æ˜“è®©äººè…»ã€‚</p><p>äººä½“æ¯å¤©éœ€è¦å¤šå°‘è¥å…»ï¼Œè‹¥é¥­é…æ¯”å¦‚ä½•åœ¨è¿™é‡Œä¸è®ºï¼Œå®˜ç½‘å’ŒåŒ…è£…ä¸Šéƒ½æœ‰å¾ˆå¤šæ•°æ®ï¼Œè€Œä¸”åœ¨æ²¡æœ‰å„ç§ä»ªå™¨æµ‹é‡çš„æƒ…å†µä¹‹ä¸‹æ— æ³•å¾—å‡ºç»“è®ºï¼›ä½†æ˜¯è‹¥é¥­ç¡®å®èƒ½ç»™äººå¸¦æ¥é¥±è…¹æ„Ÿâ€”â€”è™½ç„¶ä¸çŸ¥é“åŸç†æ˜¯ä»€ä¹ˆâ€”â€”åœ¨å–äº†åŠç“¶ä¹‹åå°±å·²ç»è§‰å¾—è‡ªå·±é¥±äº†ï¼Œè¿™æ ·çœ‹æ¥å¯èƒ½ç¡®å®ä¸€ç“¶çš„é‡æ˜¯èƒ½ç»™äººå¸¦æ¥3-4å°æ—¶é¥±è…¹æ„Ÿçš„ï¼Œå¹¶æ²¡æœ‰å¤¸å¤§å…¶è¯ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è‹¥é¥­ä½œä¸ºæ–°å‹ä»£é¤ç±»é£Ÿå“ï¼ˆé¥®æ–™ï¼‰ï¼ŒæŠ“ä½äº†äººä»¬åƒé¥­çš„è¿™ä¸ªç—›ç‚¹é—®é¢˜ï¼Œå¹¶ä¸”æå‡ºäº†ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œä»æ–¹ä¾¿å’Œå¥åº·çš„è§’åº¦å°è¯•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸»è¦çš„å¥½å¤„è¿˜æ˜¯é£Ÿç”¨æ–¹ä¾¿è€Œä¸”è¥å…»ç§‘å­¦åˆç†ï¼Œèƒ½å¤ŸèŠ‚çœä¸‹æ¥åƒé¥­çš„æ—¶é—´ï¼Œæ¯”å¦‚åƒæˆ‘ç°åœ¨å¯ä»¥å†™ä¸€æ®µä»£ç ï¼Œåœ¨æ€è€ƒçš„æ—¶å€™å–å‡ å£è‹¥é¥­å°±èƒ½è§£å†³åˆé¤ï¼ŒåŒæ—¶ä¹Ÿä¸ç”¨å»è€ƒè™‘åƒçš„æ˜¯å¦å¥åº·ã€‚å¦‚æœæ˜¯å¯¹å£å‘³å£æ„Ÿä¸Šè¦æ±‚å¾ˆé«˜çš„è¯ï¼Œä¹Ÿè®¸è‹¥é¥­å¹¶ä¸èƒ½åœ¨å£å‘³å£æ„Ÿä¸Šåšå¾—å¾ˆå¥½ã€‚</p><p>æ¥ç€ï¼ŒèŠä¸€ä¸‹ä»·æ ¼ç›¸å…³çš„äº‹æƒ…ï¼Œé™¤äº†è‹¥é¥­çš„V2.xçš„è¢‹è£…ç²‰æœ«ç‰ˆï¼ˆéœ€è¦è‡ªå·±å†²æ³¡åŠæ¸…æ´—æ¯å­ï¼‰ä»·æ ¼è¿˜å±äºå°šå¯ä¹‹å¤–ï¼Œåˆ«çš„äº§å“ï¼ˆæ¯”å¦‚ç“¶è£…ç²‰æœ«ç‰ˆï¼Œå–å®Œç›´æ¥æ‰”ç“¶å­ï¼‰çš„ä»·æ ¼å¯¹æˆ‘è¿™ç§å·¥è–ªé˜¶å±‚çš„äººæ¥è¯´è¿˜æ˜¯åè´µä¸€äº›ï¼Œä¸è¿‡è¿™ä¹Ÿæ­£å¸¸ï¼Œæ¯•ç«Ÿç°åœ¨è¶Šæ¥è¶Šå¤šçš„æ¶ˆè´¹æ˜¯æ‹¿å»ä¹°äº†æ–¹ä¾¿çš„ä½“éªŒï¼Œè€Œå¹¶éä»…ä»…æ˜¯ç‰©è´¨ä¸Šçš„ä»·å€¼ã€‚è‹¥é¥­çš„æœ¬è´¨å…¶å®å°±æ˜¯åŒ»é™¢è‚ èƒƒç§‘çš„è‚ å†…è¥å…»ç´ ï¼Œåªä¸è¿‡åŒ»é™¢ä¸ä¼šæŠŠè¿™ç§ä¸œè¥¿åšå¾—è¿™ä¹ˆæ–¹ä¾¿äººä»¬é£Ÿç”¨ï¼Œä¹Ÿä¸ä¼šå–ç»™å¥åº·äººï¼Œè€Œè‹¥é¥­åšåˆ°äº†å°†ç§‘å­¦åˆç†é…æ¯”çš„é¥®é£Ÿåšå¾—éå¸¸æ–¹ä¾¿å»é£Ÿç”¨ï¼Œä»è¿™ä¸ªè§’åº¦æ¥è¯´æˆ‘è®¤ä¸ºè‹¥é¥­å…¶å®å±äºé™„åŠ ä»·å€¼é«˜çš„å•†å“ï¼Œè€Œä¸æ˜¯ç±»ä¼¼äºå¤§å¤šæ•°çš„åˆ«çš„é›¶é£Ÿé¥®æ–™ï¼Œæ˜¯ä»¥æˆæœ¬ä¸ºä¸»çš„ã€‚</p><p>æ€»è€Œè¨€ä¹‹ï¼Œè‹¥é¥­å¯ä»¥ä½¿å¾—åƒé¥­å˜å¾—ç®€å•ã€å¥åº·ã€å¿«é€Ÿï¼Œä½†æ˜¯åƒä¹…äº†å¯èƒ½ä¼šè§‰å¾—å£è…¹ä¹‹æ¬²æ²¡èƒ½æ»¡è¶³ï¼Œè¿˜æ˜¯ä¼šæƒ³è¦åƒä¸€äº›å¥½åƒçš„å£å‘³é‡çš„ä¸œè¥¿ã€‚è‹¥é¥­å¯ä»¥åœ¨å·¥ä½œç‰¹åˆ«å¿™çš„æ—¶å€™ç”¨æ¥åº”æ€¥å½“åšå¿«é€Ÿåˆé¤ï¼Œå¹³æ—¶ä¸å¿™çš„æ—¶å€™å»åƒæ™®é€šçš„é¥­èœï¼Œè¿™æ ·äº¤æ›¿çš„å»é£Ÿç”¨å¯èƒ½æ˜¯æ›´å¥½çš„æ–¹æ¡ˆã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;ç¼˜èµ·&quot;&gt;&lt;a href=&quot;#ç¼˜èµ·&quot; class=&quot;headerlink&quot; title=&quot;ç¼˜èµ·&quot;&gt;&lt;/a&gt;ç¼˜èµ·&lt;/h1&gt;&lt;p&gt;å¾ˆä¹…ä¹‹å‰å°±çœ‹åˆ°å¤§å­¦å®¤å‹æœ‰åƒè¿‡è‹¥é¥­ï¼Œå½“æ—¶è¿˜æ¨èç»™æˆ‘ä¸è¿‡æˆ‘å½“æ—¶å¿™äºå†™ï¼ˆæ’¸ï¼‰ä»£ï¼ˆå•Šï¼‰ç ï¼ˆæ’¸ï¼‰å¹¶æ²¡æœ‰ç†ï¼Œæ˜¨å¤©åœ¨ç½‘ä¸Šåˆç¢°å·§çœ‹åˆ°äº†è‹¥é¥­ï¼Œäºæ˜¯æŠ±ç€åƒèƒèŸ¹çš„å¿ƒæ€æ‰“ç®—ä¹°æ¥å°ä¸€å°ã€‚&lt;/p&gt;
&lt;p&gt;è‹¥é¥­æ˜¯ä¸€ç§ä»£é¤é£Ÿå“ï¼ˆé¥®æ–™ï¼Ÿï¼‰ï¼Œæ˜¯ä¸ºäº†é‚£äº›å¿™çš„æ²¡æ—¶é—´åƒé¥­çš„äººæ‰€è®¾è®¡çš„ï¼Œæ®è¯´åˆ›å§‹äººåŸæ¥ä¹Ÿæ˜¯ç¨‹åºçŒ¿ï¼Œå¿™çš„æ²¡æ³•åƒé¥­ï¼Œäºæ˜¯è‡ªå·±çé¼“æ£å‡ºäº†ä¸€äº›ç”¨æ¥è§£å†³åƒé¥­é—®é¢˜çš„æ··åˆç‰©ï¼Œè‡ªå·±åƒä¸‹æ¥è§‰å¾—ä¸é”™ï¼Œäºæ˜¯æƒ³ä»¥æ­¤åˆ›ä¸šã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="å¥½åƒçš„" scheme="https://www.purewhite.io/categories/%E5%A5%BD%E5%90%83%E7%9A%84/"/>
    
    
    <category term="éšç¬”" scheme="https://www.purewhite.io/tags/%E9%9A%8F%E7%AC%94/"/>
    
    <category term="å¥½åƒçš„" scheme="https://www.purewhite.io/tags/%E5%A5%BD%E5%90%83%E7%9A%84/"/>
    
  </entry>
  
  <entry>
    <title>LintCode 415.æœ‰æ•ˆå›æ–‡ä¸²</title>
    <link href="https://www.purewhite.io/2018/03/30/lintcode-valid-palindrome/"/>
    <id>https://www.purewhite.io/2018/03/30/lintcode-valid-palindrome/</id>
    <published>2018-03-30T10:02:44.000Z</published>
    <updated>2021-12-02T12:51:07.228Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é¢˜æ„"><a href="#é¢˜æ„" class="headerlink" title="é¢˜æ„"></a>é¢˜æ„</h1><p>ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåˆ¤æ–­å…¶æ˜¯å¦ä¸ºä¸€ä¸ªå›æ–‡ä¸²ã€‚åªåŒ…å«å­—æ¯å’Œæ•°å­—ï¼Œå¿½ç•¥å¤§å°å†™ã€‚</p><h5 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h5><p>ä½ æ˜¯å¦è€ƒè™‘è¿‡ï¼Œå­—ç¬¦ä¸²æœ‰å¯èƒ½æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Ÿè¿™æ˜¯é¢è¯•è¿‡ç¨‹ä¸­ï¼Œé¢è¯•å®˜å¸¸å¸¸ä¼šé—®çš„é—®é¢˜ã€‚</p><p>åœ¨è¿™ä¸ªé¢˜ç›®ä¸­ï¼Œæˆ‘ä»¬å°†ç©ºå­—ç¬¦ä¸²åˆ¤å®šä¸ºæœ‰æ•ˆå›æ–‡ã€‚</p><span id="more"></span><h1 id="æ ·ä¾‹"><a href="#æ ·ä¾‹" class="headerlink" title="æ ·ä¾‹"></a>æ ·ä¾‹</h1><p><code>&quot;A man, a plan, a canal: Panama&quot;</code> æ˜¯ä¸€ä¸ªå›æ–‡ã€‚</p><p><code>&quot;race a car&quot;</code> ä¸æ˜¯ä¸€ä¸ªå›æ–‡ã€‚</p><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><p>è¿™é“é¢˜çš„æ€è·¯å¾ˆç®€å•ï¼Œå…ˆæŠŠç»™å®šå­—ç¬¦ä¸²é¢„å¤„ç†ä¸€ä¸‹ï¼Œå…ˆåªé€‰æ‹©å…¶ä¸­çš„å­—æ¯å’Œæ•°æ®ï¼Œå†å…¨éƒ¨å˜æˆå°å†™ï¼ˆå¤§å†™ï¼‰ï¼Œç„¶åæ ¹æ®å›æ–‡ä¸²çš„æ€§è´¨å·¦å³ä¸¤è¾¹è¿›è¡Œæ¯”è¾ƒå³å¯ã€‚</p><p>å‘ç‚¹åœ¨äºé¢˜æ„ä¸­çš„æ³¨æ„äº‹é¡¹è¯´çš„ï¼Œå¦‚æœæ˜¯ç©ºä¸²çš„æƒ…å†µã€‚</p><h1 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    @param s: A string</span></span><br><span class="line"><span class="string">    @return: Whether the string is a valid palindrome</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isPalindrome</span>(<span class="params">self, s</span>):</span></span><br><span class="line">        <span class="comment"># edge condition</span></span><br><span class="line">        <span class="keyword">if</span> s == <span class="string">&quot;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="comment"># pre-process</span></span><br><span class="line">        real = [ch.lower() <span class="keyword">for</span> ch <span class="keyword">in</span> s <span class="keyword">if</span> ch.isalnum()]</span><br><span class="line">        <span class="comment"># solve</span></span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        j = <span class="built_in">len</span>(real) - <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> i &lt;= j:</span><br><span class="line">            <span class="keyword">if</span> real[i] != real[j]:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            j -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;é¢˜æ„&quot;&gt;&lt;a href=&quot;#é¢˜æ„&quot; class=&quot;headerlink&quot; title=&quot;é¢˜æ„&quot;&gt;&lt;/a&gt;é¢˜æ„&lt;/h1&gt;&lt;p&gt;ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåˆ¤æ–­å…¶æ˜¯å¦ä¸ºä¸€ä¸ªå›æ–‡ä¸²ã€‚åªåŒ…å«å­—æ¯å’Œæ•°å­—ï¼Œå¿½ç•¥å¤§å°å†™ã€‚&lt;/p&gt;
&lt;h5 id=&quot;æ³¨æ„äº‹é¡¹&quot;&gt;&lt;a href=&quot;#æ³¨æ„äº‹é¡¹&quot; class=&quot;headerlink&quot; title=&quot;æ³¨æ„äº‹é¡¹&quot;&gt;&lt;/a&gt;æ³¨æ„äº‹é¡¹&lt;/h5&gt;&lt;p&gt;ä½ æ˜¯å¦è€ƒè™‘è¿‡ï¼Œå­—ç¬¦ä¸²æœ‰å¯èƒ½æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Ÿè¿™æ˜¯é¢è¯•è¿‡ç¨‹ä¸­ï¼Œé¢è¯•å®˜å¸¸å¸¸ä¼šé—®çš„é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨è¿™ä¸ªé¢˜ç›®ä¸­ï¼Œæˆ‘ä»¬å°†ç©ºå­—ç¬¦ä¸²åˆ¤å®šä¸ºæœ‰æ•ˆå›æ–‡ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://www.purewhite.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://www.purewhite.io/tags/%E7%AE%97%E6%B3%95/"/>
    
    <category term="LintCode" scheme="https://www.purewhite.io/tags/LintCode/"/>
    
    <category term="æ•°æ®ç»“æ„" scheme="https://www.purewhite.io/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>LintCode 627.æœ€é•¿å›æ–‡ä¸²</title>
    <link href="https://www.purewhite.io/2018/03/30/lintcode-longest-palindrome/"/>
    <id>https://www.purewhite.io/2018/03/30/lintcode-longest-palindrome/</id>
    <published>2018-03-30T09:10:06.000Z</published>
    <updated>2021-12-02T12:51:07.228Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é¢˜æ„"><a href="#é¢˜æ„" class="headerlink" title="é¢˜æ„"></a>é¢˜æ„</h1><p>ç»™å‡ºä¸€ä¸ªåŒ…å«å¤§å°å†™å­—æ¯çš„å­—ç¬¦ä¸²ã€‚æ±‚å‡ºç”±è¿™äº›å­—æ¯æ„æˆçš„æœ€é•¿çš„å›æ–‡ä¸²çš„é•¿åº¦æ˜¯å¤šå°‘ã€‚</p><p>æ•°æ®æ˜¯å¤§å°å†™æ•æ„Ÿçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>&quot;Aa&quot;</code> å¹¶ä¸ä¼šè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªå›æ–‡ä¸²ã€‚</p><h5 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h5><p>å‡è®¾å­—ç¬¦ä¸²çš„é•¿åº¦ä¸ä¼šè¶…è¿‡ <code>1010</code>ã€‚</p><span id="more"></span><h1 id="æ ·ä¾‹"><a href="#æ ·ä¾‹" class="headerlink" title="æ ·ä¾‹"></a>æ ·ä¾‹</h1><p>ç»™å‡º s = <code>&quot;abccccdd&quot;</code> è¿”å› <code>7</code></p><p>ä¸€ç§å¯ä»¥æ„å»ºå‡ºæ¥çš„æœ€é•¿å›æ–‡ä¸²æ–¹æ¡ˆæ˜¯ <code>&quot;dccaccd&quot;</code>ã€‚</p><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><p>çœ‹åˆ°é¢˜ç›®ï¼Œç¬¬ä¸€ä¸ªå…³é”®æ˜¯çœ‹åˆ°ï¼Œè¿™é“é¢˜åªè¦æ±‚é•¿åº¦å³å¯ï¼Œä¸éœ€è¦æ±‚å‡ºå…·ä½“çš„å›æ–‡ä¸²ï¼Œæ‰€ä»¥ä¼šæ–¹ä¾¿å¾ˆå¤šã€‚</p><p>æ—¢ç„¶åªè¦æ±‚å‡ºé•¿åº¦ï¼Œé‚£ä¹ˆä¸€å®šæ˜¯æœ‰ä¸€äº›ç®€å•çš„æ–¹æ³•ç®—å‡ºæ¥ä¸ç”¨æ±‚å‡ºå…·ä½“çš„å›æ–‡ä¸²åˆ°åº•å¦‚ä½•çš„ã€‚</p><p>é‚£æˆ‘ä»¬å°±æ€è€ƒï¼Œè¦ç»„æˆå›æ–‡ä¸²éœ€è¦ä»€ä¹ˆæ ·çš„æ¡ä»¶å‘¢ï¼Ÿ</p><ol><li>å•ä¸ªå­—æ¯ï¼Œæ”¾åœ¨å›æ–‡ä¸²ä¸­é—´ï¼Œä¸€å®šæ˜¯å›æ–‡ä¸²</li><li>ä¸¤ä¸ªç›¸åŒçš„å­—æ¯ï¼Œä¸€å®šèƒ½ç»„æˆå›æ–‡ä¸²</li><li>ä¸¤ä¸ªæˆ–è€…å¤šä¸ªä¸åŒçš„å­—æ¯ï¼Œä¸€å®šä¸èƒ½ç»„æˆå›æ–‡ä¸²</li></ol><p>è¿™é‡Œçš„å…³é”®æ˜¯ç¬¬äºŒç‚¹ï¼Œä¸¤ä¸ªç›¸åŒçš„å­—æ¯ä¸€å®šèƒ½ç»„æˆå›æ–‡ä¸²ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å…ˆè€ƒè™‘ä¸€ä¸‹ï¼Œå¦‚æœä¸€ä¸ªå­—æ¯åœ¨ç»™å®šå­—ç¬¦ä¸²ä¸­å‡ºç°äº†å¶æ•°æ¬¡æ•°ï¼Œé‚£ä¹ˆä¸€å®šèƒ½ç»„æˆå›æ–‡ä¸²ã€‚</p><p>é‚£å¦‚æœä¸€ä¸ªå­—æ¯å‡ºç°äº†å¥‡æ•°æ¬¡å‘¢ï¼Ÿ</p><p>æ€è€ƒä¸€ä¸‹å°±èƒ½æƒ³åˆ°ï¼Œå¥‡æ•°æ¬¡çš„å‡ºç°æ¬¡æ•°ï¼Œç­‰äºå¶æ•°æ¬¡+1ã€‚</p><p>æ ¹æ®ä¸Šé¢çš„ç¬¬ä¸€å’Œç¬¬ä¸‰ç‚¹ï¼Œå¦‚æœè¯´æœ‰å‡ºç°å¥‡æ•°æ¬¡çš„å­—æ¯ï¼Œé‚£ä¹ˆè¿™äº›å­—æ¯ä¸­å¯ä»¥é€‰æ‹©ä¸€ä¸ªæ”¾åœ¨å›æ–‡ä¸²ä¸­é—´ï¼Œè¿™æ ·é•¿åº¦å¯ä»¥+1ã€‚</p><p>æœ€åå‰©ä¸‹çš„å°±æ˜¯ä¸€äº›è¾¹ç•Œæƒ…å†µå¤„ç†äº†ï¼Œæ¯”å¦‚ï¼Œå¦‚æœæ‰€æœ‰çš„å­—æ¯éƒ½å‡ºç°å¶æ•°æ¬¡ã€‚</p><h1 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    @param s: a string which consists of lowercase or uppercase letters</span></span><br><span class="line"><span class="string">    @return: the length of the longest palindromes that can be built</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">longestPalindrome</span>(<span class="params">self, s</span>):</span></span><br><span class="line">        odd = <span class="built_in">list</span>()</span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> s:</span><br><span class="line">            <span class="keyword">if</span> ch <span class="keyword">not</span> <span class="keyword">in</span> odd:</span><br><span class="line">                odd.append(ch)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                odd.remove(ch)</span><br><span class="line"></span><br><span class="line">        num = <span class="built_in">len</span>(odd)</span><br><span class="line">        <span class="keyword">if</span> num &gt; <span class="number">0</span>:</span><br><span class="line">            num -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(s) - num</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;é¢˜æ„&quot;&gt;&lt;a href=&quot;#é¢˜æ„&quot; class=&quot;headerlink&quot; title=&quot;é¢˜æ„&quot;&gt;&lt;/a&gt;é¢˜æ„&lt;/h1&gt;&lt;p&gt;ç»™å‡ºä¸€ä¸ªåŒ…å«å¤§å°å†™å­—æ¯çš„å­—ç¬¦ä¸²ã€‚æ±‚å‡ºç”±è¿™äº›å­—æ¯æ„æˆçš„æœ€é•¿çš„å›æ–‡ä¸²çš„é•¿åº¦æ˜¯å¤šå°‘ã€‚&lt;/p&gt;
&lt;p&gt;æ•°æ®æ˜¯å¤§å°å†™æ•æ„Ÿçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ&lt;code&gt;&amp;quot;Aa&amp;quot;&lt;/code&gt; å¹¶ä¸ä¼šè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªå›æ–‡ä¸²ã€‚&lt;/p&gt;
&lt;h5 id=&quot;æ³¨æ„äº‹é¡¹&quot;&gt;&lt;a href=&quot;#æ³¨æ„äº‹é¡¹&quot; class=&quot;headerlink&quot; title=&quot;æ³¨æ„äº‹é¡¹&quot;&gt;&lt;/a&gt;æ³¨æ„äº‹é¡¹&lt;/h5&gt;&lt;p&gt;å‡è®¾å­—ç¬¦ä¸²çš„é•¿åº¦ä¸ä¼šè¶…è¿‡ &lt;code&gt;1010&lt;/code&gt;ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://www.purewhite.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://www.purewhite.io/tags/%E7%AE%97%E6%B3%95/"/>
    
    <category term="LintCode" scheme="https://www.purewhite.io/tags/LintCode/"/>
    
    <category term="æ•°æ®ç»“æ„" scheme="https://www.purewhite.io/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•ä½¿ç”¨Helmè¿›è¡Œæœ¬åœ°å¼€å‘</title>
    <link href="https://www.purewhite.io/2018/01/17/helm-local-dev/"/>
    <id>https://www.purewhite.io/2018/01/17/helm-local-dev/</id>
    <published>2018-01-17T04:49:30.000Z</published>
    <updated>2021-12-02T12:51:07.226Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://helm.sh/">Helm</a>æ˜¯kubernetesçš„å®˜æ–¹åŒ…ç®¡ç†å·¥å…·ã€‚æ ¹æ®å®˜ç½‘ä¸Šçš„æè¿°<code>Helm is the best way to find, share, and use software built for Kubernetes.</code>å¯ä»¥çœ‹å‡ºhelmåœ¨kubernetesç¤¾åŒºä¸­çš„å®šä½ã€‚</p><p>è¿™ç¯‡æ–‡ç« å¹¶ä¸æ˜¯helmçš„å…¥é—¨æ–‡ç« ï¼Œè€Œæ˜¯ç€é‡äºå¦‚ä½•åœ¨æœ¬åœ°å¼€å‘chartã€‚å¸Œæœ›è¿›è¡Œhelmå…¥é—¨çš„åŒå­¦å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚</p><span id="more"></span><h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>æœ¬æ–‡ä¼šåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†æ¥æ¢è®¨å¦‚ä½•åœ¨æœ¬åœ°å¼€å‘chartï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul><li>Chartçš„è§„èŒƒ</li><li>Helmæä¾›çš„æœ¬åœ°å¼€å‘åŠŸèƒ½</li></ul><h1 id="Chartçš„è§„èŒƒ"><a href="#Chartçš„è§„èŒƒ" class="headerlink" title="Chartçš„è§„èŒƒ"></a>Chartçš„è§„èŒƒ</h1><p>æ ¹æ®å®šä¹‰ï¼Œä¸€ä¸ªChartæ˜¯ä¸€äº›æœ‰ç›¸å…³æ€§çš„Kubernetesèµ„æºçš„é›†åˆã€‚ä¸€ä¸ªchartå¯ä»¥æ˜¯ä¸€ä¸ªç®€å•çš„åº”ç”¨ï¼Œæ¯”å¦‚memcachedï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªå¤æ‚çš„é›†åˆï¼Œæ¯”å¦‚ä¸€ä¸ªfull-stackçš„webçš„åº”ç”¨ï¼Œå«æœ‰serverï¼Œuiï¼Œdatabaseï¼Œcacheç­‰ç­‰ã€‚</p><p>Chartä»æœ¬è´¨ä¸Šåªä¸è¿‡æ˜¯ä¸€äº›æ–‡ä»¶ï¼Œä¸è¿‡è¿™äº›æ–‡ä»¶éœ€è¦æ»¡è¶³ä¸€å®šçš„è§„èŒƒï¼Œæ¯”å¦‚ç›®å½•çš„è§„èŒƒå’Œæ–‡ä»¶åçš„è§„èŒƒã€‚</p><h2 id="Chartçš„ç›®å½•ç»“æ„"><a href="#Chartçš„ç›®å½•ç»“æ„" class="headerlink" title="Chartçš„ç›®å½•ç»“æ„"></a>Chartçš„ç›®å½•ç»“æ„</h2><p>æ ¹æ®è§„å®šï¼Œç¬¦åˆå¦‚ä¸‹ç›®å½•ç»“æ„çš„ç›®å½•å°±æ˜¯ä¸€ä¸ªChartï¼Œç›®å½•åå³ä¸ºChartåï¼ˆä¸åŒ…å«ç‰ˆæœ¬ä¿¡æ¯ï¼‰ï¼š</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wordpress/</span><br><span class="line">  Chart.yaml          <span class="comment"># A YAML file containing information about the chart</span></span><br><span class="line">  LICENSE             <span class="comment"># OPTIONAL: A plain text file containing the license for the chart</span></span><br><span class="line">  README.md           <span class="comment"># OPTIONAL: A human-readable README file</span></span><br><span class="line">  requirements.yaml   <span class="comment"># OPTIONAL: A YAML file listing dependencies for the chart</span></span><br><span class="line">  values.yaml         <span class="comment"># The default configuration values for this chart</span></span><br><span class="line">  charts/             <span class="comment"># OPTIONAL: A directory containing any charts upon which this chart depends.</span></span><br><span class="line">  templates/          <span class="comment"># OPTIONAL: A directory of templates that, when combined with values,</span></span><br><span class="line">                      <span class="comment"># will generate valid Kubernetes manifest files.</span></span><br><span class="line">  templates/NOTES.txt <span class="comment"># OPTIONAL: A plain text file containing short usage notes</span></span><br></pre></td></tr></table></figure><p>è™½ç„¶è¿™é‡Œçœ‹åˆ°chartså’Œtemplatesæ–‡ä»¶å¤¹éƒ½æ˜¯optionalçš„ï¼Œä½†æ˜¯è‡³å°‘éœ€è¦æœ‰ä¸€ä¸ªå­˜åœ¨ï¼Œchartæ‰æ˜¯åˆæ³•çš„ã€‚</p><h2 id="Chart-yamlæ–‡ä»¶"><a href="#Chart-yamlæ–‡ä»¶" class="headerlink" title="Chart.yamlæ–‡ä»¶"></a>Chart.yamlæ–‡ä»¶</h2><p>æ¯ä¸ªChartéƒ½å¿…é¡»æœ‰ä¸€ä¸ª<code>Chart.yaml</code>æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">The</span> <span class="string">name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">chart</span> <span class="string">(required)</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">A</span> <span class="string">SemVer</span> <span class="number">2</span> <span class="string">version</span> <span class="string">(required)</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">A</span> <span class="string">single-sentence</span> <span class="string">description</span> <span class="string">of</span> <span class="string">this</span> <span class="string">project</span> <span class="string">(optional)</span></span><br><span class="line"><span class="attr">keywords:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">A</span> <span class="string">list</span> <span class="string">of</span> <span class="string">keywords</span> <span class="string">about</span> <span class="string">this</span> <span class="string">project</span> <span class="string">(optional)</span></span><br><span class="line"><span class="attr">home:</span> <span class="string">The</span> <span class="string">URL</span> <span class="string">of</span> <span class="string">this</span> <span class="string">project&#x27;s</span> <span class="string">home</span> <span class="string">page</span> <span class="string">(optional)</span></span><br><span class="line"><span class="attr">sources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">A</span> <span class="string">list</span> <span class="string">of</span> <span class="string">URLs</span> <span class="string">to</span> <span class="string">source</span> <span class="string">code</span> <span class="string">for</span> <span class="string">this</span> <span class="string">project</span> <span class="string">(optional)</span></span><br><span class="line"><span class="attr">maintainers:</span> <span class="comment"># (optional)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">The</span> <span class="string">maintainer&#x27;s</span> <span class="string">name</span> <span class="string">(required</span> <span class="string">for</span> <span class="string">each</span> <span class="string">maintainer)</span></span><br><span class="line">    <span class="attr">email:</span> <span class="string">The</span> <span class="string">maintainer&#x27;s</span> <span class="string">email</span> <span class="string">(optional</span> <span class="string">for</span> <span class="string">each</span> <span class="string">maintainer)</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">A</span> <span class="string">URL</span> <span class="string">for</span> <span class="string">the</span> <span class="string">maintainer</span> <span class="string">(optional</span> <span class="string">for</span> <span class="string">each</span> <span class="string">maintainer)</span></span><br><span class="line"><span class="attr">engine:</span> <span class="string">gotpl</span> <span class="comment"># The name of the template engine (optional, defaults to gotpl)</span></span><br><span class="line"><span class="attr">icon:</span> <span class="string">A</span> <span class="string">URL</span> <span class="string">to</span> <span class="string">an</span> <span class="string">SVG</span> <span class="string">or</span> <span class="string">PNG</span> <span class="string">image</span> <span class="string">to</span> <span class="string">be</span> <span class="string">used</span> <span class="string">as</span> <span class="string">an</span> <span class="string">icon</span> <span class="string">(optional).</span></span><br><span class="line"><span class="attr">appVersion:</span> <span class="string">The</span> <span class="string">version</span> <span class="string">of</span> <span class="string">the</span> <span class="string">app</span> <span class="string">that</span> <span class="string">this</span> <span class="string">contains</span> <span class="string">(optional).</span> <span class="string">This</span> <span class="string">needn&#x27;t</span> <span class="string">be</span> <span class="string">SemVer.</span></span><br><span class="line"><span class="attr">deprecated:</span> <span class="string">Whether</span> <span class="string">or</span> <span class="string">not</span> <span class="string">this</span> <span class="string">chart</span> <span class="string">is</span> <span class="string">deprecated</span> <span class="string">(optional,</span> <span class="string">boolean)</span></span><br><span class="line"><span class="attr">tillerVersion: The version of Tiller that this chart requires. This should be expressed as a SemVer range:</span> <span class="string">&quot;&gt;2.0.0&quot;</span> <span class="string">(optional)</span></span><br></pre></td></tr></table></figure><h2 id="Chartçš„ç‰ˆæœ¬"><a href="#Chartçš„ç‰ˆæœ¬" class="headerlink" title="Chartçš„ç‰ˆæœ¬"></a>Chartçš„ç‰ˆæœ¬</h2><p>æ¯ä¸ªChartéƒ½å¿…é¡»æœ‰ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œç‰ˆæœ¬å·å¿…é¡»éµå®ˆ<a href="http://semver.org/">è¯­ä¹‰åŒ–ç‰ˆæœ¬è§„èŒƒV2</a>ã€‚æ¯ä¸ªpackageï¼ˆChartæ‰“åŒ…åçš„ä¸œè¥¿ï¼‰åŒæ—¶ç”±nameå’Œversionæ¥å”¯ä¸€ç¡®å®šã€‚</p><p>æ¯”å¦‚ï¼Œä¸€ä¸ªå«åš<code>nginx</code>çš„ç‰ˆæœ¬ä¸º<code>1.2.3</code>çš„Chartï¼Œæ‰“åŒ…åå°±æ˜¯<code>nginx-1.2.3.tgz</code>ã€‚</p><p>æ›´å¤æ‚çš„è¯­ä¹‰åŒ–ç‰ˆæœ¬å·æ˜¯è¢«æ”¯æŒçš„ï¼Œæ¯”å¦‚<code>version: 1.2.3-alpha.1+ef365</code>ä½†æ˜¯éè¯­ä¹‰åŒ–çš„ç‰ˆæœ¬æ˜¯ä¸è¢«å…è®¸çš„ã€‚</p><p>Helmå’ŒTilleréƒ½ä¼šä½¿ç”¨Chartçš„åç§°+ç‰ˆæœ¬æ¥å”¯ä¸€æ ‡è¯†ä¸€ä¸ªpackageï¼Œæ‰€ä»¥Chart.yamlé‡Œé¢çš„ç‰ˆæœ¬ä¸€å®šè¦å¯¹åº”packageçš„æ–‡ä»¶åã€‚</p><h2 id="appVersion"><a href="#appVersion" class="headerlink" title="appVersion"></a>appVersion</h2><p>appVersionå…¶å®å¹¶æ²¡å•¥ç”¨ï¼Œåªæ˜¯æŒ‡å®šäº†ChartåŒ…å«çš„åº”ç”¨çš„ç‰ˆæœ¬ï¼Œå¯¹helmå’Œtilleræ¥è¯´å¹¶ä¸ä¼šæœ‰å•¥å½±å“ï¼Œä¹Ÿä¸éœ€è¦å’ŒChartçš„versionä¸€è‡´ã€‚è‡ªå·±éšä¾¿å†™éƒ½å¯ä»¥â€¦â€¦</p><h2 id="Deprecating-Chart"><a href="#Deprecating-Chart" class="headerlink" title="Deprecating Chart"></a>Deprecating Chart</h2><p>å¯ä»¥é€šè¿‡åœ¨<code>Chart.yaml</code>é‡Œé¢æŠŠ<code>deprecated</code>è®¾ä¸º<code>true</code>æ¥æ ‡è¯†ä¸€ä¸ªChartå·²ç»æ˜¯deprecatedçŠ¶æ€ã€‚</p><h2 id="Licenseï¼ŒReadMEå’ŒNotes"><a href="#Licenseï¼ŒReadMEå’ŒNotes" class="headerlink" title="Licenseï¼ŒReadMEå’ŒNotes"></a>Licenseï¼ŒReadMEå’ŒNotes</h2><p>ä¸€ä¸ªChartè¿˜å¯ä»¥æœ‰Licenseæ¥æ ‡è¯†Licenseä¿¡æ¯ï¼ŒREADME.mdæ¥åŒ…å«ä¸€äº›ä»‹ç»ä¿¡æ¯ï¼Œä»¥åŠä¸€ä¸ªtemplates/NOTES.txtæ–‡ä»¶æ¥æŒ‡å¯¼å¦‚ä½•å»å®‰è£…æˆ–è€…ä½¿ç”¨ã€‚</p><p>templates/NOTES.txtæ–‡ä»¶ä¼šè¢«å½“åšæ™®é€šçš„templateæ¥å¯¹å¾…ï¼ˆæ„å‘³ç€å…¶ä¸­å¯ä»¥æœ‰å˜é‡ï¼‰ï¼Œå¹¶ä¸”ä¼šåœ¨æ¯æ¬¡<code>helm status</code>ä¹‹åå’Œ<code>helm install</code>ä¹‹åè¢«æ‰“å°åˆ°STDOUTã€‚</p><p>æ¯”å¦‚<code>stable/mysql</code>çš„NOTES.txtå¦‚ä¸‹ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">MySQL can be accessed via<span class="built_in"> port </span>3306 on the following<span class="built_in"> DNS </span>name <span class="keyword">from</span> within your cluster:</span><br><span class="line">&#123;&#123; template <span class="string">&quot;mysql.fullname&quot;</span> . &#125;&#125;.&#123;&#123; .Release.Namespace &#125;&#125;.svc.cluster.local</span><br><span class="line"></span><br><span class="line"><span class="keyword">To</span> <span class="builtin-name">get</span> your root password run:</span><br><span class="line"></span><br><span class="line">    <span class="attribute">MYSQL_ROOT_PASSWORD</span>=$(kubectl <span class="builtin-name">get</span><span class="built_in"> secret </span>--namespace &#123;&#123; .Release.Namespace &#125;&#125; &#123;&#123; template <span class="string">&quot;mysql.fullname&quot;</span> . &#125;&#125; -o <span class="attribute">jsonpath</span>=<span class="string">&quot;&#123;.data.mysql-root-password&#125;&quot;</span> | base64 --decode; echo)</span><br><span class="line"></span><br><span class="line"><span class="keyword">To</span> connect <span class="keyword">to</span> your database:</span><br><span class="line"></span><br><span class="line">1. <span class="builtin-name">Run</span> an Ubuntu pod that you can use as a client:</span><br><span class="line"></span><br><span class="line">    kubectl <span class="builtin-name">run</span> -i --tty ubuntu <span class="attribute">--image</span>=ubuntu:16.04 <span class="attribute">--restart</span>=Never -- bash -il</span><br><span class="line"></span><br><span class="line">2. Install the mysql client:</span><br><span class="line"></span><br><span class="line">    $ apt-<span class="builtin-name">get</span> update &amp;&amp; apt-<span class="builtin-name">get</span> install mysql-client -y</span><br><span class="line"></span><br><span class="line">3. Connect using the mysql cli, then provide your password:</span><br><span class="line">    $ mysql -h &#123;&#123; template <span class="string">&quot;mysql.fullname&quot;</span> . &#125;&#125; -p</span><br><span class="line"></span><br><span class="line"><span class="keyword">To</span> connect <span class="keyword">to</span> your database directly <span class="keyword">from</span> outside the K8s cluster:</span><br><span class="line">    &#123;&#123;- <span class="keyword">if</span> contains <span class="string">&quot;NodePort&quot;</span> .Values.service.type &#125;&#125;</span><br><span class="line">    <span class="attribute">MYSQL_HOST</span>=$(kubectl <span class="builtin-name">get</span> nodes --namespace &#123;&#123; .Release.Namespace &#125;&#125; -o <span class="attribute">jsonpath</span>=<span class="string">&#x27;&#123;.items[0].status.addresses[0].address&#125;&#x27;</span>)</span><br><span class="line">    <span class="attribute">MYSQL_PORT</span>=$(kubectl <span class="builtin-name">get</span> svc --namespace &#123;&#123; .Release.Namespace &#125;&#125; &#123;&#123; template <span class="string">&quot;mysql.fullname&quot;</span> . &#125;&#125; -o <span class="attribute">jsonpath</span>=<span class="string">&#x27;&#123;.spec.ports[0].nodePort&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    &#123;&#123;- <span class="keyword">else</span> <span class="keyword">if</span> contains <span class="string">&quot;ClusterIP&quot;</span> .Values.service.type &#125;&#125;</span><br><span class="line">    <span class="attribute">MYSQL_HOST</span>=127.0.0.1</span><br><span class="line">    MYSQL_PORT=&#123;&#123;<span class="built_in"> default </span><span class="string">&quot;3306&quot;</span> .Values.service.port &#125;&#125;</span><br><span class="line"></span><br><span class="line">    # Execute the following commands <span class="keyword">to</span><span class="built_in"> route </span>the connection:</span><br><span class="line">    <span class="builtin-name">export</span> <span class="attribute">POD_NAME</span>=$(kubectl <span class="builtin-name">get</span> pods --namespace &#123;&#123; .Release.Namespace &#125;&#125; -l <span class="string">&quot;app=&#123;&#123; template &quot;</span>mysql.fullname<span class="string">&quot; . &#125;&#125;&quot;</span> -o <span class="attribute">jsonpath</span>=<span class="string">&quot;&#123;.items[0].metadata.name&#125;&quot;</span>)</span><br><span class="line">    kubectl port-forward <span class="variable">$POD_NAME</span> &#123;&#123;<span class="built_in"> default </span><span class="string">&quot;3306&quot;</span> .Values.service.port &#125;&#125;:&#123;&#123;<span class="built_in"> default </span><span class="string">&quot;3306&quot;</span> .Values.service.port &#125;&#125;</span><br><span class="line"></span><br><span class="line">    &#123;&#123;- end &#125;&#125;</span><br><span class="line"></span><br><span class="line">    mysql -h <span class="variable">$&#123;MYSQL_HOST&#125;</span> -P<span class="variable">$&#123;MYSQL_PORT&#125;</span> -u root -p<span class="variable">$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥ï¼ŒNOTES.txtæ˜¯ç”¨æ¥ç»™ç”¨æˆ·ä½œä½¿ç”¨ä¸Šçš„æŒ‡å¯¼çš„ã€‚</p><h2 id="Chartçš„ä¾èµ–"><a href="#Chartçš„ä¾èµ–" class="headerlink" title="Chartçš„ä¾èµ–"></a>Chartçš„ä¾èµ–</h2><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œè½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¤ç”¨æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼ŒåŒæ ·çš„ï¼ŒChartä¹Ÿå¯ä»¥ä¾èµ–äºå…¶å®ƒçš„Chartï¼Œå¯ä»¥å¤ç”¨å…¶å®ƒçš„Chartçš„å†…å®¹ã€‚</p><h3 id="ä½¿ç”¨requirements-yaml"><a href="#ä½¿ç”¨requirements-yaml" class="headerlink" title="ä½¿ç”¨requirements.yaml"></a>ä½¿ç”¨requirements.yaml</h3><p>Helmæä¾›äº†ä¸¤ç§å¯¹Chartå¤ç”¨çš„æ–¹æ³•ï¼Œç¬¬ä¸€ç§æ˜¯åœ¨<code>requirements.yaml</code>ä¸­æŒ‡å®šä¾èµ–çš„Chartï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">1.2</span><span class="number">.3</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">http://example.com/charts</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">3.2</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">http://another.example.com/charts</span></span><br></pre></td></tr></table></figure><p>å¦‚æœè¯´éœ€è¦å¯¹ä¸€ä¸ªchartå¤ç”¨å¤šæ¬¡ï¼Œå¯ä»¥è¿™ä¹ˆå¹²ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># parentchart/requirements.yaml</span></span><br><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">subchart</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">http://localhost:10191</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">new-subchart-1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">subchart</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">http://localhost:10191</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">new-subchart-2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">subchart</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">http://localhost:10191</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br></pre></td></tr></table></figure><p>é™¤æ­¤ä¹‹å¤–ï¼ŒHelmè¿˜å¯ä»¥é€‰æ‹©æ€§çš„å»ä½¿ç”¨ä¾èµ–çš„chartï¼Œå…·ä½“å¯ä»¥å‚è€ƒ<a href="https://docs.helm.sh/developing_charts/#tags-and-condition-fields-in-requirements-yaml">tags and condition</a>ã€‚</p><h3 id="ç›´æ¥ä½¿ç”¨chartsæ¥æ‰‹åŠ¨ç®¡ç†"><a href="#ç›´æ¥ä½¿ç”¨chartsæ¥æ‰‹åŠ¨ç®¡ç†" class="headerlink" title="ç›´æ¥ä½¿ç”¨chartsæ¥æ‰‹åŠ¨ç®¡ç†"></a>ç›´æ¥ä½¿ç”¨chartsæ¥æ‰‹åŠ¨ç®¡ç†</h3><p>ç¬¬äºŒç§æ˜¯ç›´æ¥æŠŠéœ€è¦ç”¨çš„Chartæ”¾åˆ°<code>charts</code>æ–‡ä»¶å¤¹ä¸‹ã€‚ä¸€èˆ¬æƒ…å†µä¸‹æ¨èä½¿ç”¨ç¬¬ä¸€ç§ï¼Œç¬¬äºŒç§æ˜¯åœ¨éœ€è¦å¯¹ä¾èµ–çš„chartåšé­”æ”¹çš„æƒ…å†µä¸‹ç”¨åˆ°çš„ã€‚</p><p>Helmè¿˜æä¾›äº†<code>helm dep</code>è¿™ä¸ªå‘½ä»¤æ¥æ–¹ä¾¿å¯¹ä¾èµ–çš„ç®¡ç†ï¼Œä¹‹åä¼šä»‹ç»åˆ°ã€‚</p><h3 id="ä¾èµ–çš„ä¸€äº›å®ç°ç»†èŠ‚"><a href="#ä¾èµ–çš„ä¸€äº›å®ç°ç»†èŠ‚" class="headerlink" title="ä¾èµ–çš„ä¸€äº›å®ç°ç»†èŠ‚"></a>ä¾èµ–çš„ä¸€äº›å®ç°ç»†èŠ‚</h3><p>åœ¨<code>helm install</code>å’Œ<code>helm upgrade</code>çš„æ—¶å€™ï¼Œhelmä¼šæŠŠä¾èµ–å’Œå½“å‰chartæ‰“åŒ…æˆä¸€ä¸ªé›†åˆä¸€èµ·é€ç»™tillerï¼Œç„¶åï¼ˆç›®å‰æ˜¯ï¼‰æŒ‰ç…§ç±»å‹+å­—æ¯é¡ºåºæ¥applyï¼Œå¹¶ä¸æ˜¯å…ˆå»installä¾èµ–å†å»installå½“å‰çš„chartã€‚</p><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªchartï¼Œä¼šæœ‰ä»¥ä¸‹ä¸‰ä¸ªä¸œè¥¿ï¼š</p><ul><li>namespace â€œA-Namespaceâ€</li><li>statefulset â€œA-StatefulSetâ€</li><li>service â€œA-Serviceâ€</li></ul><p>è¿™ä¸ªchartä¾èµ–äºå¦ä¸€ä¸ªchartï¼Œæœ‰å¦‚ä¸‹ä¸‰ä¸ªä¸œè¥¿ï¼š</p><ul><li>namespace â€œB-Namespaceâ€</li><li>replicaset â€œB-ReplicaSetâ€</li><li>service â€œB-Serviceâ€</li></ul><p>é‚£ä¹ˆåœ¨å®‰è£…æˆ–è€…å‡çº§çš„è¿‡ç¨‹ä¸­ï¼Œé¡ºåºå¦‚ä¸‹ï¼š</p><ul><li>A-Namespace</li><li>B-Namespace</li><li>A-StatefulSet</li><li>B-ReplicaSet</li><li>A-Service</li><li>B-Service</li></ul><h1 id="Helmå®¢æˆ·ç«¯æä¾›çš„å’Œæœ¬åœ°å¼€å‘ç›¸å…³çš„åŠŸèƒ½"><a href="#Helmå®¢æˆ·ç«¯æä¾›çš„å’Œæœ¬åœ°å¼€å‘ç›¸å…³çš„åŠŸèƒ½" class="headerlink" title="Helmå®¢æˆ·ç«¯æä¾›çš„å’Œæœ¬åœ°å¼€å‘ç›¸å…³çš„åŠŸèƒ½"></a>Helmå®¢æˆ·ç«¯æä¾›çš„å’Œæœ¬åœ°å¼€å‘ç›¸å…³çš„åŠŸèƒ½</h1><p>Helmçš„å®¢æˆ·ç«¯æä¾›äº†ä¸€äº›å’Œæœ¬åœ°å¼€å‘ç›¸å…³çš„å‘½ä»¤ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹ã€‚</p><h2 id="helm-completion"><a href="#helm-completion" class="headerlink" title="helm completion"></a>helm completion</h2><p>é¡¾åæ€ä¹‰ï¼Œæä¾›äº†å‘½ä»¤è¡¥å…¨ï¼Œä½¿ç”¨æ–¹å¼ä¹Ÿæ¯”è¾ƒç®€å•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">source</span> &lt;(helm completion zsh)</span></span><br></pre></td></tr></table></figure><h2 id="helm-create"><a href="#helm-create" class="headerlink" title="helm create"></a>helm create</h2><p>å¯ä»¥é€šè¿‡è¿™ä¸ªå‘½ä»¤ç›´æ¥åˆ›å»ºå‡ºä¸€ä¸ªç¬¦åˆChartè§„èŒƒçš„ç›®å½•å‡ºæ¥ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> helm create myweb</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tree myweb</span></span><br><span class="line">myweb</span><br><span class="line">â”œâ”€â”€ Chart.yaml</span><br><span class="line">â”œâ”€â”€ charts</span><br><span class="line">â”œâ”€â”€ templates</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ NOTES.txt</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ _helpers.tpl</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ deployment.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ ingress.yaml</span><br><span class="line">â”‚Â Â  â””â”€â”€ service.yaml</span><br><span class="line">â””â”€â”€ values.yaml</span><br><span class="line"></span><br><span class="line">2 directories, 7 files</span><br></pre></td></tr></table></figure><h2 id="helm-dependency"><a href="#helm-dependency" class="headerlink" title="helm dependency"></a>helm dependency</h2><p>é¡¾åæ€ä¹‰ï¼Œæ˜¯ç”¨æ¥è¿›è¡Œä¾èµ–ç®¡ç†çš„ï¼Œå¯ä»¥è¢«ç®€å†™ä¸º<code>helm dep</code>ï¼Œå…·ä½“ä½¿ç”¨å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> helm dep</span></span><br><span class="line">Manage the dependencies of a chart.</span><br><span class="line"></span><br><span class="line">Helm charts store their dependencies in &#x27;charts/&#x27;. For chart developers, it is</span><br><span class="line">often easier to manage a single dependency file (&#x27;requirements.yaml&#x27;)</span><br><span class="line">which declares all dependencies.</span><br><span class="line"></span><br><span class="line">The dependency commands operate on that file, making it easy to synchronize</span><br><span class="line">between the desired dependencies and the actual dependencies stored in the</span><br><span class="line">&#x27;charts/&#x27; directory.</span><br><span class="line"></span><br><span class="line">A &#x27;requirements.yaml&#x27; file is a YAML file in which developers can declare chart</span><br><span class="line">dependencies, along with the location of the chart and the desired version.</span><br><span class="line">For example, this requirements file declares two dependencies:</span><br><span class="line"></span><br><span class="line">    # requirements.yaml</span><br><span class="line">    dependencies:</span><br><span class="line">    - name: nginx</span><br><span class="line">      version: &quot;1.2.3&quot;</span><br><span class="line">      repository: &quot;https://example.com/charts&quot;</span><br><span class="line">    - name: memcached</span><br><span class="line">      version: &quot;3.2.1&quot;</span><br><span class="line">      repository: &quot;https://another.example.com/charts&quot;</span><br><span class="line"></span><br><span class="line">The &#x27;name&#x27; should be the name of a chart, where that name must match the name</span><br><span class="line">in that chart&#x27;s &#x27;Chart.yaml&#x27; file.</span><br><span class="line"></span><br><span class="line">The &#x27;version&#x27; field should contain a semantic version or version range.</span><br><span class="line"></span><br><span class="line">The &#x27;repository&#x27; URL should point to a Chart Repository. Helm expects that by</span><br><span class="line">appending &#x27;/index.yaml&#x27; to the URL, it should be able to retrieve the chart</span><br><span class="line">repository&#x27;s index. Note: &#x27;repository&#x27; can be an alias. The alias must start</span><br><span class="line">with &#x27;alias:&#x27; or &#x27;@&#x27;.</span><br><span class="line"></span><br><span class="line">Starting from 2.2.0, repository can be defined as the path to the directory of</span><br><span class="line">the dependency charts stored locally. The path should start with a prefix of</span><br><span class="line">&quot;file://&quot;. For example,</span><br><span class="line"></span><br><span class="line">    # requirements.yaml</span><br><span class="line">    dependencies:</span><br><span class="line">    - name: nginx</span><br><span class="line">      version: &quot;1.2.3&quot;</span><br><span class="line">      repository: &quot;file://../dependency_chart/nginx&quot;</span><br><span class="line"></span><br><span class="line">If the dependency chart is retrieved locally, it is not required to have the</span><br><span class="line">repository added to helm by &quot;helm add repo&quot;. Version matching is also supported</span><br><span class="line">for this case.</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  helm dependency [command]</span><br><span class="line"></span><br><span class="line">Aliases:</span><br><span class="line">  dependency, dep, dependencies</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  build       rebuild the charts/ directory based on the requirements.lock file</span><br><span class="line">  list        list the dependencies for the given chart</span><br><span class="line">  update      update charts/ based on the contents of requirements.yaml</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  -h, --help   help for dependency</span><br><span class="line"></span><br><span class="line">Use &quot;helm dependency [command] --help&quot; for more information about a command.</span><br></pre></td></tr></table></figure><h2 id="helm-fetch"><a href="#helm-fetch" class="headerlink" title="helm fetch"></a>helm fetch</h2><p>ä¸€çœ‹è¿™å°±æ˜¯ä¸ªä¸‹è½½åˆ«çš„chartçš„å‘½ä»¤ï¼Œä¸ºå•¥æˆ‘è¦è¯´å’Œæœ¬åœ°å¼€å‘æœ‰å…³ç³»å‘¢ï¼Ÿ</p><p>å› ä¸ºæˆ‘è®¤ä¸ºï¼Œhelmçš„å®˜æ–¹repoé‡Œé¢çš„chartæœ€å¤§çš„ä½œç”¨å°±æ˜¯ä½œä¸ºä¸€ä¸ªbest practiceæ¥å±•ç¤ºç»™ä½¿ç”¨è€…ä¸€ä¸ªç¤ºä¾‹ã€‚</p><p>æ‰€ä»¥ï¼Œå½“ä¸çŸ¥é“è¯¥æ€ä¹ˆå†™çš„æ—¶å€™ï¼Œå»æŠ„å§ğŸ˜ã€‚</p><h2 id="helm-lint"><a href="#helm-lint" class="headerlink" title="helm lint"></a>helm lint</h2><p>é¡¾åæ€ä¹‰ï¼Œç”¨æ¥æ£€æŸ¥ä¸€ä¸ªChartæ˜¯å¦å­˜åœ¨é—®é¢˜ã€‚</p><p>å¦‚æœè¯´æœ‰é”™è¯¯ï¼Œä¼šæŠ¥å‡ºerrorï¼Œå¹¶è¿”å›éé›¶å€¼ã€‚</p><p>æˆ‘ä»¬å°±ç”¨åˆšæ‰çš„mywebæ¥è¯•æ‰‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> helm lint myweb</span></span><br><span class="line">==&gt; Linting myweb</span><br><span class="line">[INFO] Chart.yaml: icon is recommended</span><br><span class="line"></span><br><span class="line">1 chart(s) linted, no failures</span><br></pre></td></tr></table></figure><h2 id="helm-package"><a href="#helm-package" class="headerlink" title="helm package"></a>helm package</h2><p>è¿™ä¸ªå‘½ä»¤æ˜¯å½“ä¸€ä¸ªchartå†™å®Œåç”¨æ¥æŠŠä¸€ä¸ªchartæ‰“åŒ…æˆ<code>chartName-version.tgz</code>çš„ã€‚ä¸€èˆ¬åªæœ‰åœ¨å‘å¸ƒçš„æ—¶å€™ä½¿ç”¨ï¼Œæä¾›äº†æ¯”è¾ƒå¤šçš„åŠŸèƒ½ï¼Œæ¯”å¦‚signä¹‹ç±»çš„ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> helm package --<span class="built_in">help</span></span></span><br><span class="line">This command packages a chart into a versioned chart archive file. If a path</span><br><span class="line">is given, this will look at that path for a chart (which must contain a</span><br><span class="line">Chart.yaml file) and then package that directory.</span><br><span class="line"></span><br><span class="line">If no path is given, this will look in the present working directory for a</span><br><span class="line">Chart.yaml file, and (if found) build the current directory into a chart.</span><br><span class="line"></span><br><span class="line">Versioned chart archives are used by Helm package repositories.</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  helm package [flags] [CHART_PATH] [...]</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  -u, --dependency-update    update dependencies from &quot;requirements.yaml&quot; to dir &quot;charts/&quot; before packaging</span><br><span class="line">  -d, --destination string   location to write the chart. (default &quot;.&quot;)</span><br><span class="line">      --key string           name of the key to use when signing. Used if --sign is true</span><br><span class="line">      --keyring string       location of a public keyring (default &quot;/Users/daniel/.gnupg/pubring.gpg&quot;)</span><br><span class="line">      --save                 save packaged chart to local chart repository (default true)</span><br><span class="line">      --sign                 use a PGP private key to sign this package</span><br><span class="line">      --version string       set the version on the chart to this semver version</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿˜æ˜¯ç”¨åˆšæ‰çš„mywebä½œä¸ºä¾‹å­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> helm package myweb</span></span><br><span class="line">Successfully packaged chart and saved it to: /Users/daniel/Works/k8s/helm/myweb-0.1.0.tgz</span><br></pre></td></tr></table></figure><h2 id="helm-serve"><a href="#helm-serve" class="headerlink" title="helm serve"></a>helm serve</h2><p>è¿™ä¸ªå‘½ä»¤æ˜¯ç”¨æ¥åœ¨æœ¬åœ°å¼€å¯ä¸€ä¸ªrepo serverçš„ï¼Œå¯ä»¥ç”¨æ¥æœ¬åœ°æµ‹è¯•ä½¿ç”¨ã€‚</p><h2 id="helm-template"><a href="#helm-template" class="headerlink" title="helm template"></a>helm template</h2><p>è¿™ä¸ªå‘½ä»¤å¯ä»¥åœ¨æœ¬åœ°æ¸²æŸ“å‡ºtemplateæ¥æ£€æŸ¥æ˜¯å¦æ­£ç¡®ï¼Œå…·ä½“ä½¿ç”¨å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> helm template --<span class="built_in">help</span></span></span><br><span class="line">Render chart templates locally and display the output.</span><br><span class="line"></span><br><span class="line">This does not require Tiller. However, any values that would normally be</span><br><span class="line">looked up or retrieved in-cluster will be faked locally. Additionally, none</span><br><span class="line">of the server-side testing of chart validity (e.g. whether an API is supported)</span><br><span class="line">is done.</span><br><span class="line"></span><br><span class="line">To render just one template in a chart, use &#x27;-x&#x27;:</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> helm template mychart -x templates/deployment.yaml</span></span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  helm template [flags] CHART</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  -x, --execute stringArray    only execute the given templates</span><br><span class="line">      --kube-version string    override the Kubernetes version used as Capabilities.KubeVersion.Major/Minor (e.g. 1.7)</span><br><span class="line">  -n, --name string            release name (default &quot;RELEASE-NAME&quot;)</span><br><span class="line">      --name-template string   specify template used to name the release</span><br><span class="line">      --namespace string       namespace to install the release into</span><br><span class="line">      --notes                  show the computed NOTES.txt file as well</span><br><span class="line">      --set stringArray        set values on the command line (can specify multiple or separate values with commas: key1=val1,key2=val2)</span><br><span class="line">  -f, --values valueFiles      specify values in a YAML file (can specify multiple) (default [])</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä»ç„¶ä»¥mywebä½œä¸ºä¾‹å­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> helm template myweb</span></span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span><span class="bash"> Source: myweb/templates/service.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: RELEASE-NAME-myweb</span><br><span class="line">  labels:</span><br><span class="line">    app: myweb</span><br><span class="line">    chart: myweb-0.1.0</span><br><span class="line">    release: RELEASE-NAME</span><br><span class="line">    heritage: Tiller</span><br><span class="line">spec:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">    - port: 80</span><br><span class="line">      targetPort: 80</span><br><span class="line">      protocol: TCP</span><br><span class="line">      name: nginx</span><br><span class="line">  selector:</span><br><span class="line">    app: myweb</span><br><span class="line">    release: RELEASE-NAME</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span><span class="bash"> Source: myweb/templates/deployment.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: RELEASE-NAME-myweb</span><br><span class="line">  labels:</span><br><span class="line">    app: myweb</span><br><span class="line">    chart: myweb-0.1.0</span><br><span class="line">    release: RELEASE-NAME</span><br><span class="line">    heritage: Tiller</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: myweb</span><br><span class="line">        release: RELEASE-NAME</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: myweb</span><br><span class="line">          image: &quot;nginx:stable&quot;</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 80</span><br><span class="line">          livenessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /</span><br><span class="line">              port: 80</span><br><span class="line">          readinessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /</span><br><span class="line">              port: 80</span><br><span class="line">          resources:</span><br><span class="line">            &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span><span class="bash"> Source: myweb/templates/ingress.yaml</span></span><br></pre></td></tr></table></figure><h2 id="helm-verify"><a href="#helm-verify" class="headerlink" title="helm verify"></a>helm verify</h2><p>è¿™ä¸ªå‘½ä»¤æ˜¯ç”¨æ¥éªŒè¯ä¸€ä¸ªç»™å®šçš„chartæ˜¯å¦è¢«signã€‚åœ¨å¯¹å®‰å…¨æ€§è¦æ±‚é«˜çš„ç¯å¢ƒä¸‹æœ‰ç”¨ã€‚</p><h2 id="helm-plugin"><a href="#helm-plugin" class="headerlink" title="helm plugin"></a>helm plugin</h2><p>æœ€åæ˜¯è¿™ä¸ª<code>helm plugin</code>ï¼Œçœ‹åˆ°è¿™ä¸ªæˆ‘ä»¬å°±èƒ½æ„Ÿè§‰åˆ°ï¼Œhelmç¬é—´æœ‰äº†æ— æ•°çš„æ‰©å±•æ€§ï¼Œéœ€è¦ä»€ä¹ˆåŠŸèƒ½å¦‚æœhelmä¸æä¾›å’±ä»¬å°±è‡ªå·±å¹²ä¸€ä¸ªåŠ ä¸Šå»ã€‚</p><p>helmç›®å‰ç°åœ¨å·²ç»æœ‰äº†ä¸€äº›æ¯”è¾ƒå¥½çš„pluginï¼Œæ¯”å¦‚æœ‰ä¸€ä¸ªpluginæ”¯æŒç”¨template renderå‡ºæ¥ä¹‹åå†è¿›è¡ŒéªŒè¯æŸ¥é”™ä¹‹ç±»çš„ã€‚</p><p>å¦‚æœæœ‰ä¸€äº›åˆ«çš„å®šåˆ¶åŒ–çš„éœ€æ±‚ä¹Ÿå¯ä»¥é€šè¿‡è‡ªå·±å†™ä¸ªpluginæ¥å®Œæˆã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://helm.sh/&quot;&gt;Helm&lt;/a&gt;æ˜¯kubernetesçš„å®˜æ–¹åŒ…ç®¡ç†å·¥å…·ã€‚æ ¹æ®å®˜ç½‘ä¸Šçš„æè¿°&lt;code&gt;Helm is the best way to find, share, and use software built for Kubernetes.&lt;/code&gt;å¯ä»¥çœ‹å‡ºhelmåœ¨kubernetesç¤¾åŒºä¸­çš„å®šä½ã€‚&lt;/p&gt;
&lt;p&gt;è¿™ç¯‡æ–‡ç« å¹¶ä¸æ˜¯helmçš„å…¥é—¨æ–‡ç« ï¼Œè€Œæ˜¯ç€é‡äºå¦‚ä½•åœ¨æœ¬åœ°å¼€å‘chartã€‚å¸Œæœ›è¿›è¡Œhelmå…¥é—¨çš„åŒå­¦å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://www.purewhite.io/categories/kubernetes/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="æ¶æ„" scheme="https://www.purewhite.io/tags/%E6%9E%B6%E6%9E%84/"/>
    
    <category term="docker" scheme="https://www.purewhite.io/tags/docker/"/>
    
    <category term="linux" scheme="https://www.purewhite.io/tags/linux/"/>
    
    <category term="è¿ç»´" scheme="https://www.purewhite.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="kubernetes" scheme="https://www.purewhite.io/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Helmä¸­å¦‚ä½•ä¼ é€’value</title>
    <link href="https://www.purewhite.io/2018/01/17/helm-provide-value/"/>
    <id>https://www.purewhite.io/2018/01/17/helm-provide-value/</id>
    <published>2018-01-17T03:25:15.000Z</published>
    <updated>2021-12-02T12:51:07.226Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://helm.sh/">Helm</a>æ˜¯kubernetesçš„å®˜æ–¹åŒ…ç®¡ç†å·¥å…·ã€‚æ ¹æ®å®˜ç½‘ä¸Šçš„æè¿°<code>Helm is the best way to find, share, and use software built for Kubernetes.</code>å¯ä»¥çœ‹å‡ºhelmåœ¨kubernetesç¤¾åŒºä¸­çš„å®šä½ã€‚</p><p>è¿™ç¯‡æ–‡ç« å¹¶ä¸æ˜¯helmçš„å…¥é—¨æ–‡ç« ï¼Œè€Œæ˜¯ç€é‡äºhelmä¸­çš„chartä¹‹é—´å¦‚ä½•ä¼ é€’valueã€‚å¸Œæœ›è¿›è¡Œhelmå…¥é—¨çš„åŒå­¦å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚</p><span id="more"></span><h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>åœ¨helmçš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šå‡ºç°ä¸¤ç§éœ€æ±‚ï¼š</p><ol><li>åœ¨çˆ¶chartä¸­<strong>è¯»å–</strong>å­chartçš„æŸäº›valueçš„å€¼</li><li>åœ¨çˆ¶chartä¸­<strong>ä¿®æ”¹</strong>å­chartçš„æŸäº›valueçš„å€¼</li></ol><p>helmå¯¹äºè¿™ä¸¤ç§åœºæ™¯æä¾›äº†æ¯”è¾ƒå®Œå¤‡çš„æ”¯æŒï¼Œä¸‹é¢æˆ‘ä»¬æ¥å…·ä½“è®²ä¸€ä¸‹è§£å†³æ–¹æ¡ˆã€‚</p><h1 id="åœ¨çˆ¶chartä¸­è¯»å–å­chartçš„å€¼"><a href="#åœ¨çˆ¶chartä¸­è¯»å–å­chartçš„å€¼" class="headerlink" title="åœ¨çˆ¶chartä¸­è¯»å–å­chartçš„å€¼"></a>åœ¨çˆ¶chartä¸­è¯»å–å­chartçš„å€¼</h1><p>helmæä¾›äº†ä¸¤ç§æ–¹æ³•æ¥åº”å¯¹è¿™ç§æƒ…å†µï¼š</p><h2 id="ä½¿ç”¨exportæ ¼å¼"><a href="#ä½¿ç”¨exportæ ¼å¼" class="headerlink" title="ä½¿ç”¨exportæ ¼å¼"></a>ä½¿ç”¨exportæ ¼å¼</h2><p>å¦‚æœè¯´ä¸€ä¸ªchildçš„chartåœ¨valuesçš„rootä¸‹æœ‰ä¸€ä¸ªå«åš<code>export</code>çš„keyï¼Œé‚£ä¹ˆå®ƒçš„parent chartå°±å¯ä»¥ç›´æ¥åœ¨requirementsé‡Œé¢é€šè¿‡æŒ‡å®šéœ€è¦importçš„keyæ¥å°†å€¼importåˆ°è‡ªèº«çš„valuesé‡Œé¢ï¼Œä¾‹å­å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># parent&#x27;s requirements.yaml file</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">import-values:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">data</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># child&#x27;s values.yaml file</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">exports:</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">myint:</span> <span class="number">99</span></span><br></pre></td></tr></table></figure><p>helmä¼šå‘ç°ï¼Œæˆ‘ä»¬æŒ‡å®šäº†è¦import <code>data</code>è¿™ä¸ªkeyï¼Œæ‰€ä»¥å°±å»childçš„values.yamlé‡Œé¢å¯»æ‰¾ï¼Œå‘ç°äº†è¿™ä¸ªkeyæœ‰è¢«exportï¼Œäºæ˜¯å°±importäº†å®ƒçš„å†…å®¹ã€‚</p><p>è¿™æ—¶å€™çš„parentçš„valueså¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># parent&#x27;s values file</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">myint:</span> <span class="number">99</span></span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„ï¼Œåœ¨parentçš„valuesä¸­<code>data</code>è¿™ä¸ªkeyä¸ä¼šè¢«importè¿›æ¥ï¼Œåªä¼šimport <code>data</code>çš„å†…å®¹ã€‚å¦‚æœå¸Œæœ›æŠŠè¿™ä¸ªkeyä¹Ÿä¸€èµ·importè¿›æ¥ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢è¯´çš„æ–¹æ³•ã€‚</p><h2 id="ä½¿ç”¨child-parentæ ¼å¼"><a href="#ä½¿ç”¨child-parentæ ¼å¼" class="headerlink" title="ä½¿ç”¨child/parentæ ¼å¼"></a>ä½¿ç”¨child/parentæ ¼å¼</h2><p>å¦‚æœæˆ‘ä»¬æƒ³è¦è·å¾—ä¸€äº›ä¸åœ¨exportsè¿™ä¸ªkeyä¸‹é¢çš„å€¼ï¼Œæˆ‘ä»¬å°±å¿…é¡»æŒ‡å®šåœ¨childä¸­è¦importçš„è·¯å¾„ï¼Œä»¥åŠåœ¨parentä¸­çš„å¯¹åº”è·¯å¾„ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># parent&#x27;s requirements.yaml file</span></span><br><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">subchart1</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">http://localhost:10191</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">import-values:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">child:</span> <span class="string">default.data</span></span><br><span class="line">        <span class="attr">parent:</span> <span class="string">myimports</span></span><br></pre></td></tr></table></figure><p>æ ¹æ®å¦‚ä¸Šçš„è¿™ä¸ªrequirementsæ–‡ä»¶ï¼Œhelmå°†ä¼šåœ¨childçš„chartä¸­å¯»æ‰¾default.dataçš„å€¼ï¼Œå¹¶å¯¼å…¥åˆ°parentä¸­çš„myimportsè¿™ä¸ªè·¯å¾„ä¸‹ã€‚</p><p>å‡è®¾parentå’Œchildåˆå§‹çš„valueså¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># parent&#x27;s values.yaml file</span></span><br><span class="line"></span><br><span class="line"><span class="attr">myimports:</span></span><br><span class="line">  <span class="attr">myint:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">mybool:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">mystring:</span> <span class="string">&quot;helm rocks!&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># subchart1&#x27;s values.yaml file</span></span><br><span class="line"></span><br><span class="line"><span class="attr">default:</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">myint:</span> <span class="number">999</span></span><br><span class="line">    <span class="attr">mybool:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå¯¼å…¥ä¹‹åï¼ŒçœŸæ­£æ¸²æŸ“å‡ºæ¥çš„parentçš„valuesçš„å€¼ä¸ºï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># parent&#x27;s final values</span></span><br><span class="line"></span><br><span class="line"><span class="attr">myimports:</span></span><br><span class="line">  <span class="attr">myint:</span> <span class="number">999</span></span><br><span class="line">  <span class="attr">mybool:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">mystring:</span> <span class="string">&quot;helm rocks!&quot;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥ï¼Œparentä¸­çš„valuesæŠŠmyintå’Œmyboolä»subchart1é‡Œé¢importäº†è¿›æ¥ã€‚</p><h1 id="åœ¨çˆ¶chartä¸­ä¿®æ”¹å­chartçš„å€¼"><a href="#åœ¨çˆ¶chartä¸­ä¿®æ”¹å­chartçš„å€¼" class="headerlink" title="åœ¨çˆ¶chartä¸­ä¿®æ”¹å­chartçš„å€¼"></a>åœ¨çˆ¶chartä¸­ä¿®æ”¹å­chartçš„å€¼</h1><p>æƒ³è¦å†çˆ¶chartä¸­ä¿®æ”¹å­chartçš„å€¼æ¯”è¾ƒå®¹æ˜“ï¼Œå‡è®¾å­chartçš„åå­—æ˜¯<code>mychartabc</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å¾ˆç®€å•åœ°åœ¨çˆ¶chartçš„valuesä¸­é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›è¡Œä¿®æ”¹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># in parent&#x27;s values.yaml</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mychartabc:</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">value</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥ä¿®æ”¹å­chartçš„å€¼äº†ã€‚</p><h1 id="å‡ºå¤„"><a href="#å‡ºå¤„" class="headerlink" title="å‡ºå¤„"></a>å‡ºå¤„</h1><p><a href="https://docs.helm.sh/developing_charts/#importing-child-values-via-requirements-yaml">https://docs.helm.sh/developing_charts/#importing-child-values-via-requirements-yaml</a></p><p><a href="https://docs.helm.sh/chart_template_guide/#overriding-values-from-a-parent-chart">https://docs.helm.sh/chart_template_guide/#overriding-values-from-a-parent-chart</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://helm.sh/&quot;&gt;Helm&lt;/a&gt;æ˜¯kubernetesçš„å®˜æ–¹åŒ…ç®¡ç†å·¥å…·ã€‚æ ¹æ®å®˜ç½‘ä¸Šçš„æè¿°&lt;code&gt;Helm is the best way to find, share, and use software built for Kubernetes.&lt;/code&gt;å¯ä»¥çœ‹å‡ºhelmåœ¨kubernetesç¤¾åŒºä¸­çš„å®šä½ã€‚&lt;/p&gt;
&lt;p&gt;è¿™ç¯‡æ–‡ç« å¹¶ä¸æ˜¯helmçš„å…¥é—¨æ–‡ç« ï¼Œè€Œæ˜¯ç€é‡äºhelmä¸­çš„chartä¹‹é—´å¦‚ä½•ä¼ é€’valueã€‚å¸Œæœ›è¿›è¡Œhelmå…¥é—¨çš„åŒå­¦å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://www.purewhite.io/categories/kubernetes/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="æ¶æ„" scheme="https://www.purewhite.io/tags/%E6%9E%B6%E6%9E%84/"/>
    
    <category term="docker" scheme="https://www.purewhite.io/tags/docker/"/>
    
    <category term="linux" scheme="https://www.purewhite.io/tags/linux/"/>
    
    <category term="è¿ç»´" scheme="https://www.purewhite.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="kubernetes" scheme="https://www.purewhite.io/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetesä¸­çš„Network</title>
    <link href="https://www.purewhite.io/2018/01/08/kubernetes-network/"/>
    <id>https://www.purewhite.io/2018/01/08/kubernetes-network/</id>
    <published>2018-01-08T08:01:50.000Z</published>
    <updated>2021-12-02T12:51:07.228Z</updated>
    
    <content type="html"><![CDATA[<p>Kubernetes å¤„ç†ç½‘ç»œçš„æ–¹å¼å’ŒDockerä¸åŒï¼Œä¸»è¦éœ€è¦è§£å†³å››ç§é—®é¢˜ï¼š</p><ol><li>é«˜åº¦è€¦åˆçš„Containerä¹‹é—´çš„ç½‘ç»œé€šä¿¡ï¼šè¿™ä¸ªç”±Podå’Œlocalhosté€šä¿¡è§£å†³äº†ï¼›</li><li>Podå’ŒPodä¹‹é—´çš„ç½‘ç»œé€šä¿¡ï¼Œè¿™ä¸ªæ˜¯æœ¬ç¯‡çš„ä¸»è¦å†…å®¹ï¼›</li><li>Podå’ŒServiceä¹‹é—´çš„é€šä¿¡ï¼Œè¿™ä¸ªæ˜¯ç”±Serviceè§£å†³çš„ï¼›</li><li>å¤–éƒ¨Serviceå’Œå†…éƒ¨Serviceä¹‹é—´çš„é€šä¿¡ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ç”±Serviceè§£å†³çš„ã€‚</li></ol><span id="more"></span><h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>Kubernetes å‡è®¾ Pod ä¹‹é—´å¯ä»¥äº’ç›¸é€šä¿¡ï¼Œæ— è®ºå®ƒä»¬åœ¨å“ªä¸ªä¸»æœºä¸Šã€‚æˆ‘ä»¬ç»™æ¯ä¸ªPodä¸€ä¸ªå•ç‹¬çš„IPåœ°å€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¸ç”¨ä¸“é—¨åœ¨Podä¹‹é—´åˆ›å»ºé“¾æ¥ï¼Œæˆ–è€…æ˜ å°„containerçš„portåˆ°ä¸»æœºçš„portæ¥ä½¿å¾—å¤–éƒ¨å¯ä»¥è®¿é—®åˆ°containeräº†ã€‚è¿™ä½¿å¾—æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªéå¸¸å¹²å‡€ï¼Œå‘åå…¼å®¹çš„æ¨¡å‹ï¼Œåœ¨è¿™ä¸ªæ¨¡å‹é‡Œé¢Podå¯ä»¥å°±è¢«å½“åšä¸ºä¸€ä¸ªVMæˆ–è€…ç”šè‡³ä¸€ä¸ªç‰©ç†æœºï¼Œè¿™ç»™äº†æˆ‘ä»¬å¾ˆå¤šæ–¹é¢çš„æ–¹ä¾¿ï¼Œæ¯”å¦‚portçš„åˆ†é…ï¼Œå‘½åï¼ŒæœåŠ¡æ³¨å†Œã€å‘ç°ï¼Œè´Ÿè½½å‡è¡¡ï¼Œåº”ç”¨ç¨‹åºè®¾ç½®å’Œè¿ç§»ç­‰ã€‚</p><p>ä¸ºäº†è¾¾æˆè¿™ä¸ªç›®æ ‡ï¼Œæˆ‘ä»¬å¿…é¡»è§„å®šå¦‚ä½•è®¾ç½®é›†ç¾¤çš„ç½‘ç»œã€‚</p><h1 id="Dockerçš„æ¨¡å‹"><a href="#Dockerçš„æ¨¡å‹" class="headerlink" title="Dockerçš„æ¨¡å‹"></a>Dockerçš„æ¨¡å‹</h1><p>åœ¨è®¨è®ºKuberneteså¤„ç†ç½‘ç»œçš„æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå¤ä¹ ä¸€ä¸‹Dockeræ˜¯å¦‚ä½•å¤„ç†ç½‘ç»œçš„ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒDockerç”¨çš„æ˜¯ä¸»æœºç§æœ‰çš„ç½‘ç»œï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šåˆ›å»ºä¸€ä¸ªå«åšdocker0çš„è™šæ‹Ÿç½‘æ¡¥ï¼Œå¹¶ä¸”åˆ†é…ä¸€æ®µå­ç½‘ç»™å®ƒã€‚å¯¹äºæ¯ä¸ªDockeråˆ›å»ºçš„containerï¼Œéƒ½ä¼šåˆ†é…ä¸€ä¸ªè™šæ‹Ÿçš„é™„åŠ äºè¿™ä¸ªç½‘æ¡¥çš„ç½‘ç»œè®¾å¤‡ï¼ˆè¢«ç§°ä¸º<code>veth</code>ï¼‰ï¼Œè¿™ä¸ª<code>veth</code>å…¶å®æ˜¯é€šè¿‡linuxçš„namespaceæ¥æ˜ å°„åˆ°containeré‡Œé¢çš„<code>eth0</code>çš„ã€‚è¿™ä¸ªå®¹å™¨é‡Œçš„<code>eth0</code>ä¼šè¢«åˆ†é…ä¸€ä¸ªè™šæ‹Ÿç½‘æ¡¥çš„ç½‘æ®µé‡Œé¢çš„IPåœ°å€ã€‚</p><p>ç»“æœå°±æ˜¯ï¼ŒDockerçš„å®¹å™¨åªèƒ½å’Œåœ¨åŒä¸€ä¸ªæœºå™¨ï¼ˆä¹Ÿå°±æ˜¯åœ¨åŒä¸€ä¸ªç½‘æ¡¥ï¼‰é‡Œé¢çš„å®¹å™¨äº¤æµï¼Œä¸èƒ½å’Œå¤–éƒ¨åˆ«çš„æœºå™¨ä¸Šçš„å®¹å™¨ä¹‹é—´å»ºç«‹è¿æ¥ã€‚äº‹å®ä¸Šï¼Œä¸åŒæœºå™¨ä¸Šçš„å®¹å™¨ï¼Œå¯èƒ½ä¼šæœ‰åŒæ ·çš„ç½‘æ®µå’ŒIPåœ°å€ã€‚</p><p>å¦‚æœè¯´è¦è®©Dockerå®¹å™¨èƒ½è·¨Nodeäº¤æµï¼Œé‚£ä¹ˆå¿…é¡»ç»™ä»–ä»¬åˆ†é…ä¸»æœºä¸Šçš„portï¼Œå¹¶é€šè¿‡è¿™ä¸ªportå’Œä¸»æœºIPæ¥å”¯ä¸€ç¡®å®šä¸€ä¸ªå®¹å™¨çš„åœ°å€ï¼Œç„¶åä¸»æœºä¼šæŠŠè¯·æ±‚è½¬å‘ç»™containerã€‚è¿™æ˜¾ç„¶ä¼šå¸¦æ¥å¾ˆå¤šçš„é—®é¢˜ã€‚</p><h1 id="Kubernetesçš„æ¨¡å‹"><a href="#Kubernetesçš„æ¨¡å‹" class="headerlink" title="Kubernetesçš„æ¨¡å‹"></a>Kubernetesçš„æ¨¡å‹</h1><p>åœ¨å¤§é‡çš„å¼€å‘è€…ä¹‹é—´åè°ƒportçš„ä½¿ç”¨å¾ˆæ˜æ˜¾æ˜¯éå¸¸éš¾ä»¥æ‰©å±•å’Œç®¡ç†çš„ã€‚åŠ¨æ€åˆ†é…portåˆä¼šç»™ç³»ç»Ÿå¸¦æ¥å¾ˆå¤§çš„å¤æ‚æ€§â€”â€”æ¯ä¸€ä¸ªåº”ç”¨ç¨‹åºéƒ½å¿…é¡»æŠŠportä½œä¸ºä¸€ä¸ªflagï¼ŒAPI Serverå¿…é¡»çŸ¥é“å¦‚ä½•å»æŠŠåŠ¨æ€çš„portæ’å…¥åˆ°é…ç½®å—é‡Œé¢ï¼ŒServiceå¿…é¡»çŸ¥é“å¦‚ä½•å»æ‰¾åˆ°å½¼æ­¤ï¼Œç­‰ç­‰ã€‚ä¸å…¶è§£å†³è¿™ä¹ˆå¤šçš„é—®é¢˜ï¼Œä¸å¦‚å’±ä»¬è‡ªå·±å¹²ï¼Œé‡å¤´è®¾è®¡ã€‚</p><p>Kubernetesè§„å®šäº†å¦‚ä¸‹çš„ç½‘ç»œå®ç°è§„èŒƒï¼ˆé™¤éæœ‰æ„ä¸è¿™ä¹ˆåšï¼‰ï¼š</p><ul><li>æ‰€æœ‰çš„containeréƒ½å¯ä»¥åœ¨ä¸ä½¿ç”¨NATçš„æƒ…å†µä¸‹è®¿é—®åˆ°ä»»ä½•åˆ«çš„container</li><li>æ‰€æœ‰çš„nodeéƒ½å¯ä»¥åœ¨ä¸ä½¿ç”¨NATçš„æƒ…å†µä¸‹è®¿é—®åˆ°ä»»ä½•åˆ«çš„containerï¼ˆåä¹‹äº¦ç„¶ï¼‰</li><li>æ¯ä¸ªcontainerè‡ªå·±çœ‹åˆ°çš„è‡ªå·±çš„IPåœ°å€ï¼Œå’Œè¢«äººçœ‹åˆ°çš„æ˜¯ä¸€æ ·çš„</li></ul><p>è¿™äº›è¦æ±‚å…¶å®å°±æ˜¯è¯´ï¼Œä½ ä¸èƒ½ç›´æ¥åœ¨ä¸¤å°æœºå™¨ä¸Šè£…ä¸ŠDockerï¼Œç„¶åæŒ‡æœ›Kubernetesä¼šå·¥ä½œï¼Œä½ å¿…é¡»ä¿è¯è¿™äº›åŸºç¡€è¦æ±‚è¢«æ»¡è¶³ã€‚</p><p>è¿™ä¸ªæ¨¡å‹ä¸æ­¢ç®€å•äº†å¾ˆå¤šï¼Œè€Œä¸”è¿˜å»åˆäº†Kuberneteså¯¹äºæŠŠappä»vmè¿ç§»åˆ°containerçš„æ–¹ä¾¿æ€§è¦æ±‚ã€‚æ„æ€æ˜¯ï¼Œå¦‚æœä½ ä¹‹å‰çš„appæ˜¯è¿è¡Œåœ¨vmé‡Œé¢çš„ï¼Œé‚£ä¹ˆvmå’Œvmä¹‹é—´èƒ½é€šè¿‡IPåœ°å€äº’ç›¸é€šä¿¡æ˜¯ä¸€ä¸ªåŸºæœ¬çš„è¦æ±‚ã€‚åä¹‹ï¼Œæ”¾åˆ°containeré‡Œé¢ä¹Ÿæ˜¯è¿™æ ·ã€‚</p><p>ä¸è¿‡äº‹å®ä¸Šï¼ŒKubernetesä¸­å¹¶ä¸æ˜¯æ¯ä¸€ä¸ªcontaineréƒ½ä¼šæœ‰è‡ªå·±çš„IPåœ°å€ï¼Œå…¶å®Kubernetesæ˜¯ä»¥Podä½œä¸ºæœ€å°çš„åˆ†é…IPåœ°å€çš„å•ä½çš„â€”â€”Podä¸­çš„containerä¼šå…±äº«åŒä¸€ä¸ªIPåœ°å€â€”â€”ä¹Ÿå°±æ˜¯å…±äº«åŒä¸€ä¸ªnetwork namespaceã€‚è¿™ä½¿å¾—æ‰€æœ‰çš„åŒä¸€ä¸ªPodé‡Œé¢çš„containeréƒ½èƒ½é€šè¿‡localhostç›´æ¥è®¿é—®åˆ°å½¼æ­¤ã€‚ä¸è¿‡è¿™ä¸ªå¸¦æ¥çš„é—®é¢˜æ˜¯æ¯ä¸ªPodé‡Œé¢çš„containeréœ€è¦åè°ƒå¥½portçš„ä½¿ç”¨ï¼Œé˜²æ­¢å†²çªï¼Œä½†æ˜¯è¿™ä¸ªå’Œåœ¨VMé‡Œé¢æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥å¹¶ä¸æ˜¯ä»€ä¹ˆå¤ªå¤§çš„é—®é¢˜ã€‚æˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œIP-per-podâ€æ¨¡å‹ã€‚</p><p>åœ¨Dockeré‡Œé¢ï¼Œè¯·æ±‚ä¸€ä¸ªhost portæ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯è¿™ä¸ªæ¨¡å‹ä½¿å¾—æ“ä½œæ›´åŠ ç®€å•ã€‚æˆ‘ä»¬ä¼šåœ¨æ¯ä¸ªhost Nodeä¸Šåˆ†é…ä¸€ä¸ªportï¼Œå¹¶æŠŠæ‰€æœ‰çš„trafficéƒ½è½¬å‘ç»™Podã€‚Podæœ¬èº«å¹¶ä¸éœ€è¦çŸ¥é“è¿™äº›ï¼Œåªå½“è‡ªå·±æ˜¯ä¸€ä¸ªvmæˆ–è€…ç”šè‡³ç‰©ç†æœºå°±å¥½äº†ã€‚</p><h1 id="å¦‚ä½•å®ç°"><a href="#å¦‚ä½•å®ç°" class="headerlink" title="å¦‚ä½•å®ç°"></a>å¦‚ä½•å®ç°</h1><p>ç›®å‰æœ‰å¾ˆå¤šæ–¹æ³•èƒ½å®ç°è¿™ä¸ªç½‘ç»œæ¨¡å‹ï¼Œæ¯”å¦‚è¯´å¦‚ä¸‹çš„è¿™äº›æ–¹æ¡ˆï¼š</p><h2 id="Cilium"><a href="#Cilium" class="headerlink" title="Cilium"></a>Cilium</h2><p>Ciliumæ˜¯ä¸€ä¸ªå¼€æºçš„ç½‘ç»œæ¨¡å‹ï¼Œå®ç°äº†L3-L7å±‚çš„å®‰å…¨ç­–ç•¥ï¼Œå…·ä½“çš„å¯ä»¥çœ‹ä¸€ä¸‹æ–‡æ¡£ã€‚</p><h2 id="Contiv"><a href="#Contiv" class="headerlink" title="Contiv"></a>Contiv</h2><p>Contivæä¾›äº†å¯è®¾ç½®çš„ç½‘ç»œæ¨¡å‹ã€‚</p><h2 id="Flannel"><a href="#Flannel" class="headerlink" title="Flannel"></a>Flannel</h2><p>Flannelæ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ç½‘ç»œå±‚ï¼Œä¸è¿‡å¾ˆå¤šäººéƒ½è¯´å¥½ç”¨ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å®ç°çš„æ–¹æ¡ˆéå¸¸å¤šï¼Œæˆ‘å°±ä¸ä¸€ä¸€åˆ—ä¸¾äº†ï¼Œå¤§å®¶å¯ä»¥ç›´æ¥å»å‚è€ƒå®˜æ–¹æ–‡æ¡£ä¸­çš„å†…å®¹ã€‚</p><p>ç½‘ç»œæ˜¯ä¸ªå¾ˆå¤æ‚çš„ä¸œè¥¿ï¼Œå¾ˆå¤šæ—¶å€™é—®é¢˜éƒ½ä¼šå‡ºåœ¨ç½‘ç»œä¸Šï¼Œä¸åŒçš„ä¸šåŠ¡æ¨¡å‹éœ€è¦ä½¿ç”¨ä¸åŒçš„ç½‘ç»œæ’ä»¶ï¼Œæ²¡æœ‰ä¸‡é‡‘æ²¹çš„è§£å†³æ–¹æ¡ˆã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Kubernetes å¤„ç†ç½‘ç»œçš„æ–¹å¼å’ŒDockerä¸åŒï¼Œä¸»è¦éœ€è¦è§£å†³å››ç§é—®é¢˜ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;é«˜åº¦è€¦åˆçš„Containerä¹‹é—´çš„ç½‘ç»œé€šä¿¡ï¼šè¿™ä¸ªç”±Podå’Œlocalhosté€šä¿¡è§£å†³äº†ï¼›&lt;/li&gt;
&lt;li&gt;Podå’ŒPodä¹‹é—´çš„ç½‘ç»œé€šä¿¡ï¼Œè¿™ä¸ªæ˜¯æœ¬ç¯‡çš„ä¸»è¦å†…å®¹ï¼›&lt;/li&gt;
&lt;li&gt;Podå’ŒServiceä¹‹é—´çš„é€šä¿¡ï¼Œè¿™ä¸ªæ˜¯ç”±Serviceè§£å†³çš„ï¼›&lt;/li&gt;
&lt;li&gt;å¤–éƒ¨Serviceå’Œå†…éƒ¨Serviceä¹‹é—´çš„é€šä¿¡ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ç”±Serviceè§£å†³çš„ã€‚&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://www.purewhite.io/categories/kubernetes/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="æ¶æ„" scheme="https://www.purewhite.io/tags/%E6%9E%B6%E6%9E%84/"/>
    
    <category term="docker" scheme="https://www.purewhite.io/tags/docker/"/>
    
    <category term="linux" scheme="https://www.purewhite.io/tags/linux/"/>
    
    <category term="è¿ç»´" scheme="https://www.purewhite.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="kubernetes" scheme="https://www.purewhite.io/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes ä¸­çš„ ingress</title>
    <link href="https://www.purewhite.io/2017/12/28/kubernetes-ingress/"/>
    <id>https://www.purewhite.io/2017/12/28/kubernetes-ingress/</id>
    <published>2017-12-28T08:56:45.000Z</published>
    <updated>2021-12-02T12:51:07.227Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨æˆ‘ä¹‹å‰çš„<a href="https://purewhite.io/2017/12/23/kubernetes-service/">kubernetesä¸­çš„Service</a>ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä½•ä½¿ç”¨Serviceæ¥è®©æˆ‘ä»¬çš„åº”ç”¨å¯ä»¥è¢«é›†ç¾¤å¤–æ‰€è®¿é—®åˆ°ã€‚ä½†æ˜¯åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œä»ç„¶å­˜åœ¨ä¸€äº›é—®é¢˜ã€‚å¯¹äºæˆ‘ä»¬ç»å¸¸ç”¨çš„NodePortå’ŒLoadBalancerè¿™ä¸¤ä¸ªtypeï¼ŒLoadBalanceréœ€è¦åº•å±‚çš„infraæ”¯æŒï¼Œå¹¶ä¸”å“ªæ€•æ”¯æŒäº†æˆ‘ä»¬ä¹Ÿä¸èƒ½è½»æ˜“ç”¨ï¼Œå› ä¸ºLoadBalancerèµ„æºæ˜¯æœ‰é™çš„ï¼Œè€Œä¸”æœ€é‡è¦çš„æ˜¯è´µï¼Œè´µï¼Œè´µã€‚è€Œå¯¹äºNodePortæ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦ç»å¸¸æ›´æ–°æˆ‘ä»¬çš„proxyè®¾ç½®ï¼Œå¹¶ä¸”è¿½è¸ªå“ªäº›Portè¢«ä½¿ç”¨äº†ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯å¾ˆéº»çƒ¦çš„ã€‚</p><p>ä¸‡èƒ½çš„ç¨‹åºçŒ¿æ€»æ˜¯æœ‰è§£å†³æ–¹æ¡ˆï¼Œingressåº”è¿è€Œç”Ÿã€‚</p><span id="more"></span><h1 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h1><p>é€šè¿‡ä½¿ç”¨Serviceï¼Œè·¯ç”±çš„è§„åˆ™æ˜¯ç›´æ¥é™„å±åˆ°ä¸€ä¸ªç‰¹å®šçš„Serviceä¸Šï¼Œå¹¶ä¸”ç”Ÿå‘½å‘¨æœŸå’ŒServiceä¸€æ ·ã€‚å¦‚æœè¯´ï¼Œæˆ‘ä»¬èƒ½æŠŠè·¯ç”±è§„åˆ™å’Œåº”ç”¨è§£è€¦ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥éšæ„çš„å»æ›´æ–°åº”ç”¨è€Œä¸å½±å“è®¿é—®ï¼Œæˆ–è€…éšæ„çš„å»æ›´æ”¹è·¯ç”±è§„åˆ™äº†ã€‚Ingressæ­£æ˜¯åšè¿™ä¸ªçš„ã€‚</p><p>æ ¹æ®Kuberneteså®˜æ–¹æ–‡æ¡£ï¼š</p><p><code>An Ingress is a collection of rules that allow inbound connections to reach the cluster Services.</code></p><p>Ingresså®é™…ä¸Šåšäº†ä¸€ä¸ªLayer 7çš„HTTP load balancerï¼Œå¹¶ä¸”æä¾›äº†ä»¥ä¸‹åŠŸèƒ½ï¼š</p><ul><li>TLS(Transport Layer Security)</li><li>Name-based virtual hosting</li><li>Path-based routing</li><li>Custom rules</li></ul><p><img data-src="https://static.purewhite.io/images/2017-12-28-AEE4364B-EE2F-451A-8361-DF5A6AE92116.png!webp_90" alt="AEE4364B-EE2F-451A-8361-DF5A6AE92116"></p><p>é€šè¿‡Ingressï¼Œç”¨æˆ·ä¸éœ€è¦ç›´æ¥è¿æ¥åˆ°Serviceï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥è®¿é—®åˆ°ingressçš„endpointï¼Œç„¶åé€šè¿‡Ingresså†è½¬å‘åˆ°Serviceã€‚æ ·ä¾‹Ingressé…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">blue.myweb.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span> </span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">blue-service</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">green.myweb.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">green-service</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>æ ¹æ®è¿™ä¸ªé…ç½®ï¼Œç”¨æˆ·è®¿é—®blue.myweb.comå’Œgreen.myweb.comå°†ä¼šè®¿é—®åˆ°åŒä¸€ä¸ªingressçš„endpointï¼Œå¹¶ä¸”å†è¢«è½¬å‘åˆ°blue-serviceå’Œgreen-serviceä¸­ã€‚è¿™ä¸ªå°±æ˜¯ä¹‹å‰è¯´çš„<code>Name-based virtual hosting</code>ã€‚</p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨Fan Out Ingress rulesï¼Œæ¯”å¦‚æˆ‘ä»¬è®¿é—®myweb.com/blueå’Œmyweb.com/greenï¼Œç„¶åè¿™äº›ä¹Ÿä¼šè¢«è½¬å‘åˆ°blue-serviceå’Œgreen-serviceï¼š</p><p><img data-src="https://static.purewhite.io/images/2017-12-28-6E68B099-8D89-40B4-9744-475C4E1E61B0.png!webp_90" alt="6E68B099-8D89-40B4-9744-475C4E1E61B0"></p><p>Ingressè¿™ä¸ªResourceå…¶å®å¹¶ä¸åšè½¬å‘ï¼Œè€Œæ˜¯ç”±Ingress Controlleræ¥åšçš„ã€‚</p><h1 id="Ingress-Controller"><a href="#Ingress-Controller" class="headerlink" title="Ingress Controller"></a>Ingress Controller</h1><p>Ingress Controllerå…¶å®å°±æ˜¯ä¸€ä¸ªç›‘å¬master nodeä¸ŠAPI Serverå¯¹Ingress Resourceçš„æ”¹å˜ç„¶åæ”¹å˜è¿™ä¸ªLayer 7 Load Balancerçš„Controllerã€‚Kubernetesæœ‰å¥½å¤šç§ä¸åŒçš„Ingress Controllersï¼Œæ¯”å¦‚è¯´GCE L7 Load Balancerå’ŒNginx Ingress Controllerã€‚å½“ç„¶ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦çš„è¯ä¹Ÿå¯ä»¥å†™ä¸€ä¸ªè‡ªå·±çš„ã€‚</p><p>éœ€è¦ä¿è¯Ingress Controllerè¢«å¯ç”¨ï¼ŒIngressæ‰å¯ä»¥ä½¿ç”¨ã€‚</p><h1 id="åˆ›å»ºä¸€ä¸ªIngress-Resource"><a href="#åˆ›å»ºä¸€ä¸ªIngress-Resource" class="headerlink" title="åˆ›å»ºä¸€ä¸ªIngress Resource"></a>åˆ›å»ºä¸€ä¸ªIngress Resource</h1><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>kubectl create</code>æ¥åˆ›å»ºä¸€ä¸ªingressèµ„æºï¼Œæ¯”å¦‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå«åšmyweb-ingress.yamlçš„æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">blue.myweb.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span> </span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">blue-service</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">green.myweb.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">green-service</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f myweb-ingress.yaml</span></span><br></pre></td></tr></table></figure><p>æ¥åˆ›å»ºè¿™ä¸ªingressçš„èµ„æºã€‚ç„¶ååªè¦ä¿®æ”¹æˆ‘ä»¬çš„åŸŸådnsï¼ŒæŒ‡å‘ingressçš„endpointå³å¯ï¼ˆåœ¨æœ¬æœºä¸Šå¯ä»¥é€šè¿‡ä¿®æ”¹/etc/hostsæ¥è¾¾æˆç›®çš„ï¼‰ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨æˆ‘ä¹‹å‰çš„&lt;a href=&quot;https://purewhite.io/2017/12/23/kubernetes-service/&quot;&gt;kubernetesä¸­çš„Service&lt;/a&gt;ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä½•ä½¿ç”¨Serviceæ¥è®©æˆ‘ä»¬çš„åº”ç”¨å¯ä»¥è¢«é›†ç¾¤å¤–æ‰€è®¿é—®åˆ°ã€‚ä½†æ˜¯åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œä»ç„¶å­˜åœ¨ä¸€äº›é—®é¢˜ã€‚å¯¹äºæˆ‘ä»¬ç»å¸¸ç”¨çš„NodePortå’ŒLoadBalancerè¿™ä¸¤ä¸ªtypeï¼ŒLoadBalanceréœ€è¦åº•å±‚çš„infraæ”¯æŒï¼Œå¹¶ä¸”å“ªæ€•æ”¯æŒäº†æˆ‘ä»¬ä¹Ÿä¸èƒ½è½»æ˜“ç”¨ï¼Œå› ä¸ºLoadBalancerèµ„æºæ˜¯æœ‰é™çš„ï¼Œè€Œä¸”æœ€é‡è¦çš„æ˜¯è´µï¼Œè´µï¼Œè´µã€‚è€Œå¯¹äºNodePortæ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦ç»å¸¸æ›´æ–°æˆ‘ä»¬çš„proxyè®¾ç½®ï¼Œå¹¶ä¸”è¿½è¸ªå“ªäº›Portè¢«ä½¿ç”¨äº†ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯å¾ˆéº»çƒ¦çš„ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‡èƒ½çš„ç¨‹åºçŒ¿æ€»æ˜¯æœ‰è§£å†³æ–¹æ¡ˆï¼Œingressåº”è¿è€Œç”Ÿã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://www.purewhite.io/categories/kubernetes/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="æ¶æ„" scheme="https://www.purewhite.io/tags/%E6%9E%B6%E6%9E%84/"/>
    
    <category term="docker" scheme="https://www.purewhite.io/tags/docker/"/>
    
    <category term="linux" scheme="https://www.purewhite.io/tags/linux/"/>
    
    <category term="è¿ç»´" scheme="https://www.purewhite.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="kubernetes" scheme="https://www.purewhite.io/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes ä¸­çš„ ConfigMap å’Œ Secret</title>
    <link href="https://www.purewhite.io/2017/12/28/kubernetes-configmap-and-secret/"/>
    <id>https://www.purewhite.io/2017/12/28/kubernetes-configmap-and-secret/</id>
    <published>2017-12-28T07:50:20.000Z</published>
    <updated>2021-12-02T12:51:07.227Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸ºä»€ä¹ˆè¦æœ‰è¿™ä¿©ç©æ„å„¿ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦æœ‰è¿™ä¿©ç©æ„å„¿ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦æœ‰è¿™ä¿©ç©æ„å„¿ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦æœ‰è¿™ä¿©ç©æ„å„¿ï¼Ÿ</h1><p>æˆ‘ä»¬åœ¨kubernetesä¸Šéƒ¨ç½²åº”ç”¨çš„æ—¶å€™ï¼Œç»å¸¸ä¼šéœ€è¦ä¼ ä¸€äº›é…ç½®ç»™æˆ‘ä»¬çš„åº”ç”¨ï¼Œæ¯”å¦‚æ•°æ®åº“åœ°å€å•Šï¼Œç”¨æˆ·åå¯†ç å•Šä¹‹ç±»çš„ã€‚æˆ‘ä»¬è¦åšåˆ°è¿™ä¸ªï¼Œæœ‰å¥½å¤šç§æ–¹æ¡ˆï¼Œæ¯”å¦‚ï¼š</p><ul><li>æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨æ‰“åŒ…é•œåƒçš„æ—¶å€™å†™åœ¨åº”ç”¨é…ç½®æ–‡ä»¶é‡Œé¢ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼çš„åå¤„æ˜¾è€Œæ˜“è§è€Œä¸”éå¸¸æ˜æ˜¾ã€‚</li><li>æˆ‘ä»¬å¯ä»¥åœ¨é…ç½®æ–‡ä»¶é‡Œé¢é€šè¿‡envç¯å¢ƒå˜é‡ä¼ å…¥ï¼Œä½†æ˜¯è¿™æ ·çš„è¯æˆ‘ä»¬è¦ä¿®æ”¹envå°±å¿…é¡»å»ä¿®æ”¹yamlæ–‡ä»¶ï¼Œè€Œä¸”éœ€è¦é‡å¯æ‰€æœ‰çš„containeræ‰è¡Œã€‚</li><li>æˆ‘ä»¬å¯ä»¥åœ¨åº”ç”¨å¯åŠ¨çš„æ—¶å€™å»æ•°æ®åº“æˆ–è€…æŸä¸ªç‰¹å®šçš„åœ°æ–¹æ‹¿ï¼Œæ²¡é—®é¢˜ï¼ä½†æ˜¯ç¬¬ä¸€ï¼Œå®ç°èµ·æ¥éº»çƒ¦ï¼›ç¬¬äºŒï¼Œå¦‚æœé…ç½®çš„åœ°æ–¹å˜äº†æ€ä¹ˆåŠï¼Ÿ</li></ul><p>å½“ç„¶è¿˜æœ‰åˆ«çš„æ–¹æ¡ˆï¼Œä½†æ˜¯å„ç§æ–¹æ¡ˆéƒ½æœ‰å„è‡ªçš„é—®é¢˜ã€‚</p><p>è€Œä¸”ï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œå¦‚æœè¯´æˆ‘çš„ä¸€ä¸ªé…ç½®ï¼Œæ˜¯è¦å¤šä¸ªåº”ç”¨ä¸€èµ·ä½¿ç”¨çš„ï¼Œä»¥ä¸Šé™¤äº†ç¬¬ä¸‰ç§æ–¹æ¡ˆï¼Œéƒ½æ²¡åŠæ³•è¿›è¡Œé…ç½®çš„å…±äº«ï¼Œå°±æ˜¯è¯´æˆ‘å¦‚æœè¦æ”¹é…ç½®çš„è¯ï¼Œé‚£å¾—ä¸€ä¸ªä¸€ä¸ªæ‰‹åŠ¨æ”¹ã€‚å‡å¦‚æˆ‘ä»¬æœ‰100ä¸ªåº”ç”¨ï¼Œå°±å¾—æ”¹100ä»½é…ç½®ï¼Œä»¥æ­¤ç±»æ¨â€¦â€¦</p><p>kuberneteså¯¹è¿™ä¸ªé—®é¢˜æä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œå°±æ˜¯ç”¨<strong>ConfigMap</strong>å’Œ<strong>Secret</strong>ã€‚</p><span id="more"></span><h1 id="åˆ›å»ºConfigMap"><a href="#åˆ›å»ºConfigMap" class="headerlink" title="åˆ›å»ºConfigMap"></a>åˆ›å»ºConfigMap</h1><p>ConfigMapè®©æˆ‘ä»¬èƒ½å¤Ÿä»å®¹å™¨é•œåƒä¸­æŠŠé…ç½®çš„è¯¦ç»†ä¿¡æ¯ç»™è§£è€¦å‡ºæ¥ã€‚é€šè¿‡ConfigMapæˆ‘ä»¬èƒ½å¤ŸæŠŠé…ç½®ä»¥key-valueå¯¹çš„å½¢å¼ä¼ é€’åˆ°containeræˆ–è€…åˆ«çš„ç³»ç»Ÿç»„ä»¶ï¼ˆæ¯”å¦‚Controllerï¼‰é‡Œé¢ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼æ¥åˆ›å»ºConfigMapï¼š</p><h2 id="From-Literal-Values"><a href="#From-Literal-Values" class="headerlink" title="From Literal Values"></a>From Literal Values</h2><p>æˆ‘ä»¬å¯ä»¥ç”¨<code>kubectl create</code>æ¥åˆ›å»ºä¸€ä¸ªConfigMapï¼Œç„¶åé€šè¿‡<code>kubectl get</code>æ¥è·å–ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Create the ConfigMap</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl create configmap my-config --from-literal=key1=value1 --from-literal=key2=value2</span></span><br><span class="line">configmap &quot;my-config&quot; created </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Get the ConfigMap Details <span class="keyword">for</span> my-config</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get configmaps my-config -o yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  key1: value1</span><br><span class="line">  key2: value2</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: 2017-05-31T07:21:55Z</span><br><span class="line">  name: my-config</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: &quot;241345&quot;</span><br><span class="line">  selfLink: /api/v1/namespaces/default/configmaps/my-config</span><br><span class="line">  uid: d35f0a3d-45d1-11e7-9e62-080027a46057</span><br></pre></td></tr></table></figure><p><code>-o yaml</code>çš„ä½œç”¨æ˜¯é€šè¿‡yamlçš„å½¢å¼æ¥è¿”å›æˆ‘ä»¬æ‰€è¦æ±‚çš„é…ç½®ä¿¡æ¯ã€‚</p><h2 id="From-Configuration-File"><a href="#From-Configuration-File" class="headerlink" title="From Configuration File"></a>From Configuration File</h2><p>é™¤äº†ä¸Šé¢çš„æ–¹å¼ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç›´æ¥é€šè¿‡é…ç½®æ–‡ä»¶æ¥åˆ›å»ºï¼ˆå¥½å§ï¼Œè™½ç„¶æˆ‘æ„Ÿè§‰æ˜¯åŒä¸€ç§ï¼Œåªä¸è¿‡æ˜¯æ”¾åˆ°æ–‡ä»¶é‡Œé¢äº†è€Œå·²â€¦â€¦ï¼‰ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬å¾—æœ‰ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå‡è®¾åå­—å«åš<code>myconfigmap.yaml</code>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">customer1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">TEXT1:</span> <span class="string">Customer1_Company</span></span><br><span class="line">  <span class="attr">TEXT2:</span> <span class="string">Welcomes</span> <span class="string">You</span></span><br><span class="line">  <span class="attr">COMPANY:</span> <span class="string">Customer1</span> <span class="string">Company</span> <span class="string">Technology</span> <span class="string">Pct.</span> <span class="string">Ltd.</span></span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>kubectl create -f</code>æ¥åˆ›å»ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f myconfigmap.yaml</span></span><br><span class="line">configmap &quot;customer1&quot; created</span><br></pre></td></tr></table></figure><h1 id="ä½¿ç”¨ConfigMap"><a href="#ä½¿ç”¨ConfigMap" class="headerlink" title="ä½¿ç”¨ConfigMap"></a>ä½¿ç”¨ConfigMap</h1><p>æˆ‘ä»¬å¯ä»¥æœ‰ä¸¤ç§æ–¹æ³•æ¥ä½¿ç”¨ConfigMapï¼š</p><h2 id="é€šè¿‡env"><a href="#é€šè¿‡env" class="headerlink" title="é€šè¿‡env"></a>é€šè¿‡env</h2><p>æˆ‘ä»¬å¯ä»¥è®¾ç½®envä»ConfigMapè¯»å–ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">....</span></span><br><span class="line"> <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rsvp-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">teamcloudyuga/rsvpapp</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MONGODB_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">mongodb</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TEXT1</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">customer1</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">TEXT1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TEXT2</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">customer1</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">TEXT2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">COMPANY</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">customer1</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">COMPANY</span></span><br><span class="line"></span><br><span class="line"><span class="string">....</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œæˆ‘ä»¬çš„containerå°±å¯ä»¥è¯»å–åˆ°ConfigMapé‡Œé¢å­˜å‚¨çš„ä¿¡æ¯äº†ã€‚</p><p>ä¸è¿‡ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä¸ªäººæ¨èä½¿ç”¨å¦ä¸€ç§æ–¹å¼ï¼š</p><h2 id="é€šè¿‡Volume"><a href="#é€šè¿‡Volume" class="headerlink" title="é€šè¿‡Volume"></a>é€šè¿‡Volume</h2><p>è¿™ç§æ–¹å¼æˆ‘æ¯”è¾ƒæ¨èï¼Œå› ä¸ºéšç€ConfigMapè¢«ä¿®æ”¹ï¼ˆæ¯”å¦‚ä½ æƒ³è¦æ›´æ–°ä¸€äº›è®¾ç½®ï¼‰ï¼Œcontaineré‡Œé¢å¯¹åº”çš„æ–‡ä»¶å†…å®¹ä¹Ÿä¼šè¢«ä¿®æ”¹ï¼Œè¿™æ ·å¯ä»¥ä¸ç”¨é‡å¯Containerå°±è®©åº”ç”¨èƒ½å¤Ÿå¾—åˆ°æœ€æ–°çš„é…ç½®ä¿¡æ¯ã€‚</p><p>è¿™ä¸ªå†…å®¹éœ€è¦ä¸€äº›Volumeç›¸å…³çš„çŸ¥è¯†ï¼Œåœ¨æ­¤ä¸åšæ›´å¤šè®²è§£ï¼Œå¤§å®¶å¯ä»¥å»å‚è€ƒ<a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/#adding-configmap-data-to-a-volume">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p><h1 id="åˆ›å»ºSecret"><a href="#åˆ›å»ºSecret" class="headerlink" title="åˆ›å»ºSecret"></a>åˆ›å»ºSecret</h1><p>é€šè¿‡ä¸Šé¢çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ConfigMapæ˜¯ç”¨æ¥åšä¸€äº›é…ç½®ä¿¡æ¯çš„ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬æœ‰ä¸€äº›æœºå¯†ä¿¡æ¯æ¯”å¦‚è¯´å¯†é’¥ã€å¯†ç ä¹‹ç±»çš„ä¿¡æ¯ï¼Œåº”è¯¥å­˜åœ¨å“ªé‡Œå‘¢ï¼Ÿçœ‹åˆ°è¿™ä¸ªåå­—å¤§å®¶åº”è¯¥å°±æ˜ç™½äº†å§ï¼Œkubernetesæä¾›äº†Secretæ¥å­˜å‚¨ç›¸å…³çš„ä¿¡æ¯ã€‚</p><p>å…·ä½“ä¸ºä»€ä¹ˆè¦å­˜åœ¨Secreté‡Œé¢ï¼ŒSecretå’ŒConfigMapæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œåé¢ä¼šè®²åˆ°ã€‚</p><h2 id="åˆ›å»ºSecret-1"><a href="#åˆ›å»ºSecret-1" class="headerlink" title="åˆ›å»ºSecret"></a>åˆ›å»ºSecret</h2><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>kubectl create secret</code>æ¥é€šè¿‡ä¸€ä¸ªæ–‡ä»¶åˆ›å»ºä¸€ä¸ªsecretï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Create a file with password</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&#x27;mysqlpassword&#x27;</span> &gt; password.txt</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Make sure there is no trailing newline <span class="keyword">in</span> the file, after our password.</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> To remove any newline, we can use the tr <span class="built_in">command</span>:</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tr -Ccsu <span class="string">&#x27;\n&#x27;</span> &lt; password.txt &gt; .strippedpassword.txt &amp;&amp; mv .strippedpassword.txt password.txt</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Create the Secret</span> </span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl create secret generic my-password --from-file=password.txt</span></span><br><span class="line">secret &quot;my-password&quot; created</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªSecretï¼Œä¸è¿‡è¦æ³¨æ„ï¼Œæ‰€æœ‰çš„secretçš„dataéƒ½è¦ä»¥base64è¿›è¡ŒåŠ å¯†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat password.txt | base64</span></span><br><span class="line">bXlzcWxwYXN3b3JkCg==</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> and <span class="keyword">then</span> use it <span class="keyword">in</span> the configuration file:</span></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: my-password</span><br><span class="line">type: Opaque</span><br><span class="line">data:</span><br><span class="line">  password: bXlzcWxwYXN3b3JkCg==</span><br></pre></td></tr></table></figure><h1 id="ä½¿ç”¨Secret"><a href="#ä½¿ç”¨Secret" class="headerlink" title="ä½¿ç”¨Secret"></a>ä½¿ç”¨Secret</h1><h2 id="è·å–Secret"><a href="#è·å–Secret" class="headerlink" title="è·å–Secret"></a>è·å–Secret</h2><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>get</code>å’Œ<code>describe</code>æ¥è·å–Secretï¼Œä¸è¿‡æˆ‘ä»¬å‘ç°ï¼Œ<code>kubectl</code>å¹¶æ²¡æœ‰å‘æˆ‘ä»¬è¿”å›Secretå…·ä½“çš„å†…å®¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get secret my-password</span></span><br><span class="line">NAME          TYPE     DATA   AGE </span><br><span class="line">my-password   Opaque   1      8m</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe secret my-password</span></span><br><span class="line">Name:          my-password</span><br><span class="line">Namespace:     default</span><br><span class="line">Labels:        &lt;none&gt;</span><br><span class="line">Annotations:   &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Type  Opaque</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">password.txt:  13 bytes</span><br></pre></td></tr></table></figure><h2 id="åœ¨Podé‡Œé¢ä½¿ç”¨"><a href="#åœ¨Podé‡Œé¢ä½¿ç”¨" class="headerlink" title="åœ¨Podé‡Œé¢ä½¿ç”¨"></a>åœ¨Podé‡Œé¢ä½¿ç”¨</h2><p>å’ŒConfigMapä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®æˆenvæˆ–è€…æŒ‚è½½æˆvolumeæ¥ä½¿å®¹å™¨å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„secretã€‚</p><p>å…·ä½“æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">.....</span></span><br><span class="line">         <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">wordpress:4.7.3-apache</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">wordpress</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">wordpress-mysql</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">my-password</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">password.txt</span></span><br><span class="line"><span class="string">.....</span></span><br></pre></td></tr></table></figure><p>å…³äºå¦‚ä½•åœ¨Volumeä¸­ä½¿ç”¨çš„è¿˜æ˜¯éœ€è¦è‡ªè¡ŒæŸ¥è¯¢æ–‡æ¡£å­¦ä¹ ã€‚</p><h1 id="æ‰¯æ·¡çš„Secret"><a href="#æ‰¯æ·¡çš„Secret" class="headerlink" title="æ‰¯æ·¡çš„Secret"></a>æ‰¯æ·¡çš„Secret</h1><p>å¥½äº†ï¼Œæ€»ç®—æ­£æ–‡éƒ¨åˆ†å®Œäº†ï¼Œå¯ä»¥è®²è®²Secretå’ŒConfigMapçš„å…³ç³»äº†ï¼Œä»¥åŠè®²è®²Secretåˆ°åº•æœ‰å¤šæ‰¯æ·¡â€¦â€¦</p><p>å…¶å®ç›®å‰Secretçš„å®ç°ï¼Œå°±æ˜¯ConfigMapæŠŠvalueç”¨base64 encodeäº†ä¸€ä¸‹â€¦â€¦</p><p>æ‰€ä»¥ï¼Œå…¶å®ä¸å­˜åœ¨ä»»ä½•å®‰å…¨æ€§â€¦â€¦</p><p>åªè¦decodeä¸€ä¸‹å°±èƒ½å‡ºç°åŸæ¥ç»“æœï¼Œç›¸å½“äºæ˜æ–‡å­˜å‚¨â€¦â€¦</p><p>base64è¿™ç©æ„å„¿éƒ½ä¸èƒ½å«åšåŠ å¯†ï¼Œåªèƒ½å«åšç¼–ç â€¦â€¦</p><p>æ‰€ä»¥æˆ‘ä»¬éƒ½ä¸è¯´encryptï¼Œè€Œæ˜¯encodeå’Œdecodeâ€¦â€¦</p><p>å½“ç„¶ï¼Œk8sç¤¾åŒºæœ‰åœ¨è®¡åˆ’å¯¹Secretè¿›è¡Œä¸‹ä¸€æ­¥çš„å®‰å…¨æ€§å¢å¼ºï¼Œå½“ç„¶è¿™æ˜¯åè¯äº†â€¦â€¦</p><p>åæ­£ç›®å‰ä¸ºæ­¢ï¼ŒSecretåŸºæœ¬å’ŒConfigMapä¸€æ ·æ˜¯æ˜æ–‡å­˜å‚¨â€¦â€¦</p><p>çŸ¥é“æœ‰å¤šæ‰¯æ·¡äº†å§â€¦â€¦</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;ä¸ºä»€ä¹ˆè¦æœ‰è¿™ä¿©ç©æ„å„¿ï¼Ÿ&quot;&gt;&lt;a href=&quot;#ä¸ºä»€ä¹ˆè¦æœ‰è¿™ä¿©ç©æ„å„¿ï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;ä¸ºä»€ä¹ˆè¦æœ‰è¿™ä¿©ç©æ„å„¿ï¼Ÿ&quot;&gt;&lt;/a&gt;ä¸ºä»€ä¹ˆè¦æœ‰è¿™ä¿©ç©æ„å„¿ï¼Ÿ&lt;/h1&gt;&lt;p&gt;æˆ‘ä»¬åœ¨kubernetesä¸Šéƒ¨ç½²åº”ç”¨çš„æ—¶å€™ï¼Œç»å¸¸ä¼šéœ€è¦ä¼ ä¸€äº›é…ç½®ç»™æˆ‘ä»¬çš„åº”ç”¨ï¼Œæ¯”å¦‚æ•°æ®åº“åœ°å€å•Šï¼Œç”¨æˆ·åå¯†ç å•Šä¹‹ç±»çš„ã€‚æˆ‘ä»¬è¦åšåˆ°è¿™ä¸ªï¼Œæœ‰å¥½å¤šç§æ–¹æ¡ˆï¼Œæ¯”å¦‚ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨æ‰“åŒ…é•œåƒçš„æ—¶å€™å†™åœ¨åº”ç”¨é…ç½®æ–‡ä»¶é‡Œé¢ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼çš„åå¤„æ˜¾è€Œæ˜“è§è€Œä¸”éå¸¸æ˜æ˜¾ã€‚&lt;/li&gt;
&lt;li&gt;æˆ‘ä»¬å¯ä»¥åœ¨é…ç½®æ–‡ä»¶é‡Œé¢é€šè¿‡envç¯å¢ƒå˜é‡ä¼ å…¥ï¼Œä½†æ˜¯è¿™æ ·çš„è¯æˆ‘ä»¬è¦ä¿®æ”¹envå°±å¿…é¡»å»ä¿®æ”¹yamlæ–‡ä»¶ï¼Œè€Œä¸”éœ€è¦é‡å¯æ‰€æœ‰çš„containeræ‰è¡Œã€‚&lt;/li&gt;
&lt;li&gt;æˆ‘ä»¬å¯ä»¥åœ¨åº”ç”¨å¯åŠ¨çš„æ—¶å€™å»æ•°æ®åº“æˆ–è€…æŸä¸ªç‰¹å®šçš„åœ°æ–¹æ‹¿ï¼Œæ²¡é—®é¢˜ï¼ä½†æ˜¯ç¬¬ä¸€ï¼Œå®ç°èµ·æ¥éº»çƒ¦ï¼›ç¬¬äºŒï¼Œå¦‚æœé…ç½®çš„åœ°æ–¹å˜äº†æ€ä¹ˆåŠï¼Ÿ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å½“ç„¶è¿˜æœ‰åˆ«çš„æ–¹æ¡ˆï¼Œä½†æ˜¯å„ç§æ–¹æ¡ˆéƒ½æœ‰å„è‡ªçš„é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;è€Œä¸”ï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œå¦‚æœè¯´æˆ‘çš„ä¸€ä¸ªé…ç½®ï¼Œæ˜¯è¦å¤šä¸ªåº”ç”¨ä¸€èµ·ä½¿ç”¨çš„ï¼Œä»¥ä¸Šé™¤äº†ç¬¬ä¸‰ç§æ–¹æ¡ˆï¼Œéƒ½æ²¡åŠæ³•è¿›è¡Œé…ç½®çš„å…±äº«ï¼Œå°±æ˜¯è¯´æˆ‘å¦‚æœè¦æ”¹é…ç½®çš„è¯ï¼Œé‚£å¾—ä¸€ä¸ªä¸€ä¸ªæ‰‹åŠ¨æ”¹ã€‚å‡å¦‚æˆ‘ä»¬æœ‰100ä¸ªåº”ç”¨ï¼Œå°±å¾—æ”¹100ä»½é…ç½®ï¼Œä»¥æ­¤ç±»æ¨â€¦â€¦&lt;/p&gt;
&lt;p&gt;kuberneteså¯¹è¿™ä¸ªé—®é¢˜æä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œå°±æ˜¯ç”¨&lt;strong&gt;ConfigMap&lt;/strong&gt;å’Œ&lt;strong&gt;Secret&lt;/strong&gt;ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://www.purewhite.io/categories/kubernetes/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="æ¶æ„" scheme="https://www.purewhite.io/tags/%E6%9E%B6%E6%9E%84/"/>
    
    <category term="docker" scheme="https://www.purewhite.io/tags/docker/"/>
    
    <category term="linux" scheme="https://www.purewhite.io/tags/linux/"/>
    
    <category term="è¿ç»´" scheme="https://www.purewhite.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="kubernetes" scheme="https://www.purewhite.io/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>kubernetesä¸­çš„Volume</title>
    <link href="https://www.purewhite.io/2017/12/25/kubernetes-volumes/"/>
    <id>https://www.purewhite.io/2017/12/25/kubernetes-volumes/</id>
    <published>2017-12-25T03:04:48.000Z</published>
    <updated>2021-12-02T12:51:07.228Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå®¹å™¨æ˜¯ä¸€ä¸ªçŸ­æš‚çš„ä¸ç¨³å®šçš„å­˜åœ¨ï¼ˆéšæ—¶å¯èƒ½æŒ‚æ‰ï¼‰ï¼ŒæŒ‚æ‰ä¹‹åé‡Œé¢çš„æ‰€æœ‰æ•°æ®éƒ½æ²¡äº†ï¼Œä½†æ˜¯æˆ‘ä»¬ä¼šæœ‰å¾ˆå¤šæ•°æ®æ˜¯éœ€è¦ä¸€ç›´å­˜ä¸‹æ¥ï¼ˆæŒä¹…åŒ–ï¼‰çš„ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿæ€è·¯å¾ˆç®€å•ï¼ŒæŠŠå®¹å™¨é‡Œé¢çš„æ•°æ®å­˜åˆ°ä¸€ä¸ªå¯ä»¥æŒä¹…åŒ–çš„åœ°æ–¹ï¼ˆæ¯”å¦‚s3ä¸Šï¼‰ã€‚</p><span id="more"></span><h1 id="Volume"><a href="#Volume" class="headerlink" title="Volume"></a>Volume</h1><p>ä¸ºäº†è§£å†³ä¸Šé¢è¿™ä¸ªé—®é¢˜ï¼Œkubernetesæä¾›äº†Volumeã€‚ä¸€ä¸ªVolumeå…¶å®å°±æ˜¯ç”±ä¸€ä¸ªå­˜å‚¨ä¸­é—´ä»¶é”æ”¯æŒçš„ä¸€ä¸ªdirectoryï¼Œå…·ä½“æ˜¯ä»€ä¹ˆå­˜å‚¨ä¸­é—´ä»¶æ˜¯ç”±Volumeçš„ç±»å‹ç¡®å®šçš„ã€‚</p><p><img data-src="https://static.purewhite.io/images/2017-12-25-A00784D4-9D6B-4091-B78E-16834F743338.png!webp_90" alt="A00784D4-9D6B-4091-B78E-16834F743338"></p><p>å¦‚ä¸Šå›¾ï¼Œåœ¨k8sé‡Œé¢ï¼Œä¸€ä¸ªVolumeä¼šattachåˆ°ä¸€ä¸ªPodä¸Šï¼Œæˆ‘ä»¬ä¹‹å‰ä¹Ÿæœ‰è¯´è¿‡åœ¨Podé‡Œé¢ç½‘ç»œå’Œå­˜å‚¨æ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥è¿™ä¸ªVolumeå¯ä»¥è¢«Podä¸­æ‰€æœ‰çš„containeræ‰€å…±äº«ã€‚ä¸€ä¸ªVolumeå’ŒPodçš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸€æ ·çš„ï¼Œä¸è¿‡å´æ¯”containersè¦æ›´é•¿ï¼Œè¿™æ ·å¯ä»¥ä½¿å¾—æ•°æ®å¯ä»¥åœ¨å®¹å™¨ä¹‹é—´å…±äº«ã€‚</p><h1 id="Volume-Types"><a href="#Volume-Types" class="headerlink" title="Volume Types"></a>Volume Types</h1><p>ä¸€ä¸ªmountåˆ°Podé‡Œé¢çš„directoryæ˜¯ç”±åº•å±‚çš„Volume Typeæ”¯æŒçš„ï¼ŒVolume Typeå†³å®šäº†è¿™ä¸ªdirectoryçš„å±æ€§ï¼Œæ¯”å¦‚å¤§å°ï¼Œå†…å®¹ç­‰ç­‰ã€‚ä¸‹é¢åˆ—ä¸¾ä¸€éƒ¨åˆ†çš„Volume Typeï¼š</p><h2 id="emptyDir"><a href="#emptyDir" class="headerlink" title="emptyDir"></a>emptyDir</h2><p>é¡¾åæ€ä¹‰ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªâ€œç©ºçš„â€Volumeã€‚è¿™ä¸ªç©ºçš„Volumeä¼šåœ¨Podè¢«è°ƒåº¦åˆ°nodeä¸Šçš„æ—¶å€™è¢«åˆ›å»ºã€‚è¿™ç§ç±»å‹çš„Volumeçš„ç”Ÿå‘½å‘¨æœŸå’ŒPodä¸€æ ·ï¼Œå¦‚æœPodæŒ‚äº†ï¼Œé‚£ä¹ˆè¿™ç§Volumeé‡Œé¢çš„æ‰€æœ‰æ•°æ®ä¹Ÿå°±æ²¡äº†ã€‚</p><h2 id="hostPath"><a href="#hostPath" class="headerlink" title="hostPath"></a>hostPath</h2><p>åŒæ ·é¡¾åæ€ä¹‰ï¼Œè¿™å°±æ˜¯æŠŠä¸»æœºä¸Šçš„æŸä¸ªpathæ˜ å°„åˆ°podé‡Œé¢ï¼Œå¦‚æœPodæŒ‚äº†ï¼Œæ•°æ®è¿˜åœ¨hostä¸Šï¼Œä¸è¿‡å¦‚æœhostæŒ‚äº†ï¼Œæ•°æ®ä¹Ÿå°±æ²¡äº†ã€‚</p><h2 id="gcePersistentDisk"><a href="#gcePersistentDisk" class="headerlink" title="gcePersistentDisk"></a>gcePersistentDisk</h2><p>é¡¾åæ€ä¹‰ï¼Œå¼ºè€¦åˆgceï¼Œä¸å¤šè¯´äº†ã€‚</p><h2 id="awsElasticBlockStore"><a href="#awsElasticBlockStore" class="headerlink" title="awsElasticBlockStore"></a>awsElasticBlockStore</h2><p>åŒä¸Š</p><h2 id="nfs"><a href="#nfs" class="headerlink" title="nfs"></a>nfs</h2><p>é€šè¿‡nfsï¼Œæˆ‘ä»¬å¯ä»¥mountä¸€ä¸ªnfs shareåˆ°podé‡Œã€‚</p><h2 id="iscsi"><a href="#iscsi" class="headerlink" title="iscsi"></a>iscsi</h2><p>åŒä¸Š</p><h2 id="secret"><a href="#secret" class="headerlink" title="secret"></a>secret</h2><p>æˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ªtypeæ¥æŠŠæˆ‘ä»¬æ”¾åœ¨secreté‡Œé¢çš„é‚£äº›æ¯”å¦‚å¯†ç å‘€tokenå‘€ä¹‹ç±»çš„ä¿¡æ¯æŒ‚è½½åˆ°podä¸Šï¼Œè®©åº”ç”¨å¯ä»¥ä½¿ç”¨ã€‚</p><h2 id="persistentVolumeClaim"><a href="#persistentVolumeClaim" class="headerlink" title="persistentVolumeClaim"></a>persistentVolumeClaim</h2><p>è¿™ä¸ªæ˜¯æœ€é‡è¦çš„ä¸€ç§ï¼Œä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ä¸€ç§ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸€ä¸ª<code>Persistent Volume(PV)</code>æŒ‚è½½åˆ°Podé‡Œé¢ï¼Œé€šè¿‡<code>persistentVolumeClaim(PVC)</code>ã€‚</p><h1 id="Persistent-Volumes"><a href="#Persistent-Volumes" class="headerlink" title="Persistent Volumes"></a>Persistent Volumes</h1><p>åœ¨ä¼ ç»Ÿçš„ITç¯å¢ƒä¸­ï¼Œä¸€èˆ¬å­˜å‚¨æ˜¯ç”±ç³»ç»Ÿç®¡ç†å‘˜æ¥ç®¡ç†çš„ï¼Œç»ˆç«¯ç”¨æˆ·åªæ˜¯è·å¾—å¦‚ä½•å»ä½¿ç”¨çš„æŒ‡å¯¼ï¼Œä½†æ˜¯ä¸ç”¨ç®¡åº•å±‚åˆ°åº•å­˜å‚¨æ˜¯æ€ä¹ˆç®¡ç†çš„ã€‚</p><p>åœ¨å®¹å™¨ä¸–ç•Œé‡Œé¢ï¼Œä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚Kubernetesæœ‰ä¸€ä¸ªå«åšPersistent Volumesçš„å­ç³»ç»Ÿï¼Œç®¡ç†å‘˜é€šè¿‡Persistent Volume APIå‘å…¶ä¸­æ·»åŠ å’Œç®¡ç†Persistent Volumeï¼Œç„¶åç”¨æˆ·ä½¿ç”¨Persistent Volume Claim APIæ¥ä½¿ç”¨ã€‚</p><p>ä¸€ä¸ªPVå°±æ˜¯ä¸€ä¸ªé€šè¿‡ç½‘ç»œæŒ‚è½½åˆ°é›†ç¾¤ä¸Šçš„å­˜å‚¨ã€‚</p><p><img data-src="https://static.purewhite.io/images/2017-12-25-73BBB017-7870-4014-88E4-67B1AE5BC73F.png!webp_90" alt="73BBB017-7870-4014-88E4-67B1AE5BC73F"></p><p>PVå¯ä»¥é€šè¿‡StorageClassè¿™ä¸ªresourceè¢«é™æ€åœ°åˆ›å»ºï¼Œä¹Ÿå¯ä»¥åŠ¨æ€åœ°è¢«æ·»åŠ ã€‚ä¸€ä¸ªStorageClassåŒ…å«äº†é¢„å®šä¹‰å¥½çš„åˆ›å»ºPVçš„åˆå§‹åŒ–å™¨å’Œå‚æ•°ã€‚</p><p>ä¸€äº›æ”¯æŒä½¿ç”¨PVè¿›è¡Œç®¡ç†çš„Volume Typesæ˜¯ï¼š</p><ul><li>GCEPersistentDisk</li><li>AWSElasticBlockStore</li><li>AzureFile</li><li>NFS</li><li>iSCSI</li><li>CephFS</li><li>Cinder</li><li>etc.</li></ul><h1 id="Persistent-Volume-Claims"><a href="#Persistent-Volume-Claims" class="headerlink" title="Persistent Volume Claims"></a>Persistent Volume Claims</h1><p>ä¸€ä¸ªPersistent Volume Claim(PVC)å°±æ˜¯ä¸€ä¸ªç”¨æˆ·æƒ³è¦ä½¿ç”¨storageçš„è¯·æ±‚ã€‚ç”¨æˆ·é€šè¿‡æŒ‡å®šæ¯”å¦‚å¤§å°ã€è®¿é—®æƒé™ç­‰æ¥ç”³è¯·PVèµ„æºï¼Œå½“æœ‰ä¸€ä¸ªåˆé€‚çš„èµ„æº(PV)è¢«æ‰¾åˆ°çš„æ—¶å€™ï¼Œå°±ä¼šå’ŒPVCç»‘å®šåœ¨ä¸€èµ·ï¼š</p><p><img data-src="https://static.purewhite.io/images/2017-12-25-CD52FF8E-EFFE-4519-AAD8-073BE55E97E5.png!webp_90" alt="CD52FF8E-EFFE-4519-AAD8-073BE55E97E5"></p><p>å½“bindæˆåŠŸä¹‹åï¼Œè¿™ä¸ªPVCå°±å¯ä»¥åœ¨Podé‡Œé¢ä½¿ç”¨äº†ï¼š</p><p><img data-src="https://static.purewhite.io/images/2017-12-25-2AECAABF-FE93-4F51-9716-CDBB334BE549.png!webp_90" alt="2AECAABF-FE93-4F51-9716-CDBB334BE549"></p><p>å½“ä¸€ä¸ªç”¨æˆ·ç»“æŸä½¿ç”¨ä¹‹åï¼Œç»‘å®šçš„PVå°±å¯ä»¥è¢«å½’è¿˜(release)äº†ï¼Œå°±å¯ä»¥é‡æ–°è¢«ç”³æ˜(reclaimed)å’Œä½¿ç”¨äº†ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå®¹å™¨æ˜¯ä¸€ä¸ªçŸ­æš‚çš„ä¸ç¨³å®šçš„å­˜åœ¨ï¼ˆéšæ—¶å¯èƒ½æŒ‚æ‰ï¼‰ï¼ŒæŒ‚æ‰ä¹‹åé‡Œé¢çš„æ‰€æœ‰æ•°æ®éƒ½æ²¡äº†ï¼Œä½†æ˜¯æˆ‘ä»¬ä¼šæœ‰å¾ˆå¤šæ•°æ®æ˜¯éœ€è¦ä¸€ç›´å­˜ä¸‹æ¥ï¼ˆæŒä¹…åŒ–ï¼‰çš„ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿæ€è·¯å¾ˆç®€å•ï¼ŒæŠŠå®¹å™¨é‡Œé¢çš„æ•°æ®å­˜åˆ°ä¸€ä¸ªå¯ä»¥æŒä¹…åŒ–çš„åœ°æ–¹ï¼ˆæ¯”å¦‚s3ä¸Šï¼‰ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://www.purewhite.io/categories/kubernetes/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="æ¶æ„" scheme="https://www.purewhite.io/tags/%E6%9E%B6%E6%9E%84/"/>
    
    <category term="docker" scheme="https://www.purewhite.io/tags/docker/"/>
    
    <category term="linux" scheme="https://www.purewhite.io/tags/linux/"/>
    
    <category term="è¿ç»´" scheme="https://www.purewhite.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="kubernetes" scheme="https://www.purewhite.io/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>kubernetesä¸­çš„Service</title>
    <link href="https://www.purewhite.io/2017/12/23/kubernetes-service/"/>
    <id>https://www.purewhite.io/2017/12/23/kubernetes-service/</id>
    <published>2017-12-22T16:52:22.000Z</published>
    <updated>2021-12-02T12:51:07.228Z</updated>
    
    <content type="html"><![CDATA[<p>Service æ˜¯kubernetesä¸­ä¸€ä¸ªå¾ˆé‡è¦çš„ï¼Œä¹Ÿæ˜¯å¾ˆæœ‰ç”¨çš„æ¦‚å¿µï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡serviceæ¥å°†podè¿›è¡Œåˆ†ç»„ï¼Œå¹¶æä¾›å¤–ç½‘çš„è®¿é—®endpointã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­è¿˜æœ‰æ¯”å¦‚<code>kube-proxy</code>æä¾›äº†å¯¹serviceçš„è®¿é—®ã€‚</p><span id="more"></span><h1 id="Connecting-Users-to-Pods"><a href="#Connecting-Users-to-Pods" class="headerlink" title="Connecting Users to Pods"></a>Connecting Users to Pods</h1><p>å¦‚æœæˆ‘ä»¬è¦è®©ä¸€ä¸ªç”¨æˆ·èƒ½å¤Ÿä½¿ç”¨åº”ç”¨ç¨‹åºï¼Œç”¨æˆ·éœ€è¦èƒ½è®¿é—®åˆ°podï¼Œä½†æ˜¯podæ˜¯ä¸€ä¸ªçŸ­æš‚å­˜åœ¨çš„ä¸œè¥¿ï¼Œå¾ˆå¯èƒ½çªç„¶æŒ‚äº†ç„¶åé‡å¯ï¼Œè¿™æ—¶å€™ipåœ°å€å°±ä¼šæ”¹å˜ï¼Œæ‰€ä»¥podçš„ipåœ°å€å¹¶ä¸æ˜¯é™æ€çš„ã€‚æ¯”å¦‚è¯´ï¼š</p><p><img data-src="https://static.purewhite.io/images/2017-12-23-E3FACD27-1617-40FE-A1EC-2099FD6AFF35.png!webp_90" alt="E3FACD27-1617-40FE-A1EC-2099FD6AFF35"></p><p>ç”¨æˆ·åœ¨è¿™å¼ å›¾é‡Œé¢é€šè¿‡ipåœ°å€è®¿é—®åˆ°äº†4ä¸ªpodï¼Œçªç„¶å…¶ä¸­æœ‰ä¸€ä¸ªpodæŒ‚äº†ï¼Œç„¶åcontrolleråˆèµ·äº†ä¸€ä¸ªpodï¼š</p><p><img data-src="https://static.purewhite.io/images/2017-12-23-BE6386EA-2846-4AD8-ACD3-80A6163AD935.png!webp_90" alt="BE6386EA-2846-4AD8-ACD3-80A6163AD935"></p><p>è¿™æ—¶å€™ç”¨æˆ·å°±è®¿é—®ä¸åˆ°äº†ï¼Œå› ä¸ºç”¨æˆ·ä¸çŸ¥é“æ–°çš„ipåœ°å€æ˜¯å¤šå°‘ã€‚</p><p>kubernetesä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæä¾›äº†ä¸€ä¸ªé«˜å±‚çš„æŠ½è±¡ï¼Œå«åšServiceã€‚Serviceä»é€»è¾‘ä¸ŠæŠŠpodè¿›è¡Œåˆ†ç»„ï¼Œå¹¶ä¸”è®¾ç½®è®¿é—®çš„ç­–ç•¥ã€‚ä¸€èˆ¬æˆ‘ä»¬æ˜¯é€šè¿‡labelå’Œselectoræ¥è¾¾åˆ°åˆ†ç»„çš„ç›®çš„çš„ã€‚</p><h1 id="Services"><a href="#Services" class="headerlink" title="Services"></a>Services</h1><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬ç”¨appä½œä¸ºkeyï¼Œdbå’Œfrontendä½œä¸ºvalueæ¥åŒºåˆ†podï¼š</p><p><img data-src="https://static.purewhite.io/images/2017-12-23-23B63A0F-40BC-4FF7-AAEC-4D1C11C54970.png!webp_90" alt="23B63A0F-40BC-4FF7-AAEC-4D1C11C54970"></p><p>é€šè¿‡selectorï¼ˆapp=frontendå’Œapp=dbï¼‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠè¿™äº›podåˆ†ä¸ºä¸¤ä¸ªé€»è¾‘ç»„äº†ã€‚</p><p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å†ç»™è¿™ä¸¤ä¸ªé€»è¾‘ç»„åŠ ä¸Šä¸€ä¸ªåç§°ï¼Œæ¯”å¦‚<code>frontend-svc</code>å’Œ<code>db-svc</code>ï¼Œå°±æ˜¯serviceäº†ï¼š</p><p><img data-src="https://static.purewhite.io/images/2017-12-23-F67805E2-CE2D-40A8-9CFD-DE79CFD832E4.png!webp_90" alt="F67805E2-CE2D-40A8-9CFD-DE79CFD832E4"></p><h1 id="Serviceå¯¹è±¡æ¨¡å‹"><a href="#Serviceå¯¹è±¡æ¨¡å‹" class="headerlink" title="Serviceå¯¹è±¡æ¨¡å‹"></a>Serviceå¯¹è±¡æ¨¡å‹</h1><p>ä¸€ä¸ªserviceå¯¹è±¡æ¨¡å‹å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªå¯¹è±¡æ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå«åš<code>frontend-svc</code>çš„Serviceï¼Œè¿™ä¸ªserviceé€‰æ‹©äº†æ‰€æœ‰çš„<code>app=frontend</code>çš„podã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªserviceéƒ½ä¼šæœ‰ä¸€ä¸ªclusterå†…éƒ¨å¯ä»¥è®¿é—®åˆ°çš„ipåœ°å€ï¼Œä¹Ÿè¢«ç§°ä¸º<code>ClusterIP</code>ï¼š</p><p><img data-src="https://static.purewhite.io/images/2017-12-23-3232AECF-82CA-45DF-B971-1EB278EFD552.png!webp_90" alt="3232AECF-82CA-45DF-B971-1EB278EFD552"></p><p>ç”¨æˆ·ç°åœ¨å¯ä»¥é€šè¿‡serviceçš„ipåœ°å€æ¥è®¿é—®åˆ°podäº†ï¼Œserviceä¼šè´Ÿè´£åšè´Ÿè½½å‡è¡¡ã€‚</p><p>å½“è½¬å‘è¯·æ±‚çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©podä¸Šçš„ç›®æ ‡ç«¯å£ï¼Œæ¯”å¦‚åœ¨æˆ‘ä»¬çš„ä¾‹å­é‡Œé¢ï¼Œfrontend-svcé€šè¿‡80ç«¯å£æ¥æ¥å—ç”¨æˆ·çš„è¯·æ±‚ï¼Œç„¶åè½¬å‘åˆ°podçš„5000ç«¯å£ã€‚å¦‚æœç›®æ ‡ç«¯å£æ²¡æœ‰è¢«æ˜¾å¼å£°æ˜ï¼Œé‚£ä¹ˆä¼šé»˜è®¤è½¬å‘åˆ°serviceæ¥å—è¯·æ±‚çš„ç«¯å£ï¼ˆå’Œserviceç«¯å£ä¸€æ ·ï¼‰ã€‚</p><p>ä¸€ä¸ªpodã€ipåœ°å€å’Œç›®æ ‡ç«¯å£çš„å…ƒç»„ä»£è¡¨äº†ä¸€ä¸ªserviceçš„endpointï¼Œæ¯”å¦‚åœ¨è¿™ä¸ªä¾‹å­é‡Œé¢ï¼Œfrontend-svcæœ‰3ä¸ªendpointsï¼Œåˆ†åˆ«æ˜¯<code>10.0.1.3:5000</code>, <code>10.0.1.4:5000</code>å’Œ<code>10.0.1.5:5000</code>ã€‚</p><h1 id="kube-proxy"><a href="#kube-proxy" class="headerlink" title="kube-proxy"></a>kube-proxy</h1><p>æ‰€æœ‰çš„worker nodeéƒ½æœ‰ä¸€ä¸ªåå°ä»»åŠ¡ï¼Œå«åš<code>kube-proxy</code>ã€‚è¿™ä¸ªkube-proxyä¼šæ£€æµ‹API Serverä¸Šå¯¹äºserviceå’Œendpointçš„æ–°å¢æˆ–è€…ç§»é™¤ã€‚å¯¹äºæ¯ä¸ªæ–°çš„serviceï¼Œåœ¨æ¯ä¸ªnodeä¸Šï¼Œkube-proxyéƒ½ä¼šè®¾ç½®ç›¸åº”çš„iptablesçš„è§„åˆ™æ¥è®°å½•åº”è¯¥è½¬å‘çš„åœ°å€ã€‚å½“ä¸€ä¸ªserviceè¢«åˆ é™¤çš„æ—¶å€™ï¼Œkube-proxyä¼šåœ¨æ‰€æœ‰çš„podä¸Šç§»é™¤è¿™äº›iptablesçš„è§„åˆ™ã€‚</p><p><img data-src="https://static.purewhite.io/images/2017-12-23-0608F78E-6A96-403A-A9E1-3095AE3625F3.png!webp_90" alt="0608F78E-6A96-403A-A9E1-3095AE3625F3"></p><h1 id="æœåŠ¡å‘ç°"><a href="#æœåŠ¡å‘ç°" class="headerlink" title="æœåŠ¡å‘ç°"></a>æœåŠ¡å‘ç°</h1><p>æˆ‘ä»¬å·²ç»çŸ¥é“ï¼ŒServiceæ˜¯å’Œkubernetesè¿›è¡Œæ²Ÿé€šçš„ä¸»è¦æ–¹å¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦æœ‰ä¸€ä¸ªåŠæ³•æ¥åœ¨è¿è¡Œçš„æ—¶å€™èƒ½å¤Ÿå¯¹å·²æœ‰çš„æœåŠ¡è¿›è¡Œå‘ç°ã€‚Kubernetesæä¾›äº†ä¸¤ç§æ–¹æ³•ï¼š</p><h3 id="ç¯å¢ƒå˜é‡"><a href="#ç¯å¢ƒå˜é‡" class="headerlink" title="ç¯å¢ƒå˜é‡"></a>ç¯å¢ƒå˜é‡</h3><p>æ¯ä¸ªpodåœ¨worker nodeä¸Šå¯åŠ¨çš„æ—¶å€™ï¼Œkubeletéƒ½ä¼šé€šè¿‡ç¯å¢ƒå˜é‡æŠŠæ‰€æœ‰ç›®å‰å¯ç”¨çš„serviceçš„ä¿¡æ¯ä¼ è¿›å»ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå«åš<code>redis-master</code>çš„serviceï¼Œè¿™ä¸ªservice exposeäº†6379çš„ç«¯å£ï¼Œå¹¶ä¸”ClusterIPæ˜¯172.17.0.6ï¼Œé‚£ä¹ˆåœ¨ä¸€ä¸ªæ–°åˆ›å»ºçš„podä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">REDIS_MASTER_SERVICE_HOST=172.17.0.6</span><br><span class="line">REDIS_MASTER_SERVICE_PORT=6379</span><br><span class="line">REDIS_MASTER_PORT=tcp://172.17.0.6:6379</span><br><span class="line">REDIS_MASTER_PORT_6379_TCP=tcp://172.17.0.6:6379</span><br><span class="line">REDIS_MASTER_PORT_6379_TCP_PROTO=tcp</span><br><span class="line">REDIS_MASTER_PORT_6379_TCP_PORT=6379</span><br><span class="line">REDIS_MASTER_PORT_6379_TCP_ADDR=172.17.0.6</span><br></pre></td></tr></table></figure><p>å¦‚æœä½¿ç”¨è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬å¿…é¡»éå¸¸å°å¿ƒå¯åŠ¨æœåŠ¡çš„é¡ºåºï¼Œå› ä¸ºpodä¸ä¼šè·å¾—è‡ªå·±å¯åŠ¨ä¹‹åçš„serviceçš„envã€‚</p><h3 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h3><p>kubernetesæœ‰ä¸€äº›dnsçš„addonï¼Œè¿™äº›addonä¼šè‡ªåŠ¨ä¸ºæ‰€æœ‰serviceåˆ›å»ºä¸€ä¸ªç±»ä¼¼<code>my-svc.my-namespace.svc.cluster.local</code>çš„dnsè§£æï¼Œå¹¶ä¸”åœ¨åŒä¸€ä¸ªnamespaceé‡Œé¢çš„serviceå¯ä»¥ç›´æ¥ç”¨service nameè¿›è¡Œè®¿é—®ã€‚è¿™æ˜¯æœ€ä¸ºæ¨èçš„æ–¹æ³•ã€‚</p><h1 id="Serviceç±»å‹"><a href="#Serviceç±»å‹" class="headerlink" title="Serviceç±»å‹"></a>Serviceç±»å‹</h1><p>å½“æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªserviceçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©å¯è®¿é—®çš„èŒƒå›´ï¼Œæ¯”å¦‚ï¼š</p><ul><li>æ˜¯å¦åªèƒ½åœ¨clusterå†…éƒ¨è®¿é—®</li><li>æ˜¯å¦åŒæ—¶å¯ä»¥è¢«clusterå†…éƒ¨å’Œå¤–éƒ¨è®¿é—®</li><li>æ˜¯å¦æ˜¯æ˜ å°„åˆ°ä¸€ä¸ªé›†ç¾¤å¤–çš„entityä¸Š</li></ul><p>å¯è®¿é—®çš„èŒƒå›´ç”±serviceçš„ç±»å‹å†³å®šï¼Œserviceçš„ç±»å‹å¯ä»¥åœ¨åˆ›å»ºserviceçš„æ—¶å€™å£°æ˜ã€‚</p><h3 id="ClusterIP-å’Œ-NodePort"><a href="#ClusterIP-å’Œ-NodePort" class="headerlink" title="ClusterIP å’Œ NodePort"></a>ClusterIP å’Œ NodePort</h3><p>ClusterIPæ˜¯é»˜è®¤çš„service typeï¼Œä¸€ä¸ªserviceé€šè¿‡ClusterIPæ¥è·å–è‡ªå·±çš„Virtual IPï¼Œè¿™ä¸ªIPæ˜¯ç”¨æ¥å’Œåˆ«çš„serviceé€šä¿¡çš„ï¼Œåªèƒ½åœ¨é›†ç¾¤å†…éƒ¨è¢«è®¿é—®ã€‚</p><p>NodePortçš„service typeé™¤äº†ä¼šåˆ›å»ºä¸€ä¸ªClusterIPä¹‹å¤–ï¼Œè¿˜ä¼šæŠŠæ‰€æœ‰worker nodeä¸Šçš„ä¸€ä¸ª30000-32767ä¹‹é—´çš„ç«¯å£æ˜ å°„åˆ°è¿™ä¸ªserviceï¼Œæ¯”å¦‚å‡è®¾<code>32233</code>ç«¯å£æ˜ å°„åˆ°äº†<code>frontend-svc</code>ï¼Œé‚£ä¹ˆä¸ç®¡æˆ‘ä»¬è¿æ¥åˆ°å“ªä¸ªworker nodeï¼Œæˆ‘ä»¬éƒ½ä¼šè¢«è½¬å‘åˆ°serviceåˆ†é…çš„ClusterIPâ€”â€”172.17.0.4ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“exposeåˆ°æœ‰ä¸€ä¸ªnodeportçš„æ—¶å€™ï¼Œkubernetes masterä¼šè‡ªåŠ¨éšæœºé€‰æ‹©ä¸€ä¸ª30000-32767ä¹‹é—´çš„portï¼Œå½“ç„¶ï¼Œæˆ‘ä»¬è‡ªå·±ä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®šè¿™ä¸ªportã€‚</p><p><img data-src="https://static.purewhite.io/images/2017-12-23-A943E99B-5473-4177-B8AF-543939949F0B.png!webp_90" alt="A943E99B-5473-4177-B8AF-543939949F0B"></p><p>NodePortçš„è¿™ä¸ªservice typeåœ¨æˆ‘ä»¬æƒ³è¦è®©å¤–ç½‘è®¿é—®æˆ‘ä»¬æœåŠ¡çš„æ—¶å€™éå¸¸æœ‰ç”¨ï¼Œç”¨æˆ·é€šè¿‡è®¿é—®nodeä¸ŠæŒ‡å®šçš„portå°±å¯ä»¥è®¿é—®åˆ°è¿™ä¸ªserviceã€‚ç®¡ç†å‘˜å¯ä»¥åœ¨kubernetesé›†ç¾¤å¤–å†æ­ä¸€ä¸ªåå‘ä»£ç†å°±å¯ä»¥æ›´æ–¹ä¾¿åœ°è¿›è¡Œè®¿é—®äº†ã€‚</p><h3 id="LoadBalancer"><a href="#LoadBalancer" class="headerlink" title="LoadBalancer"></a>LoadBalancer</h3><p>å¯¹äºLoadBalancerè¿™ä¸ªServicetypeï¼š</p><ul><li>NodePortå’ŒClusterIPä¼šè¢«è‡ªåŠ¨åˆ›å»ºï¼Œå¤–éƒ¨çš„load balancerä¼šè‡ªåŠ¨è·¯ç”±ä¸Šå»</li><li>serviceä¼šåœ¨ä¸€ä¸ªé™æ€çš„ç«¯å£ä¸Šè¢«æš´éœ²</li><li>é€šè¿‡åº•å±‚çš„cloud provideræä¾›çš„load balanceræ¥æš´éœ²åˆ°å¤–ç½‘</li></ul><p><img data-src="https://static.purewhite.io/images/2017-12-23-8C099E38-B51E-4688-B693-1FF2F46FCE0B.png!webp_90" alt="8C099E38-B51E-4688-B693-1FF2F46FCE0B"></p><p>LoadBalancerè¿™ä¸ªservice typeåªæœ‰åœ¨åº•å±‚çš„åŸºç¡€æ¶æ„æ”¯æŒäº†è‡ªåŠ¨åˆ›å»ºload balancerçš„æ—¶å€™kubernetesæ‰æ”¯æŒï¼Œæ¯”å¦‚Google Cloud Platformå’Œawsã€‚</p><h3 id="ExternalIP"><a href="#ExternalIP" class="headerlink" title="ExternalIP"></a>ExternalIP</h3><p>å¦‚æœä¸€ä¸ªserviceå¯ä»¥è·¯ç”±åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªworker nodeä¸Šï¼Œé‚£ä¹ˆå®ƒå¯ä»¥è¢«æ˜ å°„åˆ°ä¸€ä¸ªExternalIPåœ°å€ã€‚é€šè¿‡è¿™ä¸ªExternalIPè¿›å…¥åˆ°é›†ç¾¤çš„æµé‡ä¼šè¢«è·¯ç”±åˆ°å…¶ä¸­ä¸€ä¸ªendpointä¸Šã€‚</p><p><img data-src="https://static.purewhite.io/images/2017-12-23-1B599B5F-0EA5-46A5-B505-2FC2658AC55C.png!webp_90" alt="1B599B5F-0EA5-46A5-B505-2FC2658AC55C"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒExternalIPå¹¶ä¸æ˜¯ç”±k8sè‡ªåŠ¨ç®¡ç†çš„ï¼Œæ˜¯ç”±ç®¡ç†å‘˜æ‰‹åŠ¨è®¾ç½®è·¯ç”±åˆ°å…¶ä¸­çš„ä¸€ä¸ªnodeä¸Šçš„ã€‚</p><h3 id="ExternalName"><a href="#ExternalName" class="headerlink" title="ExternalName"></a>ExternalName</h3><p>ExternalNameæ˜¯ä¸€ä¸ªç‰¹å®šçš„service typeï¼Œè¿™ç§service typeæ²¡æœ‰ä»»ä½•çš„selectorä¹Ÿæ²¡æœ‰ä»»ä½•å£°æ˜çš„endpointã€‚å½“åœ¨é›†ç¾¤ä¸­è®¿é—®åˆ°è¿™ä¸ªserviceçš„æ—¶å€™ï¼Œä¼šè¿”å›ä¸€ä¸ªå¤–éƒ¨æœåŠ¡çš„CNAMEã€‚</p><p>è¿™ä¸ªserviceä¸€èˆ¬æ˜¯ç”¨æ¥è®©ä¸€ä¸ªå¤–éƒ¨çš„æœåŠ¡åœ¨é›†ç¾¤å†…éƒ¨å¯ä»¥è®¿é—®åˆ°çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªå¤–éƒ¨æœåŠ¡å«åš<code>my-database.example.com</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®ExternalNameç±»å‹çš„Serviceï¼Œè®©å†…éƒ¨çš„å…¶å®ƒserviceé€šè¿‡<code>my-database</code>ä¹‹ç±»çš„åå­—è®¿é—®åˆ°è¿™ä¸ªæœåŠ¡ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Service æ˜¯kubernetesä¸­ä¸€ä¸ªå¾ˆé‡è¦çš„ï¼Œä¹Ÿæ˜¯å¾ˆæœ‰ç”¨çš„æ¦‚å¿µï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡serviceæ¥å°†podè¿›è¡Œåˆ†ç»„ï¼Œå¹¶æä¾›å¤–ç½‘çš„è®¿é—®endpointã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­è¿˜æœ‰æ¯”å¦‚&lt;code&gt;kube-proxy&lt;/code&gt;æä¾›äº†å¯¹serviceçš„è®¿é—®ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://www.purewhite.io/categories/kubernetes/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="æ¶æ„" scheme="https://www.purewhite.io/tags/%E6%9E%B6%E6%9E%84/"/>
    
    <category term="docker" scheme="https://www.purewhite.io/tags/docker/"/>
    
    <category term="linux" scheme="https://www.purewhite.io/tags/linux/"/>
    
    <category term="è¿ç»´" scheme="https://www.purewhite.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="kubernetes" scheme="https://www.purewhite.io/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Building Blocks</title>
    <link href="https://www.purewhite.io/2017/12/22/kubernetes-building-blocks/"/>
    <id>https://www.purewhite.io/2017/12/22/kubernetes-building-blocks/</id>
    <published>2017-12-22T15:44:37.000Z</published>
    <updated>2021-12-02T12:51:07.227Z</updated>
    
    <content type="html"><![CDATA[<p>Kubernetesä¸­æœ‰å¾ˆå¤šç§¯æœ¨ï¼ˆBuilding Blocksï¼‰ï¼Œæ¯”å¦‚object modelï¼Œpodï¼Œrsï¼Œdeploymentï¼Œnamespaceä¹‹ç±»ï¼Œè¿™äº›éƒ½æ˜¯kubernetesä¸­å¾ˆé‡è¦çš„ä¸œè¥¿ã€‚</p><span id="more"></span><h1 id="Kubernetes-Object-Model"><a href="#Kubernetes-Object-Model" class="headerlink" title="Kubernetes Object Model"></a>Kubernetes Object Model</h1><p>kubernetesæœ‰ä¸€ä¸ªéå¸¸å®Œå–„çš„å¯¹è±¡æ¨¡å‹ï¼Œkubernetesé›†ç¾¤å¯ä»¥é€šè¿‡è¿™ä¸ªå¯¹è±¡æ¨¡å‹æ¥è¡¨ç°å‡ºä¸åŒçš„æŒä¹…åŒ–çš„æ•´ä½“ï¼Œæ¯”å¦‚ï¼š</p><ul><li>æˆ‘ä»¬æ˜¯åœ¨å“ªä¸ªnodeä¸Šè¿è¡Œå“ªä¸ªå®¹å™¨åŒ–çš„åº”ç”¨ç¨‹åºï¼Ÿ</li><li>åº”ç”¨ç¨‹åºèµ„æºæ¶ˆè€—</li><li>åº”ç”¨ç¨‹åºä¸åŒçš„ç­–ç•¥</li></ul><p>å¯¹äºæ¯ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬ç”¨<code>spec</code>è¿™ä¸ªfieldå£°æ˜æˆ‘ä»¬æœŸæœ›çš„çŠ¶æ€ï¼Œéšåkubernetesä¼šé€šè¿‡<code>status</code>è¿™ä¸ªfieldè®°å½•å¯¹è±¡å®é™…çš„çŠ¶æ€å¹¶åŠ ä»¥ç®¡ç†ã€‚éšåï¼Œkubernetesçš„controller managerä¼šæƒ³åŠæ³•è®©è¿™ä¸ªå¯¹è±¡å®é™…çš„çŠ¶æ€å’Œæˆ‘ä»¬å£°æ˜æœŸæœ›çš„çŠ¶æ€ç›¸åŒã€‚</p><p>kubernetesä¸­çš„ä¾‹å­æ¯”å¦‚ï¼šPodsï¼ŒDeploymentsï¼ŒReplicaSetsä¹‹ç±»ã€‚</p><p>å¦‚æœæˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ<code>spec</code>è¿™ä¸ªfieldæä¾›ç»™API Serverï¼Œè¿™ä¸ªfieldä¼šæè¿°æˆ‘ä»¬æœŸæœ›çš„çŠ¶æ€ä»¥åŠä¸€äº›åŸºç¡€çš„ä¿¡æ¯ï¼Œæ¯”å¦‚åç§°ã€‚åˆ›å»ºå¯¹è±¡çš„APIè¯·æ±‚å¿…é¡»æœ‰<code>spec</code>è¿™ä¸ªfieldä»¥åŠå…¶å®ƒè¯¦ç»†ä¿¡æ¯ï¼Œå¹¶ä¸”éœ€è¦æ˜¯JSONçš„æ ¼å¼ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç”¨yamlæ ¼å¼æ¥æä¾›ä¸€ä¸ªå¯¹è±¡çš„å£°æ˜ï¼Œkubectlä¼šæŠŠè¿™ä¸ªå£°æ˜è½¬æ¢æˆJSONæ ¼å¼ï¼Œç„¶åä¼ ç»™API Serverã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªDeploymentå¯¹è±¡çš„ä¾‹å­ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">             <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.7.9</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>æ’æ’­ä¸€æ¡å¹¿å‘Šï¼š</p><blockquote><h3 id="Apps"><a href="#Apps" class="headerlink" title="Apps"></a>Apps</h3><p>The core workloads API, which is composed of the DaemonSet, Deployment, ReplicaSet, and StatefulSet kinds, has been promoted to GA stability in the apps/v1 group version. As such, the apps/v1beta2 group version is deprecated, and all new code should use the kinds in the apps/v1 group version.</p></blockquote><p>æ¥ç€è¯´ï¼ŒapiVersionæŒ‡å®šäº†æˆ‘ä»¬è°ƒç”¨çš„apiçš„endpointï¼›é€šè¿‡kind fieldï¼Œæˆ‘ä»¬æŒ‡å®šäº†æˆ‘ä»¬è¦åˆ›å»ºçš„å¯¹è±¡çš„ç±»å‹ï¼›é€šè¿‡metadataï¼Œæˆ‘ä»¬ç»™å¯¹è±¡é™„åŠ ä¸Šäº†æœ€åŸºæœ¬çš„ä¿¡æ¯ï¼Œæ¯”å¦‚åå­—ï¼›ä½ å¯ä»¥å‘ç°è¿™é‡Œé¢æœ‰ä¸¤ä¸ª<code>spec</code>çš„fieldï¼ˆ<code>spec</code>å’Œ<code>spec.template.spec</code>ï¼‰ï¼Œé€šè¿‡ <code>spec</code>ï¼Œæˆ‘ä»¬å®šä¹‰äº†æˆ‘ä»¬å¯¹deploymentçš„æœŸæœ›çŠ¶æ€ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æƒ³è¦ç¡®è®¤ï¼Œåœ¨ä»»ä½•æ—¶å€™ï¼Œéƒ½æœ‰è‡³å°‘3ä¸ªpodåœ¨è¿è¡Œã€‚æˆ‘ä»¬å†åœ¨<code>spec.template.spec</code>é‡Œé¢å®šä¹‰æˆ‘ä»¬è¦è¿è¡Œçš„æ¯ä¸ªpodéƒ½åº”è¯¥æ˜¯ä»€ä¹ˆçŠ¶æ€ï¼Œæ‰€ä»¥è¿™å°±æ˜¯ä¸ºå•¥è¿™é‡Œä¼šæœ‰ä¸¤ä¸ªspecçš„åŸå› ã€‚</p><p>ä¸€æ—¦è¿™ä¸ªå¯¹è±¡è¢«åˆ›å»ºäº†ï¼Œkubernetesä¼šç›´æ¥ç»™å¯¹è±¡æ·»åŠ ä¸€ä¸ª<code>status</code>çš„fieldï¼Œå¦‚ä¸‹ï¼š</p><p><img data-src="https://static.purewhite.io/images/2017-12-22-70B197CF-63EA-401C-B029-AFC9F9271D91.png!webp_90" alt="70B197CF-63EA-401C-B029-AFC9F9271D91"></p><h1 id="Pods"><a href="#Pods" class="headerlink" title="Pods"></a>Pods</h1><p>Podæ˜¯kubernetesä¸­æœ€ç®€å•ä¹Ÿæ˜¯æœ€å°çš„ä¸€ä¸ªå¯¹è±¡ï¼Œæ˜¯kuberneteséƒ¨ç½²çš„ä¸€ä¸ªå•å…ƒï¼Œä»£è¡¨äº†åº”ç”¨çš„ä¸€ä¸ªå•ä¸€å®ä¾‹ã€‚ä¸€ä¸ªPodæ˜¯ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨çš„é€»è¾‘ä¸Šçš„é›†åˆï¼Œè¿™äº›å®¹å™¨æ‹¥æœ‰ä»¥ä¸‹çš„ç‰¹æ€§ï¼š</p><ul><li>åœ¨åŒä¸€ä¸ªhostä¸Šä¸€èµ·è¿›è¡Œè°ƒåº¦</li><li>å…±äº«åŒä¸€ä¸ªnetwork namespace</li><li>æŒ‚è½½åŒæ ·çš„external storageï¼ˆvolumesï¼‰</li></ul><p><img data-src="https://static.purewhite.io/images/2017-12-22-38D8B067-9AD2-4CE0-85C5-70C3D5538FB0.png!webp_90" alt="38D8B067-9AD2-4CE0-85C5-70C3D5538FB0"></p><p>Podå¹¶éä¸€ä¸ªæŒä¹…åŒ–çš„ä¸œè¥¿ï¼Œå¾ˆæœ‰å¯èƒ½çªç„¶æŒ‚äº†ï¼Œå¹¶ä¸”æ²¡æœ‰èƒ½åŠ›è‡ªæˆ‘ä¿®å¤ï¼Œè¿™å°±æ˜¯ä¸ºå•¥æˆ‘ä»¬æŠŠå®ƒä»¬å’Œcontrollerä¸€èµ·ç”¨ï¼Œè¿™æ ·å¯ä»¥æ¥æ§åˆ¶podçš„replicaï¼Œå®¹é”™ï¼Œè‡ªæˆ‘ä¿®å¤ç­‰ç­‰ã€‚æ¯”è¾ƒæœ‰åçš„ä¾‹å­æ¯”å¦‚Deploymentsï¼ŒReplicaSetsç­‰ã€‚æˆ‘ä»¬é€šè¿‡æŠŠPodçš„å®šä¹‰ï¼ˆspecificationï¼Œä¹Ÿå°±æ˜¯<code>spec</code>ï¼‰é™„åŠ åˆ°åˆ«çš„å¯¹è±¡ï¼ˆä¹Ÿå°±æ˜¯ä¹‹å‰ç”¨çš„<code>template.spec</code>ï¼‰æ¥å®Œæˆã€‚</p><h1 id="Labels"><a href="#Labels" class="headerlink" title="Labels"></a>Labels</h1><p>Labelséƒ½æ˜¯é”®å€¼å¯¹ï¼Œè¿™äº›é”®å€¼å¯¹å¯ä»¥è¢«attachåˆ°kubernetesçš„å¯¹è±¡ä¸Šï¼Œæ¯”å¦‚Podã€‚Labelsä¸€èˆ¬è¢«ç”¨æ¥ç»„ç»‡å’Œé€‰æ‹©ä¸€äº›ç¬¦åˆæ¡ä»¶çš„å¯¹è±¡ã€‚labelä¸æä¾›å”¯ä¸€æ€§ã€‚</p><p><img data-src="https://static.purewhite.io/images/2017-12-22-5594660A-4922-497F-9BB6-69CDE96238B3.png!webp_90" alt="5594660A-4922-497F-9BB6-69CDE96238B3"></p><p>é€šè¿‡è¿™ä¸ªå›¾ç‰‡ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç”¨äº†ä¸¤ä¸ªlabelï¼š<code>app</code>å’Œ<code>env</code>ã€‚åŸºäºæˆ‘ä»¬çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥ç»™æˆ‘ä»¬çš„podä¸åŒçš„å€¼ã€‚</p><h1 id="Label-Selectors"><a href="#Label-Selectors" class="headerlink" title="Label Selectors"></a>Label Selectors</h1><p>é€šè¿‡Label  Selectorsï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¸€ç³»åˆ—çš„å¯¹è±¡ï¼ŒKubernetesæ”¯æŒä¸¤ç§Selectorç±»å‹ï¼š</p><h3 id="Equality-Based-Selectors"><a href="#Equality-Based-Selectors" class="headerlink" title="Equality-Based Selectors"></a>Equality-Based Selectors</h3><p>é¡¾åæ€ä¹‰ï¼Œè¿™ç§selectoré€šè¿‡ <code>==</code> æˆ–è€… <code>!=</code> æ¥è¿›è¡Œé€‰æ‹©ï¼Œæ¯”å¦‚æˆ‘ä»¬é€‰æ‹©ä¸€ä¸ª <code>env==dev</code> çš„å¯¹è±¡ï¼Œå°±ä¼šæ‰¾å‡ºæ‰€æœ‰æœ‰env labelï¼Œå¹¶ä¸”å€¼ä¸ºdevçš„ã€‚</p><h3 id="Set-Based-Selectors"><a href="#Set-Based-Selectors" class="headerlink" title="Set-Based Selectors"></a>Set-Based Selectors</h3><p>è¿™ç§selectoræ”¯æŒé€šè¿‡ä¸€ç³»åˆ—çš„å€¼æ¥è¿›è¡Œè¿‡æ»¤ï¼Œæ¯”å¦‚é€šè¿‡<code>in</code>, <code>notin</code>å’Œ<code>exist</code>ã€‚</p><p>ä¸¾ä¾‹ï¼š<code>env in (dev, qa)</code></p><p><img data-src="https://static.purewhite.io/images/2017-12-22-9DCAECB6-54CF-4789-94B8-4332BABE4B53.png!webp_90" alt="9DCAECB6-54CF-4789-94B8-4332BABE4B53"></p><h1 id="Replication-Controllers"><a href="#Replication-Controllers" class="headerlink" title="Replication Controllers"></a>Replication Controllers</h1><p>ä¸€ä¸ª ReplicationControllerï¼ˆrcï¼‰æ˜¯master nodeä¸ŠController Managerçš„ä¸€éƒ¨åˆ†ï¼Œä¸»è¦ä½œç”¨æ˜¯ä¿è¯æ¯ä¸ªpodçš„replicaéƒ½è¾¾åˆ°äº†é¢„æœŸå€¼ã€‚ä¸ç„¶çš„è¯ä¼šé€šè¿‡æ€æ­»æˆ–è€…æ–°å»ºpodçš„åŠæ³•æ¥è¾¾åˆ°ã€‚ä¸è¿‡ç°åœ¨å·²ç»è¢«ReplicaSet(rs)å–ä»£äº†ã€‚</p><h1 id="Replica-Sets"><a href="#Replica-Sets" class="headerlink" title="Replica Sets"></a>Replica Sets</h1><p>Replica Setæ˜¯ä¸‹ä¸€ä»£çš„Replication Controllerï¼Œå¥½å¤„åœ¨äºåŒæ—¶æ”¯æŒequality å’Œ set based selectorï¼ˆrcåªæ”¯æŒequality-basedï¼‰ã€‚ç›®å‰è¿™æ˜¯å”¯ä¸€çš„åŒºåˆ«ã€‚</p><p>Rså¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œä¸è¿‡ä¸€èˆ¬æ˜¯é…åˆdeploymentä¸€èµ·ç”¨ã€‚Deploymentä¼šè‡ªåŠ¨åˆ›å»ºrsæ¥ç®¡ç†ä¸‹é¢çš„podã€‚</p><h1 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h1><p>deploymentæä¾›äº†å¯¹äºpodå’Œrsçš„é™ˆè¿°æ€§æ›´æ–°ã€‚DeploymentControlleræ˜¯master nodeä¸ŠController Managerçš„ä¸€éƒ¨åˆ†ï¼Œä½œç”¨å’ŒController manageråˆ«çš„ä¸€æ ·â€”â€”ç¡®ä¿å½“å‰çš„çŠ¶æ€å’ŒæœŸæœ›çš„çŠ¶æ€ç›¸åŒã€‚</p><p>åœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„deploymentåˆ›å»ºäº†ä¸€ä¸ª rs Aï¼Œç„¶års Aåˆåˆ›å»ºäº†3ä¸ªpodï¼Œå¹¶ä¸”åœ¨æ¯ä¸ªpodä¸­ï¼Œéƒ½æœ‰ä¸€ä¸ªè·‘äº†nginx:1.7.9é•œåƒçš„å®¹å™¨ã€‚</p><p><img data-src="https://static.purewhite.io/images/2017-12-22-1A74F83F-00D9-4954-9737-D6C1BBAE3EF3.png!webp_90" alt="1A74F83F-00D9-4954-9737-D6C1BBAE3EF3"></p><p>æ¥ä¸‹æ¥ï¼Œåœ¨ä¸‹ä¸€ä¸ªdeploymentä¸­ï¼Œæˆ‘ä»¬ä¿®æ”¹äº†podçš„templateï¼ŒæŠŠnginxä»1.7.9å‡çº§åˆ°äº†1.9.1ã€‚å› ä¸ºæˆ‘ä»¬å‡çº§äº†æœŸæœ›çš„çŠ¶æ€ï¼Œæ‰€ä»¥deploymentä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„rs Bï¼Œè¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸ºDeployment rolloutï¼š</p><p><img data-src="https://static.purewhite.io/images/2017-12-22-D9667D97-B328-4C19-AA9F-FD9E7CDEDD65.png!webp_90" alt="D9667D97-B328-4C19-AA9F-FD9E7CDEDD65"></p><p>å½“rs Båˆ›å»ºå®Œæ¯•çš„æ—¶å€™ï¼Œdeploymentå¼€å§‹æŒ‡å‘å®ƒï¼š</p><p><img data-src="https://static.purewhite.io/images/2017-12-22-652F4886-8F15-4C27-9DDF-8C1DA7D1DF11.png!webp_90" alt="652F4886-8F15-4C27-9DDF-8C1DA7D1DF11"></p><p>åœ¨rsä¹‹ä¸Šï¼Œdeploymentæä¾›äº†å¾ˆå¤šç‰¹æ€§æ¯”å¦‚recordingï¼Œé€šè¿‡è¿™ä¸ªç‰¹æ€§ï¼Œå¦‚æœè¯´æ›´æ–°å‡ºé”™ï¼Œæˆ–è€…æ›´æ–°åçš„åº”ç”¨å‡ºäº†bugï¼Œæˆ‘ä»¬å¯ä»¥rollbackåˆ°åŸå…ˆçš„çŠ¶æ€ã€‚</p><h1 id="Namespaces"><a href="#Namespaces" class="headerlink" title="Namespaces"></a>Namespaces</h1><p>å¦‚æœæˆ‘ä»¬æœ‰æ— æ•°ä¸ªç”¨æˆ·ï¼Œæˆ‘ä»¬æƒ³æŠŠè¿™äº›ç”¨æˆ·ç»„ç»‡åˆ°ä¸åŒçš„teamæˆ–è€…projectï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡namespaceæŠŠkubernetesé›†ç¾¤åˆ†æˆå¥½å¤šä¸ªå°é›†ç¾¤ã€‚æ‰€æœ‰åœ¨namespaceä¸­åˆ›å»ºçš„resources/objectséƒ½æ˜¯å”¯ä¸€çš„ï¼Œä¸ä¼šè·¨å‘½åç©ºé—´ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œk8sä¼šæœ‰ä¸¤ä¸ªé»˜è®¤namespaceï¼škube-systemå’Œdefaultã€‚kube-systemä¸€èˆ¬ä¼šç”¨æ¥æ”¾ä¸€äº›kubernetesç³»ç»Ÿçš„ç»„ä»¶ï¼Œdefaultä¼šç”¨æ¥æ”¾ä¸€äº›å±äºå…¶å®ƒnamespaceçš„å¯¹è±¡ã€‚æˆ‘ä»¬é»˜è®¤æƒ…å†µä¸‹æ˜¯ä¼šè¿æ¥åˆ°defaultå‘½åç©ºé—´ã€‚kube-publicæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„namespaceï¼Œå¯ä»¥è¢«æ‰€æœ‰çš„ç”¨æˆ·è¯»ï¼Œä¸€èˆ¬ç”¨äºç‰¹æ®Šæƒ…å†µæ¯”å¦‚åˆå§‹åŒ–ä¸€ä¸ªé›†ç¾¤ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨èµ„æºé…é¢ï¼ˆResource Quotasï¼‰æ¥é™åˆ¶æ¯ä¸ªå‘½åç©ºé—´çš„èµ„æºã€‚</p><p>æœ€åå†æ’æ’­ä¸€æ¡å¹¿å‘Šï¼š</p><blockquote><p><img data-src="https://static.purewhite.io/images/2017-12-22-C8E9D1AC-E8F8-4544-8DB0-F4EAA6905F56.png!webp_90" alt="C8E9D1AC-E8F8-4544-8DB0-F4EAA6905F56"></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;Kubernetesä¸­æœ‰å¾ˆå¤šç§¯æœ¨ï¼ˆBuilding Blocksï¼‰ï¼Œæ¯”å¦‚object modelï¼Œpodï¼Œrsï¼Œdeploymentï¼Œnamespaceä¹‹ç±»ï¼Œè¿™äº›éƒ½æ˜¯kubernetesä¸­å¾ˆé‡è¦çš„ä¸œè¥¿ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://www.purewhite.io/categories/kubernetes/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="æ¶æ„" scheme="https://www.purewhite.io/tags/%E6%9E%B6%E6%9E%84/"/>
    
    <category term="docker" scheme="https://www.purewhite.io/tags/docker/"/>
    
    <category term="linux" scheme="https://www.purewhite.io/tags/linux/"/>
    
    <category term="è¿ç»´" scheme="https://www.purewhite.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="kubernetes" scheme="https://www.purewhite.io/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kuberneteså®‰è£…</title>
    <link href="https://www.purewhite.io/2017/12/22/install-kubernetes/"/>
    <id>https://www.purewhite.io/2017/12/22/install-kubernetes/</id>
    <published>2017-12-22T09:43:49.000Z</published>
    <updated>2021-12-02T12:51:07.227Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œä¼šä¸»è¦è®°å½•ä¸€ä¸‹kuberneteså®‰è£…ç›¸å…³çš„ä¿¡æ¯ã€‚</p><span id="more"></span><h1 id="Kubernetes-è®¾ç½®"><a href="#Kubernetes-è®¾ç½®" class="headerlink" title="Kubernetes è®¾ç½®"></a>Kubernetes è®¾ç½®</h1><p>Kuberneteså¯ä»¥é€šè¿‡ä¸åŒçš„è®¾ç½®å®‰è£…ï¼Œæ¯”è¾ƒæ™®éçš„å››ç§å®‰è£…æ–¹æ³•å¦‚ä¸‹ï¼š</p><h3 id="All-in-One-Single-Node-Installation"><a href="#All-in-One-Single-Node-Installation" class="headerlink" title="All-in-One Single-Node Installation"></a>All-in-One Single-Node Installation</h3><p>åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰çš„masterå’Œworkerç»„ä»¶éƒ½è¢«å®‰è£…åœ¨ä¸€ä¸ªnodeä¸Šï¼Œè¿™å¯¹å­¦ä¹ ã€å¼€å‘å’Œæµ‹è¯•éå¸¸æœ‰ç”¨ï¼Œä½†æ˜¯ä¸åº”è¯¥è¢«ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ã€‚minikubeå°±æ˜¯ä¸€ä¸ªä¾‹å­ã€‚</p><h3 id="Single-Node-etcd-Single-Master-and-Multi-Worker-Installation"><a href="#Single-Node-etcd-Single-Master-and-Multi-Worker-Installation" class="headerlink" title="Single-Node etcd, Single-Master, and Multi-Worker Installation"></a>Single-Node etcd, Single-Master, and Multi-Worker Installation</h3><p>åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå•ç‹¬çš„master nodeï¼Œåœ¨è¿™ä¸ªmaster nodeä¸ŠåŒæ—¶ä¹Ÿè·‘äº†ä¸€ä¸ªå•èŠ‚ç‚¹çš„etcdå®ä¾‹ã€‚å¤šä¸ªworker nodeéƒ½è¿æ¥åˆ°è¿™ä¸€ä¸ªmaster nodeã€‚</p><h3 id="Single-Node-etcd-Multi-Master-and-Multi-Worker-Installation"><a href="#Single-Node-etcd-Multi-Master-and-Multi-Worker-Installation" class="headerlink" title="Single-Node etcd, Multi-Master, and Multi-Worker Installation"></a>Single-Node etcd, Multi-Master, and Multi-Worker Installation</h3><p>åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬æœ‰å¤šä¸ªMaster nodeï¼Œmaster nodeå°†ä¼šåœ¨HAæ¨¡å¼ä¸‹å·¥ä½œï¼Œä½†æ˜¯æˆ‘ä»¬åªæœ‰ä¸€ä¸ªå•èŠ‚ç‚¹çš„etcdå®ä¾‹ã€‚å¤šä¸ªçš„worker nodeéƒ½ä¼šè¿æ¥åˆ°å¤šä¸ªmaster nodeä¸Šå»ã€‚</p><h3 id="Multi-Node-etcd-Multi-Master-and-Multi-Worker-Installation"><a href="#Multi-Node-etcd-Multi-Master-and-Multi-Worker-Installation" class="headerlink" title="Multi-Node etcd, Multi-Master, and Multi-Worker Installation"></a>Multi-Node etcd, Multi-Master, and Multi-Worker Installation</h3><p>åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œetcdè¢«è®¾ç½®æˆäº†é›†ç¾¤æ¨¡å¼ï¼Œå¹¶ä¸”åœ¨kubernetesé›†ç¾¤ä¹‹å¤–ã€‚æ‰€æœ‰çš„Nodeéƒ½ä¼šè¿æ¥åˆ°å®ƒä¸Šé¢å»ã€‚æ‰€æœ‰çš„master nodeéƒ½è¢«è®¾ç½®ä¸ºHAæ¨¡å¼ï¼Œå¹¶ä¸”è¿æ¥åˆ°æ‰€æœ‰çš„worker nodeä¸Šã€‚Productionéƒ½åº”è¯¥è¿™ä¹ˆç©ã€‚</p><h1 id="Kuberneteséœ€è¦çš„åŸºç¡€è®¾æ–½"><a href="#Kuberneteséœ€è¦çš„åŸºç¡€è®¾æ–½" class="headerlink" title="Kuberneteséœ€è¦çš„åŸºç¡€è®¾æ–½"></a>Kuberneteséœ€è¦çš„åŸºç¡€è®¾æ–½</h1><p>å½“æˆ‘ä»¬å†³å®šäº†å®‰è£…çš„ç±»å‹ï¼Œæˆ‘ä»¬åŒæ—¶éœ€è¦å†³å®šä¸€ä¸‹åŸºç¡€æ¶æ„ç›¸å…³çš„å†³å®šï¼Œæ¯”å¦‚ï¼š</p><ul><li>æˆ‘ä»¬åº”è¯¥åœ¨è£¸æœºä¸Šå®‰è£…k8sï¼Œè¿˜æ˜¯åœ¨å…¬æœ‰äº‘ï¼Œè¿˜æ˜¯åœ¨ç§æœ‰äº‘ï¼Ÿ</li><li>æˆ‘ä»¬åº”è¯¥ç”¨å“ªç§æ“ä½œç³»ç»Ÿï¼ŸRHELï¼ŒCoreOSï¼ŒCentOSï¼Ÿ</li><li>æˆ‘ä»¬åº”è¯¥ç”¨å“ªç§ç½‘ç»œè§£å†³æ–¹æ¡ˆï¼Ÿ</li><li>ä»¥åŠå…¶å®ƒçš„ã€‚</li></ul><h3 id="æœ¬åœ°å®‰è£…"><a href="#æœ¬åœ°å®‰è£…" class="headerlink" title="æœ¬åœ°å®‰è£…"></a>æœ¬åœ°å®‰è£…</h3><p>æœ¬åœ°å®‰è£…æ¨èä½¿ç”¨ minikubeã€‚</p><h3 id="åœ¨è™šæ‹Ÿæœºæˆ–è€…è£¸æœºä¸Š"><a href="#åœ¨è™šæ‹Ÿæœºæˆ–è€…è£¸æœºä¸Š" class="headerlink" title="åœ¨è™šæ‹Ÿæœºæˆ–è€…è£¸æœºä¸Š"></a>åœ¨è™šæ‹Ÿæœºæˆ–è€…è£¸æœºä¸Š</h3><p>kuberneteséƒ½æ”¯æŒå®‰è£…åœ¨è™šæ‹Ÿæœºæˆ–è€…è£¸æœºä¸Šï¼Œæœ‰å¾ˆå¤šå·¥å…·æ¯”å¦‚ansibleå’ŒkubeadmåŒæ—¶æ”¯æŒè¿™ä¸¤ç§å®‰è£…ã€‚</p><h3 id="å®‰è£…åœ¨äº‘ä¸Š"><a href="#å®‰è£…åœ¨äº‘ä¸Š" class="headerlink" title="å®‰è£…åœ¨äº‘ä¸Š"></a>å®‰è£…åœ¨äº‘ä¸Š</h3><p>è¿™ä¸ªå°±ä¸ç”¨å¤šè¯´äº†ï¼Œäº¤ä¿æŠ¤è´¹å³å¯ã€‚</p><h1 id="Kuberneteså®‰è£…å·¥å…·"><a href="#Kuberneteså®‰è£…å·¥å…·" class="headerlink" title="Kuberneteså®‰è£…å·¥å…·"></a>Kuberneteså®‰è£…å·¥å…·</h1><p>ç›®å‰æ¯”è¾ƒæœ‰åçš„æœ‰ä¸‰ä¸ªï¼škubeadm, kubespray, kopsã€‚</p><p>åŒºåˆ«åœ¨äºï¼Œkubeadmæ”¯æŒä»»ä½•ç¯å¢ƒï¼Œkubesprayæ˜¯åŸºäºansibleçš„ï¼Œkopsç›®å‰å’Œawså’Œgceå¼ºè€¦åˆã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œä¼šä¸»è¦è®°å½•ä¸€ä¸‹kuberneteså®‰è£…ç›¸å…³çš„ä¿¡æ¯ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://www.purewhite.io/categories/kubernetes/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="æ¶æ„" scheme="https://www.purewhite.io/tags/%E6%9E%B6%E6%9E%84/"/>
    
    <category term="docker" scheme="https://www.purewhite.io/tags/docker/"/>
    
    <category term="linux" scheme="https://www.purewhite.io/tags/linux/"/>
    
    <category term="è¿ç»´" scheme="https://www.purewhite.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="kubernetes" scheme="https://www.purewhite.io/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes æ¶æ„ Overview</title>
    <link href="https://www.purewhite.io/2017/12/22/kubernetes-concepts/"/>
    <id>https://www.purewhite.io/2017/12/22/kubernetes-concepts/</id>
    <published>2017-12-22T05:51:13.000Z</published>
    <updated>2021-12-02T12:51:07.227Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘æ­£åœ¨å¤ä¹ å‡†å¤‡è€ƒè¯•ï¼Œäºæ˜¯ä¸€è¾¹å¤ä¹ ä¸€éå†™æˆåšå®¢ï¼Œå°è¯è‡ªå·±æ‰€å­¦ã€‚</p><span id="more"></span><h1 id="Kubernetesæ¶æ„"><a href="#Kubernetesæ¶æ„" class="headerlink" title="Kubernetesæ¶æ„"></a>Kubernetesæ¶æ„</h1><p>ä»é«˜å±‚çœ‹ï¼Œkubernetesæ˜¯ç”±å¦‚ä¸‹ä¸œè¥¿ç»„æˆçš„ï¼š</p><ul><li>ä¸€ä¸ªæˆ–å¤šä¸ªmaster node</li><li>ä¸€ä¸ªæˆ–å¤šä¸ªworker node</li><li>ä¸€ä¸ªåˆ†å¸ƒå¼çš„key-valueå­˜å‚¨ï¼Œæ¯”å¦‚<code>etcd</code></li></ul><p><img data-src="https://static.purewhite.io/images/2017-12-22-2FDF2789-F7EA-4EE6-8561-6FE7AD4A79D6.png!webp_90" alt="2FDF2789-F7EA-4EE6-8561-6FE7AD4A79D6"></p><h1 id="Master-Node"><a href="#Master-Node" class="headerlink" title="Master Node"></a>Master Node</h1><p>Master node æ˜¯é›†ç¾¤ç®¡ç†è€…ï¼Œæˆ‘ä»¬å‘å‡ºçš„æ‰€æœ‰è¯·æ±‚éƒ½æ˜¯åˆ°master nodeçš„api serverä¸Šã€‚</p><p>ä¸€ä¸ªé›†ç¾¤å¯ä»¥æœ‰å¤šä¸ªmaster nodeåšHAï¼Œå½“æœ‰å¤šä¸ªmaster nodeçš„æ—¶å€™ï¼Œåªæœ‰ä¸€ä¸ªä¼šæä¾›æœåŠ¡ï¼Œå‰©ä¸‹çš„éƒ½æ˜¯followerã€‚</p><p>é›†ç¾¤çš„çŠ¶æ€ä¸€èˆ¬å­˜å‚¨åœ¨<code>etcd</code>é‡Œé¢ï¼Œæ‰€æœ‰çš„master nodeéƒ½ä¼šè¿æ¥åˆ°etcdã€‚etcdæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼k-vå­˜å‚¨ã€‚etcdå¯ä»¥æ˜¯masterå†…éƒ¨çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤–éƒ¨çš„ã€‚</p><h3 id="Master-nodeçš„ç»„ä»¶"><a href="#Master-nodeçš„ç»„ä»¶" class="headerlink" title="Master nodeçš„ç»„ä»¶"></a>Master nodeçš„ç»„ä»¶</h3><p>master nodeä¸€èˆ¬éƒ½æœ‰å¦‚ä¸‹ç»„ä»¶ï¼š</p><h4 id="API-Server"><a href="#API-Server" class="headerlink" title="API Server"></a>API Server</h4><p>æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯é€šè¿‡ API Server å»å®Œæˆçš„ã€‚æ¯ä¸ªç”¨æˆ·/æ“ä½œè€…é€šè¿‡å‘é€RESTè¯·æ±‚åˆ°api serverï¼Œç„¶åapi serverå…ˆéªŒè¯ç„¶åæ‰§è¡Œè¿™äº›æ“ä½œã€‚åœ¨æ‰§è¡Œå®Œä¹‹åæŠŠé›†ç¾¤çš„çŠ¶æ€å­˜åˆ°etcdé‡Œé¢ã€‚</p><h4 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h4><p>é¡¾åæ€ä¹‰ï¼ŒSchedulerçš„ä½œç”¨æ˜¯è°ƒåº¦ï¼ŒScheduleræ‹¥æœ‰æ‰€æœ‰worker nodeçš„èµ„æºä½¿ç”¨æƒ…å†µï¼ŒåŒæ—¶ä¹ŸçŸ¥é“ç”¨æˆ·è®¾ç½®çš„èµ„æºéœ€æ±‚ï¼Œæ¯”å¦‚è¯´ä¸€ä¸ª <code>disk=ssd</code>çš„labelã€‚åœ¨è°ƒåº¦ä¹‹å‰ï¼Œschedulerè¿˜ä¼šè€ƒè™‘åˆ°service requirementsï¼Œdata localityï¼Œaffinityï¼Œanti-affinityç­‰ã€‚schedulerè´Ÿè´£çš„æ˜¯serviceå’Œpodçš„è°ƒåº¦ã€‚</p><h4 id="Controller-Manager"><a href="#Controller-Manager" class="headerlink" title="Controller Manager"></a>Controller Manager</h4><p>ç®€å•æ¥è¯´ï¼ŒController Manageræ˜¯è´Ÿè´£å¯åŠ¨å’Œå…³é—­podçš„ã€‚Controller Managerçš„ä»»åŠ¡æ˜¯è®©é›†ç¾¤ç»´æŒåœ¨æœŸæœ›çš„çŠ¶æ€ä¸Šã€‚Controller ManagerçŸ¥é“æ¯ä¸ªPodçš„çŠ¶æ€åº”è¯¥æ˜¯ä»€ä¹ˆæ ·ï¼Œç„¶åä¼šä¸æ–­æ£€æµ‹æ˜¯å¦æœ‰ä¸è¾¾æ ‡çš„podã€‚</p><h1 id="Worker-Node"><a href="#Worker-Node" class="headerlink" title="Worker Node"></a>Worker Node</h1><p>Worker Nodeå°±æ˜¯ä¸€ä¸ªè¢«master nodeæ§åˆ¶çš„æœºå™¨ï¼ŒPodä¸€èˆ¬éƒ½æ˜¯è°ƒåº¦åˆ°worker nodeé‡Œé¢çš„ã€‚Worker nodeä¼šæœ‰ä¸€äº›å¯ä»¥è¿è¡Œä»¥åŠè¿æ¥å®¹å™¨çš„å·¥å…·ã€‚Podæ˜¯kubernetesé‡Œé¢çš„è°ƒåº¦å•å…ƒï¼Œæ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ç»„æˆçš„é€šå¸¸ä¸€èµ·è°ƒåº¦çš„é€»è¾‘ä¸Šçš„é›†åˆã€‚</p><p><img data-src="https://static.purewhite.io/images/2017-12-22-D012D35E-5431-411E-AD4A-829A268E0875.png!webp_90" alt="D012D35E-5431-411E-AD4A-829A268E0875"></p><h3 id="Worker-Nodeç»„ä»¶"><a href="#Worker-Nodeç»„ä»¶" class="headerlink" title="Worker Nodeç»„ä»¶"></a>Worker Nodeç»„ä»¶</h3><p>ä¸€ä¸ªworker nodeä¸€èˆ¬ä¼šæœ‰ä»¥ä¸‹ç»„ä»¶ï¼š</p><h4 id="Contrainer-Runtime"><a href="#Contrainer-Runtime" class="headerlink" title="Contrainer Runtime"></a>Contrainer Runtime</h4><p>ä¸ç”¨å¤šè¯´äº†ï¼Œè¿è¡Œå®¹å™¨å¿…å¤‡çš„ï¼Œé»˜è®¤ç”¨çš„æ˜¯Docker</p><h4 id="kubelet"><a href="#kubelet" class="headerlink" title="kubelet"></a>kubelet</h4><p>kubeletæ˜¯åœ¨æ¯ä¸ªworker nodeä¸Šéƒ½ä¼šè¿è¡Œçš„ï¼Œç”¨æ¥å’Œmaster nodeé€šä¿¡çš„ã€‚kubeletä»masteræ¥æ”¶podçš„å®šä¹‰ï¼Œç„¶åå¯åŠ¨é‡Œé¢çš„å®¹å™¨ï¼Œå¹¶ç›‘æ§å®¹å™¨æ˜¯å¦ä¸€ç›´æ­£å¸¸è¿è¡Œã€‚</p><h4 id="kube-proxy"><a href="#kube-proxy" class="headerlink" title="kube-proxy"></a>kube-proxy</h4><p>kube-proxyç®€å•æ¥è¯´ï¼Œå°±æ˜¯å¯¹å¤–æä¾›ä»£ç†æœåŠ¡çš„ã€‚æ¢å¥è¯è¯´ï¼Œæ²¡æœ‰kube-proxyï¼Œæˆ‘ä»¬è¦è®¿é—®å…¶ä¸­çš„applicationï¼Œå°±å¾—ç›´æ¥è®¿é—®åˆ°worker nodeä¸Šï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸åˆç†çš„ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡kube-proxyæ¥åšload balancerç­‰ã€‚ä»¥å‰ç‰ˆæœ¬çš„Serviceä¹Ÿå€ŸåŠ©äº†kube-proxyã€‚</p><h1 id="ç”¨etcdæ¥ç®¡ç†çŠ¶æ€"><a href="#ç”¨etcdæ¥ç®¡ç†çŠ¶æ€" class="headerlink" title="ç”¨etcdæ¥ç®¡ç†çŠ¶æ€"></a>ç”¨etcdæ¥ç®¡ç†çŠ¶æ€</h1><p>åœ¨kubernetesé‡Œé¢ï¼Œéƒ½æ˜¯ç”¨çš„etcdæ¥ç®¡ç†æ‰€æœ‰çš„çŠ¶æ€ã€‚é™¤äº†é›†ç¾¤çš„çŠ¶æ€ä¹‹å¤–ï¼Œè¿˜ä¼šç”¨æ¥å­˜æ”¾ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚configmapï¼Œsecretã€‚</p><h1 id="ç½‘ç»œéœ€æ±‚"><a href="#ç½‘ç»œéœ€æ±‚" class="headerlink" title="ç½‘ç»œéœ€æ±‚"></a>ç½‘ç»œéœ€æ±‚</h1><p>ä¸ºäº†å¯åŠ¨ä¸€ä¸ªå…¨åŠŸèƒ½çš„kubernetesé›†ç¾¤ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç¡®è®¤ä»¥ä¸‹ä¿¡æ¯ï¼š</p><ul><li>æ¯ä¸ªPodæœ‰å”¯ä¸€ä¸€ä¸ªç‹¬ç«‹çš„IP</li><li>æ¯ä¸ªPodé‡Œé¢çš„å®¹å™¨å¯ä»¥äº’ç›¸æ²Ÿé€š</li><li>Podä¹‹é—´å¯ä»¥äº’ç›¸æ²Ÿé€š</li><li>é€šè¿‡è®¾ç½®ï¼Œåœ¨Podé‡Œé¢çš„applicationå¯ä»¥è¢«å¤–éƒ¨è®¿é—®åˆ°</li></ul><p>è¿™äº›é—®é¢˜éƒ½æ˜¯éœ€è¦åœ¨éƒ¨ç½²ä¹‹å‰è¢«è§£å†³çš„ã€‚</p><p>æˆ‘ä»¬ä¸€ä¸ªä¸ªçœ‹ï¼š</p><h3 id="ç»™æ¯ä¸ªPodåˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„IP"><a href="#ç»™æ¯ä¸ªPodåˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„IP" class="headerlink" title="ç»™æ¯ä¸ªPodåˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„IP"></a>ç»™æ¯ä¸ªPodåˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„IP</h3><p>åœ¨kubernetesé‡Œé¢ï¼Œæ¯ä¸ªPodéƒ½è¦æœ‰ä¸€ä¸ªç‹¬ç«‹çš„IPã€‚ä¸€èˆ¬å®¹å™¨ç½‘ç»œæœ‰ä¸¤ç§è§„æ ¼ï¼š</p><ul><li>Container Network Model (CNM)</li><li>Container Network Interface (CNI)</li></ul><p>Kubernetesç”¨CNIæ¥ç»™Podåˆ†é…IP</p><p><img data-src="https://static.purewhite.io/images/2017-12-22-CA97E57F-D3C7-4BF0-BD0F-AB8E83838655.png!webp_90" alt="CA97E57F-D3C7-4BF0-BD0F-AB8E83838655"></p><p>ç®€å•æ¥è¯´ï¼Œå®¹å™¨è¿è¡Œæ—¶å‘CNIç”³è¯·IPï¼Œç„¶åCNIé€šè¿‡å…¶ä¸‹é¢æŒ‡å®šçš„pluginæ¥è·å–åˆ°IPï¼Œå¹¶ä¸”è¿”å›ç»™å®¹å™¨è¿è¡Œæ—¶ã€‚</p><h3 id="å®¹å™¨ä¹‹é—´äº¤æµ"><a href="#å®¹å™¨ä¹‹é—´äº¤æµ" class="headerlink" title="å®¹å™¨ä¹‹é—´äº¤æµ"></a>å®¹å™¨ä¹‹é—´äº¤æµ</h3><p>ä¸€èˆ¬åŸºäºåº•å±‚æ“ä½œç³»ç»Ÿçš„å¸®åŠ©ï¼Œæ‰€æœ‰çš„å®¹å™¨è¿è¡Œæ—¶éƒ½ä¼šç»™æ¯ä¸ªå®¹å™¨åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„éš”ç¦»çš„ç½‘ç»œæ•´ä½“ã€‚åœ¨Linuxä¸Šï¼Œè¿™ä¸ªæ•´ä½“è¢«ç§°ä¸ºNetwork Namespaceï¼Œè¿™äº›Network Namespaceå¯ä»¥åœ¨å®¹å™¨ä¹‹é—´å…±äº«ã€‚</p><p>åœ¨ä¸€ä¸ªPodé‡Œé¢ï¼Œå®¹å™¨å…±äº«Network Namespaceï¼Œæ‰€ä»¥æ‰€æœ‰åœ¨åŒä¸€ä¸ªPodé‡Œé¢çš„å®¹å™¨å¯ä»¥é€šè¿‡localhostæ¥äº’ç›¸è®¿é—®ã€‚</p><h3 id="è·¨Nodeçš„Podä¹‹é—´è®¿é—®"><a href="#è·¨Nodeçš„Podä¹‹é—´è®¿é—®" class="headerlink" title="è·¨Nodeçš„Podä¹‹é—´è®¿é—®"></a>è·¨Nodeçš„Podä¹‹é—´è®¿é—®</h3><p>åœ¨ä¸€ä¸ªé›†ç¾¤çš„ç¯å¢ƒä¸‹ï¼Œæ¯ä¸ªPodå¯ä»¥è¢«è°ƒåº¦åˆ°ä»»ä½•ä¸€ä¸ªNodeä¸Šï¼Œæˆ‘ä»¬éœ€è¦è®©åœ¨ä¸åŒæœºå™¨ä¸Šçš„Podä¹Ÿå¯ä»¥ç›¸äº’é€šä¿¡ï¼Œå¹¶ä¸”ä»»ä½•Nodeéƒ½å¯ä»¥è®¿é—®åˆ°ä»»ä½•Podã€‚Kubernetesè®¾å®šäº†ä¸€ä¸ªæ¡ä»¶ï¼šä¸èƒ½æœ‰ä»»ä½•çš„NATè½¬æ¢ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥è¾¾æˆï¼š</p><ul><li>å¯è·¯ç”±ï¼ˆRoutableï¼‰çš„Podå’ŒNodeï¼Œé€šè¿‡åº•å±‚çš„æœåŠ¡ï¼Œæ¯”å¦‚GCEã€‚</li><li>é€šè¿‡ä¸€äº›è½¯ä»¶å®šä¹‰çš„ç½‘ç»œï¼ˆSoftware Defined Networkingï¼‰ï¼Œæ¯”å¦‚flannelï¼Œweaveï¼Œcalicoç­‰</li></ul><p>æ›´å¤šçš„ä¿¡æ¯å¯ä»¥çœ‹çœ‹kubernetesçš„å®˜æ–¹æ–‡æ¡£ã€‚</p><h3 id="å¤–ç½‘å’Œé›†ç¾¤ä¹‹é—´çš„è®¿é—®"><a href="#å¤–ç½‘å’Œé›†ç¾¤ä¹‹é—´çš„è®¿é—®" class="headerlink" title="å¤–ç½‘å’Œé›†ç¾¤ä¹‹é—´çš„è®¿é—®"></a>å¤–ç½‘å’Œé›†ç¾¤ä¹‹é—´çš„è®¿é—®</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>kube-proxy</code>æ¥æš´éœ²æˆ‘ä»¬çš„serviceï¼Œç„¶åå°±èƒ½ä»å¤–é¢è®¿é—®åˆ°æˆ‘ä»¬é›†ç¾¤é‡Œé¢çš„åº”ç”¨äº†ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘æ­£åœ¨å¤ä¹ å‡†å¤‡è€ƒè¯•ï¼Œäºæ˜¯ä¸€è¾¹å¤ä¹ ä¸€éå†™æˆåšå®¢ï¼Œå°è¯è‡ªå·±æ‰€å­¦ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://www.purewhite.io/categories/kubernetes/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="æ¶æ„" scheme="https://www.purewhite.io/tags/%E6%9E%B6%E6%9E%84/"/>
    
    <category term="docker" scheme="https://www.purewhite.io/tags/docker/"/>
    
    <category term="linux" scheme="https://www.purewhite.io/tags/linux/"/>
    
    <category term="è¿ç»´" scheme="https://www.purewhite.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="kubernetes" scheme="https://www.purewhite.io/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠHead First è®¾è®¡æ¨¡å¼ã€‹è¯»ä¹¦ç¬”è®°0.5 â€”â€” å¼•å­</title>
    <link href="https://www.purewhite.io/2017/12/21/design-pattern-opening-words/"/>
    <id>https://www.purewhite.io/2017/12/21/design-pattern-opening-words/</id>
    <published>2017-12-21T09:23:12.000Z</published>
    <updated>2021-12-02T12:51:07.225Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸ºä»€ä¹ˆå¼•å­æˆ‘è¿˜è¦å†™ä¸€ç¯‡æ–‡ç« å‘¢ï¼Ÿå› ä¸ºå¼•å­ä»‹ç»äº†å¾ˆå¤šå…³äºå¤§è„‘è®¤çŸ¥çš„çŸ¥è¯†ï¼Œè¿™æœ¬ä¹¦è¿ç”¨äº†å…¶ä¸­çš„å¾ˆå¤šçŸ¥è¯†æ¥å†™ä½œï¼Œè¿™ä¹Ÿæ˜¯è¿™æœ¬ä¹¦ä¸ºä»€ä¹ˆå¦‚æ­¤ç«å¦‚æ­¤å‡ºåçš„åŸå› ã€‚æˆ‘è®¤ä¸ºè¿™å¯èƒ½ä¼šå¯¹æˆ‘å·¥ä½œæˆ–è€…å­¦ä¹ äº§ç”Ÿå¸®åŠ©ï¼Œæ‰€ä»¥è®°å½•ä¸‹æ¥ã€‚</p><span id="more"></span><h2 id="å¤§è„‘æ€»æ˜¯æ¸´æ±‚ä¸€äº›å¥‡æ€ªçš„ä¸œè¥¿"><a href="#å¤§è„‘æ€»æ˜¯æ¸´æ±‚ä¸€äº›å¥‡æ€ªçš„ä¸œè¥¿" class="headerlink" title="å¤§è„‘æ€»æ˜¯æ¸´æ±‚ä¸€äº›å¥‡æ€ªçš„ä¸œè¥¿"></a>å¤§è„‘æ€»æ˜¯æ¸´æ±‚ä¸€äº›<code>å¥‡æ€ª</code>çš„ä¸œè¥¿</h2><p>å¥½å§ï¼ŒåŸæ–‡æ„æ€æ˜¯ï¼Œå¤§è„‘æ€»æ˜¯æ¸´æ±‚ä¸€äº›æ–°å¥‡çš„ä¸œè¥¿ï¼Œæˆ–è€…ä¸å¯»å¸¸çš„äº‹ç‰©å‘ç”Ÿï¼Œæˆ‘ä»¬çš„å¤§è„‘ä¸ä¼šæ³¨æ„ä¸€äº›ä¹ ä»¥ä¸ºå¸¸çš„ä¸œè¥¿ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¸ä¼šæ³¨æ„å¾ˆå¹³å¸¸çš„è·¯äººï¼Œä½†æ˜¯ä¼šæ³¨æ„åˆ°å¾ˆå¤šâ€œç‰¹ç«‹ç‹¬è¡Œâ€çš„äººã€‚</p><p>æ¯”å¦‚è¯´ï¼Œå½“ä½ æ‹¿åˆ°ä¸€æœ¬500é¡µçš„æ•™ç§‘ä¹¦ï¼Œä¹¦ä¸Šå¯†å¯†éº»éº»éƒ½æ˜¯æ–‡å­—ï¼Œä½ çš„å¤§è„‘è‚¯å®šæƒ³ç€â€œ**ï¼Œåˆæ˜¯è¿™ç§ç©æ„å„¿ï¼Œæ— èŠâ€¦â€¦â€</p><p>ä½†æ˜¯å¦‚æœå½“ä½ æ‹¿åˆ°ä¸€æœ¬ æ—¥æœ¬HäºŒæ¬¡å…ƒæ¼«ç”»ï¼Œè¿˜æ˜¯ æ—¶å´ç‹‚ä¸‰ æˆ–è€… ç©¹å¦¹ çš„è¿™ä¸ªæ—¶å€™ä½ çš„å¤§è„‘å°±ä¼šâ€¦â€¦</p><p>æˆ–è€…å†ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ å°±æ™®é€šçš„åœ¨è·¯ä¸Šèµ°ï¼Œä½ çš„å¤§è„‘ä¼šåŠªåŠ›çš„å»æ’é™¤é‚£äº›ä¸é‡è¦çš„ä¸œè¥¿ï¼Œä½†æ˜¯å¦‚æœä½ èµ°ç€èµ°ç€ï¼Œçªç„¶ä½ é¢å‰è¹¦å‡ºä¸€ä¸ªå¤§è€è™ï¼Œä½ çš„å¤§è„‘è‚¯å®šä¸€ä¸‹å­å°±æƒ…ç»ªçˆ†å‘ï¼ˆåŸæ–‡ï¼‰äº†ã€‚</p><p>Head firstç³»åˆ—é€šè¿‡ä¸€äº›æœ€æ–°çš„è®¤çŸ¥ç§‘å­¦ã€ç¥ç»ç”Ÿç‰©å­¦å’Œæ•™è‚²å¿ƒç†å­¦æ¥åˆ›ä½œï¼Œæœ‰ä»¥ä¸‹ä¸€äº›åŸåˆ™ï¼š</p><ol><li>çœ‹å¾—åˆ°ã€‚ä¸å•çº¯çš„æ–‡å­—ç›¸æ¯”ï¼Œå›¾ç‰‡æ›´èƒ½è®©äººè®°å¾—ä½ï¼Œé€šè¿‡å›¾ç‰‡ï¼Œå­¦ä¹ æ•ˆç‡ä¼šæ›´é«˜ï¼Œç”šè‡³èƒ½æœ‰å¤šè¾¾89%çš„æé«˜ã€‚</li><li>é‡‡ç”¨ä¸€ç§é’ˆå¯¹ä¸ªäººå¼çš„äº¤è°ˆå¼é£æ ¼ã€‚</li><li>è®©å­¦ä¹ çš„äººæƒ³å¾—æ›´æ·±ã€‚</li><li>å¼•èµ·è¯»è€…çš„æ³¨æ„ï¼Œè€Œä¸”è¦è®©ä»–ä¸€ç›´ä¿æŒæ³¨æ„ã€‚</li><li>å½±å“è¯»è€…çš„æƒ…ç»ªã€‚</li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸ºä»€ä¹ˆå¼•å­æˆ‘è¿˜è¦å†™ä¸€ç¯‡æ–‡ç« å‘¢ï¼Ÿå› ä¸ºå¼•å­ä»‹ç»äº†å¾ˆå¤šå…³äºå¤§è„‘è®¤çŸ¥çš„çŸ¥è¯†ï¼Œè¿™æœ¬ä¹¦è¿ç”¨äº†å…¶ä¸­çš„å¾ˆå¤šçŸ¥è¯†æ¥å†™ä½œï¼Œè¿™ä¹Ÿæ˜¯è¿™æœ¬ä¹¦ä¸ºä»€ä¹ˆå¦‚æ­¤ç«å¦‚æ­¤å‡ºåçš„åŸå› ã€‚æˆ‘è®¤ä¸ºè¿™å¯èƒ½ä¼šå¯¹æˆ‘å·¥ä½œæˆ–è€…å­¦ä¹ äº§ç”Ÿå¸®åŠ©ï¼Œæ‰€ä»¥è®°å½•ä¸‹æ¥ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="https://www.purewhite.io/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="https://www.purewhite.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    <category term="go" scheme="https://www.purewhite.io/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ kubeadm åˆ›å»ºä¸€ä¸ª kubernetes é›†ç¾¤</title>
    <link href="https://www.purewhite.io/2017/12/17/use-kubeadm-setup-k8s/"/>
    <id>https://www.purewhite.io/2017/12/17/use-kubeadm-setup-k8s/</id>
    <published>2017-12-17T09:22:34.000Z</published>
    <updated>2021-12-02T12:51:07.230Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p><code>kubeadm</code>æ˜¯ä¸€ä¸ª<code>kubernetes</code>å®˜æ–¹æä¾›çš„å¿«é€Ÿå®‰è£…å’Œåˆå§‹åŒ–æ‹¥æœ‰<strong>æœ€ä½³å®è·µï¼ˆbest practiceï¼‰</strong>çš„<code>kubernetes</code>é›†ç¾¤çš„å·¥å…·ï¼Œè™½ç„¶ç›®å‰è¿˜å¤„äº beta å’Œ alpha çŠ¶æ€ï¼Œè¿˜ä¸èƒ½ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡å­¦ä¹ è¿™ç§éƒ¨ç½²æ–¹æ³•æ¥ä½“ä¼šä¸€äº›å®˜æ–¹æ¨èçš„kubernetesæœ€ä½³å®è·µçš„è®¾è®¡å’Œæ€æƒ³ã€‚</p><span id="more"></span><p><code>kubeadm</code>çš„ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªæœ€å°å¯ç”¨çš„å¯ä»¥é€šè¿‡<code>Kubernetesä¸€è‡´æ€§æµ‹è¯•</code>çš„é›†ç¾¤ï¼Œæ‰€ä»¥å¹¶ä¸ä¼šå®‰è£…ä»»ä½•é™¤æ­¤ä¹‹å¤–çš„éå¿…é¡»çš„addonã€‚</p><p><code>kubeadm</code>é»˜è®¤æƒ…å†µä¸‹å¹¶ä¸ä¼šå®‰è£…ä¸€ä¸ªç½‘ç»œè§£å†³æ–¹æ¡ˆï¼Œæ‰€ä»¥ç”¨<code>kubeadm</code>å®‰è£…å®Œä¹‹å éœ€è¦è‡ªå·±æ¥å®‰è£…ä¸€ä¸ªç½‘ç»œçš„æ’ä»¶ã€‚</p><h1 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h1><h2 id="ç³»ç»Ÿç¯å¢ƒ"><a href="#ç³»ç»Ÿç¯å¢ƒ" class="headerlink" title="ç³»ç»Ÿç¯å¢ƒ"></a>ç³»ç»Ÿç¯å¢ƒ</h2><p><code>kubeadm</code>æ”¯æŒå¤šç§ç³»ç»Ÿï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹éœ€è¦çš„ç³»ç»Ÿè¦æ±‚ï¼š</p><ol><li>Ubuntu16.04+ / Debian 9 / CentOS 7 / RHEL 7 / Fedora 25/26(best-effort) / HypriotOS v1.0.1+ / Other</li><li>2GBæˆ–è€…ä»¥ä¸Šçš„RAMï¼ˆå¦åˆ™å°†æ²¡æœ‰è¶³å¤Ÿç©ºé—´ç•™ç»™appï¼‰</li><li>2æ ¸ä»¥ä¸ŠCPU</li><li>é›†ç¾¤çš„æœºå™¨ä¹‹é—´å¿…é¡»èƒ½é€šè¿‡ç½‘ç»œäº’ç›¸é€šä¿¡</li><li><strong><u>SWAPå¿…é¡»è¢«å…³é—­ï¼Œå¦åˆ™<code>kubelet</code>ä¼šå‡ºé”™ï¼</u></strong></li></ol><p>å…·ä½“çš„è¯¦ç»†ä¿¡æ¯å¯ä»¥åœ¨å®˜æ–¹ç½‘ç«™ä¸Šçœ‹åˆ°ã€‚</p><p>æœ¬ç¯‡å†…å®¹åŸºäºawsçš„ap-northeast-1çš„ec2ï¼Œ<code>CentOS 7 </code>çš„æ“ä½œç³»ç»Ÿï¼ˆami-4dd5522bï¼‰ï¼Œå®ä¾‹ç±»å‹t2.medium 2æ ¸4GBï¼Œ3å°æœºå™¨ï¼Œ1 masterï¼Œ2 nodesï¼Œkubernetes 1.9 ç‰ˆæœ¬ã€‚ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œåœ¨å®‰å…¨ç»„é‡Œé¢æ‰“å¼€äº†æ‰€æœ‰çš„ç«¯å£å’ŒIPè®¿é—®ã€‚</p><p>æœºå™¨é…ç½®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[centos@ip-172-31-24-49 ~]$ uname -a</span><br><span class="line">Linux ip-172-31-24-49.ap-northeast-1.compute.internal 3.10.0-693.5.2.el7.x86_64 #1 SMP Fri Oct 20 20:32:50 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure><p>é¦–å…ˆ ï¼Œæˆ‘ä»¬å…³é—­selinuxï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo vim /etc/sysconfig/selinux</span></span><br></pre></td></tr></table></figure><p><img data-src="https://static.purewhite.io/images/2017-12-17-91C23F22-58A4-4F03-842F-97018D78F9D8.png!webp_90" alt="91C23F22-58A4-4F03-842F-97018D78F9D8"></p><p>æŠŠSELINUXæ”¹æˆdisabledï¼Œç„¶åä¿å­˜é€€å‡ºã€‚</p><p>åœ¨æˆ‘ç”¨çš„amiä¸­ï¼Œswapæ˜¯é»˜è®¤å…³é—­çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦æˆ‘æ‰‹åŠ¨å…³é—­ï¼Œå¤§å®¶éœ€è¦ç¡®è®¤ è‡ªå·±çš„ç¯å¢ƒä¸­swapæ˜¯å¦æœ‰å…³é—­æ‰ï¼Œå¦åˆ™ä¼šåœ¨ä¹‹åçš„ç¯èŠ‚ä¸­å‡ºé—®é¢˜ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬å®‰è£…ï¼Œæˆ‘ä»¬å°†sshdè®¾ç½®ä¸ºkeepaliveï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo -i</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;ClientAliveInterval 10&quot;</span> &gt;&gt; /etc/ssh/sshd_config</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;TCPKeepAlive yes&quot;</span> &gt;&gt; /etc/ssh/sshd_config</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl restart sshd.service</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬é‡å¯ä¸€ä¸‹æœºå™¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo sync</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo reboot</span></span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œå‡†å¤‡é˜¶æ®µç»“æŸã€‚</p><h2 id="å®‰è£…kubeadm"><a href="#å®‰è£…kubeadm" class="headerlink" title="å®‰è£…kubeadm"></a>å®‰è£…kubeadm</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ‰€æœ‰æœºå™¨ä¸Šéƒ½å®‰è£…<code>docker</code>, <code>kubeadm</code>, <code>kubelet</code>å’Œ<code>kubectl</code>ã€‚</p><p>åˆ‡è®°ï¼š**<code>kubeadm</code>ä¸ä¼šè‡ªåŠ¨å»å®‰è£…å’Œç®¡ç† <code>kubelet</code>å’Œ<code>kubectl</code>ï¼Œæ‰€ä»¥éœ€è¦è‡ªå·±å»ç¡®ä¿å®‰è£…çš„ç‰ˆæœ¬å’Œä½ æƒ³è¦å®‰è£…çš„<code>kubernetes</code>ç‰ˆæœ¬ç›¸åŒã€‚**</p><p>å®‰è£…<code>docker</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install -y docker</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl <span class="built_in">enable</span> docker &amp;&amp; sudo systemctl start docker</span></span><br></pre></td></tr></table></figure><p>åœ¨RHEL/CentOS 7 ç³»ç»Ÿä¸Šå¯èƒ½ä¼šè·¯ç”±å¤±è´¥ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo -i</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat &lt;&lt;<span class="string">EOF &gt;  /etc/sysctl.d/k8s.conf</span></span></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line"><span class="meta">$</span><span class="bash"><span class="string"> sudo sysctl --system</span></span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å®‰è£…<code>kubeadm</code>, <code>kubelet</code>å’Œ<code>kubectl</code>äº†ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåŠ ä¸€ä¸ªrepoï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat &lt;&lt;<span class="string">EOF &gt; /etc/yum.repos.d/kubernetes.repo</span></span></span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>ç„¶åå®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install -y kubelet kubeadm kubectl</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl <span class="built_in">enable</span> kubelet &amp;&amp; sudo systemctl start kubelet</span></span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œåœ¨æ‰€æœ‰æœºå™¨ä¸Šå®‰è£…æ‰€éœ€çš„è½¯ä»¶å·²ç»ç»“æŸã€‚</p><h2 id="ä½¿ç”¨kubeadmåˆå§‹åŒ–master"><a href="#ä½¿ç”¨kubeadmåˆå§‹åŒ–master" class="headerlink" title="ä½¿ç”¨kubeadmåˆå§‹åŒ–master"></a>ä½¿ç”¨kubeadmåˆå§‹åŒ–master</h2><p>å®‰è£…å®Œæ‰€æœ‰çš„ä¾èµ–ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨<code>kubeadm</code>åˆå§‹åŒ–masteräº†ã€‚</p><p>æœ€ç®€å•çš„åˆå§‹åŒ–æ–¹æ³•æ˜¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubeadm init</span></span><br></pre></td></tr></table></figure><p>é™¤æ­¤ä¹‹å¤–ï¼Œ<code>kubeadm</code>è¿˜æ”¯æŒå¤šç§æ–¹æ³•æ¥é…ç½®ï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£ã€‚</p><p>æˆ‘ä»¬åœ¨åˆå§‹åŒ–çš„æ—¶å€™æŒ‡å®šä¸€ä¸‹kubernetesç‰ˆæœ¬ï¼Œå¹¶è®¾ç½®ä¸€ä¸‹pod-network-cidrï¼ˆåé¢çš„flannelä¼šç”¨åˆ°ï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo -i</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubeadm init --kubernetes-version=v1.9.0 --pod-network-cidr=10.244.0.0/16</span></span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­<code>kubeadm</code>æ‰§è¡Œäº†ä¸€ç³»åˆ—çš„æ“ä½œï¼ŒåŒ…æ‹¬ä¸€äº›pre-checkï¼Œç”Ÿæˆcaè¯ä¹¦ï¼Œå®‰è£…etcdå’Œå…¶å®ƒæ§åˆ¶ç»„ä»¶ç­‰ã€‚</p><p>ç•Œé¢å·®ä¸å¤šå¦‚ä¸‹ï¼š</p><p><img data-src="https://static.purewhite.io/images/2017-12-17-2256534A-2144-4118-843C-7179EF34EC49.png!webp_90" alt="2256534A-2144-4118-843C-7179EF34EC49"></p><p>æœ€ä¸‹é¢çš„è¿™è¡Œ<code>kubeadm join</code>ä»€ä¹ˆçš„ï¼Œå°±æ˜¯ç”¨æ¥è®©åˆ«çš„nodeåŠ å…¥é›†ç¾¤çš„ï¼Œå¯ä»¥çœ‹å‡ºéå¸¸æ–¹ä¾¿ã€‚æˆ‘ä»¬è¦ä¿å­˜å¥½è¿™ä¸€è¡Œä¸œè¥¿ï¼Œè¿™æ˜¯æˆ‘ä»¬ä¹‹åè®©nodeåŠ å…¥é›†ç¾¤çš„å‡­æ®ï¼Œä¸€ä¼šå„¿ä¼šç”¨åˆ°ã€‚</p><p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬è¿˜ä¸èƒ½é€šè¿‡<code>kubectl</code>æ¥æ§åˆ¶é›†ç¾¤ï¼Œè¦è®©<code>kubectl</code>å¯ç”¨ï¼Œæˆ‘ä»¬éœ€è¦åšï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å¯¹äºérootç”¨æˆ·</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p <span class="variable">$HOME</span>/.kube</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯¹äºrootç”¨æˆ·</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¹Ÿå¯ä»¥ç›´æ¥æ”¾åˆ°~/.bash_profile</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;export KUBECONFIG=/etc/kubernetes/admin.conf&quot;</span> &gt;&gt; ~/.bash_profile</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è¦æ³¨æ„ï¼Œæˆ‘ä»¬<strong>å¿…é¡»</strong>è‡ªå·±æ¥å®‰è£…ä¸€ä¸ªnetwork  addonã€‚</p><p><strong><u>network addonå¿…é¡»åœ¨ä»»ä½•appéƒ¨ç½²ä¹‹å‰å®‰è£…å¥½ã€‚åŒæ ·çš„ï¼Œ<code>kube-dns</code>ä¹Ÿä¼šåœ¨network addonå®‰è£…å¥½ä¹‹åæ‰å¯åŠ¨ã€‚<code>kubeadm</code>åªæ”¯æŒCNI-based networksï¼ˆä¸æ”¯æŒ<code>kubenet</code>ï¼‰ã€‚</u></strong></p><p>æ¯”è¾ƒå¸¸è§çš„network addonæœ‰ï¼š<code>Calico</code>, <code>Canal</code>, <code>Flannel</code>, <code>Kube-router</code>, <code>Romana</code>, <code>Weave Net</code>ç­‰ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨<code>Flannel</code>ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.9.1/Documentation/kube-flannel.yml</span></span><br></pre></td></tr></table></figure><p>å®‰è£…å®Œnetworkä¹‹åï¼Œä½ å¯ä»¥é€šè¿‡<code>kubectl get pods --all-namespaces</code>æ¥æŸ¥çœ‹<code>kube-dns</code>æ˜¯å¦åœ¨runningæ¥åˆ¤æ–­networkæ˜¯å¦å®‰è£…æˆåŠŸã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ºäº†ä¿è¯masterçš„å®‰å…¨ï¼Œmasteræ˜¯ä¸ä¼šè¢«è°ƒåº¦åˆ°appçš„ã€‚ä½ å¯ä»¥å–æ¶ˆè¿™ä¸ªé™åˆ¶é€šè¿‡è¾“å…¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl taint nodes --all node-role.kubernetes.io/master-</span></span><br></pre></td></tr></table></figure><h2 id="åŠ å…¥nodes"><a href="#åŠ å…¥nodes" class="headerlink" title="åŠ å…¥nodes"></a>åŠ å…¥nodes</h2><p>ç»ˆäºéƒ¨ç½²å®Œäº†æˆ‘ä»¬çš„masterï¼</p><p>ç°åœ¨æˆ‘ä»¬å¼€å§‹åŠ å…¥ä¸€äº›nodeåˆ°æˆ‘ä»¬çš„é›†ç¾¤é‡Œé¢å§ï¼</p><p>sshåˆ°æˆ‘ä»¬çš„nodeèŠ‚ç‚¹ä¸Šï¼Œæ‰§è¡Œåˆšæ‰ä¸‹é¢ç»™å‡ºçš„é‚£ä¸ª <code>kubeadm join</code>çš„å‘½ä»¤ï¼ˆæ¯ä¸ªäººä¸åŒï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo -i</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubeadm join --token 72a8a4.2ed9076cd668b8b7 172.31.31.60:6443 --discovery-token-ca-cert-hash sha256:f0894e55d475f882dd40d52c6d01f758017ec5729be632294049f687330f60d2</span></span><br></pre></td></tr></table></figure><p>è¾“å‡ºå·®ä¸å¤šå¦‚ä¸‹å›¾ï¼š</p><p><img data-src="https://static.purewhite.io/images/2017-12-17-1E93FFDE-F0FE-4C7B-9207-6B8DF3EE7787.png!webp_90" alt="1E93FFDE-F0FE-4C7B-9207-6B8DF3EE7787"></p><p>è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å»masterä¸Šè¾“å…¥<code>kubectl get nodes</code>æŸ¥çœ‹ä¸€ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@i-071abd86ed304dc84 ~]# kubectl get nodes</span><br><span class="line">NAME                  STATUS    ROLES     AGE       VERSION</span><br><span class="line">i-071abd86ed304dc84   Ready     master    12m       v1.9.0</span><br><span class="line">i-0c559ad3c0b16fd36   Ready     &lt;none&gt;    1m        v1.9.0</span><br><span class="line">i-0f3f7462b0a004b5e   Ready     &lt;none&gt;    47s       v1.9.0</span><br></pre></td></tr></table></figure><p>æˆåŠŸï¼</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç”¨<code>kubeadm</code>éƒ¨ç½²å¯ä»¥è®©æˆ‘ä»¬æ¯”æ‰‹åŠ¨éƒ¨ç½²æ–¹ä¾¿å¾—å¤šï¼Œè™½ç„¶æ¯”ä¸ä¸Š<code>kops</code>è¿™æ ·çš„ä¸€é”®éƒ¨ç½²ç”Ÿäº§Kubernetesé›†ç¾¤çš„å·¥å…·ï¼Œä½†æ˜¯<code>kubeadm</code>æœ€åˆçš„è®¾è®¡ä¹Ÿå¹¶éæ˜¯å‚»ç“œå¼ä½¿ç”¨ã€‚</p><p><code>kubeadm</code>ç»™äº†ç”¨æˆ·å¾ˆå¤šçš„çµæ´»æ€§ï¼Œè®©ç”¨æˆ·å¯ä»¥å®Œå…¨è‡ªå®šä¹‰åœ°å»é…ç½®è‡ªå·±çš„é›†ç¾¤ã€‚</p><p>ä¸è¿‡ç›®å‰ï¼ˆæˆªæ­¢åšå®¢å‘å¸ƒä¸ºæ­¢ï¼‰ï¼Œ<code>kubeadm</code>è¿˜åªæ˜¯åœ¨æµ‹è¯•ï¼Œå®˜æ–¹è¿˜ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œä¸è¿‡é¢„è®¡ä¼šåœ¨2018å¹´æ˜¥å­£å¯ä»¥æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹<code>kubeadm</code>æœ€æ ¸å¿ƒçš„å‡ ä¸ªæ¦‚å¿µï¼š</p><ul><li>å®˜æ–¹è®¤ä¸ºçš„ æœ€ä½³å®è·µï¼ˆbest-practiceï¼‰</li><li>åˆç†çš„å®‰å…¨ï¼ˆreasonably secureï¼‰</li><li>å¯æ‰©å±•ï¼ˆextensibleï¼‰</li><li>æœ€å°å¯ç”¨ï¼ˆminimum viableï¼‰</li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h1&gt;&lt;p&gt;&lt;code&gt;kubeadm&lt;/code&gt;æ˜¯ä¸€ä¸ª&lt;code&gt;kubernetes&lt;/code&gt;å®˜æ–¹æä¾›çš„å¿«é€Ÿå®‰è£…å’Œåˆå§‹åŒ–æ‹¥æœ‰&lt;strong&gt;æœ€ä½³å®è·µï¼ˆbest practiceï¼‰&lt;/strong&gt;çš„&lt;code&gt;kubernetes&lt;/code&gt;é›†ç¾¤çš„å·¥å…·ï¼Œè™½ç„¶ç›®å‰è¿˜å¤„äº beta å’Œ alpha çŠ¶æ€ï¼Œè¿˜ä¸èƒ½ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡å­¦ä¹ è¿™ç§éƒ¨ç½²æ–¹æ³•æ¥ä½“ä¼šä¸€äº›å®˜æ–¹æ¨èçš„kubernetesæœ€ä½³å®è·µçš„è®¾è®¡å’Œæ€æƒ³ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://www.purewhite.io/categories/kubernetes/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="æ¶æ„" scheme="https://www.purewhite.io/tags/%E6%9E%B6%E6%9E%84/"/>
    
    <category term="docker" scheme="https://www.purewhite.io/tags/docker/"/>
    
    <category term="linux" scheme="https://www.purewhite.io/tags/linux/"/>
    
    <category term="è¿ç»´" scheme="https://www.purewhite.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="kubernetes" scheme="https://www.purewhite.io/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>CASè®¤è¯</title>
    <link href="https://www.purewhite.io/2017/12/14/cas-authentication/"/>
    <id>https://www.purewhite.io/2017/12/14/cas-authentication/</id>
    <published>2017-12-14T01:51:49.000Z</published>
    <updated>2021-12-02T12:51:07.225Z</updated>
    
    <content type="html"><![CDATA[<p>å·¥ä½œéœ€è¦å­¦ä¹ CASï¼Œæ‰€ä»¥è¾¹å­¦è¾¹å†™åšå®¢æ¥å°è¯è‡ªå·±æ‰€å­¦ã€‚</p><p>CASâ€”â€”Central Authentication Serviceï¼Œé›†ä¸­å¼è®¤è¯æœåŠ¡ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯æŠŠä¸€ä¸ªç½‘ç«™ç¾¤çš„ç”¨æˆ·è®¤è¯æŒªåˆ°åŒä¸€ä¸ªåœ°æ–¹å»è¿›è¡Œã€‚</p><span id="more"></span><h2 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h2><p>CASæ¶æ„å¦‚ä¸‹å›¾ï¼š</p><p><img data-src="https://static.purewhite.io/images/2017-12-14-cas_architecture.png!webp_50" alt="cas_architecture"></p><p>å¯ä»¥çœ‹å‡ºæ¥ï¼ŒCASä¸»è¦æ˜¯ç”¨åœ¨ç½‘ç«™ç¾¤é‡Œé¢ã€‚æƒ³æƒ³ä¹Ÿæ˜¯ï¼Œå¦‚æœæœ‰å¥½å¤šä¸ªç½‘ç«™éƒ½éœ€è¦ç”¨æˆ·è®¤è¯ï¼Œä¸å¯èƒ½æ¯ä¸ªç½‘ç«™è‡ªå·±ç»´æŠ¤ä¸€å¥—ç”¨æˆ·è®¤è¯ç³»ç»Ÿï¼Œä¸ç„¶ç»´æŠ¤å’Œå¼€å‘èµ·æ¥ä¸æ˜¯å¤ªéº»çƒ¦äº†ï¼Œæ‰€ä»¥éœ€è¦æŠŠç”¨æˆ·è®¤è¯æŒªåˆ°åŒä¸€ä¸ªåœ°æ–¹å»é›†ä¸­åœ°è¿›è¡Œï¼Œè¿™å°±æ˜¯CASçš„æ€æƒ³ã€‚</p><p>CASæœåŠ¡å™¨å’ŒAppæœåŠ¡å™¨é€šè¿‡åè®®è¿›è¡Œäº¤äº’ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ç›¸å½“äºæˆ‘ä»¬ç»å¸¸è¯´çš„â€œè§£è€¦â€ï¼ŒæŠŠç”¨æˆ·è®¤è¯çš„ä½“ç³»ç»™å•ç‹¬å‰¥ç¦»å‡ºæ¥ï¼Œä½¿å¾—ç”¨æˆ·è®¤è¯ä½“ç³»å¯ä»¥åœ¨æ‰€æœ‰ç½‘ç«™ä¸­å¤ç”¨ã€‚è¿™ä¹ˆè¯´æ¥è¿˜æœ‰ç‚¹å¾®æœåŠ¡çš„æ„æ€ï¼Ÿå…¶å®å¾ˆå¤šæƒ³æ³•éƒ½æ˜¯æ®Šé€”åŒå½’çš„ã€‚</p><h2 id="æµç¨‹å›¾"><a href="#æµç¨‹å›¾" class="headerlink" title="æµç¨‹å›¾"></a>æµç¨‹å›¾</h2><p><img data-src="https://static.purewhite.io/images/2017-12-14-cas_flow_diagram.png!webp_50" alt="cas_flow_diagram"></p><p>è¿™æ˜¯CASä¸»è¦çš„æµç¨‹ï¼Œç®€å•æ¥è¯´å°±æ˜¯åœ¨è®¿é—®æœåŠ¡å™¨çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°æ²¡æœ‰sessionï¼Œå°±å»CAS ServeréªŒè¯ä¸€ä¸‹ï¼ŒCASçš„TGTæ˜¯ä¸ºäº†ä¸è®©ç”¨æˆ·é‡å¤ç™»å½•çš„ä¸€ä¸ªticketã€‚</p><p>CAS ServeréªŒè¯å®Œäº†èº«ä»½ï¼Œå°±ç»™ä¸€ä¸ªSTï¼Œè®©ç”¨æˆ·æ‹¿ç»™appï¼Œappç”¨STå»CAS Serverè·å–åˆ°ç”¨æˆ·çš„ä¿¡æ¯ï¼Œäºæ˜¯åˆ›å»ºsessionã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å·¥ä½œéœ€è¦å­¦ä¹ CASï¼Œæ‰€ä»¥è¾¹å­¦è¾¹å†™åšå®¢æ¥å°è¯è‡ªå·±æ‰€å­¦ã€‚&lt;/p&gt;
&lt;p&gt;CASâ€”â€”Central Authentication Serviceï¼Œé›†ä¸­å¼è®¤è¯æœåŠ¡ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯æŠŠä¸€ä¸ªç½‘ç«™ç¾¤çš„ç”¨æˆ·è®¤è¯æŒªåˆ°åŒä¸€ä¸ªåœ°æ–¹å»è¿›è¡Œã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/categories/%E5%90%8E%E7%AB%AF/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="æ¶æ„" scheme="https://www.purewhite.io/tags/%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠHead First è®¾è®¡æ¨¡å¼ã€‹è¯»ä¹¦ç¬”è®°0 â€”â€” æ€»è§ˆ</title>
    <link href="https://www.purewhite.io/2017/12/11/design-pattern-overview/"/>
    <id>https://www.purewhite.io/2017/12/11/design-pattern-overview/</id>
    <published>2017-12-11T11:56:07.000Z</published>
    <updated>2021-12-02T12:51:07.225Z</updated>
    
    <content type="html"><![CDATA[<p>å¼€å§‹çœ‹ã€ŠHead First è®¾è®¡æ¨¡å¼ã€‹ï¼Œæ¥ä¸‹æ¥ï¼ˆå¯èƒ½ï¼‰ä¼šå†™ä¸€ç³»åˆ—çš„åšå®¢å…³äºè®¾è®¡æ¨¡å¼ï¼Œå…ˆåœ¨è¿™é‡ŒæŒ–ä¸ªå‘ã€‚ã€‚ã€‚</p><span id="more"></span><h2 id="ä¸ºä»€ä¹ˆè¦å­¦è®¾è®¡æ¨¡å¼"><a href="#ä¸ºä»€ä¹ˆè¦å­¦è®¾è®¡æ¨¡å¼" class="headerlink" title="ä¸ºä»€ä¹ˆè¦å­¦è®¾è®¡æ¨¡å¼"></a>ä¸ºä»€ä¹ˆè¦å­¦è®¾è®¡æ¨¡å¼</h2><p>å› ä¸º<strong>æœ‰äº›äººå·²ç»è§£å†³ä½ çš„é—®é¢˜äº†</strong>ã€‚ä½ çš„é—®é¢˜åˆ«äººå·²ç»é‡åˆ°è¿‡äº†ï¼Œä¹Ÿè§£å†³äº†ï¼Œæˆ‘ä»¬åº”è¯¥å­¦ä¹ åˆ«äººçš„ç»éªŒå¹¶è¿›è¡Œå¤ç”¨ã€‚</p><p>è®¾è®¡æ¨¡å¼å¤§éƒ½æ˜¯ä¸€äº›è‰¯å¥½çš„OOå®è·µï¼Œå…¶ä¸­èƒ½åæ˜ å‡ºå¾ˆå¤šOOçš„è®¾è®¡åŸåˆ™ã€‚</p><p>ä½¿ç”¨æ¨¡å¼æœ€å¥½çš„æ–¹æ³•æ˜¯ï¼šâ€œ<strong>æŠŠæ¨¡å¼è£…è¿›è„‘å­é‡Œï¼Œç„¶ååœ¨ä½ çš„è®¾è®¡å’Œå·²æœ‰çš„åº”ç”¨ä¸­ï¼Œå¯»æ‰¾ä½•å¤„å¯ä»¥ä½¿ç”¨å®ƒä»¬</strong>ã€‚â€</p><h2 id="å¤§è‡´æœ‰å“ªäº›è®¾è®¡æ¨¡å¼"><a href="#å¤§è‡´æœ‰å“ªäº›è®¾è®¡æ¨¡å¼" class="headerlink" title="å¤§è‡´æœ‰å“ªäº›è®¾è®¡æ¨¡å¼"></a>å¤§è‡´æœ‰å“ªäº›è®¾è®¡æ¨¡å¼</h2><h3 id="è§‚å¯Ÿè€…æ¨¡å¼"><a href="#è§‚å¯Ÿè€…æ¨¡å¼" class="headerlink" title="è§‚å¯Ÿè€…æ¨¡å¼"></a>è§‚å¯Ÿè€…æ¨¡å¼</h3><h4 id="è®©ä½ çš„å¯¹è±¡çŸ¥æ‚‰ç°çŠ¶"><a href="#è®©ä½ çš„å¯¹è±¡çŸ¥æ‚‰ç°çŠ¶" class="headerlink" title="è®©ä½ çš„å¯¹è±¡çŸ¥æ‚‰ç°çŠ¶"></a>è®©ä½ çš„å¯¹è±¡çŸ¥æ‚‰ç°çŠ¶</h4><p><strong>æœ‰è¶£çš„äº‹æƒ…å‘ç”Ÿæ—¶ï¼Œå¯åƒä¸‡åˆ«é”™è¿‡äº†ï¼</strong></p><h3 id="è£…é¥°è€…æ¨¡å¼"><a href="#è£…é¥°è€…æ¨¡å¼" class="headerlink" title="è£…é¥°è€…æ¨¡å¼"></a>è£…é¥°è€…æ¨¡å¼</h3><h4 id="è£…é¥°å¯¹è±¡"><a href="#è£…é¥°å¯¹è±¡" class="headerlink" title="è£…é¥°å¯¹è±¡"></a>è£…é¥°å¯¹è±¡</h4><p><strong>ç»™çˆ±ç”¨ç»§æ‰¿çš„äººä¸€ä¸ªå…¨æ–°çš„è®¾è®¡çœ¼ç•Œ</strong></p><h3 id="å·¥å‚æ¨¡å¼"><a href="#å·¥å‚æ¨¡å¼" class="headerlink" title="å·¥å‚æ¨¡å¼"></a>å·¥å‚æ¨¡å¼</h3><h4 id="çƒ˜çƒ¤OOçš„ç²¾å"><a href="#çƒ˜çƒ¤OOçš„ç²¾å" class="headerlink" title="çƒ˜çƒ¤OOçš„ç²¾å"></a>çƒ˜çƒ¤OOçš„ç²¾å</h4><p><strong>è£…å¤‡å¥½å¼€å§‹çƒ˜çƒ¤æŸäº›æ¾è€¦åˆçš„OOè®¾è®¡ã€‚</strong></p><h3 id="å•å®ä¾‹æ¨¡å¼"><a href="#å•å®ä¾‹æ¨¡å¼" class="headerlink" title="å•å®ä¾‹æ¨¡å¼"></a>å•å®ä¾‹æ¨¡å¼</h3><h4 id="ç‹¬ä¸€æ— äºŒçš„å¯¹è±¡"><a href="#ç‹¬ä¸€æ— äºŒçš„å¯¹è±¡" class="headerlink" title="ç‹¬ä¸€æ— äºŒçš„å¯¹è±¡"></a>ç‹¬ä¸€æ— äºŒçš„å¯¹è±¡</h4><p><strong>å•å®ä¾‹æ¨¡å¼ï¼šç”¨æ¥åˆ›å»ºç‹¬ä¸€æ— äºŒçš„ï¼Œåªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹çš„å¯¹è±¡çš„å…¥åœºåˆ¸ã€‚</strong></p><h3 id="å‘½ä»¤æ¨¡å¼"><a href="#å‘½ä»¤æ¨¡å¼" class="headerlink" title="å‘½ä»¤æ¨¡å¼"></a>å‘½ä»¤æ¨¡å¼</h3><h4 id="å°è£…è°ƒç”¨"><a href="#å°è£…è°ƒç”¨" class="headerlink" title="å°è£…è°ƒç”¨"></a>å°è£…è°ƒç”¨</h4><p><strong>æŠŠå°è£…å¸¦åˆ°ä¸€ä¸ªå…¨æ–°çš„å¢ƒç•Œï¼šæŠŠæ–¹æ³•è°ƒç”¨å°è£…èµ·æ¥ã€‚</strong></p><h3 id="é€‚é…å™¨æ¨¡å¼ä¸å¤–è§‚æ¨¡å¼"><a href="#é€‚é…å™¨æ¨¡å¼ä¸å¤–è§‚æ¨¡å¼" class="headerlink" title="é€‚é…å™¨æ¨¡å¼ä¸å¤–è§‚æ¨¡å¼"></a>é€‚é…å™¨æ¨¡å¼ä¸å¤–è§‚æ¨¡å¼</h3><h4 id="éšé‡è€Œå®‰"><a href="#éšé‡è€Œå®‰" class="headerlink" title="éšé‡è€Œå®‰"></a>éšé‡è€Œå®‰</h4><p><strong>æŠŠæ–¹å—æ”¾è¿›åœ†æ´ä¸­ã€‚</strong></p><h3 id="æ¨¡æ¿æ–¹æ³•æ¨¡å¼"><a href="#æ¨¡æ¿æ–¹æ³•æ¨¡å¼" class="headerlink" title="æ¨¡æ¿æ–¹æ³•æ¨¡å¼"></a>æ¨¡æ¿æ–¹æ³•æ¨¡å¼</h3><h4 id="å°è£…ç®—æ³•"><a href="#å°è£…ç®—æ³•" class="headerlink" title="å°è£…ç®—æ³•"></a>å°è£…ç®—æ³•</h4><p><strong>å°è£…å®Œå¯¹è±¡â€¦â€¦æ¥ä¸‹æ¥å‘¢ï¼Ÿ</strong></p><h3 id="è¿­ä»£å™¨ä¸ç»„åˆæ¨¡å¼"><a href="#è¿­ä»£å™¨ä¸ç»„åˆæ¨¡å¼" class="headerlink" title="è¿­ä»£å™¨ä¸ç»„åˆæ¨¡å¼"></a>è¿­ä»£å™¨ä¸ç»„åˆæ¨¡å¼</h3><h4 id="ç®¡ç†è‰¯å¥½çš„é›†åˆ"><a href="#ç®¡ç†è‰¯å¥½çš„é›†åˆ" class="headerlink" title="ç®¡ç†è‰¯å¥½çš„é›†åˆ"></a>ç®¡ç†è‰¯å¥½çš„é›†åˆ</h4><p><strong>æœ‰è®¸å¤šç§æ–¹æ³•å¯ä»¥æŠŠå¯¹è±¡å †èµ·æ¥æˆä¸ºä¸€ä¸ªé›†åˆã€‚</strong></p><h3 id="çŠ¶æ€æ¨¡å¼"><a href="#çŠ¶æ€æ¨¡å¼" class="headerlink" title="çŠ¶æ€æ¨¡å¼"></a>çŠ¶æ€æ¨¡å¼</h3><h4 id="äº‹ç‰©çš„çŠ¶æ€"><a href="#äº‹ç‰©çš„çŠ¶æ€" class="headerlink" title="äº‹ç‰©çš„çŠ¶æ€"></a>äº‹ç‰©çš„çŠ¶æ€</h4><p><strong>åŸºæœ¬å¸¸è¯†ï¼šç­–ç•¥æ¨¡å¼å’ŒçŠ¶æ€æ¨¡å¼æ˜¯åŒèƒèƒï¼Œåœ¨å‡ºç”Ÿæ—¶æ‰åˆ†å¼€ã€‚</strong></p><h3 id="ä»£ç†æ¨¡å¼"><a href="#ä»£ç†æ¨¡å¼" class="headerlink" title="ä»£ç†æ¨¡å¼"></a>ä»£ç†æ¨¡å¼</h3><h4 id="æ§åˆ¶å¯¹è±¡è®¿é—®"><a href="#æ§åˆ¶å¯¹è±¡è®¿é—®" class="headerlink" title="æ§åˆ¶å¯¹è±¡è®¿é—®"></a>æ§åˆ¶å¯¹è±¡è®¿é—®</h4><p><strong>ç©è¿‡æ‰®ç™½è„¸ã€æ‰®é»‘è„¸çš„æ¸¸æˆå—ï¼Ÿ</strong></p><h3 id="å¤åˆæ¨¡å¼"><a href="#å¤åˆæ¨¡å¼" class="headerlink" title="å¤åˆæ¨¡å¼"></a>å¤åˆæ¨¡å¼</h3><h4 id="æ¨¡å¼ä¸­çš„æ¨¡å¼"><a href="#æ¨¡å¼ä¸­çš„æ¨¡å¼" class="headerlink" title="æ¨¡å¼ä¸­çš„æ¨¡å¼"></a>æ¨¡å¼ä¸­çš„æ¨¡å¼</h4><p><strong>è°æ–™å¾—åˆ°æ¨¡å¼å±…ç„¶å¯ä»¥æºæ‰‹åˆä½œï¼Ÿ</strong></p><h2 id="ä¸è®¾è®¡æ¨¡å¼ç›¸å¤„"><a href="#ä¸è®¾è®¡æ¨¡å¼ç›¸å¤„" class="headerlink" title="ä¸è®¾è®¡æ¨¡å¼ç›¸å¤„"></a>ä¸è®¾è®¡æ¨¡å¼ç›¸å¤„</h2><h3 id="çœŸå®ä¸–ç•Œä¸­çš„æ¨¡å¼"><a href="#çœŸå®ä¸–ç•Œä¸­çš„æ¨¡å¼" class="headerlink" title="çœŸå®ä¸–ç•Œä¸­çš„æ¨¡å¼"></a>çœŸå®ä¸–ç•Œä¸­çš„æ¨¡å¼</h3><p><strong>ç°åœ¨ä½ å·²ç»å‡†å¤‡å¥½è¿æ¥ä¸€ä¸ªå……æ»¡è®¾è®¡æ¨¡å¼çš„å´­æ–°ä¸–ç•Œã€‚</strong></p><h2 id="å…¶å®ƒè®¾è®¡æ¨¡å¼"><a href="#å…¶å®ƒè®¾è®¡æ¨¡å¼" class="headerlink" title="å…¶å®ƒè®¾è®¡æ¨¡å¼"></a>å…¶å®ƒè®¾è®¡æ¨¡å¼</h2><p>ç•¥â€¦â€¦</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¼€å§‹çœ‹ã€ŠHead First è®¾è®¡æ¨¡å¼ã€‹ï¼Œæ¥ä¸‹æ¥ï¼ˆå¯èƒ½ï¼‰ä¼šå†™ä¸€ç³»åˆ—çš„åšå®¢å…³äºè®¾è®¡æ¨¡å¼ï¼Œå…ˆåœ¨è¿™é‡ŒæŒ–ä¸ªå‘ã€‚ã€‚ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="https://www.purewhite.io/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="https://www.purewhite.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    <category term="go" scheme="https://www.purewhite.io/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•åœ¨Macä¸Šå¸è½½Python</title>
    <link href="https://www.purewhite.io/2017/05/21/how-to-delete-python-on-mac/"/>
    <id>https://www.purewhite.io/2017/05/21/how-to-delete-python-on-mac/</id>
    <published>2017-05-21T09:47:46.000Z</published>
    <updated>2021-12-02T12:51:07.227Z</updated>
    
    <content type="html"><![CDATA[<ol><li><p>Remove the Python 2.7 framework</p><p><code>sudo rm -rf /Library/Frameworks/Python.framework/Versions/2.7</code></p></li><li><p>Remove the Python 2.7 applications directory</p><p><code>sudo rm -rf &quot;/Applications/Python 2.7&quot;</code></p></li><li><p>Remove the symbolic links in <code>/usr/local/bin</code> that point to this Python version see <code>ls -l /usr/local/bin | grep &#39;../Library/Frameworks/Python.framework/Versions/2.7&#39;</code> and then run the following command to remove all the links:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">ls -l /usr/<span class="built_in">local</span>/bin | grep <span class="string">&#x27;../Library/Frameworks/Python.framework/Versions/2.7&#x27;</span> | awk <span class="string">&#x27;&#123;print $9&#125;&#x27;</span> | tr -d @ | xargs rm</span><br></pre></td></tr></table></figure></li><li><p>If necessary, edit your shell profile file(s) to remove adding <code>/Library/Frameworks/Python.framework/Versions/2.7</code> to your <code>PATH</code> environment file. Depending on which shell you use, any of the following files may have been modified: <code>~/.bash_login</code>, <code>~/.bash_profile</code>, <code>~/.cshrc</code>, <code>~/.profile</code>, <code>~/.tcshrc</code>, and/or <code>~/.zprofile</code>.</p></li></ol><span id="more"></span><p>è½¬è‡ªï¼š<a href="http://stackoverflow.com/questions/3819449/how-to-uninstall-python-2-7-on-a-mac-os-x-10-6-4">How to uninstall Python 2.7 on a Mac OS X 10.6.4?</a></p>]]></content>
    
    
    <summary type="html">&lt;ol&gt;
&lt;li&gt;&lt;p&gt;Remove the Python 2.7 framework&lt;/p&gt;
&lt;p&gt;&lt;code&gt;sudo rm -rf /Library/Frameworks/Python.framework/Versions/2.7&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Remove the Python 2.7 applications directory&lt;/p&gt;
&lt;p&gt;&lt;code&gt;sudo rm -rf &amp;quot;/Applications/Python 2.7&amp;quot;&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Remove the symbolic links in &lt;code&gt;/usr/local/bin&lt;/code&gt; that point to this Python version see &lt;code&gt;ls -l /usr/local/bin | grep &amp;#39;../Library/Frameworks/Python.framework/Versions/2.7&amp;#39;&lt;/code&gt; and then run the following command to remove all the links:&lt;/p&gt;
&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/bin/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ls -l /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/bin | grep &lt;span class=&quot;string&quot;&gt;&amp;#x27;../Library/Frameworks/Python.framework/Versions/2.7&amp;#x27;&lt;/span&gt; | awk &lt;span class=&quot;string&quot;&gt;&amp;#x27;&amp;#123;print $9&amp;#125;&amp;#x27;&lt;/span&gt; | tr -d @ | xargs rm&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;If necessary, edit your shell profile file(s) to remove adding &lt;code&gt;/Library/Frameworks/Python.framework/Versions/2.7&lt;/code&gt; to your &lt;code&gt;PATH&lt;/code&gt; environment file. Depending on which shell you use, any of the following files may have been modified: &lt;code&gt;~/.bash_login&lt;/code&gt;, &lt;code&gt;~/.bash_profile&lt;/code&gt;, &lt;code&gt;~/.cshrc&lt;/code&gt;, &lt;code&gt;~/.profile&lt;/code&gt;, &lt;code&gt;~/.tcshrc&lt;/code&gt;, and/or &lt;code&gt;~/.zprofile&lt;/code&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="python" scheme="https://www.purewhite.io/categories/python/"/>
    
    
    <category term="mac" scheme="https://www.purewhite.io/tags/mac/"/>
    
    <category term="python" scheme="https://www.purewhite.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>MySqlå­˜å‚¨å¼•æ“çš„æ¯”è¾ƒ</title>
    <link href="https://www.purewhite.io/2017/05/20/mysql-engines-compare/"/>
    <id>https://www.purewhite.io/2017/05/20/mysql-engines-compare/</id>
    <published>2017-05-19T16:44:21.000Z</published>
    <updated>2021-12-02T12:51:07.229Z</updated>
    
    <content type="html"><![CDATA[<p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒMySqlæä¾›äº†å¾ˆå¤šå­˜å‚¨å¼•æ“ï¼Œè¿™é‡Œæ¥æ¯”è¾ƒä¸€ä¸‹å¸¸è§å¼•æ“çš„ä¼˜åŠ£ã€‚</p><h2 id="æŸ¥çœ‹æ‰€æœ‰å­˜å‚¨å¼•æ“"><a href="#æŸ¥çœ‹æ‰€æœ‰å­˜å‚¨å¼•æ“" class="headerlink" title="æŸ¥çœ‹æ‰€æœ‰å­˜å‚¨å¼•æ“"></a>æŸ¥çœ‹æ‰€æœ‰å­˜å‚¨å¼•æ“</h2><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>show engines</code>å‘½ä»¤æ¥çœ‹åˆ°æˆ‘ä»¬çš„mysql serveræä¾›äº†å“ªäº›å¼•æ“ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">show engines;</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| Engine             | Support | Comment                                                        | Transactions | XA   | Savepoints |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| InnoDB             | DEFAULT | Supports transactions, row-level locking, and foreign keys     | YES          | YES  | YES        |</span><br><span class="line">| MRG_MYISAM         | YES     | Collection of identical MyISAM tables                          | NO           | NO   | NO         |</span><br><span class="line">| MEMORY             | YES     | Hash based, stored in memory, useful for temporary tables      | NO           | NO   | NO         |</span><br><span class="line">| BLACKHOLE          | YES     | /dev/null storage engine (anything you write to it disappears) | NO           | NO   | NO         |</span><br><span class="line">| MyISAM             | YES     | MyISAM storage engine                                          | NO           | NO   | NO         |</span><br><span class="line">| CSV                | YES     | CSV storage engine                                             | NO           | NO   | NO         |</span><br><span class="line">| ARCHIVE            | YES     | Archive storage engine                                         | NO           | NO   | NO         |</span><br><span class="line">| PERFORMANCE_SCHEMA | YES     | Performance Schema                                             | NO           | NO   | NO         |</span><br><span class="line">| FEDERATED          | NO      | Federated MySQL storage engine                                 | NULL         | NULL | NULL       |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">9 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="InnoDB-å­˜å‚¨å¼•æ“"><a href="#InnoDB-å­˜å‚¨å¼•æ“" class="headerlink" title="InnoDB å­˜å‚¨å¼•æ“"></a>InnoDB å­˜å‚¨å¼•æ“</h2><p>InnoDBæ˜¯äº‹åŠ¡æ€§æ•°æ®åº“çš„é¦–é€‰å¼•æ“ï¼Œæ”¯æŒäº‹åŠ¡å®‰å…¨è¡¨ï¼ˆACIDï¼‰ï¼Œæ”¯æŒè¡Œé”å®šå’Œå¤–é”®ã€‚MySQL5.5.5ä¹‹åï¼ŒInnoDBä½œä¸ºé»˜è®¤å­˜å‚¨å¼•æ“ã€‚InnoDBä¸»è¦ç‰¹æ€§æœ‰ï¼š</p><ol><li>InnoDBç»™MySQLæä¾›äº†å…·æœ‰æäº¤ã€å›æ»šå’Œå´©æºƒæ¢å¤èƒ½åŠ›çš„äº‹åŠ¡å®‰å…¨ï¼ˆACIDå…¼å®¹ï¼‰å­˜å‚¨å¼•æ“ã€‚InnoDBé”å®šåœ¨è¡Œçº§å¹¶ä¸”ä¹Ÿåœ¨SELECTè¯­å¥ä¸­æä¾›ä¸€ä¸ªç±»ä¼¼Oracleçš„éé”å®šè¯»ã€‚è¿™äº›åŠŸèƒ½å¢åŠ äº†å¤šç”¨æˆ·éƒ¨ç½²å’Œæ€§èƒ½ã€‚åœ¨SQLæŸ¥è¯¢ä¸­ï¼Œå¯ä»¥è‡ªç”±åœ°å°†InnoDBç±»å‹çš„è¡¨ä¸å…¶ä»–MySQLçš„è¡¨çš„ç±»å‹æ··åˆèµ·æ¥ï¼Œç”šè‡³åœ¨åŒä¸€ä¸ªæŸ¥è¯¢ä¸­ä¹Ÿå¯ä»¥æ··åˆã€‚</li><li>InnoDBæ˜¯ä¸ºå¤„ç†å·¨å¤§æ•°æ®é‡æ‰€è®¾è®¡çš„æ€§èƒ½ä¸ºé‡çš„ï¼Œå®ƒçš„CPUæ•ˆç‡å¯èƒ½æ˜¯ä»»ä½•å…¶ä»–åŸºäºç£ç›˜çš„å…³ç³»æ•°æ®åº“å¼•æ“æ‰€ä¸èƒ½åŒ¹æ•Œçš„ã€‚</li><li>InnoDBå­˜å‚¨å¼•æ“å®Œå…¨ä¸MySQLæœåŠ¡å™¨æ•´åˆï¼ŒInnoDBå­˜å‚¨å¼•æ“åœ¨ä¸»å†…å­˜ä¸­ç»´æŒäº†è‡ªå·±çš„ç¼“å†²æ± æ¥ç¼“å­˜æ•°æ®å’Œç´¢å¼•ã€‚InnoDBå°†å®ƒçš„è¡¨å’Œç´¢å¼•å­˜åœ¨ä¸€ä¸ªé€»è¾‘è¡¨ç©ºé—´ä¸­ï¼Œè¡¨ç©ºé—´å¯ä»¥åŒ…å«æ•°ä¸ªæ–‡ä»¶ï¼ˆæˆ–åŸå§‹ç£ç›˜åˆ†åŒºï¼‰ã€‚è¿™ä¸MyISAMè¡¨ä¸åŒï¼Œæ¯”å¦‚åœ¨MyISAMè¡¨ä¸­æ¯ä¸ªè¡¨è¢«å­˜åœ¨åˆ†ç¦»çš„æ–‡ä»¶ä¸­ã€‚InnoDBè¡¨å¯ä»¥æ˜¯ä»»ä½•å°ºå¯¸ï¼Œå³ä½¿åœ¨æ–‡ä»¶å°ºå¯¸è¢«é™åˆ¶åœ¨2GBçš„æ“ä½œç³»ç»Ÿä¸Šã€‚</li><li>InnoDBæ”¯æŒå¤–é”®å®Œæ•´æ€§çº¦æŸï¼ˆFOREIGN KEYï¼‰ã€‚å­˜å‚¨è¡¨ä¸­çš„æ•°æ®æ—¶ï¼Œæ¯å¼ è¡¨çš„å­˜å‚¨éƒ½æŒ‰ä¸»é”®é¡ºåºå­˜æ”¾ï¼Œå¦‚æœæ²¡æœ‰æ˜¾å¼åœ¨è¡¨å®šä¹‰æ—¶åˆ¶å®šä¸»é”®ï¼ŒInnoDBä¼šä¸ºæ¯ä¸€è¡Œç”Ÿæˆä¸€ä¸ª6Bçš„ROWIDï¼Œå¹¶ä»¥æ­¤ä½œä¸ºä¸»é”®ã€‚</li><li>InnoDBè¢«ç”¨åœ¨ä¼—å¤šéœ€è¦é«˜æ€§èƒ½çš„å¤§å‹æ•°æ®åº“ç«™ç‚¹ä¸Šã€‚</li><li>InnoDBä¸åˆ›å»ºç›®å½•ï¼Œä½¿ç”¨InnoDBæ—¶ï¼ŒMySQLå°†åœ¨MySQLæ•°æ®ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸ºibdata1çš„10MBå¤§å°çš„è‡ªåŠ¨æ‰©å±•æ•°æ®æ–‡ä»¶ï¼Œä»¥åŠä¸¤ä¸ªåä¸ºib_logfile0å’Œib_logfile1çš„5MBå¤§å°çš„æ—¥å¿—æ–‡ä»¶ã€‚</li></ol><h2 id="MyISAM-å­˜å‚¨å¼•æ“"><a href="#MyISAM-å­˜å‚¨å¼•æ“" class="headerlink" title="MyISAM å­˜å‚¨å¼•æ“"></a>MyISAM å­˜å‚¨å¼•æ“</h2><p>MyISAMæ˜¯åŸºäºISAMçš„å­˜å‚¨å¼•æ“ï¼Œå¹¶å¯¹å…¶è¿›è¡Œæ‰©å±•ã€‚å®ƒæ˜¯åœ¨Webã€æ•°æ®å­˜å‚¨å’Œå…¶ä»–åº”ç”¨ç¯å¢ƒä¸‹æœ€å¸¸ä½¿ç”¨çš„å­˜å‚¨å¼•æ“ä¹‹ä¸€ã€‚MyISAMæ‹¥æœ‰è¾ƒé«˜çš„æ’å…¥ã€æŸ¥è¯¢é€Ÿåº¦ï¼Œä½†ä¸æ”¯æŒäº‹åŠ¡ã€‚åœ¨MySQL5.5.5ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼ŒMyISAMæ˜¯é»˜è®¤å­˜å‚¨å¼•æ“ã€‚MyISAMä¸»è¦ç‰¹æ€§æœ‰ï¼š</p><ol><li>å¤§æ–‡ä»¶ï¼ˆè¾¾63ä½æ–‡ä»¶é•¿åº¦ï¼‰åœ¨æ”¯æŒå¤§æ–‡ä»¶çš„æ–‡ä»¶ç³»ç»Ÿå’Œæ“ä½œç³»ç»Ÿä¸Šè¢«æ”¯æŒã€‚</li><li>å½“æŠŠåˆ é™¤ã€æ›´æ–°åŠæ’å…¥æ“ä½œæ··åˆä½¿ç”¨çš„æ—¶å€™ï¼ŒåŠ¨æ€å°ºå¯¸çš„è¡Œäº§ç”Ÿæ›´å°‘ç¢ç‰‡ã€‚è¿™è¦é€šè¿‡åˆå¹¶ç›¸é‚»è¢«åˆ é™¤çš„å—ï¼Œä»¥åŠè‹¥ä¸‹ä¸€ä¸ªå—è¢«åˆ é™¤ï¼Œå°±æ‰©å±•åˆ°ä¸‹ä¸€å—æ¥è‡ªåŠ¨å®Œæˆã€‚</li><li>æ¯ä¸ªMyISAMè¡¨æœ€å¤§ç´¢å¼•æ•°æ˜¯64ï¼Œè¿™å¯ä»¥é€šè¿‡é‡æ–°ç¼–è¯‘æ¥æ”¹å˜ã€‚æ¯ä¸ªç´¢å¼•æœ€å¤§çš„åˆ—æ•°æ˜¯16ä¸ªã€‚</li><li>æœ€å¤§çš„é”®é•¿åº¦æ˜¯1000Bï¼Œè¿™ä¹Ÿå¯ä»¥é€šè¿‡ç¼–è¯‘æ¥æ”¹å˜ã€‚å¯¹äºé”®é•¿åº¦è¶…è¿‡250Bçš„æƒ…å†µï¼Œä¸€ä¸ªè¶…è¿‡1024Bçš„é”®å°†è¢«ç”¨ä¸Šã€‚</li><li>BLOBå’ŒTEXTåˆ—å¯ä»¥è¢«ç´¢å¼•ã€‚</li><li>NULLå€¼è¢«å…è®¸åœ¨ç´¢å¼•çš„åˆ—ä¸­ã€‚è¿™ä¸ªå€¼å æ¯ä¸ªé”®çš„0-1ä¸ªå­—èŠ‚ã€‚</li><li>æ‰€æœ‰æ•°å­—é”®å€¼ä»¥é«˜å­—èŠ‚ä¼˜å…ˆè¢«å­˜å‚¨ä»¥å…è®¸ä¸€ä¸ªæ›´é«˜çš„ç´¢å¼•å‹ç¼©ã€‚</li><li>æ¯è¡¨ä¸€ä¸ªAUTO_INCREMENTåˆ—çš„å†…éƒ¨å¤„ç†ã€‚MyISAMä¸ºINSERTå’ŒUPDATEæ“ä½œè‡ªåŠ¨æ›´æ–°è¿™ä¸€åˆ—ã€‚è¿™ä½¿å¾—AUTO_INCREMENTåˆ—æ›´å¿«ï¼ˆè‡³å°‘10%ï¼‰ã€‚åœ¨åºåˆ—é¡¹çš„å€¼è¢«åˆ é™¤ä¹‹åå°±ä¸èƒ½å†åˆ©ç”¨ã€‚</li><li>å¯ä»¥æŠŠæ•°æ®æ–‡ä»¶å’Œç´¢å¼•æ–‡ä»¶æ”¾åœ¨ä¸åŒç›®å½•ã€‚</li><li>æ¯ä¸ªå­—ç¬¦åˆ—å¯ä»¥æœ‰ä¸åŒçš„å­—ç¬¦é›†ã€‚</li><li>æœ‰VARCHARçš„è¡¨å¯ä»¥å›ºå®šæˆ–åŠ¨æ€è®°å½•é•¿åº¦ã€‚</li><li>VARCHARå’ŒCHARåˆ—å¯ä»¥å¤šè¾¾64KBã€‚</li><li>ä½¿ç”¨MyISAMå¼•æ“åˆ›å»ºæ•°æ®åº“ï¼Œå°†äº§ç”Ÿ3ä¸ªæ–‡ä»¶ã€‚æ–‡ä»¶çš„åå­—ä»¥è¡¨çš„åå­—å¼€å§‹ï¼Œæ‰©å±•åä»£è¡¨äº†æ–‡ä»¶çš„ç±»å‹ï¼šfrmæ–‡ä»¶å­˜å‚¨è¡¨å®šä¹‰ï¼Œmydä»£è¡¨æ•°æ®æ–‡ä»¶ï¼Œmyiä»£è¡¨ç´¢å¼•æ–‡ä»¶ã€‚</li></ol><h2 id="MEMORY-å­˜å‚¨å¼•æ“"><a href="#MEMORY-å­˜å‚¨å¼•æ“" class="headerlink" title="MEMORY å­˜å‚¨å¼•æ“"></a>MEMORY å­˜å‚¨å¼•æ“</h2><p>MEMORYå­˜å‚¨å¼•æ“å°†è¡¨ä¸­çš„æ•°æ®å­˜å‚¨åˆ°å†…å­˜ä¸­ï¼Œä¸ºæŸ¥è¯¢å’Œå¼•ç”¨å…¶ä»–è¡¨æ•°æ®æä¾›å¿«é€Ÿè®¿é—®ã€‚MEMORYä¸»è¦ç‰¹æ€§æœ‰ï¼š</p><ol><li>MEMORYè¡¨çš„æ¯ä¸ªè¡¨å¯ä»¥æœ‰å¤šè¾¾32ä¸ªç´¢å¼•ï¼Œæ¯ä¸ªç´¢å¼•16åˆ—ï¼Œä»¥åŠ500Bçš„æœ€å¤§é”®é•¿åº¦ã€‚</li><li>MEMORYå­˜å‚¨å¼•æ“æ‰§è¡ŒHASH å’Œ BTREEç´¢å¼•ã€‚</li><li>å¯ä»¥åœ¨ä¸€ä¸ªMEMORYè¡¨ä¸­æœ‰éå”¯ä¸€é”®ã€‚</li><li>MEMORYè¡¨ä½¿ç”¨ä¸€ä¸ªå›ºå®šçš„è®°å½•é•¿åº¦æ ¼å¼ã€‚</li><li>MEMORYä¸æ”¯æŒBLOGæˆ–TEXTåˆ—ã€‚</li><li>MEMORYæ”¯æŒAUTO_INCREMENTåˆ—å’Œå¯¹å¯åŒ…å«NULLå€¼çš„åˆ—çš„ç´¢å¼•ã€‚</li><li>MEMORYè¡¨åœ¨æ‰€æœ‰å®¢æˆ·ç«¯ä¹‹é—´å…±äº«ï¼ˆå°±åƒå…¶ä»–ä»»ä½•éTEMPORARYè¡¨ï¼‰ã€‚</li><li>MEMORYè¡¨å†…å®¹è¢«å­˜åœ¨å†…å­˜ä¸­ï¼Œå†…å­˜æ˜¯MEMORYè¡¨å’ŒæœåŠ¡å™¨åœ¨æŸ¥è¯¢å¤„ç†æ—¶çš„ç©ºé—²ä¸­åˆ›å»ºçš„å†…éƒ¨è¡¨å…±äº«çš„ã€‚</li><li>å½“ä¸å†éœ€è¦MEMORYè¡¨çš„å†…å®¹æ—¶ï¼Œè¦é‡Šæ”¾è¢«MEMORYè¡¨ä½¿ç”¨çš„å†…å­˜ï¼Œåº”è¯¥æ‰§è¡ŒDELETE FROMæˆ–TRUNCATE TABLEï¼Œæˆ–è€…åˆ é™¤æ•´ä¸ªè¡¨ï¼ˆç”¨DROP TABLEï¼‰ã€‚</li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¼—æ‰€å‘¨çŸ¥ï¼ŒMySqlæä¾›äº†å¾ˆå¤šå­˜å‚¨å¼•æ“ï¼Œè¿™é‡Œæ¥æ¯”è¾ƒä¸€ä¸‹å¸¸è§å¼•æ“çš„ä¼˜åŠ£ã€‚&lt;/p&gt;
&lt;h2 id=&quot;æŸ¥çœ‹æ‰€æœ‰å­˜å‚¨å¼•æ“&quot;&gt;&lt;a href=&quot;#æŸ¥çœ‹æ‰€æœ‰å­˜å‚¨å¼•æ“&quot; class=&quot;headerlink&quot; title=&quot;æŸ¥çœ‹æ‰€æœ‰å­˜å‚¨å¼•æ“&quot;&gt;&lt;/a&gt;æŸ¥çœ‹æ‰€æœ‰å­˜å‚¨å¼•æ“&lt;/h2&gt;&lt;p&gt;æˆ‘ä»¬å¯ä»¥é€šè¿‡&lt;code&gt;show engines&lt;/code&gt;å‘½ä»¤æ¥çœ‹åˆ°æˆ‘ä»¬çš„mysql serveræä¾›äº†å“ªäº›å¼•æ“ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;show engines;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;| Engine             | Support | Comment                                                        | Transactions | XA   | Savepoints |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;| InnoDB             | DEFAULT | Supports transactions, row-level locking, and foreign keys     | YES          | YES  | YES        |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;| MRG_MYISAM         | YES     | Collection of identical MyISAM tables                          | NO           | NO   | NO         |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;| MEMORY             | YES     | Hash based, stored in memory, useful for temporary tables      | NO           | NO   | NO         |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;| BLACKHOLE          | YES     | /dev/null storage engine (anything you write to it disappears) | NO           | NO   | NO         |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;| MyISAM             | YES     | MyISAM storage engine                                          | NO           | NO   | NO         |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;| CSV                | YES     | CSV storage engine                                             | NO           | NO   | NO         |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;| ARCHIVE            | YES     | Archive storage engine                                         | NO           | NO   | NO         |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;| PERFORMANCE_SCHEMA | YES     | Performance Schema                                             | NO           | NO   | NO         |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;| FEDERATED          | NO      | Federated MySQL storage engine                                 | NULL         | NULL | NULL       |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9 rows in set (0.00 sec)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="mysql" scheme="https://www.purewhite.io/categories/mysql/"/>
    
    
    <category term="æ¶æ„" scheme="https://www.purewhite.io/tags/%E6%9E%B6%E6%9E%84/"/>
    
    <category term="mysql" scheme="https://www.purewhite.io/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•é€‰æ‹©å¼€æºåè®®</title>
    <link href="https://www.purewhite.io/2017/05/16/how-to-choose-free-software-licenses/"/>
    <id>https://www.purewhite.io/2017/05/16/how-to-choose-free-software-licenses/</id>
    <published>2017-05-16T04:13:31.000Z</published>
    <updated>2021-12-02T12:51:07.226Z</updated>
    
    <content type="html"><![CDATA[<p><img data-src="https://static.purewhite.io/images/2017-12-11-free_software_licenses.png!webp_90" alt="free_software_licenses"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;img data-src=&quot;https://static.purewhite.io/images/2017-12-11-free_software_licenses.png!webp_90&quot; alt=&quot;free_software_licenses&quot;&gt;&lt;/p&gt;
</summary>
      
    
    
    
    <category term="éšç¬”" scheme="https://www.purewhite.io/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
    <category term="éšç¬”" scheme="https://www.purewhite.io/tags/%E9%9A%8F%E7%AC%94/"/>
    
    <category term="å¼€æº" scheme="https://www.purewhite.io/tags/%E5%BC%80%E6%BA%90/"/>
    
  </entry>
  
  <entry>
    <title>äº¤å‰ç¼–è¯‘Goç¨‹åº</title>
    <link href="https://www.purewhite.io/2017/05/12/go-cross-compile/"/>
    <id>https://www.purewhite.io/2017/05/12/go-cross-compile/</id>
    <published>2017-05-12T14:08:45.000Z</published>
    <updated>2021-12-02T12:51:07.225Z</updated>
    
    <content type="html"><![CDATA[<p>ä½ åªéœ€è®¾ç½® <strong>GOOS</strong> å’Œ **GOARCH **ä¸¤ä¸ªç¯å¢ƒå˜é‡å°±èƒ½ç”Ÿæˆæ‰€éœ€å¹³å°çš„Goç¨‹åºã€‚</p><p>æ¯”å¦‚ä½¿ç”¨ä¸‹é¢çš„ä»£ç æµ‹è¯•ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;runtime&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;OS: %s\nArchitecture: %s\n&quot;</span>, runtime.GOOS, runtime.GOARCH)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å®ƒï¼š <code>$ GOOS=darwin GOARCH=386 go build test.go</code><br>å°±å¯ä»¥ç”Ÿæˆè¿è¡Œåœ¨<code>OS X</code>ä¸Šçš„ç¨‹åºã€‚</p><span id="more"></span><p>å¯ç”¨çš„OSå’ŒARCHçš„å€¼å¦‚ä¸‹ï¼š</p><table><thead><tr><th></th><th><code>$GOOS</code></th><th><code>$GOARCH</code></th></tr></thead><tbody><tr><td></td><td><code>darwin</code></td><td><code>386</code></td></tr><tr><td></td><td><code>darwin</code></td><td><code>amd64</code></td></tr><tr><td></td><td><code>darwin</code></td><td><code>arm</code></td></tr><tr><td></td><td><code>darwin</code></td><td><code>arm64</code></td></tr><tr><td></td><td><code>dragonfly</code></td><td><code>amd64</code></td></tr><tr><td></td><td><code>freebsd</code></td><td><code>386</code></td></tr><tr><td></td><td><code>freebsd</code></td><td><code>amd64</code></td></tr><tr><td></td><td><code>freebsd</code></td><td><code>arm</code></td></tr><tr><td></td><td><code>linux</code></td><td><code>386</code></td></tr><tr><td></td><td><code>linux</code></td><td><code>amd64</code></td></tr><tr><td></td><td><code>linux</code></td><td><code>arm</code></td></tr><tr><td></td><td><code>linux</code></td><td><code>arm64</code></td></tr><tr><td></td><td><code>linux</code></td><td><code>ppc64</code></td></tr><tr><td></td><td><code>linux</code></td><td><code>ppc64le</code></td></tr><tr><td></td><td><code>netbsd</code></td><td><code>386</code></td></tr><tr><td></td><td><code>netbsd</code></td><td><code>amd64</code></td></tr><tr><td></td><td><code>netbsd</code></td><td><code>arm</code></td></tr><tr><td></td><td><code>openbsd</code></td><td><code>386</code></td></tr><tr><td></td><td><code>openbsd</code></td><td><code>amd64</code></td></tr><tr><td></td><td><code>openbsd</code></td><td><code>arm</code></td></tr><tr><td></td><td><code>plan9</code></td><td><code>386</code></td></tr><tr><td></td><td><code>plan9</code></td><td><code>amd64</code></td></tr><tr><td></td><td><code>solaris</code></td><td><code>amd64</code></td></tr><tr><td></td><td><code>windows</code></td><td><code>386</code></td></tr><tr><td></td><td><code>windows</code></td><td><code>amd64</code></td></tr></tbody></table><p>ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸‹çš„åº“å¯èƒ½æœ‰ä¸åŒçš„å®ç°ï¼Œ æ¯”å¦‚<a href="https://golang.org/src/syscall/">syscall</a>åº“ã€‚go buildæ²¡æœ‰å†…ç½®çš„<code>#define</code>æˆ–è€…é¢„å¤„ç†å™¨ä¹‹ç±»çš„å¤„ç†å¹³å°ç›¸å…³çš„ä»£ç å–èˆï¼Œ è€Œæ˜¯é‡‡ç”¨tagå’Œæ–‡ä»¶åç¼€çš„æ–¹å¼å®ç°ã€‚<br><strong>tagæ–¹å¼</strong><br>tagéµå¾ªä¸€ä¸‹è§„åˆ™</p><ol><li>a build tag is evaluated as the OR of space-separated options</li><li>each option evaluates as the AND of its comma-separated terms</li><li>each term is an alphanumeric word or, preceded by !, its negation</li></ol><p>åœ¨æ–‡ä»¶çš„å¤´éƒ¨å¢åŠ tag:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span> +build darwin freebsd netbsd openbsd</span><br></pre></td></tr></table></figure><p>å¯ä»¥æœ‰å¤šä¸ªtag,ä¹‹é—´æ˜¯<strong>AND</strong>çš„å…³ç³»</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span> +build linux darwin</span><br><span class="line"><span class="regexp">//</span> +build <span class="number">386</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„tagå’Œpackageä¸­é—´éœ€è¦æœ‰ç©ºè¡Œåˆ†éš”ï¼Œä¸‹é¢çš„ä¾‹å­æ˜¯ä¸å¯¹çš„:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span> +build !linux</span><br><span class="line">package mypkg <span class="regexp">//</span> wrong</span><br></pre></td></tr></table></figure><p><strong>æ–‡ä»¶åç¼€æ–¹å¼</strong><br>ä»¥*_$GOOS.go*ä¸ºåç¼€çš„æ–‡ä»¶åªåœ¨æ­¤å¹³å°ä¸Šç¼–è¯‘ï¼Œå…¶å®ƒå¹³å°ä¸Šç¼–è¯‘æ—¶å°±å½“æ­¤æ–‡ä»¶ä¸å­˜åœ¨ã€‚å®Œæ•´çš„åç¼€å¦‚ï¼š</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_$GOOS_$GOARCH.go</span><br></pre></td></tr></table></figure><p>å¦‚syscall_linux_amd64.go,syscall_windows_386.go,syscall_windows.goç­‰ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä½ åªéœ€è®¾ç½® &lt;strong&gt;GOOS&lt;/strong&gt; å’Œ **GOARCH **ä¸¤ä¸ªç¯å¢ƒå˜é‡å°±èƒ½ç”Ÿæˆæ‰€éœ€å¹³å°çš„Goç¨‹åºã€‚&lt;/p&gt;
&lt;p&gt;æ¯”å¦‚ä½¿ç”¨ä¸‹é¢çš„ä»£ç æµ‹è¯•ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;fmt&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;runtime&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    fmt.Printf(&lt;span class=&quot;string&quot;&gt;&amp;quot;OS: %s\nArchitecture: %s\n&amp;quot;&lt;/span&gt;, runtime.GOOS, runtime.GOARCH)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;ç¼–è¯‘å®ƒï¼š &lt;code&gt;$ GOOS=darwin GOARCH=386 go build test.go&lt;/code&gt;&lt;br&gt;å°±å¯ä»¥ç”Ÿæˆè¿è¡Œåœ¨&lt;code&gt;OS X&lt;/code&gt;ä¸Šçš„ç¨‹åºã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="go" scheme="https://www.purewhite.io/categories/go/"/>
    
    
    <category term="go" scheme="https://www.purewhite.io/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>åœ¨debian8 jessieä¸Šå®‰è£…openjdk-8-jre-headless æˆ–è€… oracle-java8-install</title>
    <link href="https://www.purewhite.io/2017/05/10/install-openjdk-8-jre-headless-on-debian-jessie/"/>
    <id>https://www.purewhite.io/2017/05/10/install-openjdk-8-jre-headless-on-debian-jessie/</id>
    <published>2017-05-09T18:33:43.000Z</published>
    <updated>2021-12-02T12:51:07.227Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨æŠ˜è…¾dockerï¼Œå†™Dockerfileçš„æ—¶å€™éœ€è¦åœ¨jessieé‡Œé¢å®‰è£…openjdk-8-jreï¼Œä¸€ç›´å¤±è´¥ï¼Œç½‘ä¸Šæœç½—äº†ä¸€åœˆï¼Œå°è¯•äº†Nç§æ–¹æ³•ç»ˆäºæœ‰ä¸€ä¸ªworkçš„ï¼Œè®°å½•ä¸‹æ¥ã€‚</p><span id="more"></span><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb http://http.debian.net/debian jessie-backports main&quot;</span> &gt; /etc/apt/sources.list.d/jessie-backports.list</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y -t jessie-backports openjdk-8-jre-headless ca-certificates-java</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±OKå•¦ï¼</p><p>å¦‚æœéœ€è¦è£…oracle javaå¹¶è‡ªåŠ¨é€‰æ‹©åŒæ„çš„è¯ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> oracle-java8-installer shared/accepted-oracle-license-v1-1 select <span class="literal">true</span> | sudo /usr/bin/debconf-set-selections</span><br><span class="line">apt-get install -y oracle-java8-installer</span><br></pre></td></tr></table></figure><p>å°±å¯ä»¥äº†ï¼</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘åœ¨æŠ˜è…¾dockerï¼Œå†™Dockerfileçš„æ—¶å€™éœ€è¦åœ¨jessieé‡Œé¢å®‰è£…openjdk-8-jreï¼Œä¸€ç›´å¤±è´¥ï¼Œç½‘ä¸Šæœç½—äº†ä¸€åœˆï¼Œå°è¯•äº†Nç§æ–¹æ³•ç»ˆäºæœ‰ä¸€ä¸ªworkçš„ï¼Œè®°å½•ä¸‹æ¥ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="linux" scheme="https://www.purewhite.io/categories/linux/"/>
    
    
    <category term="linux" scheme="https://www.purewhite.io/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>å°†Djangoä»1.7å‡çº§åˆ°1.8å°è®¡</title>
    <link href="https://www.purewhite.io/2017/05/08/upgrade-django-from-1-7-to-1-8/"/>
    <id>https://www.purewhite.io/2017/05/08/upgrade-django-from-1-7-to-1-8/</id>
    <published>2017-05-07T22:12:27.000Z</published>
    <updated>2021-12-02T12:51:07.230Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰åœ¨é¡¹ç›®ä¸­å°†Djangoä»1.7å‡çº§åˆ°1.8ï¼Œç°åœ¨æƒ³èµ·æ¥è®°å½•ä¸€ä¸‹ç›¸å…³çš„æ­¥éª¤å’Œè¿‡ç¨‹ã€‚</p><p>ç”±äºé¡¹ç›®ä¸€å¼€å§‹ç”¨çš„æ˜¯1.6ï¼Œæ‰€ä»¥ç”¨<code>python manage.py startapp</code>é»˜è®¤æ²¡æœ‰migrationsè¿™ä¸ªpackageï¼Œè€Œä¹‹å‰åˆæœ‰ä¸€äº›modelæ˜¯ä½¿ç”¨syncdbçš„ï¼Œå¹¶ä¸”ä¹‹åå†æ²¡ä¿®æ”¹è¿‡ï¼Œæ‰€ä»¥åœ¨ç”¨1.7çš„æ—¶å€™ä¸€ç›´éƒ½æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œè€Œä¸”1.7ä¼šè‡ªåŠ¨å»ä¾¦æµ‹æ²¡æœ‰makemigrationsçš„modelå¹¶è‡ªåŠ¨migrateï¼Œå¯¼è‡´äº†åœ¨å‡çº§1.8çš„è¿‡ç¨‹ä¸­å‡ºç°äº†ä¸€äº›å°æ’æ›²ï¼Œè¿™é‡Œæ¥è®°å½•ä¸€ä¸‹ã€‚</p><span id="more"></span><p>1.7å’Œ1.8åœ¨migrateæ—¶çš„é¡ºåºä¸åŒï¼ˆå…·ä½“å¯ä»¥çœ‹ä¸€ä¸‹æºä»£ç ï¼‰ï¼Œæ‰€ä»¥å¯¼è‡´äº†1.7èƒ½æ­£å¸¸migrateï¼Œä½†æ˜¯åœ¨1.8çš„æ—¶å€™ä¼šæŠ¥é”™ColoumDoesNotExistï¼Œè§£å†³æ–¹æ¡ˆæ˜¯çœ‹çœ‹æŠ¥é”™ä¿¡æ¯ä¸­åˆ°åº•è¯´çš„æ˜¯å“ªä¸ªè¡¨æ²¡æœ‰æ¸²æŸ“æˆåŠŸã€‚æˆ‘ä»¬åªè¦å…ˆç»™è¿™ä¸ªapp makemigrationså°±å¯ä»¥äº†ï¼Œå¦‚æœè¿˜å‡ºé”™çš„è¯å°±è¿½æ ¹æº¯æºåˆ°ç¬¬ä¸€ä¸ªæŠ¥é”™çš„è¡¨ï¼Œç„¶åæŒ‰é¡ºåºä¸€ä¸ªä¸€ä¸ªå»makemigrationså³å¯ã€‚</p><p>è§£å†³äº†migrationsçš„å·®å¼‚ä¹‹åï¼Œ1.7å’Œ1.8åŸºæœ¬æ˜¯å®Œå…¨å…¼å®¹çš„ï¼Œåˆ«çš„éƒ½ä¸éœ€è¦è¿›è¡Œä¿®æ”¹ã€‚ä¸è¿‡å‡çº§åˆ°1.8ä¹‹åå°±ç®—åœ¨debugæ¨¡å¼ä¸‹<code>127.0.0.1</code>é»˜è®¤ä¹Ÿä¸åœ¨<code>settings</code>ä¸­çš„<code>ALLOWED_HOSTS</code>ä¸­äº†ï¼Œæ‰€ä»¥éœ€è¦æ·»åŠ è¿›å»æ‰èƒ½åœ¨æœ¬åœ°è®¿é—®ã€‚</p><p>è¿˜æœ‰å°±æ˜¯1.8ç”¨äº†æ–°çš„TEMPLATESçš„è®¾ç½®æ–¹æ³•ï¼Œå…·ä½“çš„çœ‹çœ‹æ–‡æ¡£ç¨å¾®ä¿®æ”¹ä¸‹å°±å¥½äº†ï¼Œéå¸¸ç®€å•é—®é¢˜ä¸å¤§ã€‚</p><p>é™„ä¸Š1.8è¦å›é€€1.7çš„è„šæœ¬ï¼ˆç»æµ‹è¯•æœ‰æ•ˆï¼‰ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python manage.py migrate auth 0001</span><br><span class="line">python manage.py migrate contenttypes 0001</span><br><span class="line">pip install django==1.7.11</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¹‹å‰åœ¨é¡¹ç›®ä¸­å°†Djangoä»1.7å‡çº§åˆ°1.8ï¼Œç°åœ¨æƒ³èµ·æ¥è®°å½•ä¸€ä¸‹ç›¸å…³çš„æ­¥éª¤å’Œè¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;p&gt;ç”±äºé¡¹ç›®ä¸€å¼€å§‹ç”¨çš„æ˜¯1.6ï¼Œæ‰€ä»¥ç”¨&lt;code&gt;python manage.py startapp&lt;/code&gt;é»˜è®¤æ²¡æœ‰migrationsè¿™ä¸ªpackageï¼Œè€Œä¹‹å‰åˆæœ‰ä¸€äº›modelæ˜¯ä½¿ç”¨syncdbçš„ï¼Œå¹¶ä¸”ä¹‹åå†æ²¡ä¿®æ”¹è¿‡ï¼Œæ‰€ä»¥åœ¨ç”¨1.7çš„æ—¶å€™ä¸€ç›´éƒ½æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œè€Œä¸”1.7ä¼šè‡ªåŠ¨å»ä¾¦æµ‹æ²¡æœ‰makemigrationsçš„modelå¹¶è‡ªåŠ¨migrateï¼Œå¯¼è‡´äº†åœ¨å‡çº§1.8çš„è¿‡ç¨‹ä¸­å‡ºç°äº†ä¸€äº›å°æ’æ›²ï¼Œè¿™é‡Œæ¥è®°å½•ä¸€ä¸‹ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="python" scheme="https://www.purewhite.io/categories/python/"/>
    
    
    <category term="åç«¯" scheme="https://www.purewhite.io/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="linux" scheme="https://www.purewhite.io/tags/linux/"/>
    
    <category term="python" scheme="https://www.purewhite.io/tags/python/"/>
    
    <category term="django" scheme="https://www.purewhite.io/tags/django/"/>
    
  </entry>
  
  <entry>
    <title>ubuntu+nginxä¸‹ä½¿ç”¨letsencryptåŠ å¯†https</title>
    <link href="https://www.purewhite.io/2017/05/06/letsencrypt-ubuntu-nginx-https/"/>
    <id>https://www.purewhite.io/2017/05/06/letsencrypt-ubuntu-nginx-https/</id>
    <published>2017-05-06T12:34:47.000Z</published>
    <updated>2021-12-02T12:51:07.228Z</updated>
    
    <content type="html"><![CDATA[<p>å› ä¸ºæœåŠ¡å™¨å¤ªä¹±ï¼Œæˆ‘æ¸…ç†äº†ä¸€ä¸‹æœåŠ¡å™¨å¹¶ä¸”é‡æ–°ä½¿ç”¨letsencryptåŠ å¯†äº†httpsï¼Œç°åœ¨å°†æˆ‘çš„ç»éªŒåˆ†äº«å‡ºæ¥ã€‚</p><p>æœ¬æ–‡åŸºäºubuntu16.04ã€nginxç¯å¢ƒ</p><h2 id="ç¬¬ä¸€æ­¥ï¼šå®‰è£…-Certbot"><a href="#ç¬¬ä¸€æ­¥ï¼šå®‰è£…-Certbot" class="headerlink" title="ç¬¬ä¸€æ­¥ï¼šå®‰è£… Certbot"></a>ç¬¬ä¸€æ­¥ï¼šå®‰è£… Certbot</h2><p>ç¬¬ä¸€æ­¥æ˜¯å®‰è£…<code>letsencrypt</code>æä¾›çš„certbotå·¥å…·</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:certbot/certbot</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install certbot</span><br></pre></td></tr></table></figure><h2 id="ç¬¬äºŒæ­¥ï¼š-è·å¾—SSLçš„è¯ä¹¦"><a href="#ç¬¬äºŒæ­¥ï¼š-è·å¾—SSLçš„è¯ä¹¦" class="headerlink" title="ç¬¬äºŒæ­¥ï¼š è·å¾—SSLçš„è¯ä¹¦"></a>ç¬¬äºŒæ­¥ï¼š è·å¾—SSLçš„è¯ä¹¦</h2><p>æˆ‘ä»¬ä½¿ç”¨<code>WebRoot</code>è¿™ä¸ªæ’ä»¶ã€‚</p><span id="more"></span><p>è¿™é‡Œä»¥nginxçš„defaultçš„siteä½œä¸ºç¤ºä¾‹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nginx/sites-available/default</span><br></pre></td></tr></table></figure><p>åœ¨serverçš„å—ä¸­ï¼ŒåŠ å…¥ä»¥ä¸‹å†…å®¹</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">location</span> <span class="title">~ /.well-known</span> &#123;</span><br><span class="line">        allow all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¡®è®¤rootæ˜¯ä½ ç½‘ç«™çš„æ ¹ç›®å½•ï¼Œæ¯”å¦‚é»˜è®¤æƒ…å†µä¸‹æ˜¯<code>/var/www/html</code></p><p>ä¿å­˜é€€å‡ºä¹‹åï¼Œæµ‹è¯•å¹¶é‡å¯ä½ çš„nginxï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t</span><br><span class="line">sudo nginx -s reload</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬è·å–åˆ°ç›¸å…³çš„SSLè¯ä¹¦ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo certbot certonly --webroot --webroot-path=/var/www/html -d example.com -d www.example.com -d third.another.com</span><br></pre></td></tr></table></figure><p>è®°å¾—æŠŠä¸Šé¢çš„<code>/var/www/html</code>æ”¹æˆä½ è‡ªå·±çš„ç½‘ç«™æ ¹ç›®å½•ã€‚å¦‚æœéœ€è¦åŒæ—¶å¯¹å¤šä¸ªåŸŸåè¿›è¡Œè®¤è¯çš„è¯åªè¦åŒæ—¶ä½¿ç”¨å¤šä¸ª<code>-d</code>å°±å¯ä»¥äº†ï¼Œå¹¶ä¸”è¿™äº›åŸŸåå¹¶ä¸ä¸€å®šéƒ½éœ€è¦ä¸º<code>example.com</code>ï¼Œå¯ä»¥ä¸ºåˆ«çš„åŸŸåã€‚</p><p>ç„¶åæ ¹æ®æç¤ºï¼Œè¾“å…¥å¯¹åº”çš„ä¿¡æ¯ï¼Œå¦‚æœå®Œæˆååº”è¯¥ä¼šçœ‹åˆ°ç±»ä¼¼çš„ä¿¡æ¯ï¼š</p><figure class="highlight tp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">IMPORTANT NOTES:</span><br><span class="line"> - Congratulations<span class="comment">! Your certificate and chain have been saved at</span></span><br><span class="line"><span class="comment">   /etc/letsencrypt/live/example.com/fullchain.pem. Your cert</span></span><br><span class="line"><span class="comment">   will expire on 2017-07-26. To obtain a new or tweaked version of</span></span><br><span class="line"><span class="comment">   this certificate in the future, simply run certbot again. To</span></span><br><span class="line"><span class="comment">   non-interactively renew *all* of your certificates, run &quot;certbot</span></span><br><span class="line"><span class="comment">   renew&quot;</span></span><br><span class="line"><span class="comment"> - If you lose your account credentials, you can recover through</span></span><br><span class="line"><span class="comment">   e-mails sent to sammy@example.com.</span></span><br><span class="line"><span class="comment"> - Your account credentials have been saved in your Certbot</span></span><br><span class="line"><span class="comment">   configuration directory at /etc/letsencrypt. You should make a</span></span><br><span class="line"><span class="comment">   secure backup of this folder now. This configuration directory will</span></span><br><span class="line"><span class="comment">   also contain certificates and private keys obtained by Certbot so</span></span><br><span class="line"><span class="comment">   making regular backups of this folder is ideal.</span></span><br><span class="line"><span class="comment"> - If you like Certbot, please consider supporting our work by:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   Donating to ISRG / Let&#x27;s Encrypt:   https://letsencrypt.org/donate</span></span><br><span class="line"><span class="comment">   Donating to EFF:                    https://eff.org/donate-le</span></span><br></pre></td></tr></table></figure><p>è®¤è¯æˆåŠŸåï¼Œæˆ‘ä»¬æ¥ç”Ÿæˆä¸€ä¸‹æ›´å¼ºçš„<code>dhparam</code>ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048</span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ­¥åº”è¯¥ä¼šæ¶ˆè€—ä¸€å®šçš„æ—¶é—´</p><h2 id="ç¬¬ä¸‰æ­¥ï¼šåœ¨nginxä¸Šè®¾ç½®TLS-SSL"><a href="#ç¬¬ä¸‰æ­¥ï¼šåœ¨nginxä¸Šè®¾ç½®TLS-SSL" class="headerlink" title="ç¬¬ä¸‰æ­¥ï¼šåœ¨nginxä¸Šè®¾ç½®TLS/SSL"></a>ç¬¬ä¸‰æ­¥ï¼šåœ¨nginxä¸Šè®¾ç½®TLS/SSL</h2><p>æˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„è„šæœ¬ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/nginx/snippets/ssl-example.com.conf</span><br></pre></td></tr></table></figure><p>å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;</span><br><span class="line">ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;</span><br></pre></td></tr></table></figure><p>ä¿å­˜é€€å‡ºåï¼Œå†åˆ›å»ºä¸€ä¸ªè„šæœ¬ç”¨æ¥è®¾ç½®sslçš„å‚æ•°ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/nginx/snippets/ssl-params.conf</span><br></pre></td></tr></table></figure><p>å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from https://cipherli.st/</span></span><br><span class="line"><span class="comment"># and https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;</span><br><span class="line"><span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">ssl_ciphers</span> <span class="string">&quot;EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH&quot;</span>;</span><br><span class="line"><span class="attribute">ssl_ecdh_curve</span> secp384r1;</span><br><span class="line"><span class="attribute">ssl_session_cache</span> shared:SSL:<span class="number">10m</span>;</span><br><span class="line"><span class="attribute">ssl_session_tickets</span> <span class="literal">off</span>;</span><br><span class="line"><span class="attribute">ssl_stapling</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">ssl_stapling_verify</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">resolver</span> <span class="number">8.8.8.8</span> <span class="number">8.8.4.4</span> valid=<span class="number">300s</span>;</span><br><span class="line"><span class="attribute">resolver_timeout</span> <span class="number">5s</span>;</span><br><span class="line"><span class="comment"># disable HSTS header for now</span></span><br><span class="line"><span class="comment">#add_header Strict-Transport-Security &quot;max-age=63072000; includeSubDomains; preload&quot;;</span></span><br><span class="line"><span class="attribute">add_header</span> X-Frame-Options DENY;</span><br><span class="line"><span class="attribute">add_header</span> X-Content-Type-Options nosniff;</span><br><span class="line"></span><br><span class="line"><span class="attribute">ssl_dhparam</span> /etc/ssl/certs/dhparam.pem;</span><br></pre></td></tr></table></figure><p>ä¿å­˜é€€å‡ºã€‚</p><p>ç„¶åä¿®æ”¹ä¸€ä¸‹siteçš„é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/nginx/sites-available/default</span><br></pre></td></tr></table></figure><p>æ”¹æˆè¿™æ ·ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">server</span> &#123;</span><br><span class="line">    <span class="keyword">listen</span> <span class="number">80</span> default_server;</span><br><span class="line">    <span class="keyword">listen</span> [::]:<span class="number">80</span> default_server;</span><br><span class="line">    <span class="keyword">listen</span> <span class="number">443</span> ssl http2 default_server;</span><br><span class="line">    <span class="keyword">listen</span> [::]:<span class="number">443</span> ssl http2 default_server;</span><br><span class="line"></span><br><span class="line">    server_name example.com www.example.com;</span><br><span class="line">    <span class="keyword">include</span> snippets/ssl-example.com.conf;</span><br><span class="line">    <span class="keyword">include</span> snippets/ssl-params.conf;</span><br><span class="line"></span><br><span class="line">    . . .</span><br></pre></td></tr></table></figure><p>ä¿å­˜é€€å‡ºã€‚</p><h2 id="ç¬¬å››æ­¥ï¼šåœ¨é˜²ç«å¢™ä¸­Allow-Nginx"><a href="#ç¬¬å››æ­¥ï¼šåœ¨é˜²ç«å¢™ä¸­Allow-Nginx" class="headerlink" title="ç¬¬å››æ­¥ï¼šåœ¨é˜²ç«å¢™ä¸­Allow Nginx"></a>ç¬¬å››æ­¥ï¼šåœ¨é˜²ç«å¢™ä¸­Allow Nginx</h2><p>æ‰§è¡Œä»¥ä¸‹è„šæœ¬ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw allow <span class="string">&#x27;Nginx Full&#x27;</span></span><br><span class="line">sudo nginx -t</span><br><span class="line">sudo nginx -s reload</span><br></pre></td></tr></table></figure><h2 id="ç¬¬äº”æ­¥ï¼šè‡ªåŠ¨æ›´æ–°SSLè¯ä¹¦"><a href="#ç¬¬äº”æ­¥ï¼šè‡ªåŠ¨æ›´æ–°SSLè¯ä¹¦" class="headerlink" title="ç¬¬äº”æ­¥ï¼šè‡ªåŠ¨æ›´æ–°SSLè¯ä¹¦"></a>ç¬¬äº”æ­¥ï¼šè‡ªåŠ¨æ›´æ–°SSLè¯ä¹¦</h2><p>å› ä¸ºletsencryptæä¾›çš„è¯ä¹¦æ˜¯æœ‰æœŸé™çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è®¾ç½®è‡ªåŠ¨æ›´æ–°è¯ä¹¦ã€‚</p><p>æ‰§è¡Œå‘½ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo crontab -e</span><br></pre></td></tr></table></figure><p>åœ¨æœ€ååŠ ä¸Šè¿™ä¹ˆä¸€è¡Œï¼š</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">30 </span><span class="number">0</span> * * <span class="number">1</span> /<span class="keyword">usr</span>/bin/certbot renew --quiet --renew-hook <span class="string">&quot;/bin/systemctl reload nginx&quot;</span></span><br></pre></td></tr></table></figure><p>å®Œæˆï¼</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å› ä¸ºæœåŠ¡å™¨å¤ªä¹±ï¼Œæˆ‘æ¸…ç†äº†ä¸€ä¸‹æœåŠ¡å™¨å¹¶ä¸”é‡æ–°ä½¿ç”¨letsencryptåŠ å¯†äº†httpsï¼Œç°åœ¨å°†æˆ‘çš„ç»éªŒåˆ†äº«å‡ºæ¥ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡åŸºäºubuntu16.04ã€nginxç¯å¢ƒ&lt;/p&gt;
&lt;h2 id=&quot;ç¬¬ä¸€æ­¥ï¼šå®‰è£…-Certbot&quot;&gt;&lt;a href=&quot;#ç¬¬ä¸€æ­¥ï¼šå®‰è£…-Certbot&quot; class=&quot;headerlink&quot; title=&quot;ç¬¬ä¸€æ­¥ï¼šå®‰è£… Certbot&quot;&gt;&lt;/a&gt;ç¬¬ä¸€æ­¥ï¼šå®‰è£… Certbot&lt;/h2&gt;&lt;p&gt;ç¬¬ä¸€æ­¥æ˜¯å®‰è£…&lt;code&gt;letsencrypt&lt;/code&gt;æä¾›çš„certbotå·¥å…·&lt;/p&gt;
&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;sudo add-apt-repository ppa:certbot/certbot&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo apt-get update&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo apt-get install certbot&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&quot;ç¬¬äºŒæ­¥ï¼š-è·å¾—SSLçš„è¯ä¹¦&quot;&gt;&lt;a href=&quot;#ç¬¬äºŒæ­¥ï¼š-è·å¾—SSLçš„è¯ä¹¦&quot; class=&quot;headerlink&quot; title=&quot;ç¬¬äºŒæ­¥ï¼š è·å¾—SSLçš„è¯ä¹¦&quot;&gt;&lt;/a&gt;ç¬¬äºŒæ­¥ï¼š è·å¾—SSLçš„è¯ä¹¦&lt;/h2&gt;&lt;p&gt;æˆ‘ä»¬ä½¿ç”¨&lt;code&gt;WebRoot&lt;/code&gt;è¿™ä¸ªæ’ä»¶ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="linux" scheme="https://www.purewhite.io/categories/linux/"/>
    
    
    <category term="linux" scheme="https://www.purewhite.io/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>DockeråŸºç¡€æŠ€æœ¯â€”â€”AUFS</title>
    <link href="https://www.purewhite.io/2017/05/06/docker-aufs/"/>
    <id>https://www.purewhite.io/2017/05/06/docker-aufs/</id>
    <published>2017-05-06T08:23:43.000Z</published>
    <updated>2021-12-02T12:51:07.225Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨å­¦ä¹ dockerï¼Œçœ‹åˆ°äº†ä¸€ç¯‡æ¯”è¾ƒå¥½çš„æ–‡ç« ï¼Œäºæ˜¯è½¬è½½äº†è¿‡æ¥ï¼ŒåŸæ–‡å‡ºå¤„åœ¨æœ€åã€‚</p><p>AUFSæ˜¯ä¸€ç§Union File Systemï¼Œæ‰€è°“UnionFSå°±æ˜¯æŠŠä¸åŒç‰©ç†ä½ç½®çš„ç›®å½•åˆå¹¶mountåˆ°åŒä¸€ä¸ªç›®å½•ä¸­ã€‚UnionFSçš„ä¸€ä¸ªæœ€ä¸»è¦çš„åº”ç”¨æ˜¯ï¼ŒæŠŠä¸€å¼ CD/DVDå’Œä¸€ä¸ªç¡¬ç›˜ç›®å½•ç»™è”åˆ mountåœ¨ä¸€èµ·ï¼Œç„¶åï¼Œä½ å°±å¯ä»¥å¯¹è¿™ä¸ªåªè¯»çš„CD/DVDä¸Šçš„æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼ˆå½“ç„¶ï¼Œä¿®æ”¹çš„æ–‡ä»¶å­˜äºç¡¬ç›˜ä¸Šçš„ç›®å½•é‡Œï¼‰ã€‚</p><span id="more"></span>![](http://coolshell.cn//wp-content/uploads/2015/08/docker-filesystems-busyboxrw.png)<p>AUFSåˆå«Another UnionFSï¼Œåæ¥å«Alternative UnionFSï¼Œåæ¥å¯èƒ½è§‰å¾—ä¸å¤Ÿéœ¸æ°”ï¼Œå«æˆAdvance UnionFSã€‚æ˜¯ä¸ªå«Junjiro Okajimaï¼ˆå²¡å³¶é †æ²»éƒï¼‰åœ¨2006å¹´å¼€å‘çš„ï¼ŒAUFSå®Œå…¨é‡å†™äº†æ—©æœŸçš„UnionFS 1.xï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†å¯é æ€§å’Œæ€§èƒ½ï¼Œå¹¶ä¸”å¼•å…¥äº†ä¸€äº›æ–°çš„åŠŸèƒ½ï¼Œæ¯”å¦‚å¯å†™åˆ†æ”¯çš„è´Ÿè½½å‡è¡¡ã€‚AUFSåœ¨ä½¿ç”¨ä¸Šå…¨å…¼å®¹UnionFSï¼Œè€Œä¸”æ¯”ä¹‹å‰çš„UnionFSåœ¨ç¨³å®šæ€§å’Œæ€§èƒ½ä¸Šéƒ½è¦å¥½å¾ˆå¤šï¼Œåæ¥çš„UnionFS 2.xå¼€å§‹æŠ„AUFSä¸­çš„åŠŸèƒ½ã€‚ä½†æ˜¯ä»–å±…ç„¶æ²¡æœ‰è¿›åˆ°Linuxä¸»å¹²é‡Œï¼Œå°±æ˜¯å› ä¸ºLinusä¸è®©ï¼ŒåŸºæœ¬ä¸Šæ˜¯å› ä¸ºä»£ç é‡æ¯”è¾ƒå¤šï¼Œè€Œä¸”å†™å¾—çƒ‚ï¼ˆç›¸å¯¹äºåªæœ‰3000è¡Œçš„union mountå’Œ10000è¡Œçš„UnionFSï¼Œä»¥åŠå…¶å®ƒå¹³å‡ä¸‹æ¥åªæœ‰6000è¡Œä»£ç å·¦å³çš„VFSï¼ŒAUFSå±…ç„¶æœ‰30000è¡Œä»£ç ï¼‰ï¼Œæ‰€ä»¥ï¼Œå²¡å³¶ä¸æ–­åœ°æ”¹è¿›ä»£ç è´¨é‡ï¼Œä¸æ–­åœ°æäº¤ï¼Œä¸æ–­åœ°è¢«Linusæ‹’æ‰ï¼Œæ‰€ä»¥ï¼Œåˆ°ä»Šå¤©AUFSéƒ½è¿˜è¿›ä¸äº†Linuxä¸»å¹²ï¼ˆä»Šå¤©ä½ å¯ä»¥çœ‹åˆ°AUFSçš„ä»£ç å…¶å®è¿˜å¥½äº†ï¼Œæ¯”èµ·OpenSSLå¥½Nå€ï¼Œè¦ä¹ˆå°±æ˜¯Linuså¯¹ä»£ç çš„è´¨é‡è¦æ±‚éå¸¸é«˜ï¼Œè¦ä¹ˆå°±æ˜¯Linuså°±æ˜¯ä¸å–œæ¬¢AUFSï¼‰ã€‚</p><p>ä¸è¿‡ï¼Œå¥½åœ¨æœ‰å¾ˆå¤šå‘è¡Œç‰ˆéƒ½ç”¨äº†AUFSï¼Œæ¯”å¦‚ï¼šUbuntu 10.04ï¼ŒDebian6.0, Gentoo Live CDæ”¯æŒAUFSï¼Œæ‰€ä»¥ï¼Œä¹ŸOKäº†ã€‚</p><p>å¥½äº†ï¼Œæ‰¯å®Œè¿™äº›é—²è¯ï¼Œæˆ‘ä»¬è¿˜æ˜¯çœ‹ä¸€ä¸ªç¤ºä¾‹å§ï¼ˆç¯å¢ƒï¼šUbuntu 14.04ï¼‰</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å»ºä¸Šä¸¤ä¸ªç›®å½•ï¼ˆæ°´æœå’Œè”¬èœï¼‰ï¼Œå¹¶åœ¨è¿™ä¸¤ä¸ªç›®å½•ä¸­æ”¾ä¸Šä¸€äº›æ–‡ä»¶ï¼Œæ°´æœä¸­æœ‰è‹¹æœå’Œè•ƒèŒ„ï¼Œè”¬èœæœ‰èƒ¡èåœå’Œè•ƒèŒ„ã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š</p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨./mntç›®å½•ä¸‹æœ‰ä¸‰ä¸ªæ–‡ä»¶ï¼Œè‹¹æœappleã€èƒ¡èåœcarrotså’Œè•ƒèŒ„tomatoã€‚æ°´æœå’Œè”¬èœçš„ç›®å½•è¢«unionåˆ°äº†./mntç›®å½•ä¸‹äº†ã€‚</p><p>æˆ‘ä»¬æ¥ä¿®æ”¹ä¸€ä¸‹å…¶ä¸­çš„æ–‡ä»¶å†…å®¹ï¼š</p><p>ä¸Šé¢çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°./mnt/appleçš„å†…å®¹æ”¹äº†ï¼Œ./fruits/appleçš„å†…å®¹ä¹Ÿæ”¹äº†ã€‚</p><p>ä¸Šé¢çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¿®æ”¹äº†./mnt/carrotsçš„æ–‡ä»¶å†…å®¹ï¼Œ./vegetables/carrotså¹¶æ²¡æœ‰å˜åŒ–ï¼Œåè€Œæ˜¯./fruits/carrotsçš„ç›®å½•ä¸­å‡ºç°äº†carrotsæ–‡ä»¶ï¼Œå…¶å†…å®¹æ˜¯æˆ‘ä»¬åœ¨./mnt/carrotsé‡Œçš„å†…å®¹ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åœ¨mount aufså‘½ä»¤ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰æŒ‡å®ƒvegetableså’Œfruitsçš„ç›®å½•æƒé™ï¼Œé»˜è®¤ä¸Šæ¥è¯´ï¼Œå‘½ä»¤è¡Œä¸Šç¬¬ä¸€ä¸ªï¼ˆæœ€å·¦è¾¹ï¼‰çš„ç›®å½•æ˜¯å¯è¯»å¯å†™çš„ï¼Œåé¢çš„å…¨éƒ½æ˜¯åªè¯»çš„ã€‚ï¼ˆä¸€èˆ¬æ¥è¯´ï¼Œæœ€å‰é¢çš„ç›®å½•åº”è¯¥æ˜¯å¯å†™çš„ï¼Œè€Œåé¢çš„éƒ½åº”è¯¥æ˜¯åªè¯»çš„ï¼‰</p><p>æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬åƒä¸‹é¢è¿™æ ·æŒ‡å®šæƒé™æ¥mount aufsï¼Œä½ å°±ä¼šå‘ç°æœ‰ä¸ä¸€æ ·çš„æ•ˆæœï¼ˆè®°å¾—å…ˆæŠŠä¸Šé¢./fruits/carrotsçš„æ–‡ä»¶åˆ é™¤äº†ï¼‰ï¼š</p><p>ç°åœ¨ï¼Œåœ¨è¿™æƒ…å†µä¸‹ï¼Œå¦‚æœæˆ‘ä»¬è¦ä¿®æ”¹./mnt/tomatoè¿™ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆç©¶ç«Ÿæ˜¯å“ªä¸ªæ–‡ä»¶ä¼šè¢«æ”¹å†™ï¼Ÿ</p><p>å¯è§ï¼Œå¦‚æœæœ‰é‡å¤çš„æ–‡ä»¶åï¼Œåœ¨mountå‘½ä»¤è¡Œä¸Šï¼Œè¶Šå¾€å‰çš„å°±ä¼˜å…ˆçº§è¶Šé«˜ã€‚</p><p>ä½ å¯ä»¥ç”¨è¿™ä¸ªä¾‹å­åšä¸€äº›å„ç§å„æ ·çš„è¯•éªŒï¼Œæˆ‘è¿™é‡Œä¸»è¦æ˜¯ç»™å¤§å®¶ä¸€ä¸ªæ„Ÿæ€§è®¤è¯†ï¼Œå°±ä¸å±•å¼€è¯•éªŒä¸‹å»äº†ã€‚</p><p>é‚£ä¹ˆï¼Œè¿™ç§UnionFSæœ‰ä»€ä¹ˆç”¨ï¼Ÿ</p><p>å†å²ä¸Šï¼Œæœ‰ä¸€ä¸ªå«<a href="http://zh.wikipedia.org/wiki/Knoppix">Knoppixçš„Linuxå‘è¡Œç‰ˆ</a>ï¼Œå…¶ä¸»è¦ç”¨äºLinuxæ¼”ç¤ºã€å…‰ç›˜æ•™å­¦ã€ç³»ç»Ÿæ€¥æ•‘ï¼Œä»¥åŠå•†ä¸šäº§å“çš„æ¼”ç¤ºï¼Œä¸éœ€è¦ç¡¬ç›˜å®‰è£…ï¼Œç›´æ¥æŠŠCD/DVDä¸Šçš„imageè¿è¡Œåœ¨ä¸€ä¸ªå¯å†™çš„å­˜å‚¨è®¾å¤‡ä¸Šï¼ˆæ¯”å¦‚ä¸€ä¸ªUç›˜ä¸Šï¼‰ï¼Œå…¶å®ï¼Œä¹Ÿå°±æ˜¯æŠŠCD/DVDè¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿå’ŒUSBè¿™ä¸ªå¯å†™çš„ç³»ç»Ÿç»™è”åˆmountèµ·æ¥ï¼Œè¿™æ ·ä½ å¯¹CD/DVDä¸Šçš„imageåšçš„ä»»ä½•æ”¹åŠ¨éƒ½ä¼šåœ¨è¢«åº”ç”¨åœ¨Uç›˜ä¸Šï¼Œäºæ˜¯ä¹ï¼Œä½ å¯ä»¥å¯¹CD/DVDä¸Šçš„å†…å®¹è¿›è¡Œä»»æ„çš„ä¿®æ”¹ï¼Œå› ä¸ºæ”¹åŠ¨éƒ½åœ¨Uç›˜ä¸Šï¼Œæ‰€ä»¥ä½ æ”¹ä¸ååŸæ¥çš„ä¸œè¥¿ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å†å‘æŒ¥ä¸€ä¸‹æƒ³åƒåŠ›ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠä¸€ä¸ªç›®å½•ï¼Œæ¯”å¦‚ä½ çš„æºä»£ç ï¼Œä½œä¸ºä¸€ä¸ªåªè¯»çš„templateï¼Œå’Œå¦ä¸€ä¸ªä½ çš„working directoryç»™unionåœ¨ä¸€èµ·ï¼Œç„¶åä½ å°±å¯ä»¥åšå„ç§ä¿®æ”¹è€Œä¸ç”¨å®³æ€•ä¼šæŠŠæºä»£ç æ”¹åäº†ã€‚æœ‰ç‚¹åƒä¸€ä¸ªad hoc snapshotã€‚</p><p>DockeræŠŠUnionFSçš„æƒ³åƒåŠ›å‘æŒ¥åˆ°äº†å®¹å™¨çš„é•œåƒã€‚ä½ æ˜¯å¦è¿˜è®°å¾—æˆ‘åœ¨<a href="http://coolshell.cn/articles/17010.html">ä»‹ç»Linux Namespaceä¸Šç¯‡</a>ä¸­ç”¨mount namespaceå’Œchrootå±±å¯¨äº†ä¸€é•œåƒã€‚ç°åœ¨å½“ä½ çœ‹è¿‡äº†è¿™ä¸ªUnionFSçš„æŠ€æœ¯åï¼Œä½ æ˜¯ä¸æ˜¯å°±æ˜ç™½äº†ï¼Œä½ å®Œå…¨å¯ä»¥ç”¨UnionFSè¿™æ ·çš„æŠ€æœ¯åšå‡ºåˆ†å±‚çš„é•œåƒæ¥ã€‚</p><p>ä¸‹å›¾æ¥è‡ªDockerçš„å®˜æ–¹æ–‡æ¡£<a href="http://docs.docker.com/terms/layer/">Layer</a>ï¼Œå…¶å¾ˆå¥½çš„å±•ç¤ºäº†Dockerç”¨UnionFSæ­å»ºçš„åˆ†å±‚é•œåƒã€‚</p><p><img data-src="http://coolshell.cn//wp-content/uploads/2015/04/docker-filesystems-multilayer.png" alt="docker-filesystems-multilayer"></p><p>å…³äºdockerçš„åˆ†å±‚é•œåƒï¼Œé™¤äº†aufsï¼Œdockerè¿˜æ”¯æŒbtrfs, devicemapperå’Œvfsï¼Œä½ å¯ä»¥ä½¿ç”¨ -s æˆ– â€“storage-driver= é€‰é¡¹æ¥æŒ‡å®šç›¸å…³çš„é•œåƒå­˜å‚¨ã€‚åœ¨Ubuntu 14.04ä¸‹ï¼Œdockeré»˜è®¤Ubuntuçš„ aufsï¼ˆåœ¨CentOS7ä¸‹ï¼Œç”¨çš„æ˜¯devicemapperï¼Œå…³äºdevicemapperï¼Œæˆ‘ä¼šä»¥ä»¥åçš„æ–‡ç« ä¸­è®²è§£ï¼‰ä½ å¯ä»¥åœ¨ä¸‹é¢çš„ç›®å½•ä¸­æŸ¥çœ‹ç›¸å…³çš„æ¯ä¸ªå±‚çš„é•œåƒï¼š</p><p>åœ¨dockeræ‰§è¡Œèµ·æ¥åï¼ˆæ¯”å¦‚ï¼šdocker run -it ubuntu /bin/bash ï¼‰ï¼Œä½ å¯ä»¥ä»/sys/fs/aufs/si_[id]ç›®å½•ä¸‹æŸ¥çœ‹aufsçš„mountçš„æƒ…å†µï¼Œä¸‹é¢æ˜¯ä¸ªç¤ºä¾‹ï¼š</p><p>ä½ ä¼šçœ‹åˆ°åªæœ‰æœ€é¡¶ä¸Šçš„å±‚ï¼ˆbranchï¼‰æ˜¯rwæƒé™ï¼Œå…¶å®ƒçš„éƒ½æ˜¯ro+whæƒé™åªè¯»çš„ã€‚</p><p>å…³äºdockerçš„aufsçš„é…ç½®ï¼Œä½ å¯ä»¥åœ¨/var/lib/docker/repositories-aufsè¿™ä¸ªæ–‡ä»¶ä¸­çœ‹åˆ°ã€‚</p><h4 id="AUFSçš„ä¸€äº›ç‰¹æ€§"><a href="#AUFSçš„ä¸€äº›ç‰¹æ€§" class="headerlink" title="AUFSçš„ä¸€äº›ç‰¹æ€§"></a>AUFSçš„ä¸€äº›ç‰¹æ€§</h4><p>AUFSæœ‰æ‰€æœ‰Union FSçš„ç‰¹æ€§ï¼ŒæŠŠå¤šä¸ªç›®å½•ï¼Œåˆå¹¶æˆåŒä¸€ä¸ªç›®å½•ï¼Œå¹¶å¯ä»¥ä¸ºæ¯ä¸ªéœ€è¦åˆå¹¶çš„ç›®å½•æŒ‡å®šç›¸åº”çš„æƒé™ï¼Œå®æ—¶çš„æ·»åŠ ã€åˆ é™¤ã€ä¿®æ”¹å·²ç»è¢«mountå¥½çš„ç›®å½•ã€‚è€Œä¸”ï¼Œä»–è¿˜èƒ½åœ¨å¤šä¸ªå¯å†™çš„branch/diré—´è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚</p><p>ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°AUFSçš„mountçš„ç¤ºä¾‹äº†ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹è¢«unionçš„ç›®å½•ï¼ˆåˆ†æ”¯ï¼‰çš„ç›¸å…³æƒé™ï¼š</p><ul><li>rwè¡¨ç¤ºå¯å†™å¯è¯»read-writeã€‚</li><li>roè¡¨ç¤ºread-onlyï¼Œå¦‚æœä½ ä¸æŒ‡æƒé™ï¼Œé‚£ä¹ˆé™¤äº†ç¬¬ä¸€ä¸ªå¤–roæ˜¯é»˜è®¤å€¼ï¼Œå¯¹äºroåˆ†æ”¯ï¼Œå…¶æ°¸è¿œä¸ä¼šæ”¶åˆ°å†™æ“ä½œï¼Œä¹Ÿä¸ä¼šæ”¶åˆ°æŸ¥æ‰¾whiteoutçš„æ“ä½œã€‚</li><li>rrè¡¨ç¤ºreal-read-onlyï¼Œä¸read-onlyä¸åŒçš„æ˜¯ï¼Œrræ ‡è®°çš„æ˜¯å¤©ç”Ÿå°±æ˜¯åªè¯»çš„åˆ†æ”¯ï¼Œè¿™æ ·ï¼ŒAUFSå¯ä»¥æé«˜æ€§èƒ½ï¼Œæ¯”å¦‚ä¸å†è®¾ç½®inotifyæ¥æ£€æŸ¥æ–‡ä»¶å˜åŠ¨é€šçŸ¥ã€‚</li></ul><p>æƒé™ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†ä¸€ä¸ªæœ¯è¯­ï¼šwhiteoutï¼Œä¸‹é¢æˆ‘æ¥è§£é‡Šä¸€ä¸‹è¿™ä¸ªæœ¯è¯­ã€‚</p><p>ä¸€èˆ¬æ¥è¯´roçš„åˆ†æ”¯éƒ½ä¼šæœ‰whçš„å±æ€§ï¼Œæ¯”å¦‚ â€œ[dir]=ro+whâ€ã€‚æ‰€è°“whiteoutçš„æ„æ€ï¼Œå¦‚æœåœ¨unionä¸­åˆ é™¤çš„æŸä¸ªæ–‡ä»¶ï¼Œå®é™…ä¸Šæ˜¯ä½äºä¸€ä¸ªreadonlyçš„åˆ†æ”¯ï¼ˆç›®å½•ï¼‰ä¸Šï¼Œé‚£ä¹ˆï¼Œåœ¨mountçš„unionè¿™ä¸ªç›®å½•ä¸­ä½ å°†çœ‹ä¸åˆ°è¿™ä¸ªæ–‡ä»¶ï¼Œä½†æ˜¯read-onlyè¿™ä¸ªå±‚ä¸Šæˆ‘ä»¬æ— æ³•åšä»»ä½•çš„ä¿®æ”¹ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å°±éœ€è¦å¯¹è¿™ä¸ªreadonlyç›®å½•é‡Œçš„æ–‡ä»¶ä½œwhiteoutã€‚AUFSçš„whiteoutçš„å®ç°æ˜¯é€šè¿‡åœ¨ä¸Šå±‚çš„å¯å†™çš„ç›®å½•ä¸‹å»ºç«‹å¯¹åº”çš„whiteoutéšè—æ–‡ä»¶æ¥å®ç°çš„ã€‚</p><p>çœ‹ä¸ªä¾‹å­ï¼š</p><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸‰ä¸ªç›®å½•å’Œæ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼ˆtestæ˜¯ä¸ªç©ºç›®å½•ï¼‰ï¼š</p><p>æˆ‘ä»¬å¦‚ä¸‹mountï¼š</p><p>ç°åœ¨æˆ‘ä»¬åœ¨æƒé™ä¸ºrwçš„testç›®å½•ä¸‹å»ºä¸ªwhiteoutçš„éšè—æ–‡ä»¶.wh.appleï¼Œä½ å°±ä¼šå‘ç°./mnt/appleè¿™ä¸ªæ–‡ä»¶å°±æ¶ˆå¤±äº†:</p><p>ä¸Šé¢è¿™ä¸ªæ“ä½œå’Œ rm ./mnt/appleæ˜¯ä¸€æ ·çš„ã€‚</p><h5 id="ç›¸å…³æœ¯è¯­"><a href="#ç›¸å…³æœ¯è¯­" class="headerlink" title="ç›¸å…³æœ¯è¯­"></a>ç›¸å…³æœ¯è¯­</h5><p>Âš<strong>Branch</strong> â€“ å°±æ˜¯å„ä¸ªè¦è¢«unionèµ·æ¥çš„ç›®å½•ï¼ˆå°±æ˜¯æˆ‘åœ¨ä¸Šé¢ä½¿ç”¨çš„dirsçš„å‘½ä»¤è¡Œå‚æ•°ï¼‰</p><ul><li>ÂšBranchæ ¹æ®è¢«unionçš„é¡ºåºå½¢æˆä¸€ä¸ªstackï¼Œä¸€èˆ¬æ¥è¯´æœ€ä¸Šé¢çš„æ˜¯å¯å†™çš„ï¼Œä¸‹é¢çš„éƒ½æ˜¯åªè¯»çš„ã€‚</li><li>ÂšBranchçš„stackå¯ä»¥åœ¨è¢«mountåè¿›è¡Œä¿®æ”¹ï¼Œæ¯”å¦‚ï¼šä¿®æ”¹é¡ºåºï¼ŒåŠ å…¥æ–°çš„branchï¼Œæˆ–æ˜¯åˆ é™¤å…¶ä¸­çš„branchï¼Œæˆ–æ˜¯ç›´æ¥ä¿®æ”¹branchçš„æƒé™</li></ul><p>Âš<strong>Whiteout</strong> å’Œ <strong>Opaque</strong></p><ul><li>Âšå¦‚æœUnionFSä¸­çš„æŸä¸ªç›®å½•è¢«åˆ é™¤äº†ï¼Œé‚£ä¹ˆå°±åº”è¯¥ä¸å¯è§äº†ï¼Œå°±ç®—æ˜¯åœ¨åº•å±‚çš„branchä¸­è¿˜æœ‰è¿™ä¸ªç›®å½•ï¼Œé‚£ä¹Ÿåº”è¯¥ä¸å¯è§äº†ã€‚</li></ul><ul><li>ÂšWhiteoutå°±æ˜¯æŸä¸ªä¸Šå±‚ç›®å½•è¦†ç›–äº†ä¸‹å±‚çš„ç›¸åŒåå­—çš„ç›®å½•ã€‚ç”¨äºéšè—ä½å±‚åˆ†æ”¯çš„æ–‡ä»¶ï¼Œä¹Ÿç”¨äºé˜»æ­¢readdirè¿›å…¥ä½å±‚åˆ†æ”¯ã€‚</li></ul><ul><li>ÂšOpaqueçš„æ„æ€å°±æ˜¯ä¸å…è®¸ä»»ä½•ä¸‹å±‚çš„æŸä¸ªç›®å½•æ˜¾ç¤ºå‡ºæ¥ã€‚</li></ul><ul><li>Âšåœ¨éšè—ä½å±‚æ¡£çš„æƒ…å†µä¸‹ï¼Œwhiteoutçš„åå­—æ˜¯â€™.wh.<filename>â€™ã€‚</li></ul><ul><li>Âšåœ¨é˜»æ­¢readdirçš„æƒ…å†µä¸‹ï¼Œåå­—æ˜¯â€™.wh..wh..opqâ€™æˆ–è€… â€™.wh.__dir_opaqueâ€™ã€‚</li></ul><h5 id="ç›¸å…³é—®é¢˜"><a href="#ç›¸å…³é—®é¢˜" class="headerlink" title="ç›¸å…³é—®é¢˜"></a>ç›¸å…³é—®é¢˜</h5><p>çœ‹åˆ°ä¸Šé¢è¿™äº›ï¼Œä½ ä¸€å®šä¼šæœ‰å‡ ä¸ªé—®é¢˜ï¼š</p><p><strong>å…¶ä¸€ã€ä½ å¯èƒ½ä¼šé—®ï¼Œè¦æœ‰æ–‡ä»¶åœ¨åŸæ¥çš„åœ°æ–¹è¢«ä¿®æ”¹äº†ä¼šæ€ä¹ˆæ ·ï¼Ÿ</strong>mountçš„ç›®å½•ä¼šä¸€èµ·æ”¹å˜å—ï¼Ÿç­”æ¡ˆæ˜¯ä¼šçš„ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸ä¼šçš„ã€‚å› ä¸ºä½ å¯ä»¥æŒ‡å®šä¸€ä¸ªå«udbaçš„å‚æ•°ï¼ˆå…¨ç§°ï¼šUserâ€™s Direct Branch Accessï¼‰ï¼Œè¿™ä¸ªå‚æ•°æœ‰ä¸‰ä¸ªå–å€¼ï¼š</p><ul><li><strong>udba=none</strong> â€“ è®¾ç½®ä¸Šè¿™ä¸ªå‚æ•°åï¼ŒAUFSä¼šè¿è½¬çš„æ›´å¿«ï¼Œå› ä¸ºé‚£äº›ä¸åœ¨mountç›®å½•é‡Œå‘ç”Ÿçš„ä¿®æ”¹ï¼Œaufsä¸ä¼šåŒæ­¥è¿‡æ¥äº†ï¼Œæ‰€ä»¥ä¼šæœ‰æ•°æ®å‡ºé”™çš„é—®é¢˜ã€‚</li><li><strong>udba=reval</strong> â€“ è®¾ç½®ä¸Šè¿™ä¸ªå‚æ•°åï¼ŒAUFSä¼šå»æŸ¥æ–‡ä»¶æœ‰æ²¡æœ‰è¢«æ›´æ–°ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œå°±ä¼šæŠŠä¿®æ”¹æ‹‰åˆ°mountç›®å½•å†…ã€‚</li><li><strong>udba=notify</strong> â€“ è¿™ä¸ªå‚æ•°ä¼šè®©AUFSä¸ºæ‰€æœ‰çš„branchæ³¨å†Œinotifyï¼Œè¿™æ ·å¯ä»¥è®©AUFSåœ¨æ›´æ–°æ–‡ä»¶ä¿®æ”¹çš„æ€§èƒ½æ›´é«˜ä¸€äº›ã€‚</li></ul><p><strong>å…¶äºŒã€å¦‚æœæœ‰å¤šä¸ªrwçš„branchï¼ˆç›®å½•ï¼‰è¢«unionèµ·æ¥äº†ï¼Œé‚£ä¹ˆï¼Œå½“æˆ‘åˆ›å»ºæ–‡ä»¶çš„æ—¶å€™ï¼Œaufsä¼šåˆ›å»ºåœ¨å“ªé‡Œå‘¢ï¼Ÿ</strong> aufsæä¾›äº†ä¸€ä¸ªå«createçš„å‚æ•°å¯ä»¥ä¾›ä½ æ¥é…ç½®ç›¸å½“çš„åˆ›å»ºç­–ç•¥ï¼Œä¸‹é¢æœ‰å‡ ä¸ªä¾‹å­ã€‚</p><p><strong>create=rr | roundâˆ’robin</strong> è½®è¯¢ã€‚ä¸‹é¢çš„ç¤ºä¾‹å¯ä»¥çœ‹åˆ°ï¼Œæ–°åˆ›å»ºçš„æ–‡ä»¶è½®æµå†™åˆ°ä¸‰ä¸ªç›®å½•ä¸­</p><p><strong>create=mfs[:second] | mostâˆ’freeâˆ’space[:second]</strong> é€‰ä¸€ä¸ªå¯ç”¨ç©ºé—´æœ€å¥½çš„åˆ†æ”¯ã€‚å¯ä»¥æŒ‡å®šä¸€ä¸ªæ£€æŸ¥å¯ç”¨ç£ç›˜ç©ºé—´çš„æ—¶é—´ã€‚</p><p><strong>create=mfsrr:low[:second]</strong> é€‰ä¸€ä¸ªç©ºé—´å¤§äºlowçš„branchï¼Œå¦‚æœç©ºé—´å°äºlowäº†ï¼Œé‚£ä¹ˆaufsä¼šä½¿ç”¨ round-robin æ–¹å¼ã€‚</p><p>æ›´å¤šçš„å…³äºAUFSçš„ç»†èŠ‚ä½¿ç”¨å‚æ•°ï¼Œå¤§å®¶å¯ä»¥ç›´æ¥åœ¨Ubuntu 14.04ä¸‹é€šè¿‡<a href="http://aufs.sourceforge.net/aufs3/man.html"> man aufs </a>æ¥çœ‹ä¸€ä¸‹å…¶ä¸­çš„å„ç§å‚æ•°å’Œå‘½ä»¤ã€‚</p><h4 id="AUFSçš„æ€§èƒ½"><a href="#AUFSçš„æ€§èƒ½" class="headerlink" title="AUFSçš„æ€§èƒ½"></a>AUFSçš„æ€§èƒ½</h4><p>AUFSçš„æ€§èƒ½æ…¢å—ï¼Ÿä¹Ÿæ…¢ä¹Ÿä¸æ…¢ã€‚å› ä¸ºAUFSä¼šæŠŠæ‰€æœ‰çš„åˆ†æ”¯mountèµ·æ¥ï¼Œæ‰€ä»¥ï¼Œåœ¨æŸ¥æ‰¾æ–‡ä»¶ä¸Šæ˜¯æ¯”è¾ƒæ…¢äº†ã€‚å› ä¸ºå®ƒè¦éå†æ‰€æœ‰çš„branchã€‚æ˜¯ä¸ªO(n)çš„ç®—æ³•ï¼ˆå¾ˆæ˜æ˜¾ï¼Œè¿™ä¸ªç®—æ³•æœ‰å¾ˆå¤§çš„æ”¹è¿›ç©ºé—´çš„ï¼‰æ‰€ä»¥ï¼Œbranchè¶Šå¤šï¼ŒæŸ¥æ‰¾æ–‡ä»¶çš„æ€§èƒ½ä¹Ÿå°±è¶Šæ…¢ã€‚ä½†æ˜¯ï¼Œä¸€æ—¦AUFSæ‰¾åˆ°äº†è¿™ä¸ªæ–‡ä»¶çš„inodeï¼Œé‚£åä»¥åçš„è¯»å†™å’Œæ“ä½œåŸæ–‡ä»¶åŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„ã€‚</p><p>æ‰€ä»¥ï¼Œå¦‚æœä½ çš„ç¨‹åºè·‘åœ¨åœ¨AUFSä¸‹ï¼Œopenå’Œstatæ“ä½œä¼šæœ‰æ˜æ˜¾çš„æ€§èƒ½ä¸‹é™ï¼Œbranchè¶Šå¤šï¼Œæ€§èƒ½è¶Šå·®ï¼Œä½†æ˜¯åœ¨write/readæ“ä½œä¸Šï¼Œæ€§èƒ½æ²¡æœ‰ä»€ä¹ˆå˜åŒ–ã€‚</p><p>IBMçš„ç ”ç©¶ä¸­å¿ƒå¯¹Dockerçš„æ€§èƒ½ç»™äº†ä¸€ä»½éå¸¸ä¸é”™çš„æ€§èƒ½æŠ¥å‘Šï¼ˆPDFï¼‰ã€Š<a href="http://domino.research.ibm.com/library/cyberdig.nsf/papers/0929052195DD819C85257D2300681E7B/$File/rc25482.pdf">An Updated Performance Comparison of Virtual Machinesand Linux Containers</a>ã€‹</p><p>æˆ‘æˆªäº†ä¸¤å¼ å›¾å‡ºæ¥ï¼Œç¬¬ä¸€å¼ æ˜¯é¡ºåºè¯»å†™ï¼Œç¬¬äºŒå¼ æ˜¯éšæœºè¯»å†™ã€‚åŸºæœ¬æ²¡æœ‰ä»€ä¹ˆæ€§èƒ½æŸå¤±çš„é—®é¢˜ã€‚è€ŒKVMåœ¨éšæœºè¯»å†™çš„æƒ…å†µä¹Ÿå°±æœ‰ç‚¹æ…¢äº†ï¼ˆä½†æ˜¯ï¼Œå¦‚æœç¡¬ç›˜æ˜¯SSDçš„å‘¢ï¼Ÿï¼‰</p><p><img data-src="http://coolshell.cn//wp-content/uploads/2015/08/docker.seq_.jpg" alt="é¡ºåºè¯»å†™"></p><p><img data-src="http://coolshell.cn//wp-content/uploads/2015/08/docker.rand_.jpg" alt="éšæœºè¯»å†™"></p><p>åŸæ–‡å‡ºè‡ªï¼š<a href="http://coolshell.cn/articles/17061.html">coolshell</a></p><p><strong>ï¼ˆè½¬è½½æ–‡ç« è¯·æ³¨æ˜ä½œè€…å’Œå‡ºå¤„ é…· å£³ â€“ CoolShell ï¼Œè¯·å‹¿ç”¨äºä»»ä½•å•†ä¸šç”¨é€”ï¼‰</strong></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘åœ¨å­¦ä¹ dockerï¼Œçœ‹åˆ°äº†ä¸€ç¯‡æ¯”è¾ƒå¥½çš„æ–‡ç« ï¼Œäºæ˜¯è½¬è½½äº†è¿‡æ¥ï¼ŒåŸæ–‡å‡ºå¤„åœ¨æœ€åã€‚&lt;/p&gt;
&lt;p&gt;AUFSæ˜¯ä¸€ç§Union File Systemï¼Œæ‰€è°“UnionFSå°±æ˜¯æŠŠä¸åŒç‰©ç†ä½ç½®çš„ç›®å½•åˆå¹¶mountåˆ°åŒä¸€ä¸ªç›®å½•ä¸­ã€‚UnionFSçš„ä¸€ä¸ªæœ€ä¸»è¦çš„åº”ç”¨æ˜¯ï¼ŒæŠŠä¸€å¼ CD/DVDå’Œä¸€ä¸ªç¡¬ç›˜ç›®å½•ç»™è”åˆ mountåœ¨ä¸€èµ·ï¼Œç„¶åï¼Œä½ å°±å¯ä»¥å¯¹è¿™ä¸ªåªè¯»çš„CD/DVDä¸Šçš„æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼ˆå½“ç„¶ï¼Œä¿®æ”¹çš„æ–‡ä»¶å­˜äºç¡¬ç›˜ä¸Šçš„ç›®å½•é‡Œï¼‰ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="docker" scheme="https://www.purewhite.io/categories/docker/"/>
    
    
    <category term="docker" scheme="https://www.purewhite.io/tags/docker/"/>
    
    <category term="linux" scheme="https://www.purewhite.io/tags/linux/"/>
    
  </entry>
  
</feed>

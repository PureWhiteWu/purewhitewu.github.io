<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-Compatible" content="IE=edge"><link rel="apple-touch-icon" sizes="180x180" href="https://static.purewhite.io/favicon.jpg?v=7.3.0"><link rel="icon" type="image/png" sizes="32x32" href="https://static.purewhite.io/favicon.jpg?v=7.3.0"><link rel="icon" type="image/png" sizes="16x16" href="https://static.purewhite.io/favicon.jpg?v=7.3.0"><link rel="mask-icon" href="https://static.purewhite.io/favicon.jpg?v=7.3.0" color="#222"><meta name="google-site-verification" content="Xg_Hnp9ie-Rq7-zLPdd3c9dQtR_0N845ue4QaK8jvL4"><meta property="fb:admins" content="100008177860594"><meta property="fb:app_id" content="761738893983932"><link rel="stylesheet" href="/css/main.css?v=7.3.0"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"7.3.0",exturl:!1,sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!0,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!0,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!0,pangu:!0,algolia:{appID:"ZP9482CZD3",apiKey:"d26207a3ce8de9fe98e7af4215425c93",indexName:"Blog",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!1,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},path:"",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},translation:{copy_button:"Copy",copy_success:"Copied",copy_failure:"Copy failed"}}</script><meta name="description" content="早在去年，Service Mesh这个概念就开始火起来了，今年的时候Service Mesh更是爆发式地发展，Service Mesh中的明星项目Istio更是只用了几个月的时间就已经从0.1到了0.8 LTS了。由于工作和毕业的压力，之前一直没有时间深入研究Service Mesh。现在稍微有些时间了，所以打算写点什么关于Service Mesh的。"><meta name="keywords" content="Istio,kubernetes,Service Mesh"><meta property="og:type" content="article"><meta property="og:title" content="Service Mesh Istio 初探"><meta property="og:url" content="https://purewhite.io/2018/06/27/service-mesh-0/index.html"><meta property="og:site_name" content="Pure White"><meta property="og:description" content="早在去年，Service Mesh这个概念就开始火起来了，今年的时候Service Mesh更是爆发式地发展，Service Mesh中的明星项目Istio更是只用了几个月的时间就已经从0.1到了0.8 LTS了。由于工作和毕业的压力，之前一直没有时间深入研究Service Mesh。现在稍微有些时间了，所以打算写点什么关于Service Mesh的。"><meta property="og:locale" content="zh-Hans"><meta property="og:updated_time" content="2019-03-18T06:14:07.604Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Service Mesh Istio 初探"><meta name="twitter:description" content="早在去年，Service Mesh这个概念就开始火起来了，今年的时候Service Mesh更是爆发式地发展，Service Mesh中的明星项目Istio更是只用了几个月的时间就已经从0.1到了0.8 LTS了。由于工作和毕业的压力，之前一直没有时间深入研究Service Mesh。现在稍微有些时间了，所以打算写点什么关于Service Mesh的。"><link rel="alternate" href="/atom.xml" title="Pure White" type="application/atom+xml"><link rel="canonical" href="https://purewhite.io/2018/06/27/service-mesh-0/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,isPage:!1,isArchive:!1}</script><title>Service Mesh Istio 初探 | Pure White</title><meta name="generator" content="Hexo 3.9.0"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-98194081-1"></script><script pjax>var host=window.location.hostname;if("localhost"!==host){function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-98194081-1")}</script><script pjax>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?a29bb47eea3aa0d952f7bd979b29fa84";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container use-motion"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Pure White</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">主业写bug，副业debug</h1></div><div class="site-nav-toggle"> <button aria-label="Toggle navigation bar"><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-关于我"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于我</a></li><li class="menu-item menu-item-标签"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-分类"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div class="algolia-results"><div id="algolia-stats"></div><div id="algolia-hits"></div><div id="algolia-pagination" class="algolia-pagination"></div></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a class="book-mark-link book-mark-link-fixed" href="#"></a> <a href="https://github.com/PureWhiteWu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article itemscope itemtype="http://schema.org/Article"><div class="post-block post"><link itemprop="mainEntityOfPage" href="https://purewhite.io/2018/06/27/service-mesh-0/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Pure White"><meta itemprop="description" content="青春不是年华，是心境；<br />青春不是桃面、丹唇、柔膝，<br />而是深沉的意志、恢弘的想象、<br />炽热的感情。"><meta itemprop="image" content="https://static.purewhite.io/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Pure White"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Service Mesh Istio 初探</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-06-27 11:41:13" itemprop="dateCreated datePublished" datetime="2018-06-27T11:41:13+08:00">2018-06-27</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2019-03-18 14:14:07" itemprop="dateModified" datetime="2019-03-18T14:14:07+08:00">2019-03-18</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/kubernetes/" itemprop="url" rel="index"><span itemprop="name">kubernetes</span></a></span></span><span id="/2018/06/27/service-mesh-0/" class="post-meta-item leancloud_visitors" data-flag-title="Service Mesh Istio 初探" title="Views"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">Views:</span><span class="leancloud-visitors-count"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span> <span class="post-meta-item-text">Disqus:</span><a title="disqus" href="/2018/06/27/service-mesh-0/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/06/27/service-mesh-0/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="Symbols count in article"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">Symbols count in article:</span> <span>12k</span></span><span class="post-meta-item" title="Reading time"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">Reading time &asymp;</span> <span>11 mins.</span></span></div></header><div class="post-body" itemprop="articleBody"><p>早在去年，Service Mesh这个概念就开始火起来了，今年的时候Service Mesh更是爆发式地发展，Service Mesh中的明星项目Istio更是只用了几个月的时间就已经从0.1到了0.8 LTS了。由于工作和毕业的压力，之前一直没有时间深入研究Service Mesh。现在稍微有些时间了，所以打算写点什么关于Service Mesh的。</p><a id="more"></a><h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>首先，我们需要了解一下什么是Service Mesh。今天我们的主角是Istio，Istio的背景我不过多介绍，G家等大厂搞出来并且在后面推动支持的肯定不会弱。</p><p>根据Istio的官方文档，是这么定义自己的：一个用来连接、管理和加密微服务（流量）的开放平台。</p><blockquote><p>an open platform to connect, manage, and secure microservices</p></blockquote><p>Istio可以让你在不修改微服务源代码的情况之下，很轻松地给微服务加上诸如负载均衡、身份验证、监控等等的功能。Istio通过在你的微服务中部署一个sidecar作为所有流量的代理来达成这个目标。</p><p>总结下来，Istio提供了以下功能：</p><ul><li>流量管理（Traffic Management）</li><li>服务的身份认证和安全（Service Identity and Security）</li><li>策略配置（Policy Enforcement）</li><li>遥感（Telemetry）</li></ul><p>除了这些之外，Istio还支持很多不同的平台（尤其是Kubernetes），并且支持自定义的组件和集成。</p><p>通过这些功能，微服务的开发和迁移会变得非常容易，而运维人员也可以更方便的更改部署的策略。</p><h1 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h1><p>Istio是两层架构的，分别是<strong>数据层</strong>和<strong>控制层</strong>：</p><ul><li>数据层是由所有的部署为sidecar的Envoy所组成的。</li><li>控制层有三个组件：Pilot、Mixer和Citadel，顾名思义是用来控制Service Mesh的行为的。</li></ul><p>总体的架构如下图：</p><p><img alt="Istio Architecture" data-src="https://istio.io/docs/concepts/what-is-istio/img/overview/arch.svg"></p><h2 id="Envoy"><a href="#Envoy" class="headerlink" title="Envoy"></a>Envoy</h2><p>Istio用了一个扩展版本的Envoy作为底层的代理。Envoy是一个用C++开发的高性能的代理，具有非常多功能，具体的可以参考官方文档，在此不做赘述。</p><p>Envoy在Istio中是以sidecar模式部署在pod里面的，Istio通过控制Envoy来控制所有的流量，获取监控数据等。</p><h2 id="Mixer"><a href="#Mixer" class="headerlink" title="Mixer"></a>Mixer</h2><p>Mixer是一个平台无关的组件，用来控制访问策略和使用策略，同时会收集监控信息，将收集到的信息传给用户可以自定义的后端进行处理。</p><h2 id="Pilot"><a href="#Pilot" class="headerlink" title="Pilot"></a>Pilot</h2><p>Pilot为Envoy提供服务发现、智能路由（如AB测试、金丝雀部署）和弹性流量管理功能（如超时、重试、熔断）。它负责将高层的抽象的路由规则转化成低级的envoy的配置。</p><h2 id="Citadel"><a href="#Citadel" class="headerlink" title="Citadel"></a>Citadel</h2><p>Citadel提供了服务间和服务到终端用户的认证，同时可以直接将http流量升级成https流量。具体的可以查看官方文档。</p><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>在这里我打算使用helm进行安装。</p><h2 id="Prerequisite"><a href="#Prerequisite" class="headerlink" title="Prerequisite"></a>Prerequisite</h2><p>首先，你得有一个可运行的k8s集群，我是在gke上开了一个三节点的集群作为测试使用。</p><p>其次，你得需要有helm的客户端。mac用户可以通过brew来安装。</p><h2 id="下载release"><a href="#下载release" class="headerlink" title="下载release"></a>下载release</h2><p>Istio提供了一个很方便的脚本来下载并解压最新版的Istio，如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -L https://git.io/getLatestIstio | sh -</span></span><br></pre></td></tr></table></figure><p>等下载完之后，我们可以进入文件夹，并把bin目录加到path里面：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> istio-0.8.0</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> PATH=<span class="variable">$PWD</span>/bin:<span class="variable">$PATH</span></span></span><br></pre></td></tr></table></figure><h2 id="使用helm进行安装"><a href="#使用helm进行安装" class="headerlink" title="使用helm进行安装"></a>使用helm进行安装</h2><p>要使用helm来安装istio，首先需要在集群里面配置好helm和tiller，如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f install/kubernetes/helm/helm-service-account.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> helm init --service-account tiller</span></span><br></pre></td></tr></table></figure><p>等helm和tiller配置完之后，就可以使用helm来一键安装Istio了：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> helm install install/kubernetes/helm/istio --name istio --namespace istio-system</span></span><br></pre></td></tr></table></figure><p>这样，Istio就安装好了。</p><p>为了验证安装是否成功，我们可以看一下是否部署了以下的service：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get svc -n istio-system</span></span><br><span class="line">NAME                       TYPE           CLUSTER-IP      EXTERNAL-IP       PORT(S)                                                               AGE</span><br><span class="line">istio-citadel              ClusterIP      10.19.247.33    &lt;none&gt;            8060/TCP,9093/TCP                                                     2m</span><br><span class="line">istio-egressgateway        ClusterIP      10.19.244.143   &lt;none&gt;            80/TCP,443/TCP                                                        2m</span><br><span class="line">istio-ingress              LoadBalancer   10.19.248.42    104.199.155.220   80:32000/TCP,443:30434/TCP                                            2m</span><br><span class="line">istio-ingressgateway       LoadBalancer   10.19.254.155   35.229.183.83     80:31380/TCP,443:31390/TCP,31400:31400/TCP                            2m</span><br><span class="line">istio-pilot                ClusterIP      10.19.252.30    &lt;none&gt;            15003/TCP,15005/TCP,15007/TCP,15010/TCP,15011/TCP,8080/TCP,9093/TCP   2m</span><br><span class="line">istio-policy               ClusterIP      10.19.242.187   &lt;none&gt;            9091/TCP,15004/TCP,9093/TCP                                           2m</span><br><span class="line">istio-sidecar-injector     ClusterIP      10.19.252.155   &lt;none&gt;            443/TCP                                                               2m</span><br><span class="line">istio-statsd-prom-bridge   ClusterIP      10.19.246.99    &lt;none&gt;            9102/TCP,9125/UDP                                                     2m</span><br><span class="line">istio-telemetry            ClusterIP      10.19.240.18    &lt;none&gt;            9091/TCP,15004/TCP,9093/TCP,42422/TCP                                 2m</span><br><span class="line">prometheus                 ClusterIP      10.19.255.53    &lt;none&gt;            9090/TCP                                                              2m</span><br></pre></td></tr></table></figure><p>并且确认以下的Pod是否在running状态：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pods -n istio-system</span></span><br><span class="line">NAME                                       READY     STATUS      RESTARTS   AGE</span><br><span class="line">istio-citadel-7bdc7775c7-ntfkf             1/1       Running     0          3m</span><br><span class="line">istio-egressgateway-795fc9b47-2hw69        1/1       Running     0          3m</span><br><span class="line">istio-ingress-84659cf44c-dkgf4             1/1       Running     0          3m</span><br><span class="line">istio-ingressgateway-7d89dbf85f-9kgth      1/1       Running     0          3m</span><br><span class="line">istio-mixer-post-install-vg5gh             0/1       Completed   0          3m</span><br><span class="line">istio-pilot-66f4dd866c-nwr2j               2/2       Running     0          3m</span><br><span class="line">istio-policy-76c8896799-7l9nz              2/2       Running     0          3m</span><br><span class="line">istio-sidecar-injector-645c89bc64-6rs5k    1/1       Running     0          3m</span><br><span class="line">istio-statsd-prom-bridge-949999c4c-mpk6d   1/1       Running     0          3m</span><br><span class="line">istio-telemetry-6554768879-vqmjd           2/2       Running     0          3m</span><br><span class="line">prometheus-86cb6dd77c-vhf9s                1/1       Running     0          3m</span><br></pre></td></tr></table></figure><p>当然，我们也可以自定义一些参数，具体的请看[官方文档]($ helm install <a href="https://raw.githubusercontent.com/istio/istio/release-0.8/install/kubernetes/helm/istio" target="_blank" rel="noopener">install/kubernetes/helm/istio</a> –name istio –namespace istio-system)。</p><h1 id="样例应用"><a href="#样例应用" class="headerlink" title="样例应用"></a>样例应用</h1><p>让我们部署我们的一个样例应用来看看Istio到底干了啥。</p><p>我们的样例应用叫做BookInfo，这个应用由四个微服务所组成，具体架构图如下：</p><p><img alt="Bookinfo Application without Istio" data-src="https://istio.io/docs/guides/img/bookinfo/noistio.svg"></p><p>这个应用是用不同的语言所写的，让我们来见识一下Istio的魔力吧。</p><p>安装这个应用非常简单，我们只要执行以下命令即可：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f samples/bookinfo/kube/bookinfo.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> istioctl create -f samples/bookinfo/routing/bookinfo-gateway.yaml</span></span><br></pre></td></tr></table></figure><p>我们可以注意一下，在<code>bookinfo.yaml</code>中的manifest如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright 2017 Istio Authors</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment">#   you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">#   You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#       http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">#   distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment">#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">#   See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">#   limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##################################################################################################</span></span><br><span class="line"><span class="comment"># Details service</span></span><br><span class="line"><span class="comment">##################################################################################################</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">details</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">details</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - port:</span> <span class="number">9080</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">details</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">details-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">details</span></span><br><span class="line"><span class="attr">        version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">details</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">istio/examples-bookinfo-details-v1:1.5.0</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">9080</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><p>但是我们真正部署出来后，变成了这样：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">sidecar.istio.io/status:</span> <span class="string">'&#123;"version":"55c9e544b52e1d4e45d18a58d0b34ba4b72531e45fb6d1572c77191422556ffc","initContainers":["istio-init"],"containers":["istio-proxy"],"volumes":["istio-envoy","istio-certs"],"imagePullSecrets":null&#125;'</span></span><br><span class="line"><span class="attr">  creationTimestamp:</span> <span class="number">2018</span><span class="bullet">-07</span><span class="bullet">-05</span><span class="attr">T09:10:55Z</span></span><br><span class="line"><span class="attr">  generateName:</span> <span class="string">details-v1-5f94c6d66b-</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">details</span></span><br><span class="line"><span class="attr">    pod-template-hash:</span> <span class="string">"1950728226"</span></span><br><span class="line"><span class="attr">    version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">details-v1-5f94c6d66b-jj6lz</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  ownerReferences:</span></span><br><span class="line"><span class="attr">  - apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">    blockOwnerDeletion:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    controller:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">details-v1-5f94c6d66b</span></span><br><span class="line"><span class="attr">    uid:</span> <span class="number">528</span><span class="string">aa360-8033-11e8-8cec-0e04fb7e7092</span></span><br><span class="line"><span class="attr">  resourceVersion:</span> <span class="string">"15620"</span></span><br><span class="line"><span class="attr">  selfLink:</span> <span class="string">/api/v1/namespaces/default/pods/details-v1-5f94c6d66b-jj6lz</span></span><br><span class="line"><span class="attr">  uid:</span> <span class="number">528</span><span class="string">d5618-8033-11e8-8cec-0e04fb7e7092</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - image:</span> <span class="string">istio/examples-bookinfo-details-v1:1.5.0</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">details</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="attr">    - containerPort:</span> <span class="number">9080</span></span><br><span class="line"><span class="attr">      protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">    terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line"><span class="attr">    terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line"><span class="attr">    volumeMounts:</span></span><br><span class="line"><span class="attr">    - mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">default-token-f9mls</span></span><br><span class="line"><span class="attr">      readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  - args:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">proxy</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">sidecar</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--configPath</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/etc/istio/proxy</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--binaryPath</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/usr/local/bin/envoy</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--serviceCluster</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">details</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--drainDuration</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">45</span><span class="string">s</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--parentShutdownDuration</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">1</span><span class="string">m0s</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--discoveryAddress</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">istio-pilot.istio-system:15007</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--discoveryRefreshDelay</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--zipkinAddress</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">zipkin.istio-system:9411</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--connectTimeout</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--statsdUdpAddress</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">istio-statsd-prom-bridge.istio-system:9125</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--proxyAdminPort</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"15000"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--controlPlaneAuthPolicy</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">NONE</span></span><br><span class="line"><span class="attr">    env:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">POD_NAME</span></span><br><span class="line"><span class="attr">      valueFrom:</span></span><br><span class="line"><span class="attr">        fieldRef:</span></span><br><span class="line"><span class="attr">          apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">          fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line"><span class="attr">      valueFrom:</span></span><br><span class="line"><span class="attr">        fieldRef:</span></span><br><span class="line"><span class="attr">          apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">          fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">INSTANCE_IP</span></span><br><span class="line"><span class="attr">      valueFrom:</span></span><br><span class="line"><span class="attr">        fieldRef:</span></span><br><span class="line"><span class="attr">          apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">          fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">ISTIO_META_POD_NAME</span></span><br><span class="line"><span class="attr">      valueFrom:</span></span><br><span class="line"><span class="attr">        fieldRef:</span></span><br><span class="line"><span class="attr">          apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">          fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">ISTIO_META_INTERCEPTION_MODE</span></span><br><span class="line"><span class="attr">      value:</span> <span class="string">REDIRECT</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">docker.io/istio/proxyv2:0.8.0</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">istio-proxy</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      requests:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">100</span><span class="string">m</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">128</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">    securityContext:</span></span><br><span class="line"><span class="attr">      privileged:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      runAsUser:</span> <span class="number">1337</span></span><br><span class="line"><span class="attr">    terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line"><span class="attr">    terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line"><span class="attr">    volumeMounts:</span></span><br><span class="line"><span class="attr">    - mountPath:</span> <span class="string">/etc/istio/proxy</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">istio-envoy</span></span><br><span class="line"><span class="attr">    - mountPath:</span> <span class="string">/etc/certs/</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">istio-certs</span></span><br><span class="line"><span class="attr">      readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    - mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">default-token-f9mls</span></span><br><span class="line"><span class="attr">      readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line"><span class="attr">  initContainers:</span></span><br><span class="line"><span class="attr">  - args:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">-p</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"15001"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">-u</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"1337"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">-m</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">REDIRECT</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">-i</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'*'</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">-x</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">""</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">-b</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">9080</span><span class="string">,</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">-d</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">docker.io/istio/proxy_init:0.8.0</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">istio-init</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">    securityContext:</span></span><br><span class="line"><span class="attr">      capabilities:</span></span><br><span class="line"><span class="attr">        add:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">NET_ADMIN</span></span><br><span class="line"><span class="attr">      privileged:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line"><span class="attr">    terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line"><span class="attr">    volumeMounts:</span></span><br><span class="line"><span class="attr">    - mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">default-token-f9mls</span></span><br><span class="line"><span class="attr">      readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  nodeName:</span> <span class="string">ip-172-31-39-23</span></span><br><span class="line"><span class="attr">  restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">  schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line"><span class="attr">  securityContext:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  serviceAccount:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  serviceAccountName:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">  tolerations:</span></span><br><span class="line"><span class="attr">  - effect:</span> <span class="string">NoExecute</span></span><br><span class="line"><span class="attr">    key:</span> <span class="string">node.kubernetes.io/not-ready</span></span><br><span class="line"><span class="attr">    operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">    tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">  - effect:</span> <span class="string">NoExecute</span></span><br><span class="line"><span class="attr">    key:</span> <span class="string">node.kubernetes.io/unreachable</span></span><br><span class="line"><span class="attr">    operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">    tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">  - emptyDir:</span></span><br><span class="line"><span class="attr">      medium:</span> <span class="string">Memory</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">istio-envoy</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">istio-certs</span></span><br><span class="line"><span class="attr">    secret:</span></span><br><span class="line"><span class="attr">      defaultMode:</span> <span class="number">420</span></span><br><span class="line"><span class="attr">      optional:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      secretName:</span> <span class="string">istio.default</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">default-token-f9mls</span></span><br><span class="line"><span class="attr">    secret:</span></span><br><span class="line"><span class="attr">      defaultMode:</span> <span class="number">420</span></span><br><span class="line"><span class="attr">      secretName:</span> <span class="string">default-token-f9mls</span></span><br></pre></td></tr></table></figure><p>可以看到，本来只有一个container的，现在里面多了一个container和initContainer。这个就是Istio的Auto Injection，可以自动把sidecar注入到Pod里面，让我们不需要手动一个一个修改yaml文件，也防止手动修改过程中出错的可能。</p><h1 id="使用实例"><a href="#使用实例" class="headerlink" title="使用实例"></a>使用实例</h1><p>这里我们以路由设置为例子。</p><p>首先我们打开刚才部署好的这个应用的网页，可以看到页面右方的Book Reviews部分里面每次刷新都会随机性地出现黑星星、红星星和没有星星三种情况，这是因为我们有三个不同的backend，路由在默认情况下会随机路由到任意一个backend上。</p><p>我们先尝试把所有的路由都路由到v1版本上（就是没有星星的版本），路由规则如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">details</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">details</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">details</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">productpage</span></span><br><span class="line">  <span class="string">...</span></span><br></pre></td></tr></table></figure><p>命令如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> istioctl create -f samples/bookinfo/routing/route-rule-all-v1.yaml</span></span><br></pre></td></tr></table></figure><p>然后我们再去刷新，就会发现不管怎么刷新星星都不见了。</p><p>接着，假如我们有一个用户是jason，我们希望他能测试v2的backend，就可以用下面的路由规则：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">reviews</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - match:</span></span><br><span class="line"><span class="attr">    - headers:</span></span><br><span class="line"><span class="attr">        cookie:</span></span><br><span class="line"><span class="attr">          regex:</span> <span class="string">^(.*?;)?(user=jason)(;.*)?$</span></span><br><span class="line"><span class="attr">    route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure><p>命令如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> istioctl replace -f samples/bookinfo/routing/route-rule-reviews-test-v2.yaml</span></span><br></pre></td></tr></table></figure><p>这时候，我们打开网页，以jason这个用户登录（密码随便填），就会发现每一次访问到的都是带有黑星星的版本。</p><p>这就是Istio提供的路由功能。</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本文中我们简单讲了Service Mesh的概念，如何创建Istio以及简单的使用过程，如果大家有兴趣探索Istio更多的功能，可以直接访问<a href="https://istio.io/" target="_blank" rel="noopener">Istio的官网</a>。</p></div><div id="reward-container"><div>请博主喝杯咖啡~</div> <button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';"> Donate</button><div id="qr" style="display:none"><div style="display:inline-block"> <img src="https://static.purewhite.io/wechat_pay.jpeg" alt="Pure White WeChat Pay"><p>WeChat Pay</p></div><div style="display:inline-block"> <img src="https://static.purewhite.io/alipay.jpeg" alt="Pure White Alipay"><p>Alipay</p></div></div></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/后端/" rel="tag"># 后端</a> <a href="/tags/架构/" rel="tag"># 架构</a> <a href="/tags/kubernetes/" rel="tag"># kubernetes</a> <a href="/tags/运维/" rel="tag"># 运维</a> <a href="/tags/docker/" rel="tag"># docker</a> <a href="/tags/linux/" rel="tag"># linux</a> <a href="/tags/Service-Mesh/" rel="tag"># Service Mesh</a></div><div class="post-widgets"><div class="wp_rating"><div id="wpac-rating"></div></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018/06/16/cka/" rel="next" title="CKA 认证，持证上岗"><i class="fa fa-chevron-left"></i> CKA 认证，持证上岗</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2018/07/08/ckad/" rel="prev" title="CKAD 也考出来啦！">CKAD 也考出来啦！<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div><div class="comments" id="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc" data-target="post-toc-wrap"> Table of Contents</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> Overview</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#介绍"><span class="nav-number">1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#架构"><span class="nav-number">2.</span> <span class="nav-text">架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Envoy"><span class="nav-number">2.1.</span> <span class="nav-text">Envoy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mixer"><span class="nav-number">2.2.</span> <span class="nav-text">Mixer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pilot"><span class="nav-number">2.3.</span> <span class="nav-text">Pilot</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Citadel"><span class="nav-number">2.4.</span> <span class="nav-text">Citadel</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装"><span class="nav-number">3.</span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Prerequisite"><span class="nav-number">3.1.</span> <span class="nav-text">Prerequisite</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#下载release"><span class="nav-number">3.2.</span> <span class="nav-text">下载release</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用helm进行安装"><span class="nav-number">3.3.</span> <span class="nav-text">使用helm进行安装</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#样例应用"><span class="nav-number">4.</span> <span class="nav-text">样例应用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#使用实例"><span class="nav-number">5.</span> <span class="nav-text">使用实例</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">6.</span> <span class="nav-text">总结</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="https://static.purewhite.io/avatar.jpg" alt="Pure White"><p class="site-author-name" itemprop="name">Pure White</p><div class="site-description" itemprop="description">青春不是年华，是心境；<br>青春不是桃面、丹唇、柔膝，<br>而是深沉的意志、恢弘的想象、<br>炽热的感情。</div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives"><span class="site-state-item-count">49</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">15</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">30</span> <span class="site-state-item-name">tags</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/PureWhiteWu" title="GitHub &rarr; https://github.com/PureWhiteWu" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:daniel48@126.com" title="E-Mail &rarr; mailto:daniel48@126.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://twitter.com/PureWhite_Wu" title="Twitter &rarr; https://twitter.com/PureWhite_Wu" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i> Twitter</a></span><span class="links-of-author-item"><a href="https://www.linkedin.com/in/%E8%BF%AA-%E5%90%B4-846051106/" title="LinkedIn &rarr; https://www.linkedin.com/in/%E8%BF%AA-%E5%90%B4-846051106/" rel="noopener" target="_blank"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a></span><span class="links-of-author-item"><a href="https://telegram.me/PureWhiteWu" title="Telegram &rarr; https://telegram.me/PureWhiteWu" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i> Telegram</a></span><span class="links-of-author-item"><a href="http://weibo.com/purewhitewu" title="微博 &rarr; http://weibo.com/purewhitewu" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> 微博</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/PureWhite_Wu" title="知乎 &rarr; https://www.zhihu.com/people/PureWhite_Wu" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i> 知乎</a></span><span class="links-of-author-item"><a href="https://static.purewhite.io/wechat.jpeg" title="微信 &rarr; https://static.purewhite.io/wechat.jpeg" rel="noopener" target="_blank"><i class="fa fa-fw fa-weixin"></i> 微信</a></span></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="http://blog.didispace.com/" title="http://blog.didispace.com/" rel="noopener" target="_blank">程序猿DD</a></li><li class="links-of-blogroll-item"> <a href="http://www.v2ex.com/?r=PureWhiteWu" title="http://www.v2ex.com/?r=PureWhiteWu" rel="noopener" target="_blank">v2ex</a></li><li class="links-of-blogroll-item"> <a href="https://yuzhouwan.com/" title="https://yuzhouwan.com/" rel="noopener" target="_blank">宇宙湾</a></li><li class="links-of-blogroll-item"> <a href="https://pengrl.com/" title="https://pengrl.com/" rel="noopener" target="_blank">yoko blog</a></li></ul></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"><a href="http://www.beian.miit.gov.cn" rel="noopener" target="_blank">沪ICP备15051443号-3</a><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=" rel="noopener" target="_blank"></a> &copy; 2017 – <span itemprop="copyrightYear">2019</span><span class="with-love" id="animate"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">Pure White</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">Symbols count total:</span> <span title="Symbols count total">138k</span></div><div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div> <span class="post-meta-divider">|</span><div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.3.0</div><script pjax>
  function leancloudSelector(url) {
    return document.getElementById(url).querySelector('.leancloud-visitors-count');
  }
  if (CONFIG.page.isPost) {
    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = visitors.getAttribute('id').trim();
      var title = visitors.getAttribute('data-flag-title').trim();

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
              leancloudSelector(url).innerText = counter.time + 1;
            
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .then(response => response.json())
              .catch(error => {
                console.log('Failed to save visitor count', error);
              })
          } else {
              Counter('post', '/classes/Counter', { title: title, url: url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.log('Failed to create', error);
                });
            
          }
        })
        .catch(error => {
          console.log('LeanCloud Counter Error', error);
        });
    }
  } else {
    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return element.getAttribute('id').trim();
      });

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url: { '$in': entries } })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length === 0) {
            document.querySelectorAll('.leancloud_visitors .leancloud-visitors-count').forEach(element => {
              element.innerText = 0;
            });
            return;
          }
          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.url;
            var time = item.time;
            leancloudSelector(url).innerText = time;
          }
          for (var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = leancloudSelector(url);
            if (element.innerText == '') {
              element.innerText = 0;
            }
          }
        })
        .catch(error => {
          console.log('LeanCloud Counter Error', error);
        });
    }
  }

  fetch('https://app-router.leancloud.cn/2/route?appId=Sa9GIjpR90eFliBWzUAiUp9W-gzGzoHsz')
    .then(response => response.json())
    .then(({ api_server }) => {
      var Counter = (method, url, data) => {
        return fetch(`https://${api_server}/1.1${url}`, {
          method: method,
          headers: {
            'X-LC-Id': 'Sa9GIjpR90eFliBWzUAiUp9W-gzGzoHsz',
            'X-LC-Key': 'rSpeP2HoYIdOYJr4p2elMvLn',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        const localhost = /http:\/\/(localhost|127.0.0.1|0.0.0.0)/;
        if (localhost.test(document.URL)) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    });
  </script><script pjax>!function(){var e=document.createElement("script");e.src="//tajs.qq.com/stats?sId=61888292";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></div></footer></div><script src="/lib/jquery/index.js?v=3.4.1"></script><script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script><script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/js/utils.js?v=7.3.0"></script><script src="/js/motion.js?v=7.3.0"></script><script src="/js/bookmark.js?v=7.3.0"></script><script src="/js/schemes/muse.js?v=7.3.0"></script><script src="/js/next-boot.js?v=7.3.0"></script><script pjax>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>function fbAsyncInit(){FB.init({appId:"761738893983932",xfbml:!0,version:"v3.3"})}!function(e,n,t){var c,o=e.getElementsByTagName(n)[0];e.getElementById(t)||((c=e.createElement(n)).id=t,c.src="//connect.facebook.net/zh_Hans/sdk.js",o.parentNode.insertBefore(c,o))}(document,"script","facebook-jssdk")</script><script pjax>CONFIG.page.isPost&&(wpac_init=window.wpac_init||[],wpac_init.push({widget:"Rating",id:8500,el:"wpac-rating",color:"fc6423"}),function(){if(!("WIDGETPACK_LOADED"in window)){WIDGETPACK_LOADED=!0;var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//embed.widgetpack.com/widget.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t.nextSibling)}}())</script><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.css"><script src="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.js"></script><script src="/js/algolia-search.js?v=7.3.0"></script><div id="pjax"><script>function loadCount(){var d=document,t=d.createElement("script");t.src="https://blog-zr0zqnlt9p.disqus.com/count.js",t.id="dsq-count-scr",(d.head||d.body).appendChild(t)}window.addEventListener("load",loadCount,!1)</script><script>
  function disqus_config() {
    this.page.url = "https://purewhite.io/2018/06/27/service-mesh-0/";
    this.page.identifier = "2018/06/27/service-mesh-0/";
    this.page.title = 'Service Mesh Istio 初探';};
  function loadComments() {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://blog-zr0zqnlt9p.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  }
    (function() {
      var offsetTop = document.getElementById('comments').offsetTop - window.innerHeight;
      if (offsetTop <= 0) {
        // load directly when there's no a scrollbar
        window.addEventListener('load', loadComments, false);
      } else {
        var disqus_scroll = () => {
          // offsetTop may changes because of manually resizing browser window or lazy loading images.
          var offsetTop = document.getElementById('comments').offsetTop - window.innerHeight;
          var scrollTop = window.scrollY;

          // pre-load comments a bit? (margin or anything else)
          if (offsetTop - scrollTop < 60) {
            window.removeEventListener('scroll', disqus_scroll);
            loadComments();
          }
        };
        window.addEventListener('scroll', disqus_scroll);
      }
    })();
  
</script></div><script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo: !CONFIG.bookmark.enable
});
window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[pjax], script#page-configurations, #pjax script').forEach(element => {
    $(element).parent().append($(element).remove());
  });
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script></body></html>